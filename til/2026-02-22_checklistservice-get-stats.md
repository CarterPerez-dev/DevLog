# ChecklistService.get_stats

**Type:** Today I Learned
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/life_manager/facets/checklist/service.py
**Language:** python
**Lines:** 178-229
**Complexity:** 14.0

---

## Source Code

```python
async def get_stats(session: AsyncSession) -> ChecklistStatsResponse:
        """
        Compute streak, per-item completion rates, and year heatmap
        """
        today = date.today()
        year_start = date(today.year, 1, 1)

        heatmap_rows = await ChecklistLogRepository.get_heatmap_data(
            session, year_start, today
        )
        heatmap = [
            HeatmapDay(
                date=row.log_date,
                completed_count=int(row.completed_count or 0),
                total_count=int(row.total_count or 0),
            )
            for row in heatmap_rows
        ]

        heatmap_by_date = {h.date: h for h in heatmap}
        streak = 0
        check_date = today
        while check_date >= year_start:
            day = heatmap_by_date.get(check_date)
            if day and day.total_count > 0 and day.completed_count == day.total_count:
                streak += 1
                check_date -= timedelta(days=1)
            else:
                break

        rate_rows = await ChecklistLogRepository.get_item_completion_rates(session)
        active_items = await ChecklistItemRepository.get_active(session)
        item_map = {i.id: i.title for i in active_items}

        item_stats = [
            ItemStat(
                item_id=row.item_id,
                title=item_map.get(row.item_id, ""),
                completion_rate=round(
                    (int(row.completed or 0) / int(row.total)) if int(row.total) > 0 else 0.0,
                    4,
                ),
            )
            for row in rate_rows
            if row.item_id in item_map
        ]

        return ChecklistStatsResponse(
            streak=streak,
            item_stats=item_stats,
            heatmap=heatmap,
        )
```

---

## Today I Learned

TIL: In `get_stats`, the code uses a while loop to calculate the streak by iterating backward from todayâ€™s date, checking daily completion rates. This clever approach ensures the streak is accurately computed without needing extra data structures, showcasing efficient and concise logic.

```markdown
Today I learned that in `get_stats`, the function calculates the streak by iterating backward from today's date using a while loop. This elegant technique checks each day for consecutive completions to compute the longest streak efficiently.
```

---

*Generated by CodeWorm on 2026-02-22 02:54*
