# SearchRepository.search_all

**Type:** Today I Learned
**Repository:** my-portfolio
**File:** v1/backend/app/search/repository.py
**Language:** python
**Lines:** 18-119
**Complexity:** 2.0

---

## Source Code

```python
async def search_all(
        cls,
        session: AsyncSession,
        query: str,
        language: Language,
        limit: int = 20,
    ) -> list[SearchResultItem]:
        """
        Full-text search across projects, experiences, and certifications.
        Returns results with highlighted excerpts.
        """
        search_query = text(
            """
            WITH search_results AS (
                SELECT
                    title,
                    ts_headline(
                        'english',
                        COALESCE(description, '') || ' ' || COALESCE(technical_details, ''),
                        plainto_tsquery('english', :query),
                        'StartSel=<mark>, StopSel=</mark>, MaxWords=35, MinWords=15, MaxFragments=2'
                    ) AS excerpt,
                    '/projects/' || slug AS url,
                    'project' AS type,
                    ts_rank(
                        to_tsvector('english', title || ' ' || COALESCE(description, '') || ' ' || COALESCE(technical_details, '')),
                        plainto_tsquery('english', :query)
                    ) AS rank
                FROM projects
                WHERE language = :language
                AND to_tsvector('english', title || ' ' || COALESCE(description, '') || ' ' || COALESCE(technical_details, ''))
                    @@ plainto_tsquery('english', :query)

                UNION ALL

                SELECT
                    company || ' - ' || role AS title,
                    ts_headline(
                        'english',
                        description,
                        plainto_tsquery('english', :query),
                        'StartSel=<mark>, StopSel=</mark>, MaxWords=35, MinWords=15, MaxFragments=2'
                    ) AS excerpt,
                    '/background/experience' AS url,
                    'experience' AS type,
                    ts_rank(
                        to_tsvector('english', company || ' ' || role || ' ' || description),
                        plainto_tsquery('english', :query)
                    ) AS rank
                FROM experiences
                WHERE language = :language
                AND is_visible = true
                AND to_tsvector('english', company || ' ' || role || ' ' || description)
                    @@ plainto_tsquery('english', :query)

                UNION ALL

                SELECT
                    name AS title,
                    ts_headline(
                        'english',
                        name || ' - ' || issuer,
                        plainto_tsquery('english', :query),
                        'StartSel=<mark>, StopSel=</mark>, MaxWords=35, MinWords=15, MaxFragments=2'
                    ) AS excerpt,
                    '/background/certifications' AS url,
                    'certification' AS type,
                    ts_rank(
                        to_tsvector('english', name || ' ' || issuer),
                  
```

---

## Today I Learned

TIL: I learned how to perform full-text search across multiple tables using SQL WITH clauses and UNION ALL in Python with SQLAlchemy. This approach allows efficient querying of projects, experiences, and certifications, returning highlighted excerpts for relevant results.

```python
search_query = text(...)  # Construct complex query with multiple SELECT statements.
result = await session.execute(search_query)  # Execute the query asynchronously.
```

This pattern is both powerful and Pythonic, making full-text search across diverse data models straightforward.

---

*Generated by CodeWorm on 2026-02-21 19:35*
