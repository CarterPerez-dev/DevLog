# handle_github_auth_callback

**Type:** Today I Learned
**Repository:** CertGames-Core
**File:** backend/api/domains/account/controllers/oauth/github_auth_ctrl.py
**Language:** python
**Lines:** 49-191
**Complexity:** 18.0

---

## Source Code

```python
def handle_github_auth_callback() -> str:
    """
    Handle GitHub OAuth callback for user authentication
    """
    code: str | None = g.validated.get("code")
    if not code:
        raise ValidationError("Missing authorization code")

    github_client_id = os.getenv("GH_CLIENT_ID")
    github_client_secret = os.getenv("GH_CLIENT_SECRET")

    if not github_client_id or not github_client_secret:
        raise ValidationError("GitHub OAuth credentials not configured")

    token_response: requests.Response = requests.post(
        "https://github.com/login/oauth/access_token",
        headers = {"Accept": "application/json"},
        data = {
            "client_id": github_client_id,
            "client_secret": github_client_secret,
            "code": code,
        },
        timeout = 60,
    )

    if token_response.status_code != 200:
        raise ValidationError("Failed to exchange authorization code")

    token_data: dict[str, Any] = token_response.json()
    access_token: str | None = token_data.get("access_token")

    if not access_token:
        raise ValidationError("No access token received from GitHub")

    user_response: requests.Response = requests.get(
        "https://api.github.com/user",
        headers = {"Authorization": f"Bearer {access_token}"},
        timeout = 60,
    )

    if user_response.status_code != 200:
        raise ValidationError(
            "Failed to retrieve user information from GitHub"
        )

    user_info: dict[str, Any] = user_response.json()

    email_response: requests.Response = requests.get(
        "https://api.github.com/user/emails",
        headers = {"Authorization": f"Bearer {access_token}"},
        timeout = 60,
    )

    if email_response.status_code != 200:
        raise ValidationError(
            "Failed to retrieve email information from GitHub"
        )

    emails = email_response.json()
    if not isinstance(emails, list):
        raise ValidationError("Invalid email response from GitHub")

    email = next(
        (
            e['email'] for e in emails if isinstance(e, dict)
            and e.get('primary') and e.get('verified')
        ),
        None
    )

    if not email:
        raise ValidationError("No verified email found in GitHub account")

    github_id = str(user_info.get("id", ""))
    name = user_info.get("name") or user_info.get("login", "")

    if not github_id:
        raise ValidationError("Invalid user ID from GitHub")

    g.oauth_email = email
    g.oauth_provider = "github"
    g.provider_user_id = github_id
    g.provider_name = name

    user_id: str
    is_new_user: bool
    user_id, is_new_user = process_oauth_user()

    user = g.oauth_user

    tokens: dict[str,
                 Any] = generate_tokens(
                     user_id,
                     {
                         "username":
                         getattr(user,
                                 "username",
                                 None),
                    
```

---

## Today I Learned

TIL: In `handle_github_auth_callback`, the code uses a generator expression within `next()` to find the primary, verified email from GitHub's response. This concise approach elegantly filters through the emails list, ensuring only valid, verified addresses are considered.

```python
email = next(
    (e['email'] for e in emails if isinstance(e, dict)
     and e.get('primary') and e.get('verified')),
    None
)
```

This pattern saves lines while maintaining readability and efficiency.

---

*Generated by CodeWorm on 2026-02-19 19:18*
