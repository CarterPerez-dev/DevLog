# TestAttemptService.find_by_user_and_test

**Type:** Today I Learned
**Repository:** CertGames-Core
**File:** backend/api/domains/testing/services/session_ops.py
**Language:** python
**Lines:** 25-64
**Complexity:** 7.0

---

## Source Code

```python
def find_by_user_and_test(
        user_id: str | ObjectId,
        test_id: int | str,
        category: str | None = None,
        status: str | None = None
    ) -> TestAttempt | None:
        """
        Find test attempt by user and test.
        """
        if isinstance(user_id, str):
            try:
                user_id = ObjectId(user_id)
            except (InvalidId, ValueError):
                return None

        base_query: dict[str, Any] = {"userId": user_id, "testId": test_id}

        if category:
            base_query["category"] = category

        if status == "finished":
            return TestAttempt.objects(
                **base_query,
                finished = True
            ).order_by('-finishedAt').first()
        if status == "unfinished":
            return TestAttempt.objects(
                **base_query,
                finished = False
            ).first()
        attempt = TestAttempt.objects(
            **base_query,
            finished = False
        ).first()
        if not attempt:
            attempt = TestAttempt.objects(
                **base_query,
                finished = True
            ).order_by('-finishedAt').first()
        return attempt
```

---

## Today I Learned

TIL: This function uses dynamic query construction and conditional logic to handle different statuses efficiently. By dynamically adding conditions based on `status`, it avoids redundant queries, making the code more flexible and maintainable.

```python
if status == "finished":
    return TestAttempt.objects(**base_query, finished=True).order_by('-finishedAt').first()
if status == "unfinished":
    return TestAttempt.objects(**base_query, finished=False).first()
```

This pattern reduces redundancy and enhances readability by handling specific cases directly.

---

*Generated by CodeWorm on 2026-02-28 01:03*
