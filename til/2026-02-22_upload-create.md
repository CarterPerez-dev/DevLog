# Upload.create

**Type:** Today I Learned
**Repository:** vuemantics
**File:** backend/models/Upload.py
**Language:** python
**Lines:** 180-257
**Complexity:** 6.0

---

## Source Code

```python
async def create(
        cls,
        user_id: UUID,
        filename: str,
        file_path: str,
        file_type: str,
        file_size: int,
        mime_type: str,
        metadata: dict[str,
                       Any] | None = None,
        upload_id: UUID | None = None,
        batch_id: UUID | None = None,
    ) -> Upload:
        """
        Create a new upload record.

        Args:
            user_id: Owner's user ID
            filename: Original filename
            file_path: Local storage path
            file_type: 'image' or 'video'
            file_size: Size in bytes
            mime_type: MIME type
            metadata: Optional metadata

        Returns:
            Created Upload instance
        """
        await cls.ensure_table_exists()

        if upload_id:
            query = """
                INSERT INTO uploads (
                    id, user_id, batch_id, filename, file_path, file_type,
                    file_size, mime_type, metadata
                )
                VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
                RETURNING *
            """
            record = await database.db.fetchrow(
                query,
                upload_id,
                user_id,
                batch_id,
                filename,
                file_path,
                file_type,
                file_size,
                mime_type,
                json.dumps(metadata) if metadata is not None else None,
            )
        else:
            query = """
                INSERT INTO uploads (
                    user_id, batch_id, filename, file_path, file_type,
                    file_size, mime_type, metadata
                )
                VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
                RETURNING *
            """
            record = await database.db.fetchrow(
                query,
                user_id,
                batch_id,
                filename,
                file_path,
                file_type,
                file_size,
                mime_type,
                json.dumps(metadata) if metadata is not None else None,
            )

        if record is None:
            raise ValueError("Failed to create upload")
        upload = cls.from_record(record)
        if upload is None:
            raise ValueError("Failed to create upload from record")
        return upload
```

---

## Today I Learned

TIL: In `Upload.create`, the function conditionally includes an `id` parameter in its SQL query based on whether `upload_id` is provided. This dynamic query construction ensures that the record is inserted with a specified ID if one exists, or as a new entry otherwise, making the function versatile and flexible.

```markdown
TIL: In `Upload.create`, conditional query parameters allow inserting records with or without a specified ID dynamically.
```

---

*Generated by CodeWorm on 2026-02-22 07:13*
