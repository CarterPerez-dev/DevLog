# Upload.find_by_user

**Type:** Today I Learned
**Repository:** vuemantics
**File:** backend/models/Upload.py
**Language:** python
**Lines:** 287-358
**Complexity:** 6.0

---

## Source Code

```python
async def find_by_user(
        cls,
        user_id: UUID,
        limit: int = config.DEFAULT_PAGE_SIZE,
        offset: int = 0,
        file_type: str | None = None,
        status: str | None = None,
        show_hidden: bool = False,
        sort_by: str = "created_at",
        sort_order: str = "desc",
    ) -> list[Upload]:
        """
        Find uploads by user with optional filters.

        Args:
            user_id: User's ID
            limit: Maximum results
            offset: Skip N results
            file_type: Filter by file type
            status: Filter by processing status
            show_hidden: If True, include hidden uploads
            sort_by: Field to sort by (created_at, updated_at, file_size, filename)
            sort_order: Sort direction (asc or desc)

        Returns:
            List of Upload instances
        """
        await cls.ensure_table_exists()

        conditions = ["user_id = $1"]
        params: list[Any] = [user_id]
        param_count = 1

        if file_type:
            param_count += 1
            conditions.append(f"file_type = ${param_count}")
            params.append(file_type)

        if status:
            param_count += 1
            conditions.append(f"processing_status = ${param_count}")
            params.append(status)

        if not show_hidden:
            conditions.append("hidden = FALSE")

        where_clause = " AND ".join(conditions)

        # Validate and sanitize sort params (prevent SQL injection)
        valid_sort_fields = {
            "created_at",
            "updated_at",
            "file_size",
            "filename"
        }
        if sort_by not in valid_sort_fields:
            sort_by = "created_at"

        valid_sort_orders = {"asc", "desc"}
        if sort_order.lower() not in valid_sort_orders:
            sort_order = "desc"

        query = f"""
            SELECT * FROM uploads
            WHERE {where_clause}
            ORDER BY {sort_by} {sort_order.upper()}
            LIMIT ${param_count + 1} OFFSET ${param_count + 2}
        """

        params.extend([limit, offset])
        records = await database.db.fetch(query, *params)
        return cls.from_records(records)
```

---

## Today I Learned

TIL: In `Upload.find_by_user`, dynamic SQL conditions are built using parameterized queries to safely filter results based on optional arguments. This prevents SQL injection and keeps the query string clean, making it both secure and flexible.

```python
conditions = ["user_id = $1"]
params = [user_id]
param_count = 1

if file_type:
    param_count += 1
    conditions.append(f"file_type = ${param_count}")
    params.append(file_type)

where_clause = " AND ".join(conditions)
```

This pattern ensures that only valid parameters are used, enhancing security and maintainability.

---

*Generated by CodeWorm on 2026-02-22 09:40*
