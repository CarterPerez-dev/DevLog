# handleStatus

**Type:** Today I Learned
**Repository:** angelamos-operations
**File:** CarterBot-Telegram/src/handlers/commands.ts
**Language:** typescript
**Lines:** 79-141
**Complexity:** 12.0

---

## Source Code

```typescript
async function handleStatus(ctx: Context): Promise<void> {
  const userId = ctx.from?.id;

  if (!isAuthorized(userId, ALLOWED_USERS)) {
    await ctx.reply("Unauthorized.");
    return;
  }

  const lines: string[] = ["<b>Bot Status</b>\n"];

  if (session.isActive) {
    lines.push(`Session: Active (${session.sessionId?.slice(0, 8)}...)`);
  } else {
    lines.push("Session: None");
  }

  if (session.isRunning) {
    const elapsed = session.queryStarted
      ? Math.floor((Date.now() - session.queryStarted.getTime()) / 1000)
      : 0;
    lines.push(`Query: Running (${elapsed}s)`);
    if (session.currentTool) {
      lines.push(`   ${session.currentTool}`);
    }
  } else {
    lines.push("Query: Idle");
    if (session.lastTool) {
      lines.push(`   Last: ${session.lastTool}`);
    }
  }

  if (session.lastActivity) {
    const ago = Math.floor(
      (Date.now() - session.lastActivity.getTime()) / 1000
    );
    lines.push(`\nLast activity: ${ago}s ago`);
  }

  if (session.lastUsage) {
    const usage = session.lastUsage;
    lines.push(
      `\nLast query usage:`,
      `   Input: ${usage.input_tokens?.toLocaleString() || "?"} tokens`,
      `   Output: ${usage.output_tokens?.toLocaleString() || "?"} tokens`
    );
    if (usage.cache_read_input_tokens) {
      lines.push(
        `   Cache read: ${usage.cache_read_input_tokens.toLocaleString()}`
      );
    }
  }

  if (session.lastError) {
    const ago = session.lastErrorTime
      ? Math.floor((Date.now() - session.lastErrorTime.getTime()) / 1000)
      : "?";
    lines.push(`\nLast error (${ago}s ago):`, `   ${session.lastError}`);
  }

  lines.push(`\nWorking dir: <code>${WORKING_DIR}</code>`);

  await ctx.reply(lines.join("\n"), { parse_mode: "HTML" });
}
```

---

## Today I Learned

TIL: This TypeScript function uses an array of strings to build a formatted response, then joins it with `\n` for easy readability and reply construction. Clever for maintaining clean, readable output without complex string concatenation.

```typescript
const lines: string[] = ["<b>Bot Status</b>\n"];
// ... logic ...
await ctx.reply(lines.join("\n"), { parse_mode: "HTML" });
```

This approach keeps the code simple and the final message well-structured.

---

*Generated by CodeWorm on 2026-02-20 18:42*
