# InsightsService.get_performance_rankings

**Type:** Today I Learned
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/analytics/facets/insights/service.py
**Language:** python
**Lines:** 119-176
**Complexity:** 5.0

---

## Source Code

```python
async def get_performance_rankings(
        session: AsyncSession,
        limit: int = 10,
    ) -> PerformanceRankingsResponse:
        """Get top performing videos by different metrics"""
        videos = await InsightsRepository.get_all_videos(session)

        def to_video_performance(video) -> VideoPerformance:
            return VideoPerformance(
                id = str(video.id),
                rank = video.rank,
                hook = video.hook,
                views = video.views,
                engagement_rate = InsightsRepository.
                calculate_engagement_rate(video),
                follower_conversion_rate = InsightsRepository.
                calculate_follower_conversion_rate(video),
                avg_watch_time = video.avg_watch_time,
                watched_full_video_percentage = video.
                watched_full_video_percentage,
                date_posted = video.date_posted.isoformat(),
            )

        by_views = sorted(
            videos,
            key = lambda v: v.views,
            reverse = True
        )[: limit]
        by_engagement = sorted(
            videos,
            key = lambda v: InsightsRepository.
            calculate_engagement_rate(v),
            reverse = True
        )[: limit]
        by_followers = sorted(
            videos,
            key = lambda v: InsightsRepository.
            calculate_follower_conversion_rate(v),
            reverse = True
        )[: limit]
        by_watch_time = sorted(
            videos,
            key = lambda v: v.avg_watch_time,
            reverse = True
        )[: limit]

        return PerformanceRankingsResponse(
            by_views = [to_video_performance(v) for v in by_views],
            by_engagement_rate = [
                to_video_performance(v) for v in by_engagement
            ],
            by_follower_conversion = [
                to_video_performance(v) for v in by_followers
            ],
            by_watch_time = [
                to_video_performance(v) for v in by_watch_time
            ],
        )
```

---

## Today I Learned

TIL: I learned how to use list comprehensions and lambda functions effectively to filter and transform data in Python. In `get_performance_rankings`, list comprehensions are used to apply a transformation function (`to_video_performance`) to each video in multiple sorted lists, making the code concise and readable.

```python
[to_video_performance(v) for v in by_views]
```

This pattern reduces redundancy and enhances maintainability by centralizing the transformation logic.

---

*Generated by CodeWorm on 2026-02-28 09:22*
