# PayoutService.create_payout

**Type:** Today I Learned
**Repository:** stripe-referral
**File:** src/stripe_referral/services/payout_service.py
**Language:** python
**Lines:** 142-213
**Complexity:** 6.0

---

## Source Code

```python
def create_payout(
        db: Session,
        tracking_id: int,
        adapter_type: str,
        recipient_data: dict[str,
                             Any],
    ) -> PayoutInfo:
        """
        Create a payout record for a tracking entry
        """
        tracking_repo = ReferralTrackingRepository(db)
        payout_repo = PayoutRepository(db)
        program_repo = ReferralProgramRepository(db)

        tracking = tracking_repo.get_by_id(tracking_id)
        if not tracking:
            raise TrackingNotFoundError(
                f"Tracking ID {tracking_id} not found",
                tracking_id = tracking_id,
            )

        existing_payout = payout_repo.get_by_tracking_id(tracking_id)
        if existing_payout:
            raise PayoutAlreadyExistsError(
                f"Payout already exists for tracking ID {tracking_id}",
                tracking_id = tracking_id,
            )

        program = program_repo.get_by_id(tracking.program_id)
        if not program:
            raise TrackingNotFoundError(
                f"Program ID {tracking.program_id} not found",
                program_id = tracking.program_id,
            )

        adapter = PayoutService._get_adapter(
            adapter_type,
            program.adapter_config
        )

        validation: RecipientValidation = adapter.validate_recipient(
            recipient_data
        )
        if not validation["valid"]:
            raise InvalidRecipientDataError(
                validation.get("error",
                               "Invalid recipient data"),
                recipient_data = recipient_data,
                adapter_type = adapter_type,
            )

        payout = payout_repo.create(
            user_id = tracking.referrer_user_id,
            tracking_id = tracking_id,
            amount = tracking.amount_earned,
            currency = tracking.currency,
            status = PayoutStatus.PENDING.value,
            adapter_type = adapter_type,
            recipient_data = recipient_data,
        )

        return PayoutInfo(
            id = payout.id,
            user_id = payout.user_id,
            amount = payout.amount,
            currency = payout.currency,
            status = payout.status,
            adapter_type = payout.adapter_type,
            processed_at = payout.processed_at.isoformat()
            if payout.processed_at else None,
            external_transaction_id = payout.external_transaction_id,
        )
```

---

## Today I Learned

TIL: This function demonstrates modular error handling by raising specific exceptions like `TrackingNotFoundError` and `PayoutAlreadyExistsError`. This makes the code more readable and maintainable, as each exception handles a distinct scenario, ensuring clear communication of errors.

```python
tracking = tracking_repo.get_by_id(tracking_id)
if not tracking:
    raise TrackingNotFoundError(
        f"Tracking ID {tracking_id} not found",
        tracking_id=tracking_id,
    )
```

By breaking down error checks into specific exceptions, the code becomes easier to understand and debug.

---

*Generated by CodeWorm on 2026-02-21 20:46*
