# ProfileService.get_public_profile_by_username

**Type:** Today I Learned
**Repository:** CertGames-Core
**File:** backend/api/domains/social/services/profile_ops.py
**Language:** python
**Lines:** 35-203
**Complexity:** 20.0

---

## Source Code

```python
def get_public_profile_by_username(
        username: str
    ) -> PublicProfileResponse:
        """
        Get public profile data by username
        Returns user info, achievements, test stats, public certifications, and inventory
        """
        user = User.objects(username = username).first()
        if not user:
            raise NotFoundError("User", username)

        user_id = user.id

        friend_count = Friendship.objects(
            status = FriendshipStatus.ACCEPTED.value
        ).filter(
            __raw__ = {
                "$or": [
                    {
                        "requesterUserId": user_id
                    },
                    {
                        "recipientUserId": user_id
                    }
                ]
            }
        ).count()

        test_stats = TestAnalysisService.get_comprehensive_test_stats_for_user(
            user_id
        )

        public_certs = CertificationService.get_public_certifications_by_user(
            user_id
        )

        all_achievements = AchievementService.get_all()
        achievement_map = {
            ach.achievementId: ach
            for ach in all_achievements
        }

        user_achievement_ids = []
        if user.achievements_v2:
            for ach in user.achievements_v2:
                if isinstance(ach, dict):
                    user_achievement_ids.append(ach.get('achievementId'))
                else:
                    user_achievement_ids.append(ach.achievementId)

        unlocked_achievements: list[AchievementDict] = []
        for ach_id in user_achievement_ids:
            if ach_id in achievement_map:
                ach = achievement_map[ach_id]
                unlocked_achievements.append(
                    {
                        "achievementId": ach.achievementId,
                        "title": ach.title,
                        "description": ach.description,
                        "xpReward": ach.xpReward,
                        "coinReward": ach.coinReward,
                        "category": ach.category,
                    }
                )

        total_achievements = len(all_achievements)
        unlocked_count = len(unlocked_achievements)
        completion_percentage = round(
            (unlocked_count / total_achievements * 100),
            2
        ) if total_achievements > 0 else 0

        inventory_avatars: list[AvatarItemDict] = []
        inventory_name_colors: list[NameColorItemDict] = []
        inventory_xp_boosts: list[XPBoostItemDict] = []
        total_coins_spent = 0.0

        if user.purchasedItems:
            shop_items = Shop.objects(id__in = user.purchasedItems)
            for item in shop_items:
                if item.type == "avatar":
                    is_equipped = user.currentAvatar and str(
                        user.currentAvatar
                    ) == str(item.id)
                    inventory_avatars.append(
                        {
                 
```

---

## Today I Learned

TIL: In the `get_public_profile_by_username` function, list comprehensions and dictionary comprehensions are used to efficiently filter and transform data, making the code concise and readable. For example:

```python
unlocked_achievements = [
    {
        "achievementId": ach.achievementId,
        "title": ach.title,
        "description": ach.description,
        "xpReward": ach.xpReward,
        "coinReward": ach.coinReward,
        "category": ach.category,
    }
    for ach_id in user_achievement_ids
    if ach_id in achievement_map
]
```

This pattern reduces boilerplate and enhances code clarity by directly mapping conditions to output.

---

*Generated by CodeWorm on 2026-02-19 12:49*
