# RuleEngine.score_request

**Type:** Today I Learned
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/app/core/detection/rules.py
**Language:** python
**Lines:** 91-135
**Complexity:** 13.0

---

## Source Code

```python
def score_request(
        self,
        features: dict[str, int | float | bool | str],
        entry: ParsedLogEntry,
    ) -> RuleResult:
        """
        Evaluate all rules against a request and return a composite score.
        """
        matched: list[tuple[str, float]] = []

        uri = entry.path
        if entry.query_string:
            uri = f"{entry.path}?{entry.query_string}"

        for rule in _PATTERN_RULES:
            if rule.pattern.search(uri):
                matched.append((rule.name, rule.score))

        if DOUBLE_ENCODED.search(uri):
            matched.append(("DOUBLE_ENCODING", _DOUBLE_ENCODING_SCORE))

        ua_lower = entry.user_agent.lower()
        if any(sig in ua_lower for sig in SCANNER_USER_AGENTS):
            matched.append(("SCANNER_UA", _SCANNER_UA_SCORE))

        for trule in _THRESHOLD_RULES:
            value = features.get(trule.feature_key, 0)
            if isinstance(value, int | float) and value > trule.threshold:
                matched.append((trule.name, trule.score))

        if not matched:
            return RuleResult(threat_score=0.0, severity="LOW")

        scores = sorted([s for _, s in matched], reverse=True)
        threat_score = min(
            scores[0] + _BOOST_PER_ADDITIONAL_RULE * (len(scores) - 1),
            1.0,
        )

        return RuleResult(
            threat_score=threat_score,
            severity=_classify_severity(threat_score),
            matched_rules=[name for name, _ in matched],
            component_scores=dict(matched),
        )
```

---

## Today I Learned

TIL: I learned about how the `score_request` function dynamically builds a list of matched rules and their scores using a simple and readable approach with list comprehensions and conditional appends. This makes the logic clear and easy to maintain, ensuring that all relevant rules are evaluated against each request.

```python
matched.append((rule.name, rule.score))
```
This line is particularly clever as it succinctly adds matched rules to the `matched` list, making the function both concise and understandable.

---

*Generated by CodeWorm on 2026-02-19 10:28*
