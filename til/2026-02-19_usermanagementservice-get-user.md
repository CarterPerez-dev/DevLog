# UserManagementService.get_user_analytics_summary

**Type:** Today I Learned
**Repository:** CertGames-Core
**File:** backend/api/admin/domains/users/services.py
**Language:** python
**Lines:** 379-531
**Complexity:** 21.0

---

## Source Code

```python
def get_user_analytics_summary(user_id: str) -> dict[str, Any]:
        """
        Get user analytics summary
        """
        user = User.objects(id = user_id).first()
        if not user:
            raise NotFoundError(f"User not found: {user_id}")

        user_mgmt = UserManagement.objects(userId = user.id).first()

        test_stats = TestAttempt.objects(
            userId = user.id,
            finished = True
        ).aggregate(
            [
                {
                    "$group": {
                        "_id": None,
                        "total_tests": {
                            "$sum": 1
                        },
                        "avg_score": {
                            "$avg": "$score"
                        },
                        "perfect_tests": {
                            "$sum": {
                                "$cond": [{
                                    "$eq": ["$score",
                                            100]
                                },
                                          1,
                                          0]
                            }
                        },
                        "total_time": {
                            "$sum": "$examTimerSeconds"
                        },
                    }
                }
            ]
        )

        test_stats_list = list(test_stats) if test_stats else []
        test_summary = test_stats_list[0] if test_stats_list else {
            "total_tests": 0,
            "avg_score": 0,
            "perfect_tests": 0,
            "total_time": 0
        }

        lifetime_value = 0.0
        if user.subscriptionActive and user.subscriptionStartDate:
            subscription_start = user.subscriptionStartDate.replace(
                tzinfo = UTC
            ) if user.subscriptionStartDate.tzinfo is None else user.subscriptionStartDate
            months_subscribed = (
                datetime.now(UTC) - subscription_start
            ).days / 30
            lifetime_value = months_subscribed * 29.99

        login_frequency = "unknown"
        if user.lastLoginAt and user.createdAt:
            created_at = user.createdAt.replace(
                tzinfo = UTC
            ) if user.createdAt.tzinfo is None else user.createdAt
            days_active = (datetime.now(UTC) - created_at).days
            if days_active > 0:
                login_rate = user.achievement_counters.get(
                    "daysActive",
                    0
                ) / days_active
                if login_rate > 0.7:
                    login_frequency = "daily"
                elif login_rate > 0.3:
                    login_frequency = "regular"
                elif login_rate > 0.1:
                    login_frequency = "occasional"
                else:
                    login_frequency = "rare"

        response = {
            "lifetime_value": round(lifetime_value,
                                    2),
      
```

---

## Today I Learned

TIL: In the `get_user_analytics_summary` function, the use of aggregation pipelines with `$group` and `$avg` is clever for calculating summary statistics from test attempts. This concise approach efficiently computes metrics like total tests, average score, and perfect tests without looping through data in Python.

```python
test_stats = TestAttempt.objects(...).aggregate([
    {"$group": {...}}
])
```

This reduces database load by performing complex calculations on the server side.

---

*Generated by CodeWorm on 2026-02-19 13:34*
