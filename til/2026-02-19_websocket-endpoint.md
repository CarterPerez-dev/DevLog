# websocket_endpoint

**Type:** Today I Learned
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/encrypted-p2p-chat/backend/app/api/websocket.py
**Language:** python
**Lines:** 26-84
**Complexity:** 9.0

---

## Source Code

```python
async def websocket_endpoint(
    websocket: WebSocket,
    user_id: str = Query(...),
) -> None:
    """
    Main WebSocket endpoint for real time messaging
    """
    try:
        user_uuid = UUID(user_id)
    except ValueError:
        logger.error("Invalid user_id format: %s", user_id)
        await websocket.close(code = 1008, reason = "Invalid user ID")
        return

    connected = await connection_manager.connect(websocket, user_uuid)

    if not connected:
        return

    try:
        while True:
            data = await websocket.receive_text()

            try:
                message = json.loads(data)
                await websocket_service.route_message(
                    websocket,
                    user_uuid,
                    message
                )
            except json.JSONDecodeError:
                logger.error(
                    "Invalid JSON from user %s: %s",
                    user_uuid,
                    data[: 100]
                )
                await websocket.send_json(
                    {
                        "type": "error",
                        "error_code": "invalid_json",
                        "error_message": "Invalid JSON format"
                    }
                )
            except Exception as e:
                logger.error("Error handling message from %s: %s", user_uuid, e)
                await websocket.send_json(
                    {
                        "type": "error",
                        "error_code": "processing_error",
                        "error_message": str(e)
                    }
                )

    except WebSocketDisconnect:
        logger.info("WebSocket disconnected for user %s", user_uuid)
    except Exception as e:
        logger.error("WebSocket error for user %s: %s", user_uuid, e)
    finally:
        await connection_manager.disconnect(websocket, user_uuid)
```

---

## Today I Learned

TIL: In the `websocket_endpoint` function, the use of `try-except` blocks is clever for handling various error scenarios. This ensures robust error logging and graceful disconnection management, making the WebSocket endpoint more reliable and maintainable.

```markdown
Today I learned that using nested try-except blocks in the `websocket_endpoint` function handles both JSON parsing errors and general exceptions, ensuring proper logging and error responses. üêõ‚ú®
```

---

*Generated by CodeWorm on 2026-02-19 16:00*
