# validate_ensemble

**Type:** Today I Learned
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/ml/validation.py
**Language:** python
**Lines:** 54-113
**Complexity:** 5.0

---

## Source Code

```python
def validate_ensemble(
    model_dir: Path,
    X_test: np.ndarray,
    y_test: np.ndarray,
    ensemble_weights: dict[str, float] | None = None,
    pr_auc_gate: float = 0.85,
    f1_gate: float = 0.80,
) -> ValidationResult:
    """
    Run all 3 models on test data and compute classification metrics
    """
    weights = ensemble_weights or DEFAULT_ENSEMBLE_WEIGHTS

    engine = InferenceEngine(model_dir=str(model_dir))
    if not engine.is_loaded:
        raise RuntimeError(f"Failed to load models from {model_dir}")

    raw_scores = engine.predict(X_test.astype(np.float32), )
    if raw_scores is None:
        raise RuntimeError("Inference returned None")

    fused = _compute_fused_scores(raw_scores, engine.threshold, weights)

    y_pred = (fused >= BINARY_THRESHOLD).astype(np.int32)

    prec = float(precision_score(y_test, y_pred, zero_division=0))
    rec = float(recall_score(y_test, y_pred, zero_division=0))
    f1_val = float(f1_score(y_test, y_pred, zero_division=0))
    pr_auc_val = float(average_precision_score(y_test, fused))
    roc_auc_val = float(roc_auc_score(y_test, fused))

    cm = confusion_matrix(y_test, y_pred).tolist()

    pr_auc_passed = pr_auc_val >= pr_auc_gate
    f1_passed = f1_val >= f1_gate
    gate_details = {
        "pr_auc": pr_auc_passed,
        "f1": f1_passed,
    }

    logger.info(
        "Validation: precision=%.3f recall=%.3f "
        "f1=%.3f pr_auc=%.3f roc_auc=%.3f",
        prec,
        rec,
        f1_val,
        pr_auc_val,
        roc_auc_val,
    )

    return ValidationResult(
        precision=prec,
        recall=rec,
        f1=f1_val,
        pr_auc=pr_auc_val,
        roc_auc=roc_auc_val,
        confusion_matrix=cm,
        passed_gates=pr_auc_passed and f1_passed,
        gate_details=gate_details,
    )
```

---

## Today I Learned

TIL: In the `validate_ensemble` function, optional parameters like `ensemble_weights`, `pr_auc_gate`, and `f1_gate` are provided with default values using `| None = None`. This allows flexibility in calling the function while ensuring all required metrics are computed even if some optional parameters aren't specified. Clever for handling variable inputs! ðŸš€

---

*Generated by CodeWorm on 2026-02-28 12:04*
