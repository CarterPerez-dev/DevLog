# ReferralService.validate_code

**Type:** Today I Learned
**Repository:** stripe-referral
**File:** src/stripe_referral/services/referral_service.py
**Language:** python
**Lines:** 86-127
**Complexity:** 7.0

---

## Source Code

```python
def validate_code(db: Session, code: str) -> CodeValidation:
        """
        Validate if a code is active and usable
        """
        code_repo = ReferralCodeRepository(db)

        code_obj = code_repo.get_by_code(code)
        if not code_obj:
            raise CodeNotFoundError(
                f"Code '{code}' not found",
                code = code
            )

        if code_obj.status != ReferralCodeStatus.ACTIVE.value:
            raise CodeInactiveError(
                f"Code '{code}' is inactive (status: {code_obj.status})",
                code = code,
                status = code_obj.status,
            )

        if code_obj.expires_at and code_obj.expires_at < datetime.now(UTC
                                                                      ):
            raise CodeExpiredError(
                f"Code '{code}' expired at {code_obj.expires_at.isoformat()}",
                code = code,
                expires_at = code_obj.expires_at.isoformat(),
            )

        if code_obj.max_uses and code_obj.uses_count >= code_obj.max_uses:
            raise CodeMaxUsesReachedError(
                f"Code '{code}' has reached maximum uses ({code_obj.max_uses})",
                code = code,
                max_uses = code_obj.max_uses,
                uses_count = code_obj.uses_count,
            )

        return CodeValidation(
            valid = True,
            code_id = code_obj.id,
            program_id = code_obj.program_id,
            referrer_user_id = code_obj.user_id,
        )
```

---

## Today I Learned

TIL: I learned how to validate multiple conditions using a series of `if` statements with clear error handling in Python. This approach ensures that each validation step is checked independently, making the function easy to read and maintain. Each condition raises a specific error if not met, providing clear feedback on why the code failed validation.

---

*Generated by CodeWorm on 2026-02-21 23:14*
