# _evaluate_sequence

**Type:** Today I Learned
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/intermediate/siem-dashboard/backend/app/engine/correlation.py
**Language:** python
**Lines:** 212-254
**Complexity:** 9.0

---

## Source Code

```python
def _evaluate_sequence(
    rule: CorrelationRule,
    event_data: dict[str, Any],
    state: CorrelationState,
    rule_id: str,
    group_key: str,
) -> EvaluationResult | None:
    """
    Fire when all steps of a sequence are observed within window for a group
    """
    conditions = rule.conditions
    steps = conditions.get("steps", [])

    matched_step = None
    for idx, step in enumerate(steps):
        step_filter = step.get("event_filter", {})
        if _matches_filter(event_data, step_filter):
            matched_step = idx
            break

    if matched_step is None:
        return None

    event_id = event_data.get("id", "")
    state.record_event(
        rule_id, group_key, event_id, event_data,
        step_index=matched_step,
    )

    window_seconds = conditions.get("window_seconds", 0)
    entries = state.get_window(rule_id, group_key, window_seconds)

    for idx, step in enumerate(steps):
        required_count = step.get("count", 1)
        step_entries = [e for e in entries if e.step_index == idx]
        if len(step_entries) < required_count:
            return None

    state.mark_fired(rule_id, group_key)
    return EvaluationResult(
        matched_event_ids=[e.event_id for e in entries],
        group_value=group_key,
    )
```

---

## Today I Learned

TIL: In `_evaluate_sequence`, the function uses a clever list comprehension to filter and count required events within a sliding window, ensuring all steps are met before marking the sequence as fired. This pattern simplifies complex conditional logic into readable, concise code.

```python
step_entries = [e for e in entries if e.step_index == idx]
if len(step_entries) < required_count:
    return None
```

This snippet elegantly checks if enough events match each step's index, making the function both powerful and easy to understand.

---

*Generated by CodeWorm on 2026-02-28 19:26*
