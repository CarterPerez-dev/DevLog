# serializeRatchetState

**Type:** Today I Learned
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/encrypted-p2p-chat/frontend/src/crypto/double-ratchet.ts
**Language:** typescript
**Lines:** 291-327
**Complexity:** 12.0

---

## Source Code

```typescript
async function serializeRatchetState(
  state: DoubleRatchetState
): Promise<SerializedRatchetState> {
  let dhPrivateKey: string | null = null
  if (state.dh_private_key !== null) {
    const privateKeyBytes = await exportPrivateKey(
      state.dh_private_key.privateKey
    )
    dhPrivateKey = bytesToBase64(privateKeyBytes)
  }

  const skippedKeys: Record<string, string> = {}
  for (const [key, value] of state.skipped_message_keys) {
    skippedKeys[key] = bytesToBase64(value)
  }

  return {
    peer_id: state.peer_id,
    root_key: bytesToBase64(state.root_key),
    sending_chain_key: bytesToBase64(state.sending_chain_key),
    receiving_chain_key:
      state.receiving_chain_key !== null
        ? bytesToBase64(state.receiving_chain_key)
        : null,
    dh_private_key: dhPrivateKey,
    dh_public_key:
      state.dh_public_key !== null ? bytesToBase64(state.dh_public_key) : null,
    dh_peer_public_key:
      state.dh_peer_public_key !== null
        ? bytesToBase64(state.dh_peer_public_key)
        : null,
    sending_message_number: state.sending_message_number,
    receiving_message_number: state.receiving_message_number,
    previous_sending_chain_length: state.previous_sending_chain_length,
    skipped_message_keys: skippedKeys,
  }
}
```

---

## Today I Learned

TIL: In `serializeRatchetState`, nullish coalescing (`??`) is used to handle optional fields gracefully. For example, when serializing `receiving_chain_key` and `dh_public_key`, `null` values are converted to `null` in the output object instead of omitting them. This ensures all keys exist in the serialized state, making it easier to manage and deserialize later.

```typescript
receiving_chain_key: state.receiving_chain_key !== null ? bytesToBase64(state.receiving_chain_key) : null,
dh_public_key: state.dh_public_key !== null ? bytesToBase64(state.dh_public_key) : null,
```

This pattern simplifies handling optional fields, ensuring consistency in the serialized data.

---

*Generated by CodeWorm on 2026-02-18 20:11*
