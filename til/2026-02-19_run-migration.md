# run_migration

**Type:** Today I Learned
**Repository:** CertGames-Core
**File:** backend/devtools/migrations/migrate_achievements_v2.py
**Language:** python
**Lines:** 262-396
**Complexity:** 14.0

---

## Source Code

```python
def run_migration(uri, db_name, dry_run = False, batch_size = 100):
    """
    Run the actual migration.
    """
    print("\n" + "=" * 70)
    print(f"RUNNING MIGRATION {'(DRY RUN)' if dry_run else ''}")
    print(f"Database: {db_name}")
    print("=" * 70)

    client = MongoClient(uri)
    try:
        db = client[db_name]
        collection = db[COLLECTION_NAME]

        users_to_migrate = collection.find(
            {
                "achievements": {
                    "$exists": True,
                    "$ne": []
                },
                "$or": [
                    {
                        "achievements_v2": {
                            "$exists": False
                        }
                    },
                    {
                        "achievements_v2": []
                    },
                    {
                        "achievements_v2": {
                            "$size": 0
                        }
                    }
                ]
            }
        )

        count = collection.count_documents(
            {
                "achievements": {
                    "$exists": True,
                    "$ne": []
                },
                "$or": [
                    {
                        "achievements_v2": {
                            "$exists": False
                        }
                    },
                    {
                        "achievements_v2": []
                    },
                    {
                        "achievements_v2": {
                            "$size": 0
                        }
                    }
                ]
            }
        )

        print(f"\nUsers needing migration: {count}")

        if count == 0:
            print("No users need migration!")
            return True

        if not dry_run:
            confirm = input(
                f"\nMigrate {count} users? Type 'YES' to confirm: "
            )
            if confirm != "YES":
                print("Aborted.")
                return False

        migrated = 0
        errors = 0

        for user in users_to_migrate:
            try:
                old_achievements = user.get("achievements", [])
                created_at = user.get("createdAt", datetime.now(UTC))

                if isinstance(created_at, str):
                    try:
                        created_at = datetime.fromisoformat(
                            created_at.replace("Z",
                                               "+00:00")
                        )
                    except ValueError:
                        created_at = datetime.now(UTC)

                new_achievements_v2 = []
                for ach_id in old_achievements:
                    new_achievements_v2.append(
                        {
                            "achievementId": str(ach_id),
                            "unlockedAt": created_at
                        }
                    )

                if not dry_
```

---

## Today I Learned

TIL: The `dry_run` parameter in `run_migration` allows for both simulation and actual execution, controlled via a simple boolean flag. This makes the function versatile, enabling developers to test migrations without affecting live data.

```python
def run_migration(uri, db_name, dry_run=False, batch_size=100):
    # ...
    if not dry_run:
        confirm = input("Migrate users? Type 'YES' to confirm: ")
        if confirm != "YES":
            print("Aborted.")
            return False

    # ...
```

This pattern simplifies testing and deployment, making the function both flexible and user-friendly.

---

*Generated by CodeWorm on 2026-02-19 21:42*
