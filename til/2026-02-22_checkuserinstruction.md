# checkUserInstruction

**Type:** Today I Learned
**Repository:** docksec
**File:** internal/analyzer/dockerfile.go
**Language:** go
**Lines:** 71-117
**Complexity:** 9.0

---

## Source Code

```go
func (a *DockerfileAnalyzer) checkUserInstruction(
	target finding.Target,
	ast *parser.Node,
) finding.Collection {
	var findings finding.Collection

	hasUser := false
	var lastFromLine int

	for _, node := range ast.Children {
		switch strings.ToUpper(node.Value) {
		case "FROM":
			lastFromLine = node.StartLine
			hasUser = false
		case "USER":
			hasUser = true
			user := ""
			if node.Next != nil {
				user = node.Next.Value
			}
			if user == "root" || user == "0" {
				loc := &finding.Location{Path: a.path, Line: node.StartLine}
				f := finding.New("DS-USER-ROOT", "USER instruction sets root user", finding.SeverityMedium, target).
					WithDescription("Dockerfile explicitly sets USER to root, which should be avoided.").
					WithCategory(string(CategoryDockerfile)).
					WithLocation(loc).
					WithRemediation("Create and use a non-root user in the Dockerfile.")
				findings = append(findings, f)
			}
		}
	}

	if !hasUser && lastFromLine > 0 {
		control, _ := benchmark.Get("4.1")
		loc := &finding.Location{Path: a.path, Line: lastFromLine}
		f := finding.New("CIS-4.1", control.Title, finding.SeverityMedium, target).
			WithDescription(control.Description).
			WithCategory(string(CategoryDockerfile)).
			WithLocation(loc).
			WithRemediation(control.Remediation).
			WithReferences(control.References...).
			WithCISControl(control.ToCISControl())
		findings = append(findings, f)
	}

	return findings
}
```

---

## Today I Learned

TIL: In `checkUserInstruction`, the function cleverly uses a switch statement to parse Dockerfile instructions, identifying and flagging instances where the `USER` is set to `root`. This approach ensures security by recommending non-root user creation, enhancing Dockerfile best practices.

```go
switch strings.ToUpper(node.Value) {
case "FROM":
    lastFromLine = node.StartLine
case "USER":
    hasUser = true
    if user == "root" || user == "0" {
        findings = append(findings, finding.New("DS-USER-ROOT", ...))
    }
}
```

This pattern efficiently scans the Dockerfile for critical security settings.

---

*Generated by CodeWorm on 2026-02-22 11:15*
