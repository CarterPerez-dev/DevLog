# list_rooms

**Type:** Today I Learned
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/encrypted-p2p-chat/backend/app/api/rooms.py
**Language:** python
**Lines:** 136-200
**Complexity:** 10.0

---

## Source Code

```python
async def list_rooms(
    user_id: str,
    session: AsyncSession = Depends(get_session),
) -> RoomListResponse:
    """
    List all rooms for the specified user
    """
    user = await auth_service.get_user_by_id(session, UUID(user_id))

    if not user:
        raise HTTPException(
            status_code = status.HTTP_404_NOT_FOUND,
            detail = "User not found",
        )

    room_data_list = await surreal_db.get_rooms_for_user(user_id)

    rooms: list[RoomAPIResponse] = []

    for room_data in room_data_list:
        if not room_data:
            continue

        room_id = str(room_data.get("id", ""))
        participants_data = await surreal_db.get_room_participants(room_id)

        participants: list[ParticipantResponse] = []

        for p_data in participants_data:
            p_user_id = p_data.get("user_id")
            if not p_user_id:
                continue

            p_user = await auth_service.get_user_by_id(session, UUID(p_user_id))
            if p_user:
                participants.append(
                    ParticipantResponse(
                        user_id = str(p_user.id),
                        username = p_user.username,
                        display_name = p_user.display_name,
                        role = p_data.get("role", "member"),
                        joined_at = str(p_data.get("joined_at", "")),
                    )
                )

        other_participant = next(
            (p for p in participants if p.user_id != user_id),
            None
        )
        room_name = other_participant.display_name if other_participant else None

        rooms.append(
            RoomAPIResponse(
                id = room_id,
                type = RoomType(room_data.get("room_type", "direct")),
                name = room_name,
                participants = participants,
                unread_count = 0,
                is_encrypted = True,
                created_at = str(room_data.get("created_at", "")),
                updated_at = str(room_data.get("updated_at", "")),
            )
        )

    return RoomListResponse(rooms = rooms)
```

---

## Today I Learned

TIL: I learned how to efficiently filter and process nested data using Python's `next()` with a generator expression. In the `list_rooms` function, `next((p for p in participants if p.user_id != user_id), None)` elegantly finds the first participant other than the specified user, showcasing a concise and readable approach to handling optional values.

This pattern reduces boilerplate code and makes the logic clear and maintainable.

---

*Generated by CodeWorm on 2026-02-19 08:54*
