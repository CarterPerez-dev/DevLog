# StripeConnectAdapter.send_payout

**Type:** Today I Learned
**Repository:** stripe-referral
**File:** src/stripe_referral/adapters/stripe_connect.py
**Language:** python
**Lines:** 36-106
**Complexity:** 8.0

---

## Source Code

```python
def send_payout(
        self,
        user_id: str,
        amount: float,
        currency: str,
        recipient_data: dict[str,
                             Any],
    ) -> PayoutResult:
        """
        Send payout via Stripe Connect transfer
        """
        try:
            connected_account_id = recipient_data.get(
                "stripe_connect_account_id"
            )
            if not connected_account_id:
                return PayoutResult(
                    success = False,
                    error =
                    "Missing stripe_connect_account_id in recipient_data",
                )

            if not connected_account_id.startswith(
                    STRIPE_CONNECT_ACCOUNT_ID_PREFIX):
                return PayoutResult(
                    success = False,
                    error =
                    f"Invalid Stripe account ID format: {connected_account_id}",
                )

            amount_cents = int(amount * 100)

            transfer = stripe.Transfer.create(
                amount = amount_cents,
                currency = currency.lower(),
                destination = connected_account_id,
                metadata = {"user_id": user_id},
            )

            if not transfer.id.startswith(STRIPE_TRANSFER_ID_PREFIX):
                return PayoutResult(
                    success = False,
                    error =
                    f"Unexpected transfer ID format: {transfer.id}",
                )

            return PayoutResult(
                success = True,
                transaction_id = transfer.id,
            )

        except stripe.InvalidRequestError as e:
            return PayoutResult(
                success = False,
                error = f"Invalid request: {str(e)}",
            )
        except stripe.AuthenticationError as e:
            return PayoutResult(
                success = False,
                error = f"Authentication failed: {str(e)}",
            )
        except stripe.StripeError as e:
            return PayoutResult(
                success = False,
                error = f"Stripe error: {str(e)}",
            )
        except Exception as e:
            return PayoutResult(
                success = False,
                error = f"Unexpected error: {str(e)}",
            )
```

---

## Today I Learned

TIL: This function uses `stripe.Transfer.create` to send payouts via Stripe Connect, ensuring data integrity by validating `connected_account_id` format and transfer ID. The structured error handling with specific exceptions makes debugging easier.

```python
send_payout(self, user_id: str, amount: float, currency: str, recipient_data: dict[str, Any]) -> PayoutResult:
    # ...
    try:
        # Validation and creation of Stripe transfer
    except stripe.InvalidRequestError as e:
        # Handle invalid request
    except stripe.AuthenticationError as e:
        # Handle authentication failure
    except stripe.StripeError as e:
        # Handle general Stripe errors
    except Exception as e:
        # Catch-all for unexpected errors
    return PayoutResult(success=False, error=str(e))
```

This pattern ensures robust error management and clear feedback.

---

*Generated by CodeWorm on 2026-02-21 22:04*
