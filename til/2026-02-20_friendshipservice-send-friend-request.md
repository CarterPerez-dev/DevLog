# FriendshipService.send_friend_request

**Type:** Today I Learned
**Repository:** CertGames-Core
**File:** backend/api/domains/social/services/friendship_ops.py
**Language:** python
**Lines:** 29-112
**Complexity:** 10.0

---

## Source Code

```python
def send_friend_request(
        requester_id: str | ObjectId,
        recipient_id: str | ObjectId,
        existing_friendship_id: str | ObjectId | None = None
    ) -> Friendship:
        """
        Create a new friend request or reuse existing rejected one
        """
        requester_id = ObjectId(requester_id) if isinstance(
            requester_id,
            str
        ) else requester_id
        recipient_id = ObjectId(recipient_id) if isinstance(
            recipient_id,
            str
        ) else recipient_id

        if existing_friendship_id is not None:
            existing_friendship_id = ObjectId(existing_friendship_id
                                              ) if isinstance(
                                                  existing_friendship_id,
                                                  str
                                              ) else existing_friendship_id

            friendship = Friendship.objects(id = existing_friendship_id
                                            ).first()
            if friendship:
                friendship.update(
                    set__status = FriendshipStatus.PENDING.value,
                    set__createdAt = datetime.now(UTC)
                )
                friendship.reload()

                requester = User.objects(
                    id = requester_id
                ).only("username",
                       "level",
                       "currentAvatar",
                       "nameColor").first()

                if requester:
                    SocialSocketService.emit_friend_request_received(
                        friendship_id = str(friendship.id),
                        requester_id = str(requester_id),
                        requester_username = requester.username,
                        requester_level = requester.level,
                        requester_avatar = str(requester.currentAvatar)
                        if requester.currentAvatar else None,
                        requester_name_color = requester.nameColor,
                        recipient_id = str(recipient_id),
                        created_at = friendship.createdAt
                    )

                return friendship

        friendship = Friendship(
            requesterUserId = requester_id,
            recipientUserId = recipient_id,
            status = FriendshipStatus.PENDING.value,
            createdAt = datetime.now(UTC)
        )
        friendship.save()

        requester = User.objects(
            id = requester_id
        ).only("username",
               "level",
               "currentAvatar",
               "nameColor").first()

        if requester:
            SocialSocketService.emit_friend_request_received(
                friendship_id = str(friendship.id),
                requester_id = str(requester_id),
                requester_username = requester.username,
                requester_level = requester.level,
                requester_avatar =
```

---

## Today I Learned

TIL: This function uses type hints with `str | ObjectId` to handle both string and MongoDB ObjectId types seamlessly, making it flexible for different input formats.

```python
requester_id: str | ObjectId,
recipient_id: str | ObjectId,
```

This clever approach ensures the function can work with either a string or an ObjectId, enhancing its usability.

---

*Generated by CodeWorm on 2026-02-20 12:26*
