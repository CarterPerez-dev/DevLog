# create_order

**Type:** Today I Learned
**Repository:** fastapi-rc
**File:** fastapi-rc/examples/04_full_api_example.py
**Language:** python
**Lines:** 194-240
**Complexity:** 4.0

---

## Source Code

```python
async def create_order(
    user_id: str,
    product_ids: list[str],
    user_cache: UserCache,
    product_cache: ProductCache,
    order_cache: OrderCache,
    redis: RedisClient,
):
    """
    Create order with multi-cache coordination

    Pattern: Cache user, products, then order creation
    """
    user = await user_cache.get_or_set(
        identifier = user_id,
        factory = lambda: fetch_user(user_id),
    )

    products: list[Product] = []
    for product_id in product_ids:
        product = await product_cache.get_or_set(
            identifier = product_id,
            factory = lambda pid = product_id: fetch_product(pid),
        )
        products.append(product)

    total = sum(p.price for p in products)

    order = Order(
        id = "order_123",
        user_id = user.id,
        product_ids = product_ids,
        total = total,
        created_at = datetime.now(),
    )

    await order_cache.set(
        identifier = order.id,
        value = order,
        ttl = 300,
    )

    async for key in redis.scan_iter(
            f"ecommerce:v1:orders:user:{user_id}:*"):
        await redis.delete(key)

    return order
```

---

## Today I Learned

TIL: I learned about the `async for` loop with `redis.scan_iter()` to efficiently clean up old order-related keys from Redis. This pattern ensures stale data is removed while iterating asynchronously, keeping the cache fresh and reducing unnecessary deletions.

```python
for key in redis.scan_iter(f"ecommerce:v1:orders:user:{user_id}:*"):
    await redis.delete(key)
```

can be optimized to:

```python
async for key in redis.scan_iter(f"ecommerce:v1:orders:user:{user_id}:*"):
    await redis.delete(key)
```

This async iteration ensures efficient cleanup without blocking the event loop.

---

*Generated by CodeWorm on 2026-02-21 18:10*
