# UserManagementService.get_user_details

**Type:** Today I Learned
**Repository:** CertGames-Core
**File:** backend/api/admin/domains/users/services.py
**Language:** python
**Lines:** 217-376
**Complexity:** 27.0

---

## Source Code

```python
def get_user_details(user_id: str) -> dict[str, Any]:
        """
        Get comprehensive user information
        """
        user = User.objects(id = user_id).first()
        if not user:
            raise NotFoundError(f"User not found: {user_id}")

        user_mgmt = UserManagement.objects(userId = user.id).first()

        days_since_signup = (
            datetime.now(UTC) - (
                user.createdAt.replace(tzinfo = UTC) if user.createdAt
                and user.createdAt.tzinfo is None else user.createdAt
            )
        ).days if user.createdAt else 0
        test_attempts = TestAttempt.objects(
            userId = user.id,
            finished = True
        ).count()

        calculator = UserEngagementCalculator(
            user,
            test_attempts,
            days_since_signup
        )
        engagement_score, engagement_factors = calculator.calculate_engagement_score()

        achievement_details = []
        if user.achievements_v2:
            achievement_ids = [
                a.achievementId for a in user.achievements_v2
            ]
            achievements = Achievement.objects(
                achievementId__in = achievement_ids
            )
            achievement_map = {a.achievementId: a for a in achievements}

            for user_achievement in user.achievements_v2:
                if achievement := achievement_map.get(
                        user_achievement.achievementId):
                    achievement_details.append(
                        {
                            "achievement":
                            achievement.to_dict(),
                            "unlockedAt":
                            user_achievement.unlockedAt.isoformat()
                            if user_achievement.unlockedAt else None
                        }
                    )

        shop_items_details = []
        if user.purchasedItems:
            items = Shop.objects(id__in = user.purchasedItems)
            shop_items_details = [item.to_dict() for item in items]

        game_stats = UserManagementService._get_user_game_stats(user)

        subscription_info = UserManagementService._get_subscription_info(
            user
        )

        location_info = UserManagementService._get_location_info(
            user.currentIP or user.lastLoginIP
        )

        return {
            "basic_info": {
                "user_id":
                str(user.id),
                "username":
                user.username,
                "email":
                user.email,
                "created_at":
                user.createdAt.isoformat() if user.createdAt else None,
                "updated_at":
                user.updatedAt.isoformat() if user.updatedAt else None,
                "days_since_signup":
                days_since_signup,
            },
            "activity": {
                "is_online":
                user.isOnline,
                "last_login_at":
                user.lastLogi
```

---

## Today I Learned

TIL: In `get_user_details`, the code uses a nested ternary operator to handle timezone-aware datetimes elegantly, ensuring `user.createdAt` is always treated as UTC before calculating days since signup.

```python
days_since_signup = (
    datetime.now(UTC) - (
        user.createdAt.replace(tzinfo=UTC)
        if user.createdAt and user.createdAt.tzinfo is None else user.createdAt
    )
).days if user.createdAt else 0
```

This concise pattern ensures timezone consistency, making the code both readable and robust.

---

*Generated by CodeWorm on 2026-02-19 12:52*
