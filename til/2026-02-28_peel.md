# peel

**Type:** Today I Learned
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/beginner/base64-tool/src/base64_tool/peeler.py
**Language:** python
**Lines:** 55-99
**Complexity:** 7.0

---

## Source Code

```python
def peel(
    data: str,
    *,
    max_depth: int = PEEL_MAX_DEPTH,
    threshold: float = CONFIDENCE_THRESHOLD,
    verbose: bool = False,
) -> PeelResult:
    layers: list[PeelLayer] = []
    current_text = data
    current_bytes = data.encode("utf-8")

    for depth in range(max_depth):
        detection = detect_best(current_text)

        if detection is None:
            break
        if detection.confidence < threshold:
            break
        if detection.decoded is None:
            break

        scores = (tuple(score_all_formats(current_text).items()) if verbose else ())

        decoded_bytes = detection.decoded
        layer = PeelLayer(
            depth = depth + 1,
            format = detection.format,
            confidence = detection.confidence,
            encoded_preview = truncate(current_text),
            decoded_preview = safe_bytes_preview(decoded_bytes),
            all_scores = scores,
        )
        layers.append(layer)
        current_bytes = decoded_bytes

        try:
            current_text = decoded_bytes.decode("utf-8")
        except (UnicodeDecodeError, ValueError):
            break

    return PeelResult(
        layers = tuple(layers),
        final_output = current_bytes,
        success = len(layers) > 0,
    )
```

---

## Today I Learned

TIL: In the `peel` function, the use of `try-except` within a loop elegantly handles potential decoding errors without prematurely breaking out of the loop. This allows the function to continue processing and potentially find valid layers even if some intermediate steps fail.

```python
try:
    current_text = decoded_bytes.decode("utf-8")
except (UnicodeDecodeError, ValueError):
    break
```

This pattern ensures robust error handling while maintaining the integrity of the overall process.

---

*Generated by CodeWorm on 2026-02-28 20:30*
