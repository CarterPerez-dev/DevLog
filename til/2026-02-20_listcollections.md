# ListCollections

**Type:** Today I Learned
**Repository:** angelamos-operations
**File:** CertGamesDB-Argos/go-backend/internal/mongodb/collections.go
**Language:** go
**Lines:** 93-151
**Complexity:** 12.0

---

## Source Code

```go
func (r *CollectionsRepository) ListCollections(ctx context.Context, dbName string) ([]CollectionInfo, error) {
	db := r.client.client.Database(dbName)

	cursor, err := db.ListCollections(ctx, bson.D{})
	if err != nil {
		return nil, fmt.Errorf("list collections: %w", err)
	}
	defer cursor.Close(ctx)

	var collections []CollectionInfo
	for cursor.Next(ctx) {
		var result bson.M
		if err := cursor.Decode(&result); err != nil {
			continue
		}

		name, _ := result["name"].(string)
		collType, _ := result["type"].(string)

		if collType == "" {
			collType = "collection"
		}

		info := CollectionInfo{
			Name: name,
			Type: collType,
		}

		count, _ := db.Collection(name).EstimatedDocumentCount(ctx)
		info.DocumentCount = count

		var stats bson.M
		if err := db.RunCommand(ctx, bson.D{{"collStats", name}}).Decode(&stats); err == nil {
			if size, ok := stats["size"].(int32); ok {
				info.SizeBytes = int64(size)
			} else if size, ok := stats["size"].(int64); ok {
				info.SizeBytes = size
			}
			if avgSize, ok := stats["avgObjSize"].(int32); ok {
				info.AvgDocSize = int64(avgSize)
			} else if avgSize, ok := stats["avgObjSize"].(int64); ok {
				info.AvgDocSize = avgSize
			} else if avgSize, ok := stats["avgObjSize"].(float64); ok {
				info.AvgDocSize = int64(avgSize)
			}
			if nindexes, ok := stats["nindexes"].(int32); ok {
				info.IndexCount = int(nindexes)
			}
		}

		collections = append(collections, info)
	}

	sort.Slice(collections, func(i, j int) bool {
		return collections[i].DocumentCount > collections[j].DocumentCount
	})

	return collections, nil
}
```

---

## Today I Learned

TIL: In `ListCollections`, the code handles potential errors gracefully by using multiple type assertions and fallbacks when decoding stats, ensuring robustness even if some fields are missing. This makes the function more resilient without compromising on data collection.

```go
if err := db.RunCommand(ctx, bson.D{{"collStats", name}}).Decode(&stats); err == nil {
    // Handle stats decoding with multiple type assertions
}
```

This pattern ensures that the function can adapt to varying document structures.

---

*Generated by CodeWorm on 2026-02-20 22:32*
