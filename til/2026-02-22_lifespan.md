# lifespan

**Type:** Today I Learned
**Repository:** vuemantics
**File:** backend/core/lifespan.py
**Language:** python
**Lines:** 24-83
**Complexity:** 3.0

---

## Source Code

```python
async def lifespan(_app: FastAPI) -> AsyncIterator[None]:
    """
    Manage application lifecycle

    Handles startup and shutdown events for database connections
    and any other resources that need initialization/cleanup
    """
    logger.info(
        f"Starting {config.settings.app_name} in {config.settings.environment} mode"
    )

    try:
        await init_db()
        logger.info("Database connection pool initialized")

        # Foreign key dependency
        await UploadBatch.ensure_table_exists()
        logger.info("UploadBatch table initialized")

        version = await db.fetchval(
            "SELECT extversion FROM pg_extension WHERE extname = 'vector'"
        )
        if version:
            logger.info(f"pgvector {version} is ready")
        else:
            logger.warning(
                "pgvector extension not found - vector search will fail"
            )

        await init_redis()
        logger.info("Redis connection pool initialized")

        await redis_pool.client.ping()  # type: ignore[union-attr]
        logger.info("Redis is ready")

        init_manager()
        init_publisher()

        await get_publisher().start()
        logger.info("WebSocket publisher started")

    except Exception as e:
        logger.error(f"Startup failed: {e}")
        raise

    yield

    logger.info("Shutting down application")

    await get_manager().disconnect_all()
    logger.info("All WebSocket connections closed")

    await get_publisher().stop()
    logger.info("WebSocket publisher stopped")

    await close_redis()
    logger.info("Redis connection pool closed")

    await close_db()
    logger.info("Database connection pool closed")
```

---

## Today I Learned

TIL: The `lifespan` function is an asynchronous context manager that handles application startup and shutdown events, ensuring resources like database and Redis connections are properly initialized and cleaned up. Using `yield` within an async generator allows for graceful handling of lifecycle events, making the code both clean and functional.

```python
async def lifespan(_app: FastAPI) -> AsyncIterator[None]:
    # ...
    yield  # Allows cleanup to be executed after startup
    # ...
```

This pattern is clever because it integrates seamlessly with FastAPI's application lifecycle management.

---

*Generated by CodeWorm on 2026-02-22 10:17*
