# InsightsRepository.get_time_series_data

**Type:** Today I Learned
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/analytics/facets/insights/repository.py
**Language:** python
**Lines:** 432-469
**Complexity:** 3.0

---

## Source Code

```python
async def get_time_series_data(cls,
                                   session: AsyncSession) -> list[dict]:
        """Get performance metrics over time"""
        videos = await cls.get_all_videos(session)

        # Group by date
        date_stats = defaultdict(
            lambda: {
                "views": 0,
                "engagement": 0,
                "new_followers": 0,
                "count": 0,}
        )

        for video in videos:
            date_str = video.date_posted.isoformat()
            engagement_rate = cls.calculate_engagement_rate(video)

            date_stats[date_str]["views"] += video.views
            date_stats[date_str]["engagement"] += engagement_rate
            date_stats[date_str]["new_followers"] += video.new_followers
            date_stats[date_str]["count"] += 1

        # Convert to list and calculate averages
        result = []
        for date_str, stats in sorted(date_stats.items()):
            count = stats["count"]
            result.append(
                {
                    "date": date_str,
                    "views": stats["views"],
                    "engagement_rate": stats["engagement"] / count,
                    "new_followers": stats["new_followers"],
                    "video_count": count,
                }
            )

        return result
```

---

## Today I Learned

TIL: I learned how to use `defaultdict` with a lambda function to efficiently group and aggregate data by date in Python. This approach simplifies the accumulation of metrics like views, engagement rate, and new followers for each video posted on different dates.

```python
date_stats = defaultdict(lambda: {
    "views": 0,
    "engagement": 0,
    "new_followers": 0,
    "count": 0})
```

This clever use of `defaultdict` ensures that every date has a default dictionary, making the code more concise and easier to read.

---

*Generated by CodeWorm on 2026-03-01 13:06*
