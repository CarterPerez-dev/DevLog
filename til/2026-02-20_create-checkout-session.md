# create_checkout_session

**Type:** Today I Learned
**Repository:** CertGames-Core
**File:** backend/api/domains/account/controllers/subscription/stripe_ctrl.py
**Language:** python
**Lines:** 53-151
**Complexity:** 17.0

---

## Source Code

```python
def create_checkout_session():
    """
    Create a Stripe Checkout session for a new subscription
    """
    user_id = g.validated.get('userId')
    registration_data = g.validated.get('registrationData')
    is_oauth_flow = g.validated.get('isOauthFlow', False)
    referral_code = g.validated.get('referralCode')
    price_id = g.validated.get('priceId') or current_app.config['STRIPE_PRICE_ID']

    validated_referral_code = None
    if referral_code:
        try:
            validation = ReferralOperations.validate_code(referral_code)
            if validation and validation.get('valid'):
                validated_referral_code = referral_code
                current_app.logger.info(
                    f"Valid referral code applied to checkout: {referral_code}"
                )
            else:
                current_app.logger.warning(
                    f"Invalid referral code attempted: {referral_code}"
                )
        except Exception as e:
            current_app.logger.error(
                f"Error validating referral code during checkout: {str(e)}"
            )

    try:
        frontend_url = current_app.config.get(
            'FRONTEND_URL',
            'http://localhost:3000'
        )
        if not frontend_url.endswith('/'):
            frontend_url += '/'

        success_url = f"{frontend_url}subscription/success?session_id={{CHECKOUT_SESSION_ID}}"
        if user_id:
            success_url += f"&user_id={user_id}"

        cancel_url = f"{frontend_url}subscription/cancelled"

        metadata = {
            "user_id": user_id or "new_registration",
            "is_new_user": "true" if registration_data else "false",
            "is_oauth_flow": "true" if is_oauth_flow else "false",
        }

        if validated_referral_code:
            metadata["referral_code"] = validated_referral_code

        checkout_session = stripe.checkout.Session.create(
            payment_method_types = ["card"],
            line_items = [
                {
                    "price": price_id,
                    "quantity": 1,
                },
            ],
            mode = "subscription",
            success_url = success_url,
            cancel_url = cancel_url,
            client_reference_id = user_id or "new_registration",
            metadata = metadata,
        )

        if registration_data:
            session["temp_registration_data"] = registration_data
            TempRegistrationService.create_for_checkout(
                checkout_session.id,
                registration_data,
                is_oauth_flow
            )

        if is_oauth_flow:
            session["is_oauth_flow"] = True

        session["checkout_session_id"] = checkout_session.id

        return {
            "sessionId": checkout_session.id,
            "url": checkout_session.url
        }

    except stripe.error.StripeError as e:
        current_app.logger.error(
            f"Stripe API error creating checkout session: {str(e)}"

```

---

## Today I Learned

TIL: In `create_checkout_session`, the code uses f-strings to dynamically construct URLs for success and cancel callbacks, ensuring flexibility based on user input. This approach keeps URL logic clean and avoids hardcoding paths.

```python
success_url = f"{frontend_url}subscription/success?session_id={{CHECKOUT_SESSION_ID}}"
```

This pattern makes the function more adaptable to different frontend configurations.

---

*Generated by CodeWorm on 2026-02-20 10:48*
