# AuthService.refresh_tokens

**Type:** Today I Learned
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/auth/services/auth.py
**Language:** python
**Lines:** 113-173
**Complexity:** 6.0

---

## Source Code

```python
async def refresh_tokens(
        session: AsyncSession,
        refresh_token: str,
        device_id: str | None = None,
        device_name: str | None = None,
        ip_address: str | None = None,
    ) -> tuple[TokenResponse, str]:
        """
        Refresh access token using refresh token

        Implements token rotation with replay attack detection

        Returns:
            Tuple of (TokenResponse, new_raw_refresh_token)
        """
        token_hash = hash_token(refresh_token)
        stored_token = await RefreshTokenRepository.get_by_hash(
            session,
            token_hash
        )

        if stored_token is None:
            raise TokenError(message = "Invalid refresh token")

        if stored_token.is_revoked:
            await RefreshTokenRepository.revoke_family(
                session,
                stored_token.family_id
            )
            raise TokenRevokedError()

        if stored_token.is_expired:
            raise TokenError(message = "Refresh token expired")

        user = await UserRepository.get_by_id(
            session,
            stored_token.user_id
        )
        if user is None or not user.is_active:
            raise TokenError(message = "User not found or inactive")

        await RefreshTokenRepository.revoke_token(session, stored_token)

        access_token = create_access_token(user.id, user.token_version)

        raw_refresh, new_hash, expires_at = create_refresh_token(
            user.id, stored_token.family_id
        )

        await RefreshTokenRepository.create_token(
            session,
            user_id = user.id,
            token_hash = new_hash,
            family_id = stored_token.family_id,
            expires_at = expires_at,
            device_id = device_id,
            device_name = device_name,
            ip_address = ip_address,
        )

        return TokenResponse(access_token = access_token), raw_refresh
```

---

## Today I Learned

TIL: In `refresh_tokens`, the function handles token refreshes with careful validation and updates. It uses asynchronous context management effectively, ensuring that each database operation is properly awaited and managed. This prevents potential race conditions and ensures data consistency.

```python
await RefreshTokenRepository.create_token(
    session,
    user_id = user.id,
    # ...
)
```

This pattern of using `async` functions with proper error handling and state updates makes the code robust and maintainable.

---

*Generated by CodeWorm on 2026-02-20 20:45*
