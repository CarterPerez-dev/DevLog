# NewTelemetry

**Type:** Today I Learned
**Repository:** fullstack-template
**File:** stacks/go-react/go-backend/internal/core/telemetry.go
**Language:** go
**Lines:** 30-101
**Complexity:** 8.0

---

## Source Code

```go
func NewTelemetry(
	ctx context.Context,
	otelCfg config.OtelConfig,
	appCfg config.AppConfig,
) (*Telemetry, error) {
	if !otelCfg.Enabled || otelCfg.Endpoint == "" {
		noopProvider := sdktrace.NewTracerProvider()
		return &Telemetry{
			TracerProvider: noopProvider,
			Tracer:         noopProvider.Tracer(otelCfg.ServiceName),
		}, nil
	}

	opts := []otlptracegrpc.Option{
		otlptracegrpc.WithEndpoint(otelCfg.Endpoint),
		otlptracegrpc.WithTimeout(5 * time.Second),
	}

	if otelCfg.Insecure {
		opts = append(
			opts,
			otlptracegrpc.WithTLSCredentials(insecure.NewCredentials()),
		)
	} else {
		opts = append(opts, otlptracegrpc.WithTLSCredentials(credentials.NewClientTLSFromCert(nil, "")))
	}

	exporter, err := otlptracegrpc.New(ctx, opts...)
	if err != nil {
		return nil, fmt.Errorf("create otlp exporter: %w", err)
	}

	res, err := resource.New(ctx,
		resource.WithAttributes(
			semconv.ServiceName(otelCfg.ServiceName),
			semconv.ServiceVersion(appCfg.Version),
			attribute.String("environment", appCfg.Environment),
		),
		resource.WithHost(),
		resource.WithProcess(),
	)
	if err != nil {
		return nil, fmt.Errorf("create resource: %w", err)
	}

	sampleRate := otelCfg.SampleRate
	if sampleRate <= 0 || sampleRate > 1 {
		sampleRate = 0.1
	}

	tp := sdktrace.NewTracerProvider(
		sdktrace.WithBatcher(exporter,
			sdktrace.WithBatchTimeout(5*time.Second),
			sdktrace.WithMaxExportBatchSize(512),
		),
		sdktrace.WithResource(res),
		sdktrace.WithSampler(sdktrace.ParentBased(
			sdktrace.TraceIDRatioBased(sampleRate),
		)),
	)

	otel.SetTracerProvider(tp)
	otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(
		propagation.TraceContext{},
		propagation.Baggage{},
	))

	return &Telemetry{
		TracerProvider: tp,
		Tracer:         tp.Tracer(otelCfg.ServiceName),
	}, nil
}
```

---

## Today I Learned

TIL: The `NewTelemetry` function demonstrates a clever error handling approach by using early returns and context cancellation to manage different telemetry setups efficiently. This makes the code clean and easy to follow, ensuring that only necessary configurations are applied based on the provided configuration.

```go
if !otelCfg.Enabled || otelCfg.Endpoint == "" {
    // Return noop tracer provider if telemetry is disabled or no endpoint.
}
```

This pattern reduces complexity by avoiding nested conditionals and making error handling straightforward.

---

*Generated by CodeWorm on 2026-02-20 14:37*
