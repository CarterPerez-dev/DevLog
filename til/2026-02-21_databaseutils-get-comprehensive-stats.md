# DatabaseUtils.get_comprehensive_stats

**Type:** Today I Learned
**Repository:** kill-pr0cess.inc
**File:** backend/src/database/mod.rs
**Language:** rust
**Lines:** 105-194
**Complexity:** 9.0

---

## Source Code

```rust
pub async fn get_comprehensive_stats(pool: &DatabasePool) -> Result<serde_json::Value> {
        // Table sizes
        let table_sizes = sqlx::query(
            "SELECT
                schemaname,
                tablename,
                pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
                pg_total_relation_size(schemaname||'.'||tablename) as size_bytes
            FROM pg_tables
            WHERE schemaname = 'public'
            ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC"
        )
        .fetch_all(pool)
        .await?;

        // Connection stats
        let connection_stats = sqlx::query(
            "SELECT
                count(*) as total_connections,
                count(*) FILTER (WHERE state = 'active') as active_connections,
                count(*) FILTER (WHERE state = 'idle') as idle_connections
            FROM pg_stat_activity"
        )
        .fetch_one(pool)
        .await?;

        // Database stats
        let db_stats = sqlx::query(
            "SELECT
                numbackends,
                xact_commit,
                xact_rollback,
                blks_read,
                blks_hit,
                tup_returned,
                tup_fetched,
                tup_inserted,
                tup_updated,
                tup_deleted
            FROM pg_stat_database
            WHERE datname = current_database()"
        )
        .fetch_one(pool)
        .await?;

        // Pre-compute block read/hit statistics for hit ratio
        let blks_read: i64 = db_stats.try_get("blks_read")?;
        let blks_hit: i64 = db_stats.try_get("blks_hit")?;
        let hit_ratio = if blks_read + blks_hit > 0 {
            blks_hit as f64 / (blks_read + blks_hit) as f64 * 100.0
        } else {
            0.0
        };

        let stats = serde_json::json!({
            "table_sizes": table_sizes.iter().map(|row| {
                serde_json::json!({
                    "table": row.get::<String, _>("tablename"),
                    "size": row.get::<String, _>("size"),
                    "size_bytes": row.get::<i64, _>("size_bytes")
                })
            }).collect::<Vec<_>>(),
            "connections": {
                "total": connection_stats.get::<i64, _>("total_connections"),
                "active": connection_stats.get::<i64, _>("active_connections"),
                "idle": connection_stats.get::<i64, _>("idle_connections")
            },
            "database": {
                "backends": db_stats.try_get::<i32, _>("numbackends")?,
                "transactions": {
                    "committed": db_stats.try_get::<i64, _>("xact_commit")?,
                    "rolled_back": db_stats.get::<i64, _>("xact_rollback")
                },
                    "blocks": {
                        "read": blks_read,
                        "hit": blks_hit,
                        "hit_ratio": hit_ratio
                    },
                "tuples
```

---

## Today I Learned

TIL: In `get_comprehensive_stats`, the code uses `try_get` to safely extract values from `db_stats`. This clever approach ensures type safety and handles potential errors gracefully, making the stats retrieval robust and easy to read.

```rust
let blks_read: i64 = db_stats.try_get("blks_read")?;
```

This pattern prevents panics by returning a `Result`, enhancing reliability.

---

*Generated by CodeWorm on 2026-02-21 11:36*
