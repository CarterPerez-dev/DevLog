# createAuthResponse

**Type:** Today I Learned
**Repository:** fullstack-template
**File:** stacks/go-react/go-backend/internal/auth/service.go
**Language:** go
**Lines:** 352-411
**Complexity:** 5.0

---

## Source Code

```go
func (s *Service) createAuthResponse(
	ctx context.Context,
	user *UserInfo,
	userAgent, ipAddress, familyID string,
	oldTokenID *string,
) (*AuthResponse, error) {
	accessToken, err := s.jwt.CreateAccessToken(AccessTokenClaims{
		UserID:       user.ID,
		Role:         user.Role,
		Tier:         user.Tier,
		TokenVersion: user.TokenVersion,
	})
	if err != nil {
		return nil, fmt.Errorf("create access token: %w", err)
	}

	refreshData, err := s.jwt.CreateRefreshToken(user.ID, familyID)
	if err != nil {
		return nil, fmt.Errorf("create refresh token: %w", err)
	}

	newTokenID := uuid.New().String()

	refreshTokenEntity := &RefreshToken{
		ID:        newTokenID,
		UserID:    user.ID,
		TokenHash: refreshData.Hash,
		FamilyID:  refreshData.FamilyID,
		ExpiresAt: refreshData.ExpiresAt,
		UserAgent: userAgent,
		IPAddress: ipAddress,
	}

	if err := s.repo.Create(ctx, refreshTokenEntity); err != nil {
		return nil, fmt.Errorf("store refresh token: %w", err)
	}

	if oldTokenID != nil {
		//nolint:errcheck // best-effort token chain tracking
		_ = s.repo.MarkAsUsed(ctx, *oldTokenID, newTokenID)
	}

	return &AuthResponse{
		User: UserResponse{
			ID:        user.ID,
			Email:     user.Email,
			Name:      user.Name,
			Role:      user.Role,
			Tier:      user.Tier,
			CreatedAt: time.Now(),
		},
		Tokens: TokenResponse{
			AccessToken:  accessToken,
			RefreshToken: refreshData.Token,
			TokenType:    "Bearer",
			ExpiresIn:    int(15 * time.Minute / time.Second),
			ExpiresAt:    time.Now().Add(15 * time.Minute),
		},
	}, nil
}
```

---

## Today I Learned

TIL: In `createAuthResponse`, the function handles errors using `fmt.Errorf` with error wrapping, ensuring stack traces are preserved while providing user-friendly error messages. This is a Go idiom for robust and maintainable error handling.

```go
if err != nil {
	return nil, fmt.Errorf("create access token: %w", err)
}
```

This pattern helps in debugging by retaining the original error context.

---

*Generated by CodeWorm on 2026-02-20 15:33*
