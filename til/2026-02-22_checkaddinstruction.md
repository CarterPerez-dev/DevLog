# checkAddInstruction

**Type:** Today I Learned
**Repository:** docksec
**File:** internal/analyzer/dockerfile.go
**Language:** go
**Lines:** 159-205
**Complexity:** 11.0

---

## Source Code

```go
func (a *DockerfileAnalyzer) checkAddInstruction(
	target finding.Target,
	ast *parser.Node,
) finding.Collection {
	var findings finding.Collection

	for _, node := range ast.Children {
		if strings.ToUpper(node.Value) == "ADD" {
			src := ""
			if node.Next != nil {
				src = node.Next.Value
			}

			isURL := strings.HasPrefix(src, "http://") ||
				strings.HasPrefix(src, "https://")
			isArchive := strings.HasSuffix(src, ".tar") ||
				strings.HasSuffix(src, ".tar.gz") ||
				strings.HasSuffix(src, ".tgz") ||
				strings.HasSuffix(src, ".tar.bz2")

			if !isURL && !isArchive {
				control, _ := benchmark.Get("4.9")
				loc := &finding.Location{Path: a.path, Line: node.StartLine}
				f := finding.New("CIS-4.9", control.Title, finding.SeverityLow, target).
					WithDescription(control.Description).
					WithCategory(string(CategoryDockerfile)).
					WithLocation(loc).
					WithRemediation(control.Remediation).
					WithReferences(control.References...).
					WithCISControl(control.ToCISControl())
				findings = append(findings, f)
			}

			if isURL {
				loc := &finding.Location{Path: a.path, Line: node.StartLine}
				f := finding.New("DS-ADD-URL", "ADD instruction fetches from URL", finding.SeverityMedium, target).
					WithDescription("ADD with URLs can introduce security risks. Use curl/wget with verification instead.").
					WithCategory(string(CategoryDockerfile)).
					WithLocation(loc).
					WithRemediation("Use RUN with curl or wget and verify checksums of downloaded files.")
				findings = append(findings, f)
			}
		}
	}

	return findings
}
```

---

## Today I Learned

TIL: In `checkAddInstruction`, the function uses simple string checks to identify potential security risks associated with Dockerfile `ADD` instructions. By detecting non-URL and non-archive sources, it flags low-severity findings. For URL-based ADDs, it raises medium-severity issues, highlighting the risk of insecure downloads and suggesting safer alternatives like `RUN curl/wget`. Clever use of string manipulation for dynamic security analysis! üõ°Ô∏èüîó

---

*Generated by CodeWorm on 2026-02-22 11:14*
