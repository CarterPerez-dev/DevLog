# validate_oauth_state_match

**Type:** Today I Learned
**Repository:** CertGames-Core
**File:** backend/api/domains/account/middleware/rules.py
**Language:** python
**Lines:** 103-187
**Complexity:** 27.0

---

## Source Code

```python
def validate_oauth_state_match(provider = None):
    """
    Validate OAuth state parameter for CSRF protection.
    """
    request_state = g.validated.get('state')

    if not request_state:
        raise ValidationError("State parameter is required")

    if provider == 'apple' or g.get('oauth_provider') == 'apple':
        valid_states = session.get('apple_valid_states', [])

        if not valid_states:
            raise AuthenticationError("No valid Apple states in session")

        current_time = datetime.now(UTC).timestamp()
        state_found = False

        if isinstance(valid_states[0], tuple | list):
            for state, timestamp in valid_states:
                if state == request_state:
                    if current_time - timestamp > 600:
                        raise AuthenticationError(
                            "Apple OAuth state expired (10 min limit)"
                        )
                    state_found = True
                    break

            if not state_found:
                raise AuthenticationError("Invalid Apple OAuth state")

            valid_states = [
                (s,
                 t) for s, t in valid_states if s != request_state
            ]
        else:
            if request_state not in valid_states:
                raise AuthenticationError("Invalid Apple OAuth state")
            valid_states.remove(request_state)

        session['apple_valid_states'] = valid_states
    elif provider == 'google' or request.endpoint and 'google' in request.endpoint:
        valid_states = session.get('google_valid_states', [])

        if not valid_states:
            raise AuthenticationError("No valid Google states in session")

        current_time = datetime.now(UTC).timestamp()
        state_found = False

        if isinstance(valid_states[0], tuple | list):
            for state, timestamp in valid_states:
                if state == request_state:
                    if current_time - timestamp > 600:
                        raise AuthenticationError(
                            "Google OAuth state expired (10 min limit)"
                        )
                    state_found = True
                    break

            if not state_found:
                raise AuthenticationError("Invalid Google OAuth state")

            valid_states = [
                (s,
                 t) for s, t in valid_states if s != request_state
            ]
        else:
            if request_state not in valid_states:
                raise AuthenticationError("Invalid Google OAuth state")
            valid_states.remove(request_state)

        session['google_valid_states'] = valid_states
    else:
        session_state = session.get('oauth_state')

        if not session_state:
            raise AuthenticationError("No OAuth state in session")

        if request_state != session_state:
            raise AuthenticationError(
                "Invalid OAuth state - CSRF protection"
            )

        
```

---

## Today I Learned

TIL: This function uses dynamic validation logic based on `provider` to handle different OAuth states, showcasing flexibility and DRY principles. It checks if the state parameter is valid within a 10-minute window and updates session data accordingly, ensuring CSRF protection across multiple providers.

```python
# Example of dynamic validation logic
if provider == 'apple':
    # Validate Apple-specific states
else:
    # Validate Google-specific states
```

This approach reduces redundancy by centralizing common validation steps while handling provider-specific nuances.

---

*Generated by CodeWorm on 2026-02-19 20:08*
