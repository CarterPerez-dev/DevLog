# BulkUploadService.create_bulk_upload

**Type:** Today I Learned
**Repository:** vuemantics
**File:** backend/services/bulk_upload_service.py
**Language:** python
**Lines:** 97-237
**Complexity:** 13.0

---

## Source Code

```python
async def create_bulk_upload(
        user_id: UUID,
        files: list[UploadFile],
    ) -> BulkUploadResult:
        """
        Create and queue a bulk upload batch

        Args:
            user_id: User's UUID
            files: List of files to upload

        Returns:
            BulkUploadResult with batch info

        Process:
        1. Validate bulk upload request
        2. Create batch record
        3. Save each file to storage
        4. Create upload records linked to batch
        5. Queue batch for background processing
        6. Return batch ID and results
        """
        # Validate bulk upload
        BulkUploadService._validate_bulk_upload(files)

        total_size = sum(file.size or 0 for file in files)
        logger.info(
            f"Creating bulk upload for user {user_id}: "
            f"{len(files)} files, {total_size / (1024 * 1024):.2f} MB total"
        )

        batch = await UploadBatch.create(
            user_id = user_id,
            total_uploads = len(files),
        )

        logger.info(f"Created batch {batch.id} with {len(files)} uploads")

        upload_ids = []
        failed_files = []

        for file in files:
            try:
                if not file.filename:
                    failed_files.append(
                        {
                            "filename": "unknown",
                            "error": "No filename provided",
                        }
                    )
                    continue

                upload_id = uuid4()

                file_content = await file.read()
                file_size = len(file_content)

                await file.seek(0)

                file_type, extension = await storage_service.validate_file(
                    filename = file.filename,
                    mime_type = file.content_type or "application/octet-stream",
                    file_size = file_size,
                )

                file_path = await storage_service.save_upload(
                    file_content = file.file,
                    user_id = user_id,
                    upload_id = upload_id,
                    extension = extension,
                )

                upload = await Upload.create(
                    user_id = user_id,
                    batch_id = batch.id,
                    filename = file.filename,
                    file_path = file_path,
                    file_type = file_type,
                    file_size = file_size,
                    mime_type = file.content_type or "application/octet-stream",
                    metadata = {
                        "original_filename": file.filename,
                        "upload_source": "bulk",
                        "batch_id": str(batch.id),
                    },
                    upload_id = upload_id,
                )

                upload_ids.append(str(upload.id))
                logger.debug(
                    f"Created upload {upload.id} in batch {batch.id}"
  
```

---

## Today I Learned

TIL: In `create_bulk_upload`, the function handles file uploads asynchronously using try-except blocks to catch and log errors, ensuring each file is processed individually while maintaining overall batch integrity. This pattern keeps the code clean and error-handling robust.

```markdown
Today I learned about the robust error handling in `create_bulk_upload`. By processing files in a loop with try-except blocks, this function ensures that any issues are logged and handled gracefully, allowing the bulk upload to continue even if some files fail.
```

---

*Generated by CodeWorm on 2026-02-22 00:34*
