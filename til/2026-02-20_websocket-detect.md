# websocket_detect

**Type:** Today I Learned
**Repository:** angelamos-operations
**File:** Angela-Wake/server/routes.py
**Language:** python
**Lines:** 66-129
**Complexity:** 17.0

---

## Source Code

```python
async def websocket_detect(websocket: WebSocket):
    await websocket.accept()

    model_paths = list(MODELS_DIR.glob("*.tflite")) + list(MODELS_DIR.glob("*.onnx"))
    if model_paths:
        m = Model(
            wakeword_models=[str(p) for p in model_paths],
            vad_threshold=VAD_THRESHOLD if ENABLE_VAD else None,
        )
    else:
        m = Model(vad_threshold=VAD_THRESHOLD if ENABLE_VAD else None)

    model_names = list(m.models.keys())
    frame_count = 0

    try:
        while True:
            msg = await websocket.receive()

            if msg.get('type') == 'websocket.disconnect':
                break

            if 'text' in msg:
                if msg['text'] == 'reset':
                    m.reset()
                    print("[DEBUG] Model reset")
                continue

            if 'bytes' not in msg:
                continue

            data = msg['bytes']
            audio = np.frombuffer(data, dtype=np.int16)
            frame_count += 1

            orig_len = len(audio)
            orig_amp = np.max(np.abs(audio))

            if len(audio) != TARGET_SAMPLES:
                ratio = len(audio) // TARGET_SAMPLES
                if ratio > 1:
                    audio = audio[::ratio][:TARGET_SAMPLES]
                else:
                    audio = signal.resample_poly(audio, TARGET_SAMPLES, len(audio)).astype(np.int16)

            predictions = m.predict(audio)

            for name in model_names:
                score = predictions.get(name, 0.0)
                if frame_count % 50 == 0:
                    print(f"[DEBUG] Frame {frame_count}: orig_len={orig_len}, orig_amp={orig_amp}, {name}={score:.4f}")
                if score >= DETECTION_THRESHOLD:
                    await websocket.send_json(
                        {
                            "detected": True,
                            "model": name,
                            "score": float(score),
                        }
                    )

    except WebSocketDisconnect:
        pass
    except Exception as e:
        await websocket.close(code = 1011, reason = str(e))
```

---

## Today I Learned

TIL: In the `websocket_detect` function, the use of `try-except` blocks is clever for handling asynchronous WebSocket communication. It gracefully handles `WebSocketDisconnect` and other exceptions, ensuring the websocket connection is closed properly with a custom reason. This prevents potential issues and maintains clean state management. ðŸŒŸ

---

*Generated by CodeWorm on 2026-02-20 17:03*
