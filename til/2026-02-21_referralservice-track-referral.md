# ReferralService.track_referral

**Type:** Today I Learned
**Repository:** stripe-referral
**File:** src/stripe_referral/services/referral_service.py
**Language:** python
**Lines:** 130-186
**Complexity:** 4.0

---

## Source Code

```python
def track_referral(
        db: Session,
        code: str,
        referred_user_id: str,
        transaction_id: str | None = None,
        transaction_amount: float | None = None,
    ) -> TrackReferralResult:
        """
        Track a successful referral conversion
        """
        code_repo = ReferralCodeRepository(db)
        tracking_repo = ReferralTrackingRepository(db)
        program_repo = ReferralProgramRepository(db)

        ReferralService.validate_code(db, code)

        code_obj = code_repo.get_by_code(code)
        if not code_obj:
            raise CodeNotFoundError(
                f"Code '{code}' not found",
                code = code
            )

        if code_obj.user_id == referred_user_id:
            raise SelfReferralError(
                "Cannot use your own referral code",
                user_id = referred_user_id,
            )

        program = program_repo.get_by_id(code_obj.program_id)
        if not program:
            raise ProgramNotFoundError(
                f"Program ID {code_obj.program_id} not found",
                program_id = code_obj.program_id,
            )

        tracking = tracking_repo.create(
            referrer_user_id = code_obj.user_id,
            referred_user_id = referred_user_id,
            code_id = code_obj.id,
            program_id = program.id,
            transaction_id = transaction_id,
            transaction_amount = transaction_amount,
            amount_earned = program.reward_amount,
            currency = program.reward_currency,
        )

        code_repo.increment_uses(code_obj.id)

        return TrackReferralResult(
            tracking_id = tracking.id,
            referrer_user_id = tracking.referrer_user_id,
            referred_user_id = tracking.referred_user_id,
            amount_earned = tracking.amount_earned,
            currency = tracking.currency,
            converted_at = tracking.converted_at.isoformat(),
        )
```

---

## Today I Learned

TIL: This function uses Python's type hints and default parameters effectively. The `transaction_id` and `transaction_amount` parameters are optional, allowing flexible call signatures. This makes the function more versatile without cluttering its core logic, keeping it clean and easy to use. ðŸš€ðŸ”—

---

*Generated by CodeWorm on 2026-02-21 22:34*
