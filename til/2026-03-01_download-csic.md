# download_csic

**Type:** Today I Learned
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/ml/download_csic.py
**Language:** python
**Lines:** 41-103
**Complexity:** 8.0

---

## Source Code

```python
def download_csic(output_dir: Path = DATASET_DIR, ) -> None:
    """
    Download CSIC 2010 dataset files
    """
    output_dir.mkdir(parents=True, exist_ok=True)

    for filename in FILES:
        dest = output_dir / filename

        if dest.exists() and dest.stat().st_size > MIN_FILE_BYTES:
            logger.info("Skipping %s (already exists)", filename)
            continue

        url = f"{BASE_URL}/{filename}"
        logger.info("Downloading %s", url)
        print(f"Downloading {filename}...")

        try:
            with httpx.stream(
                "GET",
                url,
                follow_redirects=True,
            ) as response:
                response.raise_for_status()
                total = int(
                    response.headers.get("content-length", 0)
                )
                downloaded = 0
                with open(dest, "wb") as f:
                    for chunk in response.iter_bytes(
                        chunk_size=65536
                    ):
                        f.write(chunk)
                        downloaded += len(chunk)
                        if total > 0:
                            pct = min(
                                downloaded * 100 / total, 100
                            )
                            sys.stdout.write(f"\r  {pct:.0f}%")
                        else:
                            mb = downloaded / 1_048_576
                            sys.stdout.write(f"\r  {mb:.1f} MB")
                        sys.stdout.flush()
            print()
        except Exception as exc:
            logger.error(
                "Failed to download %s: %s",
                filename,
                exc,
            )
            print(f"\nError downloading {filename}: {exc}")
            continue

        size = dest.stat().st_size
        sha = _compute_sha256(dest)
        print(f"  Saved: {dest}"
              f" ({size:,} bytes, sha256={sha[:12]})")

        if size < MIN_FILE_BYTES:
            print(f"  WARNING: {filename} is suspiciously"
                  f" small ({size:,} bytes)")

    print(f"\nDataset directory: {output_dir.resolve()}")
```

---

## Today I Learned

TIL: This Python function uses `httpx.stream` to download files with progress tracking. The `iter_bytes` method writes chunks to disk, updating the console with percentage completion or file size in MB, making the download process both efficient and informative.

```python
with httpx.stream("GET", url) as response:
    ...
    for chunk in response.iter_bytes(chunk_size=65536):
        f.write(chunk)
        downloaded += len(chunk)
        if total > 0:
            pct = min(downloaded * 100 / total, 100)
            sys.stdout.write(f"\r  {pct:.0f}%")
```

This pattern balances performance and user feedback elegantly.

---

*Generated by CodeWorm on 2026-03-01 01:24*
