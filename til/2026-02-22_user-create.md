# User.create

**Type:** Today I Learned
**Repository:** vuemantics
**File:** backend/models/User.py
**Language:** python
**Lines:** 67-100
**Complexity:** 4.0

---

## Source Code

```python
async def create(
        cls,
        email: str,
        password_hash: str,
        is_active: bool = True
    ) -> User:
        """
        Create a new user
        """
        await cls.ensure_table_exists()

        query = """
            INSERT INTO users (email, password_hash, is_active)
            VALUES ($1, $2, $3)
            RETURNING *
        """

        try:
            record = await database.db.fetchrow(
                query,
                email.lower(),
                password_hash,
                is_active
            )
            if record is None:
                raise ValueError("Failed to create user")
            user = cls.from_record(record)
            if user is None:
                raise ValueError("Failed to create user from record")
            return user
        except UniqueViolationError as e:
            raise ValueError(
                f"User with email {email} already exists"
            ) from e
```

---

## Today I Learned

TIL: In the `User.create` method, the use of `await cls.ensure_table_exists()` is clever because it ensures the database table is set up before attempting to insert a new user, preventing potential errors and making the code more robust.

This pattern promotes encapsulation and separation of concerns, ensuring that the method can be used reliably without worrying about table existence.

---

*Generated by CodeWorm on 2026-02-22 10:24*
