# RepoScanner.scan_repo

**Type:** Today I Learned
**Repository:** CodeWorm
**File:** codeworm/analysis/scanner.py
**Language:** python
**Lines:** 148-212
**Complexity:** 16.0

---

## Source Code

```python
def scan_repo(self, repo_path: Path, repo_name: str) -> Iterator[ScannedFile]:
        """
        Scan a repository and yield discovered files
        """
        if not repo_path.exists():
            return

        gitignore_filter = GitignoreFilter(repo_path)
        include_spec = pathspec.PathSpec.from_lines(
            "gitwildmatch",
            self.include_patterns
        )

        for root, dirs, files in os.walk(repo_path):
            root_path = Path(root)

            dirs[:] = [
                d for d in dirs if not d.startswith(".")
                and not gitignore_filter.is_ignored(root_path / d)
            ]

            for filename in files:
                file_path = root_path / filename

                try:
                    rel_path = file_path.relative_to(repo_path)
                except ValueError:
                    continue

                if not include_spec.match_file(str(rel_path)):
                    continue

                if self._exclude_spec.match_file(str(rel_path)):
                    continue

                if gitignore_filter.is_ignored(file_path):
                    continue

                ext = file_path.suffix.lower()
                language = LANGUAGE_EXTENSIONS.get(ext)
                if not language:
                    continue

                try:
                    stat = file_path.stat()
                    if stat.st_size > self.MAX_FILE_SIZE:
                        continue
                    if stat.st_size == 0:
                        continue

                    is_binary = self._is_binary(file_path)
                    if is_binary:
                        continue

                    yield ScannedFile(
                        path = file_path,
                        language = language,
                        repo_name = repo_name,
                        relative_path = rel_path,
                        size_bytes = stat.st_size,
                        is_binary = False,
                    )

                except (OSError, PermissionError):
                    continue
```

---

## Today I Learned

TIL: The `os.walk` loop in `RepoScanner.scan_repo` uses list comprehensions to filter out unnecessary directories and files efficiently, reducing the number of files processed. This makes the function more performant by skipping over ignored and excluded paths early.

```python
dirs[:] = [d for d in dirs if not d.startswith(".") and not gitignore_filter.is_ignored(root_path / d)]
```

This pattern ensures only relevant files are considered, improving overall efficiency.

---

*Generated by CodeWorm on 2026-02-22 11:46*
