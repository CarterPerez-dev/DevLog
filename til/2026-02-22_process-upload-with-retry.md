# process_upload_with_retry

**Type:** Today I Learned
**Repository:** vuemantics
**File:** backend/workers/batch_helpers/_process_upload_with_retry.py
**Language:** python
**Lines:** 23-169
**Complexity:** 12.0

---

## Source Code

```python
async def process_upload_with_retry(
    ai_service: LocalAIService,
    upload: Upload,
    batch: UploadBatch,
) -> bool:
    """
    Process a single upload with retry logic

    Args:
        ai_service: AI service instance
        upload: Upload to process
        batch: UploadBatch instance for progress updates

    Returns:
        True if successful, False if failed after retry

    Design:
    - Try once, retry once on failure (max 2 attempts)
    - Failures don't stop batch processing
    - Upload marked as failed after 2 attempts
    - Publishes real-time progress by monitoring AI service stages
    """
    max_attempts = 2

    for attempt in range(1, max_attempts + 1):
        try:
            logger.info(
                f"Processing upload {upload.id} (attempt {attempt}/{max_attempts})"
            )

            # Generate thumbnail (only on first attempt)
            if attempt == 1 and not upload.thumbnail_path:
                try:
                    logger.info(f"Generating thumbnail for upload {upload.id}")
                    await publish_file_progress(batch, upload, status="processing", progress=5)
                    thumbnail_path = await storage_service.generate_thumbnail(
                        user_id = upload.user_id,
                        upload_id = upload.id,
                        file_type = upload.file_type,
                        extension = upload.file_path.split('.')[-1],
                    )
                    if thumbnail_path:
                        await upload.update_thumbnail(thumbnail_path)
                        logger.info(f"Thumbnail generated for upload {upload.id}")
                    await publish_file_progress(batch, upload, status="processing", progress=10)
                except Exception as thumb_error:
                    logger.warning(
                        f"Thumbnail generation failed for {upload.id}: {thumb_error}"
                    )
                    # Continue processing even if thumbnail fails

            # Monitor AI progress with real stages
            async def monitor_ai_progress() -> None:
                """Poll upload status and publish real progress from AI service"""
                last_progress = 10
                start_time = asyncio.get_event_loop().time()

                while True:
                    await asyncio.sleep(0.3)  # Poll every 300ms

                    try:
                        await upload.refresh()
                    except ValueError:
                        # Upload was deleted mid-processing (user action)
                        logger.warning(f"Upload {upload.id} was deleted during processing, stopping monitor")
                        break
                    except Exception as e:
                        logger.warning(f"Failed to refresh upload {upload.id}: {e}")
                        await asyncio.sleep(1.0)  # Back off and retry
                        continue

                    elapsed = asyncio.get_event_loop(
```

---

## Today I Learned

TIL: In `process_upload_with_retry`, the use of an asynchronous function within a loop (`async def monitor_ai_progress()`) to monitor AI progress and update real-time status is clever. This allows for dynamic, responsive processing while handling retries gracefully. ðŸ”„ðŸ”„ðŸ“ˆ

---

*Generated by CodeWorm on 2026-02-22 08:28*
