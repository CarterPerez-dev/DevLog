# Upload.update_analysis

**Type:** Today I Learned
**Repository:** vuemantics
**File:** backend/models/Upload.py
**Language:** python
**Lines:** 547-621
**Complexity:** 8.0

---

## Source Code

```python
async def update_analysis(
        self,
        description: str,
        embedding: list[float],
        use_local: bool = True,
        description_audit_score: int | None = None,
    ) -> None:
        """
        Update with AI analysis results

        Args:
            description: Text description from vision model
            embedding: Vector embedding (1024-dim bge-m3)
            use_local: If True, save to embedding_local (default)
            description_audit_score: Audit score 0-100 (higher is better)
        """
        if self.id is None:
            raise ValueError("Cannot update analysis for unsaved upload")

        # Handle both nested and flat embedding formats
        if isinstance(embedding, list) and len(embedding) > 0:
            first_elem = embedding[0]
            if isinstance(first_elem, list):  # type: ignore[unreachable]
                # Nested format: [[1.0, 2.0, ...]]
                embedding_list = first_elem  # type: ignore[unreachable]
            elif isinstance(first_elem, int | float):
                # Flat format: [1.0, 2.0, ...]
                embedding_list = embedding
            else:
                raise ValueError(
                    f"Invalid embedding format: {type(embedding)}"
                )
        else:
            raise ValueError(
                f"Invalid embedding format: {type(embedding)}"
            )

        if use_local:
            query = """
                UPDATE uploads
                SET description = $1,
                    embedding_local = $2,
                    processing_status = $3,
                    description_audit_score = $4,
                    updated_at = NOW()
                WHERE id = $5
                RETURNING updated_at
            """
        else:
            query = """
                UPDATE uploads
                SET description = $1,
                    embedding = $2,
                    processing_status = $3,
                    description_audit_score = $4,
                    updated_at = NOW()
                WHERE id = $5
                RETURNING updated_at
            """

        updated_at = await database.db.fetchval(
            query,
            description,
            embedding_list,
            ProcessingStatus.COMPLETED,
            description_audit_score,
            self.id
        )

        if updated_at:
            self.description = description
            self.embedding_local = embedding_list
            self.processing_status = ProcessingStatus.COMPLETED
            self.description_audit_score = description_audit_score
            self.updated_at = updated_at
```

---

## Today I Learned

TIL: I learned how to handle nested and flat embedding formats elegantly using Python's `isinstance` check. This makes the function flexible, accommodating both `[1.0, 2.0, ...]` (flat) and `[[1.0, 2.0, ...]]` (nested) formats without complex logic.

```python
if isinstance(embedding[0], list): 
    embedding_list = embedding[0]
elif isinstance(embedding[0], int | float):
    embedding_list = embedding
```

This concise approach keeps the code readable and maintainable!

---

*Generated by CodeWorm on 2026-02-22 09:41*
