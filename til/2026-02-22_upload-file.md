# upload_file

**Type:** Today I Learned
**Repository:** vuemantics
**File:** backend/routers/v1/upload.py
**Language:** python
**Lines:** 133-205
**Complexity:** 7.0

---

## Source Code

```python
async def upload_file(
    request: Request,
    file: Annotated[UploadFile,
                    File(description = "File to upload")],
    current_user: Annotated[User,
                            Depends(get_current_user)],
) -> UploadResponse:
    """
    Upload a new file

    File is saved immediately and processing happens in background
    Returns upload details with 'pending' status
    """
    # Generate upload ID early
    upload_id = uuid4()

    try:
        file_content = await file.read()
        file_size = len(file_content)

        # Reset file position for saving
        await file.seek(0)

        file_type, extension = await storage_service.validate_file(
            filename=file.filename or "unknown",
            mime_type=file.content_type or "application/octet-stream",
            file_size=file_size,
        )

        file_path = await storage_service.save_upload(
            file_content = file.file,
            user_id = current_user.id,
            upload_id = upload_id,
            extension = extension,
        )

        upload = await Upload.create(
            user_id = current_user.id,
            filename = file.filename or f"upload.{extension}",
            file_path = file_path,
            file_type = file_type,
            file_size = file_size,
            mime_type = file.content_type or "application/octet-stream",
            metadata = {
                "original_filename": file.filename,
                "upload_source": "web",
            },
            upload_id = upload_id,
        )

        # Queue background processing (fire and forget)
        task = asyncio.create_task(
            process_upload_background(
                upload_id = upload_id,
                user_id = current_user.id,
                file_type = file_type,
                extension = extension,
            )
        )
        # Store reference to prevent task from being garbage collected
        task.add_done_callback(lambda t: t.exception())

        logger.info(f"User {current_user.id} uploaded file {upload.id}")
        return UploadResponse.model_validate(upload)

    except StorageError as e:
        logger.error(f"Storage error during upload: {e}")
        raise
    except Exception as e:
        logger.error(f"Unexpected error during upload: {e}")
        with contextlib.suppress(Exception):
            await storage_service.delete_upload(current_user.id, upload_id)
        raise
```

---

## Today I Learned

TIL: In the `upload_file` function, using `asyncio.create_task` with `add_done_callback` ensures background tasks are not garbage collected and allows handling exceptions, making asynchronous file processing robust and maintainable.

```python
task = asyncio.create_task(
    process_upload_background(
        upload_id=upload_id,
        user_id=current_user.id,
        file_type=file_type,
        extension=extension,
    )
)
task.add_done_callback(lambda t: t.exception())
```

This pattern prevents task loss and ensures errors are logged or handled, enhancing reliability.

---

*Generated by CodeWorm on 2026-02-22 08:47*
