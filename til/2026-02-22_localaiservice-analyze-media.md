# LocalAIService.analyze_media

**Type:** Today I Learned
**Repository:** vuemantics
**File:** backend/services/ai/service.py
**Language:** python
**Lines:** 104-298
**Complexity:** 15.0

---

## Source Code

```python
async def analyze_media(self, upload_id: UUID) -> None:
        """
        Analyze media file and generate embeddings

        Args:
            upload_id: Upload to process

        Updates upload record with:
        - description: Text description
        - embedding_local: 1024-dimensional vector
        - processing_status: completed or failed
        """
        upload = await Upload.find_by_id(upload_id)
        if not upload:
            logger.error(f"Upload {upload_id} not found")
            return

        try:
            await upload.update_status(ProcessingStatus.ANALYZING)
            await self._publish_progress(
                upload_id,
                ProcessingStatus.ANALYZING,
                ProcessingStage.QUEUED,
                0,
                "Starting AI analysis"
            )
            logger.info(
                f"Starting local AI analysis for upload {upload_id}"
            )

            file_path = config.settings.upload_path / upload.file_path

            description = None
            audit_result = None
            max_retries = 2

            for attempt in range(max_retries):
                if upload.file_type == "video":
                    await self._publish_progress(
                        upload_id,
                        ProcessingStatus.ANALYZING,
                        ProcessingStage.EXTRACTING_FRAMES,
                        10,
                        "Extracting video frames"
                    )

                    try:
                        metadata = await storage_service.get_upload_metadata(
                            upload.user_id,
                            upload_id
                        )
                        if metadata and metadata.get("codec"):
                            await upload.update_video_codec(
                                metadata["codec"]
                            )
                            logger.info(
                                f"Detected video codec for {upload_id}: {metadata['codec']}"
                            )
                    except Exception as codec_err:
                        logger.warning(
                            f"Failed to detect codec for {upload_id}: {codec_err}"
                        )

                await self._publish_progress(
                    upload_id,
                    ProcessingStatus.ANALYZING,
                    ProcessingStage.VISION_ANALYSIS,
                    20,
                    f"Analyzing {upload.file_type} with vision model"
                )

                if upload.file_type == "image":
                    description = await self._vision.analyze_image(
                        file_path
                    )
                else:
                    description = await self._analyze_video_with_frames(
                        upload.user_id,
                        upload_id,
                        file_path
                    )

                if not description:
       
```

---

## Today I Learned

TIL: In `analyze_media`, the function handles retries elegantly using a for-loop with a fixed number of attempts. This ensures that critical operations, like vision analysis, are attempted multiple times before failing, improving robustness without complex retry logic.

```markdown
TIL: The `analyze_media` function uses a simple for-loop to handle up to 2 retries when analyzing media files. This ensures robust processing, especially for video frames and image descriptions, by allowing failures to be retried without complicating the code.
```

---

*Generated by CodeWorm on 2026-02-22 00:48*
