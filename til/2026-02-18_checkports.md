# checkPorts

**Type:** Today I Learned
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/intermediate/docker-security-audit/internal/analyzer/compose.go
**Language:** go
**Lines:** 477-539
**Complexity:** 15.0

---

## Source Code

```go
func (a *ComposeAnalyzer) checkPorts(
	target finding.Target,
	serviceName string,
	node *yaml.Node,
) finding.Collection {
	var findings finding.Collection

	portsNode := findNode(node, "ports")
	if portsNode == nil {
		return findings
	}

	for _, portNode := range portsNode.Content {
		var portSpec string
		switch portNode.Kind {
		case yaml.ScalarNode:
			portSpec = portNode.Value
		case yaml.MappingNode:
			publishedNode := findNode(portNode, "published")
			hostIPNode := findNode(portNode, "host_ip")
			if publishedNode != nil {
				portSpec = publishedNode.Value
			}
			if hostIPNode != nil && hostIPNode.Value == "0.0.0.0" {
				loc := &finding.Location{Path: a.path, Line: hostIPNode.Line}
				f := finding.New("DS-COMPOSE-BIND", "Service '"+serviceName+"' explicitly binds to 0.0.0.0", finding.SeverityInfo, target).
					WithDescription("Binding to 0.0.0.0 exposes the port on all network interfaces.").
					WithCategory(string(CategoryCompose)).
					WithLocation(loc).
					WithRemediation("Consider binding to 127.0.0.1 for local-only access.")
				findings = append(findings, f)
			}
		}

		if portSpec == "" {
			continue
		}

		parts := strings.Split(portSpec, ":")
		var hostPort string
		if len(parts) >= 2 {
			hostPort = parts[0]
			if strings.Contains(hostPort, ".") {
				hostPort = parts[1]
			}
		}

		if hostPort != "" {
			portNum, err := strconv.Atoi(hostPort)
			if err == nil && portNum > 0 && portNum < 1024 {
				loc := &finding.Location{Path: a.path, Line: portNode.Line}
				f := finding.New("DS-COMPOSE-PRIVPORT", "Service '"+serviceName+"' exposes privileged port "+hostPort, finding.SeverityInfo, target).
					WithDescription("Privileged ports (below 1024) typically require root privileges on the host.").
					WithCategory(string(CategoryCompose)).
					WithLocation(loc).
					WithRemediation("Consider using non-privileged ports (>1024) with port mapping.")
				findings = append(findings, f)
			}
		}
	}

	return findings
}
```

---

## Today I Learned

TIL: The `checkPorts` function in Go adeptly handles complex YAML structures by recursively searching for "ports" and "host_ip" nodes, then generating detailed findings based on port specifications. This ensures thorough security analysis of Docker Compose configurations.

```go
findNode(node, "ports")
```

This pattern makes the code both flexible and powerful, handling various node types efficiently.

---

*Generated by CodeWorm on 2026-02-18 19:13*
