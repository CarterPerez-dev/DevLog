# routes

**Type:** File Overview
**Repository:** Cybersecurity-Projects
**File:** TEMPLATES/fullstack-template/backend/app/auth/routes.py
**Language:** python
**Lines:** 1-155
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025
routes.py
"""

from typing import Annotated

from fastapi import (
    APIRouter,
    Cookie,
    Depends,
    Request,
    Response,
    status,
)
from fastapi.security import (
    OAuth2PasswordRequestForm,
)

from config import settings
from core.dependencies import (
    ClientIP,
    CurrentUser,
)
from core.security import (
    clear_refresh_cookie,
    set_refresh_cookie,
)
from core.rate_limit import limiter
from core.exceptions import TokenError
from .schemas import (
    PasswordChange,
    TokenResponse,
    TokenWithUserResponse,
)
from user.schemas import UserResponse
from .dependencies import AuthServiceDep
from user.dependencies import UserServiceDep
from core.responses import AUTH_401


router = APIRouter(prefix = "/auth", tags = ["auth"])


@router.post(
    "/login",
    response_model = TokenWithUserResponse,
    responses = {**AUTH_401}
)
@limiter.limit(settings.RATE_LIMIT_AUTH)
async def login(
    request: Request,
    response: Response,
    auth_service: AuthServiceDep,
    ip: ClientIP,
    form_data: Annotated[OAuth2PasswordRequestForm,
                         Depends()],
) -> TokenWithUserResponse:
    """
    Login with email and password
    """
    result, refresh_token = await auth_service.login(
        email=form_data.username,
        password=form_data.password,
        ip_address=ip,
    )
    set_refresh_cookie(response, refresh_token)
    return result


@router.post(
    "/refresh",
    response_model = TokenResponse,
    responses = {**AUTH_401}
)
async def refresh_token(
    response: Response,
    auth_service: AuthServiceDep,
    ip: ClientIP,
    refresh_token: str | None = Cookie(None),
) -> TokenResponse:
    """
    Refresh access token
    """
    if not refresh_token:
        raise TokenError("Refresh token required")
    result, new_refresh_token = await auth_service.refresh_tokens(
        refresh_token,
        ip_address = ip
    )
    set_refresh_cookie(response, new_refresh_token)
    return result


@router.post(
    "/logout",
    status_code = status.HTTP_204_NO_CONTENT,
    responses = {**AUTH_401}
)
async def logout(
    response: Response,
    auth_service: AuthServiceDep,
    refresh_token: str | None = Cookie(None),
) -> None:
    """
    Logout current session
    """
    if not refresh_token:
        raise TokenError("Refresh token required")
    await auth_service.logout(refresh_token)
    clear_refresh_cookie(response)


@router.post("/logout-all", responses = {**AUTH_401})
async def logout_all(
    response: Response,
    auth_service: AuthServiceDep,
    current_user: CurrentUser,
) -> dict[str,
          int]:
    """
    Logout from all devices
    """
    count = await auth_service.logout_all(current_user)
    clear_refresh_cookie(response)
    return {"revoked_sessions": count}


@router.get("/me", response_model = UserResponse, responses = {**AUTH_401})
async def get_current_user(current_user: CurrentUser) -> UserResponse:
    """
    Get current au
```

---

## File Overview

### Purpose and Responsibility

This file, `routes.py`, defines FastAPI routes for authentication-related operations such as login, token refresh, logout, password change, and user information retrieval. It integrates with various services and dependencies to handle secure user sessions and manage tokens.

### Key Exports and Public Interface

- **Login**: Handles user login with email and password.
- **Refresh Token**: Refreshes the access token using a provided refresh token.
- **Logout**: Logs out the current session by invalidating the refresh token.
- **Logout All**: Logs out from all devices associated with the user.
- **Get Current User**: Retrieves information about the currently authenticated user.
- **Change Password**: Allows users to change their password.

### How It Fits into the Project

This file is part of the authentication module, which is crucial for securing access to other parts of the application. The routes interact with services like `AuthServiceDep` and `UserServiceDep`, ensuring that only authorized users can perform actions. The routes are prefixed with `/auth` and tagged as "auth" in the API documentation.

### Notable Design Decisions

- **Rate Limiting**: Implements rate limiting for authentication endpoints to prevent brute-force attacks.
- **Token Management**: Uses cookies to manage refresh tokens, ensuring secure token handling.
- **Dependency Injection**: Utilizes dependency injection for services like `AuthServiceDep` and `UserServiceDep`, promoting loose coupling and testability.
- **Exception Handling**: Handles exceptions such as missing or invalid refresh tokens gracefully, returning appropriate HTTP responses.
```

This documentation provides a high-level overview of the file's purpose, key components, integration within the project, and significant design choices.

---

*Generated by CodeWorm on 2026-02-18 12:29*
