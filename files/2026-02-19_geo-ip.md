# geo_ip

**Type:** File Overview
**Repository:** CertGames-Core
**File:** backend/api/core/services/clients/geo_ip.py
**Language:** python
**Lines:** 1-242
**Complexity:** 0.0

---

## Source Code

```python
"""
GeoIP Service using IP-API.com
/api/core/services/geo_ip.py
"""

import requests
from typing import Any
from flask import current_app


class GeoIPService:
    """
    GeoIP - IP-API.com - 15,000 requests/hr
    """
    def __init__(self) -> None:
        self.base_url = "http://ip-api.com/json"
        self.timeout = 5

    def get_location_info(self, ip_address: str | None) -> dict[str, Any]:
        """
        Get location information from IP address using IP-API.com
        """
        if not ip_address or ip_address in ["127.0.0.1",
                                            "::1",
                                            "localhost"]:
            return {
                "ip": ip_address,
                "city": "Unknown",
                "country": "Unknown",
                "timezone": "Unknown",
                "success": False,
                "error": "Invalid or local IP address"
            }

        try:
            url = f"{self.base_url}/{ip_address}?fields=status,message,country,countryCode,region,regionName,city,zip,lat,lon,timezone,isp,org,as,query"

            response = requests.get(url, timeout = self.timeout)
            response.raise_for_status()

            data = response.json()

            if data.get("status") == "success":
                return {
                    "ip": data.get("query",
                                   ip_address),
                    "city": data.get("city",
                                     "Unknown"),
                    "region": data.get("regionName",
                                       "Unknown"),
                    "region_code": data.get("region",
                                            "Unknown"),
                    "country": data.get("country",
                                        "Unknown"),
                    "country_code": data.get("countryCode",
                                             "Unknown"),
                    "timezone": data.get("timezone",
                                         "Unknown"),
                    "latitude": data.get("lat"),
                    "longitude": data.get("lon"),
                    "zip": data.get("zip"),
                    "isp": data.get("isp",
                                    "Unknown"),
                    "organization": data.get("org",
                                             "Unknown"),
                    "as_number": data.get("as",
                                          "Unknown"),
                    "success": True
                }

            error_msg = data.get("message", "Unknown error")
            current_app.logger.warning(
                f"IP-API.com returned failure for {ip_address}: {error_msg}"
            )
            return {
                "ip": ip_address,
                "city": "Unknown",
                "country": "Unknown",
                "timezone": "Unknown",
                "success": False,
                "error": error_msg
            }

        except reque
```

---

## File Overview

# geo_ip.py

**Purpose and Responsibility:**
This file provides a service for fetching geolocation information from IP addresses using the [IP-API.com](http://ip-api.com) API. It handles both single and bulk requests, ensuring robust error handling and logging.

**Key Exports/Interface:**
- `GeoIPService`: The main class responsible for interacting with the IP-API.com service.
  - `get_location_info(ip_address: str | None) -> dict[str, Any]`: Fetches location information for a single IP address.
  - `get_bulk_location_info(ip_addresses: list[str]) -> dict[str, dict[str, Any]]`: Fetches location information for multiple IP addresses in batches.

**How it Fits into the Project:**
This service is part of the `api/core/services` module and is used by other components within the CertGames-Core backend to determine user locations based on their IP addresses. It integrates with Flask via `current_app.logger` for logging errors and warnings.

**Notable Design Decisions:**
- **Error Handling:** Comprehensive error handling, including timeouts, request failures, and unexpected exceptions, ensures robustness.
- **Batch Requests:** Supports up to 100 IPs in a single batch request, optimizing API usage.
- **Logging:** Utilizes Flask's `current_app.logger` for logging errors and warnings, aiding in monitoring and debugging.

---

*Generated by CodeWorm on 2026-02-19 13:22*
