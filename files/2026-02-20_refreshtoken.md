# RefreshToken

**Type:** File Overview
**Repository:** my-portfolio
**File:** v1/backend/app/auth/RefreshToken.py
**Language:** python
**Lines:** 1-113
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025
RefreshToken.py
"""

from __future__ import annotations

from datetime import UTC, datetime
from typing import TYPE_CHECKING
from uuid import UUID

import uuid6
from sqlalchemy import (
    DateTime,
    ForeignKey,
    String,
)
from sqlalchemy.orm import (
    Mapped,
    mapped_column,
    relationship,
)

import config
from core.Base import (
    Base,
    TimestampMixin,
    UUIDMixin,
)

if TYPE_CHECKING:
    from user.User import User


class RefreshToken(Base, UUIDMixin, TimestampMixin):
    """
    Refresh token for JWT authentication

    Tokens are stored as SHA 256 hashes, never raw
    Family ID enables detection of token reuse attacks
    """
    __tablename__ = "refresh_tokens"

    token_hash: Mapped[str] = mapped_column(
        String(config.TOKEN_HASH_LENGTH),
        unique = True,
        index = True,
    )

    user_id: Mapped[UUID] = mapped_column(
        ForeignKey("users.id",
                   ondelete = "CASCADE"),
        index = True,
    )

    family_id: Mapped[UUID] = mapped_column(
        default = uuid6.uuid7,
        index = True,
    )

    device_id: Mapped[str | None] = mapped_column(
        String(config.DEVICE_ID_MAX_LENGTH),
        default = None,
    )
    device_name: Mapped[str | None] = mapped_column(
        String(config.DEVICE_NAME_MAX_LENGTH),
        default = None,
    )
    ip_address: Mapped[str | None] = mapped_column(
        String(config.IP_ADDRESS_MAX_LENGTH),
        default = None,
    )

    expires_at: Mapped[datetime] = mapped_column(
        DateTime(timezone = True),
        index = True,
    )

    is_revoked: Mapped[bool] = mapped_column(default = False)
    revoked_at: Mapped[datetime | None] = mapped_column(
        DateTime(timezone = True),
        default = None,
    )

    user: Mapped[User] = relationship(back_populates = "refresh_tokens")

    def revoke(self) -> None:
        """
        Revoke this token
        """
        self.is_revoked = True
        self.revoked_at = datetime.now(UTC)

    @property
    def is_expired(self) -> bool:
        """
        Check if token has expired

        Handles both timezone aware and naive datetimes for SQLite compatibility
        """
        now = datetime.now(UTC)
        expires = self.expires_at
        if expires.tzinfo is None:
            expires = expires.replace(tzinfo = UTC)
        return now > expires

    @property
    def is_valid(self) -> bool:
        """
        Check if token is usable
        """
        return not self.is_revoked and not self.is_expired

```

---

## File Overview

### RefreshToken.py

**Purpose and Responsibility:**
This file defines the `RefreshToken` model for managing JWT refresh tokens within a secure authentication system. It ensures that tokens are stored securely, tracked for revocation, and managed based on their expiration.

**Key Exports or Public Interface:**
- **Class:** `RefreshToken` - Represents a single refresh token with attributes like `token_hash`, `user_id`, `family_id`, and methods to revoke the token and check its validity.
  
**How it Fits in the Project:**
`RefreshToken` is part of the authentication module, crucial for maintaining secure user sessions. It interacts with the `User` model through a relationship, ensuring that each refresh token is linked to a specific user.

**Notable Design Decisions:**
- **UUID and Timestamp Mixins:** Utilizes `UUIDMixin` and `TimestampMixin` from `core.Base` to automatically generate unique IDs and track creation/modification times.
- **Token Hashing and Family ID:** Tokens are stored as SHA 256 hashes for security, while the `family_id` helps detect token reuse attacks.
- **Revocation Mechanism:** Provides a clear method to revoke tokens (`revoke()`) and properties to check if a token is valid or expired (`is_valid`, `is_expired`).
```

This documentation provides an overview of the file's purpose, key components, integration within the project, and significant design choices.

---

*Generated by CodeWorm on 2026-02-20 08:58*
