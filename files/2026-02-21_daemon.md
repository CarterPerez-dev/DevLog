# daemon

**Type:** File Overview
**Repository:** CodeWorm
**File:** codeworm/daemon.py
**Language:** python
**Lines:** 1-720
**Complexity:** 0.0

---

## Source Code

```python
"""
ⒸAngelaMos | 2026
daemon.py
"""
from __future__ import annotations

import asyncio
import signal
import sys
from dataclasses import dataclass, field
from datetime import datetime, timedelta
from pathlib import Path
from typing import TYPE_CHECKING

from codeworm.analysis import (
    CodeAnalyzer,
    ParserManager,
    TargetRouter,
)
from codeworm.analysis.targets import DocumentationTarget, select_doc_type
from codeworm.core import (
    CodeWormSettings,
    StateManager,
    configure_logging,
    get_logger,
    load_settings,
)
from codeworm.core.events import get_publisher
from codeworm.git import DevLogRepository
from codeworm.llm import (
    DocumentationGenerator,
    OllamaClient,
    OllamaError,
)
from codeworm.models import DocType
from codeworm.scheduler import CodeWormScheduler

if TYPE_CHECKING:
    from codeworm.analysis import AnalysisCandidate


@dataclass
class CycleStats:
    """
    Tracks cycle statistics for monitoring and backoff logic
    """
    total_cycles: int = 0
    successful_cycles: int = 0
    failed_cycles: int = 0
    skipped_cycles: int = 0
    consecutive_failures: int = 0
    consecutive_ollama_failures: int = 0
    last_success: datetime | None = None
    last_failure: datetime | None = None
    last_failure_reason: str = ""
    repos_exhausted: set = field(default_factory = set)

    @property
    def success_rate(self) -> float:
        if self.total_cycles == 0:
            return 0.0
        return self.successful_cycles / self.total_cycles * 100

    def record_success(self) -> None:
        self.total_cycles += 1
        self.successful_cycles += 1
        self.consecutive_failures = 0
        self.consecutive_ollama_failures = 0
        self.last_success = datetime.now()
        self.repos_exhausted.clear()

    def record_failure(self, reason: str) -> None:
        self.total_cycles += 1
        self.failed_cycles += 1
        self.consecutive_failures += 1
        self.last_failure = datetime.now()
        self.last_failure_reason = reason

    def record_ollama_failure(self) -> None:
        self.consecutive_ollama_failures += 1

    def record_ollama_recovery(self) -> None:
        self.consecutive_ollama_failures = 0

    def record_skip(self, reason: str) -> None:
        self.total_cycles += 1
        self.skipped_cycles += 1
        self.last_failure_reason = reason

    def record_repo_exhausted(self, repo_name: str) -> None:
        self.repos_exhausted.add(repo_name)

    def get_backoff_seconds(self) -> int:
        if self.consecutive_failures <= 1:
            return 0
        return min(300, 30 * (2**(self.consecutive_failures - 1)))

    def get_ollama_wait_seconds(self) -> int:
        if self.consecutive_ollama_failures <= 1:
            return 10
        return min(300, 10 * (2**(self.consecutive_ollama_failures - 1)))

    def to_dict(self) -> dict:
        return {
            "total_cycles":
            self.total_cycles,
            "successful_cycles":
            self
```

---

## File Overview

### daemon.py

**Purpose and Responsibility:**
This file defines the `CodeWormDaemon` class, which serves as the orchestrator for CodeWorm's 24/7 operation. It coordinates tasks such as code analysis, LLM generation, git commits, and scheduling, ensuring robust self-healing capabilities.

**Key Exports and Public Interface:**
- **Class:** `CodeWormDaemon`
  - **Initialization:** Takes `settings` (CodeWormSettings) and `dry_run` (bool) parameters.
  - **Methods:**
    - `_setup_signals`: Sets up signal handlers for graceful shutdown.
    - `run`: Main loop to execute the daemon's tasks.

**How It Fits in the Project:**
The `CodeWormDaemon` class is central to CodeWorm’s operation, integrating various components like code analysis (`CodeAnalyzer`), LLM generation (`DocumentationGenerator`), and git operations (`DevLogRepository`). It ensures that all processes are managed efficiently and can recover from failures.

**Notable Design Decisions:**
- **Self-healing Mechanism:** The daemon self-restarts when Ollama (LLM service) is unavailable, ensuring continuous operation.
- **Backoff Logic:** Implements exponential backoff for retries based on consecutive failures to avoid overwhelming the system.
- **Cycle Statistics:** Tracks and manages cycle statistics using `CycleStats` to monitor performance and make informed decisions about scheduling and recovery.
```

This documentation provides a high-level overview of the file's purpose, key components, integration within the project, and significant design choices.

---

*Generated by CodeWorm on 2026-02-21 01:32*
