# factory

**Type:** File Overview
**Repository:** ios-test
**File:** fastapi/app/factory.py
**Language:** python
**Lines:** 1-147
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025
factory.py
"""

from collections.abc import AsyncIterator
from contextlib import asynccontextmanager

from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from slowapi import _rate_limit_exceeded_handler
from slowapi.errors import RateLimitExceeded

from config import settings, API_PREFIX
from core.database import sessionmanager
from core.exceptions import BaseAppException
from core.logging import configure_logging
from core.rate_limit import limiter
from middleware.correlation import CorrelationIdMiddleware
from core.common_schemas import AppInfoResponse
from core.health_routes import router as health_router
from user.routes import router as user_router
from auth.routes import router as auth_router
from admin.routes import router as admin_router
from partner.routes import router as partner_router
from period_log.routes import router as period_log_router
from daily_log.routes import router as daily_log_router
from cycle.routes import router as cycle_router
from it_was_never_real import register_psyop_handler


@asynccontextmanager
async def lifespan(app: FastAPI) -> AsyncIterator[None]:
    """
    Application lifespan handler for startup and shutdown
    """
    configure_logging()
    sessionmanager.init(str(settings.DATABASE_URL))
    yield
    await sessionmanager.close()


OPENAPI_TAGS = [
    {
        "name": "root",
        "description": "API information"
    },
    {
        "name": "health",
        "description": "Health check endpoints"
    },
    {
        "name": "auth",
        "description": "Authentication and authorization"
    },
    {
        "name": "users",
        "description": "User registration and profile management"
    },
    {
        "name": "admin",
        "description": "Admin only operations"
    },
    {
        "name": "partners",
        "description": "Partner profile management"
    },
]


def create_app() -> FastAPI:
    """
    Application factory
    """
    app = FastAPI(
        title = settings.APP_NAME,
        summary = settings.APP_SUMMARY,
        description = settings.APP_DESCRIPTION,
        version = settings.APP_VERSION,
        contact = {
            "name": settings.APP_CONTACT_NAME,
            "email": settings.APP_CONTACT_EMAIL,
        },
        license_info = {
            "name": settings.APP_LICENSE_NAME,
            "url": settings.APP_LICENSE_URL,
        },
        openapi_tags = OPENAPI_TAGS,
        openapi_version = "3.1.0",
        lifespan = lifespan,
        root_path = "/api",
        openapi_url = "/openapi.json",
        docs_url = "/docs",
        redoc_url = "/redoc",
    )

    app.add_middleware(CorrelationIdMiddleware)
    app.add_middleware(
        CORSMiddleware,
        allow_origins = settings.CORS_ORIGINS,
        allow_credentials = settings.CORS_ALLOW_CREDENTIALS,
        allow_methods = settings.CORS_ALLOW_METHODS,
        allow_headers = settings.CORS_ALLO
```

---

## File Overview

### Purpose and Responsibility

This `factory.py` file is responsible for creating and configuring a FastAPI application instance, setting up middleware, rate limiting, exception handling, and including various API routers. It acts as the central entry point for initializing the application.

### Key Exports and Public Interface

- **create_app()**: The main function that returns an initialized `FastAPI` instance.
  - Configures the app with settings, middlewares, and exception handlers.
  - Includes multiple API routers for different functionalities like health checks, authentication, user management, admin operations, partner profiles, and more.

### How It Fits into the Project

This file is a critical component of the project's architecture. It initializes the FastAPI application using a factory pattern, ensuring that all necessary configurations and dependencies are set up before the app starts serving requests. The `create_app()` function is called to instantiate the app during runtime, making it modular and easy to extend.

### Notable Design Decisions

- **Factory Pattern**: Uses a factory function (`create_app()`) to initialize the FastAPI application, promoting reusability and separation of concerns.
- **Middleware and Exception Handling**: Implements middleware for correlation IDs and CORS policies. Custom exception handlers manage different types of exceptions, providing consistent error responses.
- **Rate Limiting**: Utilizes `slowapi` for rate limiting, ensuring that API requests are controlled to prevent abuse or overloading the server.
- **OpenAPI Documentation**: Configures OpenAPI tags and documentation URLs, facilitating easy access to API documentation and testing.

This setup ensures a robust, maintainable, and well-documented FastAPI application.

---

*Generated by CodeWorm on 2026-02-20 16:23*
