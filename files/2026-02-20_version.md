# version

**Type:** File Overview
**Repository:** angela
**File:** internal/pypi/version.go
**Language:** go
**Lines:** 1-315
**Complexity:** 0.0

---

## Source Code

```go
// Â©AngelaMos | 2026
// version.go

package pypi

import (
	"cmp"
	"errors"
	"fmt"
	"math"
	"regexp"
	"strconv"
	"strings"
)

// ErrInvalidVersion indicates a string that does not conform to PEP 440
var ErrInvalidVersion = errors.New("invalid PEP 440 version")

// ChangeKind classifies a version bump by semver magnitude
type ChangeKind int

// Version change magnitudes.
const (
	Patch ChangeKind = iota + 1
	Minor
	Major
)

// String returns the lowercase name of the change kind
func (c ChangeKind) String() string {
	switch c {
	case Patch:
		return "patch"
	case Minor:
		return "minor"
	case Major:
		return "major"
	default:
		return "unknown"
	}
}

// Version represents a parsed PEP 440 version with all optional components
type Version struct {
	Raw     string
	Epoch   int
	Release []int
	PreKind string
	PreNum  int
	Post    int
	Dev     int
	Local   string
}

var versionRe = regexp.MustCompile(
	`(?i)^v?` +
		`(?:(\d+)!)?` +
		`(\d+(?:\.\d+)*)` +
		`(?:[-_.]?(alpha|a|beta|b|preview|pre|c|rc)[-_.]?(\d*))?` +
		`(?:[-_.]?(post|rev|r)[-_.]?(\d*)|-(\d+))?` +
		`(?:[-_.]?(dev)[-_.]?(\d*))?` +
		`(?:\+([a-z0-9](?:[a-z0-9._-]*[a-z0-9])?))?$`,
)

// ParseVersion parses a PEP 440 version string into its structured components
func ParseVersion(s string) (Version, error) {
	normalized := strings.ToLower(strings.TrimSpace(s))
	m := versionRe.FindStringSubmatch(normalized)
	if m == nil {
		return Version{}, fmt.Errorf("%w: %q", ErrInvalidVersion, s)
	}

	v := Version{
		Raw:  s,
		Post: -1,
		Dev:  -1,
	}

	if m[1] != "" {
		v.Epoch = mustAtoi(m[1])
	}

	for _, seg := range strings.Split(m[2], ".") {
		v.Release = append(v.Release, mustAtoi(seg))
	}

	if m[3] != "" {
		v.PreKind = normalizePreKind(m[3])
		v.PreNum = optionalAtoi(m[4])
	}

	switch {
	case m[5] != "":
		v.Post = optionalAtoi(m[6])
	case m[7] != "":
		v.Post = mustAtoi(m[7])
	}

	if m[8] != "" {
		v.Dev = optionalAtoi(m[9])
	}

	v.Local = m[10]

	return v, nil
}

// String returns the canonical PEP 440 representation
func (v Version) String() string {
	var b strings.Builder

	if v.Epoch != 0 {
		fmt.Fprintf(&b, "%d!", v.Epoch)
	}

	for i, n := range v.Release {
		if i > 0 {
			b.WriteByte('.')
		}
		fmt.Fprintf(&b, "%d", n)
	}

	if v.PreKind != "" {
		fmt.Fprintf(&b, "%s%d", v.PreKind, v.PreNum)
	}

	if v.Post >= 0 {
		fmt.Fprintf(&b, ".post%d", v.Post)
	}

	if v.Dev >= 0 {
		fmt.Fprintf(&b, ".dev%d", v.Dev)
	}

	if v.Local != "" {
		fmt.Fprintf(&b, "+%s", v.Local)
	}

	return b.String()
}

// IsStable reports whether the version is a stable (non-pre, non-dev) release
func (v Version) IsStable() bool {
	return v.PreKind == "" && v.Dev < 0
}

// Compare returns -1, 0, or 1 following PEP 440 ordering rules.
//
// The ordering within a given release segment is:
//
//	1.0.dev1 < 1.0a1 < 1.0b1 < 1.0rc1 < 1.0 < 1.0.post1
func (v Version) Compare(other Version) int {
	if c := cmp.Compare(v.Epoch, other.Epoch); c != 0 {
		return c
	}

	if c := compareRelease(v.Release, other.Release); c != 0 {
		retur
```

---

## File Overview

# version.go

## Purpose and Responsibility
This Go source file defines a `Version` struct to parse and represent PEP 440 compliant version strings, providing methods for comparison, classification of change kinds, and identifying stable versions.

## Key Exports and Public Interface
- **Version**: Represents a parsed PEP 440 version.
- **ParseVersion**: Parses a string into a `Version` struct.
- **String**: Returns the canonical PEP 440 representation of a `Version`.
- **IsStable**: Checks if a version is stable (non-pre, non-dev).
- **Compare**: Compares two versions according to PEP 440 rules.
- **ClassifyChange**: Determines whether moving from one version to another is a major, minor, or patch bump.
- **LatestStable**: Finds the highest stable version among a list of version strings.

## How It Fits into the Project
This file is part of the `pypi` package within the larger `angela` project. It handles versioning and comparison logic for packages managed by the PyPI (Python Package Index) system, ensuring compatibility with PEP 440 standards.

## Notable Design Decisions
- **Error Handling**: Uses `errors.New` to handle invalid versions.
- **Regular Expressions**: Utilizes a complex regex pattern to parse version strings accurately.
- **Comparison Logic**: Implements detailed comparison rules following PEP 440, including handling of pre-releases and post-releases.
- **Stability Check**: Provides a method to identify stable releases, crucial for package management.
```

This documentation covers the high-level purpose, key exports, integration within the project, and notable design decisions.

---

*Generated by CodeWorm on 2026-02-20 17:36*
