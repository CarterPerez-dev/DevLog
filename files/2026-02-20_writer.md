# writer

**Type:** File Overview
**Repository:** angela
**File:** internal/pyproject/writer.go
**Language:** go
**Lines:** 1-142
**Complexity:** 0.0

---

## Source Code

```go
// ©AngelaMos | 2026
// writer.go

package pyproject

import (
	"fmt"
	"os"
	"regexp"
	"strings"

	"github.com/CarterPerez-dev/angela/internal/pypi"
	toml "github.com/pelletier/go-toml/v2"
)

// Updater performs surgical edits on raw pyproject.toml bytes, preserving
// all comments, whitespace, and key ordering
type Updater struct {
	content []byte
}

// NewUpdater wraps raw file content after validating it as syntactically
// correct TOML
func NewUpdater(content []byte) (*Updater, error) {
	var probe map[string]any
	if err := toml.Unmarshal(content, &probe); err != nil {
		return nil, fmt.Errorf("invalid TOML: %w", err)
	}
	return &Updater{content: content}, nil
}

// UpdateDependency replaces the version specifier for a single dependency
// while preserving quotes, extras, markers, and surrounding formatting.
// Tries double-quote patterns first, then single-quote.
func (u *Updater) UpdateDependency(pkg, newSpec string) error {
	for _, q := range []byte{'"', '\''} {
		pattern := buildDepPattern(pkg, q)
		found := false
		u.content = pattern.ReplaceAllFunc(
			u.content,
			func(match []byte) []byte {
				found = true
				return replaceSpec(pattern, match, newSpec, q)
			},
		)
		if found {
			var probe map[string]any
			if err := toml.Unmarshal(u.content, &probe); err != nil {
				return fmt.Errorf(
					"update produced invalid TOML: %w", err,
				)
			}
			return nil
		}
	}
	return fmt.Errorf("dependency %q not found", pkg)
}

// Bytes returns the current file content
func (u *Updater) Bytes() []byte {
	return u.content
}

// WriteFile atomically writes the updated content to disk
func (u *Updater) WriteFile(path string) error {
	tmp := path + ".tmp"
	if err := os.WriteFile(tmp, u.content, 0o600); err != nil {
		return fmt.Errorf("write temp: %w", err)
	}
	if err := os.Rename(tmp, path); err != nil {
		_ = os.Remove(tmp) //nolint:errcheck
		return fmt.Errorf("rename: %w", err)
	}
	return nil
}

func buildDepPattern(name string, quote byte) *regexp.Regexp {
	normalized := pypi.NormalizeName(name)
	parts := strings.Split(normalized, "-")
	for i, p := range parts {
		parts[i] = regexp.QuoteMeta(p)
	}
	namePattern := strings.Join(parts, `[-_.]?`)

	q := string(quote)
	notQ := `[^` + q + `]`

	return regexp.MustCompile(
		`(?i)` +
			q +
			`(` + namePattern + `)` +
			`(\[[^\]]*\])?` +
			`(\s*[><=!~]` + notQ + `*?)` +
			`(;` + notQ + `*)?` +
			q,
	)
}

func replaceSpec(
	re *regexp.Regexp, match []byte, newSpec string, quote byte,
) []byte {
	groups := re.FindSubmatch(match)
	if len(groups) < 5 {
		return match
	}

	name := groups[1]
	extras := groups[2]
	markers := groups[4]

	var b []byte
	b = append(b, quote)
	b = append(b, name...)
	b = append(b, extras...)
	b = append(b, []byte(newSpec)...)
	b = append(b, markers...)
	b = append(b, quote)
	return b
}

// UpdateFile is a convenience that reads, updates all given dependencies,
// and writes back atomically
func UpdateFile(path string, updates map[string]string) error {
	data, err := os.Read
```

---

## File Overview

// writer.go

This Go source file is responsible for updating dependencies within a `pyproject.toml` file while preserving formatting, comments, and key ordering. It provides a high-level API to perform these updates atomically.

### Key Exports and Public Interface

- **Updater**: Manages the raw content of a `pyproject.toml` file.
  - `NewUpdater([]byte) (*Updater, error)`: Creates an Updater instance from raw TOML content.
  - `UpdateDependency(string, string) error`: Updates a specific dependency's version specifier.
  - `Bytes() []byte`: Returns the current content of the file.
  - `WriteFile(string) error`: Atomically writes the updated content to disk.

- **UpdateFile(string, map[string]string) error**: A convenience function that reads, updates dependencies, and writes back to the original file atomically.

### How It Fits into the Project

This file is part of the `pyproject` package within the `angela` project. Its primary role is to handle the manipulation of `pyproject.toml` files, which are crucial for Python projects' configuration. The `Updater` struct and its methods ensure that updates are performed in a way that maintains the integrity and readability of the file.

### Notable Design Decisions

- **Error Handling**: Errors are returned from all public functions to provide clear feedback on what went wrong.
- **Atomicity**: The `WriteFile` method uses atomic operations (temp files and rename) to ensure data consistency.
- **Regex Patterns**: Custom regex patterns are used to precisely locate and update dependency specifications, ensuring minimal disruption to the surrounding content.
- **TOML Validation**: The file ensures that updates do not produce invalid TOML by validating the updated content after each modification.

---

*Generated by CodeWorm on 2026-02-20 17:47*
