# writer

**Type:** File Overview
**Repository:** angela
**File:** internal/requirements/writer.go
**Language:** go
**Lines:** 1-81
**Complexity:** 0.0

---

## Source Code

```go
// ©AngelaMos | 2026
// writer.go

package requirements

import (
	"fmt"
	"os"
	"regexp"
	"strings"

	"github.com/CarterPerez-dev/angela/internal/pypi"
)

// UpdateFile replaces version specifiers for the given packages in a
// requirements.txt file, preserving all comments and formatting
func UpdateFile(path string, updates map[string]string) error {
	data, err := os.ReadFile(path) //nolint:gosec
	if err != nil {
		return fmt.Errorf("read %s: %w", path, err)
	}

	content := data
	for pkg, spec := range updates {
		pattern := buildPattern(pkg)
		found := false
		content = pattern.ReplaceAllFunc(
			content,
			func(match []byte) []byte {
				found = true
				return replaceSpec(pattern, match, spec)
			},
		)
		if !found {
			return fmt.Errorf(
				"dependency %q not found in %s", pkg, path,
			)
		}
	}

	tmp := path + ".tmp"
	if err := os.WriteFile(tmp, content, 0o600); err != nil {
		return fmt.Errorf("write temp: %w", err)
	}
	if err := os.Rename(tmp, path); err != nil {
		_ = os.Remove(tmp) //nolint:errcheck
		return fmt.Errorf("rename: %w", err)
	}
	return nil
}

func buildPattern(name string) *regexp.Regexp {
	normalized := pypi.NormalizeName(name)
	parts := strings.Split(normalized, "-")
	for i, p := range parts {
		parts[i] = regexp.QuoteMeta(p)
	}
	namePattern := strings.Join(parts, `[-_.]?`)

	return regexp.MustCompile(
		`(?im)^(` + namePattern + `)` +
			`(\[[^\]]*\])?` +
			`(\s*[><=!~][^\n;#]*)`,
	)
}

func replaceSpec(
	re *regexp.Regexp, match []byte, newSpec string,
) []byte {
	groups := re.FindSubmatch(match)
	if len(groups) < 4 {
		return match
	}

	var b []byte
	b = append(b, groups[1]...)
	b = append(b, groups[2]...)
	b = append(b, []byte(newSpec)...)
	return b
}

```

---

## File Overview

// ©AngelaMos | 2026
// writer.go

### Purpose and Responsibility
This file is responsible for updating version specifications of specified packages in a `requirements.txt` file while preserving comments and formatting.

### Key Exports or Public Interface
- **UpdateFile**: The primary function that updates dependencies in the `requirements.txt` file. It takes a path to the file and a map of package names with their new versions, returning an error if any package is not found.

### How it Fits in the Project
This file is part of the `requirements` package within the `internal` directory. It works closely with other modules that handle dependency management and ensures that changes to the `requirements.txt` file are applied correctly without disrupting existing configurations.

### Notable Design Decisions
- **Regular Expressions**: The use of regular expressions for pattern matching allows flexible handling of various naming conventions in package specifications.
- **Error Handling**: Robust error handling, including informative error messages and safe file operations, ensures that any issues during the update process are properly communicated.
- **Temporary File Usage**: Creating a temporary file before renaming it helps maintain data integrity by providing a fallback if something goes wrong during the update.
```

This documentation provides an overview of the `writer.go` file's role within the project and highlights key aspects such as its primary function, design choices, and integration with other components.

---

*Generated by CodeWorm on 2026-02-20 18:09*
