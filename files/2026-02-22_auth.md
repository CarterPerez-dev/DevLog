# auth

**Type:** File Overview
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/auth/services/auth.py
**Language:** python
**Lines:** 1-213
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025
auth.py
"""

import uuid6
from sqlalchemy.ext.asyncio import (
    AsyncSession,
)

from core.exceptions import (
    InvalidCredentials,
    TokenError,
    TokenRevokedError,
)
from core.security.auth.jwt import (
    hash_token,
    create_access_token,
    create_refresh_token,
    verify_password_with_timing_safety,
)
from aspects.auth.models.User import User
from aspects.auth.repositories.user import UserRepository
from aspects.auth.repositories.refresh_token import RefreshTokenRepository
from aspects.auth.schemas.auth import (
    TokenResponse,
    TokenWithUserResponse,
)
from aspects.auth.schemas.user import UserResponse


class AuthService:
    """
    Business logic for authentication operations
    """
    @staticmethod
    async def authenticate(
        session: AsyncSession,
        email: str,
        password: str,
        device_id: str | None = None,
        device_name: str | None = None,
        ip_address: str | None = None,
    ) -> tuple[str,
               str,
               User]:
        """
        Authenticate user and create tokens
        """
        user = await UserRepository.get_by_email(session, email)
        hashed_password = user.hashed_password if user else None

        is_valid, new_hash = await verify_password_with_timing_safety(
            password, hashed_password
        )

        if not is_valid or user is None:
            raise InvalidCredentials()

        if not user.is_active:
            raise InvalidCredentials()

        if new_hash:
            await UserRepository.update_password(session, user, new_hash)

        access_token = create_access_token(user.id, user.token_version)

        family_id = uuid6.uuid7()
        raw_refresh, token_hash, expires_at = create_refresh_token(user.id, family_id)

        await RefreshTokenRepository.create_token(
            session,
            user_id = user.id,
            token_hash = token_hash,
            family_id = family_id,
            expires_at = expires_at,
            device_id = device_id,
            device_name = device_name,
            ip_address = ip_address,
        )

        return access_token, raw_refresh, user

    @staticmethod
    async def login(
        session: AsyncSession,
        email: str,
        password: str,
        device_id: str | None = None,
        device_name: str | None = None,
        ip_address: str | None = None,
    ) -> tuple[TokenWithUserResponse,
               str]:
        """
        Login and return tokens with user data
        """
        access_token, refresh_token, user = await AuthService.authenticate(
            session,
            email,
            password,
            device_id,
            device_name,
            ip_address,
        )

        response = TokenWithUserResponse(
            access_token = access_token,
            user = UserResponse.model_validate(user),
        )
        return response, refresh_token

    @staticmethod
    async def refresh_to
```

---

## File Overview

### auth.py

**Purpose and Responsibility:**
This Python file contains business logic for authentication operations, including user login, token creation, and refresh mechanisms. It ensures secure and efficient handling of user credentials and tokens.

**Key Exports and Public Interface:**
- `AuthService`: A class containing static methods for:
  - User authentication (`authenticate`)
  - Token-based login (`login`)
  - Token refresh (`refresh_tokens`)
  - User logout (`logout`)

**How it Fits in the Project:**
This file is a crucial component of the authentication system, interfacing with user and token repositories to manage sessions securely. It integrates with core security modules for hashing passwords and creating tokens, ensuring that sensitive data is handled appropriately.

**Notable Design Decisions:**
- **Asynchronous Operations:** The use of `AsyncSession` from SQLAlchemy ensures efficient database interactions.
- **Token Security:** Implementations include timing-safe password verification and token rotation to mitigate replay attacks.
- **Dependency Injection:** Methods accept `AsyncSession` as a parameter, allowing for flexible testing and integration with different database backends.
```

This documentation provides an overview of the file's role in the project, its key functionalities, and design choices that enhance security and flexibility.

---

*Generated by CodeWorm on 2026-02-22 01:39*
