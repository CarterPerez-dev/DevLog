# auth

**Type:** File Overview
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/auth/routes/auth.py
**Language:** python
**Lines:** 1-167
**Complexity:** 0.0

---

## Source Code

```python
"""
ⒸAngelaMos | 2025
auth.py
"""

from typing import Annotated

from fastapi import (
    APIRouter,
    Cookie,
    Depends,
    Request,
    Response,
    status,
)
from fastapi.security import (
    OAuth2PasswordRequestForm,
)

from config import settings
from core.security.auth.dependencies import (
    ClientIP,
    CurrentUser,
    DBSession,
)
from core.security.auth.jwt import (
    clear_refresh_cookie,
    set_refresh_cookie,
)
from core.security.rate_limit.limiter import limiter
from core.exceptions import TokenError
from aspects.auth.schemas.auth import (
    PasswordChange,
    TokenResponse,
    TokenWithUserResponse,
)
from aspects.auth.schemas.user import UserResponse
from aspects.auth.services.auth import AuthService
from aspects.auth.services.user import UserService
from core.foundation.responses import AUTH_401


router = APIRouter(prefix = "/auth", tags = ["auth"])


@router.post(
    "/login",
    response_model = TokenWithUserResponse,
    responses = {**AUTH_401}
)
@limiter.limit(settings.RATE_LIMIT_AUTH)
async def login(
    request: Request,
    response: Response,
    db: DBSession,
    ip: ClientIP,
    form_data: Annotated[OAuth2PasswordRequestForm,
                         Depends()],
) -> TokenWithUserResponse:
    """
    Login with email and password
    """
    result, refresh_token = await AuthService.login(
        db,
        email=form_data.username,
        password=form_data.password,
        ip_address=ip,
    )
    set_refresh_cookie(response, refresh_token)
    return result


@router.post(
    "/refresh",
    response_model = TokenResponse,
    responses = {**AUTH_401}
)
async def refresh_token(
    request: Request,
    response: Response,
    db: DBSession,
    ip: ClientIP,
    refresh_token: str | None = Cookie(None),
) -> TokenResponse:
    """
    Refresh access token
    """
    import logging
    logger = logging.getLogger(__name__)
    logger.info(
        f"Refresh endpoint hit - Cookie received: {refresh_token is not None}"
    )
    logger.info(f"All cookies: {request.cookies}")

    if not refresh_token:
        raise TokenError("Refresh token required")
    result, new_refresh_token = await AuthService.refresh_tokens(
        db,
        refresh_token,
        ip_address = ip
    )
    set_refresh_cookie(response, new_refresh_token)
    return result


@router.post(
    "/logout",
    status_code = status.HTTP_204_NO_CONTENT,
    responses = {**AUTH_401}
)
async def logout(
    response: Response,
    db: DBSession,
    refresh_token: str | None = Cookie(None),
) -> None:
    """
    Logout current session
    """
    if not refresh_token:
        raise TokenError("Refresh token required")
    await AuthService.logout(db, refresh_token)
    clear_refresh_cookie(response)


@router.post("/logout-all", responses = {**AUTH_401})
async def logout_all(
    response: Response,
    db: DBSession,
    current_user: CurrentUser,
) -> dict[str,
          int]:
    """
    Logout from all devices
  
```

---

## File Overview

### auth.py

**Purpose and Responsibility:**
This file defines the authentication routes for a FastAPI application, handling user login, token refresh, logout, password change, and retrieving the current authenticated user. It ensures secure and efficient management of user sessions.

**Key Exports or Public Interface:**
- **Login:** `/auth/login` - Logs in users with email and password.
- **Refresh Token:** `/auth/refresh` - Refreshes access tokens using a valid refresh token.
- **Logout:** `/auth/logout` - Invalidates the current session's refresh token.
- **Logout All Devices:** `/auth/logout-all` - Revokes all active sessions for the user.
- **Get Current User:** `/auth/me` - Retrieves details of the currently authenticated user.
- **Change Password:** `/auth/change-password` - Allows users to change their password.

**How It Fits in the Project:**
This file is part of the `aspects/auth/routes` module, which handles authentication-related operations. It interacts with services and dependencies defined in other modules like `core.security.auth`, `aspects.auth.services`, and `core.exceptions`. The routes are secured using rate limiting and custom exceptions to ensure robustness.

**Notable Design Decisions:**
- **Rate Limiting:** Implemented via the `limiter` dependency to prevent abuse.
- **Token Management:** Uses JWT tokens for secure authentication, with refresh tokens to maintain user sessions.
- **Dependency Injection:** Utilizes FastAPI's `Depends` for injecting dependencies like database sessions and client IP addresses.
- **Logging:** Logs relevant information during token operations to aid in debugging and monitoring.
```

This documentation provides a high-level overview of the file’s purpose, key functionality, integration within the project, and significant design choices.

---

*Generated by CodeWorm on 2026-02-22 07:48*
