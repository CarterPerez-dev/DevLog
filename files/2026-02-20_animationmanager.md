# AnimationManager

**Type:** File Overview
**Repository:** angelamos-3d
**File:** frontend/src/lib/animation/AnimationManager.ts
**Language:** typescript
**Lines:** 1-251
**Complexity:** 0.0

---

## Source Code

```typescript
// ===================
// Â© AngelaMos | 2026
// AnimationManager.ts
// ===================

import type { VRM } from "@pixiv/three-vrm";
import * as THREE from "three";
import type { AnimationState } from "./AnimationController";
import { loadMixamoAnimation } from "./loadMixamoAnimation";

const BASE_IDLE = "/animations/idle/Mma Idle.fbx";

const IDLE_ACTIONS = [
	"/animations/idle/Armada.fbx",
	"/animations/idle/Capoeira.fbx",
	"/animations/idle/Chapaeu De Couro.fbx",
	"/animations/idle/Martelo Do Chau.fbx",
	"/animations/idle/Run To Flip.fbx",
	"/animations/idle/Spin Flip Kick.fbx",
];

const SPEAKING_ANIMATIONS = [
	"/animations/speaking/Breakdance 1990.fbx",
	"/animations/speaking/Breakdance Freeze Var 3.fbx",
	"/animations/speaking/Breakdance Freezes.fbx",
	"/animations/speaking/Flair.fbx",
	[
		"/animations/speaking/Headspin Start.fbx",
		"/animations/speaking/Headspin End.fbx",
	],
];

const LISTENING_ANIMATIONS = [
	"/animations/listening-thinking/Bashful.fbx",
	"/animations/listening-thinking/Talking On Phone.fbx",
];

const IDLE_REST_DURATION = 22000;

export class AnimationManager {
	private vrm: VRM;
	private mixer: THREE.AnimationMixer;
	private clips: Map<string, THREE.AnimationClip> = new Map();
	private currentAction: THREE.AnimationAction | null = null;
	private currentState: AnimationState = "idle";
	private isLoaded = false;
	private timeoutId: ReturnType<typeof setTimeout> | null = null;
	private actionQueue: string[] = [];

	constructor(vrm: VRM) {
		this.vrm = vrm;
		this.mixer = new THREE.AnimationMixer(vrm.scene);
	}

	async loadAllAnimations(): Promise<void> {
		console.log("Loading animations...");

		const allPaths = [
			BASE_IDLE,
			...IDLE_ACTIONS,
			...SPEAKING_ANIMATIONS.flat(),
			...LISTENING_ANIMATIONS,
		];

		for (const path of allPaths) {
			try {
				const clip = await loadMixamoAnimation(path, this.vrm);
				this.clips.set(path, clip);
				console.log(`Loaded: ${path}`);
			} catch (err) {
				console.warn(`Failed to load ${path}:`, err);
			}
		}

		this.isLoaded = true;
		console.log("All animations loaded!");
		this.startIdleLoop();
	}

	setState(state: AnimationState): void {
		if (this.currentState === state) return;
		console.log(`AnimationManager: ${this.currentState} -> ${state}`);
		this.currentState = state;

		this.clearSchedule();
		this.actionQueue = [];

		switch (state) {
			case "idle":
				this.startIdleLoop();
				break;
			case "listening":
			case "thinking":
				this.playRandomFrom(LISTENING_ANIMATIONS, true);
				break;
			case "speaking":
				this.startSpeakingLoop();
				break;
			case "error":
				this.playClip(BASE_IDLE);
				break;
		}
	}

	private startIdleLoop(): void {
		if (!this.isLoaded || this.currentState !== "idle") return;
		this.playClip(BASE_IDLE);
		this.timeoutId = setTimeout(() => this.playIdleCombo(), IDLE_REST_DURATION);
	}

	private playIdleCombo(): void {
		if (this.currentState !== "idle") return;

		const comboSize = 1 + Math.floor(Math.random() * 2);
		con
```

---

## File Overview

# AnimationManager.ts Documentation

## Purpose and Responsibility
This TypeScript file manages the loading, scheduling, and playback of animations for a 3D character in a VRM format. It ensures smooth transitions between different states such as idle, speaking, listening, and thinking.

## Key Exports and Public Interface
- **`AnimationManager`:** A class responsible for managing animation states and actions.
  - `loadAllAnimations()`: Asynchronously loads all required animations.
  - `setState(state: AnimationState)`: Sets the current state of the character and triggers appropriate animations.
  
## How It Fits in the Project
This file is a crucial component within the frontend project, specifically handling the animation logic for a VRM model. It integrates with other modules like `AnimationController` and `loadMixamoAnimation`, ensuring that the 3D character's behavior aligns with its state transitions.

## Notable Design Decisions
- **State Management:** The class uses an enum-like `AnimationState` to manage different states (idle, speaking, listening) and triggers corresponding animations.
- **Queue-Based Animation Scheduling:** Utilizes a queue for idle actions to create varied and natural-looking sequences of animations.
- **Error Handling:** Gracefully handles failed animation loads by logging warnings and continuing execution.
- **Async Loading:** Uses `async` functions to load animations asynchronously, ensuring the application remains responsive during loading.

---

*Generated by CodeWorm on 2026-02-20 23:12*
