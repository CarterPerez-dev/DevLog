# manager

**Type:** File Overview
**Repository:** vuemantics
**File:** backend/core/websocket/manager.py
**Language:** python
**Lines:** 1-202
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2026
manager.py
"""

import logging
from collections import defaultdict

from fastapi import WebSocket

from core.websocket.messages import ServerMessage


logger = logging.getLogger(__name__)


class ConnectionManager:
    """
    Manages WebSocket connections and subscriptions

    Handles connection lifecycle and routing messages to subscribers
    Does NOT handle Redis pub/sub (that's in publisher.py)
    """
    def __init__(self) -> None:
        """
        Initialize connection manager
        """
        self.user_connections: dict[str, set[WebSocket]] = defaultdict(set)
        self.upload_subscribers: dict[str, set[str]] = defaultdict(set)
        self.user_subscriptions: dict[str, set[str]] = defaultdict(set)

    async def connect(self, user_id: str, websocket: WebSocket) -> None:
        """
        Register new WebSocket connection

        Args:
            user_id: User's ID
            websocket: WebSocket connection
        """
        self.user_connections[user_id].add(websocket)
        logger.info(
            f"User {user_id} connected "
            f"(total connections: {len(self.user_connections[user_id])})"
        )

    async def disconnect(self, user_id: str, websocket: WebSocket) -> None:
        """
        Unregister WebSocket connection and clean up subscriptions

        Args:
            user_id: User's ID
            websocket: WebSocket connection
        """
        self.user_connections[user_id].discard(websocket)

        if not self.user_connections[user_id]:
            del self.user_connections[user_id]

            # Clean up all subscriptions for this user
            for upload_id in list(self.user_subscriptions.get(user_id,
                                                              [])):
                await self.unsubscribe_upload(user_id, upload_id)

        logger.info(f"User {user_id} disconnected")

    async def subscribe_upload(self, user_id: str, upload_id: str) -> None:
        """
        Subscribe user to upload progress updates

        Args:
            user_id: User's ID
            upload_id: Upload's ID
        """
        self.upload_subscribers[upload_id].add(user_id)
        self.user_subscriptions[user_id].add(upload_id)
        logger.debug(f"User {user_id} subscribed to upload {upload_id}")

    async def unsubscribe_upload(
        self,
        user_id: str,
        upload_id: str
    ) -> None:
        """
        Unsubscribe user from upload updates

        Args:
            user_id: User's ID
            upload_id: Upload's ID
        """
        self.upload_subscribers[upload_id].discard(user_id)
        self.user_subscriptions[user_id].discard(upload_id)

        if not self.upload_subscribers[upload_id]:
            del self.upload_subscribers[upload_id]
        if not self.user_subscriptions[user_id]:
            del self.user_subscriptions[user_id]

    async def send_to_user(
        self,
        user_id: str,
        message: ServerMessage
    
```

---

## File Overview

### manager.py

**Purpose and Responsibility:**
This file manages WebSocket connections and subscriptions for a FastAPI application, ensuring that messages are routed correctly to connected users based on their subscriptions.

**Key Exports and Public Interface:**
- `ConnectionManager`: A class responsible for managing WebSocket connections, subscriptions, and message routing.
  - Methods:
    - `connect(user_id: str, websocket: WebSocket)`: Registers a new WebSocket connection.
    - `disconnect(user_id: str, websocket: WebSocket)`: Unregisters a WebSocket connection and cleans up associated subscriptions.
    - `subscribe_upload(user_id: str, upload_id: str)`: Subscribes a user to upload progress updates.
    - `unsubscribe_upload(user_id: str, upload_id: str)`: Unsubscribes a user from upload progress updates.
    - `send_to_user(user_id: str, message: ServerMessage)`: Sends a message to all connections for a specific user.
    - `send_to_upload_subscribers(upload_id: str, message: ServerMessage)`: Sends a message to all users subscribed to an upload.
    - `get_upload_subscriber_ids(upload_id: str)`: Returns a set of user IDs subscribed to an upload.
    - `disconnect_all()`: Forces the disconnection of all WebSocket connections during application shutdown.

**How it Fits into the Project:**
This class is integral to handling real-time communication in the FastAPI application. It interacts with other components like `publisher.py` for Redis pub/sub operations, ensuring that messages are correctly routed and delivered to the appropriate users based on their subscriptions.

**Notable Design Decisions:**
- **Separation of Concerns**: The manager focuses solely on WebSocket management, while Redis handling is delegated to `publisher.py`, adhering to a clear separation of responsibilities.
- **Efficient Subscription Management**: Utilizes `defaultdict` for efficient storage and retrieval of user connections and subscriptions, ensuring quick lookups and updates.
- **Graceful Disconnection Handling**: Implements robust error handling during disconnections, logging issues and cleaning up dead WebSocket connections to maintain system stability.

---

*Generated by CodeWorm on 2026-02-20 12:52*
