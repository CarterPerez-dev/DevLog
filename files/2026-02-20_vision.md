# vision

**Type:** File Overview
**Repository:** vuemantics
**File:** backend/services/ai/vision.py
**Language:** python
**Lines:** 1-233
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2026
vision.py
"""

import asyncio
import base64
import logging
from pathlib import Path

import aiofiles
from starlette import status
import httpx
from ollama import ResponseError
from tenacity import (
    retry,
    retry_if_exception_type,
    stop_after_attempt,
    wait_exponential,
)

import config
from core import VisionError
from services.ai.manager import OllamaManager
from services.ai._preprocess_vision import preprocess_image_for_vision_model
from services.ai.prompts import (
    IMAGE_ANALYSIS_PROMPT,
    VIDEO_FRAME_PROMPT,
    VIDEO_SYNTHESIS_PROMPT,
)


logger = logging.getLogger(__name__)


class VisionService:
    """
    Handles vision analysis using Qwen2.5-VL
    """
    def __init__(
        self,
        ollama: OllamaManager,
        semaphore: asyncio.Semaphore
    ):
        """
        Initialize vision service

        Args:
            ollama: OllamaManager instance
            semaphore: Semaphore for concurrency control
        """
        self._ollama = ollama
        self._semaphore = semaphore

    @retry(
        retry = retry_if_exception_type(
            (httpx.TimeoutException,
             httpx.ConnectError)
        ),
        stop = stop_after_attempt(3),
        wait = wait_exponential(multiplier = 1,
                                min = 2,
                                max = 30),
    )
    async def analyze_image(self, image_path: Path) -> str:
        """
        Analyze image with Qwen2.5-VL via Ollama.

        Args:
            image_path: Path to image file

        Returns:
            Text description of image content
        """
        try:
            async with self._semaphore:
                # Read image
                async with aiofiles.open(image_path, "rb") as f:
                    image_data = await f.read()

                # Preprocess in executor (non-blocking)
                loop = asyncio.get_event_loop()
                preprocessed_data = await loop.run_in_executor(
                    None,
                    preprocess_image_for_vision_model,
                    image_data
                )

                image_b64 = base64.b64encode(preprocessed_data
                                             ).decode("utf-8")

                client = await self._ollama.get_client()
                response = await client.chat(
                    model = config.settings.vision_model,
                    messages = [
                        {
                            "role": "user",
                            "content": IMAGE_ANALYSIS_PROMPT,
                            "images": [image_b64],
                        }
                    ],
                    options = {
                        "temperature": config.OLLAMA_VISION_TEMPERATURE,
                        "num_predict":
                        config.OLLAMA_VISION_NUM_PREDICT_IMAGE,
                        "num_ctx": config.OLLAMA_VISION_NUM_CTX,
                    },
                )

          
```

---

## File Overview

## vision.py

**Purpose and Responsibility:**
This Python file is responsible for handling image and video analysis using Qwen2.5-VL via the Ollama API. It includes methods to preprocess images, analyze them, and handle concurrency with semaphores.

**Key Exports and Public Interface:**
- `VisionService`: A class that provides methods for analyzing images and video frames.
  - `analyze_image(image_path: Path) -> str`: Analyzes an image file using Qwen2.5-VL.
  - `_analyze_single_frame(frame_path: Path) -> str`: Analyzes a single frame of a video.

**How It Fits in the Project:**
This module is part of the AI services layer, facilitating high-level vision tasks such as image and video analysis. It integrates with other modules like `OllamaManager` for model management and `preprocess_image_for_vision_model` for data preparation.

**Notable Design Decisions:**
- **Concurrency Control**: Uses an asyncio semaphore to manage concurrent requests.
- **Error Handling**: Implements retry logic using tenacity for transient errors, ensuring robustness.
- **Dependency Injection**: Accepts `OllamaManager` and a semaphore in the constructor, promoting flexibility and testability.
```

This documentation provides a high-level overview of the file's purpose, key components, integration within the project, and significant design choices.

---

*Generated by CodeWorm on 2026-02-20 13:07*
