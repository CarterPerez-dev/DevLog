# document

**Type:** File Overview
**Repository:** angelamos-operations
**File:** CarterBot-Telegram/src/handlers/document.ts
**Language:** typescript
**Lines:** 1-215
**Complexity:** 0.0

---

## Source Code

```typescript
/**
 * CarterOS Telegram Bot - Document Handler
 *
 * Handles PDFs and text files with media group support.
 */

import type { Context } from "grammy";
import { session } from "../session";
import { ALLOWED_USERS, TEMP_DIR } from "../config";
import { isAuthorized, startTypingIndicator } from "../utils";
import { StreamingState, createStatusCallback } from "./streaming";
import { createMediaGroupBuffer, handleProcessingError } from "./media-group";

const TEXT_EXTENSIONS = [
  ".md", ".txt", ".json", ".yaml", ".yml", ".csv", ".xml",
  ".html", ".css", ".js", ".ts", ".py", ".sh", ".env",
  ".log", ".cfg", ".ini", ".toml",
];

const MAX_FILE_SIZE = 10 * 1024 * 1024;

const documentBuffer = createMediaGroupBuffer({
  itemLabel: "document",
  itemLabelPlural: "documents",
});

async function downloadDocument(ctx: Context): Promise<string> {
  const doc = ctx.message?.document;
  if (!doc) {
    throw new Error("No document in message");
  }

  const file = await ctx.getFile();
  const fileName = doc.file_name || `doc_${Date.now()}`;
  const safeName = fileName.replace(/[^a-zA-Z0-9._-]/g, "_");
  const docPath = `${TEMP_DIR}/${safeName}`;

  const response = await fetch(
    `https://api.telegram.org/file/bot${ctx.api.token}/${file.file_path}`
  );
  const buffer = await response.arrayBuffer();
  await Bun.write(docPath, buffer);

  return docPath;
}

async function extractText(filePath: string, mimeType?: string): Promise<string> {
  const fileName = filePath.split("/").pop() || "";
  const extension = "." + (fileName.split(".").pop() || "").toLowerCase();

  if (mimeType === "application/pdf" || extension === ".pdf") {
    try {
      const result = await Bun.$`pdftotext -layout ${filePath} -`.quiet();
      return result.text();
    } catch (error) {
      console.error("PDF parsing failed:", error);
      return "[PDF parsing failed - ensure pdftotext is installed]";
    }
  }

  if (TEXT_EXTENSIONS.includes(extension) || mimeType?.startsWith("text/")) {
    const text = await Bun.file(filePath).text();
    return text.slice(0, 100000);
  }

  throw new Error(`Unsupported file type: ${extension || mimeType}`);
}

async function processDocuments(
  ctx: Context,
  documents: Array<{ path: string; name: string; content: string }>,
  caption: string | undefined,
  userId: number,
  username: string,
  chatId: number
): Promise<void> {
  const stopProcessing = session.startProcessing();

  let prompt: string;
  if (documents.length === 1) {
    const doc = documents[0]!;
    prompt = caption
      ? `Document: ${doc.name}\n\nContent:\n${doc.content}\n\n---\n\n${caption}`
      : `Please analyze this document (${doc.name}):\n\n${doc.content}`;
  } else {
    const docList = documents
      .map((d, i) => `--- Document ${i + 1}: ${d.name} ---\n${d.content}`)
      .join("\n\n");
    prompt = caption
      ? `${documents.length} Documents:\n\n${docList}\n\n---\n\n${caption}`
      : `Please analyze these ${documents.length} documents:\n\n${docList}`;
  }
```

---

## File Overview

### Document Handler for CarterOS Telegram Bot

**Purpose:**
This file handles PDFs and text files, including media group support. It ensures that only authorized users can upload documents and processes them based on their type and content.

**Key Exports:**
- `handleDocument`: The main entry point for handling document uploads.
- `processDocuments`: Processes an array of documents with optional captions.
- `processDocumentPaths`: Processes multiple document paths, extracts text, and handles errors.

**Project Integration:**
This file is part of the CarterOS Telegram Bot's handler system. It interacts with other modules like session management, media group handling, and utility functions to ensure seamless document processing. The `documentBuffer` and `createMediaGroupBuffer` help manage media groups efficiently.

**Design Decisions:**
- **Authorization:** Uses `isAuthorized` to check if the user is allowed to upload documents.
- **File Size Limitation:** Enforces a maximum file size of 10MB using `MAX_FILE_SIZE`.
- **Text Extraction:** Supports various text and PDF files, with pdftotext for PDFs and direct text extraction for other formats.
- **Error Handling:** Uses `handleProcessingError` to manage errors gracefully during document processing.

This file ensures robust handling of documents while maintaining a clear separation between different functionalities within the bot's architecture.

---

*Generated by CodeWorm on 2026-02-19 19:02*
