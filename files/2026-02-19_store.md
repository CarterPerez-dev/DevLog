# store

**Type:** File Overview
**Repository:** angelamos-operations
**File:** Docker-Kentros/internal/store/store.go
**Language:** go
**Lines:** 1-164
**Complexity:** 0.0

---

## Source Code

```go
/*
AngelaMos | 2026
store.go
*/

package store

import (
	"database/sql"
	"fmt"
	"os"
	"path/filepath"
	"sync"

	_ "modernc.org/sqlite"
)

type Store struct {
	db *sql.DB
	mu sync.RWMutex
}

type ProjectPreference struct {
	ProjectID   string
	DisplayName string
	Hidden      bool
}

func New(dataDir string) (*Store, error) {
	if err := os.MkdirAll(dataDir, 0755); err != nil {
		return nil, fmt.Errorf("creating data directory: %w", err)
	}

	dbPath := filepath.Join(dataDir, "holophyly.db")
	db, err := sql.Open("sqlite", dbPath)
	if err != nil {
		return nil, fmt.Errorf("opening database: %w", err)
	}

	store := &Store{db: db}

	if err := store.migrate(); err != nil {
		db.Close()
		return nil, fmt.Errorf("migrating database: %w", err)
	}

	return store, nil
}

func (s *Store) Close() error {
	return s.db.Close()
}

func (s *Store) migrate() error {
	schema := `
		CREATE TABLE IF NOT EXISTS project_preferences (
			project_id TEXT PRIMARY KEY,
			display_name TEXT,
			hidden INTEGER DEFAULT 0
		);
	`

	_, err := s.db.Exec(schema)
	return err
}

func (s *Store) GetPreference(projectID string) (*ProjectPreference, error) {
	s.mu.RLock()
	defer s.mu.RUnlock()

	var pref ProjectPreference
	var displayName sql.NullString
	var hidden int

	err := s.db.QueryRow(
		"SELECT project_id, display_name, hidden FROM project_preferences WHERE project_id = ?",
		projectID,
	).Scan(&pref.ProjectID, &displayName, &hidden)

	if err == sql.ErrNoRows {
		return nil, nil
	}
	if err != nil {
		return nil, err
	}

	pref.DisplayName = displayName.String
	pref.Hidden = hidden == 1

	return &pref, nil
}

func (s *Store) GetAllPreferences() (map[string]*ProjectPreference, error) {
	s.mu.RLock()
	defer s.mu.RUnlock()

	rows, err := s.db.Query("SELECT project_id, display_name, hidden FROM project_preferences")
	if err != nil {
		return nil, err
	}
	defer rows.Close()

	prefs := make(map[string]*ProjectPreference)
	for rows.Next() {
		var pref ProjectPreference
		var displayName sql.NullString
		var hidden int

		if err := rows.Scan(&pref.ProjectID, &displayName, &hidden); err != nil {
			return nil, err
		}

		pref.DisplayName = displayName.String
		pref.Hidden = hidden == 1
		prefs[pref.ProjectID] = &pref
	}

	return prefs, rows.Err()
}

func (s *Store) SetDisplayName(projectID, displayName string) error {
	s.mu.Lock()
	defer s.mu.Unlock()

	var nullName sql.NullString
	if displayName != "" {
		nullName = sql.NullString{String: displayName, Valid: true}
	}

	_, err := s.db.Exec(`
		INSERT INTO project_preferences (project_id, display_name, hidden)
		VALUES (?, ?, 0)
		ON CONFLICT(project_id) DO UPDATE SET display_name = excluded.display_name
	`, projectID, nullName)

	return err
}

func (s *Store) SetHidden(projectID string, hidden bool) error {
	s.mu.Lock()
	defer s.mu.Unlock()

	hiddenInt := 0
	if hidden {
		hiddenInt = 1
	}

	_, err := s.db.Exec(`
		INSERT INTO project_preferences (project_id, display_name, hidden)
		VALUES (?, NULL, ?)
		ON CONFLICT(project_id) DO UPDATE S
```

---

## File Overview

### Purpose and Responsibility

This `store.go` file is responsible for managing persistent storage of project preferences within a SQLite database. It provides an abstraction layer to interact with the database, ensuring thread safety through mutexes.

### Key Exports and Public Interface

- **New(dataDir string) (*Store, error)**: Initializes a new store instance by creating or opening a SQLite database in the specified directory.
- **Close() error**: Closes the underlying database connection.
- **migrate() error**: Ensures that the necessary schema for storing project preferences is present.
- **GetPreference(projectID string) (*ProjectPreference, error)**: Retrieves a specific project preference by its ID.
- **GetAllPreferences() (map[string]*ProjectPreference, error)**: Fetches all stored project preferences.
- **SetDisplayName(projectID, displayName string) error**: Updates or inserts the display name for a given project.
- **SetHidden(projectID string, hidden bool) error**: Updates or inserts the hidden status for a given project.
- **DeletePreference(projectID string) error**: Deletes a project preference by its ID.

### How It Fits into the Project

This file serves as a central hub for database operations within the `angelamos-operations` project. It is imported and used by other components to manage persistent state, ensuring that preferences are stored reliably across sessions.

### Notable Design Decisions

1. **Mutexes**: The use of `sync.RWMutex` ensures thread safety when accessing or modifying the database.
2. **Error Handling**: Errors are properly propagated using standard Go idioms for error handling.
3. **Database Schema Management**: A simple schema migration is implemented to ensure that the necessary tables and columns are present upon initialization.
4. **SQL Transaction Safety**: Operations like `SetDisplayName` and `SetHidden` use mutexes to lock during database writes, preventing concurrent modifications.

---

*Generated by CodeWorm on 2026-02-19 19:46*
