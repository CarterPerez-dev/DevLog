# compose

**Type:** File Overview
**Repository:** docksec
**File:** internal/parser/compose.go
**Language:** go
**Lines:** 1-812
**Complexity:** 0.0

---

## Source Code

```go
/*
CarterPerez-dev | 2025
compose.go
*/

package parser

import (
	"fmt"
	"os"
	"strconv"
	"strings"

	"gopkg.in/yaml.v3"
)

type ComposeFile struct {
	Path     string
	Root     *yaml.Node
	Version  string
	Services map[string]*Service
	Networks map[string]*Network
	Volumes  map[string]*Volume
	Secrets  map[string]*Secret
	Configs  map[string]*Config
}

type Service struct {
	Name        string
	Node        *yaml.Node
	Line        int
	Image       string
	Build       *BuildConfig
	Ports       []PortMapping
	Volumes     []VolumeMount
	Environment map[string]EnvVar
	CapAdd      []string
	CapDrop     []string
	Privileged  bool
	ReadOnly    bool
	User        string
	NetworkMode string
	PidMode     string
	IpcMode     string
	SecurityOpt []string
	Deploy      *DeployConfig
	DependsOn   []string
	Healthcheck *HealthcheckConfig
}

type BuildConfig struct {
	Context    string
	Dockerfile string
	Args       map[string]string
	Target     string
	Line       int
}

type PortMapping struct {
	HostIP        string
	HostPort      string
	ContainerPort string
	Protocol      string
	Line          int
}

type VolumeMount struct {
	Source   string
	Target   string
	Type     string
	ReadOnly bool
	Line     int
}

type EnvVar struct {
	Name  string
	Value string
	Line  int
}

type DeployConfig struct {
	Replicas  int
	Resources *ResourceConfig
	Line      int
}

type ResourceConfig struct {
	Limits       *ResourceLimits
	Reservations *ResourceLimits
}

type ResourceLimits struct {
	CPUs   string
	Memory string
	Pids   int
}

type HealthcheckConfig struct {
	Test        []string
	Interval    string
	Timeout     string
	Retries     int
	StartPeriod string
	Disable     bool
	Line        int
}

type Network struct {
	Name     string
	Driver   string
	External bool
	Line     int
}

type Volume struct {
	Name     string
	Driver   string
	External bool
	Line     int
}

type Secret struct {
	Name     string
	File     string
	External bool
	Line     int
}

type Config struct {
	Name     string
	File     string
	External bool
	Line     int
}

func ParseComposeFile(path string) (*ComposeFile, error) {
	data, err := os.ReadFile(path)
	if err != nil {
		return nil, fmt.Errorf("reading compose file: %w", err)
	}

	return ParseComposeBytes(path, data)
}

func ParseComposeBytes(path string, data []byte) (*ComposeFile, error) {
	var root yaml.Node
	if err := yaml.Unmarshal(data, &root); err != nil {
		return nil, fmt.Errorf("parsing yaml: %w", err)
	}

	cf := &ComposeFile{
		Path:     path,
		Root:     &root,
		Services: make(map[string]*Service),
		Networks: make(map[string]*Network),
		Volumes:  make(map[string]*Volume),
		Secrets:  make(map[string]*Secret),
		Configs:  make(map[string]*Config),
	}

	cf.extract()

	return cf, nil
}

func (cf *ComposeFile) extract() {
	if cf.Root.Kind == yaml.DocumentNode && len(cf.Root.Content) > 0 {
		cf.extractFromMapping(cf.Root.Content[0])
	} else if cf.Root.Kind == yaml.MappingNode {
		cf.extractFromMapping(cf.Root)
	}
}

func (cf *ComposeFile)
```

---

## File Overview

### compose.go

**Purpose and Responsibility:**
This file is responsible for parsing Docker Compose files, extracting their configuration details, and organizing them into a structured data model. It handles the reading of YAML files, parsing services, networks, volumes, secrets, and configs.

**Key Exports or Public Interface:**
- `ParseComposeFile(path string) (*ComposeFile, error)`: The primary public function that reads and parses a Docker Compose file.
- `ParseComposeBytes(path string, data []byte) (*ComposeFile, error)`: A helper function to parse a Docker Compose file from byte data.

**How It Fits in the Project:**
This file is part of the `parser` package within the `docksec` project. The parsed `ComposeFile` object serves as an intermediate representation that can be further processed or used by other components of the application, such as deployment managers or configuration validators.

**Notable Design Decisions:**
- **Error Handling:** Errors are returned using standard Go error handling mechanisms to ensure robustness.
- **YAML Parsing:** Utilizes `gopkg.in/yaml.v3` for parsing YAML files, ensuring flexibility and ease of use.
- **Structured Data Model:** The `ComposeFile`, `Service`, `BuildConfig`, etc., structs provide a clear and organized representation of the Docker Compose configuration.
- **Line Numbers:** Preserving line numbers in parsed nodes helps with debugging and error reporting by linking issues directly to the source file.

---

*Generated by CodeWorm on 2026-02-20 19:40*
