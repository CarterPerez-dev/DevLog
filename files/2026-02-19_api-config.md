# api.config

**Type:** File Overview
**Repository:** fullstack-template
**File:** frontends/react-native-ios/src/core/api/api.config.ts
**Language:** typescript
**Lines:** 1-200
**Complexity:** 0.0

---

## Source Code

```typescript
// ===================
// Â© AngelaMos | 2026
// api.config.ts
// ===================

import axios, {
  type AxiosError,
  type AxiosInstance,
  type InternalAxiosRequestConfig,
} from 'axios'
import { API_ENDPOINTS, APP_CONFIG, HTTP_STATUS } from '@/core/config'
import { SECURE_KEYS, secureStorage } from '@/core/storage'
import { ApiError, ApiErrorCode, transformAxiosError } from './errors'

interface RequestConfig extends InternalAxiosRequestConfig {
  _retry?: boolean
}

interface RefreshSubscriber {
  resolve: (token: string) => void
  reject: (error: Error) => void
}

interface RefreshResponse {
  access_token: string
  refresh_token: string
}

const getBaseURL = (): string => {
  if (__DEV__) {
    return `http://${APP_CONFIG.DEV_IP}:${APP_CONFIG.DEV_PORT}`
  }
  return APP_CONFIG.PROD_API_URL
}

export const apiClient: AxiosInstance = axios.create({
  baseURL: getBaseURL(),
  timeout: 15000,
  headers: { 'Content-Type': 'application/json' },
})

let isRefreshing = false
let refreshSubscribers: RefreshSubscriber[] = []
let accessToken: string | null = null

export const setAccessToken = (token: string | null): void => {
  accessToken = token
}

export const getAccessToken = (): string | null => {
  return accessToken
}

const processRefreshQueue = (error: Error | null, token: string | null): void => {
  refreshSubscribers.forEach((subscriber) => {
    if (error !== null) {
      subscriber.reject(error)
    } else if (token !== null) {
      subscriber.resolve(token)
    }
  })
  refreshSubscribers = []
}

const addRefreshSubscriber = (
  resolve: (token: string) => void,
  reject: (error: Error) => void
): void => {
  refreshSubscribers.push({ resolve, reject })
}

const handleTokenRefresh = async (): Promise<RefreshResponse> => {
  const refreshToken = await secureStorage.getItem(SECURE_KEYS.REFRESH_TOKEN)

  if (!refreshToken) {
    throw new ApiError(
      'No refresh token',
      ApiErrorCode.AUTHENTICATION_ERROR,
      HTTP_STATUS.UNAUTHORIZED
    )
  }

  const response = await apiClient.post<RefreshResponse>(
    API_ENDPOINTS.AUTH.REFRESH_MOBILE,
    { refresh_token: refreshToken }
  )

  if (
    response.data === null ||
    response.data === undefined ||
    typeof response.data !== 'object'
  ) {
    throw new ApiError(
      'Invalid refresh response',
      ApiErrorCode.AUTHENTICATION_ERROR,
      HTTP_STATUS.UNAUTHORIZED
    )
  }

  const { access_token, refresh_token: newRefreshToken } = response.data

  if (typeof access_token !== 'string' || access_token.length === 0) {
    throw new ApiError(
      'Invalid access token',
      ApiErrorCode.AUTHENTICATION_ERROR,
      HTTP_STATUS.UNAUTHORIZED
    )
  }

  await secureStorage.setItem(SECURE_KEYS.REFRESH_TOKEN, newRefreshToken)

  return response.data
}

let onAuthFailure: (() => void) | null = null

export const setAuthFailureHandler = (handler: () => void): void => {
  onAuthFailure = handler
}

const handleAuthFailure = async (): Promise<void> => {
  await secureStor
```

---

## File Overview

# api.config.ts

**Purpose & Responsibility:**
This file configures and manages the Axios instance for API requests, handling authentication, token refreshes, and error management. It ensures secure access tokens are used and provides a robust mechanism to handle unauthorized access.

**Key Exports & Public Interface:**
- `apiClient`: The configured Axios instance.
- `setAccessToken`: Sets the current access token.
- `getAccessToken`: Retrieves the current access token.
- `handleTokenRefresh`: Refreshes the access token when necessary.
- `setAuthFailureHandler`: Sets a handler for authentication failures.

**How It Fits in the Project:**
This file is crucial for managing API interactions across the application. It integrates with other core modules like storage and configuration to ensure secure and reliable API calls. The Axios instance is used throughout the project, making this file a central point for handling HTTP requests.

**Notable Design Decisions:**
- **Token Management:** Implements token refresh logic using a queue system to handle concurrent refresh attempts.
- **Error Handling:** Uses interceptors to manage request and response errors, including retry mechanisms for unauthorized access.
- **Configuration Flexibility:** Supports both development and production configurations through environment-specific settings.
```

This documentation provides an overview of the file's purpose, key exports, integration within the project, and significant design choices.

---

*Generated by CodeWorm on 2026-02-19 16:26*
