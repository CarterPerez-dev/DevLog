# env

**Type:** File Overview
**Repository:** angelamos-operations
**File:** CarterOS-Server/alembic/env.py
**Language:** python
**Lines:** 1-142
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2026
env.py
"""
import asyncio
from logging.config import fileConfig

from alembic import context
from sqlalchemy import pool
from sqlalchemy.engine import Connection
from sqlalchemy.ext.asyncio import async_engine_from_config

from config import settings
from core.infrastructure.database.Base import Base
from core.enums import SafeEnum

from aspects.auth.models.User import User  # noqa: F401
from aspects.auth.models.RefreshToken import RefreshToken  # noqa: F401
from core.foundation.models.identity import (  # noqa: F401
    CoreIdentity,
    IdentitySkill,
    IdentityInterest,
    IdentityCertification,
    IdentityStrength,
    IdentityWeakness,
    BrandVoice,
    BrandVoiceAvoid,
    PlatformGoal,
    RevenueGoal,
    ContentPillar,
    ContentPreference,
)
from aspects.challenge.facets.tracker.models import Challenge, ChallengeLog  # noqa: F401
from aspects.life_manager.facets.planner.models import TimeBlock  # noqa: F401
from aspects.life_manager.facets.notes.models import NoteFolder, Note  # noqa: F401
from aspects.life_manager.facets.career.job_app_tracker.models import (  # noqa: F401
    JobApplication,
)
from aspects.life_manager.facets.checklist.models import ChecklistItem, ChecklistLog  # noqa: F401
from aspects.analytics.facets.data_input.models import TikTokVideo  # noqa: F401


config = context.config


def render_item(type_, obj, autogen_context):
    """
    Custom renderer for alembic autogenerate.
    Converts SafeEnum to standard sa.Enum and ensures DateTime uses timezone.
    """
    import sqlalchemy as sa

    if isinstance(obj, SafeEnum):
        enum_class = obj.enum_class
        values = [e.value for e in enum_class]
        return f"sa.Enum({', '.join(repr(v) for v in values)}, name='{obj.name}')"

    if isinstance(obj, sa.DateTime):
        return "sa.DateTime(timezone=True)"

    return False


if config.config_file_name is not None:
    fileConfig(config.config_file_name)

target_metadata = Base.metadata


def get_url() -> str:
    """
    Get database URL from settings
    """
    return str(settings.DATABASE_URL)


def run_migrations_offline() -> None:
    """
    Run migrations in 'offline' mode
    """
    url = get_url()
    context.configure(
        url = url,
        target_metadata = target_metadata,
        literal_binds = True,
        dialect_opts = {"paramstyle": "named"},
        compare_type = True,
        compare_server_default = True,
        render_item = render_item,
    )

    with context.begin_transaction():
        context.run_migrations()


def do_run_migrations(connection: Connection) -> None:
    """
    Run migrations with connection
    """
    context.configure(
        connection = connection,
        target_metadata = target_metadata,
        compare_type = True,
        compare_server_default = True,
        render_item = render_item,
    )

    with context.begin_transaction():
        context.run_migrations()


async def run_async_migrations() -> None:
    """

```

---

## File Overview

### Purpose and Responsibility

This file, `env.py`, is responsible for configuring and running database migrations using Alembic. It sets up the environment for both offline and online migration modes, ensuring that all models defined across various modules are properly tracked and migrated.

### Key Exports and Public Interface

- **`run_migrations_offline()`**: Runs migrations in 'offline' mode without a database connection.
- **`run_migrations_online()`**: Runs migrations in 'online' mode with an active database connection.
- **`do_run_migrations(connection: Connection)`**: A helper function to run migrations using a provided database connection.

### How It Fits into the Project

This file is crucial for maintaining and evolving the database schema of CarterOS-Server. It integrates with Alembic, a popular database migration tool, allowing for version-controlled changes to the database schema. The file ensures that all models from different aspects (auth, challenge, life manager, analytics) are included in the migrations.

### Notable Design Decisions

1. **Custom Renderer (`render_item`)**: A custom renderer is used to handle SafeEnum types and ensure DateTime fields use timezone-aware timestamps.
2. **Configuration Handling**: The file dynamically loads configuration from settings and uses Alembic's `fileConfig` for logging, ensuring that the migration process is well-documented.
3. **Async Support**: Async support is provided via `run_async_migrations`, allowing for non-blocking database operations during migrations.

This setup ensures that the project can manage schema changes efficiently while maintaining a clean and maintainable codebase.

---

*Generated by CodeWorm on 2026-02-22 07:59*
