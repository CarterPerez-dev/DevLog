# dependencies

**Type:** File Overview
**Repository:** vuemantics
**File:** backend/auth/dependencies.py
**Language:** python
**Lines:** 1-126
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2026
dependencies.py
"""

import asyncio
import contextlib
import logging
from uuid import UUID

from fastapi import Depends, WebSocket
from starlette.websockets import WebSocketDisconnect

from auth import get_current_user
from auth.jwt_auth import decode_token, TokenType
from core import NotFoundError, AuthenticationError
from core.websocket.messages import AuthSuccess, AuthError
from models.Upload import Upload
from models.User import User
import config


logger = logging.getLogger(__name__)


async def verify_upload_ownership(
    upload_id: UUID,
    current_user: User = Depends(get_current_user),
) -> Upload:
    """
    Verify user owns the upload and return it
    """
    upload = await Upload.find_by_id(upload_id)

    if not upload or upload.user_id != current_user.id:
        raise NotFoundError("Upload not found")

    return upload


async def authenticate_websocket(websocket: WebSocket) -> str | None:
    """
    Authenticate WebSocket connection via first message pattern

    Returns:
        User ID if authentication successful, None otherwise
    """
    origin = websocket.headers.get("origin", "")
    if origin and origin not in config.settings.cors_origins:
        logger.warning(f"WebSocket from unauthorized origin: {origin}")
        return None

    await websocket.accept()

    try:
        auth_data = await asyncio.wait_for(
            websocket.receive_json(),
            timeout = config.WEBSOCKET_AUTH_TIMEOUT
        )
    except TimeoutError:
        await websocket.send_json(
            AuthError(message = "Authentication timeout").model_dump()
        )
        await websocket.close(
            code = config.WEBSOCKET_CLOSE_AUTH_TIMEOUT,
            reason = "Authentication timeout"
        )
        return None
    except WebSocketDisconnect:
        logger.debug(
            "WebSocket disconnected before auth (likely React StrictMode)"
        )
        return None
    except Exception as e:
        logger.error(f"Error receiving auth message: {e}")
        with contextlib.suppress(RuntimeError):
            await websocket.close(
                code = config.WEBSOCKET_CLOSE_INVALID_MESSAGE,
                reason = "Invalid message format"
            )
        return None

    if auth_data.get("type") != "auth" or not auth_data.get("token"):
        await websocket.send_json(
            AuthError(message = "Authentication required").model_dump()
        )
        await websocket.close(
            code = config.WEBSOCKET_CLOSE_AUTH_REQUIRED,
            reason = "Authentication required"
        )
        return None

    try:
        payload = decode_token(
            auth_data["token"],
            expected_type = TokenType.ACCESS
        )

        user_id_raw = payload.get("sub")
        if not user_id_raw:
            raise AuthenticationError("Missing user ID in token")

        user_id: str = str(user_id_raw)
        user = await User.find_by_id(UUID(user_id))
        if not user or
```

---

## File Overview

### dependencies.py

**Purpose and Responsibility:**
This Python file contains dependency functions for authentication and WebSocket handling in a FastAPI application. It ensures that users are authenticated before accessing certain resources, particularly uploads, and handles WebSocket connections securely.

**Key Exports and Public Interface:**
- `verify_upload_ownership`: Verifies the user owns an upload.
- `authenticate_websocket`: Authenticates WebSocket connections using JWT tokens.

**How it Fits into the Project:**
This file is crucial for maintaining security and proper access control. It integrates with other modules like `auth`, `models`, and `config` to provide a secure environment for handling uploads and WebSocket communications. The functions are used throughout the application, particularly in routes that require user authentication.

**Notable Design Decisions:**
- **JWT Token Verification**: Uses `decode_token` from `jwt_auth` to validate JWT tokens.
- **WebSocket Authentication**: Implements a timeout mechanism to prevent indefinite waits for authentication messages and handles various error cases gracefully.
- **Dependency Injection**: Utilizes FastAPI's `Depends` to inject the current user into functions, ensuring that every function requiring authentication has access to the authenticated user object.
- **Error Handling**: Comprehensive error handling ensures that any issues during authentication or WebSocket communication are logged and handled appropriately, maintaining application stability.
```

This documentation provides a high-level overview of the file's purpose, key components, integration within the project, and notable design choices.

---

*Generated by CodeWorm on 2026-02-20 14:19*
