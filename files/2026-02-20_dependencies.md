# dependencies

**Type:** File Overview
**Repository:** my-portfolio
**File:** v1/backend/app/core/dependencies.py
**Language:** python
**Lines:** 1-159
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025
dependencies.py
"""

from __future__ import annotations

from typing import Annotated
from uuid import UUID

import jwt
from fastapi import Depends, Request
from fastapi.security import OAuth2PasswordBearer
from sqlalchemy.ext.asyncio import AsyncSession

import config
from config import (
    TokenType,
    UserRole,
)
from .database import get_db_session
from .exceptions import (
    InactiveUser,
    PermissionDenied,
    TokenError,
    TokenRevokedError,
    UserNotFound,
)
from user.User import User
from .security import decode_access_token
from user.repository import UserRepository


oauth2_scheme = OAuth2PasswordBearer(
    tokenUrl = f"{config.API_PREFIX}/auth/login",
    auto_error = True,
)

oauth2_scheme_optional = OAuth2PasswordBearer(
    tokenUrl = f"{config.API_PREFIX}/auth/login",
    auto_error = False,
)

DBSession = Annotated[AsyncSession, Depends(get_db_session)]


async def get_current_user(
    token: Annotated[str,
                     Depends(oauth2_scheme)],
    db: DBSession,
) -> User:
    """
    Validate access token and return current user
    """
    try:
        payload = decode_access_token(token)
    except jwt.InvalidTokenError as e:
        raise TokenError(message = str(e)) from e

    if payload.get("type") != TokenType.ACCESS.value:
        raise TokenError(message = "Invalid token type")

    user_id = UUID(payload["sub"])
    user = await UserRepository.get_by_id(db, user_id)

    if user is None:
        raise UserNotFound(identifier = str(user_id))

    if payload.get("token_version") != user.token_version:
        raise TokenRevokedError()

    return user


async def get_current_active_user(
    user: Annotated[User,
                    Depends(get_current_user)],
) -> User:
    """
    Ensure user is active
    """
    if not user.is_active:
        raise InactiveUser()
    return user


async def get_optional_user(
    token: Annotated[str | None,
                     Depends(oauth2_scheme_optional)],
    db: DBSession,
) -> User | None:
    """
    Return current user if authenticated, None otherwise
    """
    if token is None:
        return None

    try:
        payload = decode_access_token(token)
        if payload.get("type") != TokenType.ACCESS.value:
            return None
        user_id = UUID(payload["sub"])
        user = await UserRepository.get_by_id(db, user_id)
        if user and user.token_version == payload.get("token_version"):
            return user
    except (jwt.InvalidTokenError, ValueError):
        pass

    return None


class RequireRole:
    """
    Dependency class to check user role
    """
    def __init__(self, *allowed_roles: UserRole) -> None:
        self.allowed_roles = allowed_roles

    async def __call__(
        self,
        user: Annotated[User,
                        Depends(get_current_active_user)],
    ) -> User:
        if user.role not in self.allowed_roles:
            raise PermissionDenied(
                message =
   
```

---

## File Overview

**dependencies.py**

This Python source file is responsible for defining key dependencies and utilities used throughout the application, primarily focusing on user authentication, authorization, and context management.

### Key Exports and Public Interface

- **User Authentication:**
  - `get_current_user`: Validates an access token and returns the current authenticated user.
  - `get_current_active_user`: Ensures the user is active before returning them.
  - `get_optional_user`: Returns the current user if authenticated, or `None` otherwise.

- **Authorization:**
  - `RequireRole`: A dependency class to enforce specific roles for certain routes.

- **Context Management:**
  - `ClientIP`: Extracts and provides the client's IP address.
  - `QueryLanguage`: Provides the query language preference (defaulting to English).

### How It Fits into the Project

This file serves as a central hub for dependency injection, ensuring that authentication and authorization checks are consistent across the application. The `get_current_user` function is crucial for protected routes, while `RequireRole` enforces role-based access control.

### Notable Design Decisions

- **JWT Token Handling:** Utilizes `jwt` to validate tokens, ensuring secure and stateless authentication.
- **Dependency Injection:** Uses `Depends` from FastAPI to manage dependencies, promoting clean and modular code.
- **Contextual Information:** Provides context such as the client's IP address and preferred language, enhancing usability and logging.

This file is integral for maintaining security and consistency in user interactions within the application.

---

*Generated by CodeWorm on 2026-02-20 07:14*
