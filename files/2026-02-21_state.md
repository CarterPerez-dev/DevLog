# state

**Type:** File Overview
**Repository:** CodeWorm
**File:** codeworm/core/state.py
**Language:** python
**Lines:** 1-256
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2026
state.py
"""
import hashlib
import sqlite3
import uuid
from datetime import datetime, timedelta
from pathlib import Path

from codeworm.models import CodeSnippet, DocType, DocumentedSnippet


SCHEMA = """
CREATE TABLE IF NOT EXISTS documented_snippets (
    id TEXT PRIMARY KEY,
    source_repo TEXT NOT NULL,
    source_file TEXT NOT NULL,
    function_name TEXT,
    class_name TEXT,
    code_hash TEXT NOT NULL,
    documented_at TIMESTAMP NOT NULL,
    snippet_path TEXT NOT NULL,
    git_commit TEXT,
    doc_type TEXT NOT NULL DEFAULT 'function_doc'
);

CREATE INDEX IF NOT EXISTS idx_code_hash ON documented_snippets(code_hash);
CREATE INDEX IF NOT EXISTS idx_source ON documented_snippets(source_repo, source_file);
CREATE INDEX IF NOT EXISTS idx_function ON documented_snippets(source_file, function_name);
"""


class StateManager:
    """
    Manages persistent state in SQLite
    This is the daemon's memory - tracks what has been documented
    """
    def __init__(self, db_path: Path) -> None:
        """
        Initialize state manager with database path
        """
        self.db_path = db_path
        self.db_path.parent.mkdir(parents = True, exist_ok = True)
        self._init_db()

    def _init_db(self) -> None:
        """
        Initialize database schema and run migrations
        """
        with sqlite3.connect(self.db_path) as conn:
            conn.executescript(SCHEMA)
            self._migrate_add_doc_type(conn)
            conn.commit()

    def _migrate_add_doc_type(self, conn: sqlite3.Connection) -> None:
        """
        Add doc_type column if it does not exist
        """
        cursor = conn.execute("PRAGMA table_info(documented_snippets)")
        columns = {row[1] for row in cursor.fetchall()}
        if "doc_type" not in columns:
            conn.execute(
                "ALTER TABLE documented_snippets "
                "ADD COLUMN doc_type TEXT NOT NULL DEFAULT 'function_doc'"
            )
            conn.execute(
                "CREATE INDEX IF NOT EXISTS idx_dedup "
                "ON documented_snippets(source_file, function_name, class_name, doc_type)"
            )
            conn.execute(
                "CREATE INDEX IF NOT EXISTS idx_doc_type "
                "ON documented_snippets(doc_type)"
            )

    def _get_conn(self) -> sqlite3.Connection:
        """
        Get a database connection with row factory
        """
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row
        return conn

    @staticmethod
    def hash_code(source: str) -> str:
        """
        Generate SHA256 hash of source code for deduplication
        """
        return hashlib.sha256(source.encode("utf-8")).hexdigest()

    def is_documented(self, snippet: CodeSnippet) -> bool:
        """
        Check if this exact code has already been documented
        """
        code_hash = self.hash_code(snippet.source)
        with self._get_conn() as conn:
           
```

---

## File Overview

### state.py

**Purpose and Responsibility:**
This Python file manages persistent state for CodeWorm, a tool that documents code snippets. It initializes and maintains an SQLite database to track documented snippets, ensuring no duplicate documentation is performed on identical code.

**Key Exports/Public Interface:**
- `StateManager`: A class responsible for managing the state in the SQLite database.
  - Methods:
    - `_init_db()`: Initializes or migrates the database schema.
    - `_migrate_add_doc_type(conn)`: Adds a `doc_type` column if it does not exist.
    - `_get_conn()`: Returns a connection to the database with row factory enabled.
    - `hash_code(source: str) -> str`: Generates a SHA256 hash of source code for deduplication.
    - `is_documented(snippet: CodeSnippet) -> bool`: Checks if a snippet has been documented before.
    - `get_existing_doc(snippet: CodeSnippet) -> DocumentedSnippet | None`: Retrieves existing documentation for a snippet.
    - `should_document(snippet: CodeSnippet, doc_type: DocType = DocType.FUNCTION_DOC, redocument_after_days: int = 90) -> bool`: Determines if a snippet should be documented based on the given criteria.

**How it Fits into the Project:**
`state.py` is a critical component of CodeWorm's core functionality. It ensures that documentation efforts are efficient by avoiding redundant work and maintaining an up-to-date record of what has been documented. This class interacts with other parts of the application, such as `CodeSnippet` and `DocumentedSnippet`, to manage the state of code snippets.

**Notable Design Decisions:**
- **Schema Management**: The `_init_db()` method ensures that the database schema is always up-to-date by creating necessary tables and indexes.
- **Redocumentation Policy**: The `should_document()` method uses a redocumentation period, allowing for periodic updates without unnecessary duplication.
- **Deduplication Strategy**: Code snippets are hashed using SHA256 to ensure accurate identification of identical code across different files or entities.
```

This documentation provides an overview of the file's purpose, key methods, and how it integrates with other components of the project.

---

*Generated by CodeWorm on 2026-02-21 07:33*
