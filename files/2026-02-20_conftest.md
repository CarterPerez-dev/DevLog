# conftest

**Type:** File Overview
**Repository:** stripe-referral
**File:** tests/conftest.py
**Language:** python
**Lines:** 1-143
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025 | CertGames.com
Pytest configuration and fixtures
"""

import sys
from datetime import (
    UTC,
    datetime,
)
from pathlib import Path

import pytest
from sqlalchemy import create_engine
from sqlalchemy.orm import (
    Session,
    sessionmaker,
)

src_path = Path(__file__).parent.parent / "src"
sys.path.insert(0, str(src_path))

from stripe_referral.database.Base import Base
from stripe_referral.models.Payout import Payout
from stripe_referral.models.ReferralCode import ReferralCode
from stripe_referral.models.ReferralProgram import ReferralProgram
from stripe_referral.models.ReferralTracking import ReferralTracking


@pytest.fixture(scope = "function")
def db_session() -> Session:
    """
    Create an in-memory SQLite database for testing
    """
    engine = create_engine("sqlite:///:memory:")
    Base.metadata.create_all(engine)

    SessionLocal = sessionmaker(bind = engine)
    session = SessionLocal()

    yield session

    session.close()
    Base.metadata.drop_all(engine)


@pytest.fixture
def sample_program(db_session: Session) -> ReferralProgram:
    """
    Create a sample referral program for testing
    """
    program = ReferralProgram(
        name = "Test Program",
        program_key = "test_program",
        reward_amount = 50.0,
        reward_currency = "USD",
        reward_type = "one_time",
        is_active = True,
        adapter_type = "manual",
        adapter_config = {},
    )
    db_session.add(program)
    db_session.commit()
    db_session.refresh(program)
    return program


@pytest.fixture
def sample_code(
    db_session: Session,
    sample_program: ReferralProgram
) -> ReferralCode:
    """
    Create a sample referral code for testing
    """
    code = ReferralCode(
        code = "TEST_ABC_xyz123",
        user_id = "user_123",
        program_id = sample_program.id,
        status = "active",
        uses_count = 0,
        max_uses = None,
        expires_at = None,
    )
    db_session.add(code)
    db_session.commit()
    db_session.refresh(code)
    return code


@pytest.fixture
def sample_tracking(
    db_session: Session,
    sample_program: ReferralProgram,
    sample_code: ReferralCode
) -> ReferralTracking:
    """
    Create a sample referral tracking for testing
    """
    tracking = ReferralTracking(
        referrer_user_id = "user_123",
        referred_user_id = "user_456",
        code_id = sample_code.id,
        program_id = sample_program.id,
        transaction_id = "txn_test123",
        transaction_amount = 100.0,
        amount_earned = 50.0,
        currency = "USD",
        converted_at = datetime.now(UTC),
        payout_status = "pending",
    )
    db_session.add(tracking)
    db_session.commit()
    db_session.refresh(tracking)
    return tracking


@pytest.fixture
def sample_payout(
    db_session: Session,
    sample_tracking: ReferralTracking
) -> Payout:
    """
    Create a sample payout for testing
    """
    payout = Payout(
        user_i
```

---

## File Overview

### Purpose and Responsibility

This file, `conftest.py`, serves as a central configuration for pytest fixtures used across various test modules within the `stripe-referral` project. It sets up an in-memory SQLite database to facilitate isolated testing of models and their interactions.

### Key Exports and Public Interface

- **Fixtures:**
  - `db_session`: Provides a session for interacting with an in-memory SQLite database.
  - `sample_program`, `sample_code`, `sample_tracking`, `sample_payout`: Create sample instances of `ReferralProgram`, `ReferralCode`, `ReferralTracking`, and `Payout` respectively, to be used in test cases.

### How It Fits into the Project

This file is crucial for maintaining a clean separation between test setup and actual tests. By centralizing database setup and teardown logic within `conftest.py`, it ensures that all tests can run independently without interfering with each other or external databases. This promotes robust, isolated testing of the application's core models.

### Notable Design Decisions

- **In-Memory Database**: The use of an in-memory SQLite database (`sqlite:///:memory:`) allows for quick setup and teardown times, making it ideal for unit tests.
- **Session Management**: Utilizing `sessionmaker` from SQLAlchemy to manage database sessions ensures that each test starts with a clean slate and can be run independently.
- **Fixture Scope**: The `scope = "function"` parameter on the `db_session` fixture ensures that a new session is created for each test function, maintaining isolation.

This design supports efficient, isolated testing while keeping the codebase maintainable and easy to understand.

---

*Generated by CodeWorm on 2026-02-20 09:39*
