# conftest

**Type:** File Overview
**Repository:** my-portfolio
**File:** v1/backend/conftest.py
**Language:** python
**Lines:** 1-518
**Complexity:** 0.0

---

## Source Code

```python
"""
Â©AngelaMos | 2025
conftest.py

Test configuration, fixtures, and factories
"""

import sys
from pathlib import Path


sys.path.insert(0, str(Path(__file__).parent / "app"))

import hashlib
import secrets
from datetime import (
    UTC,
    date,
    datetime,
    timedelta,
)
from uuid import uuid4
from collections.abc import AsyncIterator

import pytest
from httpx import (
    AsyncClient,
    ASGITransport,
)
from sqlalchemy.ext.asyncio import (
    AsyncSession,
    create_async_engine,
)

from core.security import (
    hash_password,
    create_access_token,
)
from config import UserRole
from core.database import get_db_session

from core.Base import Base
from user.User import User
from auth.RefreshToken import RefreshToken
from project.Project import Project
from experience.Experience import Experience
from certification.Certification import Certification
from blog.Blog import Blog
from config import (
    Language,
    ProjectStatus,
    EmploymentType,
    CertificationCategory,
    BlogCategory,
)


TEST_DATABASE_URL = "postgresql+asyncpg://test:test@localhost:9366/test_db"


@pytest.fixture
async def db_session() -> AsyncIterator[AsyncSession]:
    """
    Per test session with fresh tables
    """
    engine = create_async_engine(TEST_DATABASE_URL, echo = False)

    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.drop_all)
        await conn.run_sync(Base.metadata.create_all)

    async with AsyncSession(engine, expire_on_commit = False) as session:
        yield session

    await engine.dispose()


@pytest.fixture
async def client(db_session: AsyncSession) -> AsyncIterator[AsyncClient]:
    """
    Async HTTP client with DB session override
    """
    from factory import create_app

    app = create_app()

    async def override_get_db():
        yield db_session

    app.dependency_overrides[get_db_session] = override_get_db

    async with AsyncClient(
            transport = ASGITransport(app = app),
            base_url = "http://test",
    ) as ac:
        yield ac

    app.dependency_overrides.clear()


@pytest.fixture
def auth_headers(access_token: str) -> dict[str, str]:
    """
    Authorization headers for authenticated requests
    """
    return {"Authorization": f"Bearer {access_token}"}


@pytest.fixture
def admin_auth_headers(admin_access_token: str) -> dict[str, str]:
    """
    Authorization headers for admin requests
    """
    return {"Authorization": f"Bearer {admin_access_token}"}


class UserFactory:
    """
    Factory for creating test users
    """
    _counter = 0

    @classmethod
    async def create(
        cls,
        session: AsyncSession,
        *,
        email: str | None = None,
        password: str = "TestPass123",
        full_name: str | None = None,
        role: UserRole = UserRole.USER,
        is_active: bool = True,
        is_verified: bool = True,
    ) -> User:
        cls._counter += 1

        user = User(
            email = email or f"user{cls.
```

---

## File Overview

**File Purpose and Responsibility:**
This `conftest.py` file serves as a central configuration for pytest, defining fixtures and factories to facilitate testing across various modules within the project. It ensures that each test has access to a fresh database session and an authenticated HTTP client.

**Key Exports or Public Interface:**
- **Fixtures:** `db_session`, `client`, `auth_headers`, `admin_auth_headers`, `test_user`, `admin_user`, `inactive_user`, `access_token`.
- **Factories:** `UserFactory` and `RefreshTokenFactory` for creating test users and tokens.

**How It Fits in the Project:**
This file is crucial for setting up a consistent testing environment. The fixtures provide isolated database sessions, ensuring that tests do not interfere with each other. The factories help generate test data, making it easier to write comprehensive tests without manual setup.

**Notable Design Decisions:**
- **Database Isolation:** Each test session uses a fresh database instance to maintain isolation.
- **Dependency Injection:** Overriding the `get_db_session` dependency in the test client ensures that each test has its own database session, reducing side effects.
- **Token Management:** The `UserFactory` and `RefreshTokenFactory` classes simplify token creation, ensuring they are correctly hashed and expire as expected.
```

This documentation provides an overview of the file's role, key components, integration within the project, and important design choices.

---

*Generated by CodeWorm on 2026-02-20 02:26*
