# rate_limiter

**Type:** File Overview
**Repository:** Telehook
**File:** src/telehook/middleware/rate_limiter.py
**Language:** python
**Lines:** 1-40
**Complexity:** 0.0

---

## Source Code

```python
"""
©AngelaMos | 2026
rate_limiter.py
"""

import time

from telehook.message import Message
from telehook.middleware.base import SendFunc


class RateLimiter:
    def __init__(self, max_per_second: float = 1.0, burst: int = 3):
        self._max_per_second = max_per_second
        self._burst = burst
        self._tokens = float(burst)
        self._last_refill = time.monotonic()
        self._dropped_count = 0

    def _refill(self) -> None:
        now = time.monotonic()
        elapsed = now - self._last_refill
        self._tokens = min(
            self._burst,
            self._tokens + elapsed * self._max_per_second
        )
        self._last_refill = now

    async def __call__(self, message: Message, next_: SendFunc) -> None:
        self._refill()

        if self._tokens >= 1.0:
            self._tokens -= 1.0
            if self._dropped_count > 0:
                message.metadata["dropped_count"] = self._dropped_count
                self._dropped_count = 0
            await next_(message)
        else:
            self._dropped_count += 1

```

---

## File Overview

## rate_limiter.py

**Purpose:**
This Python file implements a rate limiter middleware for the Telehook library, ensuring that messages are sent at controlled intervals to prevent overwhelming the messaging service.

**Key Exports and Public Interface:**
- `RateLimiter`: A class responsible for managing message sending rates. It controls the frequency of message dispatches based on a configurable maximum rate per second and burst capacity.
  - Methods:
    - `__init__(self, max_per_second: float = 1.0, burst: int = 3)`: Initializes the rate limiter with a specified maximum rate and burst capacity.
    - `_refill(self)`: Refills the token bucket based on elapsed time since the last refill.
    - `__call__(self, message: Message, next_: SendFunc) -> None`: Checks if a message can be sent. If so, it sends the message; otherwise, it drops the message and increments the drop count.

**Project Fit:**
This file is part of the Telehook middleware layer, designed to ensure that messages are sent in a controlled manner. It integrates with other middleware components by wrapping them with rate limiting logic, ensuring compliance with external service rate limits or internal policy constraints.

**Design Decisions:**
- The implementation uses a token bucket algorithm for rate limiting, which is efficient and easy to understand.
- The `__call__` method allows the class to be used as a decorator, seamlessly integrating into Telehook's middleware pipeline.
- Type hints are provided for clarity and maintainability, ensuring that users of this class understand its expected inputs and outputs.
```

This documentation provides an overview of the file’s purpose, key components, integration within the project, and notable design choices.

---

*Generated by CodeWorm on 2026-03-01 09:03*
