# useAuth

**Type:** File Overview
**Repository:** ios-test
**File:** red-recon/src/api/hooks/useAuth.ts
**Language:** typescript
**Lines:** 1-196
**Complexity:** 0.0

---

## Source Code

```typescript
/**
 * @AngelaMos | 2026
 * useAuth.ts
 */

import {
  AUTH_ERROR_MESSAGES,
  AuthResponseError,
  type LoginRequest,
  type LogoutAllResponse,
  type MobileLoginResponse,
  type PasswordChangeRequest,
  type UserResponse,
  isValidLogoutAllResponse,
  isValidMobileLoginResponse,
  isValidUserResponse,
} from '@/api/types'
import { QUERY_STRATEGIES, apiClient, setAccessToken } from '@/core/api'
import { API_ENDPOINTS, QUERY_KEYS } from '@/core/config'
import { useAuthStore } from '@/core/lib'
import { SECURE_KEYS, secureStorage } from '@/core/storage'
import {
  type UseMutationResult,
  type UseQueryResult,
  useMutation,
  useQuery,
  useQueryClient,
} from '@tanstack/react-query'
import { router } from 'expo-router'

export const authQueries = {
  all: () => QUERY_KEYS.AUTH.ALL,
  me: () => QUERY_KEYS.AUTH.ME(),
} as const

const fetchCurrentUser = async (): Promise<UserResponse> => {
  const response = await apiClient.get<unknown>(API_ENDPOINTS.AUTH.ME)
  const data: unknown = response.data

  if (!isValidUserResponse(data)) {
    throw new AuthResponseError(
      AUTH_ERROR_MESSAGES.INVALID_USER_RESPONSE,
      API_ENDPOINTS.AUTH.ME
    )
  }

  return data
}

export const useCurrentUser = (): UseQueryResult<UserResponse, Error> => {
  const isAuthenticated = useAuthStore((s) => s.isAuthenticated)

  return useQuery({
    queryKey: authQueries.me(),
    queryFn: fetchCurrentUser,
    enabled: isAuthenticated,
    ...QUERY_STRATEGIES.auth,
  })
}

const performLogin = async (
  credentials: LoginRequest
): Promise<MobileLoginResponse> => {
  const formData = new URLSearchParams()
  formData.append('username', credentials.username)
  formData.append('password', credentials.password)

  const response = await apiClient.post<unknown>(
    API_ENDPOINTS.AUTH.LOGIN,
    formData,
    {
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    }
  )

  const data: unknown = response.data

  if (!isValidMobileLoginResponse(data)) {
    throw new AuthResponseError(
      AUTH_ERROR_MESSAGES.INVALID_LOGIN_RESPONSE,
      API_ENDPOINTS.AUTH.LOGIN
    )
  }

  return data
}

export const useLogin = (): UseMutationResult<
  MobileLoginResponse,
  Error,
  LoginRequest
> => {
  const queryClient = useQueryClient()
  const login = useAuthStore((s) => s.login)

  return useMutation({
    mutationFn: performLogin,
    onSuccess: async (data: MobileLoginResponse): Promise<void> => {
      setAccessToken(data.access_token)
      if (data.refresh_token) {
        await secureStorage.setItem(SECURE_KEYS.REFRESH_TOKEN, data.refresh_token)
      }

      login(data.user)

      queryClient.setQueryData(authQueries.me(), data.user)
    },
  })
}

const performLogout = async (): Promise<void> => {
  await apiClient.post(API_ENDPOINTS.AUTH.LOGOUT)
}

export const useLogout = (): UseMutationResult<void, Error, void> => {
  const queryClient = useQueryClient()
  const logout = useAuthStore((s) => s.logout)

  return useMutation({
    mutationFn: perf
```

---

## File Overview

### useAuth.ts

**Purpose and Responsibility:**
This file provides authentication-related hooks for handling user login, logout, current user retrieval, password changes, and secure storage of tokens. It integrates with the `@tanstack/react-query` library to manage asynchronous data fetching and caching.

**Key Exports/Interface:**
- **useCurrentUser:** A hook that fetches and caches the currently authenticated user.
- **useLogin:** A mutation hook for logging in a user, handling token storage, and updating the store.
- **useLogout:** A mutation hook for logging out a user, clearing tokens, and redirecting to the login page.
- **useLogoutAll:** A mutation hook for logging out all sessions of a user.
- **useChangePassword:** A mutation hook for changing a user's password.

**How it Fits in the Project:**
This file is crucial for managing authentication states across the application. It interacts with other core modules like `apiClient` for API calls, `authStore` for state management, and `secureStorage` for secure token storage. The hooks are used throughout the app to ensure consistent user authentication.

**Notable Design Decisions:**
- **Type Safety:** Utilizes TypeScript types extensively to ensure type safety.
- **Error Handling:** Implements robust error handling using custom `AuthResponseError`.
- **Query Caching:** Uses `@tanstack/react-query` for caching and managing query states, ensuring efficient data fetching.
- **Secure Storage:** Stores sensitive tokens securely in local storage using `secureStorage`.
```

This documentation provides a high-level overview of the file's purpose, key exports, integration within the project, and notable design decisions.

---

*Generated by CodeWorm on 2026-02-20 14:34*
