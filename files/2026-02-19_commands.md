# commands

**Type:** File Overview
**Repository:** angelamos-operations
**File:** CarterBot-Telegram/src/handlers/commands.ts
**Language:** typescript
**Lines:** 1-228
**Complexity:** 0.0

---

## Source Code

```typescript
/**
 * CarterOS Telegram Bot - Command Handlers
 *
 * /start, /new, /stop, /status, /resume, /restart, /retry
 */

import type { Context } from "grammy";
import { session } from "../session";
import { WORKING_DIR, ALLOWED_USERS, RESTART_FILE } from "../config";
import { isAuthorized } from "../utils";

export async function handleStart(ctx: Context): Promise<void> {
  const userId = ctx.from?.id;

  if (!isAuthorized(userId, ALLOWED_USERS)) {
    await ctx.reply("Unauthorized. Contact the bot owner for access.");
    return;
  }

  const status = session.isActive ? "Active session" : "No active session";

  await ctx.reply(
    `<b>CarterOS Telegram Bot</b>\n\n` +
      `Status: ${status}\n` +
      `Working directory: <code>${WORKING_DIR}</code>\n\n` +
      `<b>Commands:</b>\n` +
      `/new - Start fresh session\n` +
      `/stop - Stop current query\n` +
      `/status - Show detailed status\n` +
      `/resume - Resume last session\n` +
      `/retry - Retry last message\n` +
      `/restart - Restart the bot\n\n` +
      `<b>Tips:</b>\n` +
      `Prefix with <code>!</code> to interrupt current query\n` +
      `Use "think" or "ultrathink" for extended reasoning\n` +
      `Send photos, voice, or documents`,
    { parse_mode: "HTML" }
  );
}

export async function handleNew(ctx: Context): Promise<void> {
  const userId = ctx.from?.id;

  if (!isAuthorized(userId, ALLOWED_USERS)) {
    await ctx.reply("Unauthorized.");
    return;
  }

  if (session.isRunning) {
    const result = await session.stop();
    if (result) {
      await Bun.sleep(100);
      session.clearStopRequested();
    }
  }

  await session.kill();

  await ctx.reply("Session cleared. Next message starts fresh.");
}

export async function handleStop(ctx: Context): Promise<void> {
  const userId = ctx.from?.id;

  if (!isAuthorized(userId, ALLOWED_USERS)) {
    await ctx.reply("Unauthorized.");
    return;
  }

  if (session.isRunning) {
    const result = await session.stop();
    if (result) {
      await Bun.sleep(100);
      session.clearStopRequested();
    }
  }
}

export async function handleStatus(ctx: Context): Promise<void> {
  const userId = ctx.from?.id;

  if (!isAuthorized(userId, ALLOWED_USERS)) {
    await ctx.reply("Unauthorized.");
    return;
  }

  const lines: string[] = ["<b>Bot Status</b>\n"];

  if (session.isActive) {
    lines.push(`Session: Active (${session.sessionId?.slice(0, 8)}...)`);
  } else {
    lines.push("Session: None");
  }

  if (session.isRunning) {
    const elapsed = session.queryStarted
      ? Math.floor((Date.now() - session.queryStarted.getTime()) / 1000)
      : 0;
    lines.push(`Query: Running (${elapsed}s)`);
    if (session.currentTool) {
      lines.push(`   ${session.currentTool}`);
    }
  } else {
    lines.push("Query: Idle");
    if (session.lastTool) {
      lines.push(`   Last: ${session.lastTool}`);
    }
  }

  if (session.lastActivity) {
    const ago = Math.floor(
      (Date.now() - session.lastActivity.getTime
```

---

## File Overview

### File Documentation

**File Purpose and Responsibility:**
This TypeScript source file defines command handlers for a Telegram bot, specifically handling commands like `/start`, `/new`, `/stop`, `/status`, `/resume`, `/restart`, and `/retry`. These handlers manage the session state, user authorization, and interaction with the bot's internal logic.

**Key Exports or Public Interface:**
- `handleStart`: Initializes a new session for authorized users.
- `handleNew`: Clears an existing session to start fresh.
- `handleStop`: Stops the current query if running.
- `handleStatus`: Displays detailed status information about the bot and active sessions.
- `handleResume`: Resumes the last session if it was previously stopped.
- `handleRestart`: Restarts the bot, saving state for potential recovery.

**How It Fits in the Project:**
This file is a crucial part of the CarterOS Telegram Bot's command processing system. It interacts with the global `session` object to manage user sessions and provides commands that users can execute directly via Telegram. The handlers are responsible for ensuring only authorized users can perform actions, maintaining session integrity, and providing feedback through Telegram messages.

**Notable Design Decisions:**
- **User Authorization**: Utilizes a `isAuthorized` function from the `utils` module to ensure only allowed users can execute commands.
- **Session Management**: The `session` object is used to track active sessions, query status, and manage session states. This ensures consistent handling of user interactions across different command handlers.
- **Restart Mechanism**: Implements a restart mechanism by writing state information to a file (`RESTART_FILE`) before exiting the process, allowing for potential recovery or graceful shutdowns.

This design ensures robust management of user sessions and commands while maintaining clear separation of concerns within the bot's architecture.

---

*Generated by CodeWorm on 2026-02-19 18:24*
