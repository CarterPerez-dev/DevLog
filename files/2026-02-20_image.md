# image

**Type:** File Overview
**Repository:** docksec
**File:** internal/analyzer/image.go
**Language:** go
**Lines:** 1-183
**Complexity:** 0.0

---

## Source Code

```go
/*
AngelaMos | 2025
image.go
*/

package analyzer

import (
	"context"
	"fmt"
	"strings"

	"github.com/CarterPerez-dev/docksec/internal/benchmark"
	"github.com/CarterPerez-dev/docksec/internal/docker"
	"github.com/CarterPerez-dev/docksec/internal/finding"
	"github.com/docker/docker/api/types"
)

// ImageAnalyzer inspects local Docker images for security issues including
// missing user specifications, healthcheck configurations, and image
// configuration metadata.
type ImageAnalyzer struct {
	client *docker.Client
}

// NewImageAnalyzer creates a new analyzer using the provided Docker client.
func NewImageAnalyzer(client *docker.Client) *ImageAnalyzer {
	return &ImageAnalyzer{client: client}
}

// Name returns "image" as the analyzer identifier.
func (a *ImageAnalyzer) Name() string {
	return "image"
}

// Analyze lists all local images and inspects each for security
// misconfigurations per CIS Docker Benchmark Section 4 controls.
func (a *ImageAnalyzer) Analyze(
	ctx context.Context,
) (finding.Collection, error) {
	images, err := a.client.ListImages(ctx)
	if err != nil {
		return nil, err
	}

	var findings finding.Collection
	for _, img := range images {
		info, err := a.client.InspectImage(ctx, img.ID)
		if err != nil {
			continue
		}

		name := img.ID[:12]
		if len(img.RepoTags) > 0 {
			name = img.RepoTags[0]
		}

		target := finding.Target{
			Type: finding.TargetImage,
			Name: name,
			ID:   img.ID,
		}

		findings = append(findings, a.analyzeImage(target, info)...)
	}

	return findings, nil
}

func (a *ImageAnalyzer) analyzeImage(
	target finding.Target,
	info types.ImageInspect,
) finding.Collection {
	var findings finding.Collection

	findings = append(findings, a.checkRootUser(target, info)...)
	findings = append(findings, a.checkHealthcheck(target, info)...)
	findings = append(findings, a.checkExposedPorts(target, info)...)

	return findings
}

func (a *ImageAnalyzer) checkRootUser(
	target finding.Target,
	info types.ImageInspect,
) finding.Collection {
	var findings finding.Collection

	if info.Config == nil {
		return findings
	}

	user := info.Config.User
	if user == "" || user == "root" || user == "0" {
		control, _ := benchmark.Get("4.1")
		f := finding.New("CIS-4.1", control.Title, finding.SeverityMedium, target).
			WithDescription(control.Description).
			WithCategory(string(CategoryImage)).
			WithRemediation(control.Remediation).
			WithReferences(control.References...).
			WithCISControl(control.ToCISControl())
		findings = append(findings, f)
	}

	return findings
}

func (a *ImageAnalyzer) checkHealthcheck(
	target finding.Target,
	info types.ImageInspect,
) finding.Collection {
	var findings finding.Collection

	if info.Config == nil {
		return findings
	}

	if info.Config.Healthcheck == nil ||
		len(info.Config.Healthcheck.Test) == 0 {
		control, _ := benchmark.Get("4.6")
		f := finding.New("CIS-4.6", control.Title, finding.SeverityLow, target).
			WithDescription(control.Description).
			WithCategory(string(Categor
```

---

## File Overview

## File Documentation: image.go

### Purpose and Responsibility
This file defines `ImageAnalyzer`, a component responsible for inspecting local Docker images to identify security misconfigurations according to the CIS Docker Benchmark Section 4 controls.

### Key Exports and Public Interface
- **`ImageAnalyzer`**: An analyzer struct that inspects Docker images.
- **`NewImageAnalyzer`**: A constructor function that initializes an `ImageAnalyzer`.
- **`Analyze`**: The main method for analyzing images, listing them and checking for security issues.
- **`checkRootUser`, `checkHealthcheck`, `checkExposedPorts`**: Helper methods to check specific image configurations.

### How It Fits in the Project
The `ImageAnalyzer` is part of a larger suite of analyzers that collectively ensure Docker environments meet security standards. This file integrates with the `docker.Client` to fetch and inspect images, then reports findings using the `finding.Collection`.

### Notable Design Decisions
- **Error Handling**: Errors are handled gracefully by logging them or continuing analysis.
- **CIS Benchmark Compliance**: The analyzer adheres to specific CIS controls, ensuring compliance through structured checks.
- **Modular Structure**: Helper methods like `checkRootUser`, `checkHealthcheck`, and `checkExposedPorts` make the code more readable and maintainable.
```

This documentation provides a high-level overview of the file's purpose, key components, integration within the project, and design choices.

---

*Generated by CodeWorm on 2026-02-20 20:07*
