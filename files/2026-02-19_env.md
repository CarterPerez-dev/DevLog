# env

**Type:** File Overview
**Repository:** angelamos-operations
**File:** CarterOS-Server/alembic/env.py
**Language:** python
**Lines:** 1-141
**Complexity:** 0.0

---

## Source Code

```python
"""
ⒸAngelaMos | 2026
env.py
"""
import asyncio
from logging.config import fileConfig

from alembic import context
from sqlalchemy import pool
from sqlalchemy.engine import Connection
from sqlalchemy.ext.asyncio import async_engine_from_config

from config import settings
from core.infrastructure.database.Base import Base
from core.enums import SafeEnum

from aspects.auth.models.User import User  # noqa: F401
from aspects.auth.models.RefreshToken import RefreshToken  # noqa: F401
from core.foundation.models.identity import (  # noqa: F401
    CoreIdentity,
    IdentitySkill,
    IdentityInterest,
    IdentityCertification,
    IdentityStrength,
    IdentityWeakness,
    BrandVoice,
    BrandVoiceAvoid,
    PlatformGoal,
    RevenueGoal,
    ContentPillar,
    ContentPreference,
)
from aspects.challenge.facets.tracker.models import Challenge, ChallengeLog  # noqa: F401
from aspects.life_manager.facets.planner.models import TimeBlock  # noqa: F401
from aspects.life_manager.facets.notes.models import NoteFolder, Note  # noqa: F401
from aspects.life_manager.facets.career.job_app_tracker.models import (  # noqa: F401
    JobApplication,
)
from aspects.analytics.facets.data_input.models import TikTokVideo  # noqa: F401


config = context.config


def render_item(type_, obj, autogen_context):
    """
    Custom renderer for alembic autogenerate.
    Converts SafeEnum to standard sa.Enum and ensures DateTime uses timezone.
    """
    import sqlalchemy as sa

    if isinstance(obj, SafeEnum):
        enum_class = obj.enum_class
        values = [e.value for e in enum_class]
        return f"sa.Enum({', '.join(repr(v) for v in values)}, name='{obj.name}')"

    if isinstance(obj, sa.DateTime):
        return "sa.DateTime(timezone=True)"

    return False


if config.config_file_name is not None:
    fileConfig(config.config_file_name)

target_metadata = Base.metadata


def get_url() -> str:
    """
    Get database URL from settings
    """
    return str(settings.DATABASE_URL)


def run_migrations_offline() -> None:
    """
    Run migrations in 'offline' mode
    """
    url = get_url()
    context.configure(
        url = url,
        target_metadata = target_metadata,
        literal_binds = True,
        dialect_opts = {"paramstyle": "named"},
        compare_type = True,
        compare_server_default = True,
        render_item = render_item,
    )

    with context.begin_transaction():
        context.run_migrations()


def do_run_migrations(connection: Connection) -> None:
    """
    Run migrations with connection
    """
    context.configure(
        connection = connection,
        target_metadata = target_metadata,
        compare_type = True,
        compare_server_default = True,
        render_item = render_item,
    )

    with context.begin_transaction():
        context.run_migrations()


async def run_async_migrations() -> None:
    """
    Run migrations in async mode
    """
    configuration = config.get_section(config.config_ini_s
```

---

## File Overview

### Purpose and Responsibility

This file, `env.py`, is responsible for configuring and running database migrations using Alembic in both offline and online modes. It ensures that all models defined across various modules are properly registered and that custom rendering functions are applied during migration generation.

### Key Exports and Public Interface

- **render_item**: A custom renderer function used by Alembic to handle SafeEnum types and DateTime fields.
- **get_url**: Retrieves the database URL from project settings.
- **run_migrations_offline**: Runs migrations in offline mode, useful for non-interactive environments.
- **do_run_migrations**: Executes migrations with a given connection.
- **run_async_migrations**: Asynchronous function to run migrations using an async engine.
- **run_migrations_online**: Runs migrations in online mode, leveraging asyncio.

### How It Fits into the Project

This file is crucial for database schema management and ensures that all models (from various aspects like auth, challenge, life manager, analytics) are included in the migration process. It integrates with Alembic's configuration to handle complex data types and custom rendering requirements, making it a key component of the project’s database infrastructure.

### Notable Design Decisions

- **Custom Renderer**: The `render_item` function is designed to handle SafeEnum types and ensure that DateTime fields are timezone-aware.
- **Async Support**: The use of asyncio for running migrations supports modern asynchronous programming practices.
- **Model Registration**: All models from different aspects are imported and registered, ensuring comprehensive database schema management.
- **Configuration Flexibility**: The file dynamically retrieves the database URL from settings, making it flexible across different environments.
```

This documentation provides a high-level overview of the file's purpose, key functions, integration within the project, and notable design decisions.

---

*Generated by CodeWorm on 2026-02-19 19:07*
