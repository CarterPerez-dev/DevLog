# jwt_auth

**Type:** File Overview
**Repository:** CertGames-Core
**File:** backend/api/core/auth/jwt_auth.py
**Language:** python
**Lines:** 1-204
**Complexity:** 0.0

---

## Source Code

```python
"""
JWT Helper Functions
/api/core/auth/jwt_auth.py
"""

from typing import Any
from datetime import timedelta
from flask import Flask, current_app
from flask_jwt_extended import (
    JWTManager,
    create_access_token,
    create_refresh_token,
)
from config import init_jwt_config, Config

from api.admin.models.security import (
    TokenBlocklist,
    ActiveTokenCount,
)
from api.admin.models.users.AdminUser import AdminUser
from api.core.services.refresh_token_service import RefreshTokenService
from api.domains.account.models.User import User


jwt: JWTManager = JWTManager()


def init_jwt(app: Flask) -> None:
    """
    Initialize JWT settings for the app
    """
    config_instance = Config()
    init_jwt_config(app, config_instance)

    @jwt.token_in_blocklist_loader
    def check_if_token_revoked(
        jwt_header: dict[str,
                         Any],
        jwt_payload: dict[str,
                          Any],
    ) -> bool:
        jti: str = jwt_payload["jti"]
        return bool(TokenBlocklist.is_token_revoked(jti))

    @jwt.user_lookup_loader
    def user_lookup_callback(
        _jwt_header: dict[str,
                          Any],
        jwt_data: dict[str,
                       Any]
    ) -> dict[str,
              Any] | None:
        """
        Load user from database when JWT is verified
        """
        identity: str = jwt_data["sub"]
        is_admin_token = jwt_data.get("is_admin", False)

        try:
            if is_admin_token:
                admin_user: AdminUser | None = AdminUser.objects(
                    id = identity
                ).first()
                if admin_user:
                    admin_dict: dict[str,
                                     Any] = {
                                         "id": str(admin_user.id),
                                         "email": admin_user.email,
                                         "name": admin_user.name,
                                         "role": admin_user.role.value,
                                         "is_active": admin_user.is_active,
                                         "is_admin": True
                                     }
                    return admin_dict
            else:
                user: User | None = User.objects(id = identity).first()
                if user:
                    user_dict: dict[str, Any] = user.to_dict()
                    return user_dict
        except Exception as e:
            current_app.logger.error(f"Error looking up user: {str(e)}")
        return None

    @jwt.expired_token_loader
    def expired_token_callback(
        jwt_header: dict[str,
                         Any],
        jwt_payload: dict[str,
                          Any],
    ) -> tuple[dict[str,
                    str | int],
               int]:
        return {
            "status": 401,
            "error": "Token has expired",
            "message": "The token has expired. Please log in again.",
        }, 40
```

---

## File Overview

### Purpose and Responsibility

This Python source file, `jwt_auth.py`, is responsible for managing JWT (JSON Web Token) authentication within the CertGames-Core backend application. It initializes JWT settings, handles token generation, and implements various callbacks to manage token validation and revocation.

### Key Exports and Public Interface

- **`init_jwt(app: Flask) -> None`**: Initializes JWT settings for the Flask app.
- **`generate_tokens(user_id: str, additional_claims: dict[str, Any] | None = None, access_expires: int | None = None, refresh_expires: int | None = None) -> dict[str, str | int]`**: Generates access and refresh tokens for a user.

### How It Fits into the Project

This file is crucial for authentication in the CertGames-Core backend. It integrates with Flask and Flask-JWT-Extended to handle token-based authentication. The `init_jwt` function configures JWT settings and sets up callbacks for token validation, revocation, and expiration handling. The `generate_tokens` function provides a convenient way to create tokens for users.

### Notable Design Decisions

1. **JWTManager Initialization**: Uses `JWTManager` from Flask-JWT-Extended to manage tokens.
2. **Token Revocation Check**: Implements a custom token revocation check using `TokenBlocklist`.
3. **User Lookup Loader**: Defines a user lookup loader to load users from the database when JWT is verified.
4. **Expired Token Handler**: Provides an expired token handler to handle cases where access tokens expire.
5. **Refresh Token Storage**: Utilizes a refresh token service (`RefreshTokenService`) to store and manage refresh tokens securely.

This file ensures robust authentication mechanisms, including token validation, revocation, and expiration handling, contributing significantly to the security of the CertGames-Core application.

---

*Generated by CodeWorm on 2026-02-19 11:46*
