# routes

**Type:** File Overview
**Repository:** angelamos-operations
**File:** Angela-Wake/server/routes.py
**Language:** python
**Lines:** 1-145
**Complexity:** 0.0

---

## Source Code

```python
"""
Angela Wake Word Server - Routes
"""

import numpy as np
from fastapi import APIRouter, WebSocket, WebSocketDisconnect
from openwakeword.model import Model
from scipy import signal

from .config import (
    DETECTION_THRESHOLD,
    ENABLE_VAD,
    FRAME_SAMPLES,
    MODELS_DIR,
    VAD_THRESHOLD,
)

TARGET_SAMPLES = 1280


router = APIRouter()

model: Model | None = None


def get_model() -> Model:
    global model
    if model is None:
        model_paths = list(MODELS_DIR.glob("*.tflite")) + list(MODELS_DIR.glob("*.onnx"))

        if model_paths:
            model = Model(
                wakeword_models=[str(p) for p in model_paths],
                vad_threshold=VAD_THRESHOLD if ENABLE_VAD else None,
            )
        else:
            model = Model(
                vad_threshold=VAD_THRESHOLD if ENABLE_VAD else None,
            )
    return model


@router.on_event("startup")
async def startup():
    get_model()


@router.get("/health")
async def health():
    m = get_model()
    return {
        "status": "ok",
        "models": list(m.models.keys()),
        "threshold": DETECTION_THRESHOLD,
        "vad_enabled": ENABLE_VAD,
    }


@router.get("/models")
async def list_models():
    m = get_model()
    return {"models": list(m.models.keys())}


@router.websocket("/ws")
async def websocket_detect(websocket: WebSocket):
    await websocket.accept()

    model_paths = list(MODELS_DIR.glob("*.tflite")) + list(MODELS_DIR.glob("*.onnx"))
    if model_paths:
        m = Model(
            wakeword_models=[str(p) for p in model_paths],
            vad_threshold=VAD_THRESHOLD if ENABLE_VAD else None,
        )
    else:
        m = Model(vad_threshold=VAD_THRESHOLD if ENABLE_VAD else None)

    model_names = list(m.models.keys())
    frame_count = 0

    try:
        while True:
            msg = await websocket.receive()

            if msg.get('type') == 'websocket.disconnect':
                break

            if 'text' in msg:
                if msg['text'] == 'reset':
                    m.reset()
                    print("[DEBUG] Model reset")
                continue

            if 'bytes' not in msg:
                continue

            data = msg['bytes']
            audio = np.frombuffer(data, dtype=np.int16)
            frame_count += 1

            orig_len = len(audio)
            orig_amp = np.max(np.abs(audio))

            if len(audio) != TARGET_SAMPLES:
                ratio = len(audio) // TARGET_SAMPLES
                if ratio > 1:
                    audio = audio[::ratio][:TARGET_SAMPLES]
                else:
                    audio = signal.resample_poly(audio, TARGET_SAMPLES, len(audio)).astype(np.int16)

            predictions = m.predict(audio)

            for name in model_names:
                score = predictions.get(name, 0.0)
                if frame_count % 50 == 0:
                    print(f"[DEBUG] Frame {frame_count}: orig_len={orig_len}, orig_amp={orig_amp}, {name}={score:.4f}")
          
```

---

## File Overview

# Angela Wake Word Server - Routes Documentation

## Purpose and Responsibility
This file defines the API routes for a wake word detection server using FastAPI. It handles health checks, model management, and real-time audio processing via websockets.

## Key Exports and Public Interface
- **Health Check**: `/health` endpoint to verify server status.
- **Model Management**: `/models` endpoint to list available models.
- **WebSocket Detection**: Real-time detection of wake words using `/ws`.
- **Audio Detection**: POST `/detect` for detecting wake words from audio data.

## Integration in the Project
This file is part of a larger project that includes model training and deployment. It integrates with the `config.py` module to load settings, and uses the `openwakeword.model.Model` class for detection logic. The routes handle both static information (like available models) and dynamic processing (real-time audio).

## Notable Design Decisions
- **Global Model Instance**: A single global instance of the model is maintained across requests to avoid reinitialization overhead.
- **WebSocket Handling**: Real-time detection uses websockets for efficient communication, allowing continuous audio stream processing.
- **Detection Thresholds and VAD**: Detection threshold (`DETECTION_THRESHOLD`) and Voice Activity Detection (VAD) are configurable via environment variables.
- **Resampling Logic**: Ensures incoming audio data is of a consistent length before prediction to maintain accuracy.
```

This documentation provides an overview of the file's role, its key components, how it integrates with other parts of the project, and some important design choices.

---

*Generated by CodeWorm on 2026-02-19 19:46*
