# Session

**Type:** File Overview
**Repository:** stripe-referral
**File:** src/stripe_referral/database/Session.py
**Language:** python
**Lines:** 1-71
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025 | CertGames.com
SQLAlchemy session factory and context manager
"""

from collections.abc import Generator
from contextlib import contextmanager

from sqlalchemy import Engine, create_engine
from sqlalchemy.orm import Session, sessionmaker

from ..config.constants import (
    DATABASE_CONNECTION_MAX_OVERFLOW,
    DATABASE_CONNECTION_POOL_SIZE,
    DATABASE_CONNECTION_TIMEOUT_SECONDS,
)
from ..config.enums import Environment
from ..config.settings import settings


engine: Engine | None
SessionLocal: sessionmaker[Session] | None

if settings.database_url:
    engine = create_engine(
        settings.database_url,
        pool_pre_ping = True,
        pool_size = DATABASE_CONNECTION_POOL_SIZE,
        max_overflow = DATABASE_CONNECTION_MAX_OVERFLOW,
        pool_timeout = DATABASE_CONNECTION_TIMEOUT_SECONDS,
        echo = settings.environment == Environment.DEVELOPMENT,
    )

    SessionLocal = sessionmaker(
        autocommit = False,
        autoflush = False,
        bind = engine,
    )
else:
    engine = None
    SessionLocal = None


@contextmanager
def get_db() -> Generator[Session, None, None]:
    """
    Context manager for database sessions
    """
    if SessionLocal is None:
        raise RuntimeError(
            "Database not configured. Set DATABASE_URL environment variable."
        )

    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


def get_db_session() -> Session:
    """
    Get a new database session (for dependency injection)
    """
    if SessionLocal is None:
        raise RuntimeError(
            "Database not configured. Set DATABASE_URL environment variable."
        )

    return SessionLocal()

```

---

## File Overview

**Purpose and Responsibility:**
This Python source file provides a database session factory and context manager for managing SQLAlchemy sessions, ensuring proper connection pooling and resource management within the `stripe-referral` application.

**Key Exports or Public Interface:**
- **SessionLocal**: A SQLAlchemy sessionmaker instance that creates sessions bound to the configured engine.
- **get_db()**: A context manager function that yields a database session, handling session creation and closure.
- **get_db_session()**: A utility function for obtaining a new database session, useful for dependency injection.

**How it Fits in the Project:**
This file is crucial for database operations within `stripe-referral`, providing a standardized way to interact with the database. It ensures that sessions are properly managed, reducing the risk of connection leaks and improving performance through connection pooling.

**Notable Design Decisions:**
- The use of a context manager (`get_db()`) simplifies session management by automatically handling session closure.
- Configuration is based on environment settings, allowing for flexible database setup across different environments (development, production).
- Dependency injection via `get_db_session()` supports clean separation of concerns and easier testing.
```

This documentation provides an overview of the file's role in the project, its key components, and important design choices.

---

*Generated by CodeWorm on 2026-02-20 11:08*
