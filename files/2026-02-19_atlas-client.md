# atlas_client

**Type:** File Overview
**Repository:** CertGames-Core
**File:** backend/api/core/services/clients/atlas_client.py
**Language:** python
**Lines:** 1-390
**Complexity:** 0.0

---

## Source Code

```python
"""
Atlas API v2 Client Service
/api/core/services/clients/atlas_client.py
"""

import requests
from typing import Any
from dataclasses import dataclass
from requests.auth import HTTPDigestAuth
from datetime import datetime, timedelta, UTC


@dataclass
class AtlasMetricsRequest:
    """
    Configuration for Atlas metrics API request
    """
    metrics: list[str]
    granularity: str
    start: datetime
    end: datetime


class AtlasClient:
    """
    MongoDB Atlas Metrics API v2 client for cluster-wide performance monitoring.
    """
    def __init__(self, config):
        """
        Initialize Atlas client with configuration
        """
        self.config = config
        self.base_url = "https://cloud.mongodb.com/api/atlas/v2"
        self.auth = HTTPDigestAuth(
            config.ATLAS_PUBLIC_KEY,
            config.ATLAS_PRIVATE_KEY
        )
        self.headers = {
            'Accept': 'application/vnd.atlas.2025-03-12+json',
            'Content-Type': 'application/vnd.atlas.2025-03-12+json'
        }
        self.timeout = getattr(config, 'ATLAS_REQUEST_TIMEOUT', 30)

    def get_cluster_metrics(self,
                            request: AtlasMetricsRequest) -> dict[str,
                                                                  Any]:
        """
        Fetch cluster-wide performance metrics from Atlas API v2
        """
        url = f"{self.base_url}/groups/{self.config.ATLAS_GROUP_ID}/processes/{self.config.ATLAS_PROCESS_ID}/measurements"

        params = {
            "granularity": request.granularity,
            "start": request.start.isoformat().replace('+00:00',
                                                       'Z'),
            "end": request.end.isoformat().replace('+00:00',
                                                   'Z'),
            "metrics": request.metrics
        }

        response = requests.get(
            url,
            auth = self.auth,
            headers = self.headers,
            params = params,
            timeout = self.timeout
        )
        response.raise_for_status()
        return dict(response.json())

    def get_database_level_metrics(
        self,
        database_name: str,
        request: AtlasMetricsRequest
    ) -> dict[str,
              Any]:
        """
        Fetch database-level metrics from Atlas API v2
        """
        url = f"{self.base_url}/groups/{self.config.ATLAS_GROUP_ID}/processes/{self.config.ATLAS_PROCESS_ID}/databases/{database_name}/measurements"

        params = {
            "granularity": request.granularity,
            "start": request.start.isoformat().replace('+00:00',
                                                       'Z'),
            "end": request.end.isoformat().replace('+00:00',
                                                   'Z'),
            "metrics": request.metrics
        }

        response = requests.get(
            url,
            auth = self.auth,
            headers = self.headers,
            params = para
```

---

## File Overview

# Atlas API v2 Client Service

## Purpose and Responsibility
This file defines a Python client for interacting with MongoDB Atlas Metrics API v2, enabling cluster-wide performance monitoring.

## Key Exports and Public Interface
- **AtlasClient**: A class for making API requests to fetch metrics.
  - `get_cluster_metrics(request: AtlasMetricsRequest) -> dict[str, Any]`: Fetches cluster-wide performance metrics.
  - `get_database_level_metrics(database_name: str, request: AtlasMetricsRequest) -> dict[str, Any]`: Fetches database-level metrics.
  - `extract_metric_values(raw_data: dict[str, Any], metric_name: str) -> list[float]`: Extracts specific metric values from raw API response.
  - `calculate_metric_summary(values: list[float]) -> dict[str, float]`: Calculates summary statistics for a given metric.

## Project Integration
This client service is part of the backend infrastructure in CertGames-Core. It provides essential metrics to monitor and analyze MongoDB Atlas clusters, aiding in performance optimization and troubleshooting.

## Design Decisions
- **Data Classes**: `AtlasMetricsRequest` uses dataclasses for type safety and readability.
- **HTTP Requests**: Utilizes `requests` library with authentication via HTTP Digest Auth.
- **Error Handling**: Raises exceptions on API errors to ensure robust error handling.
- **Static Methods**: `extract_metric_values` and `calculate_metric_summary` are static methods, making them reusable across the application.

---

*Generated by CodeWorm on 2026-02-19 07:51*
