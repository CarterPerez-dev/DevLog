# dedup

**Type:** File Overview
**Repository:** Telehook
**File:** src/telehook/middleware/dedup.py
**Language:** python
**Lines:** 1-37
**Complexity:** 0.0

---

## Source Code

```python
"""
Â©AngelaMos | 2026
dedup.py
"""

import hashlib
import time

from telehook.message import Message
from telehook.middleware.base import SendFunc


class Dedup:
    def __init__(self, window_seconds: float = 60.0):
        self._window = window_seconds
        self._seen: dict[str, float] = {}

    def _message_hash(self, message: Message) -> str:
        return hashlib.sha256(message.text.encode()).hexdigest()[: 16]

    def _cleanup(self) -> None:
        now = time.monotonic()
        expired = [k for k, v in self._seen.items() if now - v > self._window]
        for k in expired:
            del self._seen[k]

    async def __call__(self, message: Message, next_: SendFunc) -> None:
        self._cleanup()
        msg_hash = self._message_hash(message)
        now = time.monotonic()

        if msg_hash in self._seen:
            return

        self._seen[msg_hash] = now
        await next_(message)

```

---

## File Overview

## dedup.py

### Purpose and Responsibility
This Python file implements a message deduplication middleware for Telehook, ensuring that messages are not sent more frequently than specified by a window period.

### Key Exports and Public Interface
- **Dedup**: A class responsible for deduplicating messages based on their content hash. It provides an asynchronous interface to integrate with the Telehook messaging system.
  - `__init__(self, window_seconds: float = 60.0)`: Initializes the deduplication logic with a specified time window (default is 60 seconds).
  - `_message_hash(self, message: Message) -> str`: Generates a hash of the message content using SHA-256.
  - `_cleanup(self) -> None`: Removes expired entries from the seen messages dictionary to ensure memory efficiency.
  - `__call__(self, message: Message, next_: SendFunc) -> None`: The main method that checks if a message has been sent recently and calls the next middleware function only if necessary.

### How it Fits into the Project
This file is part of the Telehook project's middleware layer. It ensures that messages are not repeatedly sent within a specified time window, enhancing the reliability and efficiency of the messaging system. The `Dedup` class is designed to be easily integrated with other message handling components in the Telehook framework.

### Notable Design Decisions
- **Hashing**: Uses SHA-256 to generate a hash of the message content, ensuring that only messages with identical text are considered duplicates.
- **Time Window**: Implements a sliding window mechanism to track recent messages and remove old entries efficiently using a context manager-like approach in `_cleanup`.
- **Asynchronous Handling**: Utilizes asynchronous functions to handle message processing without blocking other operations, maintaining performance even under high load.

---

*Generated by CodeWorm on 2026-03-01 08:01*
