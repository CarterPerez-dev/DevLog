# retry

**Type:** File Overview
**Repository:** Telehook
**File:** src/telehook/middleware/retry.py
**Language:** python
**Lines:** 1-40
**Complexity:** 0.0

---

## Source Code

```python
"""
Â©AngelaMos | 2026
retry.py
"""

import asyncio

from telehook.message import Message
from telehook.middleware.base import SendFunc
from telehook.transport import TelegramAPIError


class Retry:
    def __init__(self, max_attempts: int = 3, initial_backoff: float = 2.0):
        self._max_attempts = max_attempts
        self._initial_backoff = initial_backoff

    async def __call__(self, message: Message, next_: SendFunc) -> None:
        last_error: TelegramAPIError | None = None

        for attempt in range(self._max_attempts):
            try:
                await next_(message)
                return
            except TelegramAPIError as e:
                if e.status_code < 500 and e.status_code != 429:
                    raise

                last_error = e

                if attempt < self._max_attempts - 1:
                    if e.retry_after:
                        delay = min(e.retry_after, 60)
                    else:
                        delay = self._initial_backoff * (2**attempt)
                    await asyncio.sleep(delay)

        if last_error:
            raise last_error

```

---

## File Overview

## retry.py

**Purpose and Responsibility:**
This file implements a retry mechanism for sending messages using the Telegram API. It handles transient errors by automatically retrying failed message sends, with exponential backoff to avoid overwhelming the API.

**Key Exports or Public Interface:**
- `Retry`: A class that encapsulates the retry logic. It is responsible for managing retries and backoff delays.
  - `__init__(self, max_attempts: int = 3, initial_backoff: float = 2.0)`: Initializes the retry mechanism with a specified maximum number of attempts and an initial delay.

**How it Fits in the Project:**
This module is part of the `telehook.middleware` package, which provides various middleware functions to enhance message handling. The `Retry` class is used by other middleware or transport layers to ensure messages are sent reliably despite API errors.

**Notable Design Decisions:**
- **Exponential Backoff:** Uses an exponential backoff strategy to delay retries, starting with a small initial delay and doubling the delay for each subsequent attempt.
- **Error Handling:** Only retries on certain error statuses (500 series and 429 Too Many Requests) and raises other errors immediately.
- **Asynchronous Operation:** Utilizes `asyncio.sleep` to pause execution between retry attempts, ensuring non-blocking behavior.
```

This documentation provides a concise overview of the file's role within the project, its key components, and important design choices.

---

*Generated by CodeWorm on 2026-03-01 09:11*
