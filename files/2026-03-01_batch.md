# batch

**Type:** File Overview
**Repository:** Telehook
**File:** src/telehook/middleware/batch.py
**Language:** python
**Lines:** 1-60
**Complexity:** 0.0

---

## Source Code

```python
"""
Â©AngelaMos | 2026
batch.py
"""

import asyncio

from telehook.message import Message
from telehook.middleware.base import SendFunc


class Batch:
    def __init__(self, window_seconds: float = 5.0, max_size: int = 10):
        self._window = window_seconds
        self._max_size = max_size
        self._buffer: list[Message] = []
        self._next: SendFunc | None = None
        self._timer: asyncio.TimerHandle | None = None

    async def __call__(self, message: Message, next_: SendFunc) -> None:
        self._next = next_
        self._buffer.append(message)

        if len(self._buffer) >= self._max_size:
            await self.flush()
            return

        if self._timer is None:
            loop = asyncio.get_running_loop()
            self._timer = loop.call_later(
                self._window,
                lambda: asyncio.ensure_future(self.flush()),
            )

    async def flush(self) -> None:
        if self._timer is not None:
            self._timer.cancel()
            self._timer = None

        if not self._buffer or self._next is None:
            return

        messages = self._buffer[:]
        self._buffer.clear()

        if len(messages) == 1:
            await self._next(messages[0])
            return

        combined_text = "\n\n---\n\n".join(m.text for m in messages)
        combined = Message(
            text = combined_text,
            parse_mode = messages[0].parse_mode,
            metadata = {"batched_count": len(messages)},
        )
        await self._next(combined)

    async def close(self) -> None:
        await self.flush()

```

---

## File Overview

# batch.py Documentation

## Purpose and Responsibility
This file defines a `Batch` class responsible for batching messages to be sent over time, ensuring that no more than a specified number of messages are sent within a given window period. This helps in managing message throughput and reducing the load on external services.

## Key Exports and Public Interface
- **Class: Batch**
  - **Constructor**: Initializes the batch with a window size and maximum buffer size.
  - **Methods**:
    - `__call__(self, message: Message, next_: SendFunc) -> None`: Adds messages to the buffer and schedules flushing if necessary.
    - `flush(self) -> None`: Flushes the buffered messages at the end of the window or when the buffer reaches its maximum size.
    - `close(self) -> None`: Ensures all buffered messages are sent before closing.

## How It Fits in the Project
The `Batch` class is part of the `telehook.middleware.base` module, which handles message processing and sending. This class works closely with other middleware components to manage and optimize message delivery, ensuring that messages are sent efficiently without overwhelming the system or external services.

## Notable Design Decisions
- **Asynchronous Handling**: The class uses asynchronous methods (`__call__`, `flush`) to handle message buffering and flushing.
- **Buffer Management**: Messages are buffered until either the buffer reaches its maximum size or the specified window period elapses, ensuring efficient use of resources.
- **Scheduling**: Utilizes asyncio's `call_later` for scheduling flush operations, allowing precise control over when messages are sent.

---

*Generated by CodeWorm on 2026-03-01 00:25*
