# search

**Type:** File Overview
**Repository:** vuemantics
**File:** backend/routers/v1/search.py
**Language:** python
**Lines:** 1-302
**Complexity:** 0.0

---

## Source Code

```python
"""
ⒸAngelaMos | 2026
search.py
"""

import logging
from typing import Annotated

from fastapi import (
    APIRouter,
    Depends,
    Query,
    Request,
)

import config
from config import settings
from auth import (
    get_current_user,
    verify_upload_ownership,
)
from core import (
    AUTH_401,
    NOT_FOUND_404,
    RATE_LIMIT_420,
    SERVER_ERROR_500,
    VALIDATION_422,
    ValidationError,
    limiter,
)
from models.Upload import ProcessingStatus, Upload
from models.User import User
from schemas import (
    SearchRequest,
    SearchResponse,
    SearchResult,
)
from services.search_service import search_service


logger = logging.getLogger(__name__)

router = APIRouter(
    prefix = "/search",
    tags = ["search"],
    responses = {
        **AUTH_401,
        **NOT_FOUND_404,
        **VALIDATION_422,
        **RATE_LIMIT_420,
        **SERVER_ERROR_500,
    },
)


@router.post(
    "",
    response_model = SearchResponse,
    summary = "Search uploads",
    description = "Search through uploads using natural language queries",
)
@limiter.limit(settings.rate_limit_search)
async def search_uploads(
    request: Request,
    search_request: SearchRequest,
    current_user: Annotated[User,
                            Depends(get_current_user)],
) -> SearchResponse:
    """
    Perform semantic search on user's uploads

    The search uses AI-generated embeddings to find uploads
    that match the semantic meaning of your query.

    Example queries:
    - "sunset at the beach"
    - "funny cat videos"
    - "birthday party with friends"
    - "cooking in the kitchen"

    Supports filtering by:
    - File type (image/video)
    - Date range
    - Similarity threshold
    """
    try:
        # Log search for analytics (but don't store query for privacy)
        logger.info(
            f"User {current_user.id} searching with "
            f"{len(search_request.query)} char query"
        )

        # Check if user has any uploads
        upload_count = await Upload.count({"user_id": current_user.id})
        if upload_count == 0:
            return SearchResponse(
                results = [],
                total_found = 0,
                returned_count = 0,
                search_time_ms = 0.0,
                query = search_request.query,
                query_embedding_generated = False,
                applied_filters = None,
            )

        # Perform search (limited to user's uploads by default)
        response = await search_service.search(
            request = search_request,
            user_id = current_user.id
        )

        # Log search metrics
        logger.info(
            f"Search completed: {response.returned_count} results "
            f"in {response.search_time_ms:.1f}ms"
        )

        return response

    except Exception as e:
        logger.error(f"Search failed for user {current_user.id}: {e}")
        raise


@router.get(
    "/similar/{upload_id}",
    response_model = list[SearchResul
```

---

## File Overview

### search.py

**Purpose & Responsibility:**
This file defines the `/search` API endpoints for semantic search functionality, including searching uploads, finding similar uploads, and providing search suggestions. It leverages FastAPI for routing and integrates with a custom `search_service` for performing complex searches.

**Key Exports & Public Interface:**
- **Endpoints:**
  - `POST /search`: Performs semantic search on user's uploads.
  - `GET /similar/{upload_id}`: Finds similar uploads to a specific upload.
  - `GET /suggestions`: Provides search query suggestions based on partial input.

**How it Fits in the Project:**
This file is part of the backend API layer, specifically handling search-related functionalities. It interacts with user authentication and authorization services through dependencies like `get_current_user` and `verify_upload_ownership`. The responses are formatted using custom response models to ensure consistency across the application.

**Notable Design Decisions:**
- **Rate Limiting:** Uses FastAPI's `limiter` to enforce rate limits on search requests.
- **Dependency Injection:** Utilizes dependency injection for user authentication, ensuring secure and consistent access control.
- **Logging:** Logs detailed information about searches for analytics purposes without storing sensitive query data.
```

This documentation provides a high-level overview of the file’s role in the project, its key components, and important design choices.

---

*Generated by CodeWorm on 2026-02-20 12:51*
