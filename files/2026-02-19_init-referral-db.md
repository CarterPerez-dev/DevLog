# init_referral_db

**Type:** File Overview
**Repository:** CertGames-Core
**File:** backend/devtools/scripts/init_referral_db.py
**Language:** python
**Lines:** 1-205
**Complexity:** 0.0

---

## Source Code

```python
"""
Referral Database Initialization Script
/devtools/scripts/init_referral_db.py

Run this ONCE to set up the referral database with:
1. Create all tables (via SQLAlchemy)
2. Create initial RECURRING referral program
3. Verify setup

Usage:
    python devtools/scripts/init_referral_db.py
"""

import os
import sys
from pathlib import Path


backend_dir = Path(__file__).resolve().parent.parent.parent
sys.path.insert(0, str(backend_dir))

from dotenv import load_dotenv


env_file = backend_dir / f'.env.{os.getenv("ENVIRONMENT", "development")}'
load_dotenv(env_file)
print(f"[*] Loaded environment: {env_file.name}")

from stripe_referral.services import PayoutService
from stripe_referral.config.enums import AdapterType, RewardType, CurrencyCode
from api.core.database.referral_db import (
    init_referral_db,
    get_referral_db,
)


BANNER = """
╔══════════════════════════════════════════════════════════════╗
║                                                              ║
║   CertGames Referral System Database Initialization         ║
║                                                              ║
╚══════════════════════════════════════════════════════════════╝
"""


def create_referral_program():
    """
    Create the main CertGames recurring referral program

    Program Configuration:
    - $5/month RECURRING reward (50% of $10 subscription)
    - Unlimited referrals per user
    - No conversion window (always valid)
    - Manual payout adapter (collect bank info, pay manually)
    """
    print("\n[*] Creating referral program...")

    db = get_referral_db()

    try:
        program = PayoutService.create_program(
            db = db,
            name = "CertGames Subscription Referral",
            program_key = "certgames_sub",
            reward_amount = 5.00,
            reward_currency = CurrencyCode.USD.value,
            reward_type = RewardType.RECURRING.value,
            adapter_type = AdapterType.MANUAL.value,
            max_rewards_per_user = None,
            conversion_window_days = None,
            adapter_config = {}
        )

        db.commit()

        print(f"[+] Program created successfully!")
        print(f"    ID: {program['id']}")
        print(f"    Key: {program['program_key']}")
        print(
            f"    Reward: ${program['reward_amount']:.2f} {program['reward_currency']} (RECURRING)"
        )
        print(f"    Active: {program['is_active']}")

        return program

    except Exception as e:
        db.rollback()
        print(f"[!] Failed to create program: {str(e)}")
        raise
    finally:
        db.close()


def verify_setup():
    """
    Verify database tables and program creation
    """
    print("\n[*] Verifying setup...")

    db = get_referral_db()

    try:
        from stripe_referral.repositories.program_repo import ReferralProgramRepository

        program_repo = ReferralProgramRepository(db)
        program = program_repo.get_by_key("certgames_sub")

        if not program:
 
```

---

## File Overview

# init_referral_db.py

**Purpose & Responsibility:**
This script initializes the referral database for CertGames by creating necessary tables, setting up a recurring referral program, and verifying the setup.

**Key Exports & Public Interface:**
- `create_referral_program()`: Creates the main CertGames referral program.
- `verify_setup()`: Verifies that the database tables and referral programs are correctly set up.

**How It Fits in the Project:**
This script is executed ONCE during deployment to ensure the referral system is properly configured. It uses SQLAlchemy for database operations, Stripe services for reward management, and environment variables for configuration.

**Notable Design Decisions:**
- **Environment Configuration**: Uses `.env` files based on the current environment (development, production).
- **Database Initialization**: Utilizes `init_referral_db()` to establish a connection before performing any operations.
- **Error Handling**: Includes comprehensive error handling and rollback mechanisms to ensure database integrity.
- **Program Creation & Verification**: Ensures that the referral program is created with specific configurations and verifies its existence in the database.
```

This documentation provides an overview of the script's role, key functions, integration within the project, and important design choices.

---

*Generated by CodeWorm on 2026-02-19 11:21*
