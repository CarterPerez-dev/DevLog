# api

**Type:** File Overview
**Repository:** CodeWorm
**File:** dashboard/backend/api.py
**Language:** python
**Lines:** 1-256
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2026
dashboard/backend/api.py
"""
from __future__ import annotations

import os
import sqlite3
from pathlib import Path

from fastapi import APIRouter, Query

from dashboard.backend.models import (
    ActivityDay,
    LanguageBreakdown,
    RecentDoc,
    RepoStatus,
    StatsResponse,
)

router = APIRouter()


def _get_db_path() -> Path:
    return Path(os.environ.get("CODEWORM_DB_PATH", "data/codeworm.db"))


def _get_conn() -> sqlite3.Connection:
    conn = sqlite3.connect(_get_db_path())
    conn.row_factory = sqlite3.Row
    return conn


def _has_column(conn: sqlite3.Connection, table: str, column: str) -> bool:
    cursor = conn.execute(f"PRAGMA table_info({table})")
    return column in {row[1] for row in cursor.fetchall()}


@router.get("/stats", response_model=StatsResponse)
async def get_stats() -> StatsResponse:
    db = _get_db_path()
    if not db.exists():
        return StatsResponse()

    with _get_conn() as conn:
        total = conn.execute(
            "SELECT COUNT(*) FROM documented_snippets"
        ).fetchone()[0]

        by_repo = dict(conn.execute(
            "SELECT source_repo, COUNT(*) FROM documented_snippets "
            "GROUP BY source_repo"
        ).fetchall())

        if _has_column(conn, "documented_snippets", "doc_type"):
            by_doc_type = dict(conn.execute(
                "SELECT doc_type, COUNT(*) FROM documented_snippets "
                "GROUP BY doc_type"
            ).fetchall())
        else:
            by_doc_type = {"function_doc": total}

        last_7 = conn.execute(
            "SELECT COUNT(*) FROM documented_snippets "
            "WHERE documented_at > datetime('now', '-7 days')"
        ).fetchone()[0]

        last_30 = conn.execute(
            "SELECT COUNT(*) FROM documented_snippets "
            "WHERE documented_at > datetime('now', '-30 days')"
        ).fetchone()[0]

        today = conn.execute(
            "SELECT COUNT(*) FROM documented_snippets "
            "WHERE date(documented_at) = date('now')"
        ).fetchone()[0]

        lang_rows = conn.execute(
            "SELECT "
            "CASE "
            "  WHEN source_file LIKE '%.py' THEN 'python' "
            "  WHEN source_file LIKE '%.ts' THEN 'typescript' "
            "  WHEN source_file LIKE '%.tsx' THEN 'tsx' "
            "  WHEN source_file LIKE '%.js' THEN 'javascript' "
            "  WHEN source_file LIKE '%.go' THEN 'go' "
            "  WHEN source_file LIKE '%.rs' THEN 'rust' "
            "  ELSE 'other' "
            "END AS lang, COUNT(*) "
            "FROM documented_snippets GROUP BY lang"
        ).fetchall()
        by_language = dict(lang_rows)

    return StatsResponse(
        total_documented=total,
        by_repo=by_repo,
        by_language=by_language,
        by_doc_type=by_doc_type,
        last_7_days=last_7,
        last_30_days=last_30,
        today=today,
    )


@router.get("/repos", response_model=list[RepoStatus])
async def get_repos() -> list[R
```

---

## File Overview

### Purpose and Responsibility

This Python source file, `api.py`, is part of the backend API for CodeWorm, a tool designed to document code snippets. It defines routes for retrieving statistics about documented code, listing repositories with their documentation status, and fetching recent documented snippets.

### Key Exports and Public Interface

- **`/stats`**: Returns statistical data on documented code, including total documents, by repository, language, doc type, and activity over the last 7 days, 30 days, and today.
- **`/repos`**: Lists repositories with their documentation status, including the path, weight, enabled status, number of generated docs, and last activity date.
- **`/recent`**: Fetches recent documented snippets based on optional filters such as repository name and document type.

### How It Fits into the Project

This file serves as a crucial component of CodeWorm's backend API. The `APIRouter` defines endpoints that interact with the database to provide insights and data about code documentation activities. These endpoints are accessed via HTTP requests, enabling frontend applications or other services to retrieve necessary information for analytics and user feedback.

### Notable Design Decisions

- **Database Interactions**: Utilizes SQLite3 for local storage, ensuring efficient and straightforward data access.
- **Column Existence Check**: Uses a helper function `_has_column` to dynamically check if certain columns exist in the database tables, enhancing flexibility.
- **Type Hints and Annotations**: Employed extensively throughout the code to ensure type safety and clarity.
- **Context Managers**: Used for managing database connections (`_get_conn`) to ensure proper handling of resources.

---

*Generated by CodeWorm on 2026-02-21 07:19*
