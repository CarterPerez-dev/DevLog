# audit

**Type:** File Overview
**Repository:** CertGames-Core
**File:** backend/api/core/services/logging/audit.py
**Language:** python
**Lines:** 1-228
**Complexity:** 0.0

---

## Source Code

```python
"""
Audit logging utility using MongoEngine
/api/core/services/logging/audit.py
"""

from typing import Any
from datetime import datetime, UTC
from flask import current_app, g, request, session

from api.admin.models.audit.AuditLog import AuditLog


class AuditLogger:
    """
    Centralized audit logging service using MongoEngine
    """
    @staticmethod
    def _extract_request_info() -> dict[str, Any]:
        """
        Extract information from the current request
        """
        try:
            if not request or not request.method:
                return {}
        except RuntimeError:
            return {}

        info = {
            "ip_address": request.remote_addr,
            "user_agent": request.headers.get("User-Agent",
                                              "")[: 500],
            "endpoint": request.endpoint,
            "method": request.method,
            "request_id": getattr(g,
                                  'request_id',
                                  None),
        }

        try:
            if session:
                info["session_id"] = session.get('session_id')
        except Exception:
            info["session_id"] = None

        return info

    @staticmethod
    def _calculate_response_time(provided_time: int | None) -> int | None:
        """
        Calculate response time if not provided
        """
        if provided_time is not None:
            return provided_time

        if hasattr(g, "start_time"):
            return int(
                (datetime.now(UTC).timestamp() - g.start_time) * 1000
            )

        return None

    @staticmethod
    def _build_audit_data(
        base_data: dict[str,
                        Any] | None,
        request_info: dict[str,
                           Any],
        response_time: int | None,
        status_code: int | None,
    ) -> dict[str,
              Any]:
        """
        Build the audit data dictionary
        """
        audit_data = base_data or {}

        skip_fields = {
            "ip_address",
            "user_agent",
            "endpoint",
            "method",
            "request_id",
            "session_id"
        }

        for key, value in request_info.items():
            if value and key not in skip_fields:
                audit_data[key] = value

        if response_time is not None:
            audit_data["response_time_ms"] = response_time
        if status_code is not None:
            audit_data["status_code"] = status_code

        return audit_data

    @staticmethod
    def log_action(
        action: str,
        user_id: str | None = None,
        data: dict[str,
                   Any] | None = None,
        status_code: int | None = None,
        response_time: int | None = None,
    ) -> AuditLog | None:
        """
        Log an action to the audit trail.
        """
        try:
            request_info = AuditLogger._extract_request_info()

            actual_response_time = AuditLogger._calcul
```

---

## File Overview

## audit.py

### Purpose and Responsibility
This Python source file provides a centralized audit logging service using MongoEngine, designed to capture and log various actions, database operations, and authentication events within the CertGames-Core application.

### Key Exports and Public Interface
- **AuditLogger**: A class responsible for logging different types of actions.
  - `log_action(action: str, user_id: str | None = None, data: dict[str, Any] | None = None, status_code: int | None = None, response_time: int | None = None) -> AuditLog | None`: Logs an action with optional user ID, data, status code, and response time.
  - `log_database_timing(collection_name: str, operation: str, duration: float) -> AuditLog | None`: Logs database operations timing.
  - `log_auth_event(event_type: str, user_id: str | None = None, success: bool = True, details: dict[str, Any] | None = None) -> AuditLog | None`: Logs authentication events.

### How it Fits into the Project
This file is part of the `/api/core/services/logging` module and integrates with other services to provide comprehensive logging. It ensures that all significant actions within the application are recorded for auditing purposes, contributing to the overall security and traceability of the system.

### Notable Design Decisions
- **Centralized Logging**: The `AuditLogger` class centralizes logging logic, making it easier to manage and extend.
- **Request Information Extraction**: Uses `_extract_request_info()` to gather relevant request details such as IP address, user agent, and endpoint.
- **Response Time Calculation**: Automatically calculates response time if not provided, ensuring accurate logging of performance metrics.
- **Error Handling**: Logs errors gracefully using Flask's `current_app.logger`, preventing failures from disrupting the application flow.

---

*Generated by CodeWorm on 2026-02-19 08:59*
