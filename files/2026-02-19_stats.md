# stats

**Type:** File Overview
**Repository:** angelamos-operations
**File:** Docker-Kentros/internal/docker/stats.go
**Language:** go
**Lines:** 1-206
**Complexity:** 0.0

---

## Source Code

```go
/*
AngelaMos | 2026
stats.go
*/

package docker

import (
	"context"
	"encoding/json"
	"fmt"
	"io"
	"sync"
	"time"

	"github.com/docker/docker/api/types/container"

	"github.com/carterperez-dev/holophyly/internal/model"
)

type StatsCollector struct {
	client    *Client
	prevStats map[string]*container.StatsResponse
	mu        sync.RWMutex
}

// NewStatsCollector creates a collector that tracks previous stats for delta calculations.
func NewStatsCollector(client *Client) *StatsCollector {
	return &StatsCollector{
		client:    client,
		prevStats: make(map[string]*container.StatsResponse),
	}
}

// GetStats retrieves current stats for a container with proper CPU percentage calculation.
// The Docker API returns cumulative CPU values, so we calculate delta from previous reading.
func (s *StatsCollector) GetStats(
	ctx context.Context,
	containerID string,
) (*model.ContainerStats, error) {
	s.client.mu.RLock()
	cli := s.client.cli
	s.client.mu.RUnlock()

	resp, err := cli.ContainerStats(ctx, containerID, false)
	if err != nil {
		return nil, fmt.Errorf("getting stats for %s: %w", containerID, err)
	}
	defer func() { _ = resp.Body.Close() }()

	var stats container.StatsResponse
	if err := json.NewDecoder(resp.Body).Decode(&stats); err != nil {
		return nil, fmt.Errorf("decoding stats for %s: %w", containerID, err)
	}

	s.mu.Lock()
	prev := s.prevStats[containerID]
	s.prevStats[containerID] = &stats
	s.mu.Unlock()

	return calculateStats(prev, &stats), nil
}

// StreamStats continuously streams stats for a container.
// Returns a channel that receives stats updates until context is cancelled.
func (s *StatsCollector) StreamStats(
	ctx context.Context,
	containerID string,
) (<-chan *model.ContainerStats, <-chan error) {
	statsCh := make(chan *model.ContainerStats)
	errCh := make(chan error, 1)

	go func() {
		defer close(statsCh)
		defer close(errCh)

		s.client.mu.RLock()
		cli := s.client.cli
		s.client.mu.RUnlock()

		resp, err := cli.ContainerStats(ctx, containerID, true)
		if err != nil {
			errCh <- fmt.Errorf("streaming stats for %s: %w", containerID, err)
			return
		}
		defer func() { _ = resp.Body.Close() }()

		decoder := json.NewDecoder(resp.Body)
		var prev *container.StatsResponse

		for {
			select {
			case <-ctx.Done():
				return
			default:
			}

			var stats container.StatsResponse
			if err := decoder.Decode(&stats); err != nil {
				if err == io.EOF {
					return
				}
				errCh <- fmt.Errorf("decoding streamed stats: %w", err)
				return
			}

			calculated := calculateStats(prev, &stats)
			prev = &stats

			select {
			case statsCh <- calculated:
			case <-ctx.Done():
				return
			}
		}
	}()

	return statsCh, errCh
}

// calculateStats converts raw Docker stats to our ContainerStats format.
// CPU percentage requires delta calculation between consecutive readings.
func calculateStats(prev, curr *container.StatsResponse) *model.ContainerStats {
	if curr == nil {
		return nil
	}

	stats := &model.ContainerStats{
		MemoryUsage:
```

---

## File Overview

# stats.go

## Purpose and Responsibility
This file contains the `StatsCollector` struct, which is responsible for collecting and processing Docker container statistics. It handles both one-time stat retrieval and continuous streaming of stats updates.

## Key Exports and Public Interface
- **NewStatsCollector**: Creates a new `StatsCollector` instance.
- **GetStats**: Retrieves current stats for a container by calculating deltas from previous readings.
- **StreamStats**: Streams stats updates for a container in real-time, returning channels for receiving stats and handling errors.
- **calculateStats**: Converts raw Docker stats to our internal `ContainerStats` format.
- **calculateCPUPercent**: Computes CPU usage percentage from cumulative values.
- **ClearPreviousStats**: Removes stored previous stats for a stopped or removed container.

## How It Fits in the Project
The `StatsCollector` is part of the `docker` package, which provides functionality to interact with Docker containers. This file integrates closely with other components that require real-time monitoring and analysis of container performance metrics.

## Notable Design Decisions
- **Delta Calculation**: The `GetStats` and `StreamStats` methods use delta calculations to provide meaningful CPU usage percentages.
- **Concurrency**: Goroutines are used in the `StreamStats` method for handling continuous streaming, ensuring non-blocking behavior.
- **Error Handling**: Proper error handling is implemented throughout, with clear error messages and appropriate channel management.
```

This documentation covers the high-level purpose of the file, its key exports, how it fits into the project, and notable design decisions.

---

*Generated by CodeWorm on 2026-02-19 18:55*
