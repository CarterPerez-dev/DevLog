# conftest

**Type:** File Overview
**Repository:** angelamos-operations
**File:** CarterOS-Server/conftest.py
**Language:** python
**Lines:** 1-285
**Complexity:** 0.0

---

## Source Code

```python
"""
Â©AngelaMos | 2025
conftest.py

Test configuration, fixtures, and factories
"""

import hashlib
import secrets
from datetime import (
    UTC,
    datetime,
    timedelta,
)
from uuid import uuid4
from collections.abc import AsyncIterator

import pytest
from httpx import (
    AsyncClient,
    ASGITransport,
)
import pytest_asyncio
from sqlalchemy.ext.asyncio import (
    AsyncSession,
    create_async_engine,
)
from sqlalchemy.pool import StaticPool

from core.security.auth.jwt import (
    hash_password,
    create_access_token,
)
from config import UserRole
from core.infrastructure.database.session import get_db_session

from core.infrastructure.database.Base import Base
from aspects.auth.models.User import User
from aspects.auth.models.RefreshToken import RefreshToken


@pytest_asyncio.fixture(scope = "session", loop_scope = "session")
async def test_engine():
    """
    Session scoped async engine with in memory SQLite
    StaticPool keeps single connection so DB persists
    """
    engine = create_async_engine(
        "sqlite+aiosqlite:///:memory:",
        poolclass = StaticPool,
        connect_args = {"check_same_thread": False},
        echo = False,
    )
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    yield engine
    await engine.dispose()


@pytest.fixture
async def db_session(test_engine) -> AsyncIterator[AsyncSession]:
    """
    Per test session with transaction rollback for isolation
    App commits become savepoints that rollback with test
    """
    async with test_engine.connect() as conn:
        await conn.begin()

        session = AsyncSession(
            bind = conn,
            expire_on_commit = False,
            join_transaction_mode = "create_savepoint",
        )

        yield session

        await session.close()
        await conn.rollback()


@pytest.fixture
async def client(db_session: AsyncSession) -> AsyncIterator[AsyncClient]:
    """
    Async HTTP client with DB session override
    """
    from src.__main__ import app

    async def override_get_db():
        yield db_session

    app.dependency_overrides[get_db_session] = override_get_db

    async with AsyncClient(
            transport = ASGITransport(app = app),
            base_url = "http://test",
    ) as ac:
        yield ac

    app.dependency_overrides.clear()


@pytest.fixture
def auth_headers(access_token: str) -> dict[str, str]:
    """
    Authorization headers for authenticated requests
    """
    return {"Authorization": f"Bearer {access_token}"}


@pytest.fixture
def admin_auth_headers(admin_access_token: str) -> dict[str, str]:
    """
    Authorization headers for admin requests
    """
    return {"Authorization": f"Bearer {admin_access_token}"}


class UserFactory:
    """
    Factory for creating test users
    """
    _counter = 0

    @classmethod
    async def create(
        cls,
        session: AsyncSession,
        *,
        email: str | None = None,
        passwor
```

---

## File Overview

**File Purpose and Responsibility:**
This `conftest.py` file serves as a central configuration for pytest fixtures, factories, and utilities used across multiple test modules within the project. It sets up an in-memory SQLite database with transactional isolation to ensure clean testing environments.

**Key Exports or Public Interface:**
- **Fixtures:** `test_engine`, `db_session`, `client`, `auth_headers`, `admin_auth_headers`, `UserFactory`, and `RefreshTokenFactory`.
- **Factories:** `UserFactory` for creating test users, and `RefreshTokenFactory` for generating refresh tokens.
  
**How it Fits in the Project:**
This file is crucial as it provides a consistent setup for database interactions and HTTP client testing. The fixtures ensure that each test runs in an isolated environment, preventing side effects between tests. The factories simplify the creation of test data, making the tests more maintainable.

**Notable Design Decisions:**
- **Session Scope Engine:** Using `StaticPool` to keep a single connection open for the entire session, ensuring database state persistence.
- **Transaction Rollback:** Each test uses a savepoint transaction that rolls back at the end of the test, maintaining clean states between tests.
- **Dependency Override:** The `client` fixture overrides the dependency injection to use the test session in the HTTP client, facilitating seamless integration testing.
```

This documentation covers the high-level purpose and responsibilities of the file, its key exports, how it integrates into the project, and highlights some notable design decisions.

---

*Generated by CodeWorm on 2026-02-19 18:04*
