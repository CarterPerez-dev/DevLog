# redis

**Type:** File Overview
**Repository:** CertGames-Core
**File:** backend/app/engine/redis.py
**Language:** python
**Lines:** 1-144
**Complexity:** 0.0

---

## Source Code

```python
"""
Redis Connection Pool Setup
/app/engine/redis.py
"""

from flask import Flask

import redis
from redis.retry import Retry
from redis.connection import ConnectionPool
from redis.backoff import ExponentialBackoff
from settings import Redis


def setup_redis(app: Flask) -> None:
    """
    Redis connection with connection pooling, retries, and health monitoring
    """
    redis_url = app.config.get(
        'REDIS_URL',
        f'redis://{Redis.DEFAULT_HOST}:{Redis.DEFAULT_PORT}/{Redis.DEFAULT_DB}'
    )
    redis_password = app.config.get('REDIS_PASSWORD')

    try:
        pool = ConnectionPool.from_url(
            redis_url,
            password = redis_password,
            decode_responses = True,
            max_connections = Redis.MAX_CONNECTIONS,
            retry_on_timeout = True,
            retry_on_error = [
                redis.ConnectionError,
                redis.TimeoutError,
                redis.BusyLoadingError
            ],
            retry = Retry(
                ExponentialBackoff(
                    cap = Redis.RETRY_BACKOFF_CAP,
                    base = Redis.RETRY_BACKOFF_BASE
                ),
                retries = Redis.RETRY_COUNT
            ),
            socket_keepalive = True,
            socket_keepalive_options = {},
            health_check_interval = Redis.HEALTH_CHECK_INTERVAL,
            socket_connect_timeout = Redis.SOCKET_CONNECT_TIMEOUT,
            socket_read_size = 65536,
        )

        redis_client = redis.StrictRedis(
            connection_pool = pool,
            socket_connect_timeout = Redis.SOCKET_CONNECT_TIMEOUT,
            socket_timeout = Redis.SOCKET_TIMEOUT,
        )

        _validate_redis_connection(redis_client, app.logger)

        app.extensions["redis_client"] = redis_client
        app.logger.info(
            f"Redis client initialized successfully: {redis_url} "
            f"(pool_size={Redis.MAX_CONNECTIONS}, health_check={Redis.HEALTH_CHECK_INTERVAL}s)"
        )

    except (redis.ConnectionError,
            redis.TimeoutError,
            redis.RedisError,
            OSError,
            ValueError) as e:
        app.logger.error(
            f"Failed to initialize optimized Redis client: {str(e)}"
        )
        app.extensions["redis_client"] = _fallback_redis_client(
            redis_url,
            redis_password,
            app.logger
        )


def _validate_redis_connection(
    redis_client: redis.StrictRedis,
    logger
) -> None:
    """
    Redis connection validation
    """
    ping_result = redis_client.ping()
    if not ping_result:
        raise redis.ConnectionError("Redis ping failed")

    test_key = Redis.HEALTH_CHECK_TEST_KEY
    redis_client.setex(
        test_key,
        Redis.HEALTH_CHECK_TEST_TTL,
        Redis.HEALTH_CHECK_TEST_VALUE
    )

    if redis_client.get(test_key) != Redis.HEALTH_CHECK_TEST_VALUE:
        raise redis.ConnectionError("Redis read/write test failed")

    redis_client.delete(test_key)

    t
```

---

## File Overview

# Redis Connection Pool Setup

**Purpose:**
This Python file sets up a connection pool for Redis, ensuring robust and efficient handling of database interactions within the application.

**Key Exports/Interface:**
- `setup_redis(app: Flask)`: Initializes a Redis client with retries, health checks, and connection pooling.
- `_validate_redis_connection(redis_client: redis.StrictRedis, logger)`: Validates the Redis connection by performing ping and read/write tests.
- `_fallback_redis_client(redis_url: str, redis_password: str | None, logger)`: Provides a fallback Redis client when the primary setup fails.

**Project Integration:**
This file is crucial for database operations in the Flask application. It initializes the `redis_client` as an extension of the Flask app and handles retries and health checks to ensure reliable database interactions. The setup function is called during the application startup, making it a key component for initializing database connections.

**Design Decisions:**
- **Connection Pooling**: Utilizes `ConnectionPool` with configurable parameters like max_connections, retry strategies, and socket options.
- **Health Checks**: Implements ping tests and read/write validations to ensure the Redis server is operational.
- **Fallback Mechanism**: Provides a fallback client configuration when initial setup fails, ensuring application availability even under adverse conditions.

This file plays a critical role in maintaining database connectivity and reliability within the CertGames-Core project.

---

*Generated by CodeWorm on 2026-02-19 15:45*
