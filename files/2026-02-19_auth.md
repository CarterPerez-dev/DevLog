# auth

**Type:** File Overview
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/auth/routes/auth.py
**Language:** python
**Lines:** 1-165
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025
auth.py
"""

from typing import Annotated

from fastapi import (
    APIRouter,
    Cookie,
    Depends,
    Request,
    Response,
    status,
)
from fastapi.security import (
    OAuth2PasswordRequestForm,
)

from config import settings
from core.security.auth.dependencies import (
    ClientIP,
    CurrentUser,
    DBSession,
)
from core.security.auth.jwt import (
    clear_refresh_cookie,
    set_refresh_cookie,
)
from core.security.rate_limit.limiter import limiter
from core.exceptions import TokenError
from aspects.auth.schemas.auth import (
    PasswordChange,
    TokenResponse,
    TokenWithUserResponse,
)
from aspects.auth.schemas.user import UserResponse
from aspects.auth.services.auth import AuthService
from aspects.auth.services.user import UserService
from core.foundation.responses import AUTH_401


router = APIRouter(prefix = "/auth", tags = ["auth"])


@router.post(
    "/login",
    response_model = TokenWithUserResponse,
    responses = {**AUTH_401}
)
@limiter.limit(settings.RATE_LIMIT_AUTH)
async def login(
    request: Request,
    response: Response,
    db: DBSession,
    ip: ClientIP,
    form_data: Annotated[OAuth2PasswordRequestForm,
                         Depends()],
) -> TokenWithUserResponse:
    """
    Login with email and password
    """
    result, refresh_token = await AuthService.login(
        db,
        email=form_data.username,
        password=form_data.password,
        ip_address=ip,
    )
    set_refresh_cookie(response, refresh_token)
    return result


@router.post(
    "/refresh",
    response_model = TokenResponse,
    responses = {**AUTH_401}
)
async def refresh_token(
    request: Request,
    response: Response,
    db: DBSession,
    ip: ClientIP,
    refresh_token: str | None = Cookie(None),
) -> TokenResponse:
    """
    Refresh access token
    """
    import logging
    logger = logging.getLogger(__name__)
    logger.info(f"Refresh endpoint hit - Cookie received: {refresh_token is not None}")
    logger.info(f"All cookies: {request.cookies}")

    if not refresh_token:
        raise TokenError("Refresh token required")
    result, new_refresh_token = await AuthService.refresh_tokens(
        db,
        refresh_token,
        ip_address = ip
    )
    set_refresh_cookie(response, new_refresh_token)
    return result


@router.post(
    "/logout",
    status_code = status.HTTP_204_NO_CONTENT,
    responses = {**AUTH_401}
)
async def logout(
    response: Response,
    db: DBSession,
    refresh_token: str | None = Cookie(None),
) -> None:
    """
    Logout current session
    """
    if not refresh_token:
        raise TokenError("Refresh token required")
    await AuthService.logout(db, refresh_token)
    clear_refresh_cookie(response)


@router.post("/logout-all", responses = {**AUTH_401})
async def logout_all(
    response: Response,
    db: DBSession,
    current_user: CurrentUser,
) -> dict[str,
          int]:
    """
    Logout from all devices
    """
    coun
```

---

## File Overview

### auth.py

**Purpose and Responsibility:**
This file is responsible for handling authentication-related endpoints, including user login, token refresh, logout, password change, and retrieving current user information. It integrates with FastAPI to provide secure and efficient authentication mechanisms.

**Key Exports or Public Interface:**
- **Endpoints:** `/auth/login`, `/auth/refresh`, `/auth/logout`, `/auth/logout-all`, `/auth/me`, `/auth/change-password`
- **Services:** `AuthService` for login, refresh tokens, logout, and managing sessions; `UserService` for changing user passwords.
- **Dependencies:** `ClientIP`, `CurrentUser`, `DBSession` to ensure secure and stateful operations.

**How it Fits in the Project:**
This file is part of the authentication module within the broader project structure. It leverages FastAPI's routing capabilities and integrates with a database session (`DBSession`) for persistent data storage. The endpoints are designed to be modular, allowing easy extension or modification as needed.

**Notable Design Decisions:**
- **Rate Limiting:** Implements rate limiting using `limiter` from the `core.security.rate_limit.limiter` module to prevent abuse.
- **Token Management:** Utilizes JWT tokens for secure authentication and refresh mechanisms. Tokens are managed via cookies, ensuring statelessness while maintaining user session integrity.
- **Security:** Ensures that sensitive operations like password changes and token revocation are handled securely by validating user credentials and managing sessions effectively.
```

This documentation provides a high-level overview of the file's purpose, key components, integration within the project, and notable design choices.

---

*Generated by CodeWorm on 2026-02-19 18:27*
