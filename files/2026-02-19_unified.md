# unified

**Type:** File Overview
**Repository:** CertGames-Core
**File:** backend/api/core/decorators/unified.py
**Language:** python
**Lines:** 1-198
**Complexity:** 0.0

---

## Source Code

```python
"""
Unified API Endpoint Decorator
/api/core/decorators/unified.py
"""

import time
import traceback
from typing import Any
from functools import wraps
from flask import g, request
from collections.abc import Callable

from ..services.logging import AuditLogger
from ..auth.auth_required import (
    auth_required as _auth_required,
)
from ..auth.subscription_required import (
    subscription_required as _subscription_required,
)
from ...domains.progression.services.streak_ops import StreakService
from ...domains.progression.services.progression_ops import ProgressionService


def api_endpoint(
    *,
    auth: bool = True,
    subscription: bool = False,
    audit: bool = True,
    audit_action: str | None = None,
    audit_data: dict | None = None,
    json_body: bool | None = None,
) -> Callable[[Callable[...,
                        Any]],
              Callable[...,
                       Any]]:
    """
    Unified decorator for API endpoints combining common middleware.
    """
    def decorator(f: Callable[..., Any]) -> Callable[..., Any]:
        @wraps(f)
        def decorated_function(*args: Any, **kwargs: Any) -> Any:
            """
            Used as @api_endpoint - audit | auth | subscription | json body
            """
            start_time: float = time.time()
            if json_body is None:
                expects_json: bool = request.method in [
                    "POST",
                    "PUT",
                    "PATCH"
                ]
            else:
                expects_json = json_body

            if expects_json:
                try:
                    g.json = request.get_json(
                        force = True,
                        silent = True
                    ) or {}
                except Exception:
                    g.json = {}
            else:
                g.json = {}

            if auth:

                @_auth_required
                def _temp_auth_check() -> None:
                    pass

                auth_result = _temp_auth_check()
                if auth_result is not None:

                    return auth_result

            if subscription:

                @_subscription_required
                def _temp_sub_check() -> None:
                    pass

                sub_result = _temp_sub_check()
                if sub_result is not None:
                    return sub_result

            if auth and hasattr(g, 'user') and g.user:
                try:
                    streak_result = StreakService.update_streak(g.user)
                    if streak_result["streak_updated"]:
                        daily_reward = StreakService.calculate_daily_reward(
                            streak_result["current_streak"]
                        )
                        ProgressionService.update_xp_and_coins(
                            g.user,
                            daily_reward["xp"],
                            daily_reward["coins"]
                        )
          
```

---

## File Overview

### Unified API Endpoint Decorator

**Purpose:**
This file defines a unified decorator for API endpoints, combining common middleware such as authentication, subscription validation, and logging. It ensures that all API endpoints can be easily decorated with these functionalities.

**Key Exports/Interface:**
- `api_endpoint`: A decorator function that combines multiple middleware functions (authentication, subscription validation, and audit logging) based on the provided flags.
  - Flags include `auth`, `subscription`, `audit`, `audit_action`, `audit_data`, and `json_body`.

**Project Integration:**
This decorator is used throughout the project to ensure consistent handling of API requests. It integrates with other modules like authentication services, subscription validation, and logging to provide a robust middleware layer for all endpoints.

**Design Decisions:**
- **Flexibility:** The decorator allows selective inclusion of middleware based on flags, making it highly flexible.
- **Modularity:** By using smaller decorators (`_auth_required`, `_subscription_required`) as sub-decorators, the main `api_endpoint` remains clean and focused.
- **Performance:** Timing is captured early in the request lifecycle to ensure minimal overhead. Errors are logged with detailed stack traces for better debugging.
- **Audit Logging:** Detailed logging is performed post-execution if enabled, capturing both successful requests and errors, ensuring comprehensive tracking of API usage.

This decorator plays a crucial role in maintaining consistency and security across all API endpoints in the CertGames-Core project.

---

*Generated by CodeWorm on 2026-02-19 11:30*
