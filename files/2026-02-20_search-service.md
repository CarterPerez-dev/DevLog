# search_service

**Type:** File Overview
**Repository:** vuemantics
**File:** backend/services/search_service.py
**Language:** python
**Lines:** 1-375
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2026
search_service.py
"""

import time
import asyncio
import logging
from uuid import UUID
from typing import Any

import config
from core import (
    QueryEmbeddingError,
)
from models.Upload import Upload
from schemas import (
    SearchRequest,
    SearchResponse,
    SearchResult,
)
from services.ai import local_ai_service


logger = logging.getLogger(__name__)


class SearchService:
    """
    Handles semantic search functionality

    Workflow:
    1. Generate embedding for search query using local bge-m3
    2. Find similar uploads using pgvector
    3. Apply additional filters
    4. Format and return results
    """
    def __init__(self) -> None:
        """
        Initialize search service
        """
        logger.info("Search service initialized")

    async def search(
        self,
        request: SearchRequest,
        user_id: UUID | None = None
    ) -> SearchResponse:
        """
        Perform semantic search on uploads

        Args:
            request: Search parameters including query and filters
            user_id: Optional user ID to limit search scope

        Returns:
            SearchResponse with ranked results
        """
        start_time = time.time()

        try:
            logger.info(
                f"Generating embedding for query: {request.query[:50]}..."
            )
            query_embedding = await self._generate_query_embedding(
                request.query
            )

            results = await self._search_uploads(
                query_embedding = query_embedding,
                user_id = user_id
                if request.user_id is None else request.user_id,
                limit = request.limit * config.SEARCH_RESULT_MULTIPLIER,
                similarity_threshold = request.similarity_threshold,
            )

            filtered_results = self._apply_filters(results, request)

            final_results = filtered_results[: request.limit]

            search_time_ms = (time.time() - start_time) * 1000

            response = SearchResponse(
                results = final_results,
                total_found = len(filtered_results),
                returned_count = len(final_results),
                search_time_ms = search_time_ms,
                query = request.query,
                query_embedding_generated = True,
                applied_filters = self._get_applied_filters(request),
            )

            logger.info(
                f"Search completed: {len(final_results)} results in {search_time_ms:.1f}ms"
            )
            return response

        except Exception as e:
            logger.error(f"Search failed: {e}")
            search_time_ms = (time.time() - start_time) * 1000
            return SearchResponse(
                results = [],
                total_found = 0,
                returned_count = 0,
                search_time_ms = search_time_ms,
                query = request.query,
                query_embedding_generated 
```

---

## File Overview

### search_service.py

**Purpose:**
This Python module implements a semantic search service for handling queries against uploaded content, leveraging embeddings and vector similarity searches.

**Key Exports & Public Interface:**
- `SearchService`: The primary class responsible for performing the search workflow.
  - `__init__`: Initializes the search service.
  - `search`: Asynchronously performs a semantic search based on provided request parameters.
  - `_generate_query_embedding`: Generates an embedding vector for the query text.
  - `_search_uploads`: Searches uploads using vector similarity.

**Project Fit:**
This file is part of the backend services layer, specifically designed to handle complex search operations. It interacts with `Upload` models and uses AI services for embedding generation, fitting into a larger system that processes user queries and returns relevant results.

**Design Decisions & Patterns:**
- **Asynchronous Operations:** Uses `asyncio` for handling I/O-bound tasks like embedding generation and database searches.
- **Error Handling:** Robust error handling with custom exceptions (`QueryEmbeddingError`) to manage specific issues during query processing.
- **Configuration Dependency:** Relies on external configuration settings via `config.settings`, ensuring flexibility in deployment environments.
- **Logging:** Comprehensive logging for tracking search operations, including success and failure cases.

---

*Generated by CodeWorm on 2026-02-20 11:58*
