# session

**Type:** File Overview
**Repository:** angelamos-operations
**File:** CarterBot-Telegram/src/session.ts
**Language:** typescript
**Lines:** 1-364
**Complexity:** 0.0

---

## Source Code

```typescript
/**
 * CarterOS Telegram Bot - Session Management
 *
 * Wraps Claude Agent SDK for streaming conversations.
 * Handles session persistence, abort, and resume.
 */

import {
  query,
  type Options,
  type SDKMessage,
} from "@anthropic-ai/claude-agent-sdk";
import { readFileSync } from "fs";
import type { Context } from "grammy";
import {
  MCP_SERVERS,
  SYSTEM_PROMPT,
  SESSION_FILE,
  STREAMING_THROTTLE_MS,
  THINKING_DEEP_KEYWORDS,
  THINKING_KEYWORDS,
  WORKING_DIR,
} from "./config";
import { formatToolStatus } from "./formatting";
import type { SessionData, StatusCallback, TokenUsage } from "./types";

function getThinkingLevel(message: string): number {
  const msgLower = message.toLowerCase();

  if (THINKING_DEEP_KEYWORDS.some((k) => msgLower.includes(k))) {
    return 50000;
  }

  if (THINKING_KEYWORDS.some((k) => msgLower.includes(k))) {
    return 10000;
  }

  return 0;
}

class ClaudeSession {
  sessionId: string | null = null;
  lastActivity: Date | null = null;
  queryStarted: Date | null = null;
  currentTool: string | null = null;
  lastTool: string | null = null;
  lastError: string | null = null;
  lastErrorTime: Date | null = null;
  lastUsage: TokenUsage | null = null;
  lastMessage: string | null = null;

  private abortController: AbortController | null = null;
  private isQueryRunning = false;
  private stopRequested = false;
  private _isProcessing = false;
  private _wasInterruptedByNewMessage = false;

  get isActive(): boolean {
    return this.sessionId !== null;
  }

  get isRunning(): boolean {
    return this.isQueryRunning || this._isProcessing;
  }

  consumeInterruptFlag(): boolean {
    const was = this._wasInterruptedByNewMessage;
    this._wasInterruptedByNewMessage = false;
    if (was) {
      this.stopRequested = false;
    }
    return was;
  }

  markInterrupt(): void {
    this._wasInterruptedByNewMessage = true;
  }

  clearStopRequested(): void {
    this.stopRequested = false;
  }

  startProcessing(): () => void {
    this._isProcessing = true;
    return () => {
      this._isProcessing = false;
    };
  }

  async stop(): Promise<"stopped" | "pending" | false> {
    if (this.isQueryRunning && this.abortController) {
      this.stopRequested = true;
      this.abortController.abort();
      console.log("Stop requested - aborting current query");
      return "stopped";
    }

    if (this._isProcessing) {
      this.stopRequested = true;
      console.log("Stop requested - will cancel before query starts");
      return "pending";
    }

    return false;
  }

  async sendMessageStreaming(
    message: string,
    username: string,
    userId: number,
    statusCallback: StatusCallback,
    chatId?: number,
    ctx?: Context
  ): Promise<string> {
    if (chatId) {
      process.env.TELEGRAM_CHAT_ID = String(chatId);
    }

    const isNewSession = !this.isActive;
    const thinkingTokens = getThinkingLevel(message);
    const thinkingLabel =
      { 0: "off", 10000: "normal", 50000: "deep" }[th
```

---

## File Overview

### Session Management for CarterOS Telegram Bot

**Purpose:**
This file manages Claude Agent SDK sessions, ensuring seamless conversation handling with Telegram users. It handles session persistence, aborting, and resuming, providing a robust mechanism to maintain context across interactions.

**Key Exports & Public Interface:**
- `ClaudeSession`: A class responsible for managing Claude Agent SDK sessions.
  - Methods:
    - `isActive`: Checks if the session is active.
    - `isRunning`: Determines if the query or processing is currently running.
    - `consumeInterruptFlag`, `markInterrupt`, and `clearStopRequested`: Manage interrupt flags and stop requests.
    - `startProcessing` and `stop`: Control the start and stop of queries.
    - `sendMessageStreaming`: Streams a message to Claude, handling session resumption and token usage.

**Project Fit:**
This file is integral to CarterOS Telegram Bot's conversation management. It integrates with the Claude Agent SDK to ensure that conversations are handled efficiently, maintaining context across multiple interactions and managing resource usage effectively.

**Design Decisions:**
- **Session Persistence:** The `sessionId` and `resume` options in the `query` function allow sessions to be resumed where they left off.
- **Interrupt Handling:** `consumeInterruptFlag`, `markInterrupt`, and `clearStopRequested` provide a mechanism to handle interruptions gracefully, ensuring that queries can be stopped or paused without losing state.
- **Token Management:** The `getThinkingLevel` function categorizes messages based on their complexity, influencing the number of tokens used in the query.
- **Environment Customization:** Environment variables like `CLAUDE_CODE_PATH` allow for flexibility in running custom Claude code paths.

This class ensures that each session is managed with precision and efficiency, contributing to a smooth user experience in the Telegram bot.

---

*Generated by CodeWorm on 2026-02-19 18:17*
