# service

**Type:** File Overview
**Repository:** my-portfolio
**File:** v1/backend/app/auth/service.py
**Language:** python
**Lines:** 1-207
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025
service.py
"""

import uuid6
from sqlalchemy.ext.asyncio import (
    AsyncSession,
)

from core.exceptions import (
    InvalidCredentials,
    TokenError,
    TokenRevokedError,
)
from core.security import (
    hash_token,
    create_access_token,
    create_refresh_token,
    verify_password_with_timing_safety,
)
from user.User import User
from user.repository import UserRepository
from .repository import RefreshTokenRepository
from .schemas import (
    TokenResponse,
    TokenWithUserResponse,
)
from user.schemas import UserResponse


class AuthService:
    """
    Business logic for authentication operations
    """
    def __init__(self, session: AsyncSession) -> None:
        self.session = session

    async def authenticate(
        self,
        email: str,
        password: str,
        device_id: str | None = None,
        device_name: str | None = None,
        ip_address: str | None = None,
    ) -> tuple[str,
               str,
               User]:
        """
        Authenticate user and create tokens
        """
        user = await UserRepository.get_by_email(self.session, email)
        hashed_password = user.hashed_password if user else None

        is_valid, new_hash = await verify_password_with_timing_safety(
            password, hashed_password
        )

        if not is_valid or user is None:
            raise InvalidCredentials()

        if not user.is_active:
            raise InvalidCredentials()

        if new_hash:
            await UserRepository.update_password(self.session, user, new_hash)

        access_token = create_access_token(user.id, user.token_version)

        family_id = uuid6.uuid7()
        raw_refresh, token_hash, expires_at = create_refresh_token(user.id, family_id)

        await RefreshTokenRepository.create_token(
            self.session,
            user_id = user.id,
            token_hash = token_hash,
            family_id = family_id,
            expires_at = expires_at,
            device_id = device_id,
            device_name = device_name,
            ip_address = ip_address,
        )

        return access_token, raw_refresh, user

    async def login(
        self,
        email: str,
        password: str,
        device_id: str | None = None,
        device_name: str | None = None,
        ip_address: str | None = None,
    ) -> tuple[TokenWithUserResponse,
               str]:
        """
        Login and return tokens with user data
        """
        access_token, refresh_token, user = await self.authenticate(
            email,
            password,
            device_id,
            device_name,
            ip_address,
        )

        response = TokenWithUserResponse(
            access_token = access_token,
            user = UserResponse.model_validate(user),
        )
        return response, refresh_token

    async def refresh_tokens(
        self,
        refresh_token: str,
        device_id: str | None = None,
        device_name: s
```

---

## File Overview

**File Purpose and Responsibility:**
This Python source file, `service.py`, is responsible for handling authentication and authorization logic within the application. It encapsulates business rules related to user login, token generation, and refresh operations.

**Key Exports or Public Interface:**
- **AuthService:** The primary class exposing methods for authenticating users, logging in, refreshing tokens, and logging out.
  - `authenticate`: Verifies user credentials and generates access and refresh tokens.
  - `login`: Logs in a user and returns tokens with associated user data.
  - `refresh_tokens`: Refreshes the access token using a valid refresh token.
  - `logout`: Revokes a refresh token to log out a user.

**How It Fits into the Project:**
This file acts as a central hub for authentication services, interacting with the database through repositories and leveraging security utilities. It integrates with other modules like `UserRepository` and `RefreshTokenRepository` to manage user sessions and tokens effectively.

**Notable Design Decisions:**
- **Asynchronous Operations:** The use of `AsyncSession` ensures that all operations are performed asynchronously, enhancing performance.
- **Security Measures:** Implementing timing-safe password verification and token revocation mechanisms helps protect against common security threats like timing attacks and token misuse.
- **Dependency Injection:** The `AuthService` constructor accepts an `AsyncSession`, allowing for flexible session management across different services.
```

This documentation provides a high-level overview of the file's purpose, key components, integration within the project, and important design choices.

---

*Generated by CodeWorm on 2026-02-20 02:41*
