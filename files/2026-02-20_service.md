# service

**Type:** File Overview
**Repository:** angelamos-3d
**File:** backend/app/wake/service.py
**Language:** python
**Lines:** 1-103
**Complexity:** 0.0

---

## Source Code

```python
"""
Â©AngelaMos | 2026
service.py
"""

import numpy as np
from openwakeword.model import Model
from scipy import signal

from app.config import settings
from app.wake.schemas import WakeWordDetection


_model: Model | None = None


def get_model() -> Model:
    """
    Lazy-load the OpenWakeWord model singleton.
    """
    global _model
    if _model is None:
        model_paths = list(settings.WAKEWORD_MODELS_DIR.glob("*.tflite"))
        model_paths += list(settings.WAKEWORD_MODELS_DIR.glob("*.onnx"))

        vad_threshold = (
            settings.WAKEWORD_VAD_THRESHOLD
            if settings.WAKEWORD_ENABLE_VAD else None
        )

        if model_paths:
            _model = Model(
                wakeword_models = [str(p) for p in model_paths],
                vad_threshold = vad_threshold,
            )
        else:
            _model = Model(vad_threshold = vad_threshold)
    return _model


def create_session_model() -> Model:
    """
    Create a new model instance for a WebSocket session.
    Each session needs its own model to avoid state conflicts.
    """
    model_paths = list(settings.WAKEWORD_MODELS_DIR.glob("*.tflite"))
    model_paths += list(settings.WAKEWORD_MODELS_DIR.glob("*.onnx"))

    vad_threshold = (
        settings.WAKEWORD_VAD_THRESHOLD
        if settings.WAKEWORD_ENABLE_VAD else None
    )

    if model_paths:
        return Model(
            wakeword_models = [str(p) for p in model_paths],
            vad_threshold = vad_threshold,
        )
    return Model(vad_threshold = vad_threshold)


def list_models() -> list[str]:
    """
    Get names of loaded wake word models.
    """
    m = get_model()
    return list(m.models.keys())


def process_audio(model: Model, audio_bytes: bytes) -> list[WakeWordDetection]:
    """
    Process audio chunk and return any detections.
    """
    audio = np.frombuffer(audio_bytes, dtype = np.int16)

    if len(audio) != settings.WAKEWORD_TARGET_SAMPLES:
        ratio = len(audio) // settings.WAKEWORD_TARGET_SAMPLES
        if ratio > 1:
            audio = audio[:: ratio][: settings.WAKEWORD_TARGET_SAMPLES]
        else:
            audio = signal.resample_poly(
                audio,
                settings.WAKEWORD_TARGET_SAMPLES,
                len(audio)
            ).astype(np.int16)

    predictions = model.predict(audio)
    model_names = list(model.models.keys())

    detections = []
    for name in model_names:
        score = predictions.get(name, 0.0)
        if score >= settings.WAKEWORD_THRESHOLD:
            detections.append(
                WakeWordDetection(
                    detected = True,
                    model = name,
                    score = float(score),
                )
            )

    return detections

```

---

## File Overview

# service.py

**Purpose**: This file provides core functionality for processing audio data to detect wake words using OpenWakeWord models. It handles model loading, session management, and audio processing.

**Key Exports**:
- `get_model()`: Lazy-loads a singleton instance of the OpenWakeWord model.
- `create_session_model()`: Creates a new model instance per WebSocket session.
- `list_models()`: Returns the names of loaded wake word models.
- `process_audio(model, audio_bytes)`: Processes an audio chunk and returns any detected wake words.

**Project Fit**: This file is integral to the wake-word detection module within the backend. It interacts with configuration settings and provides essential services for real-time audio processing.

**Design Decisions**:
1. **Lazy Loading**: The `get_model()` function ensures that the model is only loaded once, optimizing performance.
2. **Session Isolation**: Each WebSocket session gets its own model instance to avoid state conflicts.
3. **Audio Resampling**: Ensures consistent audio length by resampling if necessary before processing.
4. **Threshold-Based Detection**: Uses a configurable threshold for detecting wake words, allowing flexibility in sensitivity.

This file leverages external libraries like `numpy` and `scipy.signal`, and depends on project-specific configurations defined in `app.config.settings`.

---

*Generated by CodeWorm on 2026-02-20 23:49*
