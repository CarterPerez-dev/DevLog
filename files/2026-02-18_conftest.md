# conftest

**Type:** File Overview
**Repository:** Cybersecurity-Projects
**File:** TEMPLATES/fullstack-template/backend/conftest.py
**Language:** python
**Lines:** 1-292
**Complexity:** 0.0

---

## Source Code

```python
"""
Â©AngelaMos | 2025
conftest.py

Test configuration, fixtures, and factories
"""

import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent / "app"))

import hashlib
import secrets
from datetime import (
    UTC,
    datetime,
    timedelta,
)
from uuid import uuid4
from collections.abc import AsyncIterator

import pytest
from httpx import (
    AsyncClient,
    ASGITransport,
)
import pytest_asyncio
from sqlalchemy.ext.asyncio import (
    AsyncSession,
    create_async_engine,
)
from sqlalchemy.pool import StaticPool

from core.security import (
    hash_password,
    create_access_token,
)
from config import UserRole
from core.database import get_db_session

from core.Base import Base
from user.User import User
from auth.RefreshToken import RefreshToken


@pytest_asyncio.fixture(scope = "session", loop_scope = "session")
async def test_engine():
    """
    Session scoped async engine with in memory SQLite
    StaticPool keeps single connection so DB persists
    """
    engine = create_async_engine(
        "sqlite+aiosqlite:///:memory:",
        poolclass = StaticPool,
        connect_args = {"check_same_thread": False},
        echo = False,
    )
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    yield engine
    await engine.dispose()


@pytest.fixture
async def db_session(test_engine) -> AsyncIterator[AsyncSession]:
    """
    Per test session with transaction rollback for isolation
    App commits become savepoints that rollback with test
    """
    async with test_engine.connect() as conn:
        await conn.begin()

        session = AsyncSession(
            bind = conn,
            expire_on_commit = False,
            join_transaction_mode = "create_savepoint",
        )

        yield session

        await session.close()
        await conn.rollback()


@pytest.fixture
async def client(db_session: AsyncSession) -> AsyncIterator[AsyncClient]:
    """
    Async HTTP client with DB session override
    """
    from factory import create_app

    app = create_app()

    async def override_get_db():
        yield db_session

    app.dependency_overrides[get_db_session] = override_get_db

    async with AsyncClient(
            transport = ASGITransport(app = app),
            base_url = "http://test",
    ) as ac:
        yield ac

    app.dependency_overrides.clear()


@pytest.fixture
def auth_headers(access_token: str) -> dict[str, str]:
    """
    Authorization headers for authenticated requests
    """
    return {"Authorization": f"Bearer {access_token}"}


@pytest.fixture
def admin_auth_headers(admin_access_token: str) -> dict[str, str]:
    """
    Authorization headers for admin requests
    """
    return {"Authorization": f"Bearer {admin_access_token}"}


class UserFactory:
    """
    Factory for creating test users
    """
    _counter = 0

    @classmethod
    async def create(
        cls,
        session: AsyncSession,
        *,
        email: s
```

---

## File Overview

**conftest.py**

This file serves as a central configuration hub for testing within the backend of the application, providing fixtures and factories to facilitate test setup and execution.

### Purpose and Responsibility

The `conftest.py` file contains essential configurations such as database engines, HTTP clients, and user factories. It ensures that tests are isolated and can run independently while maintaining consistency in their environment.

### Key Exports and Public Interface

- **Fixtures**: 
  - `test_engine`: A session-scoped async engine with an in-memory SQLite database for testing.
  - `db_session`: A per-test-session fixture providing a transactional database session.
  - `client`: An HTTP client configured to use the test database session.
  - `auth_headers`, `admin_auth_headers`: Authorization headers for authenticated and admin requests.
- **Factories**:
  - `UserFactory` and `RefreshTokenFactory`: Classes for creating test users and refresh tokens, respectively.

### How It Fits into the Project

This file is crucial for setting up a consistent testing environment. The fixtures ensure that each test runs in isolation with its own database state, preventing side effects between tests. The factories simplify the creation of test data, making it easier to write comprehensive and isolated unit and integration tests.

### Notable Design Decisions

- **Session Scope**: Using session-scoped fixtures like `test_engine` and `db_session` ensures that each test has a clean database state.
- **Transaction Rollback**: The `db_session` fixture uses savepoints for transaction rollback, maintaining the integrity of the test environment.
- **Dependency Overrides**: The `client` fixture overrides the dependency injection to use the test database session, ensuring tests interact with the correct data source.
- **Factories**: Utilizing factory classes (`UserFactory`, `RefreshTokenFactory`) simplifies test data creation and maintains consistency across tests.

---

*Generated by CodeWorm on 2026-02-18 07:28*
