# telegram

**Type:** File Overview
**Repository:** CertGames-Core
**File:** backend/app/clients/telegram.py
**Language:** python
**Lines:** 1-201
**Complexity:** 0.0

---

## Source Code

```python
"""
Â©AngelaMos | 2026
telegram.py
"""

import requests
from typing import Any
from flask import Flask, current_app


TELEGRAM_API = "https://api.telegram.org/bot{token}/{method}"
THREAD_MAPPING_PREFIX = "tg_thread:"
THREAD_MAPPING_TTL = 604800


class TelegramService:

    def __init__(
        self,
        bot_token: str,
        admin_chat_id: str,
        webhook_secret: str | None = None
    ):
        self.bot_token = bot_token
        self.admin_chat_id = admin_chat_id
        self.webhook_secret = webhook_secret
        self.enabled = bool(bot_token and admin_chat_id)

    def _api_url(self, method: str) -> str:
        return TELEGRAM_API.format(token=self.bot_token, method=method)

    def send_message(
        self,
        text: str,
        reply_to_message_id: int | None = None
    ) -> int | None:
        if not self.enabled:
            return None

        payload: dict[str, Any] = {
            "chat_id": self.admin_chat_id,
            "text": text,
            "parse_mode": "HTML",
        }

        if reply_to_message_id:
            payload["reply_parameters"] = {
                "message_id": reply_to_message_id
            }

        try:
            response = requests.post(
                self._api_url("sendMessage"),
                json=payload,
                timeout=5
            )
            data = response.json()
            if data.get("ok"):
                return int(data["result"]["message_id"])

            current_app.logger.error(
                "Telegram API error: %s",
                data.get("description", "Unknown error")
            )
            return None
        except Exception as e:  # pylint: disable=broad-exception-caught
            current_app.logger.error(
                "Failed to send Telegram message: %s",
                str(e)
            )
            return None

    def register_webhook(self, webhook_url: str) -> bool:
        if not self.enabled:
            return False

        payload: dict[str, Any] = {
            "url": webhook_url,
            "allowed_updates": ["message"],
        }

        if self.webhook_secret:
            payload["secret_token"] = self.webhook_secret

        try:
            response = requests.post(
                self._api_url("setWebhook"),
                json=payload,
                timeout=10
            )
            data = response.json()
            if data.get("ok"):
                current_app.logger.info(
                    "Telegram webhook registered: %s",
                    webhook_url
                )
                return True

            current_app.logger.error(
                "Failed to register Telegram webhook: %s",
                data.get("description", "Unknown error")
            )
            return False
        except Exception as e:  # pylint: disable=broad-exception-caught
            current_app.logger.error(
                "Failed to register Telegram webhook: %s",
                str(e)
            )
  
```

---

## File Overview

# telegram.py

**Purpose and Responsibility:**
This Python file provides a service for interacting with Telegram's API to send messages, register webhooks, and manage thread notifications within the CertGames-Core backend application.

**Key Exports and Public Interface:**
- `TelegramService`: A class responsible for handling interactions with the Telegram API.
  - Methods include `send_message`, `register_webhook`, `notify_new_thread`, and `notify_user_message`.
- `store_thread_mapping` and `get_thread_from_mapping`: Functions to manage thread mappings in Redis.
- `setup_telegram`: A function to configure the `TelegramService` within a Flask application.

**How it Fits into the Project:**
This file is part of the `clients` module, which handles external API interactions. The `TelegramService` class is used by various parts of the backend to communicate with Telegram users and manage support threads. It integrates with Flask via `setup_telegram`, allowing seamless configuration within the application.

**Notable Design Decisions:**
- **Error Handling:** Broad exception handling is used for robust error logging, ensuring that any issues are captured and logged.
- **Thread Safety:** Thread mappings are stored in Redis to ensure data consistency across multiple instances or threads.
- **Configuration Management:** Configuration parameters like `TELEGRAM_BOT_TOKEN` and `TELEGRAM_ADMIN_CHAT_ID` are loaded from Flask's configuration, promoting flexibility and ease of use.

This file ensures that the backend can effectively communicate with users via Telegram, providing a seamless support experience.

---

*Generated by CodeWorm on 2026-02-19 10:54*
