# daemon

**Type:** File Overview
**Repository:** CodeWorm
**File:** codeworm/daemon.py
**Language:** python
**Lines:** 1-753
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2026
daemon.py
"""
from __future__ import annotations

import asyncio
import signal
import sys
from dataclasses import dataclass, field
from datetime import datetime, timedelta
from pathlib import Path
from typing import TYPE_CHECKING

from codeworm.analysis import (
    CodeAnalyzer,
    ParserManager,
    TargetRouter,
)
from codeworm.analysis.targets import DocumentationTarget, select_doc_type
from codeworm.core import (
    CodeWormSettings,
    StateManager,
    configure_logging,
    get_logger,
    load_settings,
)
from codeworm.core.events import get_publisher
from codeworm.core.notifier import CodeWormNotifier
from codeworm.git import DevLogRepository
from codeworm.llm import (
    DocumentationGenerator,
    OllamaClient,
    OllamaError,
)
from codeworm.models import DocType
from codeworm.scheduler import CodeWormScheduler

if TYPE_CHECKING:
    from codeworm.analysis import AnalysisCandidate


@dataclass
class CycleStats:
    """
    Tracks cycle statistics for monitoring and backoff logic
    """
    total_cycles: int = 0
    successful_cycles: int = 0
    failed_cycles: int = 0
    skipped_cycles: int = 0
    consecutive_failures: int = 0
    consecutive_ollama_failures: int = 0
    consecutive_push_failures: int = 0
    last_success: datetime | None = None
    last_failure: datetime | None = None
    last_failure_reason: str = ""
    repos_exhausted: set = field(default_factory = set)

    @property
    def success_rate(self) -> float:
        if self.total_cycles == 0:
            return 0.0
        return self.successful_cycles / self.total_cycles * 100

    def record_success(self) -> None:
        self.total_cycles += 1
        self.successful_cycles += 1
        self.consecutive_failures = 0
        self.consecutive_ollama_failures = 0
        self.last_success = datetime.now()
        self.repos_exhausted.clear()

    def record_failure(self, reason: str) -> None:
        self.total_cycles += 1
        self.failed_cycles += 1
        self.consecutive_failures += 1
        self.last_failure = datetime.now()
        self.last_failure_reason = reason

    def record_ollama_failure(self) -> None:
        self.consecutive_ollama_failures += 1

    def record_ollama_recovery(self) -> None:
        self.consecutive_ollama_failures = 0

    def record_skip(self, reason: str) -> None:
        self.total_cycles += 1
        self.skipped_cycles += 1
        self.last_failure_reason = reason

    def record_repo_exhausted(self, repo_name: str) -> None:
        self.repos_exhausted.add(repo_name)

    def get_backoff_seconds(self) -> int:
        if self.consecutive_failures <= 1:
            return 0
        return min(300, 30 * (2**(self.consecutive_failures - 1)))

    def get_ollama_wait_seconds(self) -> int:
        if self.consecutive_ollama_failures <= 1:
            return 10
        return min(300, 10 * (2**(self.consecutive_ollama_failures - 1)))

    def to_dict(self) -> dict:
        return {
            "tota
```

---

## File Overview

### daemon.py

**Purpose and Responsibility:**
This file implements the `CodeWormDaemon`, a core orchestrator for CodeWorm, designed to run 24/7 with robust self-healing capabilities. It coordinates code analysis, LLM-based documentation generation, git commits, and scheduling.

**Key Exports and Public Interface:**
- **`CycleStats`:** Tracks statistics for monitoring and backoff logic.
- **`CodeWormDaemon`:** Main orchestrator class that handles the entire workflow of CodeWorm operations.

**How It Fits in the Project:**
The `CodeWormDaemon` is a central component that integrates various modules like code analysis, LLM generation, and git operations. It ensures seamless operation by handling retries, backoffs, and self-healing when services fail. The daemon runs asynchronously using asyncio and handles signals for graceful shutdown.

**Notable Design Decisions:**
- **Asyncio and Asynchronous Operations:** Utilizes `asyncio` for non-blocking I/O and scheduling tasks.
- **Self-Healing Mechanism:** Implements retry logic with exponential backoff to handle failures, ensuring the daemon does not crash even when services like Ollama are down.
- **State Management:** Uses a `StateManager` to maintain persistent state across runs.
- **Logging and Notifiers:** Configures logging and integrates with Telegram notifications for real-time alerts on failures or successes.
```

This documentation provides an overview of the file's role, key components, integration within the project, and important design choices.

---

*Generated by CodeWorm on 2026-02-28 07:42*
