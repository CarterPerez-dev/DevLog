# client

**Type:** File Overview
**Repository:** angela
**File:** internal/osv/client.go
**Language:** go
**Lines:** 1-402
**Complexity:** 0.0

---

## Source Code

```go
// Â©AngelaMos | 2026
// client.go

package osv

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"strconv"
	"strings"
	"sync"
	"time"

	"github.com/CarterPerez-dev/angela/pkg/types"
	"golang.org/x/sync/errgroup"
)

const (
	batchEndpoint = "https://api.osv.dev/v1/querybatch"
	vulnEndpoint  = "https://api.osv.dev/v1/vulns/"
	userAgent     = "angela/0.1.0 (https://github.com/CarterPerez-dev/angela)"
	maxHydrate    = 15
)

// Client queries the OSV.dev API for known vulnerabilities
type Client struct {
	http *http.Client
}

// NewClient creates an OSV client with sensible defaults
func NewClient() *Client {
	return &Client{
		http: &http.Client{Timeout: 30 * time.Second},
	}
}

// PackageQuery identifies a single package+version to check
type PackageQuery struct {
	Name    string
	Version string
}

type batchRequest struct {
	Queries []query `json:"queries"`
}

type query struct {
	Package pkg    `json:"package"`
	Version string `json:"version"`
}

type pkg struct {
	Name      string `json:"name"`
	Ecosystem string `json:"ecosystem"`
}

type batchResponse struct {
	Results []batchResult `json:"results"`
}

type batchResult struct {
	Vulns []vulnRef `json:"vulns"`
}

type vulnRef struct {
	ID       string `json:"id"`
	Modified string `json:"modified"`
}

type osvVuln struct {
	ID               string         `json:"id"`
	Summary          string         `json:"summary"`
	Aliases          []string       `json:"aliases"`
	Severity         []severity     `json:"severity"`
	Affected         []affected     `json:"affected"`
	References       []reference    `json:"references"`
	DatabaseSpecific map[string]any `json:"database_specific"`
}

type severity struct {
	Type  string `json:"type"`
	Score string `json:"score"`
}

type affected struct {
	Package pkg   `json:"package"`
	Ranges  []rng `json:"ranges"`
}

type rng struct {
	Type   string  `json:"type"`
	Events []event `json:"events"`
}

type event struct {
	Introduced string `json:"introduced,omitempty"`
	Fixed      string `json:"fixed,omitempty"`
}

type reference struct {
	Type string `json:"type"`
	URL  string `json:"url"`
}

// ScanPackages checks a list of packages for known vulnerabilities and returns
// per-package results with full vulnerability details. Duplicates caused by
// overlapping CVE/GHSA identifiers are removed.
func (c *Client) ScanPackages(
	ctx context.Context,
	packages []PackageQuery,
) (map[string][]types.Vulnerability, error) {
	if len(packages) == 0 {
		return nil, nil
	}

	batch, err := c.queryBatch(ctx, packages)
	if err != nil {
		return nil, fmt.Errorf("osv batch query: %w", err)
	}

	allIDs := collectUniqueIDs(batch)
	if len(allIDs) == 0 {
		return nil, nil
	}

	vulnMap, err := c.hydrateAll(ctx, allIDs)
	if err != nil {
		return nil, fmt.Errorf("osv hydrate: %w", err)
	}

	return buildResults(packages, batch, vulnMap), nil
}

func (c *Client) queryBatch(
	ctx context.Context,
	packages []PackageQuery,
) (*batchResponse, error) {
	queries := make([]que
```

---

## File Overview

# client.go Documentation

## Purpose and Responsibility
This Go source file defines the `Client` for interacting with the OSV.dev API to query known vulnerabilities for software packages. It handles batching queries, fetching individual vulnerability details, and hydrating results.

## Key Exports and Public Interface
- **Client**: The main interface for querying OSV.dev.
  - `NewClient() *Client`: Creates a new client instance.
  - `ScanPackages(ctx context.Context, packages []PackageQuery) (map[string][]types.Vulnerability, error)`: Scans multiple package versions for vulnerabilities.

## How It Fits into the Project
This file is part of the `osv` package within the broader `angela` project. The `Client` struct and its methods are responsible for interfacing with external APIs to gather vulnerability information, which is crucial for security analysis tools like `angela`.

## Notable Design Decisions
- **Batch Querying**: Uses a batch endpoint to query multiple packages in one request, optimizing API calls.
- **Concurrency Control**: Implements an error group with a limit on concurrent requests to manage API rate limits and improve performance.
- **Error Handling**: Robust error handling ensures that any issues during HTTP requests or JSON decoding are properly captured and reported.
- **User-Agent Header**: Sets a consistent `User-Agent` header for API requests, improving traceability and compliance.

---

*Generated by CodeWorm on 2026-02-20 17:09*
