# client

**Type:** File Overview
**Repository:** angela
**File:** internal/pypi/client.go
**Language:** go
**Lines:** 1-227
**Complexity:** 0.0

---

## Source Code

```go
// Â©AngelaMos | 2026
// client.go

package pypi

import (
	"context"
	"encoding/json"
	"fmt"
	"net/http"
	"regexp"
	"strings"
	"sync"
	"time"

	"golang.org/x/sync/errgroup"
)

// PyPI client configuration defaults.
const (
	DefaultMaxWorkers = 10
	DefaultTimeout    = 30 * time.Second
	DefaultUserAgent  = "angela/0.1.0 (https://github.com/CarterPerez-dev/angela)"

	simpleAPIBase   = "https://pypi.org/simple/"
	simpleAPIAccept = "application/vnd.pypi.simple.v1+json"

	maxRetries  = 3
	baseRetryMs = 500
)

var nameNormalizeRe = regexp.MustCompile(`[-_.]+`)

// Client queries the PyPI Simple API for package version information
type Client struct {
	http       *http.Client
	cache      *Cache
	maxWorkers int
	userAgent  string
}

type simpleAPIResponse struct {
	Name     string   `json:"name"`
	Versions []string `json:"versions"`
}

// FetchResult holds the outcome of querying a single package
type FetchResult struct {
	Name     string
	Versions []string
	Err      error
}

// NewClient creates a PyPI client backed by a file cache at cacheDir
func NewClient(cacheDir string) (*Client, error) {
	cache, err := NewCache(cacheDir, DefaultCacheTTL)
	if err != nil {
		return nil, fmt.Errorf("init cache: %w", err)
	}

	return &Client{
		http: &http.Client{
			Timeout: DefaultTimeout,
			Transport: &http.Transport{
				MaxIdleConnsPerHost: DefaultMaxWorkers,
				MaxConnsPerHost:     DefaultMaxWorkers,
				IdleConnTimeout:     90 * time.Second,
			},
		},
		cache:      cache,
		maxWorkers: DefaultMaxWorkers,
		userAgent:  DefaultUserAgent,
	}, nil
}

// FetchVersions returns all known versions for a single PyPI package
func (c *Client) FetchVersions(
	ctx context.Context,
	name string,
) ([]string, error) {
	normalized := NormalizeName(name)

	entry, hit := c.cache.Get(normalized)
	if hit && c.cache.IsFresh(entry) {
		return entry.Versions, nil
	}

	url := simpleAPIBase + normalized + "/"
	req, err := http.NewRequestWithContext(
		ctx, http.MethodGet, url, nil,
	)
	if err != nil {
		return nil, fmt.Errorf("build request for %s: %w", name, err)
	}
	req.Header.Set("Accept", simpleAPIAccept)
	req.Header.Set("User-Agent", c.userAgent)

	if entry != nil && entry.ETag != "" {
		req.Header.Set("If-None-Match", entry.ETag)
	}

	resp, err := c.doWithRetry(ctx, req)
	if err != nil {
		if entry != nil {
			return entry.Versions, nil
		}
		return nil, fmt.Errorf("fetch %s: %w", name, err)
	}
	defer func() { _ = resp.Body.Close() }() //nolint:errcheck

	switch resp.StatusCode {
	case http.StatusNotModified:
		c.cache.Touch(normalized)
		return entry.Versions, nil

	case http.StatusNotFound:
		return nil, fmt.Errorf(
			"package %q not found on PyPI", name,
		)

	case http.StatusOK:
		var result simpleAPIResponse
		if err := json.NewDecoder(resp.Body).Decode(&result); err != nil {
			return nil, fmt.Errorf("decode %s: %w", name, err)
		}
		_ = c.cache.Set(normalized, &CacheEntry{ //nolint:errcheck
			ETag:     resp.Header.Get("ETag"),
			Versions: result.Versions,
			CachedAt:
```

---

## File Overview

# client.go

## Purpose and Responsibility
This file defines a Go package `pypi` that implements a client for querying the PyPI Simple API to fetch version information for Python packages. The client supports caching, concurrent fetching of multiple packages, and retry logic with exponential backoff.

## Key Exports and Public Interface
- **Client**: Represents the main interface for interacting with the PyPI Simple API.
  - `NewClient(cacheDir string) (*Client, error)`: Creates a new PyPI client instance.
  - `FetchVersions(ctx context.Context, name string) ([]string, error)`: Fetches all known versions of a single package.
  - `FetchAllVersions(ctx context.Context, names []string) []FetchResult`: Concurrently fetches version information for multiple packages.
  - `ClearCache() error`: Clears the cache of all PyPI responses.

- **FetchResult**: Struct to hold the outcome of querying a single package.

## How It Fits in the Project
This client is part of the `angela` project, responsible for interfacing with external APIs. It integrates with other components that depend on up-to-date package information, such as dependency resolution and package management tools.

## Notable Design Decisions
- **Caching**: Utilizes a file-based cache to store responses from PyPI, reducing redundant API calls.
- **Concurrency**: Supports concurrent fetching of multiple packages using goroutines and an error group for managing retries and context cancellation.
- **Error Handling**: Implements retry logic with exponential backoff to handle server errors gracefully. Uses context timeouts to prevent indefinite blocking.
- **User-Agent Header**: Sets a custom user-agent header to identify the client, aiding in rate limiting and API usage tracking by PyPI.

---

*Generated by CodeWorm on 2026-02-20 17:46*
