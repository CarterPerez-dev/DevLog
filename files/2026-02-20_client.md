# client

**Type:** File Overview
**Repository:** fastapi-rc
**File:** fastapi-rc/fastapi_rc/client.py
**Language:** python
**Lines:** 1-142
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025
client.py
"""

import logging
import contextlib
from collections.abc import AsyncIterator

import redis.asyncio as redis
from redis.asyncio import (
    Redis,
    ConnectionPool,
)
from redis.asyncio.retry import Retry
from redis.backoff import ExponentialWithJitterBackoff
from redis.exceptions import (
    TimeoutError,
    ConnectionError,
    BusyLoadingError,
)


logger = logging.getLogger(__name__)


class CacheManager:
    """
    Manages Redis connections and client lifecycle
    """
    def __init__(self) -> None:
        self._pool: ConnectionPool | None = None
        self._client: Redis | None = None

    def init(
        self,
        redis_url: str | None = None,
        max_connections: int = 50,
        socket_timeout: float = 5.0,
        socket_connect_timeout: float = 2.0,
        health_check_interval: int = 30,
        decode_responses: bool = True,
    ) -> None:
        """
        Initialize Redis connection pool and client

        Args:
            redis_url: Redis connection URL (e.g., redis://localhost:6379/0)
            max_connections: Maximum number of connections in pool (10-200)
            socket_timeout: Socket timeout in seconds
            socket_connect_timeout: Connection timeout in seconds
            health_check_interval: Health check ping interval in seconds
            decode_responses: Auto-decode bytes to strings
        """
        if redis_url is None:
            logger.warning(
                "Redis URL not provided - cache will be disabled"
            )
            return

        retry = Retry(
            backoff = ExponentialWithJitterBackoff(base = 1, cap = 10),
            retries = 5,
            supported_errors = (
                ConnectionError,
                TimeoutError,
                BusyLoadingError,
            ),
        )

        self._pool = ConnectionPool.from_url(
            redis_url,
            max_connections = max_connections,
            socket_timeout = socket_timeout,
            socket_connect_timeout = socket_connect_timeout,
            socket_keepalive = True,
            health_check_interval = health_check_interval,
            decode_responses = decode_responses,
            retry = retry,
        )

        self._client = Redis.from_pool(self._pool)
        logger.info(
            f"Redis connection pool initialized (max_connections={max_connections})"
        )

    async def close(self) -> None:
        """
        Close Redis client and dispose of connection pool
        """
        if self._client:
            await self._client.aclose()
            self._client = None
            self._pool = None
            logger.info("Redis connection pool closed")

    async def ping(self) -> bool:
        """
        Health check - ping Redis server
        """
        if not self._client:
            return False

        try:
            return await self._client.ping()
        except Exception as e:
            logger.warning(f"Red
```

---

## File Overview

### client.py

**Purpose and Responsibility:**
This file manages Redis connections and provides a high-level API for interacting with Redis using an asynchronous context manager pattern. It initializes, closes, and pings a Redis connection pool, ensuring robust handling of connection errors and retries.

**Key Exports and Public Interface:**
- `CacheManager`: A class responsible for managing the lifecycle of a Redis client.
  - `init()`: Initializes the Redis connection pool and client with provided configuration.
  - `close()`: Closes the Redis client and disposes of the connection pool.
  - `ping()`: Performs a health check by pinging the Redis server.
  - `client`: Property to access the Redis client instance.
  - `is_available`: Property indicating if the Redis client is available.
  - `pipeline()`: Context manager for executing Redis pipeline operations.

**How It Fits in the Project:**
This file serves as a central hub for managing Redis connections, ensuring that all parts of the application can interact with Redis seamlessly. The `CacheManager` class abstracts away the complexities of connection management and error handling, making it easier to integrate caching mechanisms across different components of the FastAPI application.

**Notable Design Decisions:**
- **Async Context Manager**: Utilizes `contextlib.asynccontextmanager` for managing Redis pipelines efficiently.
- **Retry Mechanism**: Implements a retry mechanism with exponential backoff using `ExponentialWithJitterBackoff` to handle transient errors gracefully.
- **Connection Pool Management**: Manages connection pools and clients, ensuring that resources are properly released when the application is shut down or connections fail.

---

*Generated by CodeWorm on 2026-02-20 01:50*
