# query.config

**Type:** File Overview
**Repository:** social-media-notes
**File:** frontend/src/core/api/query.config.ts
**Language:** typescript
**Lines:** 1-105
**Complexity:** 0.0

---

## Source Code

```typescript
/**
 * AngelaMos | 2025
 * query.config.ts
 */

import { Alert } from 'react-native'
import { MutationCache, QueryCache, QueryClient } from '@tanstack/react-query'
import { QUERY_CONFIG } from '@/config'
import { ApiError, ApiErrorCode } from './errors'

const NO_RETRY_ERROR_CODES: readonly ApiErrorCode[] = [
  ApiErrorCode.AUTHENTICATION_ERROR,
  ApiErrorCode.AUTHORIZATION_ERROR,
  ApiErrorCode.NOT_FOUND,
  ApiErrorCode.VALIDATION_ERROR,
] as const

const shouldRetryQuery = (failureCount: number, error: Error): boolean => {
  if (error instanceof ApiError) {
    if (NO_RETRY_ERROR_CODES.includes(error.code)) {
      return false
    }
  }
  return failureCount < QUERY_CONFIG.RETRY.DEFAULT
}

const calculateRetryDelay = (attemptIndex: number): number => {
  const baseDelay = 1000
  const maxDelay = 30000
  return Math.min(baseDelay * 2 ** attemptIndex, maxDelay)
}

const handleQueryCacheError = (
  error: Error,
  query: { state: { data: unknown } }
): void => {
  if (query.state.data !== undefined) {
    const message =
      error instanceof ApiError
        ? error.getUserMessage()
        : 'Background update failed'
    Alert.alert('Error', message)
  }
}

const handleMutationCacheError = (
  error: Error,
  _variables: unknown,
  _context: unknown,
  mutation: { options: { onError?: unknown } }
): void => {
  if (mutation.options.onError === undefined) {
    const message =
      error instanceof ApiError ? error.getUserMessage() : 'Operation failed'
    Alert.alert('Error', message)
  }
}

export const QUERY_STRATEGIES = {
  standard: {
    staleTime: QUERY_CONFIG.STALE_TIME.USER,
    gcTime: QUERY_CONFIG.GC_TIME.DEFAULT,
  },
  frequent: {
    staleTime: QUERY_CONFIG.STALE_TIME.FREQUENT,
    gcTime: QUERY_CONFIG.GC_TIME.DEFAULT,
    refetchInterval: QUERY_CONFIG.STALE_TIME.FREQUENT,
  },
  static: {
    staleTime: QUERY_CONFIG.STALE_TIME.STATIC,
    gcTime: QUERY_CONFIG.GC_TIME.LONG,
    refetchOnMount: false,
    refetchOnWindowFocus: false,
  },
  auth: {
    staleTime: QUERY_CONFIG.STALE_TIME.USER,
    gcTime: QUERY_CONFIG.GC_TIME.DEFAULT,
    retry: QUERY_CONFIG.RETRY.NONE,
  },
} as const

export type QueryStrategy = keyof typeof QUERY_STRATEGIES

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: QUERY_CONFIG.STALE_TIME.USER,
      gcTime: QUERY_CONFIG.GC_TIME.DEFAULT,
      retry: shouldRetryQuery,
      retryDelay: calculateRetryDelay,
      refetchOnMount: true,
      refetchOnReconnect: true,
    },
    mutations: {
      retry: QUERY_CONFIG.RETRY.NONE,
    },
  },
  queryCache: new QueryCache({
    onError: handleQueryCacheError,
  }),
  mutationCache: new MutationCache({
    onError: handleMutationCacheError,
  }),
})

```

---

## File Overview

### Documenting `query.config.ts`

**Purpose:**
This TypeScript source file configures and manages query strategies for a React Native application using `@tanstack/react-query`. It sets up retry mechanisms, cache management, and error handling to ensure robust data fetching.

**Key Exports:**
- **QueryStrategy:** An enum defining different query strategies.
- **queryClient:** A configured instance of `QueryClient` with custom options for queries and mutations.

**Project Integration:**
This file is crucial for the application's data layer. It provides a centralized configuration point that can be referenced throughout the project to ensure consistent behavior across all API calls. The `queryClient` instance is used by other components to fetch data, making it easier to manage caching, retries, and error handling.

**Design Decisions:**
- **Retry Mechanism:** Implements conditional retry logic based on error codes and failure count.
- **Cache Management:** Configures different stale times and garbage collection intervals for various query strategies.
- **Error Handling:** Provides custom alert messages for both `QueryCache` and `MutationCache` errors, enhancing user experience by providing meaningful feedback.

This file ensures that the application can handle network failures gracefully and maintain a good user experience even under poor network conditions.

---

*Generated by CodeWorm on 2026-02-20 22:45*
