# main

**Type:** File Overview
**Repository:** angelamos-operations
**File:** Docker-Kentros/cmd/server/main.go
**Language:** go
**Lines:** 1-270
**Complexity:** 0.0

---

## Source Code

```go
/*
AngelaMos | 2026
main.go
*/

package main

import (
	"context"
	"flag"
	"fmt"
	"log/slog"
	"net/http"
	"os"
	"os/signal"
	"path/filepath"
	"syscall"
	"time"

	"github.com/carterperez-dev/holophyly/internal/api"
	"github.com/carterperez-dev/holophyly/internal/config"
	"github.com/carterperez-dev/holophyly/internal/docker"
	"github.com/carterperez-dev/holophyly/internal/model"
	"github.com/carterperez-dev/holophyly/internal/project"
	"github.com/carterperez-dev/holophyly/internal/scanner"
	"github.com/carterperez-dev/holophyly/internal/store"
	"github.com/carterperez-dev/holophyly/internal/websocket"
	"github.com/carterperez-dev/holophyly/web"
)

var (
	version = "dev"
	commit  = "none"
	date    = "unknown"
)

func main() {
	os.Exit(mainRun())
}

func mainRun() int {
	configPath := flag.String("config", "", "path to config file")
	showVersion := flag.Bool("version", false, "show version information")
	flag.Parse()

	if *showVersion {
		fmt.Printf(
			"holophyly %s (commit: %s, built: %s)\n",
			version,
			commit,
			date,
		)
		return 0
	}

	cfg, err := config.Load(*configPath)
	if err != nil {
		fmt.Fprintf(os.Stderr, "failed to load config: %v\n", err)
		return 1
	}

	logger := setupLogger(cfg.Logging.Level, cfg.Logging.Format)
	slog.SetDefault(logger)

	ctx, stop := signal.NotifyContext(
		context.Background(),
		syscall.SIGINT,
		syscall.SIGTERM,
	)
	defer stop()

	if err := run(ctx, cfg, logger); err != nil {
		logger.Error("application error", "error", err)
		return 1
	}

	return 0
}

func run(ctx context.Context, cfg *config.Config, logger *slog.Logger) error {
	logger.Info("starting holophyly",
		"version", version,
		"address", cfg.Address(),
	)

	dockerClient, err := docker.NewClient()
	if err != nil {
		return fmt.Errorf("creating docker client: %w", err)
	}
	defer func() { _ = dockerClient.Close() }()

	if err := dockerClient.Ping(ctx); err != nil {
		return fmt.Errorf("docker daemon not available: %w", err)
	}
	logger.Info("connected to docker daemon")

	if !docker.IsComposeInstalled(ctx) {
		logger.Warn("docker compose not found - compose operations will fail")
	}

	dataDir := cfg.DataDir
	if dataDir == "" {
		home, _ := os.UserHomeDir()
		dataDir = filepath.Join(home, ".config", "holophyly")
	}

	prefStore, err := store.New(dataDir)
	if err != nil {
		logger.Warn("failed to initialize preferences store", "error", err)
	} else {
		defer func() { _ = prefStore.Close() }()
		logger.Info("preferences store initialized", "path", dataDir)
	}

	fileScanner := scanner.NewScanner(cfg.Scanner.Paths, cfg.Scanner.Exclude)

	protection := project.NewProtectionConfig(
		cfg.Protection.Patterns,
		cfg.Protection.Projects,
	)

	manager := project.NewManager(dockerClient, fileScanner, protection, prefStore)

	if err := manager.Refresh(ctx); err != nil {
		logger.Warn("initial project scan failed", "error", err)
	} else {
		projects := manager.ListProjects()
		logger.Info("initial scan complete", "projects_found", len(projects))
	}

	hub := websoc
```

---

## File Overview

# main.go

## Purpose and Responsibility
This Go source file is the entry point of the `holophyly` application, responsible for initializing the application's configuration, setting up logging, starting various services, and handling graceful shutdowns.

## Key Exports and Public Interface
- **mainRun**: The primary function that initializes the application context, loads configurations, sets up logging, starts services, and handles the main execution flow.
- **run**: Manages the core logic of the application, including project scanning, server setup, and periodic scanning tasks.
- **setupLogger**: Configures the logging system based on provided configuration.

## How It Fits into the Larger Project
This file acts as the central hub for initializing and coordinating various components of the `holophyly` application. It leverages dependencies from other packages to manage project storage, scanning, API routing, and server operations. The main function orchestrates these components, ensuring they work together seamlessly.

## Notable Design Decisions
- **Error Handling**: Errors are logged using structured logging with `slog`, providing detailed information for debugging.
- **Graceful Shutdown**: A context-based shutdown mechanism ensures that the application can gracefully stop all services and clean up resources before exiting.
- **Configuration Management**: Configurations are loaded from a specified file, allowing flexibility in deployment scenarios. Default values are provided to ensure minimal setup requirements.
- **Modular Services**: The application is designed with modular services (e.g., project management, scanning, API routing) that can be independently developed and tested.

---

*Generated by CodeWorm on 2026-02-19 19:17*
