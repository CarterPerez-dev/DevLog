# payout_service

**Type:** File Overview
**Repository:** stripe-referral
**File:** src/stripe_referral/services/payout_service.py
**Language:** python
**Lines:** 1-308
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025 | CertGames.com
Payout service with business logic
"""

from typing import Any
from sqlalchemy.orm import Session

from ..adapters import (
    ManualBankAdapter,
    PayoutAdapter,
    StripeConnectAdapter,
    WiseAdapter,
)
from ..config.enums import (
    AdapterType,
    CurrencyCode,
    PayoutStatus,
    RewardType,
)
from ..exceptions.errors import (
    InvalidRecipientDataError,
    PayoutAlreadyExistsError,
    PayoutNotFoundError,
    TrackingNotFoundError,
)
from ..repositories.payout_repo import PayoutRepository
from ..repositories.program_repo import ReferralProgramRepository
from ..repositories.referral_repo import ReferralTrackingRepository
from ..schemas.types import (
    PayoutInfo,
    PayoutResult,
    ProgramInfo,
    RecipientValidation,
)


class PayoutService:
    """
    Service for payout business logic
    """
    @staticmethod
    def _get_adapter(
        adapter_type: str,
        adapter_config: dict[str,
                             Any] | None = None
    ) -> PayoutAdapter:
        """
        Factory method to get the appropriate payout adapter instance
        """
        config = adapter_config or {}

        if adapter_type == AdapterType.MANUAL.value:
            return ManualBankAdapter()
        if adapter_type == AdapterType.STRIPE_CONNECT.value:
            api_key = config.get("api_key", "")
            return StripeConnectAdapter(api_key = api_key)
        if adapter_type == AdapterType.WISE.value:
            api_token = config.get("api_token", "")
            sandbox = config.get("sandbox", False)
            return WiseAdapter(api_token = api_token, sandbox = sandbox)

        raise InvalidRecipientDataError(
            f"Unknown adapter type: {adapter_type}",
            adapter_type = adapter_type,
        )

    @staticmethod
    def create_program(
        db: Session,
        name: str,
        program_key: str,
        reward_amount: float,
        *,
        reward_currency: str = CurrencyCode.USD.value,
        reward_type: str = RewardType.ONE_TIME.value,
        adapter_type: str = AdapterType.MANUAL.value,
        max_rewards_per_user: int | None = None,
        conversion_window_days: int | None = None,
        adapter_config: dict[str,
                             Any] | None = None,
    ) -> ProgramInfo:
        """
        Create a new referral program
        """
        valid_adapter_types = [at.value for at in AdapterType]
        if adapter_type not in valid_adapter_types:
            raise InvalidRecipientDataError(
                f"Invalid adapter_type. Must be one of: {valid_adapter_types}",
                adapter_type = adapter_type,
            )

        program_repo = ReferralProgramRepository(db)

        program = program_repo.create(
            name = name,
            program_key = program_key,
            reward_amount = reward_amount,
            reward_currency = reward_currency,
            reward_type = reward_type,
            adapter_ty
```

---

## File Overview

### PayoutService Documentation

**Purpose:**
This file defines a service layer for handling payout-related business logic, including program creation, tracking, and payout processing.

**Key Exports & Public Interface:**
- `create_program`: Creates a new referral program with specified parameters.
- `get_program_info`: Retrieves information about an existing referral program by its key.
- `create_payout`: Initializes a payout record for a specific tracking entry using the appropriate adapter based on the configured type.

**Project Integration:**
The `PayoutService` class is part of the broader service layer in the `stripe-referral` project. It interacts with various repositories and adapters to manage payouts, ensuring that the business logic is encapsulated and decoupled from the database and external services.

**Design Decisions:**
- **Adapter Pattern**: Uses a factory method (`_get_adapter`) to instantiate the correct adapter based on configuration, promoting flexibility and ease of extension.
- **Type Hints & Validation**: Utilizes Python's type hints for clear function signatures and includes validation checks to ensure input data is correct before proceeding with operations.
- **Error Handling**: Implements custom exceptions for specific error conditions, improving robustness and maintainability.

This service ensures that payout-related operations are handled consistently across the application, leveraging adapters for different payment methods.

---

*Generated by CodeWorm on 2026-02-20 09:24*
