# service

**Type:** File Overview
**Repository:** Cybersecurity-Projects
**File:** TEMPLATES/fullstack-template/backend/app/auth/service.py
**Language:** python
**Lines:** 1-213
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025
service.py
"""

import uuid6
from sqlalchemy.ext.asyncio import (
    AsyncSession,
)

from core.exceptions import (
    InvalidCredentials,
    TokenError,
    TokenRevokedError,
)
from core.security import (
    hash_token,
    create_access_token,
    create_refresh_token,
    verify_password_with_timing_safety,
)
from user.User import User
from user.repository import UserRepository
from .repository import RefreshTokenRepository
from .schemas import (
    TokenResponse,
    TokenWithUserResponse,
)
from user.schemas import UserResponse


class AuthService:
    """
    Business logic for authentication operations
    """
    def __init__(self, session: AsyncSession) -> None:
        self.session = session

    async def authenticate(
        self,
        email: str,
        password: str,
        device_id: str | None = None,
        device_name: str | None = None,
        ip_address: str | None = None,
    ) -> tuple[str,
               str,
               User]:
        """
        Authenticate user and create tokens
        """
        user = await UserRepository.get_by_email(self.session, email)
        hashed_password = user.hashed_password if user else None

        is_valid, new_hash = await verify_password_with_timing_safety(
            password, hashed_password
        )

        if not is_valid or user is None:
            raise InvalidCredentials()

        if not user.is_active:
            raise InvalidCredentials()

        if new_hash:
            await UserRepository.update_password(
                self.session,
                user,
                new_hash
            )

        access_token = create_access_token(user.id, user.token_version)

        family_id = uuid6.uuid7()
        raw_refresh, token_hash, expires_at = create_refresh_token(user.id, family_id)

        await RefreshTokenRepository.create_token(
            self.session,
            user_id = user.id,
            token_hash = token_hash,
            family_id = family_id,
            expires_at = expires_at,
            device_id = device_id,
            device_name = device_name,
            ip_address = ip_address,
        )

        return access_token, raw_refresh, user

    async def login(
        self,
        email: str,
        password: str,
        device_id: str | None = None,
        device_name: str | None = None,
        ip_address: str | None = None,
    ) -> tuple[TokenWithUserResponse,
               str]:
        """
        Login and return tokens with user data
        """
        access_token, refresh_token, user = await self.authenticate(
            email,
            password,
            device_id,
            device_name,
            ip_address,
        )

        response = TokenWithUserResponse(
            access_token = access_token,
            user = UserResponse.model_validate(user),
        )
        return response, refresh_token

    async def refresh_tokens(
        self,
        refresh_token: str
```

---

## File Overview

**File Purpose and Responsibility:**
This file contains the `AuthService` class, which handles authentication logic for user login and token management within a full-stack application. It interacts with SQLAlchemy repositories to manage user sessions and refresh tokens.

**Key Exports or Public Interface:**
- **`AuthService` Class:** Provides methods for authenticating users, logging in, refreshing tokens, and logging out.
  - `authenticate`: Verifies user credentials and generates access and refresh tokens.
  - `login`: Logs in a user and returns tokens with user data.
  - `refresh_tokens`: Refreshes the access token using a valid refresh token.
  - `logout`: Revokes a refresh token to log out a user.

**How it Fits into the Project:**
This service layer is crucial for handling authentication-related business logic. It interacts with repositories and security utilities, ensuring secure and efficient management of user sessions across the application.

**Notable Design Decisions:**
- **Timing Safety:** Implements `verify_password_with_timing_safety` to prevent timing attacks.
- **Token Rotation:** Uses a family ID system to manage token rotation and detect replay attacks.
- **Replay Detection:** Ensures that revoked or expired tokens are handled appropriately, enhancing security.
```

This documentation provides an overview of the file's purpose, key methods, integration within the project, and significant design choices.

---

*Generated by CodeWorm on 2026-02-18 08:44*
