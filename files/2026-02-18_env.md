# env

**Type:** File Overview
**Repository:** Cybersecurity-Projects
**File:** TEMPLATES/fullstack-template/backend/alembic/env.py
**Language:** python
**Lines:** 1-119
**Complexity:** 0.0

---

## Source Code

```python
"""
ⒸAngelaMos | 2025
env.py
"""
import asyncio
from logging.config import fileConfig

from alembic import context
from sqlalchemy import pool
from sqlalchemy.engine import Connection
from sqlalchemy.ext.asyncio import async_engine_from_config

from config import settings
from core.Base import Base
from core.enums import SafeEnum
from user.User import User
from auth.RefreshToken import RefreshToken


config = context.config


def render_item(type_, obj, autogen_context):
    """
    Custom renderer for alembic autogenerate.
    Converts SafeEnum to standard sa.Enum and ensures DateTime uses timezone.
    """
    import sqlalchemy as sa

    if isinstance(obj, SafeEnum):
        enum_class = obj.enum_class
        values = [e.value for e in enum_class]
        return f"sa.Enum({', '.join(repr(v) for v in values)}, name='{obj.name}')"

    if isinstance(obj, sa.DateTime):
        return "sa.DateTime(timezone=True)"

    return False


if config.config_file_name is not None:
    fileConfig(config.config_file_name)

target_metadata = Base.metadata


def get_url() -> str:
    """
    Get database URL from settings
    """
    return str(settings.DATABASE_URL)


def run_migrations_offline() -> None:
    """
    Run migrations in 'offline' mode
    """
    url = get_url()
    context.configure(
        url = url,
        target_metadata = target_metadata,
        literal_binds = True,
        dialect_opts = {"paramstyle": "named"},
        compare_type = True,
        compare_server_default = True,
        render_item = render_item,
    )

    with context.begin_transaction():
        context.run_migrations()


def do_run_migrations(connection: Connection) -> None:
    """
    Run migrations with connection
    """
    context.configure(
        connection = connection,
        target_metadata = target_metadata,
        compare_type = True,
        compare_server_default = True,
        render_item = render_item,
    )

    with context.begin_transaction():
        context.run_migrations()


async def run_async_migrations() -> None:
    """
    Run migrations in async mode
    """
    configuration = config.get_section(config.config_ini_section, {})
    configuration["sqlalchemy.url"] = get_url()

    connectable = async_engine_from_config(
        configuration,
        prefix = "sqlalchemy.",
        poolclass = pool.NullPool,
    )

    async with connectable.connect() as connection:
        await connection.run_sync(do_run_migrations)

    await connectable.dispose()


def run_migrations_online() -> None:
    """
    Run migrations in 'online' mode
    """
    asyncio.run(run_async_migrations())


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()

```

---

## File Overview

### Purpose and Responsibility

This `env.py` file is responsible for configuring and running database migrations using Alembic, a popular version control tool for databases. It ensures that schema changes are tracked and applied consistently across different environments.

### Key Exports and Public Interface

- **render_item**: A custom renderer function used by Alembic to generate migration scripts.
- **get_url**: Retrieves the database URL from settings.
- **run_migrations_offline**: Runs migrations in offline mode, useful for non-interactive environments.
- **do_run_migrations**: Executes migrations with a given connection.
- **run_async_migrations**: Asynchronous function that runs migrations using an async engine.
- **run_migrations_online**: Entry point for running migrations in online mode.

### How It Fits into the Project

This file is crucial for managing database schema changes. It integrates with Alembic to generate and apply migrations, ensuring that the database schema stays in sync with the application's evolving structure. The `env.py` file is part of the project’s core infrastructure, facilitating smooth deployment across different environments.

### Notable Design Decisions

- **Alembic Integration**: Uses Alembic for database migration management, providing a robust solution for schema versioning.
- **Custom Renderer**: Implements a custom renderer to handle SafeEnum and DateTime fields appropriately during migrations.
- **Async Support**: Supports both synchronous and asynchronous migration runs, ensuring flexibility across different deployment scenarios.
- **Configuration Flexibility**: Configures the engine dynamically based on settings, making it adaptable to various database configurations.

---

*Generated by CodeWorm on 2026-02-18 14:40*
