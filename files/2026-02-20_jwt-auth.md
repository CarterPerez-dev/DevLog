# jwt_auth

**Type:** File Overview
**Repository:** vuemantics
**File:** backend/auth/jwt_auth.py
**Language:** python
**Lines:** 1-198
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2026
jwt_auth.py
"""

from typing import Any
from uuid import UUID
from datetime import datetime, timedelta, UTC

from fastapi import Depends
from fastapi.security import OAuth2PasswordBearer
from jose import JWTError, jwt

import config
from core import (
    AuthenticationError,
    AuthorizationError,
    BaseAppException,
)
from models.User import User


oauth2_scheme = OAuth2PasswordBearer(tokenUrl = "/api/auth/token")


class TokenType:
    """
    Token type constants.
    """
    ACCESS = "access"
    REFRESH = "refresh"


def create_access_token(user_id: UUID, token_version: int = 0) -> str:
    """
    Create a JWT access token for API requests
    """
    expire = datetime.now(UTC) + timedelta(
        minutes = config.ACCESS_TOKEN_EXPIRE_MINUTES
    )

    payload = {
        "sub": str(user_id),
        "exp": expire,
        "type": TokenType.ACCESS,
        "token_version": token_version,
    }

    return jwt.encode(
        payload,
        config.settings.secret_key,
        algorithm = config.settings.algorithm
    )


def create_refresh_token(user_id: UUID) -> str:
    """
    Create a JWT refresh token for getting new access tokens
    """
    expire = datetime.now(UTC) + timedelta(
        days = config.REFRESH_TOKEN_EXPIRE_DAYS
    )

    payload = {
        "sub": str(user_id),
        "exp": expire,
        "type": TokenType.REFRESH,
    }

    encoded: str = jwt.encode(
        payload,
        config.settings.secret_key,
        algorithm = config.settings.algorithm
    )
    return encoded


def create_token_pair(user_id: UUID,
                      token_version: int = 0) -> dict[str,
                                                      str]:
    """
    Create both access and refresh tokens
    """
    return {
        "access_token": create_access_token(user_id,
                                            token_version),
        "refresh_token": create_refresh_token(user_id),
        "token_type": "bearer",
    }


def decode_token(token: str,
                 expected_type: str | None = None) -> dict[str,
                                                           Any]:
    """
    Decode and validate a JWT token
    """
    try:
        payload: dict[str, Any] = jwt.decode(
            token,
            config.settings.secret_key,
            algorithms = [config.settings.algorithm]
        )

        if expected_type and payload.get("type") != expected_type:
            raise AuthenticationError(
                f"Invalid token type. Expected {expected_type}"
            )

        return payload

    except JWTError as e:
        if "expired" in str(e).lower():
            raise AuthenticationError("Token has expired") from e
        raise AuthenticationError("Could not validate token") from e


async def get_current_user(token: str = Depends(oauth2_scheme)) -> User:
    """
    FastAPI dependency to get current authenticated user
    """
    payload = decode_token(token, expected_type = TokenT
```

---

## File Overview

### jwt_auth.py

**Purpose and Responsibility:**
This file implements JWT token generation, validation, and management for user authentication within the `vuemantics` backend application. It provides secure access control mechanisms using FastAPI dependencies.

**Key Exports and Public Interface:**
- **Token Types:** Constants defining `ACCESS` and `REFRESH` tokens.
- **Token Creation Functions:** `create_access_token`, `create_refresh_token`, and `create_token_pair`.
- **Token Decoding Function:** `decode_token` for validating JWTs.
- **Dependency Functions:** 
  - `get_current_user`: Authenticates the current user based on an access token.
  - `get_current_active_user`: Ensures the authenticated user is active.
  - `refresh_access_token`: Generates a new access token using a valid refresh token.
  - `get_optional_current_user`: Provides optional authentication for public endpoints.

**How It Fits in the Project:**
This module integrates with the FastAPI framework to handle secure user authentication and authorization. It leverages JWTs for stateless session management, ensuring that tokens are securely generated and validated throughout the application lifecycle.

**Notable Design Decisions:**
- **Token Versioning:** Tokens include a version number to detect token invalidation.
- **Error Handling:** Custom exceptions (`AuthenticationError`, `AuthorizationError`) are used to handle authentication failures gracefully.
- **Dependency Injection:** FastAPI dependencies ensure that user authentication is handled consistently across the application, promoting modularity and testability.
```

This documentation provides an overview of the file's purpose, key components, integration within the project, and significant design choices.

---

*Generated by CodeWorm on 2026-02-20 12:17*
