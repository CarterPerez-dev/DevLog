# database

**Type:** File Overview
**Repository:** vuemantics
**File:** backend/database.py
**Language:** python
**Lines:** 1-324
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2026
/backend/database.py
"""

import asyncio
import logging
from collections.abc import AsyncIterator
from contextlib import asynccontextmanager, suppress
from typing import Any

import asyncpg
from asyncpg import Connection, Pool, Record

import config


logger = logging.getLogger(__name__)


class DatabasePool:
    """
    Manages PostgreSQL connection pool with pgvector support

    Provides methods for executing queries, managing transactions,
    and handling vector operations efficiently
    """
    def __init__(self) -> None:
        """
        Initialize database pool instance
        """
        self._pool: Pool | None = None
        self._lock = asyncio.Lock()

    async def connect(self) -> None:
        """
        Initialize connection pool with pgvector extension
        """
        if self._pool is not None:
            return

        async with self._lock:
            if self._pool is not None:
                return  # type: ignore[unreachable]

            try:
                self._pool = await asyncpg.create_pool(
                    config.settings.database_url,
                    min_size = config.settings.db_pool_min_size,
                    max_size = config.settings.db_pool_max_size,
                    command_timeout = config.settings.db_command_timeout,
                    timeout = config.settings.db_pool_timeout,
                    init = self._init_connection,
                )

                await self._verify_pgvector()

                logger.info(
                    "Database pool created successfully",
                    extra = {
                        "min_size": config.settings.db_pool_min_size,
                        "max_size": config.settings.db_pool_max_size,
                    },
                )

            except Exception as e:
                logger.error(f"Failed to create database pool: {e}")
                raise

    async def disconnect(self) -> None:
        """
        Close all connections in the pool
        """
        if self._pool is not None:
            await self._pool.close()
            self._pool = None
            logger.info("Database pool closed")

    async def _init_connection(self, conn: Connection) -> None:
        """
        Initialize individual connection with vector codec
        """
        with suppress(asyncpg.PostgresError, ValueError):
            await conn.set_type_codec(
                "vector",
                encoder = lambda v: f"[{','.join(map(str, v))}]",
                decoder = lambda v: list(map(float, v[1 :-1].split(","))),
                schema = "public",
            )

    async def _verify_pgvector(self) -> None:
        """
        Verify required extensions are installed and create if needed
        Then register vector type codec for all connections
        """
        async with self.acquire() as conn:
            try:
                await conn.execute(
                    'CREATE EXTENSION IF NOT EXISTS "uuid
```

---

## File Overview

### Purpose and Responsibility

This Python source file, `database.py`, manages a connection pool to a PostgreSQL database with support for the pgvector extension. It provides methods for initializing, managing, and executing queries against the database.

### Key Exports and Public Interface

- **`DatabasePool`**: A class responsible for creating and maintaining an asyncpg connection pool.
  - `connect()`: Initializes the connection pool.
  - `disconnect()`: Closes all connections in the pool.
  - `_init_connection(conn)`: Configures each connection to support vector types.
  - `_verify_pgvector()`: Ensures required extensions are installed and registered.
  - `_register_vector_types()`: Registers vector type codecs for all connections.
  - `acquire()`: Acquires a connection from the pool.
  - `transaction()`: A context manager for database transactions (currently marked as future).

### How It Fits in the Project

This file is crucial for establishing and managing database connections, ensuring that the application can efficiently interact with the PostgreSQL database. It integrates seamlessly with other backend components by providing a robust, thread-safe connection pool.

### Notable Design Decisions

- **Async Context Managers**: `acquire()` and `transaction()` are implemented as async context managers to simplify resource management.
- **Error Handling**: Robust error handling is employed using `asynccontextmanager` and `suppress`.
- **Type Hints and Annotations**: Extensive use of type hints and annotations for clarity and maintainability.
- **PostgreSQL Extensions**: Ensures that required extensions like `uuid-ossp` and `vector` are installed, providing vector support for efficient data operations.

---

*Generated by CodeWorm on 2026-02-20 12:25*
