# metrics

**Type:** File Overview
**Repository:** oneIsNun_
**File:** go-backend/internal/mongodb/metrics.go
**Language:** go
**Lines:** 1-251
**Complexity:** 0.0

---

## Source Code

```go
/*
AngelaMos | 2026
metrics.go
*/

package mongodb

import (
	"context"
	"fmt"
	"time"

	"go.mongodb.org/mongo-driver/v2/bson"
	"go.mongodb.org/mongo-driver/v2/mongo"
)

type MetricsRepository struct {
	client *Client
}

func NewMetricsRepository(client *Client) *MetricsRepository {
	return &MetricsRepository{client: client}
}

type ServerStatus struct {
	Host        string    `bson:"host"`
	Version     string    `bson:"version"`
	Uptime      int64     `bson:"uptime"`
	LocalTime   time.Time `bson:"localTime"`
	Connections struct {
		Current      int `bson:"current"`
		Available    int `bson:"available"`
		TotalCreated int `bson:"totalCreated"`
	} `bson:"connections"`
	Opcounters struct {
		Insert  int64 `bson:"insert"`
		Query   int64 `bson:"query"`
		Update  int64 `bson:"update"`
		Delete  int64 `bson:"delete"`
		Getmore int64 `bson:"getmore"`
		Command int64 `bson:"command"`
	} `bson:"opcounters"`
	Mem struct {
		Resident int `bson:"resident"`
		Virtual  int `bson:"virtual"`
	} `bson:"mem"`
	Network struct {
		BytesIn     int64 `bson:"bytesIn"`
		BytesOut    int64 `bson:"bytesOut"`
		NumRequests int64 `bson:"numRequests"`
	} `bson:"network"`
}

type DatabaseStats struct {
	DB          string  `bson:"db"`
	Collections int     `bson:"collections"`
	Views       int     `bson:"views"`
	Objects     int64   `bson:"objects"`
	DataSize    float64 `bson:"dataSize"`
	StorageSize float64 `bson:"storageSize"`
	Indexes     int     `bson:"indexes"`
	IndexSize   float64 `bson:"indexSize"`
}

type CurrentOp struct {
	Inprog []Operation `bson:"inprog"`
}

type Operation struct {
	OpID            int       `bson:"opid"`
	Active          bool      `bson:"active"`
	Op              string    `bson:"op"`
	Namespace       string    `bson:"ns"`
	SecsRunning     int       `bson:"secs_running"`
	MicrosecsRunning int64    `bson:"microsecs_running"`
	Command         bson.Raw  `bson:"command"`
	Client          string    `bson:"client"`
}

func (r *MetricsRepository) GetServerStatus(ctx context.Context) (*ServerStatus, error) {
	var result ServerStatus
	err := r.client.Database("admin").RunCommand(ctx, bson.D{{"serverStatus", 1}}).Decode(&result)
	if err != nil {
		return nil, fmt.Errorf("serverStatus command: %w", err)
	}
	return &result, nil
}

func (r *MetricsRepository) GetDatabaseStats(ctx context.Context, dbName string) (*DatabaseStats, error) {
	var result DatabaseStats
	err := r.client.Database(dbName).RunCommand(ctx, bson.D{{"dbStats", 1}}).Decode(&result)
	if err != nil {
		return nil, fmt.Errorf("dbStats command: %w", err)
	}
	return &result, nil
}

func (r *MetricsRepository) GetCurrentOps(ctx context.Context) ([]Operation, error) {
	pipeline := mongo.Pipeline{
		{{Key: "$currentOp", Value: bson.D{
			{Key: "allUsers", Value: true},
			{Key: "idleConnections", Value: false},
		}}},
		{{Key: "$match", Value: bson.D{
			{Key: "active", Value: true},
		}}},
	}

	cursor, err := r.client.Database("admin").Aggregate(ctx, pipeline)
	if err != nil {
		return nil, fmt.Er
```

---

## File Overview

# metrics.go

## Purpose and Responsibility
This file defines a `MetricsRepository` struct responsible for querying MongoDB server status, database statistics, current operations, list of databases, collection counts, slow queries, and index suggestions.

## Key Exports and Public Interface
- **ServerStatus**: Represents the output of the `serverStatus` command.
- **DatabaseStats**: Contains statistical information about a specific database.
- **Operation**: Describes an ongoing operation in MongoDB.
- **CurrentOps**: Fetches current operations from the `admin` database.
- **ListDatabases**: Lists all databases available on the MongoDB server.
- **GetCollectionCount**: Returns the number of collections in a specified database.
- **SlowQuery**: Represents slow queries and their details.
- **IndexSuggestion**: Provides suggestions for indexing based on query patterns.

## How It Fits into the Project
This file is part of the `mongodb` package, which handles interactions with MongoDB. The `MetricsRepository` provides essential metrics and operational insights, enabling monitoring and performance analysis within the application. These metrics are crucial for maintaining system health and optimizing database operations.

## Notable Design Decisions
- **Error Handling**: Uses Go's idiomatic error handling to manage potential failures during command execution.
- **Context Passing**: Utilizes `context.Context` for clean cancellation of operations, ensuring graceful termination when necessary.
- **BSON Encoding/Decoding**: Leverages MongoDB's `bson` package for efficient data serialization and deserialization.
- **Aggregation Pipelines**: Constructs complex queries using MongoDB aggregation pipelines to fetch detailed operational information.

---

*Generated by CodeWorm on 2026-02-19 23:20*
