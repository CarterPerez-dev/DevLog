# RateLimiter

**Type:** Class Documentation
**Repository:** Telehook
**File:** src/telehook/middleware/rate_limiter.py
**Language:** python
**Lines:** 12-39
**Complexity:** 0.0

---

## Source Code

```python
class RateLimiter:
    def __init__(self, max_per_second: float = 1.0, burst: int = 3):
        self._max_per_second = max_per_second
        self._burst = burst
        self._tokens = float(burst)
        self._last_refill = time.monotonic()
        self._dropped_count = 0

    def _refill(self) -> None:
        now = time.monotonic()
        elapsed = now - self._last_refill
        self._tokens = min(
            self._burst,
            self._tokens + elapsed * self._max_per_second
        )
        self._last_refill = now

    async def __call__(self, message: Message, next_: SendFunc) -> None:
        self._refill()

        if self._tokens >= 1.0:
            self._tokens -= 1.0
            if self._dropped_count > 0:
                message.metadata["dropped_count"] = self._dropped_count
                self._dropped_count = 0
            await next_(message)
        else:
            self._dropped_count += 1
```

---

## Class Documentation

### RateLimiter Class Documentation

**Class Responsibility and Purpose:**
The `RateLimiter` class is responsible for controlling message throughput by limiting the number of messages that can be processed per second, with an optional burst allowance. This ensures that the system does not overload due to excessive requests.

**Public Interface (Key Methods):**
- **`__init__(self, max_per_second: float = 1.0, burst: int = 3)`**: Initializes the rate limiter with a maximum tokens per second and an initial burst allowance.
- **`_refill(self) -> None`**: Refills the token bucket based on elapsed time since the last refill.
- **`__call__(self, message: Message, next_: SendFunc) -> None`**: Processes incoming messages by either passing them to the next handler or dropping them if the token count is insufficient.

**Design Patterns Used:**
The class implements a simple token bucket algorithm, which is a common pattern for rate limiting. It does not explicitly use any design patterns like Factory, Observer, or Strategy but follows a state management approach typical of such algorithms.

**How it Fits in the Architecture:**
`RateLimiter` acts as a middleware component within the Telehook architecture, ensuring that message processing rates are controlled and preventing potential overloading issues. It is designed to be easily integrated into the existing system by being called directly on incoming messages, making sure only an allowed number of messages pass through at any given time.

---

*Generated by CodeWorm on 2026-02-28 23:51*
