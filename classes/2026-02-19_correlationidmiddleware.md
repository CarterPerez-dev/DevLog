# CorrelationIdMiddleware

**Type:** Class Documentation
**Repository:** vuemantics
**File:** backend/core/correlation.py
**Language:** python
**Lines:** 21-66
**Complexity:** 0.0

---

## Source Code

```python
class CorrelationIdMiddleware(BaseHTTPMiddleware):
    """
    Correlation ID middleware for distributed tracing and request tracking

    Features:
    - Accepts existing correlation ID
      from upstream services via X-Correlation-ID header
    - Generates new UUID if no correlation ID provided
    - Tracks request timing and performance
    - Logs request lifecycle with correlation ID
    - Exposes correlation ID in response headers
    """
    async def dispatch(
        self,
        request: Request,
        call_next: RequestResponseEndpoint,
    ) -> Response:
        correlation_id = request.headers.get(
            "X-Correlation-ID",
            str(uuid.uuid4()),
        )

        request.state.correlation_id = correlation_id

        start_time = time.time()
        logger.info(
            "[%s] %s %s",
            correlation_id,
            request.method,
            request.url.path
        )

        response = await call_next(request)

        duration = time.time() - start_time
        logger.info(
            "[%s] %s %s - status=%s duration=%.3fs",
            correlation_id,
            request.method,
            request.url.path,
            response.status_code,
            duration
        )

        response.headers["X-Correlation-ID"] = correlation_id
        return response
```

---

## Class Documentation

### CorrelationIdMiddleware Documentation

**Class Responsibility and Purpose:**
The `CorrelationIdMiddleware` class is designed to manage distributed tracing and request tracking by handling correlation IDs. It ensures that each request has a unique identifier, either inherited from upstream services or generated locally if not provided. This middleware also tracks the duration of requests and logs their lifecycle, facilitating easier debugging and performance analysis.

**Public Interface:**
- **`dispatch(request: Request, call_next: RequestResponseEndpoint) -> Response`:** The primary method that processes each incoming request by setting up the correlation ID in the `request.state`, logging the start time, invoking the next middleware or endpoint, and then logging the end time with details about the response.

**Design Patterns Used:**
- **Observer Pattern:** Implicitly used through the `BaseHTTPMiddleware` base class, which allows this middleware to observe and modify request handling.
- **Strategy Pattern:** Not explicitly implemented but implied in how different strategies for generating or obtaining correlation IDs can be abstracted.

**How it Fits in the Architecture:**
This middleware is part of a broader architecture that emphasizes observability and traceability. It integrates seamlessly with other middlewares and endpoints, ensuring consistent behavior across the application. By exposing the `X-Correlation-ID` header in responses, it enables downstream services to maintain context throughout the request lifecycle, enhancing debugging capabilities and performance monitoring.

---

*Generated by CodeWorm on 2026-02-19 07:13*
