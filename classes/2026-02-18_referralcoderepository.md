# ReferralCodeRepository

**Type:** Class Documentation
**Repository:** stripe-referral
**File:** src/stripe_referral/repositories/referral_repo.py
**Language:** python
**Lines:** 20-58
**Complexity:** 0.0

---

## Source Code

```python
class ReferralCodeRepository(BaseRepository[ReferralCode]):
    """
    Repository for ReferralCode database operations
    """
    def __init__(self, db: Session) -> None:
        """
        Initialize with ReferralCode model
        """
        super().__init__(db, ReferralCode)

    def get_by_code(self, code: str) -> ReferralCode | None:
        """
        Get referral code by code string
        """
        stmt = select(ReferralCode).where(ReferralCode.code == code)
        return self.db.execute(stmt).scalar_one_or_none()

    def get_by_user(self,
                    user_id: str,
                    program_id: int | None = None) -> list[ReferralCode]:
        """
        Get all codes for a user optionally filtered by program
        """
        stmt = select(ReferralCode).where(ReferralCode.user_id == user_id)
        if program_id:
            stmt = stmt.where(ReferralCode.program_id == program_id)
        return list(self.db.execute(stmt).scalars().all())

    def increment_uses(self, code_id: int) -> bool:
        """
        Atomically increment uses count
        """
        code = self.get_by_id(code_id)
        if not code:
            return False

        code.uses_count += 1
        self.db.commit()
        return True
```

---

## Class Documentation

### ReferralCodeRepository Documentation

**Class Responsibility and Purpose:**
The `ReferralCodeRepository` class is responsible for managing database operations related to `ReferralCode` entities within the `stripe-referral` application. It provides methods to retrieve referral codes by code or user, and increment the usage count of a specific code.

**Public Interface (Key Methods):**
- **`__init__(self, db: Session) -> None`:** Initializes the repository with a database session.
- **`get_by_code(self, code: str) -> ReferralCode | None`:** Retrieves a referral code by its unique code string.
- **`get_by_user(self, user_id: str, program_id: int | None = None) -> list[ReferralCode]`:** Fetches all referral codes associated with a specific user, optionally filtered by a program ID.
- **`increment_uses(self, code_id: int) -> bool`:** Atomically increments the usage count of a referral code identified by its ID.

**Design Patterns Used:**
The class leverages the **Repository Pattern**, which encapsulates persistence logic and provides a clean interface for interacting with data. The use of SQLAlchemy's `Session` object ensures database operations are handled efficiently, adhering to Pythonic practices such as context managers and type hints.

**How it Fits in the Architecture:**
This repository acts as an intermediary between the applicationâ€™s business logic and the database layer. It is designed to be agnostic of specific implementation details, allowing for easy integration with other parts of the application. The `ReferralCodeRepository` interacts directly with the `ReferralCode` model, ensuring that all database operations are encapsulated within this class. This design promotes loose coupling and makes it easier to test and maintain the codebase.

---

*Generated by CodeWorm on 2026-02-18 23:15*
