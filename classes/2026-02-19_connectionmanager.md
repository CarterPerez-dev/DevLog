# ConnectionManager

**Type:** Class Documentation
**Repository:** CodeWorm
**File:** dashboard/backend/ws.py
**Language:** python
**Lines:** 21-54
**Complexity:** 0.0

---

## Source Code

```python
class ConnectionManager:
    def __init__(self) -> None:
        self.active: list[WebSocket] = []
        self.log_buffer: deque[dict[str, Any]] = deque(maxlen=LOG_BUFFER_SIZE)

    async def connect(self, websocket: WebSocket) -> None:
        await websocket.accept()
        self.active.append(websocket)
        if self.log_buffer:
            history = orjson.dumps({
                "channel": "codeworm:history",
                "data": list(self.log_buffer),
            }).decode("utf-8")
            try:
                await websocket.send_text(history)
            except Exception:
                pass

    def disconnect(self, websocket: WebSocket) -> None:
        if websocket in self.active:
            self.active.remove(websocket)

    async def broadcast(self, message: dict[str, Any]) -> None:
        if message.get("channel") in ("codeworm:logs", "codeworm:events"):
            self.log_buffer.append(message)
        payload = orjson.dumps(message).decode("utf-8")
        disconnected: list[WebSocket] = []
        for ws in self.active:
            try:
                await ws.send_text(payload)
            except Exception:
                disconnected.append(ws)
        for ws in disconnected:
            self.disconnect(ws)
```

---

## Class Documentation

### ConnectionManager Documentation

**Class Responsibility and Purpose:**
The `ConnectionManager` class manages WebSocket connections for a real-time application, handling connection establishment, disconnection, and message broadcasting. It ensures that active WebSocket clients receive relevant messages and maintains a log buffer for historical data.

**Public Interface (Key Methods):**
- **`__init__()`**: Initializes the manager with an empty list of active WebSockets and a log buffer.
- **`connect(websocket: WebSocket) -> None`**: Accepts a WebSocket connection, adds it to the active clients, and sends historical logs if available.
- **`disconnect(websocket: WebSocket) -> None`**: Removes a WebSocket from the active client list upon disconnection.
- **`broadcast(message: dict[str, Any]) -> None`**: Broadcasts messages to all connected WebSockets, updating the log buffer as necessary.

**Design Patterns Used:**
The class employs the **Observer Pattern** through its `connect()` and `disconnect()` methods, where WebSocket clients are observed for connection and disconnection events. It also uses a simple state management approach with a `log_buffer` to manage historical data.

**How it Fits in the Architecture:**
In the broader architecture of CodeWorm's backend, `ConnectionManager` acts as a central hub for WebSocket communication. It integrates with other components such as event handlers and loggers, ensuring real-time updates and maintaining session state efficiently. The class is crucial for enabling seamless interaction between the server and connected clients, facilitating dynamic content delivery and real-time data synchronization.

---

*Generated by CodeWorm on 2026-02-19 14:36*
