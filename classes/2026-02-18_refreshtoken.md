# RefreshToken

**Type:** Class Documentation
**Repository:** Cybersecurity-Projects
**File:** TEMPLATES/fullstack-template/backend/app/auth/RefreshToken.py
**Language:** python
**Lines:** 40-117
**Complexity:** 0.0

---

## Source Code

```python
class RefreshToken(Base, UUIDMixin, TimestampMixin):
    """
    Refresh token for JWT authentication

    Tokens are stored as SHA 256 hashes, never raw
    Family ID enables detection of token reuse attacks
    """
    __tablename__ = "refresh_tokens"

    token_hash: Mapped[str] = mapped_column(
        String(TOKEN_HASH_LENGTH),
        unique = True,
        index = True,
    )

    user_id: Mapped[UUID] = mapped_column(
        ForeignKey("users.id",
                   ondelete = "CASCADE"),
        index = True,
    )

    family_id: Mapped[UUID] = mapped_column(
        default = uuid6.uuid7,
        index = True,
    )

    device_id: Mapped[str | None] = mapped_column(
        String(DEVICE_ID_MAX_LENGTH),
        default = None,
    )
    device_name: Mapped[str | None] = mapped_column(
        String(DEVICE_NAME_MAX_LENGTH),
        default = None,
    )
    ip_address: Mapped[str | None] = mapped_column(
        String(IP_ADDRESS_MAX_LENGTH),
        default = None,
    )

    expires_at: Mapped[datetime] = mapped_column(
        DateTime(timezone = True),
        index = True,
    )

    is_revoked: Mapped[bool] = mapped_column(default = False)
    revoked_at: Mapped[datetime | None] = mapped_column(
        DateTime(timezone = True),
        default = None,
    )

    user: Mapped[User] = relationship(back_populates = "refresh_tokens")

    def revoke(self) -> None:
        """
        Revoke this token
        """
        self.is_revoked = True
        self.revoked_at = datetime.now(UTC)

    @property
    def is_expired(self) -> bool:
        """
        Check if token has expired

        Handles both timezone aware and naive datetimes for SQLite compatibility
        """
        now = datetime.now(UTC)
        expires = self.expires_at
        if expires.tzinfo is None:
            expires = expires.replace(tzinfo = UTC)
        return now > expires

    @property
    def is_valid(self) -> bool:
        """
        Check if token is usable
        """
        return not self.is_revoked and not self.is_expired
```

---

## Class Documentation

### RefreshToken Class Documentation

**Class Responsibility and Purpose:**
The `RefreshToken` class models a refresh token for JWT authentication, ensuring secure user sessions by tracking token usage, expiration, and revocation. Tokens are stored as SHA-256 hashes to maintain security.

**Public Interface (Key Methods):**
- **`revoke(self) -> None`:** Marks the token as revoked and records the revocation time.
- **`@property is_expired(self) -> bool`:** Checks if the token has expired, handling timezone-aware and naive datetimes for SQLite compatibility.
- **`@property is_valid(self) -> bool`:** Determines if the token is currently usable by checking its revocation status and expiration.

**Design Patterns Used:**
The class employs the **Strategy Pattern** through the `is_expired` and `is_valid` properties, allowing flexible validation logic. It also uses the **Active Record Pattern**, managing database interactions directly within the model.

**Relationship to Other Classes:**
- **User:** A `RefreshToken` is associated with a `User`, enabling tracking of token usage per user.
- **UUIDMixin, TimestampMixin:** These mixins provide common functionality for UUID and timestamp management, ensuring consistency across models.

**State Management Approach:**
The class manages the state of tokens through attributes like `is_revoked`, `revoked_at`, `expires_at`, and `is_valid`. These states are updated as needed to reflect the token's current status.

---

*Generated by CodeWorm on 2026-02-18 11:24*
