# RefreshToken

**Type:** Class Documentation
**Repository:** my-portfolio
**File:** v1/backend/app/auth/RefreshToken.py
**Language:** python
**Lines:** 35-112
**Complexity:** 0.0

---

## Source Code

```python
class RefreshToken(Base, UUIDMixin, TimestampMixin):
    """
    Refresh token for JWT authentication

    Tokens are stored as SHA 256 hashes, never raw
    Family ID enables detection of token reuse attacks
    """
    __tablename__ = "refresh_tokens"

    token_hash: Mapped[str] = mapped_column(
        String(config.TOKEN_HASH_LENGTH),
        unique = True,
        index = True,
    )

    user_id: Mapped[UUID] = mapped_column(
        ForeignKey("users.id",
                   ondelete = "CASCADE"),
        index = True,
    )

    family_id: Mapped[UUID] = mapped_column(
        default = uuid6.uuid7,
        index = True,
    )

    device_id: Mapped[str | None] = mapped_column(
        String(config.DEVICE_ID_MAX_LENGTH),
        default = None,
    )
    device_name: Mapped[str | None] = mapped_column(
        String(config.DEVICE_NAME_MAX_LENGTH),
        default = None,
    )
    ip_address: Mapped[str | None] = mapped_column(
        String(config.IP_ADDRESS_MAX_LENGTH),
        default = None,
    )

    expires_at: Mapped[datetime] = mapped_column(
        DateTime(timezone = True),
        index = True,
    )

    is_revoked: Mapped[bool] = mapped_column(default = False)
    revoked_at: Mapped[datetime | None] = mapped_column(
        DateTime(timezone = True),
        default = None,
    )

    user: Mapped[User] = relationship(back_populates = "refresh_tokens")

    def revoke(self) -> None:
        """
        Revoke this token
        """
        self.is_revoked = True
        self.revoked_at = datetime.now(UTC)

    @property
    def is_expired(self) -> bool:
        """
        Check if token has expired

        Handles both timezone aware and naive datetimes for SQLite compatibility
        """
        now = datetime.now(UTC)
        expires = self.expires_at
        if expires.tzinfo is None:
            expires = expires.replace(tzinfo = UTC)
        return now > expires

    @property
    def is_valid(self) -> bool:
        """
        Check if token is usable
        """
        return not self.is_revoked and not self.is_expired
```

---

## Class Documentation

### RefreshToken Class Documentation

**Class Responsibility and Purpose:**
The `RefreshToken` class manages JWT refresh tokens for user authentication. It stores token hashes, user associations, device information, and expiration details. The class ensures that tokens are securely managed by tracking their revocation status and expiration.

**Public Interface (Key Methods):**
- **revoke()**: Marks the token as revoked.
- **is_expired**: Checks if the token has expired based on its `expires_at` timestamp.
- **is_valid**: Determines if the token is currently valid, considering both revocation and expiration statuses.

**Design Patterns Used:**
The class leverages SQLAlchemy ORM for database interactions. It uses a property pattern to encapsulate logic for checking token validity and expiration without exposing internal state directly.

**How it Fits in the Architecture:**
`RefreshToken` integrates into the authentication system by providing secure, time-bound tokens that can be issued and revoked as needed. It is part of the broader user authentication framework, interacting with `User` entities to manage access and session states effectively. The class ensures that token management is consistent across different parts of the application, enhancing security and maintainability.

---

*Generated by CodeWorm on 2026-02-18 21:10*
