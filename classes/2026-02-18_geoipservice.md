# GeoIPService

**Type:** Class Documentation
**Repository:** CertGames-Core
**File:** backend/api/core/services/clients/geo_ip.py
**Language:** python
**Lines:** 11-241
**Complexity:** 0.0

---

## Source Code

```python
class GeoIPService:
    """
    GeoIP - IP-API.com - 15,000 requests/hr
    """
    def __init__(self) -> None:
        self.base_url = "http://ip-api.com/json"
        self.timeout = 5

    def get_location_info(self, ip_address: str | None) -> dict[str, Any]:
        """
        Get location information from IP address using IP-API.com
        """
        if not ip_address or ip_address in ["127.0.0.1",
                                            "::1",
                                            "localhost"]:
            return {
                "ip": ip_address,
                "city": "Unknown",
                "country": "Unknown",
                "timezone": "Unknown",
                "success": False,
                "error": "Invalid or local IP address"
            }

        try:
            url = f"{self.base_url}/{ip_address}?fields=status,message,country,countryCode,region,regionName,city,zip,lat,lon,timezone,isp,org,as,query"

            response = requests.get(url, timeout = self.timeout)
            response.raise_for_status()

            data = response.json()

            if data.get("status") == "success":
                return {
                    "ip": data.get("query",
                                   ip_address),
                    "city": data.get("city",
                                     "Unknown"),
                    "region": data.get("regionName",
                                       "Unknown"),
                    "region_code": data.get("region",
                                            "Unknown"),
                    "country": data.get("country",
                                        "Unknown"),
                    "country_code": data.get("countryCode",
                                             "Unknown"),
                    "timezone": data.get("timezone",
                                         "Unknown"),
                    "latitude": data.get("lat"),
                    "longitude": data.get("lon"),
                    "zip": data.get("zip"),
                    "isp": data.get("isp",
                                    "Unknown"),
                    "organization": data.get("org",
                                             "Unknown"),
                    "as_number": data.get("as",
                                          "Unknown"),
                    "success": True
                }

            error_msg = data.get("message", "Unknown error")
            current_app.logger.warning(
                f"IP-API.com returned failure for {ip_address}: {error_msg}"
            )
            return {
                "ip": ip_address,
                "city": "Unknown",
                "country": "Unknown",
                "timezone": "Unknown",
                "success": False,
                "error": error_msg
            }

        except requests.exceptions.Timeout:
            current_app.logger.error(
                f"Timeout getting location for IP {ip_address}"
            )

```

---

## Class Documentation

### GeoIPService Documentation

**Class Responsibility and Purpose:**
The `GeoIPService` class is responsible for retrieving location information from IP addresses using the IP-API.com service. It handles both single and bulk requests, ensuring that the API's rate limits and batch request capabilities are utilized effectively.

**Public Interface (Key Methods):**
- **get_location_info(ip_address: str | None) -> dict[str, Any]:** Retrieves location data for a single IP address.
- **get_bulk_location_info(ip_addresses: list[str]) -> dict[str, dict[str, Any]]:** Fetches location information for multiple IP addresses in batches.

**Design Patterns Used:**
The class employs the following design patterns:
- **Strategy Pattern:** The `get_location_info` and `get_bulk_location_info` methods handle different request types (single vs. bulk), allowing for flexible and extensible behavior.
- **Error Handling:** Comprehensive error handling is implemented using try-except blocks to manage various exceptions, ensuring robustness.

**Relationship to Other Classes:**
This class interacts with the `requests` library to make HTTP requests and logs errors using a logger instance from the Flask application context (`current_app.logger`). It is part of the backend API service layer, providing essential geolocation services for other components in the CertGames-Core architecture.

---

*Generated by CodeWorm on 2026-02-18 14:30*
