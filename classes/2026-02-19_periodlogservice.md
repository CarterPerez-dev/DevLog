# PeriodLogService

**Type:** Class Documentation
**Repository:** ios-test
**File:** fastapi/app/period_log/service.py
**Language:** python
**Lines:** 18-161
**Complexity:** 0.0

---

## Source Code

```python
class PeriodLogService:
    """
    Business logic for period log operations
    """
    def __init__(self, session: AsyncSession) -> None:
        self.session = session

    async def _get_partner_id(self, user_id: UUID) -> UUID:
        """
        Get partner ID for user, raise if not found
        """
        partner = await PartnerRepository.get_by_user_id(self.session, user_id)
        if not partner:
            raise PartnerNotFound(str(user_id))
        return partner.id

    async def create_period_log(
        self,
        user_id: UUID,
        data: PeriodLogCreate,
    ) -> PeriodLogResponse:
        """
        Create a new period log entry
        """
        partner_id = await self._get_partner_id(user_id)

        existing = await PeriodLogRepository.get_by_partner_and_date(
            self.session,
            partner_id,
            data.start_date,
        )
        if existing:
            raise PeriodLogAlreadyExists(str(data.start_date))

        previous_log = await PeriodLogRepository.get_latest_for_partner(
            self.session,
            partner_id,
        )
        cycle_length = None
        if previous_log and not previous_log.is_predicted:
            days_diff = (data.start_date - previous_log.start_date).days
            if 21 <= days_diff <= 45:
                cycle_length = days_diff

        await PeriodLogRepository.delete_predicted_after_date(
            self.session,
            partner_id,
            data.start_date,
        )

        period_log = await PeriodLogRepository.create(
            self.session,
            partner_id = partner_id,
            start_date = data.start_date,
            end_date = data.end_date,
            flow_intensity = data.flow_intensity,
            notes = data.notes,
            cycle_length = cycle_length,
            is_predicted = False,
        )

        partner = await PartnerRepository.get_by_user_id(self.session, user_id)
        if partner:
            await PartnerRepository.update_last_period(
                self.session,
                partner,
                data.start_date,
            )

        return PeriodLogResponse.model_validate(period_log)

    async def get_period_logs(
        self,
        user_id: UUID,
        skip: int = 0,
        limit: int = 20,
    ) -> Sequence[PeriodLogResponse]:
        """
        Get period logs for user's partner
        """
        partner_id = await self._get_partner_id(user_id)

        logs = await PeriodLogRepository.get_by_partner_id(
            self.session,
            partner_id,
            skip = skip,
            limit = limit,
        )
        return [PeriodLogResponse.model_validate(log) for log in logs]

    async def get_period_log(
        self,
        user_id: UUID,
        log_id: UUID,
    ) -> PeriodLogResponse:
        """
        Get a specific period log by ID
        """
        partner_id = await self._get_partner_id(user_id)

        log = await PeriodLogRepository.get_by
```

---

## Class Documentation

### PeriodLogService Documentation

**Class Responsibility and Purpose:**
The `PeriodLogService` class handles business logic for period log operations, including creating, retrieving, updating, and deleting logs. It ensures that each operation adheres to the defined rules and relationships with other entities.

**Public Interface (Key Methods):**
- **create_period_log**: Creates a new period log entry.
- **get_period_logs**: Retrieves a paginated list of period logs for a user's partner.
- **get_period_log**: Fetches a specific period log by ID.
- **update_period_log**: Updates an existing period log entry.
- **delete_period_log**: Deletes a specified period log.

**Design Patterns Used:**
The class leverages the **Repository Pattern** to abstract data access logic, ensuring that business rules are separated from database operations. This pattern is used through `PartnerRepository` and `PeriodLogRepository`.

**How It Fits in the Architecture:**
`PeriodLogService` acts as a service layer, providing high-level operations for managing period logs. It interacts with repositories to perform CRUD operations while enforcing business logic. The class ensures that each method adheres to the Single Responsibility Principle by focusing on specific tasks such as creating, retrieving, updating, and deleting period logs.

This design promotes loose coupling between the service and repository layers, making it easier to modify or replace either layer without affecting the other.

---

*Generated by CodeWorm on 2026-02-19 08:46*
