# ConnectionManager

**Type:** Class Documentation
**Repository:** CodeWorm
**File:** dashboard/backend/ws.py
**Language:** python
**Lines:** 22-57
**Complexity:** 0.0

---

## Source Code

```python
class ConnectionManager:
    def __init__(self) -> None:
        self.active: list[WebSocket] = []
        self.log_buffer: deque[dict[str, Any]] = deque(maxlen = LOG_BUFFER_SIZE)

    async def connect(self, websocket: WebSocket) -> None:
        await websocket.accept()
        self.active.append(websocket)
        if self.log_buffer:
            history = orjson.dumps(
                {
                    "channel": "codeworm:history",
                    "data": list(self.log_buffer),
                }
            ).decode("utf-8")
            try:  # noqa: SIM105
                await websocket.send_text(history)
            except Exception:  # noqa: S110
                pass

    def disconnect(self, websocket: WebSocket) -> None:
        if websocket in self.active:
            self.active.remove(websocket)

    async def broadcast(self, message: dict[str, Any]) -> None:
        if message.get("channel") in ("codeworm:logs", "codeworm:events"):
            self.log_buffer.append(message)
        payload = orjson.dumps(message).decode("utf-8")
        disconnected: list[WebSocket] = []
        for ws in self.active:
            try:
                await ws.send_text(payload)
            except Exception:
                disconnected.append(ws)
        for ws in disconnected:
            self.disconnect(ws)
```

---

## Class Documentation

### ConnectionManager Documentation

**Class Responsibility and Purpose**
The `ConnectionManager` class manages WebSocket connections, ensuring that messages are broadcasted to all connected clients while maintaining a log buffer for specific message channels.

**Public Interface (Key Methods)**
- **`__init__()`**: Initializes the instance with an empty list of active WebSockets and a log buffer.
- **`connect(websocket: WebSocket)`**: Accepts a WebSocket connection, adds it to the active connections, and sends historical logs if available.
- **`disconnect(websocket: WebSocket)`**: Removes a WebSocket from the active connections when it disconnects.
- **`broadcast(message: dict[str, Any])`**: Broadcasts messages to all connected WebSockets, logging relevant messages.

**Design Patterns Used**
The class leverages the **Observer Pattern** implicitly by managing multiple WebSocket clients and broadcasting messages to them. It also uses a **Strategy Pattern** for handling different types of messages (e.g., logs vs. events).

**How it Fits in the Architecture**
`ConnectionManager` is a core component responsible for WebSocket communication within the CodeWorm application. It integrates with other services by maintaining state and ensuring that all connected clients receive relevant updates, making it essential for real-time data synchronization. The class interacts with `WebSocket` objects to manage connections and broadcasts messages, fitting into the broader architecture as a central hub for WebSocket operations.

---

*Generated by CodeWorm on 2026-02-28 20:11*
