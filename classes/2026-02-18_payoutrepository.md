# PayoutRepository

**Type:** Class Documentation
**Repository:** stripe-referral
**File:** src/stripe_referral/repositories/payout_repo.py
**Language:** python
**Lines:** 20-104
**Complexity:** 0.0

---

## Source Code

```python
class PayoutRepository(BaseRepository[Payout]):
    """
    Repository for Payout database operations
    """
    def __init__(self, db: Session) -> None:
        """
        Initialize with Payout model
        """
        super().__init__(db, Payout)

    def get_by_user(self, user_id: str) -> list[Payout]:
        """
        Get all payouts for a user
        """
        stmt = select(Payout).where(Payout.user_id == user_id)
        return list(self.db.execute(stmt).scalars().all())

    def get_by_tracking_id(self, tracking_id: int) -> Payout | None:
        """
        Get payout by tracking ID
        """
        stmt = select(Payout).where(Payout.tracking_id == tracking_id)
        return self.db.execute(stmt).scalar_one_or_none()

    def get_pending_payouts(self,
                            limit: int | None = None) -> list[Payout]:
        """
        Get all pending payouts with optional limit
        """
        stmt = select(Payout).where(
            Payout.status == PayoutStatus.PENDING.value
        )
        if limit:
            stmt = stmt.limit(limit)
        return list(self.db.execute(stmt).scalars().all())

    def get_failed_payouts(self,
                           limit: int | None = None) -> list[Payout]:
        """
        Get all failed payouts with optional limit
        """
        stmt = select(Payout).where(
            Payout.status == PayoutStatus.FAILED.value
        )
        if limit:
            stmt = stmt.limit(limit)
        return list(self.db.execute(stmt).scalars().all())

    def mark_as_paid(
        self,
        payout_id: int,
        transaction_id: str
    ) -> Payout | None:
        """
        Mark payout as paid with transaction ID
        """
        payout = self.get_by_id(payout_id)
        if not payout:
            return None

        payout.status = PayoutStatus.PAID.value
        payout.external_transaction_id = transaction_id
        payout.processed_at = datetime.now(UTC)
        self.db.commit()
        self.db.refresh(payout)
        return payout

    def mark_as_failed(
        self,
        payout_id: int,
        error_message: str
    ) -> Payout | None:
        """
        Mark payout as failed with error message
        """
        payout = self.get_by_id(payout_id)
        if not payout:
            return None

        payout.status = PayoutStatus.FAILED.value
        payout.error_message = error_message
        payout.failed_at = datetime.now(UTC)
        self.db.commit()
        self.db.refresh(payout)
        return payout
```

---

## Class Documentation

### PayoutRepository Documentation

**Class Responsibility and Purpose:**
The `PayoutRepository` class is responsible for managing database operations related to `Payout` entities within the `stripe-referral` application. It provides methods to retrieve, update, and manage payouts based on various criteria such as user ID, tracking ID, status, etc.

**Public Interface (Key Methods):**
- **get_by_user(user_id: str) -> list[Payout]:** Retrieves all payouts associated with a given user.
- **get_by_tracking_id(tracking_id: int) -> Payout | None:** Fetches a payout by its unique tracking ID.
- **get_pending_payouts(limit: int | None = None) -> list[Payout]:** Returns pending payouts, optionally limited in number.
- **get_failed_payouts(limit: int | None = None) -> list[Payout]:** Retrieves failed payouts with an optional limit.
- **mark_as_paid(payout_id: int, transaction_id: str) -> Payout | None:** Marks a payout as paid and records the transaction ID.
- **mark_as_failed(payout_id: int, error_message: str) -> Payout | None:** Marks a payout as failed with an associated error message.

**Design Patterns Used:**
The class utilizes the **Repository Pattern**, which abstracts data access operations. It also employs the **Active Record Pattern** for handling database records directly within the repository methods.

**How it Fits in the Architecture:**
`PayoutRepository` is part of the Data Access Layer (DAL) and interacts with the `Session` object from SQLAlchemy to perform CRUD operations on the `Payout` model. It provides a clean interface for higher-level services or controllers to interact with the database without dealing directly with SQL queries, promoting separation of concerns and making the code more maintainable.

---

*Generated by CodeWorm on 2026-02-18 22:41*
