# Batch

**Type:** Class Documentation
**Repository:** Telehook
**File:** src/telehook/middleware/batch.py
**Language:** python
**Lines:** 12-59
**Complexity:** 0.0

---

## Source Code

```python
class Batch:
    def __init__(self, window_seconds: float = 5.0, max_size: int = 10):
        self._window = window_seconds
        self._max_size = max_size
        self._buffer: list[Message] = []
        self._next: SendFunc | None = None
        self._timer: asyncio.TimerHandle | None = None

    async def __call__(self, message: Message, next_: SendFunc) -> None:
        self._next = next_
        self._buffer.append(message)

        if len(self._buffer) >= self._max_size:
            await self.flush()
            return

        if self._timer is None:
            loop = asyncio.get_running_loop()
            self._timer = loop.call_later(
                self._window,
                lambda: asyncio.ensure_future(self.flush()),
            )

    async def flush(self) -> None:
        if self._timer is not None:
            self._timer.cancel()
            self._timer = None

        if not self._buffer or self._next is None:
            return

        messages = self._buffer[:]
        self._buffer.clear()

        if len(messages) == 1:
            await self._next(messages[0])
            return

        combined_text = "\n\n---\n\n".join(m.text for m in messages)
        combined = Message(
            text = combined_text,
            parse_mode = messages[0].parse_mode,
            metadata = {"batched_count": len(messages)},
        )
        await self._next(combined)

    async def close(self) -> None:
        await self.flush()
```

---

## Class Documentation

### Batch Class Documentation

**Class Responsibility and Purpose:**
The `Batch` class is responsible for batching messages to be sent over a period of time or when a certain buffer size is reached, ensuring efficient message transmission by combining multiple messages into one.

**Public Interface (Key Methods):**
- **`__call__(self, message: Message, next_: SendFunc) -> None`:** This method is called with each incoming message. It buffers the messages and schedules a flush operation if the buffer exceeds the maximum size or after a specified window of time.
- **`flush(self) -> None`:** Flushes the buffered messages by sending them as a single combined message, handling cancellation of pending timers.
- **`close(self) -> None`:** Ensures all buffered messages are sent before closing the batch.

**Design Patterns Used:**
The `Batch` class employs the **Strategy Pattern** for handling different strategies in flushing messages and the **Observer Pattern** through the `next_` callback, which acts as an observer to be notified when messages are ready to be sent.

**How it Fits in the Architecture:**
This class is part of a middleware system in Telehook that processes incoming messages. It integrates with the main message handling logic by intercepting messages and batching them before sending, optimizing network usage and reducing the number of API calls made to the Telegram server. The `Batch` class works closely with other components like `SendFunc`, which represents the next stage in the message processing pipeline.

---

*Generated by CodeWorm on 2026-02-28 22:34*
