# Retry

**Type:** Class Documentation
**Repository:** Telehook
**File:** src/telehook/middleware/retry.py
**Language:** python
**Lines:** 13-39
**Complexity:** 0.0

---

## Source Code

```python
class Retry:
    def __init__(self, max_attempts: int = 3, initial_backoff: float = 2.0):
        self._max_attempts = max_attempts
        self._initial_backoff = initial_backoff

    async def __call__(self, message: Message, next_: SendFunc) -> None:
        last_error: TelegramAPIError | None = None

        for attempt in range(self._max_attempts):
            try:
                await next_(message)
                return
            except TelegramAPIError as e:
                if e.status_code < 500 and e.status_code != 429:
                    raise

                last_error = e

                if attempt < self._max_attempts - 1:
                    if e.retry_after:
                        delay = min(e.retry_after, 60)
                    else:
                        delay = self._initial_backoff * (2**attempt)
                    await asyncio.sleep(delay)

        if last_error:
            raise last_error
```

---

## Class Documentation

### Retry Class Documentation

**Class Responsibility and Purpose:**
The `Retry` class is designed to handle retries for asynchronous operations, specifically for sending messages using a Telegram API client. It ensures that failed attempts due to transient errors are retried with exponential backoff until the maximum number of attempts is reached or the operation succeeds.

**Public Interface (Key Methods):**
- **`__init__(self, max_attempts: int = 3, initial_backoff: float = 2.0)`**: Initializes the `Retry` instance with a specified maximum number of attempts and an initial backoff delay.
- **`async def __call__(self, message: Message, next_: SendFunc) -> None`**: This method is used as a decorator to wrap the sending function for a message. It retries the operation based on error conditions and backoff strategies.

**Design Patterns Used:**
The `Retry` class employs the **Strategy Pattern** through its handling of different retry behaviors (e.g., exponential backoff). The use of an asynchronous context manager (`__call__`) allows it to be used seamlessly in asynchronous workflows.

**How It Fits in the Architecture:**
In the architecture of Telehook, the `Retry` class acts as a middleware component. It is integrated into the message sending process to ensure robustness and reliability. By wrapping the core send function with retry logic, it enhances the overall resilience of the system without altering the underlying implementation details of the send function.

This design ensures that transient network issues or API rate limits are handled gracefully, improving the user experience by reducing the number of failed operations.

---

*Generated by CodeWorm on 2026-03-01 01:28*
