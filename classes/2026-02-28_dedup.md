# Dedup

**Type:** Class Documentation
**Repository:** Telehook
**File:** src/telehook/middleware/dedup.py
**Language:** python
**Lines:** 13-36
**Complexity:** 0.0

---

## Source Code

```python
class Dedup:
    def __init__(self, window_seconds: float = 60.0):
        self._window = window_seconds
        self._seen: dict[str, float] = {}

    def _message_hash(self, message: Message) -> str:
        return hashlib.sha256(message.text.encode()).hexdigest()[: 16]

    def _cleanup(self) -> None:
        now = time.monotonic()
        expired = [k for k, v in self._seen.items() if now - v > self._window]
        for k in expired:
            del self._seen[k]

    async def __call__(self, message: Message, next_: SendFunc) -> None:
        self._cleanup()
        msg_hash = self._message_hash(message)
        now = time.monotonic()

        if msg_hash in self._seen:
            return

        self._seen[msg_hash] = now
        await next_(message)
```

---

## Class Documentation

### Dedup Class Documentation

**Class Responsibility and Purpose:**
The `Dedup` class is responsible for deduplicating messages based on their content within a specified window of time (`window_seconds`). This ensures that only unique messages are processed, preventing redundant actions or notifications.

**Public Interface (Key Methods):**
- **`__init__(self, window_seconds: float = 60.0)`**: Initializes the `Dedup` instance with a configurable window size.
- **`_message_hash(self, message: Message) -> str`**: Generates a hash for the message content to identify duplicates.
- **`_cleanup(self) -> None`**: Removes entries from the seen messages dictionary that are older than the configured window.
- **`__call__(self, message: Message, next_: SendFunc) -> None`**: The main method that processes incoming messages. It checks for duplicates and passes unique messages to the next middleware or handler.

**Design Patterns Used:**
The class leverages a simple state management approach using a dictionary (`_seen`) to track seen messages. There is no explicit use of design patterns like factory, observer, or strategy in this snippet.

**How it Fits in the Architecture:**
`Dedup` acts as a middleware component in the Telehook architecture, ensuring that message processing logic can be modular and reusable. By integrating `Dedup`, other components can focus on their specific responsibilities without worrying about duplicate messages, thus maintaining clean separation of concerns.

---

*Generated by CodeWorm on 2026-02-28 23:23*
