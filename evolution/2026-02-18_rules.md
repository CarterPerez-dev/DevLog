# rules

**Type:** Code Evolution
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/app/core/detection/rules.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: 3fd9f773
Message: checkpoint - phase 13 complete
Author: CarterPerez-dev
File: PROJECTS/advanced/ai-threat-detection/backend/app/core/detection/rules.py
Change type: new file

Diff:
@@ -0,0 +1,131 @@
+"""
+Â©AngelaMos | 2026
+rules.py
+"""
+
+from dataclasses import dataclass, field
+from typing import NamedTuple
+
+from app.core.features.patterns import (
+    COMMAND_INJECTION,
+    DOUBLE_ENCODED,
+    FILE_INCLUSION,
+    PATH_TRAVERSAL,
+    SQLI,
+    XSS,
+)
+from app.core.features.signatures import SCANNER_USER_AGENTS
+from app.core.ingestion.parsers import ParsedLogEntry
+
+
+class _PatternRule(NamedTuple):
+    """
+    A regex-based detection rule applied to the request URI.
+    """
+    name: str
+    pattern: object
+    score: float
+
+
+class _ThresholdRule(NamedTuple):
+    """
+    A threshold-based detection rule applied to a windowed feature.
+    """
+    name: str
+    feature_key: str
+    threshold: float
+    score: float
+
+
+_PATTERN_RULES: list[_PatternRule] = [
+    _PatternRule("COMMAND_INJECTION", COMMAND_INJECTION, 0.90),
+    _PatternRule("SQL_INJECTION", SQLI, 0.85),
+    _PatternRule("XSS", XSS, 0.80),
+    _PatternRule("FILE_INCLUSION", FILE_INCLUSION, 0.75),
+    _PatternRule("PATH_TRAVERSAL", PATH_TRAVERSAL, 0.60),
+]
+
+_THRESHOLD_RULES: list[_ThresholdRule] = [
+    _ThresholdRule("RATE_ANOMALY", "req_count_1m", 100.0, 0.30),
+    _ThresholdRule("HIGH_ERROR_RATE", "error_rate_5m", 0.5, 0.25),
+]
+
+_DOUBLE_ENCODING_SCORE = 0.40
+_SCANNER_UA_SCORE = 0.35
+_BOOST_PER_ADDITIONAL_RULE = 0.05
+
+
+@dataclass(frozen=True, slots=True)
+class RuleResult:
+    """
+    Output of the rule-based detection engine for a single request.
+    """
+    threat_score: float
+    severity: str
+    matched_rules: list[str] = field(default_factory=list)
+    component_scores: dict[str, float] = field(default_factory=dict)
+
+
+def _classify_severity(score: float) -> str:
+    """
+    Map a threat score to a severity label.
+    """
+    if score >= 0.7:
+        return "HIGH"
+    if score >= 0.5:
+        return "MEDIUM"
+    return "LOW"
+
+
+class RuleEngine:
+    """
+    Cold-start rule-based detection engine inspired by ModSecurity CRS.
+    Scores requests using pattern matching, signature detection,
+    and behavioral thresholds from windowed features.
+    """
+
+    def score_request(
+        self,
+        features: dict[str, int | float | bool | str],
+        entry: ParsedLogEntry,
+    ) -> RuleResult:
+        """
+        Evaluate all rules against a request and return a composite score.
+        """
+        matched: list[tuple[str, float]] = []
+
+        uri = entry.path
+        if entry.query_string:
+            uri = f"{entry.path}?{entry.query_string}"
+
+        for rule in _PATTERN_RULES:
+            if rule.pattern.search(uri):
+                matched.append((rule.name, rule.score))
+
+        if DOUBLE_ENCODED.search(uri):
+            matched.append(("DOUBLE_ENCODING", _DOUBLE_ENCODING_
```

---

## Code Evolution

### Change Analysis for `rules.py`

**What was Changed:**
The commit introduces a new file, `rules.py`, which defines a rule-based detection engine for threat identification in web requests. It includes dataclasses and namedtuples to represent pattern rules and threshold rules, along with functions and a class to evaluate these rules.

**Why it Was Likely Changed:**
This change likely aims to enhance the AI-threat-detection system by formalizing the rules and evaluation logic. By defining clear structures for patterns and thresholds, the code becomes more maintainable and easier to extend in future phases of development.

**Impact on Behavior:**
The new `RuleEngine` class scores requests based on various criteria such as URI patterns, user agent signatures, and threshold-based features. This enhances the detection capabilities by considering multiple aspects of the request, potentially improving accuracy.

**Risks or Concerns:**
- **Complexity:** The introduction of multiple rules and thresholds can increase complexity if not managed properly.
- **Performance:** Evaluating each rule on every request could impact performance, especially with a large number of rules.
- **Maintenance:** Ensuring that the patterns and thresholds remain up-to-date to effectively detect new threats is crucial.

Overall, this change significantly improves the detection mechanism but requires careful monitoring and updates.

---

*Generated by CodeWorm on 2026-02-18 12:10*
