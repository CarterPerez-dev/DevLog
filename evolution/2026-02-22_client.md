# client

**Type:** Code Evolution
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/intermediate/secrets-scanner/internal/hibp/client.go
**Language:** go
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```go
Commit: 294169a2
Message: feat: Complete Go secrets scanner - Portia
Author: CarterPerez-dev
File: PROJECTS/intermediate/secrets-scanner/internal/hibp/client.go
Change type: new file

Diff:
@@ -0,0 +1,177 @@
+// Â©AngelaMos | 2026
+// client.go
+
+package hibp
+
+import (
+	"bufio"
+	"context"
+	"crypto/sha1"
+	"fmt"
+	"net/http"
+	"strconv"
+	"strings"
+	"time"
+
+	lru "github.com/hashicorp/golang-lru/v2"
+	"github.com/sony/gobreaker/v2"
+	"golang.org/x/time/rate"
+)
+
+type Result struct {
+	Breached bool
+	Count    int
+}
+
+type Client struct {
+	httpClient *http.Client
+	baseURL    string
+	cache      *lru.Cache[string, Result]
+	breaker    *gobreaker.CircuitBreaker[Result]
+	limiter    *rate.Limiter
+}
+
+func NewClient() *Client {
+	cache, err := lru.New[string, Result](10000)
+	if err != nil {
+		panic(fmt.Errorf("create HIBP cache: %w", err))
+	}
+
+	breaker := gobreaker.NewCircuitBreaker[Result](
+		gobreaker.Settings{
+			Name:        "hibp",
+			MaxRequests: 3,
+			Interval:    30 * time.Second,
+			Timeout:     60 * time.Second,
+			ReadyToTrip: func(
+				counts gobreaker.Counts,
+			) bool {
+				return counts.ConsecutiveFailures > 5
+			},
+		},
+	)
+
+	return &Client{
+		httpClient: &http.Client{
+			Timeout: 10 * time.Second,
+		},
+		baseURL: "https://api.pwnedpasswords.com/range/",
+		cache:   cache,
+		breaker: breaker,
+		limiter: rate.NewLimiter(rate.Every(200*time.Millisecond), 5),
+	}
+}
+
+func (c *Client) Check(
+	ctx context.Context, secret string,
+) (Result, error) {
+	hash := sha1Hash(secret)
+	prefix := hash[:5]
+	suffix := hash[5:]
+
+	if cached, ok := c.cache.Get(hash); ok {
+		return cached, nil
+	}
+
+	if err := c.limiter.Wait(ctx); err != nil {
+		return Result{}, fmt.Errorf("rate limit: %w", err)
+	}
+
+	result, err := c.breaker.Execute(func() (Result, error) {
+		return c.queryAPI(ctx, prefix, suffix)
+	})
+	if err != nil {
+		return Result{}, err
+	}
+
+	c.cache.Add(hash, result)
+	return result, nil
+}
+
+const maxRetries = 3
+
+func (c *Client) queryAPI(
+	ctx context.Context, prefix, suffix string,
+) (Result, error) {
+	url := c.baseURL + prefix
+
+	for attempt := range maxRetries {
+		if attempt > 0 {
+			backoff := time.Duration(attempt) * 2 * time.Second
+			select {
+			case <-ctx.Done():
+				return Result{}, ctx.Err()
+			case <-time.After(backoff):
+			}
+		}
+
+		result, retry, err := c.doQuery(ctx, url, suffix)
+		if !retry {
+			return result, err
+		}
+	}
+
+	return Result{}, fmt.Errorf("HIBP API: retries exhausted (429)")
+}
+
+func (c *Client) doQuery(
+	ctx context.Context, url, suffix string,
+) (Result, bool, error) {
+	req, err := http.NewRequestWithContext(
+		ctx, http.MethodGet, url, nil,
+	)
+	if err != nil {
+		return Result{}, false,
+			fmt.Errorf("create request: %w", err)
+	}
+	req.Header.Set("User-Agent", "portia-secrets-scanner/1.0")
+	req.Header.Set("Add-Padding", "true")
+
+	resp, err := c.httpClient.Do(req) //nolint:gosec
+	if err != nil {
+		return Result{}, false,
+			fmt
```

---

## Code Evolution

### Change Analysis for `client.go` in `secrets-scanner`

**What was Changed:**
The file `client.go` introduces a new Go package named `hibp`, which implements an HTTP client to interact with the Have I Been Pwned (HIBP) API. The code defines a `Client` struct and methods for interacting with HIBP, including rate limiting, caching, and error handling.

**Why it was Likely Changed:**
This change likely aims to enhance the functionality of the secrets scanner by integrating robust interaction with the HIBP API. The implementation includes features such as caching to reduce API calls, circuit breaker to handle failures gracefully, and rate limiting to prevent abuse.

**Impact on Behavior:**
The `Client` struct provides a well-structured interface for checking if a password has been breached. It caches results to minimize redundant API requests, uses a circuit breaker to manage service disruptions, and implements rate limiting to comply with API usage policies. This ensures the scanner operates efficiently while maintaining reliability.

**Risks or Concerns:**
1. **Security Risks**: The `nolint:gosec` comment in `doQuery` suggests potential security concerns, such as insecure HTTP requests.
2. **Error Handling**: While error handling is present, it could be improved to provide more detailed logging and context for debugging.
3. **Rate Limiting**: Although rate limiting is implemented, the backoff strategy might not handle all edge cases effectively.

Overall, this change significantly improves the robustness of the secrets scanner by integrating sophisticated API interaction logic.

---

*Generated by CodeWorm on 2026-02-22 21:05*
