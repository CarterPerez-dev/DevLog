# service

**Type:** Code Evolution
**Repository:** angelamos-3d
**File:** backend/app/stt/service.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: a61e4cd8
Message: feat: complete mvp v1.0.0
Author: CarterPerez-dev
File: backend/app/stt/service.py
Change type: new file

Diff:
@@ -0,0 +1,84 @@
+"""
+Â©AngelaMos | 2026
+service.py
+"""
+
+import tempfile
+from pathlib import Path
+
+from faster_whisper import WhisperModel
+
+from app.config import settings
+from app.core.exceptions import TranscriptionError
+from app.stt.schemas import TranscriptionResponse
+
+
+_model: WhisperModel | None = None
+
+
+def get_model() -> WhisperModel:
+    """
+    Lazy-load the Whisper model singleton.
+    """
+    global _model
+    if _model is None:
+        device = settings.WHISPER_DEVICE
+        compute_type = "int8"
+
+        if device == "auto":
+            try:
+                import ctranslate2
+                if ctranslate2.get_cuda_device_count() > 0:
+                    device = "cuda"
+                    compute_type = "float16"
+                else:
+                    device = "cpu"
+            except Exception:
+                device = "cpu"
+        elif device == "cuda":
+            compute_type = "float16"
+
+        try:
+            _model = WhisperModel(
+                settings.WHISPER_MODEL,
+                device = device,
+                compute_type = compute_type,
+            )
+        except Exception:
+            device = "cpu"
+            compute_type = "int8"
+            _model = WhisperModel(
+                settings.WHISPER_MODEL,
+                device = device,
+                compute_type = compute_type,
+            )
+    return _model
+
+
+async def transcribe(
+    audio_data: bytes,
+    filename: str
+) -> TranscriptionResponse:
+    """
+    Transcribe audio bytes to text.
+    """
+    suffix = Path(filename).suffix or ".wav"
+
+    try:
+        with tempfile.NamedTemporaryFile(suffix = suffix,
+                                         delete = True) as tmp:
+            tmp.write(audio_data)
+            tmp.flush()
+
+            model = get_model()
+            segments, info = model.transcribe(tmp.name, beam_size = 5)
+            text_parts = [segment.text for segment in segments]
+            full_text = " ".join(text_parts).strip()
+
+        return TranscriptionResponse(
+            text = full_text,
+            language = info.language,
+            duration = info.duration,
+        )
+    except Exception as e:
+        raise TranscriptionError(str(e)) from e

```

---

## Code Evolution

### Change Analysis

**What was Changed:**
A new file `service.py` was added to the repository, implementing a service for speech-to-text (STT) transcriptions using the `faster_whisper` library. The file includes functions for lazy-loading a Whisper model and performing transcriptions.

**Why it was Likely Changed:**
This change likely implements an MVP (Minimum Viable Product) feature for STT capabilities in version 1.0.0, as indicated by the commit message. It addresses the need to integrate speech recognition functionality into the application, possibly to support voice commands or real-time transcription features.

**Impact on Behavior:**
The introduction of `get_model` ensures that the Whisper model is only loaded once, optimizing performance and resource usage. The `transcribe` function processes audio data, converting it into text transcriptions with detailed metadata like language and duration. This significantly enhances the application's functionality for handling audio inputs.

**Risks or Concerns:**
- **Resource Management:** The use of a temporary file might introduce potential issues if not handled properly.
- **Error Handling:** While exceptions are caught, specific error messages could be more informative to aid debugging.
- **Model Initialization:** Ensuring the model is correctly initialized on different devices (CPU vs. GPU) with appropriate compute types is crucial for performance and stability.

Overall, this change adds robust STT capabilities while maintaining a clean and modular design.

---

*Generated by CodeWorm on 2026-02-23 18:56*
