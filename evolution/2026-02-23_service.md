# service

**Type:** Code Evolution
**Repository:** angelamos-3d
**File:** backend/app/wake/service.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: a61e4cd8
Message: feat: complete mvp v1.0.0
Author: CarterPerez-dev
File: backend/app/wake/service.py
Change type: new file

Diff:
@@ -0,0 +1,102 @@
+"""
+Â©AngelaMos | 2026
+service.py
+"""
+
+import numpy as np
+from openwakeword.model import Model
+from scipy import signal
+
+from app.config import settings
+from app.wake.schemas import WakeWordDetection
+
+
+_model: Model | None = None
+
+
+def get_model() -> Model:
+    """
+    Lazy-load the OpenWakeWord model singleton.
+    """
+    global _model
+    if _model is None:
+        model_paths = list(settings.WAKEWORD_MODELS_DIR.glob("*.tflite"))
+        model_paths += list(settings.WAKEWORD_MODELS_DIR.glob("*.onnx"))
+
+        vad_threshold = (
+            settings.WAKEWORD_VAD_THRESHOLD
+            if settings.WAKEWORD_ENABLE_VAD else None
+        )
+
+        if model_paths:
+            _model = Model(
+                wakeword_models = [str(p) for p in model_paths],
+                vad_threshold = vad_threshold,
+            )
+        else:
+            _model = Model(vad_threshold = vad_threshold)
+    return _model
+
+
+def create_session_model() -> Model:
+    """
+    Create a new model instance for a WebSocket session.
+    Each session needs its own model to avoid state conflicts.
+    """
+    model_paths = list(settings.WAKEWORD_MODELS_DIR.glob("*.tflite"))
+    model_paths += list(settings.WAKEWORD_MODELS_DIR.glob("*.onnx"))
+
+    vad_threshold = (
+        settings.WAKEWORD_VAD_THRESHOLD
+        if settings.WAKEWORD_ENABLE_VAD else None
+    )
+
+    if model_paths:
+        return Model(
+            wakeword_models = [str(p) for p in model_paths],
+            vad_threshold = vad_threshold,
+        )
+    return Model(vad_threshold = vad_threshold)
+
+
+def list_models() -> list[str]:
+    """
+    Get names of loaded wake word models.
+    """
+    m = get_model()
+    return list(m.models.keys())
+
+
+def process_audio(model: Model, audio_bytes: bytes) -> list[WakeWordDetection]:
+    """
+    Process audio chunk and return any detections.
+    """
+    audio = np.frombuffer(audio_bytes, dtype = np.int16)
+
+    if len(audio) != settings.WAKEWORD_TARGET_SAMPLES:
+        ratio = len(audio) // settings.WAKEWORD_TARGET_SAMPLES
+        if ratio > 1:
+            audio = audio[:: ratio][: settings.WAKEWORD_TARGET_SAMPLES]
+        else:
+            audio = signal.resample_poly(
+                audio,
+                settings.WAKEWORD_TARGET_SAMPLES,
+                len(audio)
+            ).astype(np.int16)
+
+    predictions = model.predict(audio)
+    model_names = list(model.models.keys())
+
+    detections = []
+    for name in model_names:
+        score = predictions.get(name, 0.0)
+        if score >= settings.WAKEWORD_THRESHOLD:
+            detections.append(
+                WakeWordDetection(
+                    detected = True,
+                    model = name,
+                    score = float(score),
+                )
+            )
+
+ 
```

---

## Code Evolution

### Change Analysis for Commit `a61e4cd8`

**What was Changed:**
The commit introduces a new file, `service.py`, which contains several functions related to the OpenWakeWord model and audio processing. The changes include:
- Defining a singleton `_model` using a global variable.
- Implementing two main functions: `get_model()` for lazy-loading a shared model instance and `create_session_model()` for creating a new, session-specific model instance.
- Adding utility functions like `list_models()` to retrieve the names of loaded models and `process_audio()` to process audio chunks.

**Why it was Likely Changed:**
This change is likely part of completing MVP v1.0.0 by setting up the core functionality needed for wake word detection. The introduction of a singleton model ensures efficient use of resources, while session-specific models prevent state conflicts in concurrent WebSocket sessions.

**Impact on Behavior:**
- `get_model()` and `create_session_model()` provide mechanisms to manage shared and per-session model instances.
- `process_audio()` processes audio chunks and detects wake words based on the loaded models.

**Risks or Concerns:**
- The use of a global `_model` could lead to issues if not managed properly, especially in multi-threaded environments.
- The resampling logic might introduce artifacts; it would be beneficial to validate this against real-world audio data.

---

*Generated by CodeWorm on 2026-02-23 19:08*
