# test_cli

**Type:** Code Evolution
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/tests/test_cli.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: f9b5a614
Message: feat: did a couple things idk
Author: CarterPerez-dev
File: PROJECTS/advanced/ai-threat-detection/backend/tests/test_cli.py
Change type: modified

Diff:
@@ -4,6 +4,7 @@ test_cli.py
 """
 
 import re
+from unittest import mock
 
 from typer.testing import CliRunner
 
@@ -105,3 +106,38 @@ class TestCLICommands:
             ],
         )
         assert result.exit_code != 0
+
+
+class TestCLITrainMetadata:
+    """
+    Test metadata persistence wiring in the train command
+    """
+
+    def test_train_warns_when_db_unavailable(self) -> None:
+        """
+        train exits 0 and emits a warning when DB write fails
+        """
+        mock_result = mock.MagicMock()
+        mock_result.ensemble_metrics = None
+        mock_result.passed_gates = True
+        mock_result.mlflow_run_id = None
+        mock_result.ae_metrics = {}
+
+        with mock.patch(
+            "ml.orchestrator.TrainingOrchestrator"
+        ) as mock_class:
+            mock_class.return_value.run.return_value = mock_result
+            result = runner.invoke(
+                app,
+                [
+                    "train",
+                    "--synthetic-normal",
+                    "5",
+                    "--synthetic-attack",
+                    "3",
+                ],
+            )
+
+        assert result.exit_code == 0
+        output = _clean(result.output)
+        assert "warning" in output or "metadata" in output

```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The code added a new test class `TestCLITrainMetadata` and a method `test_train_warns_when_db_unavailable`. The existing test class `TestCLICommands` was modified to include this new test.

**Why it was Likely Changed:**
This change likely aims to ensure that the CLI's train command handles database unavailability gracefully. By adding a mock patch for `TrainingOrchestrator`, the test simulates a scenario where the database write fails, and verifies that the command exits with code 0 while emitting a warning.

**Impact on Behavior:**
The new test ensures that when the database is unavailable during training, the CLI still completes without error but logs a warning. This improves robustness by handling potential database failures more gracefully.

**Risks or Concerns:**
- The mock setup might not fully replicate real-world scenarios if the database interaction logic is complex.
- There's a risk of false positives if the warning message format changes, causing the test to fail unnecessarily.
- Ensuring that all relevant warnings are captured and logged correctly requires thorough testing.

Overall, this change enhances the CLIâ€™s error handling by making sure it can deal with temporary database unavailability.

---

*Generated by CodeWorm on 2026-03-01 11:52*
