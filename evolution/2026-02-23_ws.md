# ws

**Type:** Code Evolution
**Repository:** CodeWorm
**File:** dashboard/backend/ws.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: ca3ce30d
Message: v1.0.2: add doc type system, Docker infrastructure, and web dashboard

- Add 11 documentation types (function, class, file, security review, TIL, etc.)
  with weighted random selection so the same codebase generates 10x more unique content
- Add Docker Compose for Ollama (GPU passthrough) + Redis + Dashboard + Nginx
- Add FastAPI backend with REST API, WebSocket live events, and Redis pub/sub
- Add React dashboard with stats, live log, commit feed, repo list, and worm viz
- Add next_scheduled_run logging after each cycle completes
- Update repos config and README for v1.0.2
Author: CarterPerez-dev
File: dashboard/backend/ws.py
Change type: new file

Diff:
@@ -0,0 +1,118 @@
+"""
+â’¸AngelaMos | 2026
+dashboard/backend/ws.py
+"""
+from __future__ import annotations
+
+import asyncio
+import contextlib
+import os
+from collections import deque
+from typing import Any
+
+import orjson
+from fastapi import APIRouter, WebSocket, WebSocketDisconnect
+
+router = APIRouter()
+
+LOG_BUFFER_SIZE = 200
+
+
+class ConnectionManager:
+    def __init__(self) -> None:
+        self.active: list[WebSocket] = []
+        self.log_buffer: deque[dict[str, Any]] = deque(maxlen=LOG_BUFFER_SIZE)
+
+    async def connect(self, websocket: WebSocket) -> None:
+        await websocket.accept()
+        self.active.append(websocket)
+        if self.log_buffer:
+            history = orjson.dumps({
+                "channel": "codeworm:history",
+                "data": list(self.log_buffer),
+            }).decode("utf-8")
+            try:
+                await websocket.send_text(history)
+            except Exception:
+                pass
+
+    def disconnect(self, websocket: WebSocket) -> None:
+        if websocket in self.active:
+            self.active.remove(websocket)
+
+    async def broadcast(self, message: dict[str, Any]) -> None:
+        if message.get("channel") in ("codeworm:logs", "codeworm:events"):
+            self.log_buffer.append(message)
+        payload = orjson.dumps(message).decode("utf-8")
+        disconnected: list[WebSocket] = []
+        for ws in self.active:
+            try:
+                await ws.send_text(payload)
+            except Exception:
+                disconnected.append(ws)
+        for ws in disconnected:
+            self.disconnect(ws)
+
+
+manager = ConnectionManager()
+
+_subscriber_task: asyncio.Task | None = None
+
+
+async def start_redis_subscriber() -> None:
+    global _subscriber_task
+    redis_url = os.environ.get("REDIS_URL", "redis://localhost:6379")
+
+    try:
+        import redis.asyncio as aioredis
+
+        client = aioredis.from_url(redis_url, decode_responses=True)
+        await client.ping()
+    except Exception:
+        return
+
+    async def _subscribe() -> None:
+        pubsub = client.pubsub()
+        await pubsub.subscribe(
+            "codeworm:logs",
+            "codeworm:events",
+            "codeworm:stats",
+        )
+
+        async for message in p
```

---

## Code Evolution

### Change Analysis for `dashboard/backend/ws.py`

**What was Changed:**
A new file `ws.py` was added to the `dashboard/backend/` directory, implementing WebSocket functionality using FastAPI and Redis pub/sub. The file includes a `ConnectionManager` class for managing active WebSocket connections and broadcasting messages. It also contains tasks for starting and stopping a Redis subscriber.

**Why it Was Likely Changed:**
This change likely aims to provide real-time communication capabilities between the backend and frontend, enabling live updates such as logs, events, and stats. The use of Redis ensures efficient message distribution among connected clients.

**Impact on Behavior:**
The addition of WebSocket support allows for dynamic interactions with the dashboard, such as receiving real-time log entries or event notifications directly from the server. This enhances user experience by providing immediate feedback without requiring page reloads.

**Risks and Concerns:**
- **Concurrency Issues:** Managing active connections and handling disconnections requires careful synchronization to avoid race conditions.
- **Error Handling:** The code includes basic error handling but may need more robust mechanisms, especially for WebSocket disconnects.
- **Resource Management:** Proper cleanup of Redis subscriptions is crucial; the `stop_redis_subscriber` function helps manage this, but it should be thoroughly tested.

Overall, this change significantly improves interactivity and real-time capabilities in the dashboard.

---

*Generated by CodeWorm on 2026-02-23 20:56*
