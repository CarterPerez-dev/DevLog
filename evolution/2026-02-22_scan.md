# scan

**Type:** Code Evolution
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/intermediate/secrets-scanner/internal/cli/scan.go
**Language:** go
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```go
Commit: 294169a2
Message: feat: Complete Go secrets scanner - Portia
Author: CarterPerez-dev
File: PROJECTS/intermediate/secrets-scanner/internal/cli/scan.go
Change type: new file

Diff:
@@ -0,0 +1,119 @@
+// Â©AngelaMos | 2026
+// scan.go
+
+package cli
+
+import (
+	"context"
+	"os"
+	"time"
+
+	"github.com/spf13/cobra"
+
+	"github.com/CarterPerez-dev/portia/internal/engine"
+	"github.com/CarterPerez-dev/portia/internal/hibp"
+	"github.com/CarterPerez-dev/portia/internal/reporter"
+	"github.com/CarterPerez-dev/portia/internal/rules"
+	"github.com/CarterPerez-dev/portia/internal/source"
+	"github.com/CarterPerez-dev/portia/internal/ui"
+	"github.com/CarterPerez-dev/portia/pkg/types"
+)
+
+var scanCmd = &cobra.Command{
+	Use:   "scan [path]",
+	Short: "Scan a directory for secrets",
+	Args:  cobra.MaximumNArgs(1),
+	RunE:  runScan,
+}
+
+func runScan(cmd *cobra.Command, args []string) error {
+	path := "."
+	if len(args) > 0 {
+		path = args[0]
+	}
+
+	ui.PrintBanner()
+
+	reg := rules.NewRegistry()
+	rules.RegisterBuiltins(reg)
+	applyRuleConfig(reg)
+
+	src := source.NewDirectory(path, maxSize, excludes)
+
+	return executeScan(cmd.Context(), reg, src)
+}
+
+func executeScan(
+	ctx context.Context,
+	reg *rules.Registry,
+	src source.Source,
+) error {
+	spin := ui.NewSpinner("Scanning for secrets...")
+	if !verbose {
+		spin.Start()
+	}
+
+	start := time.Now()
+	p := engine.NewPipeline(reg)
+	p.SetVerbose(verbose)
+	result, err := p.Run(ctx, src)
+	spin.Stop()
+
+	if err != nil {
+		return err
+	}
+
+	result.Duration = time.Since(start)
+
+	if enableHIBP && len(result.Findings) > 0 {
+		checkHIBP(ctx, result)
+	}
+
+	rep := reporter.New(format)
+	return rep.Report(os.Stdout, result)
+}
+
+func checkHIBP(ctx context.Context, result *types.ScanResult) {
+	client := hibp.NewClient()
+	spin := ui.NewSpinner("Checking HIBP breach database...")
+	spin.Start()
+	defer spin.Stop()
+
+	for i := range result.Findings {
+		f := &result.Findings[i]
+		if f.Secret == "" {
+			continue
+		}
+
+		if f.RuleID != "generic-password" &&
+			f.RuleID != "generic-secret" {
+			f.HIBPStatus = types.HIBPSkipped
+			continue
+		}
+
+		res, err := client.Check(ctx, f.Secret)
+		result.HIBPChecked++
+
+		if err != nil {
+			f.HIBPStatus = types.HIBPError
+			continue
+		}
+
+		if res.Breached {
+			f.HIBPStatus = types.HIBPBreached
+			f.BreachCount = res.Count
+			result.HIBPBreached++
+		} else {
+			f.HIBPStatus = types.HIBPClean
+		}
+	}
+}
+
+func applyRuleConfig(reg *rules.Registry) {
+	if cfg == nil {
+		return
+	}
+	if len(cfg.Rules.Disable) > 0 {
+		reg.Disable(cfg.Rules.Disable...)
+	}
+}

```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The commit introduces a new file `scan.go` in the `internal/cli` package, which implements a command-line interface (CLI) for scanning directories for secrets. The code defines a `cobra.Command` for the "scan" subcommand and its associated logic.

**Why it was Likely Changed:**
This change likely aims to provide a user-friendly way to integrate the secret scanning functionality into an existing CLI tool, making it more accessible and versatile. By using `cobra`, the developers can leverage a well-established framework for command-line interfaces in Go.

**Impact on Behavior:**
The new `scan` subcommand allows users to specify a directory path as an argument (defaulting to the current directory if none is provided). It configures rules, sources, and runs a pipeline to scan the specified directory. The results are then reported via a reporter. If enabled, it also checks findings against the Have I Been Pwned (HIBP) breach database.

**Risks or Concerns:**
- **Error Handling:** The `runScan` function does not handle errors from the `source.NewDirectory`, which could lead to unexpected behavior if the directory path is invalid.
- **Concurrency:** While the code uses a spinner for visual feedback, it does not appear to use goroutines for asynchronous operations. This might impact performance in scenarios with large directories or slow network requests.
- **Configuration Management:** The `applyRuleConfig` function assumes that configuration (`cfg`) is available and could be improved to handle cases where no configuration is provided.

Overall, this change enhances the usability of the secret scanner by providing a CLI interface while maintaining flexibility through configurable rules and sources.

---

*Generated by CodeWorm on 2026-02-22 20:20*
