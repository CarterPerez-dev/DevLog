# dockerfile

**Type:** Code Evolution
**Repository:** docksec
**File:** internal/parser/dockerfile.go
**Language:** go
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```go
Commit: 5a7c48c4
Message: Initial release
Author: CarterPerez-dev
File: internal/parser/dockerfile.go
Change type: new file

Diff:
@@ -0,0 +1,206 @@
+/*
+CarterPerez-dev | 2025
+dockerfile.go
+*/
+
+package parser
+
+import (
+	"fmt"
+	"io"
+	"os"
+	"strings"
+
+	"github.com/moby/buildkit/frontend/dockerfile/parser"
+)
+
+type DockerfileAST struct {
+	Path     string
+	Root     *parser.Node
+	Stages   []Stage
+	Commands []Command
+}
+
+type Stage struct {
+	Name      string
+	BaseName  string
+	BaseTag   string
+	StartLine int
+	EndLine   int
+	Commands  []Command
+}
+
+type Command struct {
+	Instruction string
+	Arguments   []string
+	Original    string
+	StartLine   int
+	EndLine     int
+	Stage       int
+}
+
+func ParseDockerfile(path string) (*DockerfileAST, error) {
+	file, err := os.Open(path)
+	if err != nil {
+		return nil, fmt.Errorf("opening dockerfile: %w", err)
+	}
+	defer func() { _ = file.Close() }()
+
+	return ParseDockerfileReader(path, file)
+}
+
+func ParseDockerfileReader(path string, r io.Reader) (*DockerfileAST, error) {
+	result, err := parser.Parse(r)
+	if err != nil {
+		return nil, fmt.Errorf("parsing dockerfile: %w", err)
+	}
+
+	ast := &DockerfileAST{
+		Path: path,
+		Root: result.AST,
+	}
+
+	ast.extractStructure()
+
+	return ast, nil
+}
+
+func (d *DockerfileAST) extractStructure() {
+	stageIndex := -1
+
+	for _, node := range d.Root.Children {
+		instruction := strings.ToUpper(node.Value)
+
+		cmd := Command{
+			Instruction: instruction,
+			Original:    node.Original,
+			StartLine:   node.StartLine,
+			EndLine:     node.EndLine,
+			Stage:       stageIndex,
+		}
+
+		for n := node.Next; n != nil; n = n.Next {
+			cmd.Arguments = append(cmd.Arguments, n.Value)
+		}
+
+		if instruction == "FROM" {
+			stageIndex++
+			stage := d.parseFromInstruction(node, stageIndex)
+			d.Stages = append(d.Stages, stage)
+			cmd.Stage = stageIndex
+		}
+
+		d.Commands = append(d.Commands, cmd)
+
+		if stageIndex >= 0 && stageIndex < len(d.Stages) {
+			d.Stages[stageIndex].Commands = append(
+				d.Stages[stageIndex].Commands,
+				cmd,
+			)
+			d.Stages[stageIndex].EndLine = node.EndLine
+		}
+	}
+}
+
+func (d *DockerfileAST) parseFromInstruction(
+	node *parser.Node,
+	index int,
+) Stage {
+	stage := Stage{
+		StartLine: node.StartLine,
+		EndLine:   node.EndLine,
+	}
+
+	if node.Next != nil {
+		imageRef := node.Next.Value
+		stage.BaseName, stage.BaseTag = parseImageReference(imageRef)
+	}
+
+	for n := node.Next; n != nil; n = n.Next {
+		if strings.ToUpper(n.Value) == "AS" && n.Next != nil {
+			stage.Name = n.Next.Value
+			break
+		}
+	}
+
+	if stage.Name == "" {
+		stage.Name = fmt.Sprintf("stage-%d", index)
+	}
+
+	return stage
+}
+
+func parseImageReference(ref string) (name, tag string) {
+	ref = strings.TrimSpace(ref)
+
+	if atIdx := strings.Index(ref, "@"); atIdx != -1 {
+		return ref[:atIdx], ref[atIdx:]
+	}
+
+	if colonIdx := strings.LastIndex(ref, ":"); colonIdx != -1 {
+		possibleTag := ref[colonIdx+1:]
+		if
```

---

## Code Evolution

### Change Analysis for Commit 5a7c48c4 in `internal/parser/dockerfile.go`

**What was Changed:**
- Introduced a new file, `dockerfile.go`, which defines the structure of Dockerfile parsing and analysis.
- Added types for `DockerfileAST`, `Stage`, and `Command` to represent parsed Dockerfile data.
- Implemented functions like `ParseDockerfile`, `extractStructure`, and various utility methods such as `GetInstructions`, `HasInstruction`, etc.

**Why it was Likely Changed:**
The changes were likely made to provide a structured representation of Dockerfiles for further analysis or manipulation. This is common in security tools that need to understand the contents of Dockerfiles to identify potential vulnerabilities.

**Impact on Behavior:**
- The new functions allow for easy querying and manipulation of parsed Dockerfile data.
- `ParseDockerfile` provides a convenient way to load and parse Dockerfiles, while methods like `GetInstructions` enable specific command searches within the Dockerfile.

**Risks or Concerns:**
- Error handling is basic; more robust error management could be added (e.g., logging detailed errors).
- The current implementation assumes that all instructions are well-formed, which might not always be true. Additional validation logic would improve reliability.
- The `DockerfileVisitor` interface introduces flexibility but requires implementing custom visitors for specific use cases.

Overall, this change significantly enhances the tool's ability to analyze Dockerfiles by providing a structured data model and utility functions.

---

*Generated by CodeWorm on 2026-02-23 15:50*
