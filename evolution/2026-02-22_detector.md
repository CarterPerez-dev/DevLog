# detector

**Type:** Code Evolution
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/intermediate/secrets-scanner/internal/engine/detector.go
**Language:** go
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```go
Commit: 294169a2
Message: feat: Complete Go secrets scanner - Portia
Author: CarterPerez-dev
File: PROJECTS/intermediate/secrets-scanner/internal/engine/detector.go
Change type: new file

Diff:
@@ -0,0 +1,187 @@
+// ©AngelaMos | 2026
+// detector.go
+
+package engine
+
+import (
+	"strings"
+
+	"github.com/CarterPerez-dev/portia/internal/rules"
+	"github.com/CarterPerez-dev/portia/pkg/types"
+)
+
+type Detector struct {
+	registry *rules.Registry
+}
+
+func NewDetector(reg *rules.Registry) *Detector {
+	return &Detector{registry: reg}
+}
+
+func (d *Detector) Detect(chunk types.Chunk) []types.Finding { //nolint:gocognit
+	lines := strings.Split(chunk.Content, "\n")
+	var findings []types.Finding
+
+	matched := d.registry.MatchKeywords(chunk.Content)
+	for _, rule := range matched {
+		for i, line := range lines {
+			matches := rule.Pattern.FindAllStringSubmatchIndex(
+				line, -1,
+			)
+			if len(matches) == 0 {
+				continue
+			}
+
+			for _, loc := range matches {
+				secret := extractSecret(line, loc, rule.SecretGroup)
+				if secret == "" {
+					continue
+				}
+
+				match := line[loc[0]:loc[1]]
+
+				finding := types.Finding{
+					RuleID:      rule.ID,
+					Description: rule.Description,
+					Severity:    rule.Severity,
+					Match:       match,
+					Secret:      secret,
+					FilePath:    chunk.FilePath,
+					LineNumber:  chunk.LineStart + i,
+					LineContent: line,
+					CommitSHA:   chunk.CommitSHA,
+					Author:      chunk.Author,
+					CommitDate:  chunk.CommitDate,
+				}
+
+				if rule.Entropy != nil {
+					charset := rules.DetectCharset(secret)
+					var charsetStr string
+					switch charset {
+					case "hex":
+						charsetStr = rules.HexCharset
+					case "base64":
+						charsetStr = rules.Base64Charset
+					default:
+						charsetStr = rules.AlphanumericCharset
+					}
+					entropy := rules.ShannonEntropy(
+						secret, charsetStr,
+					)
+					finding.Entropy = entropy
+
+					if entropy < *rule.Entropy {
+						continue
+					}
+				}
+
+				if !FilterFinding(&finding, rule) {
+					continue
+				}
+
+				findings = append(findings, finding)
+			}
+		}
+	}
+
+	findings = append(
+		findings,
+		d.detectHighEntropy(chunk, lines, findings)...,
+	)
+
+	return findings
+}
+
+var entropyCharsets = []struct {
+	charset   string
+	threshold float64
+}{
+	{rules.Base64Charset, 4.5},
+	{rules.HexCharset, 3.5},
+}
+
+func (d *Detector) detectHighEntropy(
+	chunk types.Chunk,
+	lines []string,
+	existing []types.Finding,
+) []types.Finding {
+	var findings []types.Finding
+	dummyRule := &types.Rule{}
+
+	for i, line := range lines {
+		if !HasAssignmentOperator(line) {
+			continue
+		}
+		lineNum := chunk.LineStart + i
+
+		for _, cs := range entropyCharsets {
+			tokens := rules.ExtractHighEntropyTokens(
+				line, cs.charset, cs.threshold, 20,
+			)
+			for _, token := range tokens {
+				if isAlreadyCaught(
+					token.Value, lineNum, existing,
+				) {
+					continue
+				}
+				if isAlreadyCaught(
+					token.Va
```

---

## Code Evolution

### Change Analysis for `detector.go`

**What was Changed:**
The file `detector.go` introduces a new Go package and implements the `Detector` struct with methods to detect secrets in code chunks using a rules registry. The `Detect` method processes each line of a chunk's content, matching keywords against predefined rules and extracting potential secrets. Additionally, it includes an entropy-based detection mechanism for high-entropy strings.

**Why Changed:**
This change was likely made to enhance the Go secrets scanner by incorporating more sophisticated secret detection techniques. Specifically, it integrates keyword matching with regex patterns and adds an entropy analysis step to filter out false positives.

**Impact on Behavior:**
The `Detect` method now provides a comprehensive approach to identifying secrets, combining rule-based matching with entropy checks. This should improve the accuracy of detected secrets by reducing noise from non-secret data.

**Risks or Concerns:**
- The use of regular expressions (`FindAllStringSubmatchIndex`) could introduce performance bottlenecks for very large files.
- The entropy calculation might be computationally expensive, especially if applied to every line.
- The `FilterFinding` function's implementation is not shown but should ensure that only relevant findings are returned.

Overall, this change significantly enhances the scanner’s capabilities by adding robust secret detection mechanisms.

---

*Generated by CodeWorm on 2026-02-22 20:37*
