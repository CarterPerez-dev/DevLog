# repository

**Type:** Code Evolution
**Repository:** fullstack-template
**File:** stacks/go-react/go-backend/internal/auth/repository.go
**Language:** go
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```go
Commit: bf95949c
Message: go backend to react-go stack
Author: CarterPerez-dev
File: stacks/go-react/go-backend/internal/auth/repository.go
Change type: new file

Diff:
@@ -0,0 +1,236 @@
+// AngelaMos | 2026
+// repository.go
+
+package auth
+
+import (
+	"context"
+	"database/sql"
+	"errors"
+	"fmt"
+	"time"
+
+	"github.com/carterperez-dev/templates/go-backend/internal/core"
+)
+
+type Repository interface {
+	Create(ctx context.Context, token *RefreshToken) error
+	FindByHash(ctx context.Context, tokenHash string) (*RefreshToken, error)
+	FindByID(ctx context.Context, id string) (*RefreshToken, error)
+	MarkAsUsed(ctx context.Context, id, replacedByID string) error
+	RevokeByID(ctx context.Context, id string) error
+	RevokeByFamilyID(ctx context.Context, familyID string) error
+	RevokeAllForUser(ctx context.Context, userID string) error
+	GetActiveSessionsForUser(
+		ctx context.Context,
+		userID string,
+	) ([]RefreshToken, error)
+	DeleteExpired(ctx context.Context) (int64, error)
+}
+
+type repository struct {
+	db core.DBTX
+}
+
+func NewRepository(db core.DBTX) Repository {
+	return &repository{db: db}
+}
+
+func (r *repository) Create(ctx context.Context, token *RefreshToken) error {
+	query := `
+		INSERT INTO refresh_tokens (
+			id, user_id, token_hash, family_id, expires_at,
+			user_agent, ip_address
+		) VALUES (
+			$1, $2, $3, $4, $5, $6, $7
+		)
+		RETURNING created_at`
+
+	err := r.db.GetContext(ctx, &token.CreatedAt, query,
+		token.ID,
+		token.UserID,
+		token.TokenHash,
+		token.FamilyID,
+		token.ExpiresAt,
+		token.UserAgent,
+		token.IPAddress,
+	)
+	if err != nil {
+		return fmt.Errorf("create refresh token: %w", err)
+	}
+
+	return nil
+}
+
+func (r *repository) FindByHash(
+	ctx context.Context,
+	tokenHash string,
+) (*RefreshToken, error) {
+	query := `
+		SELECT
+			id, user_id, token_hash, family_id, expires_at, created_at,
+			is_used, used_at, revoked_at, replaced_by_id, user_agent, ip_address
+		FROM refresh_tokens
+		WHERE token_hash = $1`
+
+	var token RefreshToken
+	err := r.db.GetContext(ctx, &token, query, tokenHash)
+	if errors.Is(err, sql.ErrNoRows) {
+		return nil, fmt.Errorf("find refresh token: %w", core.ErrNotFound)
+	}
+	if err != nil {
+		return nil, fmt.Errorf("find refresh token: %w", err)
+	}
+
+	return &token, nil
+}
+
+func (r *repository) FindByID(
+	ctx context.Context,
+	id string,
+) (*RefreshToken, error) {
+	query := `
+		SELECT
+			id, user_id, token_hash, family_id, expires_at, created_at,
+			is_used, used_at, revoked_at, replaced_by_id, user_agent, ip_address
+		FROM refresh_tokens
+		WHERE id = $1`
+
+	var token RefreshToken
+	err := r.db.GetContext(ctx, &token, query, id)
+	if errors.Is(err, sql.ErrNoRows) {
+		return nil, fmt.Errorf("find refresh token: %w", core.ErrNotFound)
+	}
+	if err != nil {
+		return nil, fmt.Errorf("find refresh token: %w", err)
+	}
+
+	return &token, nil
+}
+
+func (r *repository) MarkAsUsed(
+	ctx context.Context,
+	id, replacedByID string,
+) error {
+	
```

---

## Code Evolution

### Change Analysis

**What was Changed:**
A new file `repository.go` was added to the Go backend, defining a `Repository` interface and its implementation for managing refresh tokens. The implementation includes methods like `Create`, `FindByHash`, `MarkAsUsed`, `RevokeByID`, etc., which handle CRUD operations on refresh tokens.

**Why it Was Likely Changed:**
This change likely aims to centralize token management logic in the backend, improving modularity and separation of concerns between frontend (React) and backend services. The introduction of a repository pattern ensures that all database interactions are encapsulated within this interface, making the codebase more maintainable and testable.

**Impact on Behavior:**
The new methods provide a structured way to interact with refresh tokens, ensuring consistency in how they are created, retrieved, used, revoked, and deleted. This impacts the overall security and session management of the application by providing robust mechanisms for token lifecycle management.

**Risks or Concerns:**
While this change enhances code organization, it introduces dependencies on the `core.DBTX` interface, which must be properly implemented elsewhere in the project. Additionally, error handling is crucial; the use of custom errors like `core.ErrNotFound` should be consistent and well-defined to avoid runtime issues.

Overall, this change is a refactor that aligns with best practices for Go development, focusing on clear interfaces and robust data management.

---

*Generated by CodeWorm on 2026-02-22 13:53*
