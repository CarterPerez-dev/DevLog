# batch_processor

**Type:** Code Evolution
**Repository:** vuemantics
**File:** backend/workers/batch_processor.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: 4d33b24a
Message: feat: dramatiq - bulkupload
Author: CarterPerez-dev
File: backend/workers/batch_processor.py
Change type: modified

Diff:
@@ -12,15 +12,16 @@ batch_processor.py
 
 import asyncio
 import logging
+import threading
 from uuid import UUID
 
 import dramatiq
 
+import database
 from core.tasks import broker
+from core.redis import redis_pool
 from core.websocket import (
-    get_publisher,
-    BatchProgressUpdate,
-    BatchProgressPayload,
+    init_publisher,
 )
 from models.Upload import (
     Upload,
@@ -32,9 +33,59 @@ from models.UploadBatch import (
 )
 from services.ai.service import LocalAIService
 
+from .batch_helpers import (
+    publish_batch_progress,
+    publish_file_progress,
+    process_upload_with_retry,
+)
+
 
 logger = logging.getLogger(__name__)
 
+# Thread-local storage for event loop and initialization state
+_thread_local = threading.local()
+
+
+def get_or_create_event_loop() -> asyncio.AbstractEventLoop:
+    """
+    Get or create event loop for current thread
+
+    Returns:
+        Event loop instance
+    """
+    try:
+        loop = asyncio.get_event_loop()
+        if loop.is_closed():
+            loop = asyncio.new_event_loop()
+            asyncio.set_event_loop(loop)
+    except RuntimeError:
+        loop = asyncio.new_event_loop()
+        asyncio.set_event_loop(loop)
+
+    return loop
+
+
+async def ensure_worker_initialized() -> None:
+    """
+    Ensure worker thread is initialized (database, Redis, publisher)
+
+    Idempotent - safe to call multiple times, only initializes once per thread
+    """
+    if getattr(_thread_local, 'initialized', False):
+        return
+
+    # Initialize database connection
+    await database.db.connect()
+
+    # Initialize Redis connection pool
+    await redis_pool.connect()
+
+    # Initialize WebSocket publisher (for publishing to Redis only - no listener needed)
+    init_publisher()
+
+    _thread_local.initialized = True
+    logger.info("Worker thread initialized")
+
 
 @dramatiq.actor(
     broker = broker,
@@ -60,8 +111,11 @@ def process_batch(batch_id: str) -> None:
     # String UUID back to UUID
     batch_uuid = UUID(batch_id)
 
-    # Async
-    asyncio.run(_process_batch_async(batch_uuid))
+    # Get or create event loop for this thread
+    loop = get_or_create_event_loop()
+
+    # Run async processing
+    loop.run_until_complete(_process_batch_async(batch_uuid))
 
 
 async def _process_batch_async(batch_id: UUID) -> None:
@@ -71,6 +125,9 @@ async def _process_batch_async(batch_id: UUID) -> None:
     Args:
         batch_id: UUID of the batch to process
     """
+    # Initialize worker thread (idempotent - only runs once per thread)
+    await ensure_worker_initialized()
+
     logger.info(f"Starting batch processing for batch {batch_id}")
 
     batch = await UploadBatch.find_by_id(batch_id)
@@ -88,7 +145,7 @@ async def _process_batch_async(batch_id: UUID) -> None:
         f"{batch.total_uploads} uploads to process"
 
```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The code introduces threading and asynchronous initialization for the worker thread, along with refactoring of upload processing logic into helper functions. Specifically:
- Added `threading` module imports.
- Introduced `get_or_create_event_loop`, `ensure_worker_initialized`, and related async helpers.
- Updated `_process_batch_async` to use these new helpers.

**Why it was Likely Changed:**
This change likely aims to improve thread safety and ensure consistent initialization across worker threads. By using thread-local storage for the event loop, it ensures that each thread has its own isolated environment, preventing race conditions. The `ensure_worker_initialized` function guarantees that critical resources like database connections are set up only once per thread.

**Impact on Behavior:**
- **Initialization:** Worker threads now initialize necessary resources (database, Redis) idempotently.
- **Concurrency:** Asynchronous operations are handled safely across multiple threads.
- **Progress Updates:** New helper functions `publish_batch_progress` and `publish_file_progress` streamline progress reporting.

**Risks or Concerns:**
- Potential race conditions if not all threads properly initialize resources.
- Increased complexity due to threading, which may introduce subtle bugs.
- Ensure that the new initialization logic does not conflict with existing concurrency control mechanisms.

---

*Generated by CodeWorm on 2026-02-23 10:33*
