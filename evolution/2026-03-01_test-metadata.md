# test_metadata

**Type:** Code Evolution
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/tests/test_metadata.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: f9b5a614
Message: feat: did a couple things idk
Author: CarterPerez-dev
File: PROJECTS/advanced/ai-threat-detection/backend/tests/test_metadata.py
Change type: modified

Diff:
@@ -192,3 +192,35 @@ class TestSaveModelMetadata:
 
         assert len(active_rows) == 3
         assert all(r.training_samples == 600 for r in active_rows)
+
+    @pytest.mark.asyncio
+    async def test_previous_inactive_rows_preserved(
+        self,
+        db_session: AsyncSession,
+        model_artifacts: Path,
+    ) -> None:
+        """
+        Old model rows are deactivated, not deleted, after a new save
+        """
+        await save_model_metadata(
+            db_session,
+            model_dir=model_artifacts,
+            training_samples=500,
+            metrics={"f1": 0.9},
+        )
+
+        (model_artifacts / "ae.onnx").write_bytes(b"new-ae-data")
+        await save_model_metadata(
+            db_session,
+            model_dir=model_artifacts,
+            training_samples=600,
+            metrics={"f1": 0.95},
+        )
+
+        result = await db_session.execute(select(ModelMetadata))
+        all_rows = result.scalars().all()
+        inactive = [r for r in all_rows if not r.is_active]
+
+        assert len(all_rows) == 6
+        assert len(inactive) == 3
+        assert all(r.training_samples == 500 for r in inactive)

```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The commit added a new test method `test_previous_inactive_rows_preserved` to the `test_metadata.py` file. This method ensures that old model rows are deactivated, not deleted, after a new save operation.

Specifically:
- A new test function is introduced at line 192.
- The function uses `@pytest.mark.asyncio` and `async def` to indicate it's an asynchronous test.
- Two calls to `save_model_metadata` simulate saving model metadata with different training samples.
- The test then queries the database to verify that old inactive rows are preserved.

**Why It Was Likely Changed:**
This change likely aims to ensure data integrity by preventing accidental deletion of historical model metadata. By deactivating old entries instead, it maintains a record of past models while allowing new versions to be saved without overwriting previous data.

**Impact on Behavior:**
The addition of this test ensures that the system correctly handles updates to model metadata, preserving inactive rows and only updating active ones. This is crucial for maintaining historical records and ensuring data consistency.

**Risks or Concerns:**
- The new behavior might affect performance if there are many old entries, as they will continue to occupy space in the database.
- There's a risk that developers might misunderstand the deactivation mechanism, leading to potential bugs where inactive rows are mistakenly considered active.

---

*Generated by CodeWorm on 2026-03-01 12:49*
