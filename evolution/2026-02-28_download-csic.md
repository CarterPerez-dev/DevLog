# download_csic

**Type:** Code Evolution
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/ml/download_csic.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: f9b5a614
Message: feat: did a couple things idk
Author: CarterPerez-dev
File: PROJECTS/advanced/ai-threat-detection/backend/ml/download_csic.py
Change type: modified

Diff:
@@ -7,7 +7,8 @@ import hashlib
 import logging
 import sys
 from pathlib import Path
-from urllib.request import urlretrieve
+
+import httpx
 
 logger = logging.getLogger(__name__)
 
@@ -26,24 +27,6 @@ FILES = [
 MIN_FILE_BYTES = 1_000_000
 
 
-def _progress_hook(
-    block_num: int,
-    block_size: int,
-    total_size: int,
-) -> None:
-    """
-    Print download progress to stdout
-    """
-    downloaded = block_num * block_size
-    if total_size > 0:
-        pct = min(downloaded * 100 / total_size, 100)
-        sys.stdout.write(f"\r  {pct:.0f}%")
-    else:
-        mb = downloaded / 1_048_576
-        sys.stdout.write(f"\r  {mb:.1f} MB")
-    sys.stdout.flush()
-
-
 def _compute_sha256(path: Path) -> str:
     """
     Compute SHA-256 hash of a file
@@ -73,7 +56,31 @@ def download_csic(output_dir: Path = DATASET_DIR, ) -> None:
         print(f"Downloading {filename}...")
 
         try:
-            urlretrieve(url, dest, reporthook=_progress_hook)
+            with httpx.stream(
+                "GET",
+                url,
+                follow_redirects=True,
+            ) as response:
+                response.raise_for_status()
+                total = int(
+                    response.headers.get("content-length", 0)
+                )
+                downloaded = 0
+                with open(dest, "wb") as f:
+                    for chunk in response.iter_bytes(
+                        chunk_size=65536
+                    ):
+                        f.write(chunk)
+                        downloaded += len(chunk)
+                        if total > 0:
+                            pct = min(
+                                downloaded * 100 / total, 100
+                            )
+                            sys.stdout.write(f"\r  {pct:.0f}%")
+                        else:
+                            mb = downloaded / 1_048_576
+                            sys.stdout.write(f"\r  {mb:.1f} MB")
+                        sys.stdout.flush()
             print()
         except Exception as exc:
             logger.error(

```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The code switched from using `urlretrieve` to the `httpx` library for downloading files. The `_progress_hook` function, which printed download progress to stdout, was removed and replaced with a custom implementation that uses `httpx.stream`.

**Why it was Likely Changed:**
This change likely aims to provide more control over the HTTP request process using `httpx`, potentially offering features like automatic redirection handling (`follow_redirects=True`). The new approach also allows for chunked file downloads, which can be more efficient and flexible.

**Impact on Behavior:**
- **Progress Reporting:** The progress reporting now uses a custom implementation that writes to stdout in a similar manner but with improved control over the download process.
- **Error Handling:** The use of `httpx.stream` provides better error handling and status checks, which can lead to more robust downloads.

**Risks or Concerns:**
- **Complexity Increase:** Introducing `httpx` might increase code complexity for those unfamiliar with it.
- **Resource Management:** The custom implementation manages file writing and progress reporting manually, which could introduce subtle bugs if not handled correctly.
- **Performance Impact:** While chunked downloads are generally efficient, the additional overhead of managing the stream could impact performance in edge cases.

Overall, this change likely improves the robustness and flexibility of the download process.

---

*Generated by CodeWorm on 2026-02-28 17:32*
