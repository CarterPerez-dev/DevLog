# payout_repo

**Type:** Code Evolution
**Repository:** stripe-referral
**File:** src/stripe_referral/repositories/payout_repo.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: bfb52633
Message: feat: Done
Author: CarterPerez-dev
File: src/stripe_referral/repositories/payout_repo.py
Change type: new file

Diff:
@@ -0,0 +1,104 @@
+"""
+â’¸AngelaMos | 2025 | CertGames.com
+Payout repository
+"""
+
+from datetime import (
+    UTC,
+    datetime,
+)
+
+from sqlalchemy import select
+from sqlalchemy.orm import Session
+
+from ..config.enums import PayoutStatus
+from ..models.Payout import Payout
+
+from .base import BaseRepository
+
+
+class PayoutRepository(BaseRepository[Payout]):
+    """
+    Repository for Payout database operations
+    """
+    def __init__(self, db: Session) -> None:
+        """
+        Initialize with Payout model
+        """
+        super().__init__(db, Payout)
+
+    def get_by_user(self, user_id: str) -> list[Payout]:
+        """
+        Get all payouts for a user
+        """
+        stmt = select(Payout).where(Payout.user_id == user_id)
+        return list(self.db.execute(stmt).scalars().all())
+
+    def get_by_tracking_id(self, tracking_id: int) -> Payout | None:
+        """
+        Get payout by tracking ID
+        """
+        stmt = select(Payout).where(Payout.tracking_id == tracking_id)
+        return self.db.execute(stmt).scalar_one_or_none()
+
+    def get_pending_payouts(self,
+                            limit: int | None = None) -> list[Payout]:
+        """
+        Get all pending payouts with optional limit
+        """
+        stmt = select(Payout).where(
+            Payout.status == PayoutStatus.PENDING.value
+        )
+        if limit:
+            stmt = stmt.limit(limit)
+        return list(self.db.execute(stmt).scalars().all())
+
+    def get_failed_payouts(self,
+                           limit: int | None = None) -> list[Payout]:
+        """
+        Get all failed payouts with optional limit
+        """
+        stmt = select(Payout).where(
+            Payout.status == PayoutStatus.FAILED.value
+        )
+        if limit:
+            stmt = stmt.limit(limit)
+        return list(self.db.execute(stmt).scalars().all())
+
+    def mark_as_paid(
+        self,
+        payout_id: int,
+        transaction_id: str
+    ) -> Payout | None:
+        """
+        Mark payout as paid with transaction ID
+        """
+        payout = self.get_by_id(payout_id)
+        if not payout:
+            return None
+
+        payout.status = PayoutStatus.PAID.value
+        payout.external_transaction_id = transaction_id
+        payout.processed_at = datetime.now(UTC)
+        self.db.commit()
+        self.db.refresh(payout)
+        return payout
+
+    def mark_as_failed(
+        self,
+        payout_id: int,
+        error_message: str
+    ) -> Payout | None:
+        """
+        Mark payout as failed with error message
+        """
+        payout = self.get_by_id(payout_id)
+        if not payout:
+            return None
+
+        payout.status = PayoutStatus.FAILED.value
+        payout.error_message = error_message
+        payout.failed_at = 
```

---

## Code Evolution

### Change Analysis

**What was Changed:**
A new file `payout_repo.py` was added to the `stripe-referral/repositories` directory. This file introduces a repository class, `PayoutRepository`, which encapsulates database operations for managing payouts using SQLAlchemy.

**Why it Was Likely Changed:**
This change likely aims to provide a structured way to handle CRUD (Create, Read, Update, Delete) operations on payout records in the database. The introduction of methods like `get_by_user`, `get_pending_payouts`, and `mark_as_paid` suggests an intention to streamline common use cases for managing payouts.

**Impact on Behavior:**
The new repository class significantly enhances the application's ability to interact with payout data. Developers can now easily retrieve, update, and manage payout records without directly interacting with SQLAlchemy queries, promoting cleaner and more maintainable code.

**Risks or Concerns:**
- **Database Consistency:** Ensuring that operations like `mark_as_paid` and `mark_as_failed` are atomic and consistent is crucial to avoid data corruption.
- **Error Handling:** While the methods handle some basic error checks (e.g., checking if a payout exists before marking it), more comprehensive exception handling might be necessary for robustness.

Overall, this change introduces a well-structured repository pattern that should improve code organization and maintainability.

---

*Generated by CodeWorm on 2026-02-23 08:25*
