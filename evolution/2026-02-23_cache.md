# cache

**Type:** Code Evolution
**Repository:** angela
**File:** internal/pypi/cache.go
**Language:** go
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```go
Commit: ea4cc501
Message: Create canonical module source location - release v1.0.0
Author: CarterPerez-dev
File: internal/pypi/cache.go
Change type: new file

Diff:
@@ -0,0 +1,105 @@
+// Â©AngelaMos | 2026
+// cache.go
+
+package pypi
+
+import (
+	"encoding/json"
+	"os"
+	"path/filepath"
+	"time"
+)
+
+// DefaultCacheTTL defines how long cached PyPI responses remain valid
+const DefaultCacheTTL = 1 * time.Hour
+
+// Cache provides file-backed storage for PyPI API responses with ETag support
+type Cache struct {
+	dir string
+	ttl time.Duration
+}
+
+// CacheEntry holds a cached PyPI response alongside its freshness metadata
+type CacheEntry struct {
+	ETag     string    `json:"etag"`
+	Versions []string  `json:"versions"`
+	CachedAt time.Time `json:"cached_at"`
+}
+
+// NewCache creates a file-backed cache at the given directory
+func NewCache(dir string, ttl time.Duration) (*Cache, error) {
+	if err := os.MkdirAll(dir, 0o750); err != nil {
+		return nil, err
+	}
+	return &Cache{dir: dir, ttl: ttl}, nil
+}
+
+// Get retrieves a cache entry by package name, returning false on miss
+func (c *Cache) Get(key string) (*CacheEntry, bool) {
+	data, err := os.ReadFile(c.path(key))
+	if err != nil {
+		return nil, false
+	}
+
+	var entry CacheEntry
+	if err := json.Unmarshal(data, &entry); err != nil {
+		return nil, false
+	}
+	return &entry, true
+}
+
+// IsFresh reports whether the entry is still within its TTL window
+func (c *Cache) IsFresh(entry *CacheEntry) bool {
+	return time.Since(entry.CachedAt) <= c.ttl
+}
+
+// Set writes a cache entry atomically using rename-over-temp
+func (c *Cache) Set(key string, entry *CacheEntry) error {
+	data, err := json.Marshal(entry)
+	if err != nil {
+		return err
+	}
+
+	tmp, err := os.CreateTemp(c.dir, "tmp-*.json")
+	if err != nil {
+		return err
+	}
+
+	if _, writeErr := tmp.Write(data); writeErr != nil {
+		_ = tmp.Close()           //nolint:errcheck
+		_ = os.Remove(tmp.Name()) //nolint:errcheck
+		return writeErr
+	}
+	_ = tmp.Close() //nolint:errcheck
+
+	return os.Rename(tmp.Name(), c.path(key))
+}
+
+// Touch refreshes the CachedAt timestamp without changing stored data
+func (c *Cache) Touch(key string) {
+	entry, ok := c.Get(key)
+	if !ok {
+		return
+	}
+	entry.CachedAt = time.Now()
+	_ = c.Set(key, entry) //nolint:errcheck
+}
+
+// Clear removes all cached entries from disk
+func (c *Cache) Clear() error {
+	entries, err := os.ReadDir(c.dir)
+	if err != nil {
+		return err
+	}
+	for _, e := range entries {
+		if filepath.Ext(e.Name()) == ".json" {
+			_ = os.Remove(filepath.Join(c.dir, e.Name())) //nolint:errcheck
+		}
+	}
+	return nil
+}
+
+func (c *Cache) path(key string) string {
+	safe := filepath.Base(key)
+	return filepath.Join(c.dir, safe+".json")
+}

```

---

## Code Evolution

### Change Analysis for `cache.go`

**What was Changed:**
The commit introduces a new file, `cache.go`, which implements caching mechanisms for PyPI API responses. The code defines constants, types, and functions to manage cache entries, including reading, writing, refreshing, and clearing cached data.

**Why it Was Likely Changed:**
This change likely aims to improve performance by reducing the number of requests made to the PyPI server. Caching responses with ETag support ensures that only outdated or missing data is fetched from the network, making the system more efficient.

**Impact on Behavior:**
The addition of caching significantly enhances the application's responsiveness and reduces load times for repeated API calls. The `Get` function retrieves cached entries, while `Set`, `Touch`, and `Clear` manage cache persistence and freshness. This change is crucial for maintaining a balance between network requests and local processing.

**Risks or Concerns:**
- **Data Consistency:** Ensuring that the cache remains up-to-date with the PyPI server's data requires careful handling of ETags and TTL.
- **Error Handling:** The code uses `nolint` comments to suppress error checks, which could lead to unhandled errors. Proper error logging or re-throwing should be considered.
- **Security:** Storing sensitive information in files might pose security risks; ensure that the cache directory is properly secured.

Overall, this change introduces a robust caching mechanism that will likely improve application performance while managing potential risks effectively.

---

*Generated by CodeWorm on 2026-02-23 13:53*
