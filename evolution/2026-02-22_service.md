# service

**Type:** Code Evolution
**Repository:** oneIsNun_
**File:** go-backend/internal/metrics/service.go
**Language:** go
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```go
Commit: 4ffe4b69
Message: feat: add real-time query speeds to dashboard

Backend:
- Add current_ops array to DashboardMetrics with query details
- Add CurrentOperation type with collection, type, timing, client
- Extract collection name from namespace
- Include microseconds and milliseconds for each active operation

Frontend:
- Add CurrentOperation schema to metrics types
- Display live operations table when operations are active
- Show collection, operation type, speed (Âµs or ms), and client
- Style operations table with hover effects and monospace speed
- Fix undefined $bg-surface-150 variable (use $bg-overlay)

Real-time query speeds now visible in dashboard via WebSocket!
Author: CarterPerez-dev
File: go-backend/internal/metrics/service.go
Change type: modified

Diff:
@@ -38,15 +38,26 @@ func NewService(repo metricsRepository, database string) *Service {
 }
 
 type DashboardMetrics struct {
-	Timestamp       time.Time       `json:"timestamp"`
-	Server          ServerMetrics   `json:"server"`
-	Database        DatabaseMetrics `json:"database"`
-	Connections     ConnectionStats `json:"connections"`
-	Operations      OpCounters      `json:"operations"`
-	Memory          MemoryStats     `json:"memory"`
-	Network         NetworkStats    `json:"network"`
-	ActiveOps       int             `json:"active_ops"`
-	PaidSubscribers int64           `json:"paid_subscribers"`
+	Timestamp       time.Time          `json:"timestamp"`
+	Server          ServerMetrics      `json:"server"`
+	Database        DatabaseMetrics    `json:"database"`
+	Connections     ConnectionStats    `json:"connections"`
+	Operations      OpCounters         `json:"operations"`
+	Memory          MemoryStats        `json:"memory"`
+	Network         NetworkStats       `json:"network"`
+	ActiveOps       int                `json:"active_ops"`
+	CurrentOps      []CurrentOperation `json:"current_ops"`
+	PaidSubscribers int64              `json:"paid_subscribers"`
+}
+
+type CurrentOperation struct {
+	OpID             int     `json:"opid"`
+	Type             string  `json:"type"`
+	Namespace        string  `json:"namespace"`
+	Collection       string  `json:"collection"`
+	MicrosecsRunning int64   `json:"microsecs_running"`
+	MillisRunning    float64 `json:"millis_running"`
+	Client           string  `json:"client"`
 }
 
 type ServerMetrics struct {
@@ -126,6 +137,20 @@ func (s *Service) GetDashboardMetrics(ctx context.Context) (*DashboardMetrics, e
 		serverStatus.Opcounters.Getmore +
 		serverStatus.Opcounters.Command
 
+	currentOps := make([]CurrentOperation, 0, len(activeOps))
+	for _, op := range activeOps {
+		collection := extractCollection(op.Namespace)
+		currentOps = append(currentOps, CurrentOperation{
+			OpID:             op.OpID,
+			Type:             op.Op,
+			Namespace:        op.Namespace,
+			Collection:       collection,
+			MicrosecsRunning: op.MicrosecsRunning,
+			MillisRunning:    float64(op.MicrosecsRunning) / 1000.0,
+			Client:           op.Client,
+		})
+	}
+
 	re
```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The code added `CurrentOperation` and `current_ops` to the `DashboardMetrics` struct, along with a method to populate these fields from active operations. The `extractCollection` function was introduced to extract collection names from namespaces.

**Why it Was Likely Changed:**
This change likely aims to provide real-time query speed information for dashboard monitoring. By adding detailed operation data and extracting relevant parts of the namespace, the system can now display live operation details such as type, duration, and client.

**Impact on Behavior:**
The backend now includes current operations in the dashboard metrics, which will be displayed via WebSocket updates. This provides users with real-time insights into ongoing database activities, helping them to identify potential bottlenecks or performance issues quickly.

**Risks or Concerns:**
- **Performance Impact:** Extracting collection names and calculating running times could introduce additional overhead.
- **Error Handling:** The `extractCollection` function assumes well-formed namespaces; errors might occur if the format is unexpected.
- **WebSocket Load:** Real-time updates may increase WebSocket traffic, potentially affecting performance under high load.

Overall, this change enhances monitoring capabilities but requires careful testing to ensure it does not introduce significant overhead.

---

*Generated by CodeWorm on 2026-02-22 23:51*
