# main

**Type:** Code Evolution
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/cli/main.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: f9b5a614
Message: feat: did a couple things idk
Author: CarterPerez-dev
File: PROJECTS/advanced/ai-threat-detection/backend/cli/main.py
Change type: modified

Diff:
@@ -3,6 +3,8 @@
 main.py
 """
 
+import asyncio
+import dataclasses
 from pathlib import Path
 
 import typer
@@ -22,6 +24,44 @@ DEFAULT_EXPERIMENT_NAME = "angelusvigil-training"
 DEFAULT_SERVER_URL = "http://localhost:8000"
 
 
+async def _write_metadata(
+    model_dir: Path,
+    training_samples: int,
+    metrics: dict[str, object],
+    mlflow_run_id: str | None,
+    threshold: float | None,
+) -> None:
+    """
+    Persist training metadata to the database
+    """
+    from app.config import settings
+    from ml.metadata import save_model_metadata
+    from sqlalchemy.ext.asyncio import (
+        AsyncSession,
+        async_sessionmaker,
+        create_async_engine,
+    )
+
+    engine = create_async_engine(settings.database_url)
+    try:
+        factory = async_sessionmaker(
+            engine,
+            class_=AsyncSession,
+            expire_on_commit=False,
+        )
+        async with factory() as session:
+            await save_model_metadata(
+                session,
+                model_dir=model_dir,
+                training_samples=training_samples,
+                metrics=metrics,
+                mlflow_run_id=mlflow_run_id,
+                threshold=threshold,
+            )
+    finally:
+        await engine.dispose()
+
+
 @app.command()
 def serve(
     host: str = typer.Option("0.0.0.0", help="Bind address"),
@@ -92,9 +132,10 @@ def train(
             )
             raise typer.Exit(code=1)
 
-        from ml.data_loader import load_csic_dataset
+        from ml.data_loader import load_csic_dataset, load_csic_normal
 
         normal_path = csic_dir / "normalTrafficTraining.txt"
+        normal_test_path = csic_dir / "normalTrafficTest.txt"
         attack_path = csic_dir / "anomalousTrafficTest.txt"
         typer.echo(f"Loading CSIC data from {csic_dir}")
         X_csic, y_csic = load_csic_dataset(
@@ -106,6 +147,14 @@ def train(
             f"  CSIC: {len(X_csic)} samples"
         )
 
+        if normal_test_path.exists():
+            X_extra, y_extra = load_csic_normal(normal_test_path)
+            X_parts.append(X_extra)
+            y_parts.append(y_extra)
+            typer.echo(
+                f"  CSIC normal test: {len(X_extra)} samples"
+            )
+
     if synthetic_normal > 0 or synthetic_attack > 0:
         from ml.synthetic import generate_mixed_dataset
 
@@ -143,6 +192,25 @@ def train(
     )
     result = orch.run(X, y)
 
+    try:
+        metrics: dict[str, object] = (
+            dataclasses.asdict(result.ensemble_metrics)
+            if result.ensemble_metrics else {}
+        )
+        asyncio.run(_write_metadata(
+            Path(output_dir),
+            int(len(X)),
+            metrics,
+            result.mlflow_run_id,
+            result.ae_metrics.get("ae_threshold"),
+        ))
+   
```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The commit introduces an asynchronous function `_write_metadata` to persist training metadata to the database and updates the `train` function to call this new function after model training. Additionally, it adds support for loading extra normal test data from a separate file.

**Why it Was Likely Changed:**
This change likely aims to improve the robustness of the AI threat detection system by ensuring that all relevant metadata is stored in a database post-training. The addition of handling an optional `normal_test_path` suggests flexibility in using different datasets for testing, which could be useful for fine-tuning models.

**Impact on Behavior:**
- **New Functionality:** The `_write_metadata` function will now save important training details to the database.
- **Enhanced Data Handling:** The system can now process and store additional normal test data if available, providing more comprehensive model evaluation.

**Risks or Concerns:**
- **Asynchronous Code:** Introducing `asyncio.run()` in a context where synchronous code predominates might introduce complexity. Ensure that all dependencies are properly awaited to avoid potential deadlocks.
- **Error Handling:** The try-except block around `_write_metadata` is good, but ensure that the error messages and handling logic are comprehensive enough to diagnose issues effectively.

Overall, these changes enhance data management and flexibility in model training processes while introducing some complexity due to asynchronous operations.

---

*Generated by CodeWorm on 2026-02-28 16:16*
