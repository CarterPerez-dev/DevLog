# useSession

**Type:** Code Evolution
**Repository:** ios-test
**File:** red-recon/src/shared/hooks/useSession.ts
**Language:** typescript
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```typescript
Commit: 120aefce
Message: checkpoint
Author: CarterPerez-dev
File: red-recon/src/shared/hooks/useSession.ts
Change type: modified

Diff:
@@ -3,7 +3,23 @@
  * useSession.ts
  */
 
+import { getAccessToken, setAccessToken } from '@/core/api/api.config'
+import { API_ENDPOINTS } from '@/core/config'
 import { useAuthStore } from '@/core/lib'
+import { SECURE_KEYS, secureStorage } from '@/core/storage'
+import axios from 'axios'
+import { useEffect, useState } from 'react'
+
+const YOUR_DEV_IP = '192.168.1.167'
+const YOUR_DEV_PORT = '8501'
+const YOUR_PROD_API_URL = 'https://api.carterperez-dev.com'
+
+const getBaseURL = (): string => {
+  if (__DEV__) {
+    return `http://${YOUR_DEV_IP}:${YOUR_DEV_PORT}`
+  }
+  return YOUR_PROD_API_URL
+}
 
 interface UseSessionReturn {
   isAuthenticated: boolean
@@ -16,8 +32,48 @@ export const useSession = (): UseSessionReturn => {
   const isAuthenticated = useAuthStore((s) => s.isAuthenticated)
   const isLoading = useAuthStore((s) => s.isLoading)
   const hasHydrated = useAuthStore((s) => s.hasHydrated)
+  const logout = useAuthStore((s) => s.logout)
+  const [isRestoringSession, setIsRestoringSession] = useState(true)
+
+  useEffect(() => {
+    const restoreSession = async (): Promise<void> => {
+      if (!hasHydrated) return
+
+      if (isAuthenticated && getAccessToken() === null) {
+        try {
+          const refreshToken = await secureStorage.getItem(SECURE_KEYS.REFRESH_TOKEN)
+
+          if (!refreshToken) {
+            logout()
+            setIsRestoringSession(false)
+            return
+          }
+
+          const response = await axios.post<{ access_token: string; refresh_token: string }>(
+            `${getBaseURL()}${API_ENDPOINTS.AUTH.REFRESH_MOBILE}`,
+            { refresh_token: refreshToken }
+          )
+
+          if (response.data?.access_token) {
+            setAccessToken(response.data.access_token)
+            if (response.data.refresh_token) {
+              await secureStorage.setItem(SECURE_KEYS.REFRESH_TOKEN, response.data.refresh_token)
+            }
+          } else {
+            logout()
+          }
+        } catch {
+          logout()
+        }
+      }
+
+      setIsRestoringSession(false)
+    }
+
+    restoreSession()
+  }, [hasHydrated, isAuthenticated, logout])
 
-  const isReady = hasHydrated && !isLoading
+  const isReady = hasHydrated && !isLoading && !isRestoringSession
 
   return {
     isAuthenticated,

```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The code introduces several new imports, constants, and a function `getBaseURL`. A state variable `isRestoringSession` is added along with an effect hook to handle session restoration. The logic for restoring the session from a refresh token has been implemented.

**Why it Was Likely Changed:**
This change likely aims to improve session management by ensuring that users can seamlessly log in using their refresh tokens, even if they have logged out or the access token is invalid. This is common in applications where sessions need to be automatically restored without requiring user interaction.

**Impact on Behavior:**
The `useSession` hook now includes a mechanism for restoring the session when the application starts up, provided that certain conditions are met (e.g., `hasHydrated` and `isAuthenticated`). The addition of `isRestoringSession` ensures that the initial loading state is correctly managed.

**Risks or Concerns:**
- **Security Risks:** Storing refresh tokens in local storage could pose security risks if not properly secured. Ensure that `secureStorage` uses strong encryption.
- **Performance Impact:** The session restoration logic involves network requests, which might impact performance during initial load times.
- **Complexity Increase:** Adding this functionality increases the complexity of the hook, making it harder to maintain and understand.

Overall, these changes enhance the application's ability to handle sessions more robustly but should be reviewed for potential security and performance issues.

---

*Generated by CodeWorm on 2026-02-23 12:34*
