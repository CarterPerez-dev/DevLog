# client_test

**Type:** Code Evolution
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/intermediate/secrets-scanner/internal/hibp/client_test.go
**Language:** go
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```go
Commit: 294169a2
Message: feat: Complete Go secrets scanner - Portia
Author: CarterPerez-dev
File: PROJECTS/intermediate/secrets-scanner/internal/hibp/client_test.go
Change type: new file

Diff:
@@ -0,0 +1,203 @@
+// Â©AngelaMos | 2026
+// client_test.go
+
+package hibp
+
+import (
+	"context"
+	"fmt"
+	"net/http"
+	"net/http/httptest"
+	"testing"
+
+	"github.com/stretchr/testify/assert"
+	"github.com/stretchr/testify/require"
+)
+
+func TestSha1Hash(t *testing.T) {
+	t.Parallel()
+	got := sha1Hash("password")
+	assert.Equal(t,
+		"5BAA61E4C9B93F3F0682250B6CF8331B7EE68FD8",
+		got,
+	)
+}
+
+func TestClientCheckBreached(t *testing.T) {
+	t.Parallel()
+
+	hash := sha1Hash("password")
+	prefix := hash[:5]
+	suffix := hash[5:]
+
+	server := httptest.NewServer(
+		http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
+			assert.Equal(t, "/range/"+prefix, r.URL.Path)
+			w.WriteHeader(http.StatusOK)
+			fmt.Fprintf( //nolint:errcheck
+				w,
+				"%s:3861493\n",
+				suffix,
+			)
+			fmt.Fprintf( //nolint:errcheck
+				w,
+				"0000000000000000000000000000DEAD0:0\n",
+			)
+		}),
+	)
+	defer server.Close()
+
+	client := NewClient()
+	client.baseURL = server.URL + "/range/"
+
+	result, err := client.Check(context.Background(), "password")
+	require.NoError(t, err)
+	assert.True(t, result.Breached)
+	assert.Equal(t, 3861493, result.Count)
+}
+
+func TestClientCheckClean(t *testing.T) {
+	t.Parallel()
+
+	server := httptest.NewServer(
+		http.HandlerFunc(func(w http.ResponseWriter, _ *http.Request) {
+			w.WriteHeader(http.StatusOK)
+			fmt.Fprintf(w, //nolint:errcheck
+				"0000000000000000000000000000AAAA0:5\n")
+			fmt.Fprintf( //nolint:errcheck
+				w,
+				"0000000000000000000000000000BBBB0:2\n",
+			)
+		}),
+	)
+	defer server.Close()
+
+	client := NewClient()
+	client.baseURL = server.URL + "/range/"
+
+	result, err := client.Check(
+		context.Background(), "unique_password_not_in_breach",
+	)
+	require.NoError(t, err)
+	assert.False(t, result.Breached)
+	assert.Equal(t, 0, result.Count)
+}
+
+func TestClientCachesResults(t *testing.T) {
+	t.Parallel()
+
+	callCount := 0
+	server := httptest.NewServer(
+		http.HandlerFunc(func(w http.ResponseWriter, _ *http.Request) {
+			callCount++
+			hash := sha1Hash("cached_secret")
+			suffix := hash[5:]
+			w.WriteHeader(http.StatusOK)
+			fmt.Fprintf(w, "%s:42\n", suffix) //nolint:errcheck
+		}),
+	)
+	defer server.Close()
+
+	client := NewClient()
+	client.baseURL = server.URL + "/range/"
+
+	result1, err := client.Check(
+		context.Background(), "cached_secret",
+	)
+	require.NoError(t, err)
+	assert.True(t, result1.Breached)
+
+	result2, err := client.Check(
+		context.Background(), "cached_secret",
+	)
+	require.NoError(t, err)
+	assert.True(t, result2.Breached)
+	assert.Equal(t, 42, result2.Count)
+	assert.Equal(t, 1, callCount)
+}
+
+func TestClientHandlesServerError(t *testing.T) {
+	t.Parallel()
+
+	server := httptest.NewServer(
+		http.HandlerFunc(func(w http.ResponseWriter, _ *http.Requ
```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The commit `294169a2` introduces a new file, `client_test.go`, which contains multiple test functions for the `hibp` package's `Client`. These tests cover various scenarios including hashing passwords, checking if secrets have been breached, caching results, handling server errors, and retrying on rate limits. The tests use an in-memory HTTP server (`httptest`) to simulate API responses.

**Why it was Likely Changed:**
This change was likely made to ensure the `hibp` client is robust and behaves correctly under different conditions. By adding comprehensive test cases, developers can verify that the client handles breaches, retries on rate limits, context cancellation, and error handling properly.

**Impact on Behavior:**
The addition of these tests will help maintain the reliability of the `hibp` client by ensuring it accurately identifies breached secrets, caches results effectively, and gracefully handles errors and rate limits. This improves overall security scanning functionality.

**Risks or Concerns:**
While the tests are thorough, there is a risk that they might not cover all edge cases. Additionally, relying heavily on in-memory servers for testing can sometimes lead to subtle issues if the test environment differs from the production environment. Ensuring consistent behavior across different setups should be a priority.

Overall, this change significantly enhances the quality and reliability of the `hibp` client through robust testing.

---

*Generated by CodeWorm on 2026-02-22 21:09*
