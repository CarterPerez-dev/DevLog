# Session

**Type:** Code Evolution
**Repository:** stripe-referral
**File:** src/stripe_referral/database/Session.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: bfb52633
Message: feat: Done
Author: CarterPerez-dev
File: src/stripe_referral/database/Session.py
Change type: new file

Diff:
@@ -0,0 +1,70 @@
+"""
+â’¸AngelaMos | 2025 | CertGames.com
+SQLAlchemy session factory and context manager
+"""
+
+from collections.abc import Generator
+from contextlib import contextmanager
+
+from sqlalchemy import Engine, create_engine
+from sqlalchemy.orm import Session, sessionmaker
+
+from ..config.constants import (
+    DATABASE_CONNECTION_MAX_OVERFLOW,
+    DATABASE_CONNECTION_POOL_SIZE,
+    DATABASE_CONNECTION_TIMEOUT_SECONDS,
+)
+from ..config.enums import Environment
+from ..config.settings import settings
+
+
+engine: Engine | None
+SessionLocal: sessionmaker[Session] | None
+
+if settings.database_url:
+    engine = create_engine(
+        settings.database_url,
+        pool_pre_ping = True,
+        pool_size = DATABASE_CONNECTION_POOL_SIZE,
+        max_overflow = DATABASE_CONNECTION_MAX_OVERFLOW,
+        pool_timeout = DATABASE_CONNECTION_TIMEOUT_SECONDS,
+        echo = settings.environment == Environment.DEVELOPMENT,
+    )
+
+    SessionLocal = sessionmaker(
+        autocommit = False,
+        autoflush = False,
+        bind = engine,
+    )
+else:
+    engine = None
+    SessionLocal = None
+
+
+@contextmanager
+def get_db() -> Generator[Session, None, None]:
+    """
+    Context manager for database sessions
+    """
+    if SessionLocal is None:
+        raise RuntimeError(
+            "Database not configured. Set DATABASE_URL environment variable."
+        )
+
+    db = SessionLocal()
+    try:
+        yield db
+    finally:
+        db.close()
+
+
+def get_db_session() -> Session:
+    """
+    Get a new database session (for dependency injection)
+    """
+    if SessionLocal is None:
+        raise RuntimeError(
+            "Database not configured. Set DATABASE_URL environment variable."
+        )
+
+    return SessionLocal()

```

---

## Code Evolution

### Change Analysis

**What was Changed:**
A new file `Session.py` was added to the repository, introducing a SQLAlchemy session factory and context manager for database operations. The file includes:
- A global `engine` and `SessionLocal` variable.
- Configuration of the engine using environment-specific settings.
- A context manager `get_db()` that provides a managed database session.
- A function `get_db_session()` to retrieve a new session.

**Why it was Likely Changed:**
This change likely aims to centralize database connection management, ensuring proper handling and closing of sessions. By using a context manager, the code ensures resources are properly released after use, which is crucial for maintaining application performance and preventing resource leaks.

**Impact on Behavior:**
The introduction of `get_db()` as a context manager simplifies database interaction by automatically managing session creation and cleanup. This makes the code more robust and easier to maintain. The function `get_db_session()` provides a straightforward way to obtain a new session for dependency injection, enhancing testability and modularity.

**Risks or Concerns:**
- **Configuration Dependency:** The code relies on the `DATABASE_URL` environment variable being set. If this is not configured, the application will fail.
- **Global State:** Using global variables (`engine`, `SessionLocal`) might lead to issues if multiple parts of the application interact with the database simultaneously without proper synchronization.

Overall, this change improves the manageability and reliability of database operations in the application.

---

*Generated by CodeWorm on 2026-02-23 02:02*
