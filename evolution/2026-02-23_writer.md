# writer

**Type:** Code Evolution
**Repository:** angela
**File:** internal/requirements/writer.go
**Language:** go
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```go
Commit: ea4cc501
Message: Create canonical module source location - release v1.0.0
Author: CarterPerez-dev
File: internal/requirements/writer.go
Change type: new file

Diff:
@@ -0,0 +1,80 @@
+// ©AngelaMos | 2026
+// writer.go
+
+package requirements
+
+import (
+	"fmt"
+	"os"
+	"regexp"
+	"strings"
+
+	"github.com/CarterPerez-dev/angela/internal/pypi"
+)
+
+// UpdateFile replaces version specifiers for the given packages in a
+// requirements.txt file, preserving all comments and formatting
+func UpdateFile(path string, updates map[string]string) error {
+	data, err := os.ReadFile(path) //nolint:gosec
+	if err != nil {
+		return fmt.Errorf("read %s: %w", path, err)
+	}
+
+	content := data
+	for pkg, spec := range updates {
+		pattern := buildPattern(pkg)
+		found := false
+		content = pattern.ReplaceAllFunc(
+			content,
+			func(match []byte) []byte {
+				found = true
+				return replaceSpec(pattern, match, spec)
+			},
+		)
+		if !found {
+			return fmt.Errorf(
+				"dependency %q not found in %s", pkg, path,
+			)
+		}
+	}
+
+	tmp := path + ".tmp"
+	if err := os.WriteFile(tmp, content, 0o600); err != nil {
+		return fmt.Errorf("write temp: %w", err)
+	}
+	if err := os.Rename(tmp, path); err != nil {
+		_ = os.Remove(tmp) //nolint:errcheck
+		return fmt.Errorf("rename: %w", err)
+	}
+	return nil
+}
+
+func buildPattern(name string) *regexp.Regexp {
+	normalized := pypi.NormalizeName(name)
+	parts := strings.Split(normalized, "-")
+	for i, p := range parts {
+		parts[i] = regexp.QuoteMeta(p)
+	}
+	namePattern := strings.Join(parts, `[-_.]?`)
+
+	return regexp.MustCompile(
+		`(?im)^(` + namePattern + `)` +
+			`(\[[^\]]*\])?` +
+			`(\s*[><=!~][^\n;#]*)`,
+	)
+}
+
+func replaceSpec(
+	re *regexp.Regexp, match []byte, newSpec string,
+) []byte {
+	groups := re.FindSubmatch(match)
+	if len(groups) < 4 {
+		return match
+	}
+
+	var b []byte
+	b = append(b, groups[1]...)
+	b = append(b, groups[2]...)
+	b = append(b, []byte(newSpec)...)
+	return b
+}

```

---

## Code Evolution

### Change Analysis for `internal/requirements/writer.go`

**What was Changed:**
The commit introduces a new file, `writer.go`, which contains the implementation of the `UpdateFile` function and related helper functions (`buildPattern` and `replaceSpec`). The `UpdateFile` function reads a requirements.txt file, updates version specifiers for specified packages while preserving comments and formatting, and then writes the updated content back to the original file.

**Why it was Likely Changed:**
This change likely aims to provide functionality for updating package versions in a requirements.txt file without altering other parts of the file. It addresses common use cases where developers need to update dependencies efficiently.

**Impact on Behavior:**
The `UpdateFile` function allows for selective updates to version specifiers within a requirements.txt file, ensuring that comments and formatting are preserved. This can significantly streamline dependency management in projects using pip or similar tools.

**Risks or Concerns:**
- **Security**: The use of `os.ReadFile` without additional security checks (e.g., validating the file path) could pose risks if the function is used improperly.
- **Error Handling**: While error handling is present, it might be improved by adding more specific error messages and logging mechanisms.
- **Regexp Complexity**: The regular expression in `buildPattern` is complex and may not cover all edge cases, potentially leading to incorrect updates.

Overall, this change enhances the project's ability to manage dependencies efficiently while maintaining file integrity.

---

*Generated by CodeWorm on 2026-02-23 14:33*
