# writer

**Type:** Code Evolution
**Repository:** angela
**File:** internal/pyproject/writer.go
**Language:** go
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```go
Commit: ea4cc501
Message: Create canonical module source location - release v1.0.0
Author: CarterPerez-dev
File: internal/pyproject/writer.go
Change type: new file

Diff:
@@ -0,0 +1,141 @@
+// ©AngelaMos | 2026
+// writer.go
+
+package pyproject
+
+import (
+	"fmt"
+	"os"
+	"regexp"
+	"strings"
+
+	"github.com/CarterPerez-dev/angela/internal/pypi"
+	toml "github.com/pelletier/go-toml/v2"
+)
+
+// Updater performs surgical edits on raw pyproject.toml bytes, preserving
+// all comments, whitespace, and key ordering
+type Updater struct {
+	content []byte
+}
+
+// NewUpdater wraps raw file content after validating it as syntactically
+// correct TOML
+func NewUpdater(content []byte) (*Updater, error) {
+	var probe map[string]any
+	if err := toml.Unmarshal(content, &probe); err != nil {
+		return nil, fmt.Errorf("invalid TOML: %w", err)
+	}
+	return &Updater{content: content}, nil
+}
+
+// UpdateDependency replaces the version specifier for a single dependency
+// while preserving quotes, extras, markers, and surrounding formatting.
+// Tries double-quote patterns first, then single-quote.
+func (u *Updater) UpdateDependency(pkg, newSpec string) error {
+	for _, q := range []byte{'"', '\''} {
+		pattern := buildDepPattern(pkg, q)
+		found := false
+		u.content = pattern.ReplaceAllFunc(
+			u.content,
+			func(match []byte) []byte {
+				found = true
+				return replaceSpec(pattern, match, newSpec, q)
+			},
+		)
+		if found {
+			var probe map[string]any
+			if err := toml.Unmarshal(u.content, &probe); err != nil {
+				return fmt.Errorf(
+					"update produced invalid TOML: %w", err,
+				)
+			}
+			return nil
+		}
+	}
+	return fmt.Errorf("dependency %q not found", pkg)
+}
+
+// Bytes returns the current file content
+func (u *Updater) Bytes() []byte {
+	return u.content
+}
+
+// WriteFile atomically writes the updated content to disk
+func (u *Updater) WriteFile(path string) error {
+	tmp := path + ".tmp"
+	if err := os.WriteFile(tmp, u.content, 0o600); err != nil {
+		return fmt.Errorf("write temp: %w", err)
+	}
+	if err := os.Rename(tmp, path); err != nil {
+		_ = os.Remove(tmp) //nolint:errcheck
+		return fmt.Errorf("rename: %w", err)
+	}
+	return nil
+}
+
+func buildDepPattern(name string, quote byte) *regexp.Regexp {
+	normalized := pypi.NormalizeName(name)
+	parts := strings.Split(normalized, "-")
+	for i, p := range parts {
+		parts[i] = regexp.QuoteMeta(p)
+	}
+	namePattern := strings.Join(parts, `[-_.]?`)
+
+	q := string(quote)
+	notQ := `[^` + q + `]`
+
+	return regexp.MustCompile(
+		`(?i)` +
+			q +
+			`(` + namePattern + `)` +
+			`(\[[^\]]*\])?` +
+			`(\s*[><=!~]` + notQ + `*?)` +
+			`(;` + notQ + `*)?` +
+			q,
+	)
+}
+
+func replaceSpec(
+	re *regexp.Regexp, match []byte, newSpec string, quote byte,
+) []byte {
+	groups := re.FindSubmatch(match)
+	if len(groups) < 5 {
+		return match
+	}
+
+	name := groups[1]
+	extras := groups[2]
+	markers := groups[4]
+
+	var b []byte
+	b = append(b, quote)
+	b = append(b, name...)
+	b = appen
```

---

## Code Evolution

### Change Analysis for Commit `ea4cc501`

**What was Changed:**
The commit introduces a new file, `writer.go`, which implements an `Updater` struct to modify the contents of a `pyproject.toml` file while preserving comments and formatting. The key functions include `NewUpdater`, `UpdateDependency`, `Bytes`, `WriteFile`, and `UpdateFile`.

**Why it was Likely Changed:**
This change likely aims to provide a robust mechanism for updating dependency versions in `pyproject.toml` files, ensuring that the integrity of the file is maintained during updates. The use of regular expressions and careful handling of quotes ensures precise modifications.

**Impact on Behavior:**
The introduction of `Updater` allows for atomic updates by first validating the TOML syntax and then making targeted changes to dependency versions. This approach preserves the original formatting, including comments and whitespace, which is crucial for maintaining readability and compliance with project standards.

**Risks or Concerns:**
- **Error Handling:** The function `UpdateDependency` could potentially return an error if no match is found, but it does not handle this case explicitly.
- **Security Risks:** Reading files directly using `os.ReadFile` without proper validation can introduce security risks. Consider using more secure methods to read and write files.
- **Complexity:** The use of regular expressions for dependency updates might be complex and could fail if the TOML syntax changes.

Overall, this change significantly enhances the tool's functionality by providing a reliable way to update dependencies in `pyproject.toml` files.

---

*Generated by CodeWorm on 2026-02-23 14:19*
