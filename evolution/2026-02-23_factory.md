# factory

**Type:** Code Evolution
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/app/factory.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: 7f35fbd8
Message: feat: complete Phase 1 â€” rule-based detection pipeline, API, Docker E2E

Phase 1 delivers end-to-end threat detection from nginx log ingestion
through rule-based scoring to REST API and WebSocket alerts.

- API layer: /threats, /stats, /models/status, /ws/alerts, /health, /ready
- Alert dispatcher with Redis pub/sub + PostgreSQL persistence
- Typer CLI: vigil serve, config, health
- Integration tests (tailer -> pipeline -> DB round-trip)
- Docker E2E verified: dev.compose.yml stack with all services healthy
- Linting clean: ruff, mypy strict (0 issues), pylint 10/10
- 75 tests passing across 8 test modules
Author: CarterPerez-dev
File: PROJECTS/advanced/ai-threat-detection/backend/app/factory.py
Change type: modified

Diff:
@@ -3,34 +3,106 @@
 factory.py
 """
 
+import asyncio
+import logging
 import time
 from collections.abc import AsyncIterator
 from contextlib import asynccontextmanager
+from pathlib import Path
 
 from fastapi import FastAPI
+from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker, create_async_engine
+from sqlmodel import SQLModel
 
 from app.config import settings
+from app.core.alerts.dispatcher import AlertDispatcher
+from app.core.detection.rules import RuleEngine
+from app.core.enrichment.geoip import GeoIPService
+from app.core.ingestion.pipeline import Pipeline
+from app.core.ingestion.tailer import LogTailer
 from app.core.redis_manager import redis_manager
+from app.models import model_metadata as _model_metadata_reg  # noqa: F401
+from app.models import threat_event as _threat_event_reg  # noqa: F401
+
+logger = logging.getLogger(__name__)
 
 
 @asynccontextmanager
 async def lifespan(app: FastAPI) -> AsyncIterator[None]:
     """
-    Manage application startup and shutdown lifecycle
+    Manage application startup and shutdown lifecycle.
     """
     app.state.startup_time = time.monotonic()
     app.state.pipeline_running = False
 
+    engine = create_async_engine(settings.database_url)
+    app.state.db_engine = engine
+    app.state.session_factory = async_sessionmaker(
+        engine,
+        class_=AsyncSession,
+        expire_on_commit=False,
+    )
+
+    async with engine.begin() as conn:
+        await conn.run_sync(SQLModel.metadata.create_all)
+    logger.info("Database tables verified")
+
     await redis_manager.connect()
 
+    geoip = GeoIPService(settings.geoip_db_path)
+
+    redis_client = redis_manager.client
+    assert redis_client is not None
+
+    dispatcher = AlertDispatcher(
+        redis_client=redis_client,
+        session_factory=app.state.session_factory,
+    )
+
+    pipeline = Pipeline(
+        redis_client=redis_client,  # type: ignore[arg-type]
+        rule_engine=RuleEngine(),
+        geoip=geoip,
+        on_result=dispatcher.dispatch,
+        raw_queue_size=settings.raw_queue_size,
+        parsed_queue_size=settings.parsed_queue_size,
+        feature_queue_size=settings.feature_queue_size,
+        alert_queue_size=settings.
```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The `factory.py` file in the `backend/app` directory was modified to enhance the setup and lifecycle management of the AngelusVigil application. New components like database connection, Redis manager, GeoIP service, RuleEngine, Pipeline, and LogTailer were introduced. The `lifespan` context manager now initializes these services and manages their lifecycle.

**Why it was Likely Changed:**
This change likely aims to complete Phase 1 of the project by integrating core functionalities such as database management, real-time alerting, and log processing into a cohesive pipeline. Adding these components ensures that the application can handle threat detection from log ingestion through rule-based scoring to alerts.

**Impact on Behavior:**
The new setup improves the robustness and functionality of the AngelusVigil application by enabling it to manage database connections, process logs in real-time, and dispatch alerts effectively. The `lifespan` context manager ensures that all services are properly initialized and shut down, enhancing reliability.

**Risks or Concerns:**
- **Complexity:** Introducing multiple new components increases the complexity of the application.
- **Dependency Management:** Ensuring proper initialization and shutdown sequences for these dependencies is crucial to avoid runtime issues.
- **Error Handling:** The code now relies on asynchronous operations; thus, thorough error handling should be implemented to manage potential failures.

Overall, this change significantly enhances the project's capabilities while introducing some complexity that needs careful management.

---

*Generated by CodeWorm on 2026-02-23 07:38*
