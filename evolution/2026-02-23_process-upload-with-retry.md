# _process_upload_with_retry

**Type:** Code Evolution
**Repository:** vuemantics
**File:** backend/workers/batch_helpers/_process_upload_with_retry.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: 4d33b24a
Message: feat: dramatiq - bulkupload
Author: CarterPerez-dev
File: backend/workers/batch_helpers/_process_upload_with_retry.py
Change type: new file

Diff:
@@ -0,0 +1,169 @@
+"""
+â’¸AngelaMos | 2026
+_process_upload_with_retry.py
+
+Process single upload with retry logic and progress monitoring
+"""
+
+import asyncio
+import contextlib
+import logging
+
+from models.Upload import Upload, ProcessingStatus
+from models.UploadBatch import UploadBatch
+from services.ai import LocalAIService
+from services.storage_service import storage_service
+
+from ._publish_file_progress import publish_file_progress
+
+
+logger = logging.getLogger(__name__)
+
+
+async def process_upload_with_retry(
+    ai_service: LocalAIService,
+    upload: Upload,
+    batch: UploadBatch,
+) -> bool:
+    """
+    Process a single upload with retry logic
+
+    Args:
+        ai_service: AI service instance
+        upload: Upload to process
+        batch: UploadBatch instance for progress updates
+
+    Returns:
+        True if successful, False if failed after retry
+
+    Design:
+    - Try once, retry once on failure (max 2 attempts)
+    - Failures don't stop batch processing
+    - Upload marked as failed after 2 attempts
+    - Publishes real-time progress by monitoring AI service stages
+    """
+    max_attempts = 2
+
+    for attempt in range(1, max_attempts + 1):
+        try:
+            logger.info(
+                f"Processing upload {upload.id} (attempt {attempt}/{max_attempts})"
+            )
+
+            # Generate thumbnail (only on first attempt)
+            if attempt == 1 and not upload.thumbnail_path:
+                try:
+                    logger.info(f"Generating thumbnail for upload {upload.id}")
+                    await publish_file_progress(batch, upload, status="processing", progress=5)
+                    thumbnail_path = await storage_service.generate_thumbnail(
+                        user_id = upload.user_id,
+                        upload_id = upload.id,
+                        file_type = upload.file_type,
+                        extension = upload.file_path.split('.')[-1],
+                    )
+                    if thumbnail_path:
+                        await upload.update_thumbnail(thumbnail_path)
+                        logger.info(f"Thumbnail generated for upload {upload.id}")
+                    await publish_file_progress(batch, upload, status="processing", progress=10)
+                except Exception as thumb_error:
+                    logger.warning(
+                        f"Thumbnail generation failed for {upload.id}: {thumb_error}"
+                    )
+                    # Continue processing even if thumbnail fails
+
+            # Monitor AI progress with real stages
+            async def monitor_ai_progress() -> None:
+                """Poll upload status and publish real progress from AI service"""
+                last_progress = 10
+                start_time = asyncio.get_e
```

---

## Code Evolution

### Change Analysis

**What was Changed**: A new file `_process_upload_with_retry.py` was added, introducing an asynchronous function `process_upload_with_retry`. This function handles the processing of a single upload with retry logic and real-time progress monitoring.

**Why it was Likely Changed**: The addition is part of a feature (feat) to enhance the robustness of the batch processing system by ensuring that individual uploads can be retried if they fail, while still allowing the batch to continue. This change likely addresses issues where single upload failures could halt entire batches, and now provides better user experience and reliability.

**Impact on Behavior**: The function introduces a maximum of two retries for each upload, which significantly improves resilience against transient errors. It also monitors the AI service's processing stages in real-time and publishes progress updates to the batch, providing transparency into the upload process.

**Risks or Concerns**: While this change enhances reliability, it could introduce complexity due to the asynchronous nature and retry logic. Potential risks include increased latency if retries are frequent, and the need for careful handling of edge cases like user deletion during processing. Additionally, the real-time progress monitoring might impact performance if not optimized properly.

This change is a feature addition aimed at improving the robustness and transparency of upload processing in the system.

---

*Generated by CodeWorm on 2026-02-23 09:55*
