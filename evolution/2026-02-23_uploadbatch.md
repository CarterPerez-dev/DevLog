# UploadBatch

**Type:** Code Evolution
**Repository:** vuemantics
**File:** backend/models/UploadBatch.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: 4d33b24a
Message: feat: dramatiq - bulkupload
Author: CarterPerez-dev
File: backend/models/UploadBatch.py
Change type: modified

Diff:
@@ -3,6 +3,8 @@
 UploadBatch.py
 """
 
+from __future__ import annotations
+
 from typing import Any
 from datetime import datetime
 from uuid import UUID, uuid4
@@ -197,21 +199,14 @@ class UploadBatch(BaseModel):
         if self.id is None:
             raise ValueError("Cannot update status for unsaved batch")
 
-        started_at_update = "started_at" if status == BatchStatus.PROCESSING else "started_at"
-        completed_at_update = "completed_at" if status in (
-            BatchStatus.COMPLETED,
-            BatchStatus.FAILED,
-            BatchStatus.CANCELLED,
-        ) else "completed_at"
-
-        query = f"""
+        query = """
             UPDATE upload_batches
             SET status = $1,
                 error_message = $2,
-                {started_at_update} = COALESCE({started_at_update}, NOW()),
-                {completed_at_update} = CASE WHEN $1 IN ('completed', 'failed', 'cancelled') THEN NOW() ELSE {completed_at_update} END,
+                started_at = COALESCE(started_at, NOW()),
+                completed_at = CASE WHEN $3 IN ('completed', 'failed', 'cancelled') THEN NOW() ELSE completed_at END,
                 updated_at = NOW()
-            WHERE id = $3
+            WHERE id = $4
             RETURNING updated_at, started_at, completed_at
         """
 
@@ -219,6 +214,7 @@ class UploadBatch(BaseModel):
             query,
             status,
             error_message,
+            status,
             self.id
         )
         if row:
@@ -269,6 +265,78 @@ class UploadBatch(BaseModel):
                 self.failed_uploads = row["failed_uploads"]
             self.updated_at = row["updated_at"]
 
+    async def _insert(self) -> None:
+        """
+        Insert new batch record.
+        """
+        query = """
+            INSERT INTO upload_batches (
+                id, user_id, status, total_uploads, processed_uploads,
+                successful_uploads, failed_uploads, error_message,
+                started_at, completed_at
+            )
+            VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
+            RETURNING *
+        """
+
+        record = await database.db.fetchrow(
+            query,
+            self.id,
+            self.user_id,
+            self.status,
+            self.total_uploads,
+            self.processed_uploads,
+            self.successful_uploads,
+            self.failed_uploads,
+            self.error_message,
+            self.started_at,
+            self.completed_at,
+        )
+
+        if record is None:
+            raise RuntimeError("Insert query failed to return a record")
+        for key, value in dict(record).items():
+            setattr(self, key, value)
+
+    async def _update(self) -> None:
+        """
+        Update existing batch record.
+        """
+        query = """
+            UPDATE uplo
```

---

## Code Evolution

### Change Analysis for Commit 4d33b24a

**What was Changed:**
The code added two new methods, `_insert` and `_update`, to handle the insertion and updating of `UploadBatch` records in a database. The existing method `update_status` was modified to use these new methods based on whether the batch is being updated or inserted.

**Why it Was Likely Changed:**
This change likely aims to improve code organization and separation of concerns by abstracting the database operations into dedicated methods. This makes the code more modular, easier to maintain, and potentially reusable for other similar operations.

**Impact on Behavior:**
- The `update_status` method now calls `_insert` or `_update` based on whether the batch is being saved for the first time or updated.
- New fields like `started_at` and `completed_at` are handled more consistently across both insertion and updates.
- The behavior of updating a batch's status, error message, and timestamps is preserved but now uses clearer method names.

**Risks or Concerns:**
- Potential issues if the new methods `_insert` and `_update` have different requirements or constraints not explicitly mentioned in the diff.
- Ensuring that all existing logic for handling `started_at` and `completed_at` remains correct, especially with the removal of conditional updates.
- The risk of introducing bugs due to the refactoring, particularly if the old and new methods are not thoroughly tested.

---

*Generated by CodeWorm on 2026-02-23 10:25*
