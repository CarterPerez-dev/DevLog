# aggregator

**Type:** Code Evolution
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/app/core/features/aggregator.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: 7f35fbd8
Message: feat: complete Phase 1 â€” rule-based detection pipeline, API, Docker E2E

Phase 1 delivers end-to-end threat detection from nginx log ingestion
through rule-based scoring to REST API and WebSocket alerts.

- API layer: /threats, /stats, /models/status, /ws/alerts, /health, /ready
- Alert dispatcher with Redis pub/sub + PostgreSQL persistence
- Typer CLI: vigil serve, config, health
- Integration tests (tailer -> pipeline -> DB round-trip)
- Docker E2E verified: dev.compose.yml stack with all services healthy
- Linting clean: ruff, mypy strict (0 issues), pylint 10/10
- 75 tests passing across 8 test modules
Author: CarterPerez-dev
File: PROJECTS/advanced/ai-threat-detection/backend/app/core/features/aggregator.py
Change type: modified

Diff:
@@ -27,7 +27,7 @@ class WindowAggregator:
     Per-IP sliding window feature aggregator backed by Redis sorted sets.
     """
 
-    def __init__(self, redis_client: aioredis.Redis) -> None:
+    def __init__(self, redis_client: aioredis.Redis[bytes]) -> None:
         self._redis = redis_client
 
     async def record_and_aggregate(
@@ -66,17 +66,11 @@ class WindowAggregator:
 
         pipe.zadd(keys["requests"], {request_id: timestamp})
         pipe.zadd(keys["paths"], {_hash_member(path): timestamp})
-        pipe.zadd(
-            keys["statuses"], {f"{status_code}:{request_id}": timestamp}
-        )
+        pipe.zadd(keys["statuses"], {f"{status_code}:{request_id}": timestamp})
         pipe.zadd(keys["uas"], {_hash_member(user_agent): timestamp})
-        pipe.zadd(
-            keys["sizes"], {f"{response_size}:{request_id}": timestamp}
-        )
+        pipe.zadd(keys["sizes"], {f"{response_size}:{request_id}": timestamp})
         pipe.zadd(keys["methods"], {f"{method}:{request_id}": timestamp})
-        pipe.zadd(
-            keys["depths"], {f"{path_depth}:{request_id}": timestamp}
-        )
+        pipe.zadd(keys["depths"], {f"{path_depth}:{request_id}": timestamp})
 
         for key in keys.values():
             pipe.zremrangebyscore(key, "-inf", trim_boundary)
@@ -90,9 +84,7 @@ class WindowAggregator:
         pipe.zrangebyscore(keys["sizes"], w5m, "+inf")
         pipe.zrangebyscore(keys["methods"], w5m, "+inf")
         pipe.zrangebyscore(keys["depths"], w5m, "+inf")
-        pipe.zrangebyscore(
-            keys["requests"], w10m, "+inf", withscores=True
-        )
+        pipe.zrangebyscore(keys["requests"], w10m, "+inf", withscores=True)
 
         for key in keys.values():
             pipe.expire(key, KEY_TTL)
@@ -135,9 +127,7 @@ def _error_rate(status_members: list[str]) -> float:
     """
     if not status_members:
         return 0.0
-    errors = sum(
-        1 for m in status_members if int(m.split(":")[0]) >= 400
-    )
+    errors = sum(1 for m in status_members if int(m.split(":")[0]) >= 400)
     return errors / len(status_members)
 
 
@@ -160,9 +150,7 @@ def _method_entropy(method_members: list[str]) -> float:
     methods = [m.split(":")[
```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The `WindowAggregator` class in `aggregator.py` was modified to use type hints for the Redis client parameter, and some redundant code blocks were removed. Specifically:
- The `__init__` method now specifies the return type of the Redis client as `aioredis.Redis[bytes]`.
- Redundant lines within the `record_and_aggregate` method were removed, such as comments and unnecessary function calls.

**Why it was Likely Changed:**
These changes likely aim to improve code clarity and maintainability. The addition of type hints enhances readability and helps catch potential issues early during development. Removing redundant code simplifies the logic without changing its behavior.

**Impact on Behavior:**
The behavior remains unchanged since the removed lines were redundant or commented out. The core functionality of aggregating features from Redis sorted sets is preserved.

**Risks or Concerns:**
- **Type Safety:** While type hints improve safety, they should be thoroughly tested to ensure compatibility with the actual Redis client implementation.
- **Code Readability:** Simplifying the code can make it easier to understand and maintain. However, overly aggressive simplification might obscure important logic for future developers.

Overall, these changes are likely part of a broader effort to clean up and modernize the codebase while maintaining its functionality.

---

*Generated by CodeWorm on 2026-02-23 08:06*
