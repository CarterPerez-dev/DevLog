# api

**Type:** Code Evolution
**Repository:** CodeWorm
**File:** dashboard/backend/api.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: ca3ce30d
Message: v1.0.2: add doc type system, Docker infrastructure, and web dashboard

- Add 11 documentation types (function, class, file, security review, TIL, etc.)
  with weighted random selection so the same codebase generates 10x more unique content
- Add Docker Compose for Ollama (GPU passthrough) + Redis + Dashboard + Nginx
- Add FastAPI backend with REST API, WebSocket live events, and Redis pub/sub
- Add React dashboard with stats, live log, commit feed, repo list, and worm viz
- Add next_scheduled_run logging after each cycle completes
- Update repos config and README for v1.0.2
Author: CarterPerez-dev
File: dashboard/backend/api.py
Change type: new file

Diff:
@@ -0,0 +1,255 @@
+"""
+â’¸AngelaMos | 2026
+dashboard/backend/api.py
+"""
+from __future__ import annotations
+
+import os
+import sqlite3
+from pathlib import Path
+
+from fastapi import APIRouter, Query
+
+from dashboard.backend.models import (
+    ActivityDay,
+    LanguageBreakdown,
+    RecentDoc,
+    RepoStatus,
+    StatsResponse,
+)
+
+router = APIRouter()
+
+
+def _get_db_path() -> Path:
+    return Path(os.environ.get("CODEWORM_DB_PATH", "data/codeworm.db"))
+
+
+def _get_conn() -> sqlite3.Connection:
+    conn = sqlite3.connect(_get_db_path())
+    conn.row_factory = sqlite3.Row
+    return conn
+
+
+def _has_column(conn: sqlite3.Connection, table: str, column: str) -> bool:
+    cursor = conn.execute(f"PRAGMA table_info({table})")
+    return column in {row[1] for row in cursor.fetchall()}
+
+
+@router.get("/stats", response_model=StatsResponse)
+async def get_stats() -> StatsResponse:
+    db = _get_db_path()
+    if not db.exists():
+        return StatsResponse()
+
+    with _get_conn() as conn:
+        total = conn.execute(
+            "SELECT COUNT(*) FROM documented_snippets"
+        ).fetchone()[0]
+
+        by_repo = dict(conn.execute(
+            "SELECT source_repo, COUNT(*) FROM documented_snippets "
+            "GROUP BY source_repo"
+        ).fetchall())
+
+        if _has_column(conn, "documented_snippets", "doc_type"):
+            by_doc_type = dict(conn.execute(
+                "SELECT doc_type, COUNT(*) FROM documented_snippets "
+                "GROUP BY doc_type"
+            ).fetchall())
+        else:
+            by_doc_type = {"function_doc": total}
+
+        last_7 = conn.execute(
+            "SELECT COUNT(*) FROM documented_snippets "
+            "WHERE documented_at > datetime('now', '-7 days')"
+        ).fetchone()[0]
+
+        last_30 = conn.execute(
+            "SELECT COUNT(*) FROM documented_snippets "
+            "WHERE documented_at > datetime('now', '-30 days')"
+        ).fetchone()[0]
+
+        today = conn.execute(
+            "SELECT COUNT(*) FROM documented_snippets "
+            "WHERE date(documented_at) = date('now')"
+        ).fetchone()[0]
+
+        lang_rows = conn.execute(
+            "SELECT "
+            "CASE "
+            "  WHEN source_file LIKE '%.py' THEN 'python' "
+           
```

---

## Code Evolution

### Change Analysis for Commit `ca3ce30d`

**What Changed:**
The commit introduces a new file, `api.py`, which is part of the FastAPI backend in the CodeWorm repository. This file contains two API endpoints: `/stats` and `/repos`. The `/stats` endpoint retrieves detailed statistics about documented snippets, including totals, by repository, language, and doc type. The `/repos` endpoint lists repositories configured in `repos.yaml`, along with their last update times.

**Why Changed:**
This change was likely made to enhance the dashboard's functionality by providing more granular insights into the project's documentation status. By exposing these endpoints, developers can easily integrate this data into other tools or dashboards, improving visibility and accountability.

**Impact on Behavior:**
The addition of `/stats` allows for real-time tracking of documentation progress across different languages and repositories. The `/repos` endpoint ensures that repository configurations are dynamically reflected in the backend, making it easier to manage multiple projects.

**Risks or Concerns:**
- **Database Access:** Direct database access via SQL queries could introduce security risks if not properly sanitized.
- **Resource Usage:** Frequent database queries might impact performance, especially with large datasets.
- **Configuration Sensitivity:** Changes in repository configurations should be handled carefully to avoid data inconsistencies.

Overall, this change significantly enhances the dashboard's utility while introducing some potential risks that need to be managed.

---

*Generated by CodeWorm on 2026-02-23 20:44*
