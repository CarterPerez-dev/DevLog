# state

**Type:** Code Evolution
**Repository:** CodeWorm
**File:** codeworm/core/state.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: ca3ce30d
Message: v1.0.2: add doc type system, Docker infrastructure, and web dashboard

- Add 11 documentation types (function, class, file, security review, TIL, etc.)
  with weighted random selection so the same codebase generates 10x more unique content
- Add Docker Compose for Ollama (GPU passthrough) + Redis + Dashboard + Nginx
- Add FastAPI backend with REST API, WebSocket live events, and Redis pub/sub
- Add React dashboard with stats, live log, commit feed, repo list, and worm viz
- Add next_scheduled_run logging after each cycle completes
- Update repos config and README for v1.0.2
Author: CarterPerez-dev
File: codeworm/core/state.py
Change type: modified

Diff:
@@ -8,7 +8,7 @@ import uuid
 from datetime import datetime, timedelta
 from pathlib import Path
 
-from codeworm.models import CodeSnippet, DocumentedSnippet
+from codeworm.models import CodeSnippet, DocType, DocumentedSnippet
 
 
 SCHEMA = """
@@ -21,7 +21,8 @@ CREATE TABLE IF NOT EXISTS documented_snippets (
     code_hash TEXT NOT NULL,
     documented_at TIMESTAMP NOT NULL,
     snippet_path TEXT NOT NULL,
-    git_commit TEXT
+    git_commit TEXT,
+    doc_type TEXT NOT NULL DEFAULT 'function_doc'
 );
 
 CREATE INDEX IF NOT EXISTS idx_code_hash ON documented_snippets(code_hash);
@@ -45,12 +46,33 @@ class StateManager:
 
     def _init_db(self) -> None:
         """
-        Initialize database schema
+        Initialize database schema and run migrations
         """
         with sqlite3.connect(self.db_path) as conn:
             conn.executescript(SCHEMA)
+            self._migrate_add_doc_type(conn)
             conn.commit()
 
+    def _migrate_add_doc_type(self, conn: sqlite3.Connection) -> None:
+        """
+        Add doc_type column if it does not exist
+        """
+        cursor = conn.execute("PRAGMA table_info(documented_snippets)")
+        columns = {row[1] for row in cursor.fetchall()}
+        if "doc_type" not in columns:
+            conn.execute(
+                "ALTER TABLE documented_snippets "
+                "ADD COLUMN doc_type TEXT NOT NULL DEFAULT 'function_doc'"
+            )
+            conn.execute(
+                "CREATE INDEX IF NOT EXISTS idx_dedup "
+                "ON documented_snippets(source_file, function_name, class_name, doc_type)"
+            )
+            conn.execute(
+                "CREATE INDEX IF NOT EXISTS idx_doc_type "
+                "ON documented_snippets(doc_type)"
+            )
+
     def _get_conn(self) -> sqlite3.Connection:
         """
         Get a database connection with row factory
@@ -115,20 +137,21 @@ class StateManager:
     def should_document(
         self,
         snippet: CodeSnippet,
-        redocument_after_days: int = 30,
+        doc_type: DocType = DocType.FUNCTION_DOC,
+        redocument_after_days: int = 90,
     ) -> bool:
         """
-        Determine if a snippet should be documented
-        Returns True if:
-        - Never documented before
-        - Code has c
```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The `state.py` file was modified to include a new `DocType` class and update the database schema to add a `doc_type` column. The `_migrate_add_doc_type` method ensures that this column is added if it doesn't already exist, and relevant indexes are created. The `should_document` and `record_documentation` methods were updated to accept and use `DocType`.

**Why it was Likely Changed:**
This change likely aims to support a more granular and flexible documentation system by allowing different types of documents (e.g., function doc, security review, TIL) for the same codebase. This enhances deduplication logic, ensuring that similar snippets with different documentations are treated distinctly.

**Impact on Behavior:**
- The `should_document` method now considers the `doc_type`, which affects when and how often a snippet is documented.
- The database schema has been updated to support multiple types of documentation, improving data integrity and query efficiency.

**Risks or Concerns:**
- Potential performance impact due to additional index creation.
- Ensuring that existing data is correctly migrated without loss or corruption.
- Complexity in the `should_document` method may introduce bugs if not thoroughly tested.

---

*Generated by CodeWorm on 2026-02-23 21:35*
