# client

**Type:** Code Evolution
**Repository:** angela
**File:** internal/pypi/client.go
**Language:** go
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```go
Commit: ea4cc501
Message: Create canonical module source location - release v1.0.0
Author: CarterPerez-dev
File: internal/pypi/client.go
Change type: new file

Diff:
@@ -0,0 +1,226 @@
+// Â©AngelaMos | 2026
+// client.go
+
+package pypi
+
+import (
+	"context"
+	"encoding/json"
+	"fmt"
+	"net/http"
+	"regexp"
+	"strings"
+	"sync"
+	"time"
+
+	"golang.org/x/sync/errgroup"
+)
+
+// PyPI client configuration defaults.
+const (
+	DefaultMaxWorkers = 10
+	DefaultTimeout    = 30 * time.Second
+	DefaultUserAgent  = "angela/0.1.0 (https://github.com/CarterPerez-dev/angela)"
+
+	simpleAPIBase   = "https://pypi.org/simple/"
+	simpleAPIAccept = "application/vnd.pypi.simple.v1+json"
+
+	maxRetries  = 3
+	baseRetryMs = 500
+)
+
+var nameNormalizeRe = regexp.MustCompile(`[-_.]+`)
+
+// Client queries the PyPI Simple API for package version information
+type Client struct {
+	http       *http.Client
+	cache      *Cache
+	maxWorkers int
+	userAgent  string
+}
+
+type simpleAPIResponse struct {
+	Name     string   `json:"name"`
+	Versions []string `json:"versions"`
+}
+
+// FetchResult holds the outcome of querying a single package
+type FetchResult struct {
+	Name     string
+	Versions []string
+	Err      error
+}
+
+// NewClient creates a PyPI client backed by a file cache at cacheDir
+func NewClient(cacheDir string) (*Client, error) {
+	cache, err := NewCache(cacheDir, DefaultCacheTTL)
+	if err != nil {
+		return nil, fmt.Errorf("init cache: %w", err)
+	}
+
+	return &Client{
+		http: &http.Client{
+			Timeout: DefaultTimeout,
+			Transport: &http.Transport{
+				MaxIdleConnsPerHost: DefaultMaxWorkers,
+				MaxConnsPerHost:     DefaultMaxWorkers,
+				IdleConnTimeout:     90 * time.Second,
+			},
+		},
+		cache:      cache,
+		maxWorkers: DefaultMaxWorkers,
+		userAgent:  DefaultUserAgent,
+	}, nil
+}
+
+// FetchVersions returns all known versions for a single PyPI package
+func (c *Client) FetchVersions(
+	ctx context.Context,
+	name string,
+) ([]string, error) {
+	normalized := NormalizeName(name)
+
+	entry, hit := c.cache.Get(normalized)
+	if hit && c.cache.IsFresh(entry) {
+		return entry.Versions, nil
+	}
+
+	url := simpleAPIBase + normalized + "/"
+	req, err := http.NewRequestWithContext(
+		ctx, http.MethodGet, url, nil,
+	)
+	if err != nil {
+		return nil, fmt.Errorf("build request for %s: %w", name, err)
+	}
+	req.Header.Set("Accept", simpleAPIAccept)
+	req.Header.Set("User-Agent", c.userAgent)
+
+	if entry != nil && entry.ETag != "" {
+		req.Header.Set("If-None-Match", entry.ETag)
+	}
+
+	resp, err := c.doWithRetry(ctx, req)
+	if err != nil {
+		if entry != nil {
+			return entry.Versions, nil
+		}
+		return nil, fmt.Errorf("fetch %s: %w", name, err)
+	}
+	defer func() { _ = resp.Body.Close() }() //nolint:errcheck
+
+	switch resp.StatusCode {
+	case http.StatusNotModified:
+		c.cache.Touch(normalized)
+		return entry.Versions, nil
+
+	case http.StatusNotFound:
+		return nil, fmt.Errorf(
+			"package %q not found on PyPI", name,
+		)
+
+	case http.Stat
```

---

## Code Evolution

### Change Analysis

**What was Changed**: 
The commit introduces a new file `client.go` in the Go package `internal/pypi`, which implements a client for interacting with the PyPI Simple API. The code includes configuration constants, a `Client` struct with methods to fetch package versions and manage caching, as well as utility functions like `NormalizeName`.

**Why it was Likely Changed**: 
This change likely aims to provide a robust and efficient way to query PyPI for package version information while leveraging caching to reduce API load. The introduction of retry logic ensures that transient network issues do not result in failed requests.

**Impact on Behavior**: 
- **Caching**: Fetching the same package multiple times will now use cached data, reducing redundant API calls.
- **Concurrency**: `FetchAllVersions` allows concurrent fetching of multiple packages, improving performance for bulk operations.
- **Error Handling**: Retry logic and proper error handling ensure more reliable interactions with the PyPI API.

**Risks or Concerns**: 
- The use of a fixed number of retries (3) might not be sufficient in all scenarios; consider making this configurable.
- The `doWithRetry` function uses a simple exponential backoff strategy, which could lead to excessive delays if the network issues persist. Consider implementing a more sophisticated retry mechanism.

Overall, this change significantly enhances the functionality and reliability of package version querying for the `angela` project.

---

*Generated by CodeWorm on 2026-02-23 14:07*
