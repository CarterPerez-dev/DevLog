# routes

**Type:** Code Evolution
**Repository:** angelamos-operations
**File:** Angela-Wake/server/routes.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: dae6cf01
Message: add checklist tool
Author: CarterPerez-dev
File: Angela-Wake/server/routes.py
Change type: modified

Diff:
@@ -5,6 +5,7 @@ Angela Wake Word Server - Routes
 import numpy as np
 from fastapi import APIRouter, WebSocket, WebSocketDisconnect
 from openwakeword.model import Model
+from scipy import signal
 
 from .config import (
     DETECTION_THRESHOLD,
@@ -14,6 +15,8 @@ from .config import (
     VAD_THRESHOLD,
 )
 
+TARGET_SAMPLES = 1280
+
 
 router = APIRouter()
 
@@ -63,19 +66,54 @@ async def list_models():
 async def websocket_detect(websocket: WebSocket):
     await websocket.accept()
 
-    m = get_model()
+    model_paths = list(MODELS_DIR.glob("*.tflite")) + list(MODELS_DIR.glob("*.onnx"))
+    if model_paths:
+        m = Model(
+            wakeword_models=[str(p) for p in model_paths],
+            vad_threshold=VAD_THRESHOLD if ENABLE_VAD else None,
+        )
+    else:
+        m = Model(vad_threshold=VAD_THRESHOLD if ENABLE_VAD else None)
+
     model_names = list(m.models.keys())
+    frame_count = 0
 
     try:
         while True:
-            data = await websocket.receive_bytes()
+            msg = await websocket.receive()
+
+            if msg.get('type') == 'websocket.disconnect':
+                break
+
+            if 'text' in msg:
+                if msg['text'] == 'reset':
+                    m.reset()
+                    print("[DEBUG] Model reset")
+                continue
+
+            if 'bytes' not in msg:
+                continue
+
+            data = msg['bytes']
+            audio = np.frombuffer(data, dtype=np.int16)
+            frame_count += 1
+
+            orig_len = len(audio)
+            orig_amp = np.max(np.abs(audio))
 
-            audio = np.frombuffer(data, dtype = np.int16)
+            if len(audio) != TARGET_SAMPLES:
+                ratio = len(audio) // TARGET_SAMPLES
+                if ratio > 1:
+                    audio = audio[::ratio][:TARGET_SAMPLES]
+                else:
+                    audio = signal.resample_poly(audio, TARGET_SAMPLES, len(audio)).astype(np.int16)
 
             predictions = m.predict(audio)
 
             for name in model_names:
                 score = predictions.get(name, 0.0)
+                if frame_count % 50 == 0:
+                    print(f"[DEBUG] Frame {frame_count}: orig_len={orig_len}, orig_amp={orig_amp}, {name}={score:.4f}")
                 if score >= DETECTION_THRESHOLD:
                     await websocket.send_json(
                         {

```

---

## Code Evolution

### Change Analysis

**What was Changed:**
The code added support for multiple models and improved handling of WebSocket messages in the `websocket_detect` function. Specifically, a new variable `model_paths` is introduced to list available model files. The function now checks if any models are present before initializing the `Model`. Additionally, it handles WebSocket disconnections and resets the model state on receiving a 'reset' command.

**Why it was Likely Changed:**
This change likely aims to enhance flexibility by allowing multiple models to be used simultaneously. It also improves robustness by handling various types of WebSocket messages more gracefully, such as disconnects and reset commands.

**Impact on Behavior:**
The new logic allows the server to handle different model files dynamically. If no models are available, it initializes with default settings. The addition of `TARGET_SAMPLES` ensures consistent processing of audio data. Debug prints provide insights into the processing flow, which can be useful for debugging and monitoring.

**Risks or Concerns:**
- **Resource Management:** Handling large buffers (`audio`) could lead to memory issues if not managed properly.
- **Performance Impact:** Resampling audio might introduce latency; ensure this is acceptable for real-time applications.
- **Debug Statements:** While helpful, the debug prints should be conditionally enabled to avoid cluttering production logs.

Overall, these changes improve the server's flexibility and robustness while maintaining clear logging for debugging.

---

*Generated by CodeWorm on 2026-02-22 20:00*
