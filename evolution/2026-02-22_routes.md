# routes

**Type:** Code Evolution
**Repository:** angelamos-operations
**File:** Angela-Wake/server/routes.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: 3894239b
Message: angela-3d implementation - in prog open wake
Author: CarterPerez-dev
File: Angela-Wake/server/routes.py
Change type: new file

Diff:
@@ -0,0 +1,106 @@
+"""
+Angela Wake Word Server - Routes
+"""
+
+import numpy as np
+from fastapi import APIRouter, WebSocket, WebSocketDisconnect
+from openwakeword.model import Model
+
+from .config import (
+    DETECTION_THRESHOLD,
+    ENABLE_VAD,
+    FRAME_SAMPLES,
+    MODELS_DIR,
+    VAD_THRESHOLD,
+)
+
+
+router = APIRouter()
+
+model: Model | None = None
+
+
+def get_model() -> Model:
+    global model
+    if model is None:
+        model_paths = list(MODELS_DIR.glob("*.tflite")) + list(MODELS_DIR.glob("*.onnx"))
+
+        if model_paths:
+            model = Model(
+                wakeword_models=[str(p) for p in model_paths],
+                vad_threshold=VAD_THRESHOLD if ENABLE_VAD else None,
+            )
+        else:
+            model = Model(
+                vad_threshold=VAD_THRESHOLD if ENABLE_VAD else None,
+            )
+    return model
+
+
+@router.on_event("startup")
+async def startup():
+    get_model()
+
+
+@router.get("/health")
+async def health():
+    m = get_model()
+    return {
+        "status": "ok",
+        "models": list(m.models.keys()),
+        "threshold": DETECTION_THRESHOLD,
+        "vad_enabled": ENABLE_VAD,
+    }
+
+
+@router.get("/models")
+async def list_models():
+    m = get_model()
+    return {"models": list(m.models.keys())}
+
+
+@router.websocket("/ws")
+async def websocket_detect(websocket: WebSocket):
+    await websocket.accept()
+
+    m = get_model()
+    model_names = list(m.models.keys())
+
+    try:
+        while True:
+            data = await websocket.receive_bytes()
+
+            audio = np.frombuffer(data, dtype = np.int16)
+
+            predictions = m.predict(audio)
+
+            for name in model_names:
+                score = predictions.get(name, 0.0)
+                if score >= DETECTION_THRESHOLD:
+                    await websocket.send_json(
+                        {
+                            "detected": True,
+                            "model": name,
+                            "score": float(score),
+                        }
+                    )
+
+    except WebSocketDisconnect:
+        pass
+    except Exception as e:
+        await websocket.close(code = 1011, reason = str(e))
+
+
+@router.post("/detect")
+async def detect_from_audio(audio_data: bytes):
+    m = get_model()
+
+    audio = np.frombuffer(audio_data, dtype = np.int16)
+    predictions = m.predict(audio)
+
+    detections = []
+    for name, score in predictions.items():
+        if score >= DETECTION_THRESHOLD:
+            detections.append({"model": name, "score": float(score)})
+
+    return {"detections": detections}

```

---

## Code Evolution

### Change Analysis for Commit 3894239b

**What was Changed:**
The commit introduces a new file `routes.py` in the Angela Wake Word Server project, implementing routes for health checks, model listing, WebSocket-based audio detection, and HTTP POST requests to detect wake words from audio data. The code uses FastAPI for routing and interacts with an OpenWakeWord model.

**Why it was Likely Changed:**
This change likely aims to provide a server-side implementation that supports real-time and batch wake word detection functionalities. By integrating FastAPI and the OpenWakeWord library, the developer enables flexible deployment options and enhances the server's capabilities to handle different types of client requests.

**Impact on Behavior:**
- **Health Check:** Added an endpoint `/health` to check the server status.
- **Model Management:** Endpoints for listing available models (`/models`) and checking the health status.
- **Real-Time Detection:** WebSocket route (`/ws`) allows real-time detection of wake words from audio streams.
- **Batch Detection:** HTTP POST method (`/detect`) supports batch processing of audio data.

**Risks or Concerns:**
1. **Global State Management:** The `get_model()` function uses a global variable, which could lead to race conditions if not properly managed in concurrent environments.
2. **Error Handling:** While basic error handling is present, more robust exception management and logging should be considered for production use.
3. **Resource Management:** Proper cleanup of resources (e.g., model instances) should be ensured during server shutdown or WebSocket disconnects.

Overall, this change significantly expands the functionality of the Angela Wake Word Server, making it more versatile and capable of handling various types of client interactions.

---

*Generated by CodeWorm on 2026-02-22 15:15*
