# dispatcher

**Type:** Code Evolution
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/app/core/alerts/dispatcher.py
**Language:** python
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```python
Commit: 7f35fbd8
Message: feat: complete Phase 1 — rule-based detection pipeline, API, Docker E2E

Phase 1 delivers end-to-end threat detection from nginx log ingestion
through rule-based scoring to REST API and WebSocket alerts.

- API layer: /threats, /stats, /models/status, /ws/alerts, /health, /ready
- Alert dispatcher with Redis pub/sub + PostgreSQL persistence
- Typer CLI: vigil serve, config, health
- Integration tests (tailer -> pipeline -> DB round-trip)
- Docker E2E verified: dev.compose.yml stack with all services healthy
- Linting clean: ruff, mypy strict (0 issues), pylint 10/10
- 75 tests passing across 8 test modules
Author: CarterPerez-dev
File: PROJECTS/advanced/ai-threat-detection/backend/app/core/alerts/dispatcher.py
Change type: new file

Diff:
@@ -0,0 +1,73 @@
+"""
+©AngelaMos | 2026
+dispatcher.py
+"""
+
+import logging
+
+import redis.asyncio as aioredis
+from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker
+
+from app.core.alerts import ALERTS_CHANNEL
+from app.core.ingestion.pipeline import ScoredRequest
+from app.schemas.websocket import WebSocketAlert
+from app.services.threat_service import create_threat_event
+
+logger = logging.getLogger(__name__)
+
+
+class AlertDispatcher:
+    """
+    Routes scored threat events to storage, pub/sub, and structured logging.
+
+    MEDIUM+ severity events are persisted to PostgreSQL and published
+    to the Redis alerts channel for WebSocket relay.
+    All events are logged to stdout.
+    """
+
+    def __init__(
+        self,
+        redis_client: aioredis.Redis[str],
+        session_factory: async_sessionmaker[AsyncSession],
+    ) -> None:
+        self._redis = redis_client
+        self._session_factory = session_factory
+
+    async def dispatch(self, scored: ScoredRequest) -> None:
+        """
+        Handle a scored request from the pipeline's dispatch stage.
+        """
+        logger.info(
+            "threat_event severity=%s score=%.2f ip=%s path=%s rules=%s",
+            scored.rule_result.severity,
+            scored.rule_result.threat_score,
+            scored.entry.ip,
+            scored.entry.path,
+            scored.rule_result.matched_rules,
+        )
+
+        if scored.rule_result.severity in ("HIGH", "MEDIUM"):
+            await self._store_event(scored)
+            await self._publish_alert(scored)
+
+    async def _store_event(self, scored: ScoredRequest) -> None:
+        """
+        Persist the scored request as a threat event in PostgreSQL.
+        """
+        async with self._session_factory() as session:
+            await create_threat_event(session, scored)
+            await session.commit()
+
+    async def _publish_alert(self, scored: ScoredRequest) -> None:
+        """
+        Publish a real-time alert to the Redis pub/sub channel.
+        """
+        alert = WebSocketAlert(
+            timestamp=scored.entry.timestamp,
+            source_ip=scored.entry.ip,
+            request_path=scored.entry.path,
+
```

---

## Code Evolution

### Change Analysis for Commit 7f35fbd8

**What was Changed:**
A new file `dispatcher.py` was added to the project, implementing an `AlertDispatcher` class responsible for routing scored threat events from a rule-based detection pipeline to storage and real-time alerts. The class uses Redis for pub/sub notifications and SQLAlchemy for database persistence.

**Why it Was Likely Changed:**
This change likely addresses the need for a robust alerting system that can handle both persistent logging in PostgreSQL and real-time WebSocket notifications. By separating these concerns, the design ensures modularity and ease of maintenance.

**Impact on Behavior:**
The `AlertDispatcher` class processes scored threat events, logging them to stdout, storing relevant data in PostgreSQL, and publishing alerts via Redis. This enhances the system's ability to provide timely and comprehensive threat detection.

**Risks or Concerns:**
- **Dependency Management:** The class relies on external services like Redis and SQLAlchemy, which could introduce dependency issues if not properly configured.
- **Error Handling:** While logging is implemented, more robust error handling should be considered for production environments.
- **Performance:** Publishing JSON data to Redis might impact performance; optimizing this process could improve overall system efficiency.

Overall, the addition of `dispatcher.py` significantly enhances the backend's alerting capabilities while maintaining a clean and modular design.

---

*Generated by CodeWorm on 2026-02-23 07:12*
