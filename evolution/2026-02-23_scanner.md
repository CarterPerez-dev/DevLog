# scanner

**Type:** Code Evolution
**Repository:** docksec
**File:** internal/scanner/scanner.go
**Language:** go
**Lines:** 1-1
**Complexity:** 0.0

---

## Source Code

```go
Commit: 5a7c48c4
Message: Initial release
Author: CarterPerez-dev
File: internal/scanner/scanner.go
Change type: new file

Diff:
@@ -0,0 +1,260 @@
+/*
+AngelaMos | 2025
+scanner.go
+*/
+
+package scanner
+
+import (
+	"context"
+	"fmt"
+	"log/slog"
+	"os"
+	"runtime"
+
+	"github.com/CarterPerez-dev/docksec/internal/analyzer"
+	"github.com/CarterPerez-dev/docksec/internal/config"
+	"github.com/CarterPerez-dev/docksec/internal/docker"
+	"github.com/CarterPerez-dev/docksec/internal/finding"
+	"github.com/CarterPerez-dev/docksec/internal/report"
+	"golang.org/x/sync/errgroup"
+	"golang.org/x/time/rate"
+)
+
+type Scanner struct {
+	cfg      *config.Config
+	client   *docker.Client
+	logger   *slog.Logger
+	limiter  *rate.Limiter
+	reporter report.Reporter
+}
+
+func New(cfg *config.Config) (*Scanner, error) {
+	client, err := docker.NewClient()
+	if err != nil {
+		return nil, fmt.Errorf("creating docker client: %w", err)
+	}
+
+	logger := slog.New(slog.NewTextHandler(os.Stderr, &slog.HandlerOptions{
+		Level: getLogLevel(cfg),
+	}))
+
+	reporter, err := report.NewReporter(cfg.Output, cfg.OutputFile)
+	if err != nil {
+		return nil, fmt.Errorf("creating reporter: %w", err)
+	}
+
+	workers := cfg.Workers
+	if workers <= 0 {
+		workers = runtime.NumCPU() * 4
+	}
+	if workers > config.MaxWorkers {
+		workers = config.MaxWorkers
+	}
+
+	limiter := rate.NewLimiter(
+		rate.Limit(config.RateLimitPerSecond),
+		config.RateLimitBurst,
+	)
+
+	return &Scanner{
+		cfg:      cfg,
+		client:   client,
+		logger:   logger,
+		limiter:  limiter,
+		reporter: reporter,
+	}, nil
+}
+
+func (s *Scanner) Close() error {
+	return s.client.Close()
+}
+
+func (s *Scanner) Run(ctx context.Context) error {
+	if err := s.client.Ping(ctx); err != nil {
+		return fmt.Errorf("docker daemon not accessible: %w", err)
+	}
+
+	s.logger.Info("starting security scan")
+
+	analyzers := s.buildAnalyzers()
+	if len(analyzers) == 0 {
+		return fmt.Errorf("no analyzers configured")
+	}
+
+	findings, err := s.runAnalyzers(ctx, analyzers)
+	if err != nil {
+		return err
+	}
+
+	findings = s.filterFindings(findings)
+
+	if err := s.reporter.Report(findings); err != nil {
+		return fmt.Errorf("generating report: %w", err)
+	}
+
+	return s.checkFailThreshold(findings)
+}
+
+func (s *Scanner) buildAnalyzers() []analyzer.Analyzer {
+	var analyzers []analyzer.Analyzer
+
+	if s.cfg.ShouldScanContainers() {
+		analyzers = append(analyzers, analyzer.NewContainerAnalyzer(s.client))
+	}
+
+	if s.cfg.ShouldScanDaemon() {
+		analyzers = append(analyzers, analyzer.NewDaemonAnalyzer(s.client))
+	}
+
+	if s.cfg.ShouldScanImages() {
+		analyzers = append(analyzers, analyzer.NewImageAnalyzer(s.client))
+	}
+
+	for _, file := range s.cfg.Files {
+		if isDockerfile(file) {
+			analyzers = append(analyzers, analyzer.NewDockerfileAnalyzer(file))
+		} else if isComposeFile(file) {
+			analyzers = append(analyzers, analyzer.NewComposeAnalyzer(file))
+		}
+	}
+
+	return analyzers
+}
+
+func (s *Scanner) runAnalyze
```

---

## Code Evolution

### Change Analysis for `internal/scanner/scanner.go`

**What was Changed:**
The file `scanner.go` introduces a new package that handles the core functionality of the security scanner in the `docksec` project. It defines a `Scanner` struct and its methods, including initialization (`New`), running the scan (`Run`), building analyzers (`buildAnalyzers`), executing them concurrently using goroutines (`runAnalyzers`), filtering findings based on severity and CIS controls (`filterFindings`), and checking if the fail threshold is exceeded (`checkFailThreshold`). Additionally, it sets up error handling and logging.

**Why it was Likely Changed:**
This change likely aims to modularize the security scanning process by separating concerns into distinct methods. The use of goroutines for concurrent execution of analyzers improves performance, while structured error handling and configurable severity filtering enhance flexibility and usability.

**Impact on Behavior:**
The new scanner implementation allows for parallel analysis of Docker containers, images, and daemon configurations. It also provides options to filter findings based on severity levels and specific CIS controls, making the tool more customizable and robust.

**Risks or Concerns:**
- **Resource Management:** The use of goroutines could lead to resource exhaustion if not properly managed.
- **Error Handling:** Ensuring that all errors are appropriately logged and handled is crucial for debugging and maintaining the system's stability.
- **Configuration Sensitivity:** The scanner relies heavily on configuration settings, which must be carefully validated to avoid unexpected behavior.

Overall, this change significantly enhances the security scanning capabilities of `docksec` while introducing a more structured and flexible approach.

---

*Generated by CodeWorm on 2026-02-23 16:37*
