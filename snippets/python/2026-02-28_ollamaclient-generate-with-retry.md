# OllamaClient.generate_with_retry

**Type:** Documentation
**Repository:** CodeWorm
**File:** codeworm/llm/client.py
**Language:** python
**Lines:** 214-245
**Complexity:** 8.0

---

## Source Code

```python
async def generate_with_retry(
        self,
        prompt: str,
        system: str | None = None,
        max_retries: int = 3,
        retry_delay: float = 2.0,
    ) -> GenerationResult:
        """
        Generate with automatic retry on transient failures
        """
        last_error: Exception | None = None

        for attempt in range(max_retries):
            try:
                return await self.generate(prompt, system)

            except OllamaModelError:
                logger.warning("model_oom_detected", attempt = attempt + 1)
                await self._recover_from_oom()
                last_error = OllamaModelError("Model OOM after recovery attempt")

            except OllamaTimeoutError as e:
                last_error = e
                if attempt < max_retries - 1:
                    await asyncio.sleep(retry_delay * (attempt + 1))

            except OllamaConnectionError as e:
                last_error = e
                if attempt < max_retries - 1:
                    await asyncio.sleep(retry_delay * (attempt + 1))

        raise last_error or OllamaError("Generation failed after retries")
```

---

## Documentation

### Documentation for `generate_with_retry` Method

**Purpose and Behavior:**
The `generate_with_retry` method in the `OllamaClient` class attempts to generate text with a model, automatically retrying on transient failures like out-of-memory errors (`OllamaModelError`) or connection issues (`OllamaConnectionError`). It logs warnings for OOM errors and retries after increasing delays. If all retries fail, it rethrows the last error.

**Key Implementation Details:**
- **Async/Await:** The method is asynchronous, using `await` to handle retries.
- **Logging:** Uses a logger to log warnings when encountering an OOM error during recovery attempts.
- **Retry Logic:** Retries up to `max_retries` times with exponential backoff for non-terminal errors. Logs the attempt number and waits before retrying.
- **Exception Handling:** Catches specific model-related exceptions, logs them, and retries or recovers as needed.

**When/Why to Use:**
Use this method when you need robust text generation from a model that might fail due to transient issues like OOM errors. It ensures reliability by automatically handling retries with increasing delays between attempts.

**Patterns/Gotchas:**
- Ensure `max_retries` and `retry_delay` are set appropriately for your use case.
- Be aware of the exponential backoff, which can slow down retry cycles significantly after multiple failures.
- The method assumes that `generate`, `_recover_from_oom`, and logging functions (`logger`) are correctly implemented elsewhere in the codebase.

---

*Generated by CodeWorm on 2026-02-28 11:51*
