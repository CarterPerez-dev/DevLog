# RuleEngine.score_request

**Type:** Documentation
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/app/core/detection/rules.py
**Language:** python
**Lines:** 90-134
**Complexity:** 13.0

---

## Source Code

```python
def score_request(
        self,
        features: dict[str, int | float | bool | str],
        entry: ParsedLogEntry,
    ) -> RuleResult:
        """
        Evaluate all rules against a request and return a composite score.
        """
        matched: list[tuple[str, float]] = []

        uri = entry.path
        if entry.query_string:
            uri = f"{entry.path}?{entry.query_string}"

        for rule in _PATTERN_RULES:
            if rule.pattern.search(uri):
                matched.append((rule.name, rule.score))

        if DOUBLE_ENCODED.search(uri):
            matched.append(("DOUBLE_ENCODING", _DOUBLE_ENCODING_SCORE))

        ua_lower = entry.user_agent.lower()
        if any(sig in ua_lower for sig in SCANNER_USER_AGENTS):
            matched.append(("SCANNER_UA", _SCANNER_UA_SCORE))

        for rule in _THRESHOLD_RULES:
            value = features.get(rule.feature_key, 0)
            if isinstance(value, (int, float)) and value > rule.threshold:
                matched.append((rule.name, rule.score))

        if not matched:
            return RuleResult(threat_score=0.0, severity="LOW")

        scores = sorted([s for _, s in matched], reverse=True)
        threat_score = min(
            scores[0] + _BOOST_PER_ADDITIONAL_RULE * (len(scores) - 1),
            1.0,
        )

        return RuleResult(
            threat_score=threat_score,
            severity=_classify_severity(threat_score),
            matched_rules=[name for name, _ in matched],
            component_scores=dict(matched),
        )
```

---

## Documentation

### Documentation for `RuleEngine.score_request`

**Purpose and Behavior:**
The function `score_request` evaluates a request against multiple security rules, returning a composite threat score and severity level based on the matched rules. It processes features from the request, checks URI patterns, user agent signatures, and threshold-based conditions to determine the overall risk.

**Key Implementation Details:**
- **URI Processing:** The URI is enhanced by appending query strings if present.
- **Pattern Matching:** Uses regular expressions to match predefined patterns in the URI against `_PATTERN_RULES`.
- **Threshold Rules:** Evaluates feature values from `features` dictionary against thresholds defined in `_THRESHOLD_RULES`.
- **Scoring Logic:** Compiles matched rules into a list and calculates a threat score, boosting it for multiple matches.
- **Result Construction:** Returns a structured `RuleResult` object containing the calculated threat score, severity level, matched rule names, and component scores.

**When/Why to Use:**
This function is crucial in security systems where dynamic requests need to be evaluated against various rulesets. It helps in identifying potential threats by systematically assessing different aspects of incoming data.

**Patterns/Gotchas:**
- **Regular Expression Usage:** Ensure that the patterns defined in `_PATTERN_RULES` are comprehensive and up-to-date.
- **Threshold Values:** Properly set thresholds in `_THRESHOLD_RULES` to avoid false positives or negatives.
- **Performance Considerations:** The function's complexity suggests potential performance issues with large numbers of rules. Optimizing these could improve efficiency.

---

*Generated by CodeWorm on 2026-02-18 07:04*
