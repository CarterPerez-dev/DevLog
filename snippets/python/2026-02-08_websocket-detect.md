# websocket_detect

**Repository:** angelamos-operations
**File:** Angela-Wake/server/routes.py
**Language:** python
**Lines:** 66-104
**Complexity:** 8.0

---

## Source Code

```python
async def websocket_detect(websocket: WebSocket):
    await websocket.accept()

    m = get_model()
    model_names = list(m.models.keys())
    frame_count = 0

    try:
        while True:
            data = await websocket.receive_bytes()

            audio = np.frombuffer(data, dtype=np.int16)
            frame_count += 1

            orig_len = len(audio)
            orig_amp = np.max(np.abs(audio))

            if len(audio) != TARGET_SAMPLES:
                audio = signal.resample_poly(audio, TARGET_SAMPLES, len(audio)).astype(np.int16)

            predictions = m.predict(audio)

            for name in model_names:
                score = predictions.get(name, 0.0)
                if frame_count % 50 == 0:
                    print(f"[DEBUG] Frame {frame_count}: orig_len={orig_len}, orig_amp={orig_amp}, {name}={score:.4f}")
                if score >= DETECTION_THRESHOLD:
                    await websocket.send_json(
                        {
                            "detected": True,
                            "model": name,
                            "score": float(score),
                        }
                    )

    except WebSocketDisconnect:
        pass
    except Exception as e:
        await websocket.close(code = 1011, reason = str(e))
```

---

## Documentation

### Documentation for `websocket_detect` Function

**Purpose and Behavior:**
The `websocket_detect` function is an asynchronous handler that processes audio data received via a WebSocket connection. It accepts raw audio bytes, processes them using a model to detect specific sounds, and sends detection results back to the client.

**Key Implementation Details:**
- **Model Prediction:** Uses `get_model().predict(audio)` to predict sound names from input audio.
- **Resampling:** Adjusts audio length to `TARGET_SAMPLES` if necessary using `signal.resample_poly`.
- **Debug Logging:** Prints debug information every 50 frames.
- **Threshold Detection:** Sends JSON messages when detection scores exceed `DETECTION_THRESHOLD`.

**When/Why to Use:**
This function is ideal for real-time sound detection applications, such as voice command recognition or environmental sound monitoring. It ensures timely feedback by immediately sending detected events back to the client.

**Patterns and Gotchas:**
- **Asynchronous Handling:** The use of async/await makes this suitable for handling multiple WebSocket connections concurrently.
- **Resource Management:** Properly handles `WebSocketDisconnect` and unexpected exceptions, ensuring graceful closure.
- **Performance Considerations:** Resampling can be CPU-intensive; consider optimizing or using a more efficient resampling method if performance is an issue.

---

*Generated by CodeWorm on 2026-02-08 11:55*
