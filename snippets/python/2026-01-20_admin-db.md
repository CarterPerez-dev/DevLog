# admin_db

**Repository:** CertGames-Core
**File:** backend/api/admin/qa/conftest.py
**Language:** python
**Lines:** 76-133
**Complexity:** 11.0

---

## Source Code

```python
def admin_db(admin_app):
    """
    Admin-focused database with proper state management like domains tests
    """
    from api.core.database import get_db
    db_instance = get_db()

    admin_collections = [
        'admin_users',
        'admin_sessions',
        'admin_audit_logs',
        'endpoint_metrics',
        'performance_metrics',
        'error_logs',
        'ai_usage_logs',
        'request_logs',
        'subscription_events',
        'subscription_metrics',
        'security_events',
        'rate_limits',
        'ip_blocklist',
        'token_blocklist',
        'active_token_counts',
        'data_retention',
        'user',
        'auditlog',
        'globalratelimit',
        # Daily questions collections
        'dailyQuestions',
        'dailyAnswers',
        'dailyMetrics',
        'daily_questions',
        'daily_answers',
        'daily_metrics'
    ]

    for collection_name in admin_collections:
        if collection_name in db_instance.list_collection_names():
            db_instance[collection_name].drop()

    try:
        if 'token_blocklist' in db_instance.list_collection_names():
            for index in db_instance.token_blocklist.list_indexes():
                if index['name'] != '_id_':
                    db_instance.token_blocklist.drop_index(index['name'])
    except Exception as e:
        print(f"Warning: Could not clean admin indexes: {e}")

    if hasattr(connection._connections.get('default'), '_database'):
        db_conn = connection._connections.get('default')._database
        if hasattr(db_conn, '_collections'):
            db_conn._collections = {}

    yield db_instance

    for collection_name in admin_collections:
        if collection_name in db_instance.list_collection_names():
            db_instance[collection_name].drop()
```

---

## Documentation

### Documentation for `admin_db` Function

**Purpose and Behavior:**
The `admin_db` function is a pytest fixture designed to clean up the database before and after each test run, focusing on admin-related collections. It drops existing collections and indexes, ensuring a pristine state for testing.

**Key Implementation Details:**
1. **Imports:** The function imports necessary modules from `api.core.database`.
2. **Collections List:** A list of admin-focused collections is defined.
3. **Cleanup Logic:** 
   - Drops each collection if it exists.
   - Drops non-`_id_` indexes in the `token_blocklist` collection.
   - Clears out `_collections` attribute to reset database state.

**When/Why to Use:**
This fixture should be used when running tests that require a clean admin database state, ensuring no residual data from previous test runs interferes with current ones. It is particularly useful for integration and end-to-end testing scenarios where admin functionalities are tested extensively.

**Patterns/Gotchas:**
- The function uses `yield` to provide the database instance during the test run, then cleans up afterward.
- Potential gotcha: Ensure that all necessary collections are included in the `admin_collections` list. Omissions can lead to incomplete cleanup.
- The `_collections` attribute reset is a non-standard approach and might not be supported by all MongoDB drivers or versions.

This fixture helps maintain database integrity and consistency across tests, making it essential for robust testing environments.

---

*Generated by CodeWorm on 2026-01-20 03:31*
