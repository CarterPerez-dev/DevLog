# ReferralService.track_referral

**Repository:** stripe-referral
**File:** src/stripe_referral/services/referral_service.py
**Language:** python
**Lines:** 130-186
**Complexity:** 4.0

---

## Source Code

```python
def track_referral(
        db: Session,
        code: str,
        referred_user_id: str,
        transaction_id: str | None = None,
        transaction_amount: float | None = None,
    ) -> TrackReferralResult:
        """
        Track a successful referral conversion
        """
        code_repo = ReferralCodeRepository(db)
        tracking_repo = ReferralTrackingRepository(db)
        program_repo = ReferralProgramRepository(db)

        ReferralService.validate_code(db, code)

        code_obj = code_repo.get_by_code(code)
        if not code_obj:
            raise CodeNotFoundError(
                f"Code '{code}' not found",
                code = code
            )

        if code_obj.user_id == referred_user_id:
            raise SelfReferralError(
                "Cannot use your own referral code",
                user_id = referred_user_id,
            )

        program = program_repo.get_by_id(code_obj.program_id)
        if not program:
            raise ProgramNotFoundError(
                f"Program ID {code_obj.program_id} not found",
                program_id = code_obj.program_id,
            )

        tracking = tracking_repo.create(
            referrer_user_id = code_obj.user_id,
            referred_user_id = referred_user_id,
            code_id = code_obj.id,
            program_id = program.id,
            transaction_id = transaction_id,
            transaction_amount = transaction_amount,
            amount_earned = program.reward_amount,
            currency = program.reward_currency,
        )

        code_repo.increment_uses(code_obj.id)

        return TrackReferralResult(
            tracking_id = tracking.id,
            referrer_user_id = tracking.referrer_user_id,
            referred_user_id = tracking.referred_user_id,
            amount_earned = tracking.amount_earned,
            currency = tracking.currency,
            converted_at = tracking.converted_at.isoformat(),
        )
```

---

## Documentation

### Documentation for `ReferralService.track_referral`

**Purpose and Behavior**
The function `track_referral` is responsible for tracking a successful referral conversion in the system. It validates the referral code, checks if the user is not self-referring, retrieves relevant program details, creates a new tracking record, and updates the usage count of the referral code.

**Key Implementation Details**
- **Dependencies**: The function uses repositories (`ReferralCodeRepository`, `ReferralTrackingRepository`, `ReferralProgramRepository`) to interact with the database.
- **Validation**: It validates the referral code and ensures that the referrer is not self-referring. If any validation fails, it raises appropriate errors.
- **Transaction Handling**: Optional transaction ID and amount are passed for tracking purposes.
- **Result Return**: Returns a `TrackReferralResult` object containing details of the new tracking record.

**When/Why to Use This Code**
Use this function when you need to log a successful referral conversion in your application. It ensures that all necessary checks are performed before recording the event, maintaining data integrity and preventing self-referrals.

**Patterns/Gotchas**
- **Error Handling**: Ensure proper error handling by catching specific exceptions like `CodeNotFoundError` or `SelfReferralError`.
- **Optional Parameters**: The function allows for optional transaction details, which can be useful in tracking financial transactions related to referrals.
- **Repository Pattern**: Utilizes repository pattern for database operations, making the code more maintainable and testable.

---

*Generated by CodeWorm on 2026-01-26 15:19*
