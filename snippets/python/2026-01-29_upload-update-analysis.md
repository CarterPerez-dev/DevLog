# Upload.update_analysis

**Repository:** vuemantics
**File:** backend/models/Upload.py
**Language:** python
**Lines:** 547-621
**Complexity:** 8.0

---

## Source Code

```python
async def update_analysis(
        self,
        description: str,
        embedding: list[float],
        use_local: bool = True,
        description_audit_score: int | None = None,
    ) -> None:
        """
        Update with AI analysis results

        Args:
            description: Text description from vision model
            embedding: Vector embedding (1024-dim bge-m3)
            use_local: If True, save to embedding_local (default)
            description_audit_score: Audit score 0-100 (higher is better)
        """
        if self.id is None:
            raise ValueError("Cannot update analysis for unsaved upload")

        # Handle both nested and flat embedding formats
        if isinstance(embedding, list) and len(embedding) > 0:
            first_elem = embedding[0]
            if isinstance(first_elem, list):  # type: ignore[unreachable]
                # Nested format: [[1.0, 2.0, ...]]
                embedding_list = first_elem  # type: ignore[unreachable]
            elif isinstance(first_elem, int | float):
                # Flat format: [1.0, 2.0, ...]
                embedding_list = embedding
            else:
                raise ValueError(
                    f"Invalid embedding format: {type(embedding)}"
                )
        else:
            raise ValueError(
                f"Invalid embedding format: {type(embedding)}"
            )

        if use_local:
            query = """
                UPDATE uploads
                SET description = $1,
                    embedding_local = $2,
                    processing_status = $3,
                    description_audit_score = $4,
                    updated_at = NOW()
                WHERE id = $5
                RETURNING updated_at
            """
        else:
            query = """
                UPDATE uploads
                SET description = $1,
                    embedding = $2,
                    processing_status = $3,
                    description_audit_score = $4,
                    updated_at = NOW()
                WHERE id = $5
                RETURNING updated_at
            """

        updated_at = await database.db.fetchval(
            query,
            description,
            embedding_list,
            ProcessingStatus.COMPLETED,
            description_audit_score,
            self.id
        )

        if updated_at:
            self.description = description
            self.embedding_local = embedding_list
            self.processing_status = ProcessingStatus.COMPLETED
            self.description_audit_score = description_audit_score
            self.updated_at = updated_at
```

---

## Documentation

### Documentation for `update_analysis` Method

**Purpose and Behavior:**
The `update_analysis` method updates the analysis results of an upload in a database table. It handles both flat and nested embedding formats, ensuring correct data is stored based on the input format.

**Key Implementation Details:**
- The function takes parameters like `description`, `embedding`, `use_local`, and `description_audit_score`.
- It checks if the `id` attribute exists to ensure the upload is saved.
- Depending on the embedding format, it processes the data accordingly.
- It uses an SQL query to update the database table. The query differs based on whether local storage (`use_local`) is used.

**When/Why to Use:**
Use this method when you need to store AI analysis results for a specific upload. Itâ€™s particularly useful in scenarios where embeddings can come in different formats, ensuring flexibility and correctness.

**Patterns/Gotchas:**
- The function handles both flat and nested embedding formats gracefully.
- Ensure the `id` attribute is set before calling this method; otherwise, it will raise an error.
- Be cautious with the SQL query to avoid injection attacks or incorrect data updates. Always validate input parameters thoroughly.

---

*Generated by CodeWorm on 2026-01-29 10:56*
