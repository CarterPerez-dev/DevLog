# StripeConnectAdapter.send_payout

**Repository:** stripe-referral
**File:** src/stripe_referral/adapters/stripe_connect.py
**Language:** python
**Lines:** 36-106
**Complexity:** 8.0

---

## Source Code

```python
def send_payout(
        self,
        user_id: str,
        amount: float,
        currency: str,
        recipient_data: dict[str,
                             Any],
    ) -> PayoutResult:
        """
        Send payout via Stripe Connect transfer
        """
        try:
            connected_account_id = recipient_data.get(
                "stripe_connect_account_id"
            )
            if not connected_account_id:
                return PayoutResult(
                    success = False,
                    error =
                    "Missing stripe_connect_account_id in recipient_data",
                )

            if not connected_account_id.startswith(
                    STRIPE_CONNECT_ACCOUNT_ID_PREFIX):
                return PayoutResult(
                    success = False,
                    error =
                    f"Invalid Stripe account ID format: {connected_account_id}",
                )

            amount_cents = int(amount * 100)

            transfer = stripe.Transfer.create(
                amount = amount_cents,
                currency = currency.lower(),
                destination = connected_account_id,
                metadata = {"user_id": user_id},
            )

            if not transfer.id.startswith(STRIPE_TRANSFER_ID_PREFIX):
                return PayoutResult(
                    success = False,
                    error =
                    f"Unexpected transfer ID format: {transfer.id}",
                )

            return PayoutResult(
                success = True,
                transaction_id = transfer.id,
            )

        except stripe.InvalidRequestError as e:
            return PayoutResult(
                success = False,
                error = f"Invalid request: {str(e)}",
            )
        except stripe.AuthenticationError as e:
            return PayoutResult(
                success = False,
                error = f"Authentication failed: {str(e)}",
            )
        except stripe.StripeError as e:
            return PayoutResult(
                success = False,
                error = f"Stripe error: {str(e)}",
            )
        except Exception as e:
            return PayoutResult(
                success = False,
                error = f"Unexpected error: {str(e)}",
            )
```

---

## Documentation

### Documentation for `send_payout` Method

**Purpose and Behavior:**
The `send_payout` method sends a payout via Stripe Connect transfer, ensuring that the recipient's Stripe account ID is valid and formatted correctly before initiating the transfer. It returns a `PayoutResult` object indicating whether the operation was successful or not.

**Key Implementation Details:**
- **Type Hints:** The function uses type hints to specify input types (`user_id`, `amount`, `currency`, `recipient_data`) and return type (`PayoutResult`).
- **Error Handling:** It handles various exceptions, including `stripe.InvalidRequestError`, `stripe.AuthenticationError`, and generic `stripe.StripeError`.
- **Metadata:** The transfer metadata includes the user ID for tracking purposes.
- **Validation Checks:** The method checks if the `connected_account_id` is present and valid before proceeding with the transfer.

**When/Why to Use This Code:**
Use this code when you need to automate payouts via Stripe Connect. It ensures that transfers are only initiated after thorough validation, reducing the risk of errors or unauthorized transactions.

**Patterns and Gotchas:**
- **Type Safety:** The use of type hints improves code readability and maintainability.
- **Exception Handling:** Comprehensive error handling prevents unexpected failures by providing clear error messages.
- **Stripe API Usage:** Ensure that your Stripe API keys are correctly configured to avoid authentication issues.

---

*Generated by CodeWorm on 2026-01-26 14:31*
