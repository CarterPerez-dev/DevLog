# scrub

**Repository:** Cybersecurity-Projects
**File:** PROJECTS/metadata-scrubber-tool/src/commands/scrub.py
**Language:** python
**Lines:** 36-150
**Complexity:** 10.0

---

## Source Code

```python
def scrub(
    file_path: Path = typer.Argument(
        exists=True,
        file_okay=True,
        dir_okay=True,
        readable=True,
        writable=True,
        resolve_path=True,
        help="The file or directory to process.",
    ),
    recursive: bool = typer.Option(
        False, "--recursive", "-r",
        help="Recursively process files in the specified directory."
    ),
    ext: str = typer.Option(
        None, "--extension", "-ext",
        help="File extension to filter by (e.g., jpg, png)."
    ),
    output_dir: str = typer.Option(
        "./scrubbed", "--output", "-o",
        help="Directory to save processed files."
    ),
    dry_run: bool = typer.Option(
        False, "--dry-run", "-d",
        help="Preview what would be processed without making changes."
    ),
    workers: int = typer.Option(
        min(4, (os.cpu_count() or 1)),
        "--workers", "-w",
        help="Number of concurrent worker threads (default: 4 or CPU count)."
    ),
):
    # fmt: on
    """
    Remove metadata from files.

    Scrubs privacy-sensitive metadata (EXIF, GPS, author info) from images.
    Works with JPEG, PNG, and will support PDF/Office docs in future.

    Examples:

        scrub photo.jpg

        scrub ./photos/ -r -ext jpg --output ./cleaned

        scrub ./folder/ -r -ext png --dry-run

        scrub ./large_batch/ -r -ext jpg --workers 8
    """
    # Validate recursive/extension combo
    if recursive and not ext:
        raise typer.BadParameter(
            "If you provide --recursive or -r, you must also provide --extension or -ext."
        )
    if ext and not recursive:
        raise typer.BadParameter(
            "If you provide --extension or -ext, you must also provide --recursive or -r."
        )

    # Show dry-run banner
    if dry_run:
        console.print(
            "\n[bold yellow]ðŸ” DRY-RUN MODE[/bold yellow] - No files will be modified.\n"
        )

    # Collect files to process
    files = list(get_target_files(file_path, ext)) if recursive else [file_path]

    if not files:
        console.print("[yellow]No files found to process.[/yellow]")
        raise typer.Exit(0)

    # Show worker count for batch operations
    if len(files) > 1:
        console.print(
            f"[dim]Processing {len(files)} files with {workers} workers...[/dim]\n"
        )

    # Initialize processor with worker count
    processor = BatchProcessor(
        output_dir = output_dir,
        dry_run = dry_run,
        max_workers = workers
    )

    # Process with thread-safe progress bar
    with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            BarColumn(),
            MofNCompleteColumn(),
            TaskProgressColumn(),
            TimeElapsedColumn(),
            console = console,
            refresh_per_second = 10,  # Smooth updates for concurrent processing
    ) as progress:
        task_id = progress.add_task(
            "[cyan]Scrubbing metadata...",
            total = len(files),
        )

        def on_file_complete(result):
            """Callback for progress updates from concurrent workers."""
            status = "âœ“" if result.success else "âœ—"
            progress.update(
                task_id,
                description = f"[cyan]{status} {result.filepath.name}",
                advance = 1,
            )

        # Use concurrent batch processing
        processor.process_batch(files, progress_callback = on_file_complete)

    # Display summary
    print_batch_summary(processor.get_summary())
```

---

## Documentation

### Documentation for `scrub` Function

**Purpose and Behavior:**
The `scrub` function is a command-line tool designed to remove metadata from files, particularly useful for privacy-sensitive data like EXIF information in images. It supports recursive processing, file extension filtering, output directory specification, dry-run mode, and parallel execution with progress tracking.

**Key Implementation Details:**
- **Typer Arguments:** The function uses `typer` for command-line argument parsing, allowing flexible input handling.
- **Validation Logic:** Ensures that recursive processing requires an extension filter and vice versa to prevent invalid configurations.
- **Progress Tracking:** Utilizes the `rich` library's `Progress` class for real-time progress updates during file processing.
- **Concurrency:** Employs concurrent batch processing with a specified number of worker threads, enhancing performance on large datasets.

**When/Why to Use:**
Use this code when you need to securely remove metadata from files in bulk, especially for privacy-sensitive data. It is ideal for image processing and can be extended to support other file types like PDFs or Office documents.

**Patterns/Gotchas:**
- **Dependency on `rich` Library:** Ensure the `rich` library is installed (`pip install rich`) as it provides necessary progress bar functionality.
- **Worker Count Limitation:** The default worker count is limited by the number of available CPU cores to prevent overloading the system.
- **Recursive and Extension Dependency:** Always provide both recursive and extension filters together or neither, as they are mutually dependent.

---

*Generated by CodeWorm on 2026-01-22 01:09*
