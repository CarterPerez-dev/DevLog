# get_repos

**Type:** Documentation
**Repository:** CodeWorm
**File:** dashboard/backend/api.py
**Language:** python
**Lines:** 105-145
**Complexity:** 7.0

---

## Source Code

```python
async def get_repos() -> list[RepoStatus]:
    config_dir = Path(os.environ.get("CODEWORM_CONFIG_DIR", "config"))
    repos_path = config_dir / "repos.yaml"

    repos: list[RepoStatus] = []
    if repos_path.exists():
        import yaml

        with repos_path.open() as f:
            data = yaml.safe_load(f) or {}

        db = _get_db_path()
        repo_counts: dict[str, int] = {}
        repo_last: dict[str, str] = {}

        if db.exists():
            with _get_conn() as conn:
                for row in conn.execute(
                    "SELECT source_repo, COUNT(*), MAX(documented_at) "
                    "FROM documented_snippets GROUP BY source_repo"
                ).fetchall():
                    repo_counts[row[0]] = row[1]
                    repo_last[row[0]] = row[2]

        for entry in data.get("repositories", []):
            from datetime import datetime

            name = entry.get("name", "")
            last_str = repo_last.get(name)
            last_dt = datetime.fromisoformat(last_str) if last_str else None

            repos.append(RepoStatus(
                name=name,
                path=str(entry.get("path", "")),
                weight=entry.get("weight", 5),
                enabled=entry.get("enabled", True),
                docs_generated=repo_counts.get(name, 0),
                last_activity=last_dt,
            ))

    return repos
```

---

## Documentation

### Documentation for `get_repos` Function

**Purpose and Behavior:**
The `get_repos` function retrieves repository statuses from a configuration file (`repos.yaml`) and a database, then returns them as a list of `RepoStatus` objects. It checks if the `repos.yaml` exists, loads its contents, and merges this data with repository activity from the database.

**Key Implementation Details:**
- **Configuration Handling:** The function reads the `repos.yaml` file using YAML parsing.
- **Database Interaction:** It queries a SQLite database to get the last documented snippets per source repository.
- **Data Aggregation:** Repository statuses are aggregated by combining configuration data and database results, ensuring each repository has relevant attributes like name, path, weight, enabled status, number of generated documents, and last activity.

**When/Why to Use:**
Use this function when you need a comprehensive view of repositories configured in `repos.yaml` along with their recent activity tracked in the database. It's particularly useful for dashboard or monitoring applications where repository health and documentation generation are critical metrics.

**Patterns/Gotchas:**
- **Type Hints:** The use of type hints (`-> list[RepoStatus]`) ensures clear function signatures.
- **Context Managers:** `_get_conn()` is used to manage database connections properly, preventing resource leaks.
- **Optional Data Handling:** The code gracefully handles missing or empty data from both the configuration file and the database.

---

*Generated by CodeWorm on 2026-02-27 21:33*
