# InsightsRepository.aggregate_by_posting_time

**Type:** Documentation
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/analytics/facets/insights/repository.py
**Language:** python
**Lines:** 397-429
**Complexity:** 3.0

---

## Source Code

```python
async def aggregate_by_posting_time(
        cls,
        session: AsyncSession
    ) -> dict:
        """Aggregate performance by posting day of week"""
        videos = await cls.get_all_videos(session)

        day_stats = defaultdict(
            lambda: {
                "videos": [],
                "total_views": 0,
                "total_engagement": 0,}
        )

        for video in videos:
            day = cls.get_day_of_week(video.date_posted)
            engagement_rate = cls.calculate_engagement_rate(video)

            day_stats[day]["videos"].append(video)
            day_stats[day]["total_views"] += video.views
            day_stats[day]["total_engagement"] += engagement_rate

        # Calculate averages
        result = {}
        for day, stats in day_stats.items():
            count = len(stats["videos"])
            result[day] = {
                "video_count": count,
                "avg_views": stats["total_views"] / count,
                "avg_engagement_rate": stats["total_engagement"] / count,
            }

        return result
```

---

## Documentation

### Documentation for `aggregate_by_posting_time`

**Purpose and Behavior:**
This asynchronous function aggregates video performance metrics by the day of posting. It calculates the total views, engagement rate, and average values per day.

**Key Implementation Details:**
- **Input:** Takes a session object from SQLAlchemy to interact with the database.
- **Output:** Returns a dictionary mapping each weekday to its aggregated statistics including video count, average views, and average engagement rate.
- **Use of `defaultdict`:** Simplifies handling of missing keys by automatically creating dictionaries for each day.

**When/Why to Use:**
This function is useful for analyzing the performance trends of videos posted on different days of the week. It can help in understanding which days are more effective for posting content, aiding in scheduling strategies and content planning.

**Patterns/Gotchas:**
- **Asynchronous Context:** Ensure that `session` is properly managed as an asynchronous session to avoid blocking operations.
- **Type Hints:** The use of type hints (`AsyncSession`, `dict`) makes the function signature clear for other developers, improving code maintainability and readability.

---

*Generated by CodeWorm on 2026-02-27 18:36*
