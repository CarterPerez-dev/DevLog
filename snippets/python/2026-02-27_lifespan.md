# lifespan

**Type:** Documentation
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/app/factory.py
**Language:** python
**Lines:** 31-100
**Complexity:** 3.0

---

## Source Code

```python
async def lifespan(app: FastAPI) -> AsyncIterator[None]:
    """
    Manage application startup and shutdown lifecycle.
    """
    app.state.startup_time = time.monotonic()
    app.state.pipeline_running = False

    engine = create_async_engine(settings.database_url)
    app.state.db_engine = engine
    app.state.session_factory = async_sessionmaker(
        engine,
        class_=AsyncSession,
        expire_on_commit=False,
    )

    async with engine.begin() as conn:
        await conn.run_sync(SQLModel.metadata.create_all)
    logger.info("Database tables verified")

    await redis_manager.connect()

    geoip = GeoIPService(settings.geoip_db_path)

    redis_client = redis_manager.client
    assert redis_client is not None

    dispatcher = AlertDispatcher(
        redis_client=redis_client,
        session_factory=app.state.session_factory,
    )

    pipeline = Pipeline(
        redis_client=redis_client,  # type: ignore[arg-type]
        rule_engine=RuleEngine(),
        geoip=geoip,
        on_result=dispatcher.dispatch,
        raw_queue_size=settings.raw_queue_size,
        parsed_queue_size=settings.parsed_queue_size,
        feature_queue_size=settings.feature_queue_size,
        alert_queue_size=settings.alert_queue_size,
    )
    await pipeline.start()

    tailer = None
    log_dir = Path(settings.nginx_log_path).resolve().parent
    if log_dir.is_dir():
        loop = asyncio.get_running_loop()
        tailer = LogTailer(settings.nginx_log_path, pipeline.raw_queue, loop)
        tailer.start()
    else:
        logger.warning("Log directory %s not found — tailer disabled", log_dir)

    app.state.pipeline = pipeline
    app.state.tailer = tailer
    app.state.geoip = geoip
    app.state.pipeline_running = True

    logger.info("AngelusVigil started — pipeline active")

    yield

    app.state.pipeline_running = False
    if tailer is not None:
        tailer.stop()
    await pipeline.stop()
    geoip.close()
    await redis_manager.disconnect()
    await engine.dispose()

    logger.info("AngelusVigil shut down cleanly")
```

---

## Documentation

### Documentation for `lifespan` Function

**Purpose and Behavior:**
The `lifespan` function manages the startup and shutdown lifecycle of a FastAPI application in an asynchronous context. It initializes database connections, sets up Redis and GeoIP services, starts a pipeline, and handles logging.

**Key Implementation Details:**
- Initializes a database engine and creates all necessary tables.
- Connects to Redis and starts a log tailer for processing Nginx logs.
- Sets up an `AlertDispatcher` and a `Pipeline` with various components like `GeoIPService`, `RuleEngine`, and queue sizes.
- Uses context management and async iterators to ensure resources are properly disposed of during shutdown.

**When/Why to Use:**
Use this function in FastAPI applications that require complex initialization, such as setting up database connections, Redis clients, and log processing. It ensures that all necessary services are started and stopped gracefully, maintaining application integrity.

**Patterns/Gotchas:**
- The use of `async with` for managing database connections is crucial to ensure they are properly closed.
- Ensure that the `pipeline.raw_queue`, `redis_client`, and other dependencies are correctly initialized before starting the pipeline.
- Be cautious with type hints like `# type: ignore[arg-type]` which may indicate potential issues or assumptions in the code.

---

*Generated by CodeWorm on 2026-02-27 17:54*
