# ChallengeService.create_or_update_log

**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/challenge/facets/tracker/service.py
**Language:** python
**Lines:** 181-253
**Complexity:** 5.0

---

## Source Code

```python
async def create_or_update_log(
        session: AsyncSession,
        data: LogCreate,
    ) -> LogResponse:
        """
        Create a log entry or update if exists
        """
        challenge = await ChallengeRepository.get_active(session)
        if not challenge:
            raise ChallengeNotFound()

        if data.log_date < challenge.start_date or data.log_date > challenge.end_date:
            raise ValidationError(
                message = f"Log date must be between {challenge.start_date} and {challenge.end_date}",
                field = "log_date",
            )

        existing = await ChallengeLogRepository.get_by_date(
            session,
            challenge.id,
            data.log_date,
        )

        if existing:
            log = await ChallengeLogRepository.update(
                session,
                existing,
                tiktok = data.tiktok,
                instagram_reels = data.instagram_reels,
                youtube_shorts = data.youtube_shorts,
                twitter = data.twitter,
                reddit = data.reddit,
                linkedin_personal = data.linkedin_personal,
                linkedin_company = data.linkedin_company,
                youtube_full = data.youtube_full,
                medium = data.medium,
                jobs_applied = data.jobs_applied,
            )
        else:
            log = await ChallengeLogRepository.create(
                session,
                challenge_id = challenge.id,
                log_date = data.log_date,
                tiktok = data.tiktok,
                instagram_reels = data.instagram_reels,
                youtube_shorts = data.youtube_shorts,
                twitter = data.twitter,
                reddit = data.reddit,
                linkedin_personal = data.linkedin_personal,
                linkedin_company = data.linkedin_company,
                youtube_full = data.youtube_full,
                medium = data.medium,
                jobs_applied = data.jobs_applied,
            )

        return LogResponse(
            id = log.id,
            challenge_id = log.challenge_id,
            log_date = log.log_date,
            day_number = ChallengeService._calculate_day_number(challenge, log.log_date),
            tiktok = log.tiktok,
            instagram_reels = log.instagram_reels,
            youtube_shorts = log.youtube_shorts,
            twitter = log.twitter,
            reddit = log.reddit,
            linkedin_personal = log.linkedin_personal,
            linkedin_company = log.linkedin_company,
            youtube_full = log.youtube_full,
            medium = log.medium,
            jobs_applied = log.jobs_applied,
            created_at = log.created_at,
            updated_at = log.updated_at,
        )
```

---

## Documentation

### Documentation for `create_or_update_log`

**Purpose and Behavior**
The function `create_or_update_log` in the `ChallengeService` class is designed to either create a new log entry or update an existing one based on provided data. It first checks if there's an active challenge, validates the log date against the challenge's start and end dates, and then either updates or creates a log entry.

**Key Implementation Details**
- **Dependencies**: The function uses `AsyncSession` for database operations and `LogCreate`, `LogResponse` as input and output data models.
- **Validation**: It ensures that the provided `log_date` falls within the challenge's active period, raising a `ValidationError` if it does not.
- **Repository Methods**: Utilizes methods from `ChallengeRepository` to get an active challenge and check for existing log entries. Uses `ChallengeLogRepository` to create or update logs.

**When/Why to Use**
This function is ideal when you need to track user activities (e.g., social media posts, job applications) related to a specific challenge over time. It ensures data integrity by validating the log date and handles both creation and updating seamlessly.

**Patterns/Gotchas**
- The function uses asynchronous operations throughout, making it suitable for I/O-bound tasks.
- Ensure that `LogCreate` and `LogResponse` models are correctly defined as they are crucial for type checking and data handling.
- Be cautious with the `_calculate_day_number` method, which is used to determine the day number based on the log date.

---

*Generated by CodeWorm on 2026-01-23 11:28*
