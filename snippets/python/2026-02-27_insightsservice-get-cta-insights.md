# InsightsService.get_cta_insights

**Type:** Documentation
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/analytics/facets/insights/service.py
**Language:** python
**Lines:** 208-235
**Complexity:** 2.0

---

## Source Code

```python
async def get_cta_insights(
        session: AsyncSession,
        limit: int = 10,
    ) -> CTAInsightsResponse:
        """Get CTA performance analysis"""
        cta_data = await InsightsRepository.aggregate_cta_performance(
            session
        )

        ctas = [
            CTAAnalysis(
                cta = cta,
                video_count = stats["video_count"],
                avg_shares = stats["avg_shares"],
                avg_new_followers = stats["avg_new_followers"],
                avg_engagement_rate = stats["avg_engagement_rate"],
                total_shares = stats["total_shares"],
                total_followers = stats["total_followers"],
            ) for cta, stats in cta_data.items()
        ]

        # Sort by average new followers
        ctas.sort(key = lambda c: c.avg_new_followers, reverse = True)

        return CTAInsightsResponse(
            top_ctas = ctas[: limit],
            total_unique_ctas = len(ctas),
        )
```

---

## Documentation

### Documentation for `get_cta_insights` Function

**Purpose and Behavior:**
The `get_cta_insights` function retrieves CTA (Call-to-Action) performance analysis from a database using an asynchronous session. It aggregates performance metrics, sorts CTAs by average new followers, and returns a response containing the top CTAs and total unique CTAs.

**Key Implementation Details:**
1. **Parameters:** 
   - `session`: An instance of `AsyncSession` for database interaction.
   - `limit`: The number of top CTAs to return (default is 10).
2. **Return Type:** `CTAInsightsResponse`, which contains a list of top CTAs and the total count of unique CTAs.

**When/Why to Use This Code:**
This function should be used when you need to analyze and display the performance of different CTAs based on engagement metrics such as video counts, shares, new followers, and engagement rates. It is particularly useful for generating reports or dashboards that highlight high-performing CTAs.

**Patterns and Gotchas:**
- **Asynchronous Context:** Ensure that `session` is properly managed within an asynchronous context to avoid blocking the event loop.
- **Sorting Logic:** The sorting key uses a lambda function, which can be optimized if performance becomes an issue with large datasets.
- **Type Hints:** Proper use of type hints ensures type safety and improves code readability.

---

*Generated by CodeWorm on 2026-02-27 19:32*
