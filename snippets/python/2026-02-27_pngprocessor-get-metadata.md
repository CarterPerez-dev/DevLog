# PngProcessor.get_metadata

**Type:** Documentation
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/beginner/metadata-scrubber-tool/src/core/png_metadata.py
**Language:** python
**Lines:** 51-113
**Complexity:** 13.0

---

## Source Code

```python
def get_metadata(self, img: Image) -> dict[str, Any]:
        """
        Extract metadata from a PNG image.

        Extracts both EXIF data (if present) and PNG textual chunks (PngInfo).

        Args:
            img: PIL Image object.

        Returns:
            Dict with 'data' (metadata dict), 'tags_to_delete' (EXIF tag IDs),
            and 'text_keys' (PngInfo keys to remove).

        Raises:
            MetadataNotFoundError: If no metadata is found in the image.
        """
        img.load()
        found_metadata = False

        # Extract EXIF data (if present)
        exif = img.getexif()
        if exif:
            found_metadata = True
            # Main IFD
            for tag, value in exif.items():
                tag_name = ExifTags.TAGS.get(tag, f"Tag_{tag}")
                self.tags_to_delete.append(tag)
                self.data[f"EXIF:{tag_name}"] = value

            # GPS IFD
            gps_ifd = exif.get_ifd(ExifTags.IFD.GPSInfo)
            for tag, value in gps_ifd.items():
                tag_name = ExifTags.GPSTAGS.get(tag, f"GPSTag_{tag}")
                self.tags_to_delete.append(tag)
                self.data[f"GPS:{tag_name}"] = value

        # Extract PNG textual metadata (PngInfo chunks)
        if hasattr(img, "info") and img.info:
            for key, value in img.info.items():
                # Skip binary/internal data
                if key in ("icc_profile", "exif", "transparency", "gamma"):
                    continue

                if isinstance(value, str | bytes):
                    found_metadata = True
                    if isinstance(value, bytes):
                        try:
                            value = value.decode("utf-8", errors = "replace")
                        except Exception:
                            value = str(value)

                    self.data[f"PNG:{key}"] = value
                    if isinstance(key, str):  # Only add string keys
                        self.text_keys_to_delete.append(key)

        if not found_metadata:
            raise MetadataNotFoundError("No metadata found in the PNG image.")

        return {
            "data": self.data,
            "tags_to_delete": self.tags_to_delete,
            "text_keys": self.text_keys_to_delete,
        }
```

---

## Documentation

### Documentation for `get_metadata` Method

**Purpose and Behavior:**
The `get_metadata` method extracts both EXIF data and PNG textual chunks (PngInfo) from a given PIL Image object, returning metadata in a structured dictionary format. It handles EXIF tags and GPS information, as well as various PNG-specific text keys.

**Key Implementation Details:**
- The function iterates over EXIF data and PngInfo to collect relevant metadata.
- It decodes binary values to UTF-8 strings for consistency.
- Metadata is stored in a dictionary with specific keys like `EXIF`, `GPS`, and `PNG`.
- Binary keys such as `icc_profile` are skipped to avoid processing internal image data.

**When/Why to Use:**
Use this method when you need to extract metadata from PNG images, especially for EXIF and PngInfo chunks. It is useful in scenarios where you want to scrub or modify image metadata before further processing.

**Patterns and Gotchas:**
- The function uses `img.load()` to ensure that all image data is loaded into memory.
- It handles exceptions during string decoding but may still fail if the binary data cannot be decoded.
- Ensure that the input image object has both EXIF and PngInfo attributes, as these are used for metadata extraction.

---

*Generated by CodeWorm on 2026-02-27 17:26*
