# list_rooms

**Repository:** Cybersecurity-Projects
**File:** PROJECTS/encrypted-p2p-chat/backend/app/api/rooms.py
**Language:** python
**Lines:** 136-200
**Complexity:** 10.0

---

## Source Code

```python
async def list_rooms(
    user_id: str,
    session: AsyncSession = Depends(get_session),
) -> RoomListResponse:
    """
    List all rooms for the specified user
    """
    user = await auth_service.get_user_by_id(session, UUID(user_id))

    if not user:
        raise HTTPException(
            status_code = status.HTTP_404_NOT_FOUND,
            detail = "User not found",
        )

    room_data_list = await surreal_db.get_rooms_for_user(user_id)

    rooms: list[RoomAPIResponse] = []

    for room_data in room_data_list:
        if not room_data:
            continue

        room_id = str(room_data.get("id", ""))
        participants_data = await surreal_db.get_room_participants(room_id)

        participants: list[ParticipantResponse] = []

        for p_data in participants_data:
            p_user_id = p_data.get("user_id")
            if not p_user_id:
                continue

            p_user = await auth_service.get_user_by_id(session, UUID(p_user_id))
            if p_user:
                participants.append(
                    ParticipantResponse(
                        user_id = str(p_user.id),
                        username = p_user.username,
                        display_name = p_user.display_name,
                        role = p_data.get("role", "member"),
                        joined_at = str(p_data.get("joined_at", "")),
                    )
                )

        other_participant = next(
            (p for p in participants if p.user_id != user_id),
            None
        )
        room_name = other_participant.display_name if other_participant else None

        rooms.append(
            RoomAPIResponse(
                id = room_id,
                type = RoomType(room_data.get("room_type", "direct")),
                name = room_name,
                participants = participants,
                unread_count = 0,
                is_encrypted = True,
                created_at = str(room_data.get("created_at", "")),
                updated_at = str(room_data.get("updated_at", "")),
            )
        )

    return RoomListResponse(rooms = rooms)
```

---

## Documentation

### Documentation for `list_rooms` Function

**Purpose and Behavior**
The `list_rooms` function retrieves a list of rooms associated with a specified user from a database. It ensures the user exists, fetches room data, and populates each room's participants before returning a structured response.

**Key Implementation Details**
- **Dependencies**: Uses an asynchronous session (`session`) provided by `Depends(get_session)`.
- **Error Handling**: Raises an HTTP 404 error if the user is not found.
- **Data Fetching**: Retrieves rooms and their participants using `surreal_db` and `auth_service`.
- **Response Structuring**: Constructs a `RoomListResponse` object containing room details, including names, types, and participant information.

**When/Why to Use This Code**
Use this function when you need to list all the chat rooms for a specific user in your application. It ensures that only relevant data is returned by filtering out non-participant users and handling potential missing or invalid data gracefully.

**Patterns and Gotchas**
- **Asynchronous Handling**: The use of `async` functions and context managers (like `Depends`) is crucial for proper asynchronous operation.
- **Error Propagation**: Ensure all async calls handle errors appropriately to maintain the integrity of the response.
- **Performance Considerations**: The nested loops can impact performance with large datasets; consider optimizing if necessary.

---

*Generated by CodeWorm on 2026-01-14 00:22*
