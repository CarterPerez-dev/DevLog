# AuthService.refresh_tokens

**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/auth/services/auth.py
**Language:** python
**Lines:** 113-173
**Complexity:** 6.0

---

## Source Code

```python
async def refresh_tokens(
        session: AsyncSession,
        refresh_token: str,
        device_id: str | None = None,
        device_name: str | None = None,
        ip_address: str | None = None,
    ) -> tuple[TokenResponse, str]:
        """
        Refresh access token using refresh token

        Implements token rotation with replay attack detection

        Returns:
            Tuple of (TokenResponse, new_raw_refresh_token)
        """
        token_hash = hash_token(refresh_token)
        stored_token = await RefreshTokenRepository.get_by_hash(
            session,
            token_hash
        )

        if stored_token is None:
            raise TokenError(message = "Invalid refresh token")

        if stored_token.is_revoked:
            await RefreshTokenRepository.revoke_family(
                session,
                stored_token.family_id
            )
            raise TokenRevokedError()

        if stored_token.is_expired:
            raise TokenError(message = "Refresh token expired")

        user = await UserRepository.get_by_id(
            session,
            stored_token.user_id
        )
        if user is None or not user.is_active:
            raise TokenError(message = "User not found or inactive")

        await RefreshTokenRepository.revoke_token(session, stored_token)

        access_token = create_access_token(user.id, user.token_version)

        raw_refresh, new_hash, expires_at = create_refresh_token(
            user.id, stored_token.family_id
        )

        await RefreshTokenRepository.create_token(
            session,
            user_id = user.id,
            token_hash = new_hash,
            family_id = stored_token.family_id,
            expires_at = expires_at,
            device_id = device_id,
            device_name = device_name,
            ip_address = ip_address,
        )

        return TokenResponse(access_token = access_token), raw_refresh
```

---

## Documentation

### Documentation for `refresh_tokens` Method

**Purpose and Behavior:**
The `refresh_tokens` method in the `AuthService` class is responsible for refreshing access tokens using a provided refresh token. It ensures that the refresh token is valid, not revoked or expired, and associated with an active user. If all checks pass, it generates new tokens and updates the database to reflect the changes.

**Key Implementation Details:**
- **Asynchronous:** The method is asynchronous, making use of `async` and `await` for database operations.
- **Parameters:** It accepts a session object, refresh token, optional device ID, device name, and IP address.
- **Return Value:** Returns a tuple containing the new access token and raw refresh token.

**When/Why to Use:**
Use this method whenever you need to refresh an access token securely. It handles token validation, user authentication, and database updates in a single method, ensuring security and consistency.

**Patterns and Gotchas:**
- **Replay Attack Detection:** The method uses hashing and stored tokens to detect replay attacks.
- **Token Revocation:** If the token is revoked or expired, it revokes related family tokens to prevent unauthorized access.
- **Database Operations:** Ensure that database operations are correctly awaited to avoid potential issues with asynchronous code.

This method provides a robust mechanism for secure token management in web applications.

---

*Generated by CodeWorm on 2026-01-23 01:54*
