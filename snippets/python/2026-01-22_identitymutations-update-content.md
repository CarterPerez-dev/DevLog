# IdentityMutations.update_content_preference

**Repository:** angelamos-operations
**File:** CarterOS-Server/src/core/foundation/repositories/identity_mutations.py
**Language:** python
**Lines:** 754-792
**Complexity:** 10.0

---

## Source Code

```python
async def update_content_preference(
        session: AsyncSession,
        pref_id: UUID,
        data: dict
    ) -> ContentPreference:
        """
        Update content preference - partial update supported
        """
        result = await session.execute(
            select(ContentPreference).where(
                ContentPreference.id == pref_id
            )
        )
        pref = result.scalar_one()

        if "preference_type" in data:
            pref.preference_type = PreferenceType(data["preference_type"])
        if "content_type" in data:
            pref.content_type = data["content_type"]
        if "platform" in data:
            pref.platform = (
                PlatformType(data["platform"])
                if data["platform"] else None
            )
        if "evidence" in data:
            pref.evidence = data["evidence"]
        if "engagement_level" in data:
            pref.engagement_level = (
                EngagementLevel(data["engagement_level"])
                if data["engagement_level"] else None
            )
        if "reason" in data:
            pref.reason = data["reason"]
        if "challenge" in data:
            pref.challenge = data["challenge"]

        await session.flush()
        await session.refresh(pref)
        return pref
```

---

## Documentation

### Documentation for `update_content_preference`

**Purpose and Behavior**
The function `update_content_preference` updates a specific content preference in the database using an asynchronous session. It supports partial updates, allowing only certain fields to be modified based on the provided data dictionary.

**Key Implementation Details**
- **Session Management**: Uses an `AsyncSession` for database operations.
- **Data Handling**: Updates fields like `preference_type`, `content_type`, `platform`, `evidence`, `engagement_level`, and `reason` conditionally based on keys present in the input data dictionary.
- **Type Casting**: Converts string values to appropriate enum types (`PreferenceType`, `PlatformType`, `EngagementLevel`) using type hints.
- **Database Operations**: Uses SQLAlchemy's `select` and ORM methods for querying and updating records.

**When/Why to Use This Code**
Use this function when you need to update specific fields of a content preference without fetching or modifying unrelated data. It is efficient for partial updates, making it suitable in scenarios where only certain attributes are updated frequently.

**Patterns/Gotchas**
- **Partial Updates**: Only the specified keys in `data` will be updated, ensuring minimal database traffic.
- **Type Safety**: Ensures that enum values are correctly cast using type hints, preventing runtime errors.
- **Session Management**: Proper use of `session.flush()` and `session.refresh()` ensures data consistency but requires careful handling to avoid unnecessary transactions.

---

*Generated by CodeWorm on 2026-01-22 21:57*
