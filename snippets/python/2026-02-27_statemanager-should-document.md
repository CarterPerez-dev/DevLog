# StateManager.should_document

**Type:** Documentation
**Repository:** CodeWorm
**File:** codeworm/core/state.py
**Language:** python
**Lines:** 137-180
**Complexity:** 4.0

---

## Source Code

```python
def should_document(
        self,
        snippet: CodeSnippet,
        doc_type: DocType = DocType.FUNCTION_DOC,
        redocument_after_days: int = 90,
    ) -> bool:
        """
        Determine if a snippet should be documented with a given doc_type
        Deduplication is scoped to (entity + doc_type) so the same code
        can have a function_doc, security_review, and TIL without conflict
        """
        code_hash = self.hash_code(snippet.source)
        with self._get_conn() as conn:
            cursor = conn.execute(
                "SELECT 1 FROM documented_snippets "
                "WHERE code_hash = ? AND doc_type = ? LIMIT 1",
                (code_hash,
                 doc_type.value),
            )
            if cursor.fetchone():
                return False

            cursor = conn.execute(
                """
                SELECT documented_at FROM documented_snippets
                WHERE source_file = ? AND function_name = ?
                    AND class_name IS ? AND doc_type = ?
                ORDER BY documented_at DESC LIMIT 1
                """,
                (
                    str(snippet.file_path),
                    snippet.function_name,
                    snippet.class_name,
                    doc_type.value,
                ),
            )
            row = cursor.fetchone()
            if row:
                last_doc = datetime.fromisoformat(row["documented_at"])
                if datetime.now() - last_doc < timedelta(
                        days = redocument_after_days):
                    return False

            return True
```

---

## Documentation

### Documentation for `StateManager.should_document`

**Purpose and Behavior:**
The `should_document` method in the `StateManager` class determines whether a given `CodeSnippet` should be documented based on its type (`doc_type`). It checks if the code snippet has already been documented with the same `doc_type`. If not, it further checks if re-documentation is needed within a specified timeframe.

**Key Implementation Details:**
- **Hashing and Deduplication:** The method uses a hash of the code snippet's source to check for duplicates.
- **Database Query:** It queries a database table (`documented_snippets`) to find existing documentation entries. If an entry exists, it returns `False`.
- **Time-based Redocumentation:** For snippets that have been documented before, it checks if re-documentation is needed based on the last documentation date and the specified `redocument_after_days`.

**When/Why to Use:**
Use this method when you need to decide whether a code snippet should be documented. It ensures that each type of documentation (e.g., function doc, security review) is applied only once per entity, preventing redundancy.

**Patterns and Gotchas:**
- **Hashing:** Ensure the `hash_code` method accurately generates hashes for all possible code snippets.
- **Database Schema:** The database schema should include fields like `code_hash`, `source_file`, `function_name`, `class_name`, and `documented_at`.
- **Time Calculation:** Be mindful of timezone differences when using `datetime.now()` and `timedelta` to calculate the re-documentation period.

---

*Generated by CodeWorm on 2026-02-27 22:47*
