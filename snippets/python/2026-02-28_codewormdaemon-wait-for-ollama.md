# CodeWormDaemon._wait_for_ollama

**Type:** Documentation
**Repository:** CodeWorm
**File:** codeworm/daemon.py
**Language:** python
**Lines:** 193-225
**Complexity:** 6.0

---

## Source Code

```python
async def _wait_for_ollama(self) -> bool:
        """
        Wait for Ollama to become available with exponential backoff
        Returns True when available, False if daemon is shutting down
        """
        client = await self._init_llm()

        while self.running:
            if await client.health_check():
                if self.stats.consecutive_ollama_failures > 0:
                    self.logger.info(
                        "ollama_recovered",
                        after_failures = self.stats.consecutive_ollama_failures,
                    )
                self.stats.record_ollama_recovery()
                return True

            wait_seconds = self.stats.get_ollama_wait_seconds()
            self.stats.record_ollama_failure()

            self.logger.warning(
                "ollama_unavailable_waiting",
                url = self.settings.ollama.base_url,
                retry_in_seconds = wait_seconds,
                consecutive_failures = self.stats.consecutive_ollama_failures,
            )

            for _ in range(wait_seconds):
                if not self.running:
                    return False
                await asyncio.sleep(1)

        return False
```

---

## Documentation

### Documentation for `_wait_for_ollama` Method

**Purpose and Behavior:**
The `_wait_for_ollama` method asynchronously waits for the Ollama service to become available, using exponential backoff. It returns `True` if the service becomes available, or `False` if the daemon is shutting down.

**Key Implementation Details:**
- **Initialization:** The method initializes an LLM client.
- **Health Check Loop:** It enters a loop that checks the health of Ollama and waits for it to become available. If Ollama recovers after a failure, logs recovery details and returns `True`.
- **Exponential Backoff:** On failure, it calculates wait time using statistics, logs warnings, and sleeps for up to the calculated duration.
- **Graceful Shutdown:** The loop respects the daemon's shutdown state by returning `False` if `self.running` is `False`.

**When/Why to Use:**
Use this method in scenarios where your application depends on an external service like Ollama. It ensures robust handling of service unavailability and recovery, making your application more resilient.

**Patterns/Gotchas:**
- **Exponential Backoff:** This pattern helps avoid overwhelming the server with repeated requests.
- **Graceful Shutdown Handling:** The method checks `self.running` periodically to ensure it exits cleanly on shutdown. Misconfigurations could lead to infinite loops if not properly managed.

This method is crucial for maintaining application stability by ensuring that critical services are available before proceeding.

---

*Generated by CodeWorm on 2026-02-28 00:24*
