# Retry.__call__

**Type:** Documentation
**Repository:** Telehook
**File:** src/telehook/middleware/retry.py
**Language:** python
**Lines:** 18-39
**Complexity:** 8.0

---

## Source Code

```python
async def __call__(self, message: Message, next_: SendFunc) -> None:
        last_error: TelegramAPIError | None = None

        for attempt in range(self._max_attempts):
            try:
                await next_(message)
                return
            except TelegramAPIError as e:
                if e.status_code < 500 and e.status_code != 429:
                    raise

                last_error = e

                if attempt < self._max_attempts - 1:
                    if e.retry_after:
                        delay = min(e.retry_after, 60)
                    else:
                        delay = self._initial_backoff * (2**attempt)
                    await asyncio.sleep(delay)

        if last_error:
            raise last_error
```

---

## Documentation

### Documentation for `Retry.__call__`

**Purpose and Behavior:**
The `__call__` method of the `Retry` class is an asynchronous function designed to handle retries in case of API errors, particularly `TelegramAPIError`. It attempts to execute a given function (`next_`) up to a specified number of times (`self._max_attempts`). If an error occurs, it retries after waiting for a calculated delay. The method ensures that transient errors are retried while permanent or rate-limiting errors are re-raised.

**Key Implementation Details:**
- **Error Handling:** Uses `try-except` blocks to catch and handle `TelegramAPIError`. Retries only if the error status code is less than 500 or not a rate limit (429).
- **Exponential Backoff:** Implements an exponential backoff strategy with a minimum delay of 60 seconds for retry-after errors.
- **Delay Calculation:** Uses a base backoff (`self._initial_backoff`) that doubles on each attempt, capped at 60 seconds.

**When/Why to Use:**
This code is useful in scenarios where API calls might fail due to temporary issues like network problems or server overload. It ensures robust handling of transient errors by retrying the operation with increasing delays until it succeeds or reaches the maximum number of attempts.

**Patterns and Gotchas:**
- **Rate Limiting:** Be cautious as rate limiting (429) is not retried, which could lead to repeated failures if the limit is frequently hit.
- **Backoff Calculation:** The backoff strategy uses exponential growth with a cap, which can be adjusted based on specific use cases.

---

*Generated by CodeWorm on 2026-02-28 13:53*
