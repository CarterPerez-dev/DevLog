# Upload.create

**Repository:** vuemantics
**File:** backend/models/Upload.py
**Language:** python
**Lines:** 180-257
**Complexity:** 6.0

---

## Source Code

```python
async def create(
        cls,
        user_id: UUID,
        filename: str,
        file_path: str,
        file_type: str,
        file_size: int,
        mime_type: str,
        metadata: dict[str,
                       Any] | None = None,
        upload_id: UUID | None = None,
        batch_id: UUID | None = None,
    ) -> Upload:
        """
        Create a new upload record.

        Args:
            user_id: Owner's user ID
            filename: Original filename
            file_path: Local storage path
            file_type: 'image' or 'video'
            file_size: Size in bytes
            mime_type: MIME type
            metadata: Optional metadata

        Returns:
            Created Upload instance
        """
        await cls.ensure_table_exists()

        if upload_id:
            query = """
                INSERT INTO uploads (
                    id, user_id, batch_id, filename, file_path, file_type,
                    file_size, mime_type, metadata
                )
                VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
                RETURNING *
            """
            record = await database.db.fetchrow(
                query,
                upload_id,
                user_id,
                batch_id,
                filename,
                file_path,
                file_type,
                file_size,
                mime_type,
                json.dumps(metadata) if metadata is not None else None,
            )
        else:
            query = """
                INSERT INTO uploads (
                    user_id, batch_id, filename, file_path, file_type,
                    file_size, mime_type, metadata
                )
                VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
                RETURNING *
            """
            record = await database.db.fetchrow(
                query,
                user_id,
                batch_id,
                filename,
                file_path,
                file_type,
                file_size,
                mime_type,
                json.dumps(metadata) if metadata is not None else None,
            )

        if record is None:
            raise ValueError("Failed to create upload")
        upload = cls.from_record(record)
        if upload is None:
            raise ValueError("Failed to create upload from record")
        return upload
```

---

## Documentation

### Documentation for `Upload.create`

**Purpose and Behavior**
The `create` method is a class method that asynchronously creates a new upload record in the database. It handles both cases where an `upload_id` is provided (for updates) and when it isn't (for inserts). The method ensures the table exists, constructs an appropriate SQL query based on the presence of `upload_id`, and returns the created `Upload` instance.

**Key Implementation Details**
- **Type Hints**: The function uses type hints for parameters like `user_id` (UUID), `filename` (str), etc., ensuring clear input validation.
- **Database Interaction**: It uses an asynchronous database connection to insert records, handling both insertion and update scenarios.
- **Metadata Handling**: Metadata is stored as a JSON string if provided.

**When/Why to Use This Code**
Use this method when you need to create or update upload records in the database. The method handles both cases seamlessly, making it versatile for different use cases such as initial uploads or resuming interrupted ones.

**Patterns and Gotchas**
- **Class Method**: `@classmethod` is used, allowing the method to be called on the class itself rather than an instance.
- **SQL Injection Prevention**: Parameters are safely passed via placeholders in the SQL query.
- **Error Handling**: The method checks for a non-null record after execution and raises an error if it fails, ensuring robustness.

This code snippet is part of a larger system handling file uploads, providing a clean interface for database interactions.

---

*Generated by CodeWorm on 2026-01-29 09:42*
