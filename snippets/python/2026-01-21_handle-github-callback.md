# handle_github_callback

**Repository:** CertGames-Core
**File:** backend/api/admin/auth/controllers.py
**Language:** python
**Lines:** 129-205
**Complexity:** 16.0

---

## Source Code

```python
def handle_github_callback() -> Response:
    """
    Handle GitHub OAuth callback for admin
    """
    state = request.args.get('state')
    if not state or state != session.get('admin_oauth_state'):
        raise ValidationError("Invalid OAuth state")

    session.pop('admin_oauth_state', None)

    oauth = current_app.extensions.get("oauth")
    if not oauth:
        raise ValidationError("OAuth not configured")

    github = oauth.create_client('github_admin')

    token = github.authorize_access_token()

    if not token:
        raise ValidationError("GitHub authorization failed")

    resp = github.get('user', token = token)
    if resp.status_code != 200:
        raise ValidationError(
            "Failed to retrieve user information from GitHub"
        )

    user_info = resp.json()
    if not isinstance(user_info, dict):
        raise ValidationError(
            "Failed to retrieve user information from GitHub"
        )

    email_resp = github.get('user/emails', token = token)
    if email_resp.status_code != 200:
        raise ValidationError(
            "Failed to retrieve email information from GitHub"
        )

    emails = email_resp.json()

    if not isinstance(emails, list):
        raise ValidationError(
            "Failed to retrieve email information from GitHub"
        )

    email = next(
        (
            e['email'] for e in emails if isinstance(e, dict)
            and e.get('primary') and e.get('verified')
        ),
        None
    )

    if not email:
        raise ValidationError("No verified email found in GitHub account")

    name = user_info.get('name') or user_info.get('login')
    avatar_url = user_info.get('avatar_url')
    oauth_id = str(user_info.get('id'))
    ip_address = request.remote_addr or "unknown"

    result: dict[str,
                 Any] = AdminAuthService.authenticate_with_oauth(
                     email = email,
                     provider = 'github',
                     oauth_id = oauth_id,
                     name = name,
                     avatar_url = avatar_url,
                     ip_address = ip_address
                 )

    auth_json = json.dumps(result)
    encoded_auth = urllib.parse.quote(auth_json)

    frontend_url = os.getenv('ADMIN_URL', 'http://localhost:8080')
    return redirect(f"{frontend_url}/auth/callback#{encoded_auth}")
```

---

## Documentation

### Documentation for `handle_github_callback`

**Purpose and Behavior:**
The function `handle_github_callback` processes a GitHub OAuth callback request, verifies the user's credentials, and authenticates them using an internal service.

**Key Implementation Details:**
- Validates the OAuth state to prevent CSRF attacks.
- Uses Flask extensions to interact with the GitHub OAuth client.
- Retrieves user information and emails from GitHub.
- Checks for a verified primary email before authentication.
- Authenticates the user via `AdminAuthService` and returns a redirect response to the frontend.

**When/Why to Use This Code:**
This function is crucial for integrating GitHub OAuth into your application, ensuring secure and reliable user authentication. It should be used when you need to authenticate users through GitHub in an administrative context.

**Patterns and Gotchas:**
- The use of `session.pop` ensures state management.
- Error handling with `ValidationError` prevents unauthorized access.
- Type hints and explicit type checks enhance code clarity and robustness.
- The function relies on environment variables for frontend URLs, making it flexible but requiring careful configuration.

---

*Generated by CodeWorm on 2026-01-21 12:58*
