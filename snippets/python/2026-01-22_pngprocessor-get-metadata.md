# PngProcessor.get_metadata

**Repository:** Cybersecurity-Projects
**File:** PROJECTS/metadata-scrubber-tool/src/core/png_metadata.py
**Language:** python
**Lines:** 51-113
**Complexity:** 13.0

---

## Source Code

```python
def get_metadata(self, img: Image) -> dict[str, Any]:
        """
        Extract metadata from a PNG image.

        Extracts both EXIF data (if present) and PNG textual chunks (PngInfo).

        Args:
            img: PIL Image object.

        Returns:
            Dict with 'data' (metadata dict), 'tags_to_delete' (EXIF tag IDs),
            and 'text_keys' (PngInfo keys to remove).

        Raises:
            MetadataNotFoundError: If no metadata is found in the image.
        """
        img.load()
        found_metadata = False

        # Extract EXIF data (if present)
        exif = img.getexif()
        if exif:
            found_metadata = True
            # Main IFD
            for tag, value in exif.items():
                tag_name = ExifTags.TAGS.get(tag, f"Tag_{tag}")
                self.tags_to_delete.append(tag)
                self.data[f"EXIF:{tag_name}"] = value

            # GPS IFD
            gps_ifd = exif.get_ifd(ExifTags.IFD.GPSInfo)
            for tag, value in gps_ifd.items():
                tag_name = ExifTags.GPSTAGS.get(tag, f"GPSTag_{tag}")
                self.tags_to_delete.append(tag)
                self.data[f"GPS:{tag_name}"] = value

        # Extract PNG textual metadata (PngInfo chunks)
        if hasattr(img, "info") and img.info:
            for key, value in img.info.items():
                # Skip binary/internal data
                if key in ("icc_profile", "exif", "transparency", "gamma"):
                    continue

                if isinstance(value, (str, bytes)):
                    found_metadata = True
                    if isinstance(value, bytes):
                        try:
                            value = value.decode("utf-8", errors = "replace")
                        except Exception:
                            value = str(value)

                    self.data[f"PNG:{key}"] = value
                    if isinstance(key, str):  # Only add string keys
                        self.text_keys_to_delete.append(key)

        if not found_metadata:
            raise MetadataNotFoundError("No metadata found in the PNG image.")

        return {
            "data": self.data,
            "tags_to_delete": self.tags_to_delete,
            "text_keys": self.text_keys_to_delete,
        }
```

---

## Documentation

### Documentation for `get_metadata` Method

**Purpose and Behavior:**
The `get_metadata` method extracts both EXIF data and PNG textual chunks (PngInfo) from a given PIL Image object. It returns a dictionary containing the extracted metadata, tags to delete, and keys to remove.

**Key Implementation Details:**
- The function iterates over EXIF data and PngInfo chunks separately.
- Metadata is stored in `self.data`, with specific keys prefixed by "EXIF:" or "PNG:".
- Binary values are decoded if possible; otherwise, they are converted to strings.
- Tags from the EXIF GPS IFD are also extracted.
- The method raises a `MetadataNotFoundError` if no metadata is found.

**When/Why to Use:**
Use this function when you need to extract and process metadata from PNG images for purposes such as data scrubbing or analysis. It ensures that both EXIF and PngInfo chunks are thoroughly examined, making it versatile for various image processing tasks.

**Patterns/Gotchas:**
- The method relies on the `PIL` library's `Image` object to access metadata.
- Ensure that the input image has valid EXIF data or PngInfo; otherwise, a `MetadataNotFoundError` will be raised.
- Binary values are handled and converted to strings for consistency.

---

*Generated by CodeWorm on 2026-01-22 02:46*
