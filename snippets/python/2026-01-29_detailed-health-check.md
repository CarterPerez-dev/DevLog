# detailed_health_check

**Repository:** vuemantics
**File:** backend/routers/v1/health.py
**Language:** python
**Lines:** 45-91
**Complexity:** 9.0

---

## Source Code

```python
async def detailed_health_check() -> HealthDetailedResponse:
    """
    Detailed health check including database connectivity

    healthy, degraded, or unhealthy
    """
    db_status = HealthStatus.UNHEALTHY
    redis_status = None

    try:
        await db.fetchval("SELECT 1")
        db_status = HealthStatus.HEALTHY
    except Exception as e:
        logger.error(f"Database health check failed: {e}")
        db_status = HealthStatus.UNHEALTHY

    if settings.redis_url:
        try:
            redis_client = redis.from_url(
                settings.redis_url,
                decode_responses = settings.redis_decode_responses
            )
            await redis_client.ping()
            await redis_client.close()
            redis_status = HealthStatus.HEALTHY
        except Exception as e:
            logger.error(f"Redis health check failed: {e}")
            redis_status = HealthStatus.UNHEALTHY

    services = [db_status,
                redis_status] if redis_status is not None else [db_status]
    healthy_count = sum(1 for s in services if s == HealthStatus.HEALTHY)

    if healthy_count == len(services):
        overall = HealthStatus.HEALTHY
    elif healthy_count > 0:
        overall = HealthStatus.DEGRADED
    else:
        overall = HealthStatus.UNHEALTHY

    return HealthDetailedResponse(
        status = overall,
        environment = settings.environment,
        version = config.APP_VERSION,
        database = db_status,
        redis = redis_status,
    )
```

---

## Documentation

### Purpose and Behavior

The `detailed_health_check` function performs a comprehensive health check for the application, including database and Redis status. It returns a detailed response indicating whether the system is healthy, degraded, or unhealthy based on the statuses of its components.

### Key Implementation Details

- **Database Check**: The function attempts to execute a simple SQL query (`SELECT 1`) to verify database connectivity.
- **Redis Check**: If `settings.redis_url` is provided, it connects to Redis using the specified URL and performs a `ping()` operation.
- **Health Status Calculation**: The overall health status is determined by counting healthy services. If all are healthy, it returns `HEALTHY`; if any service is healthy, it returns `DEGRADED`; otherwise, `UNHEALTHY`.

### When/Why to Use This Code

Use this function in scenarios where you need a detailed health check for your application, especially when monitoring or automated systems require precise status updates. It ensures that both database and Redis services are functioning correctly before declaring the system healthy.

### Patterns and Gotchas

- **Error Handling**: The code uses try-except blocks to handle potential exceptions during database and Redis operations.
- **Resource Management**: `redis_client.close()` is called after use, ensuring resources are properly managed.
- **Health Status Logic**: The logic for determining overall health status can be complex; ensure it aligns with your application's requirements.

---

*Generated by CodeWorm on 2026-01-29 12:13*
