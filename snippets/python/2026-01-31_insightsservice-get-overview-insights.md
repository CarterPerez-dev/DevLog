# InsightsService.get_overview_insights

**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/analytics/facets/insights/service.py
**Language:** python
**Lines:** 43-105
**Complexity:** 11.0

---

## Source Code

```python
async def get_overview_insights(
        session: AsyncSession,
    ) -> OverviewInsightsResponse:
        """Get high-level overview of all metrics"""
        metrics_data = await InsightsRepository.get_overview_metrics(session)
        videos = await InsightsRepository.get_all_videos(session)

        # Calculate average engagement rate
        total_engagement_rate = sum(
            InsightsRepository.calculate_engagement_rate(v) for v in videos
        )
        avg_engagement_rate = total_engagement_rate / len(videos) if videos else 0.0

        # Find top video
        top_video = None
        if videos:
            top_by_views = max(videos, key=lambda v: v.views)
            top_video = VideoPerformance(
                id=str(top_by_views.id),
                rank=top_by_views.rank,
                hook=top_by_views.hook,
                views=top_by_views.views,
                engagement_rate=InsightsRepository.calculate_engagement_rate(top_by_views),
                follower_conversion_rate=InsightsRepository.calculate_follower_conversion_rate(top_by_views),
                avg_watch_time=top_by_views.avg_watch_time,
                watched_full_video_percentage=top_by_views.watched_full_video_percentage,
                date_posted=top_by_views.date_posted.isoformat(),
            )

        # Determine trend (simple: compare first half vs second half of videos)
        trend = "stable"
        if len(videos) >= 4:
            mid_point = len(videos) // 2
            first_half_avg = sum(v.views for v in videos[:mid_point]) / mid_point
            second_half_avg = sum(v.views for v in videos[mid_point:]) / (len(videos) - mid_point)

            if second_half_avg > first_half_avg * 1.1:
                trend = "improving"
            elif second_half_avg < first_half_avg * 0.9:
                trend = "declining"

        metrics = OverviewMetrics(
            total_videos=metrics_data["total_videos"],
            total_views=metrics_data["total_views"],
            total_likes=metrics_data["total_likes"],
            total_comments=metrics_data["total_comments"],
            total_shares=metrics_data["total_shares"],
            total_bookmarks=metrics_data["total_bookmarks"],
            total_new_followers=metrics_data["total_new_followers"],
            avg_engagement_rate=avg_engagement_rate,
            avg_watch_time=metrics_data["avg_watch_time"],
            avg_watch_percentage=metrics_data["avg_watch_percentage"],
            date_range=(
                metrics_data["min_date"].isoformat() if metrics_data["min_date"] else "",
                metrics_data["max_date"].isoformat() if metrics_data["max_date"] else "",
            ),
        )

        return OverviewInsightsResponse(
            metrics=metrics,
            top_video=top_video,
            recent_trend=trend,
        )
```

---

## Documentation

### Documentation for `get_overview_insights`

**Purpose and Behavior:**
The function `get_overview_insights` retrieves high-level analytics metrics and insights from a database session, including total videos, views, likes, comments, shares, new followers, engagement rates, and trends. It calculates average engagement rate, identifies the top-performing video, and determines overall trend based on view counts.

**Key Implementation Details:**
- **Async Operations:** Uses `async` for asynchronous data retrieval.
- **Metrics Calculation:** Computes metrics like total views, likes, comments, etc., from repository methods.
- **Top Video Selection:** Identifies the most viewed video using a lambda function and calculates its engagement rate.
- **Trend Analysis:** Compares view counts between two halves of videos to determine if trends are improving or declining.

**When/Why to Use:**
Use this code when you need a comprehensive overview of your analytics data, including key performance indicators (KPIs) like engagement rates and video performance. It's ideal for generating reports or dashboards that require aggregated insights from multiple metrics.

**Patterns & Gotchas:**
- **Asynchronous Handling:** Ensure the `AsyncSession` is properly managed to avoid blocking.
- **Null Checks:** The code handles cases where no videos are present, avoiding division by zero errors.
- **Performance Considerations:** For large datasets, consider optimizing the trend analysis logic.

---

*Generated by CodeWorm on 2026-01-31 18:14*
