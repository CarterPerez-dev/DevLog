# create_order

**Type:** Documentation
**Repository:** fastapi-rc
**File:** fastapi-rc/examples/04_full_api_example.py
**Language:** python
**Lines:** 194-240
**Complexity:** 4.0

---

## Source Code

```python
async def create_order(
    user_id: str,
    product_ids: list[str],
    user_cache: UserCache,
    product_cache: ProductCache,
    order_cache: OrderCache,
    redis: RedisClient,
):
    """
    Create order with multi-cache coordination

    Pattern: Cache user, products, then order creation
    """
    user = await user_cache.get_or_set(
        identifier = user_id,
        factory = lambda: fetch_user(user_id),
    )

    products: list[Product] = []
    for product_id in product_ids:
        product = await product_cache.get_or_set(
            identifier = product_id,
            factory = lambda pid = product_id: fetch_product(pid),
        )
        products.append(product)

    total = sum(p.price for p in products)

    order = Order(
        id = "order_123",
        user_id = user.id,
        product_ids = product_ids,
        total = total,
        created_at = datetime.now(),
    )

    await order_cache.set(
        identifier = order.id,
        value = order,
        ttl = 300,
    )

    async for key in redis.scan_iter(
            f"ecommerce:v1:orders:user:{user_id}:*"):
        await redis.delete(key)

    return order
```

---

## Documentation

### Documentation for `create_order` Function

**Purpose and Behavior:**
The `create_order` function asynchronously creates an order by fetching user and product data from caches, calculating the total price, and storing the order in a cache with a TTL of 300 seconds. It also cleans up old order-related keys in Redis.

**Key Implementation Details:**
- **Caching:** Uses `get_or_set` to fetch or create user and product objects.
- **Order Creation:** Constructs an `Order` object, setting its attributes based on fetched data.
- **Redis Cleanup:** Iterates over matching keys using a Redis scan command and deletes them.

**When/Why to Use:**
This function is ideal for scenarios where you need to ensure that order creation is efficient by leveraging cached data. It handles both cache coordination and cleanup, making it suitable for high-throughput applications requiring fast order processing and timely expiration of stale data.

**Patterns and Gotchas:**
- **Async Context Management:** The use of `async for` in the Redis cleanup section is a good practice for iterating over keys asynchronously.
- **TTL Handling:** Setting a TTL ensures that cached data does not persist indefinitely, which can help manage server memory usage effectively. However, ensure that the TTL value aligns with your application's requirements to avoid unnecessary cache misses.

This function exemplifies best practices in async programming and cache management for web services.

---

*Generated by CodeWorm on 2026-02-18 07:15*
