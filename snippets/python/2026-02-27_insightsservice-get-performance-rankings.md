# InsightsService.get_performance_rankings

**Type:** Documentation
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/analytics/facets/insights/service.py
**Language:** python
**Lines:** 119-176
**Complexity:** 5.0

---

## Source Code

```python
async def get_performance_rankings(
        session: AsyncSession,
        limit: int = 10,
    ) -> PerformanceRankingsResponse:
        """Get top performing videos by different metrics"""
        videos = await InsightsRepository.get_all_videos(session)

        def to_video_performance(video) -> VideoPerformance:
            return VideoPerformance(
                id = str(video.id),
                rank = video.rank,
                hook = video.hook,
                views = video.views,
                engagement_rate = InsightsRepository.
                calculate_engagement_rate(video),
                follower_conversion_rate = InsightsRepository.
                calculate_follower_conversion_rate(video),
                avg_watch_time = video.avg_watch_time,
                watched_full_video_percentage = video.
                watched_full_video_percentage,
                date_posted = video.date_posted.isoformat(),
            )

        by_views = sorted(
            videos,
            key = lambda v: v.views,
            reverse = True
        )[: limit]
        by_engagement = sorted(
            videos,
            key = lambda v: InsightsRepository.
            calculate_engagement_rate(v),
            reverse = True
        )[: limit]
        by_followers = sorted(
            videos,
            key = lambda v: InsightsRepository.
            calculate_follower_conversion_rate(v),
            reverse = True
        )[: limit]
        by_watch_time = sorted(
            videos,
            key = lambda v: v.avg_watch_time,
            reverse = True
        )[: limit]

        return PerformanceRankingsResponse(
            by_views = [to_video_performance(v) for v in by_views],
            by_engagement_rate = [
                to_video_performance(v) for v in by_engagement
            ],
            by_follower_conversion = [
                to_video_performance(v) for v in by_followers
            ],
            by_watch_time = [
                to_video_performance(v) for v in by_watch_time
            ],
        )
```

---

## Documentation

### Documentation for `get_performance_rankings`

**Purpose and Behavior:**
The function `get_performance_rankings` retrieves top-performing videos based on four metrics: views, engagement rate, follower conversion rate, and average watch time. It returns a structured response containing lists of video performances sorted by each metric.

**Key Implementation Details:**
- **Asynchronous Operation:** The function is marked as `async`, indicating it operates asynchronously.
- **Parameterization:** Accepts an `AsyncSession` for database interaction and a `limit` parameter to control the number of top videos returned (defaulting to 10).
- **Sorting Logic:** Videos are sorted by each metric using lambda functions, with the highest values appearing first due to `reverse=True`.
- **Transformation Function:** A helper function `to_video_performance` converts raw video data into a structured `VideoPerformance` object.

**When/Why to Use:**
Use this code when you need to analyze and rank videos based on performance metrics. It is particularly useful for analytics dashboards or reports that require top-performing content insights.

**Patterns and Gotchas:**
- **Asynchronous Handling:** Ensure the caller handles asynchronous operations properly, using `await` as needed.
- **Performance Considerations:** The function may be slow with large datasets due to repeated database queries. Consider caching results if performance is an issue.
- **Type Hints:** Utilize type hints for better code readability and maintainability.

This function encapsulates complex logic into manageable parts, making it easier to understand and modify as needed.

---

*Generated by CodeWorm on 2026-02-27 18:06*
