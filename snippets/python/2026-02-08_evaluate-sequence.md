# _evaluate_sequence

**Repository:** Cybersecurity-Projects
**File:** PROJECTS/intermediate/siem-dashboard/backend/app/engine/correlation.py
**Language:** python
**Lines:** 189-231
**Complexity:** 9.0

---

## Source Code

```python
def _evaluate_sequence(
    rule: CorrelationRule,
    event_data: dict,
    state: CorrelationState,
    rule_id: str,
    group_key: str,
) -> EvaluationResult | None:
    """
    Fire when all steps of a sequence are observed within window for a group
    """
    conditions = rule.conditions
    steps = conditions.get("steps", [])

    matched_step = None
    for idx, step in enumerate(steps):
        step_filter = step.get("event_filter", {})
        if _matches_filter(event_data, step_filter):
            matched_step = idx
            break

    if matched_step is None:
        return None

    event_id = event_data.get("id", "")
    state.record_event(
        rule_id, group_key, event_id, event_data,
        step_index=matched_step,
    )

    window_seconds = conditions.get("window_seconds", 0)
    entries = state.get_window(rule_id, group_key, window_seconds)

    for idx, step in enumerate(steps):
        required_count = step.get("count", 1)
        step_entries = [e for e in entries if e.step_index == idx]
        if len(step_entries) < required_count:
            return None

    state.mark_fired(rule_id, group_key)
    return EvaluationResult(
        matched_event_ids=[e.event_id for e in entries],
        group_value=group_key,
    )
```

---

## Documentation

### Documentation for `_evaluate_sequence`

**Purpose and Behavior:**
The function `_evaluate_sequence` evaluates a sequence of events defined by `CorrelationRule`. It checks if all steps in the sequence are observed within a specified window period, recording matched events and marking the rule as fired when conditions are met. If any step is not met, it returns `None`.

**Key Implementation Details:**
- The function takes parameters like `rule`, `event_data`, `state`, `rule_id`, and `group_key`.
- It iterates over steps in a sequence to find a matching event.
- Uses context managers or state objects (`state`) for managing events within a window period.
- Returns an instance of `EvaluationResult` if all steps are met, otherwise returns `None`.

**When/Why to Use:**
Use this function when implementing rule-based correlation in cybersecurity systems. It is essential for detecting sequences of events that indicate potential threats or anomalies.

**Patterns and Gotchas:**
- The use of dynamic step filtering (`step.get("event_filter", {})`) can be complex; ensure filters are well-defined.
- The `state` object's methods like `record_event`, `get_window`, and `mark_fired` should be carefully implemented to handle concurrent access and state consistency.

---

*Generated by CodeWorm on 2026-02-08 03:04*
