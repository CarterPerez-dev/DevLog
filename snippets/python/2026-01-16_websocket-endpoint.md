# websocket_endpoint

**Repository:** Cybersecurity-Projects
**File:** PROJECTS/encrypted-p2p-chat/backend/app/api/websocket.py
**Language:** python
**Lines:** 26-84
**Complexity:** 9.0

---

## Source Code

```python
async def websocket_endpoint(
    websocket: WebSocket,
    user_id: str = Query(...),
) -> None:
    """
    Main WebSocket endpoint for real time messaging
    """
    try:
        user_uuid = UUID(user_id)
    except ValueError:
        logger.error("Invalid user_id format: %s", user_id)
        await websocket.close(code = 1008, reason = "Invalid user ID")
        return

    connected = await connection_manager.connect(websocket, user_uuid)

    if not connected:
        return

    try:
        while True:
            data = await websocket.receive_text()

            try:
                message = json.loads(data)
                await websocket_service.route_message(
                    websocket,
                    user_uuid,
                    message
                )
            except json.JSONDecodeError:
                logger.error(
                    "Invalid JSON from user %s: %s",
                    user_uuid,
                    data[: 100]
                )
                await websocket.send_json(
                    {
                        "type": "error",
                        "error_code": "invalid_json",
                        "error_message": "Invalid JSON format"
                    }
                )
            except Exception as e:
                logger.error("Error handling message from %s: %s", user_uuid, e)
                await websocket.send_json(
                    {
                        "type": "error",
                        "error_code": "processing_error",
                        "error_message": str(e)
                    }
                )

    except WebSocketDisconnect:
        logger.info("WebSocket disconnected for user %s", user_uuid)
    except Exception as e:
        logger.error("WebSocket error for user %s: %s", user_uuid, e)
    finally:
        await connection_manager.disconnect(websocket, user_uuid)
```

---

## Documentation

### Documentation for `websocket_endpoint`

**Purpose and Behavior**
The `websocket_endpoint` function is an asynchronous WebSocket endpoint designed for real-time messaging in a secure P2P chat application. It validates user IDs, connects to the connection manager, processes incoming messages, and handles errors gracefully.

**Key Implementation Details**
- **User Authentication**: Validates `user_id` using `UUID`.
- **Connection Management**: Uses `connection_manager.connect` to establish a WebSocket connection.
- **Message Handling**: Parses JSON data from the WebSocket, routes it through `websocket_service.route_message`, and logs any issues.
- **Error Handling**: Catches specific errors like `JSONDecodeError` and generic exceptions, logging detailed error messages.

**When/Why to Use This Code**
This code is ideal for implementing secure real-time communication in applications where user authentication via UUIDs is required. It ensures robust handling of WebSocket connections and JSON data, making it suitable for complex, high-traffic environments.

**Patterns and Gotchas**
- **Asynchronous Handling**: The use of `async` and `await` is crucial for managing asynchronous operations efficiently.
- **Error Logging**: Comprehensive logging helps in debugging issues but should be adjusted based on production vs. development environments.
- **Resource Management**: Properly handles WebSocket disconnections using the `finally` block to ensure resources are released.

This function exemplifies best practices in handling WebSocket connections and JSON data, making it a reliable choice for real-time applications.

---

*Generated by CodeWorm on 2026-01-16 19:17*
