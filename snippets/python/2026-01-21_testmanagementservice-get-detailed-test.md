# TestManagementService._get_detailed_test_analytics

**Repository:** CertGames-Core
**File:** backend/api/admin/domains/testing/services.py
**Language:** python
**Lines:** 243-317
**Complexity:** 10.0

---

## Source Code

```python
def _get_detailed_test_analytics(test_id: int) -> dict[str, Any]:
        """
        Get detailed analytics for a specific test
        """
        attempts = TestAttempt.objects(testId = test_id, finished = True)
        total_attempts = attempts.count()

        if total_attempts == 0:
            return {
                "analytics": {
                    "total_attempts": 0,
                    "unique_users": 0,
                    "completion_rate": 0,
                    "avg_score": 0,
                    "avg_time_minutes": 0,
                    "perfect_scores": 0,
                    "last_30_days_attempts": 0,
                    "weekly_trend": []
                }
            }

        unique_users = len(attempts.distinct('userId'))
        avg_score = attempts.average('score') or 0
        avg_time = attempts.average('examTimerSeconds') or 0

        perfect_scores = 0
        for attempt in attempts:
            if attempt.score is not None and attempt.totalQuestions is not None and attempt.score == attempt.totalQuestions:
                perfect_scores += 1

        thirty_days_ago = datetime.now(UTC) - timedelta(days = 30)
        recent_attempts = attempts.filter(
            finishedAt__gte = thirty_days_ago
        ).count()

        weekly_stats = []
        for week in range(4):
            week_start = datetime.now(UTC) - timedelta(weeks = week + 1)
            week_end = datetime.now(UTC) - timedelta(weeks = week)
            week_attempts = attempts.filter(
                finishedAt__gte = week_start,
                finishedAt__lt = week_end
            ).count()
            weekly_stats.append(
                {
                    "week": f"{week+1} weeks ago",
                    "attempts": week_attempts
                }
            )

        return {
            "analytics": {
                "total_attempts":
                total_attempts,
                "unique_users":
                unique_users,
                "completion_rate":
                100.0,
                "avg_score":
                round(avg_score,
                      2),
                "avg_time_minutes":
                round(avg_time / 60,
                      2) if avg_time else 0,
                "perfect_scores":
                perfect_scores,
                "perfect_score_rate":
                round((perfect_scores / total_attempts) * 100,
                      2),
                "last_30_days_attempts":
                recent_attempts,
                "weekly_trend":
                weekly_stats[::-1]
            }
        }
```

---

## Documentation

### Documentation for `_get_detailed_test_analytics`

**Purpose and Behavior:**
The function retrieves detailed analytics for a specific test by querying the `TestAttempt` model in Django. It calculates metrics such as total attempts, unique users, average score, completion rate, perfect scores, and weekly trends over the past 30 days.

**Key Implementation Details:**
- **Type Hints:** The function uses type hints to specify input (`test_id`) and output types.
- **Query Filtering:** Filters `TestAttempt` objects based on whether they have finished and were completed within a specific time frame.
- **Aggregations:** Uses Django ORM methods like `count`, `distinct`, and `average`.
- **Date Calculations:** Computes weekly trends by iterating over the past 4 weeks.

**When/Why to Use:**
Use this function when you need comprehensive analytics for a test, including performance metrics and user engagement. It's particularly useful in administrative or reporting contexts where detailed insights are required.

**Patterns & Gotchas:**
- **Static Method:** Decorated with `@staticmethod`, indicating it operates independently of the class state.
- **Potential Performance Issues:** Frequent database queries can impact performance; consider caching for high-traffic scenarios.
- **Date Handling:** Ensure correct timezone handling, especially when dealing with recent dates.

---

*Generated by CodeWorm on 2026-01-21 15:54*
