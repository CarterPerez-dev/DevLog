# CodeWormDaemon._async_run

**Type:** Documentation
**Repository:** CodeWorm
**File:** codeworm/daemon.py
**Language:** python
**Lines:** 259-310
**Complexity:** 7.0

---

## Source Code

```python
async def _async_run(self) -> None:
        """
        Async main run loop
        """
        mode = "[DRY RUN] " if self.dry_run else ""
        self.logger.info(
            "daemon_starting",
            mode = mode.strip() or "normal",
            repos = len(self.settings.repos),
            devlog = str(self.settings.devlog.repo_path),
            debug = self.settings.debug,
        )

        ParserManager.initialize()

        if not self.dry_run:
            self.devlog.ensure_directory_structure()

        db_stats = self.state.get_stats()
        self.logger.info(
            "state_loaded",
            total_documented = db_stats["total_documented"],
            last_7_days = db_stats["last_7_days"],
        )

        self.logger.info(
            "waiting_for_ollama",
            url = self.settings.ollama.base_url
        )
        if not await self._wait_for_ollama():
            self.logger.info("shutdown_during_ollama_wait")
            return

        client = await self._init_llm()
        await client.prewarm()
        self.logger.info("llm_initialized", model = self.settings.ollama.model)

        self.scheduler.set_task_callback(self._on_scheduled_task)
        self.scheduler.start()

        next_run = self.scheduler.get_next_run_time()
        if next_run:
            self.logger.info("next_scheduled_run", time = next_run.isoformat())
            self._emit_event("next_cycle", {"time": next_run.isoformat()})

        while self.running:
            await asyncio.sleep(1)

        self.logger.info(
            "daemon_stopped",
            stats = self.stats.to_dict(),
        )
```

---

## Documentation

### Documentation for `CodeWormDaemon._async_run`

**Purpose and Behavior:**
The `_async_run` method is an asynchronous main loop that initializes the daemon, logs startup information, and runs a series of tasks until the daemon stops. It handles dry run mode, database state loading, LLM initialization, scheduling, and logging.

**Key Implementation Details:**
- **Dry Run Mode:** Logs are prefixed with "[DRY RUN] " if `self.dry_run` is set.
- **Devlog Initialization:** Ensures directory structure only in non-dry-run modes.
- **LLM Prewarming:** Waits for the Ollama service to be available and initializes the LLM client, which then prewarms the model.
- **Scheduling:** Sets a task callback and starts the scheduler.

**When/Why to Use:**
This method is crucial for running the CodeWorm daemon. It should be used whenever you need to start the daemon with its full functionality, including database state management, LLM interaction, and scheduling tasks.

**Patterns/Gotchas:**
- **Asynchronous Handling:** The use of `async` ensures that operations like waiting for services or prewarming are handled efficiently.
- **Dry Run Mode:** Be cautious when enabling dry run mode as it can affect logging behavior significantly.
- **State Management:** Ensure the database state is correctly loaded and managed to avoid unexpected behaviors.

---

*Generated by CodeWorm on 2026-02-27 21:49*
