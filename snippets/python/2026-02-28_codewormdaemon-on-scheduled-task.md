# CodeWormDaemon._on_scheduled_task

**Type:** Documentation
**Repository:** CodeWorm
**File:** codeworm/daemon.py
**Language:** python
**Lines:** 370-393
**Complexity:** 6.0

---

## Source Code

```python
def _on_scheduled_task(self) -> None:
        """
        Callback executed by scheduler for each documentation task
        """
        if self._loop:
            future = asyncio.run_coroutine_threadsafe(
                self._execute_documentation_cycle(),
                self._loop,
            )
            try:
                future.result(timeout = 1800)
            except Exception as e:
                self.logger.exception("scheduled_task_error", error = str(e))
                self.stats.record_failure(f"task_error: {e}")
                if self.notifier and self.stats.consecutive_failures >= self.settings.telegram.alert_after_failures:
                    self.notifier.send_error_sync(e, "scheduler")

            next_run = self.scheduler.get_next_run_time()
            if next_run:
                self.logger.info(
                    "next_scheduled_run",
                    time = next_run.isoformat()
                )
                self._emit_event("next_cycle", {"time": next_run.isoformat()})
```

---

## Documentation

### Documentation for `_on_scheduled_task`

**Purpose and Behavior:**
The `_on_scheduled_task` method is a callback executed by the scheduler for each documentation task in `CodeWormDaemon`. It initiates an asynchronous execution of the `_execute_documentation_cycle()` method, waits up to 30 minutes for its completion, logs any exceptions, records failures, and sends notifications if consecutive failures exceed a threshold.

**Key Implementation Details:**
- Uses `asyncio.run_coroutine_threadsafe` to run the coroutine in the existing event loop.
- Implements error handling with a timeout of 1800 seconds (30 minutes).
- Logs errors using `self.logger.exception`.
- Records failure statistics and triggers notifications via `self.notifier.send_error_sync`.

**When/Why to Use:**
This method is crucial for managing periodic documentation tasks in the CodeWorm system. It ensures that tasks are executed within a specified time frame, logs any issues, and alerts relevant parties if failures persist.

**Patterns/Gotchas:**
- **Concurrency:** The use of `asyncio.run_coroutine_threadsafe` allows for safe execution of asynchronous code in an existing event loop.
- **Error Handling:** A timeout is implemented to prevent indefinite blocking; however, ensure that tasks are designed to complete within the given timeframe.
- **Logging and Notifications:** Proper logging and notification mechanisms are essential for monitoring and debugging. Ensure that `self.logger` and `self.notifier` are correctly configured.

---

*Generated by CodeWorm on 2026-02-28 21:37*
