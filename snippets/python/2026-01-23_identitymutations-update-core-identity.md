# IdentityMutations.update_core_identity

**Repository:** angelamos-operations
**File:** CarterOS-Server/src/core/foundation/repositories/identity_mutations.py
**Language:** python
**Lines:** 43-86
**Complexity:** 8.0

---

## Source Code

```python
async def update_core_identity(
        session: AsyncSession,
        data: dict
    ) -> CoreIdentity:
        """
        Update core identity (singleton) - partial update supported

        Args:
            data: Dict with fields to update (only updates fields present)
                  Fields: name, age, background, current_role, primary_goal, target_audience
        """
        result = await session.execute(select(CoreIdentity).limit(1))
        identity = result.scalar_one_or_none()

        if not identity:
            identity = CoreIdentity(
                name=data.get("name", ""),
                age=data.get("age", 0),
                background=data.get("background", ""),
                current_role=data.get("current_role", ""),
                primary_goal=data.get("primary_goal", ""),
                target_audience=data.get("target_audience", ""),
            )
            session.add(identity)
            await session.flush()
            await session.refresh(identity)
            return identity

        if "name" in data:
            identity.name = data["name"]
        if "age" in data:
            identity.age = data["age"]
        if "background" in data:
            identity.background = data["background"]
        if "current_role" in data:
            identity.current_role = data["current_role"]
        if "primary_goal" in data:
            identity.primary_goal = data["primary_goal"]
        if "target_audience" in data:
            identity.target_audience = data["target_audience"]

        await session.flush()
        await session.refresh(identity)
        return identity
```

---

## Documentation

### Documentation for `update_core_identity`

**Purpose and Behavior**
The function `update_core_identity` is an asynchronous method designed to update a singleton core identity object in the database. It supports partial updates by only modifying fields that are provided in the input dictionary.

**Key Implementation Details**
- **Session Handling**: Uses an `AsyncSession` for database operations.
- **Partial Updates**: Only modifies fields present in the `data` dictionary, ensuring efficient and targeted updates.
- **Singleton Check**: Ensures there is exactly one core identity by limiting the query to one result. If none exists, a new instance is created and added to the session.
- **Field Mapping**: Maps provided data keys to corresponding CoreIdentity attributes.

**When/Why to Use**
Use this function when you need to update specific fields of a singleton core identity object without affecting other fields or multiple objects. It's ideal for scenarios where partial updates are required, such as updating user profiles with minimal changes.

**Patterns and Gotchas**
- **Singleton Handling**: The method assumes there is only one `CoreIdentity` instance; if this assumption fails, unexpected behavior may occur.
- **Field Validation**: Ensure the provided `data` dictionary contains valid keys to avoid runtime errors.

---

*Generated by CodeWorm on 2026-01-23 04:45*
