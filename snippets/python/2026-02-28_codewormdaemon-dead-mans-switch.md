# CodeWormDaemon._dead_mans_switch

**Type:** Documentation
**Repository:** CodeWorm
**File:** codeworm/daemon.py
**Language:** python
**Lines:** 342-368
**Complexity:** 8.0

---

## Source Code

```python
async def _dead_mans_switch(self) -> None:
        check_interval = 300
        alert_threshold = 2700
        alerted = False

        await asyncio.sleep(check_interval)

        while self.running:
            reference = self.stats.last_success or self._start_time
            age = (datetime.now() - reference).total_seconds()
            if age > alert_threshold and not alerted:
                self.logger.warning(
                    "dead_mans_switch_triggered",
                    minutes_since_last_commit = round(age / 60,
                                                      1),
                )
                if self.notifier:
                    log_tail = self._tail_log(20)
                    await self.notifier.send_alert(
                        f"No commits in {int(age / 60)} minutes",
                        details = f"<pre>{log_tail}</pre>",
                    )
                alerted = True
            elif age <= alert_threshold and alerted:
                alerted = False

            await asyncio.sleep(check_interval)
```

---

## Documentation

### Documentation for `_dead_mans_switch` Method

#### Purpose and Behavior
The `CodeWormDaemon._dead_mans_switch` method is an asynchronous function designed to monitor the activity of a daemon process, specifically checking for inactivity over extended periods. It logs a warning if no activity (as defined by the last successful operation) has been detected for more than 45 minutes and sends an alert via a configured notifier.

#### Key Implementation Details
- **Check Interval**: The function sleeps for `check_interval` seconds (300 seconds or 5 minutes) before starting its loop.
- **Alert Mechanism**: An alert is triggered if the time since the last successful operation exceeds `alert_threshold` (45 minutes). If an alert has already been sent, it resets when activity resumes.
- **Logging and Notifying**: Logs a warning message with details about the inactivity period. If configured, sends a detailed alert via a notifier.

#### When/Why to Use This Code
This code is useful for monitoring long-running processes or services that should not be idle for extended periods. It helps ensure that issues are detected early, preventing potential data loss or system failures.

#### Patterns and Gotchas
- **Asynchronous Sleep**: The use of `asyncio.sleep` ensures the function does not block the event loop.
- **Resource Management**: The method relies on class attributes (`self.stats.last_success`, `self.running`, `self.logger`, `self.notifier`) to manage state. Ensure these are properly initialized and managed in your application.
- **Potential False Positives**: If the last successful operation is set incorrectly, it could trigger false alerts. Always validate the timestamp logic.

This method provides a robust way to implement a dead man's switch for long-running processes, ensuring they remain active or alerting you if they do not.

---

*Generated by CodeWorm on 2026-02-28 13:43*
