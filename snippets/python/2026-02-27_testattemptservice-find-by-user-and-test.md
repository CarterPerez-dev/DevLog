# TestAttemptService.find_by_user_and_test

**Type:** Documentation
**Repository:** CertGames-Core
**File:** backend/api/domains/testing/services/session_ops.py
**Language:** python
**Lines:** 25-64
**Complexity:** 7.0

---

## Source Code

```python
def find_by_user_and_test(
        user_id: str | ObjectId,
        test_id: int | str,
        category: str | None = None,
        status: str | None = None
    ) -> TestAttempt | None:
        """
        Find test attempt by user and test.
        """
        if isinstance(user_id, str):
            try:
                user_id = ObjectId(user_id)
            except (InvalidId, ValueError):
                return None

        base_query: dict[str, Any] = {"userId": user_id, "testId": test_id}

        if category:
            base_query["category"] = category

        if status == "finished":
            return TestAttempt.objects(
                **base_query,
                finished = True
            ).order_by('-finishedAt').first()
        if status == "unfinished":
            return TestAttempt.objects(
                **base_query,
                finished = False
            ).first()
        attempt = TestAttempt.objects(
            **base_query,
            finished = False
        ).first()
        if not attempt:
            attempt = TestAttempt.objects(
                **base_query,
                finished = True
            ).order_by('-finishedAt').first()
        return attempt
```

---

## Documentation

### Documentation for `find_by_user_and_test`

**Purpose and Behavior:**
The function `find_by_user_and_test` searches for a `TestAttempt` object based on user ID, test ID, category, and status (finished or unfinished). It returns the first matching attempt, prioritizing finished attempts if no unfinished ones are found.

**Key Implementation Details:**
- **Type Hints:** The function accepts `user_id` as a string or `ObjectId`, `test_id` as an integer or string, and optional `category` and `status` parameters.
- **Query Handling:** It constructs a base query using the provided user ID and test ID. Additional filters are applied based on category and status.
- **Status Filtering:** Depending on the `status` parameter, it searches for either finished or unfinished attempts, with an order by clause to prioritize recent finished attempts.

**When/Why to Use:**
Use this function when you need to retrieve a specific `TestAttempt` record from your database based on user and test identifiers. It handles different statuses efficiently and ensures that the most relevant attempt is returned first.

**Patterns/Gotchas:**
- **Type Conversion:** The code converts string `user_id` to an `ObjectId`, returning `None` if conversion fails.
- **Query Logic:** The function checks for unfinished attempts before finished ones, which might not be ideal in all scenarios. Consider the order of status queries based on your application's requirements.

This function is particularly useful in scenarios where you need to quickly find and display test attempt records with specific criteria.

---

*Generated by CodeWorm on 2026-02-27 23:22*
