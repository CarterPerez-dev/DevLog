# PayoutService.create_payout

**Repository:** stripe-referral
**File:** src/stripe_referral/services/payout_service.py
**Language:** python
**Lines:** 142-213
**Complexity:** 6.0

---

## Source Code

```python
def create_payout(
        db: Session,
        tracking_id: int,
        adapter_type: str,
        recipient_data: dict[str,
                             Any],
    ) -> PayoutInfo:
        """
        Create a payout record for a tracking entry
        """
        tracking_repo = ReferralTrackingRepository(db)
        payout_repo = PayoutRepository(db)
        program_repo = ReferralProgramRepository(db)

        tracking = tracking_repo.get_by_id(tracking_id)
        if not tracking:
            raise TrackingNotFoundError(
                f"Tracking ID {tracking_id} not found",
                tracking_id = tracking_id,
            )

        existing_payout = payout_repo.get_by_tracking_id(tracking_id)
        if existing_payout:
            raise PayoutAlreadyExistsError(
                f"Payout already exists for tracking ID {tracking_id}",
                tracking_id = tracking_id,
            )

        program = program_repo.get_by_id(tracking.program_id)
        if not program:
            raise TrackingNotFoundError(
                f"Program ID {tracking.program_id} not found",
                program_id = tracking.program_id,
            )

        adapter = PayoutService._get_adapter(
            adapter_type,
            program.adapter_config
        )

        validation: RecipientValidation = adapter.validate_recipient(
            recipient_data
        )
        if not validation["valid"]:
            raise InvalidRecipientDataError(
                validation.get("error",
                               "Invalid recipient data"),
                recipient_data = recipient_data,
                adapter_type = adapter_type,
            )

        payout = payout_repo.create(
            user_id = tracking.referrer_user_id,
            tracking_id = tracking_id,
            amount = tracking.amount_earned,
            currency = tracking.currency,
            status = PayoutStatus.PENDING.value,
            adapter_type = adapter_type,
            recipient_data = recipient_data,
        )

        return PayoutInfo(
            id = payout.id,
            user_id = payout.user_id,
            amount = payout.amount,
            currency = payout.currency,
            status = payout.status,
            adapter_type = payout.adapter_type,
            processed_at = payout.processed_at.isoformat()
            if payout.processed_at else None,
            external_transaction_id = payout.external_transaction_id,
        )
```

---

## Documentation

### Documentation for `create_payout` Method

**Purpose and Behavior:**  
The `create_payout` method in the `PayoutService` class creates a new payout record for a given tracking entry, ensuring that the recipient data is valid and no existing payouts exist for the same tracking ID. It uses repositories to interact with the database and an adapter service to validate the recipient data based on the specified adapter type.

**Key Implementation Details:**  
- **Repositories**: Utilizes `ReferralTrackingRepository`, `PayoutRepository`, and `ReferralProgramRepository` for database operations.
- **Validation**: Validates the recipient data using a dynamically selected adapter based on `adapter_type`.
- **Error Handling**: Raises specific exceptions like `TrackingNotFoundError`, `PayoutAlreadyExistsError`, and `InvalidRecipientDataError` to handle various failure cases.

**When/Why to Use:**  
Use this method when you need to create a new payout for a tracking entry, ensuring that all necessary validations are performed. It is particularly useful in scenarios where payouts must be created based on specific criteria and validated against different adapters.

**Patterns/Gotchas:**
- The use of context managers or session handling (assumed from `Session` type hint) should be managed externally to ensure proper database transactions.
- Ensure that the adapter types are correctly configured as they determine how recipient data is validated. Incorrect configuration can lead to validation errors.

---

*Generated by CodeWorm on 2026-01-26 01:49*
