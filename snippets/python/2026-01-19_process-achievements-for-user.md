# process_achievements_for_user

**Repository:** CertGames-Core
**File:** backend/api/domains/progression/services/unlock_engine.py
**Language:** python
**Lines:** 20-104
**Complexity:** 22.0

---

## Source Code

```python
def process_achievements_for_user():
    """
    Checks all achievement criteria against a user's progress
    and unlocks any that have been earned.
    """
    user = g.user

    counters = user.achievement_counters or {}
    unlocked = set(UserAchievementService.get_achievement_ids(user))
    newly_unlocked = []

    all_achievements = AchievementService.get_all()

    for ach in all_achievements:
        aid = ach.achievementId

        if aid in unlocked:
            continue

        crit = ach.criteria or {}

        if any(checker(crit,
                       counters,
                       user) for checker in CRITERIA_CHECKERS):
            unlocked.add(aid)
            newly_unlocked.append(aid)

    if newly_unlocked:
        current_time = datetime.now(UTC)
        total_xp_reward = 0
        total_coin_reward = 0

        for achievement_id in newly_unlocked:

            def get_ach_id(ach):
                return ach.get('achievementId') if isinstance(
                    ach,
                    dict
                ) else ach.achievementId

            if not any(get_ach_id(ach) == achievement_id
                       for ach in user.achievements_v2):
                user.achievements_v2.append(
                    UserAchievement(
                        achievementId = achievement_id,
                        unlockedAt = current_time
                    )
                )

                achievement = next(
                    (
                        ach for ach in all_achievements
                        if ach.achievementId == achievement_id
                    ),
                    None
                )
                if achievement:
                    total_xp_reward += achievement.xpReward or 0
                    total_coin_reward += achievement.coinReward or 0

        user.update(set__achievements_v2=user.achievements_v2)

        if total_xp_reward > 0 or total_coin_reward > 0:
            if total_xp_reward > 0 and total_coin_reward > 0:
                ProgressionService.update_xp_and_coins(
                    user,
                    total_xp_reward,
                    total_coin_reward
                )
            elif total_xp_reward > 0:
                ProgressionService.update_xp(user, total_xp_reward)
            elif total_coin_reward > 0:
                ProgressionService.update_coins(user, total_coin_reward)

        user.reload()

        g.user = user

        AuditLogger.log_action(
            action = "achievements_unlocked",
            user_id = str(user.id),
            data = {"newly_unlocked": newly_unlocked},
        )

    return newly_unlocked
```

---

## Documentation

### Documentation for `process_achievements_for_user`

**Purpose and Behavior:**
This function checks all achievement criteria against a user's progress, unlocks any achievements that have been earned, and updates the user's achievements and rewards accordingly.

**Key Implementation Details:**
1. **User Context**: Retrieves the current user from the global context (`g.user`).
2. **Achievement Criteria Evaluation**: Iterates through all achievements, evaluates criteria using `CRITERIA_CHECKERS`, and unlocks achievements that meet the conditions.
3. **Reward Calculation**: Calculates XP and coin rewards for newly unlocked achievements.
4. **User Update**: Updates the user's achievements and applies the earned rewards.

**When/Why to Use:**
Use this function whenever you need to process and unlock achievements for a user, ensuring their progress is accurately reflected in the system.

**Patterns and Gotchas:**
- **Global Context Dependency**: The function relies on `g.user` for the current user context.
- **Criteria Checkers**: Utilizes `CRITERIA_CHECKERS`, which must be defined elsewhere. Ensure these checkers are comprehensive to cover all possible criteria.
- **Performance Considerations**: Iterating through all achievements can be resource-intensive; consider optimizations if performance is a concern.

This function ensures that users receive timely and accurate rewards for their progress, enhancing the game's engagement loop.

---

*Generated by CodeWorm on 2026-01-19 20:06*
