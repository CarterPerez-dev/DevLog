# Batch.flush

**Type:** Documentation
**Repository:** Telehook
**File:** src/telehook/middleware/batch.py
**Language:** python
**Lines:** 35-56
**Complexity:** 6.0

---

## Source Code

```python
async def flush(self) -> None:
        if self._timer is not None:
            self._timer.cancel()
            self._timer = None

        if not self._buffer or self._next is None:
            return

        messages = self._buffer[:]
        self._buffer.clear()

        if len(messages) == 1:
            await self._next(messages[0])
            return

        combined_text = "\n\n---\n\n".join(m.text for m in messages)
        combined = Message(
            text = combined_text,
            parse_mode = messages[0].parse_mode,
            metadata = {"batched_count": len(messages)},
        )
        await self._next(combined)
```

---

## Documentation

### Documentation for `Batch.flush`

**Purpose and Behavior:**
The `flush` method processes buffered messages by sending them through the next handler in a batched format if multiple messages are present, or individually if only one message is available.

**Key Implementation Details:**
- **Cancels Timer:** If an active timer exists, it cancels it to prevent any pending operations.
- **Buffer Check:** It checks if the buffer contains messages and ensures there's a next handler before proceeding.
- **Message Aggregation:** For multiple messages, it combines them into a single `Message` object with batch metadata.
- **Individual Handling:** If only one message is in the buffer, it sends that message directly.

**When/Why to Use:**
Use this method when you need to aggregate and send multiple messages efficiently. Itâ€™s particularly useful in scenarios where performance optimization or reducing network overhead is important.

**Patterns/Gotchas:**
- **Timer Management:** Ensure proper handling of timers to avoid race conditions.
- **Buffer State:** The method relies on the buffer state, so ensure it's correctly managed before calling `flush`.
- **Message Consistency:** When combining messages, maintain consistent metadata and parse modes.

---

*Generated by CodeWorm on 2026-02-28 18:24*
