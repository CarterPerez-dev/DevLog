# ChecklistService.get_stats

**Type:** Documentation
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/life_manager/facets/checklist/service.py
**Language:** python
**Lines:** 178-229
**Complexity:** 14.0

---

## Source Code

```python
async def get_stats(session: AsyncSession) -> ChecklistStatsResponse:
        """
        Compute streak, per-item completion rates, and year heatmap
        """
        today = date.today()
        year_start = date(today.year, 1, 1)

        heatmap_rows = await ChecklistLogRepository.get_heatmap_data(
            session, year_start, today
        )
        heatmap = [
            HeatmapDay(
                date=row.log_date,
                completed_count=int(row.completed_count or 0),
                total_count=int(row.total_count or 0),
            )
            for row in heatmap_rows
        ]

        heatmap_by_date = {h.date: h for h in heatmap}
        streak = 0
        check_date = today
        while check_date >= year_start:
            day = heatmap_by_date.get(check_date)
            if day and day.total_count > 0 and day.completed_count == day.total_count:
                streak += 1
                check_date -= timedelta(days=1)
            else:
                break

        rate_rows = await ChecklistLogRepository.get_item_completion_rates(session)
        active_items = await ChecklistItemRepository.get_active(session)
        item_map = {i.id: i.title for i in active_items}

        item_stats = [
            ItemStat(
                item_id=row.item_id,
                title=item_map.get(row.item_id, ""),
                completion_rate=round(
                    (int(row.completed or 0) / int(row.total)) if int(row.total) > 0 else 0.0,
                    4,
                ),
            )
            for row in rate_rows
            if row.item_id in item_map
        ]

        return ChecklistStatsResponse(
            streak=streak,
            item_stats=item_stats,
            heatmap=heatmap,
        )
```

---

## Documentation

### Documentation for `get_stats` Method

**Purpose and Behavior:**
The `get_stats` method computes various statistics related to checklist items, including streaks, completion rates, and year-over-year heatmaps. It processes data from the `ChecklistLogRepository` and `ChecklistItemRepository`, returning a structured response object.

**Key Implementation Details:**
1. **Streak Calculation:** The function calculates the longest consecutive day streak where all items were completed.
2. **Completion Rates:** It computes completion rates for each active checklist item, using data from the repository.
3. **Heatmap Data:** Generates a heatmap representing daily completions over the past year.

**When/Why to Use:**
This method is essential for generating comprehensive statistics on user checklist performance. It's useful in scenarios where you need to track progress and provide insights into user behavior over time, such as in productivity or habit tracking applications.

**Patterns and Gotchas:**
- **Asynchronous Operations:** The use of `await` ensures that database queries are handled asynchronously.
- **Type Hints:** Clear type hints for parameters and return values improve code readability and maintainability.
- **Heatmap Construction:** Using a dictionary comprehension to map dates to heatmap entries can be memory-intensive with large datasets. Consider optimizing if performance is an issue.

This method provides a robust way to analyze checklist data, making it valuable for analytics and reporting purposes.

---

*Generated by CodeWorm on 2026-02-22 01:27*
