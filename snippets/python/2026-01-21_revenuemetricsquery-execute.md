# RevenueMetricsQuery.execute

**Repository:** CertGames-Core
**File:** backend/api/admin/domains/revenue/queries.py
**Language:** python
**Lines:** 531-599
**Complexity:** 13.0

---

## Source Code

```python
def execute(self) -> list[dict[str, Any]]:
        """
        Get revenue metrics over time
        """
        date_format = {
            'day': '%Y-%m-%d',
            'week': '%Y-W%V',
            'month': '%Y-%m'
        }.get(self.group_by,
              '%Y-%m-%d')

        pipeline = [
            {
                '$match': {
                    'conversionDate': {
                        '$gte': self.start_date,
                        '$lte': self.end_date
                    }
                }
            },
            {
                '$group': {
                    '_id': {
                        '$dateToString': {
                            'format': date_format,
                            'date': '$conversionDate'
                        }
                    },
                    'new_subscriptions': {
                        '$sum': 1
                    },
                    'total_revenue': {
                        '$sum': '$firstPaymentAmount'
                    },
                    'mrr_added': {
                        '$sum': '$monthlyRevenue'
                    },
                    'avg_payment': {
                        '$avg': '$firstPaymentAmount'
                    }
                }
            },
            {
                '$project': {
                    'period': '$_id',
                    'new_subscriptions': 1,
                    'total_revenue': {
                        '$round': ['$total_revenue',
                                   2]
                    },
                    'mrr_added': {
                        '$round': ['$mrr_added',
                                   2]
                    },
                    'avg_payment': {
                        '$round': ['$avg_payment',
                                   2]
                    },
                    '_id': 0
                }
            },
            {
                '$sort': {
                    'period': 1
                }
            }
        ]

        return list(SubscriptionMetrics.objects.aggregate(pipeline))
```

---

## Documentation

### Documentation for `RevenueMetricsQuery.execute`

**Purpose and Behavior:**
The `execute` method retrieves revenue metrics over time, grouped by a specified period (day, week, month). It processes documents from the `SubscriptionMetrics` collection to calculate new subscriptions, total revenue, MRR added, and average payment amount. The results are formatted for readability.

**Key Implementation Details:**
- **Aggregation Pipeline:** Uses MongoDB aggregation framework to filter, group, project, and sort data.
- **Date Formatting:** Dynamically formats dates based on the `group_by` parameter using Python's string formatting.
- **Result Projection:** Rounds monetary values to two decimal places for clarity.

**When/Why to Use:**
Use this method when you need to analyze revenue trends over time. It is particularly useful in financial reporting or performance analysis, providing insights into subscription growth and revenue patterns.

**Patterns and Gotchas:**
- **Dynamic Date Formatting:** The date format is determined at runtime based on the `group_by` parameter.
- **Aggregation Pipeline Complexity:** While powerful, complex pipelines can be difficult to debug. Ensure thorough testing with various groupings and date ranges.
- **Rounding Precision:** Rounding monetary values ensures consistent presentation but may introduce minor discrepancies in exact calculations.

---

*Generated by CodeWorm on 2026-01-21 04:29*
