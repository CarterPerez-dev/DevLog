# ReferralService.validate_code

**Repository:** stripe-referral
**File:** stripe-referral/src/stripe_referral/services/referral_service.py
**Language:** python
**Lines:** 86-127
**Complexity:** 7.0

---

## Source Code

```python
def validate_code(db: Session, code: str) -> CodeValidation:
        """
        Validate if a code is active and usable
        """
        code_repo = ReferralCodeRepository(db)

        code_obj = code_repo.get_by_code(code)
        if not code_obj:
            raise CodeNotFoundError(
                f"Code '{code}' not found",
                code = code
            )

        if code_obj.status != ReferralCodeStatus.ACTIVE.value:
            raise CodeInactiveError(
                f"Code '{code}' is inactive (status: {code_obj.status})",
                code = code,
                status = code_obj.status,
            )

        if code_obj.expires_at and code_obj.expires_at < datetime.now(UTC
                                                                      ):
            raise CodeExpiredError(
                f"Code '{code}' expired at {code_obj.expires_at.isoformat()}",
                code = code,
                expires_at = code_obj.expires_at.isoformat(),
            )

        if code_obj.max_uses and code_obj.uses_count >= code_obj.max_uses:
            raise CodeMaxUsesReachedError(
                f"Code '{code}' has reached maximum uses ({code_obj.max_uses})",
                code = code,
                max_uses = code_obj.max_uses,
                uses_count = code_obj.uses_count,
            )

        return CodeValidation(
            valid = True,
            code_id = code_obj.id,
            program_id = code_obj.program_id,
            referrer_user_id = code_obj.user_id,
        )
```

---

## Documentation

### Documentation for `validate_code` Method

**Purpose and Behavior**
The `validate_code` method in the `ReferralService` class checks if a referral code is valid, active, not expired, and has not been used beyond its maximum limit. It raises specific errors if any validation fails and returns a `CodeValidation` object with relevant details if all validations pass.

**Key Implementation Details**
- **Session Dependency**: The method takes a database session (`db`) and the referral code (`code`) as parameters.
- **Repository Interaction**: Uses `ReferralCodeRepository` to fetch the code object by its value.
- **Error Handling**: Raises `CodeNotFoundError`, `CodeInactiveError`, `CodeExpiredError`, and `CodeMaxUsesReachedError` for different validation failure cases.
- **Return Value**: Returns a `CodeValidation` object containing validation status and relevant code details.

**When/Why to Use This Code**
Use this method when you need to validate referral codes before applying them in your application. It ensures that only valid, active, and unused codes are processed, enhancing the security and integrity of your referral system.

**Patterns and Gotchas**
- **Type Hints**: The use of type hints (`Session`, `str`, `CodeValidation`) makes the code more readable and maintainable.
- **Error Propagation**: Raising specific error types helps in handling different validation failures gracefully. Ensure that these errors are properly caught and handled at higher levels to provide meaningful user feedback.

This method follows a clear, structured approach to validate referral codes, making it robust and easy to understand.

---

*Generated by CodeWorm on 2026-01-12 20:28*
