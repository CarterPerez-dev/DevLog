# RateLimiter.__call__

**Type:** Documentation
**Repository:** Telehook
**File:** src/telehook/middleware/rate_limiter.py
**Language:** python
**Lines:** 29-39
**Complexity:** 3.0

---

## Source Code

```python
async def __call__(self, message: Message, next_: SendFunc) -> None:
        self._refill()

        if self._tokens >= 1.0:
            self._tokens -= 1.0
            if self._dropped_count > 0:
                message.metadata["dropped_count"] = self._dropped_count
                self._dropped_count = 0
            await next_(message)
        else:
            self._dropped_count += 1
```

---

## Documentation

### Documentation for `RateLimiter.__call__`

**Purpose and Behavior:**
The `RateLimiter.__call__` method is an asynchronous function that processes incoming `Message` objects in a rate-limited manner. It checks if the current token count (`self._tokens`) allows for processing the message. If tokens are available, it decrements the token count by 1 and optionally adds metadata to the message indicating how many messages were dropped due to rate limiting. Otherwise, it increments the `_dropped_count` counter.

**Key Implementation Details:**
- The method is marked as `async`, allowing for asynchronous processing.
- It takes two parameters: a `Message` object and a `SendFunc` function (likely another middleware or handler).
- Internal state (`_tokens` and `_dropped_count`) is managed to enforce rate limits.

**When/Why to Use This Code:**
This code should be used in situations where you need to limit the frequency of message processing, such as handling notifications or requests. It ensures that only a certain number of messages are processed within a given time frame, preventing overload and maintaining system stability.

**Patterns/Gotchas:**
- The use of `async def` indicates this function is part of an asynchronous context, which may require careful handling in the calling code.
- The decrementing of `_tokens` by 1.0 suggests that tokens are consumed at a fixed rate; ensure this aligns with your application's requirements.
- Be cautious about the state variables (`_tokens`, `_dropped_count`) as they are shared across calls, which could lead to race conditions if not properly managed in concurrent environments.

---

*Generated by CodeWorm on 2026-02-28 20:34*
