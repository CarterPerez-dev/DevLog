# update_profile

**Type:** Documentation
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/intermediate/siem-dashboard/backend/app/controllers/auth_ctrl.py
**Language:** python
**Lines:** 99-149
**Complexity:** 11.0

---

## Source Code

```python
def update_profile() -> dict[str, Any]:
    """
    Update the authenticated user's own profile fields
    """
    user = g.current_user
    data = g.validated

    is_valid, _ = verify_password(data.current_password, user.password_hash)
    if not is_valid:
        raise AuthenticationError("Current password is incorrect")

    updates: dict[str, str] = {}

    if data.username is not None and data.username != user.username:
        if User.username_exists(data.username):
            raise ConflictError("Username already taken")
        updates["username"] = data.username

    if data.email is not None and data.email != user.email:
        if User.email_exists(data.email):
            raise ConflictError("Email already registered")
        updates["email"] = data.email

    if data.password is not None:
        updates["password_hash"] = hash_password(data.password)

    if not updates:
        raise ValidationError("No fields to update")

    user.update_profile(**updates)

    new_token: str | None = None
    if "username" in updates:
        new_token = create_access_token(
            user_id = str(user.id),
            extra_claims = {
                "username": user.username,
                "role": user.role,
            },
        )

    return UpdateProfileResponse(
        user = UserResponse(
            id = str(user.id),
            username = user.username,
            email = user.email,
            role = user.role,
            is_active = user.is_active,
        ),
        access_token = new_token,
    ).model_dump(exclude_none = True)
```

---

## Documentation

### Purpose and Behavior

The `update_profile` function updates a user's profile fields in an authenticated application. It validates the current password, checks for conflicts (like existing usernames or emails), hashes new passwords, and issues a new access token if the username changes.

### Key Implementation Details

- **Authentication**: Uses `g.current_user` to get the authenticated user.
- **Validation**: Checks if the provided data matches the current user's credentials before proceeding.
- **Conditional Updates**: Only updates fields that have valid new values.
- **Error Handling**: Raises specific errors for validation issues like incorrect passwords, taken usernames, or duplicate emails.
- **Token Management**: Issues a new access token when the username changes.

### When/Why to Use This Code

Use this function in scenarios where users can modify their profile information. It ensures security by validating credentials and preventing conflicts with existing data. This code is essential for maintaining user integrity and security, especially in applications handling sensitive user data.

### Patterns and Gotchas

- **Context Dependency**: The function relies on `g.current_user` and `g.validated`, which must be set appropriately.
- **Error Propagation**: Specific error types (`AuthenticationError`, `ConflictError`, `ValidationError`) are raised to handle different failure cases.
- **Token Reissuance**: A new token is issued only when the username changes, ensuring that tokens remain valid even if other fields are updated.

---

*Generated by CodeWorm on 2026-02-28 17:03*
