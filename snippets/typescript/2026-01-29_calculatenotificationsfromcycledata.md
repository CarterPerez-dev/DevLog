# calculateNotificationsFromCycleData

**Repository:** ios-test
**File:** red-recon/src/core/notifications/notification.service.ts
**Language:** typescript
**Lines:** 118-190
**Complexity:** 9.0

---

## Source Code

```typescript
function calculateNotificationsFromCycleData(
  cycleStatus: CycleStatus,
  partner: PartnerResponse
): NotificationConfig[] {
  const notifications: NotificationConfig[] = []
  const today = new Date()
  today.setHours(0, 0, 0, 0)

  if (
    partner.notification_period_reminder &&
    cycleStatus.predicted_period_start &&
    cycleStatus.days_until_period !== null
  ) {
    const predictedStart = new Date(cycleStatus.predicted_period_start)
    const reminderDate = addDays(predictedStart, -partner.reminder_days_before)

    if (reminderDate > today) {
      const content = NOTIFICATION_CONTENT[NotificationType.PERIOD_REMINDER]
      notifications.push({
        type: NotificationType.PERIOD_REMINDER,
        identifier: NOTIFICATION_IDENTIFIERS.PERIOD_REMINDER,
        title: content.title,
        body: content.bodyTemplate(partner.reminder_days_before),
        triggerDate: setTimeToMorning(reminderDate),
      })
    }
  }

  if (
    partner.notification_pms_alert &&
    cycleStatus.last_period_start &&
    cycleStatus.cycle_length
  ) {
    const lastPeriod = new Date(cycleStatus.last_period_start)
    const ovulationDay = cycleStatus.cycle_length - 14
    const lutealStartDay = ovulationDay + 2
    const lutealDate = addDays(lastPeriod, lutealStartDay - 1)

    if (lutealDate > today) {
      const content = NOTIFICATION_CONTENT[NotificationType.PMS_ALERT]
      notifications.push({
        type: NotificationType.PMS_ALERT,
        identifier: NOTIFICATION_IDENTIFIERS.PMS_ALERT,
        title: content.title,
        body: content.body,
        triggerDate: setTimeToMorning(lutealDate),
      })
    }
  }

  if (
    partner.notification_ovulation_alert &&
    cycleStatus.last_period_start &&
    cycleStatus.cycle_length
  ) {
    const lastPeriod = new Date(cycleStatus.last_period_start)
    const ovulationDay = cycleStatus.cycle_length - 14
    const ovulationDate = addDays(lastPeriod, ovulationDay - 1)

    if (ovulationDate > today) {
      const content = NOTIFICATION_CONTENT[NotificationType.OVULATION_ALERT]
      notifications.push({
        type: NotificationType.OVULATION_ALERT,
        identifier: NOTIFICATION_IDENTIFIERS.OVULATION_ALERT,
        title: content.title,
        body: content.body,
        triggerDate: setTimeToMorning(ovulationDate),
      })
    }
  }

  return notifications
}
```

---

## Documentation

### Documentation for `calculateNotificationsFromCycleData`

**Purpose and Behavior:**
This function generates notifications based on cycle data, specifically focusing on reminders before a predicted period start, alerts for ovulation and PMS (premenstrual syndrome). It checks the current date against calculated dates derived from user cycle status to determine when to trigger each notification.

**Key Implementation Details:**
- The function takes `cycleStatus` and `partner` as inputs.
- Notifications are created based on conditions related to predicted period start, ovulation, and PMS alerts.
- Each condition involves calculating relevant dates using the `addDays` and `setTimeToMorning` functions.
- Notifications are stored in an array and returned.

**When/Why to Use:**
Use this function when implementing a feature that requires generating cycle-related notifications for users. It ensures timely reminders and alerts, enhancing user engagement with health tracking applications.

**Patterns and Gotchas:**
- The function uses multiple conditional checks (`if` statements) leading to a high cyclomatic complexity.
- Ensure `NOTIFICATION_CONTENT`, `NotificationType`, and related constants are correctly defined elsewhere in the codebase.
- Be cautious of potential date calculation errors, especially with time zone differences or daylight saving changes.

---

*Generated by CodeWorm on 2026-01-29 14:53*
