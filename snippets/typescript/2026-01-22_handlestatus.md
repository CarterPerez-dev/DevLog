# handleStatus

**Repository:** angelamos-operations
**File:** CarterBot-Telegram/src/handlers/commands.ts
**Language:** typescript
**Lines:** 79-141
**Complexity:** 12.0

---

## Source Code

```typescript
async function handleStatus(ctx: Context): Promise<void> {
  const userId = ctx.from?.id;

  if (!isAuthorized(userId, ALLOWED_USERS)) {
    await ctx.reply("Unauthorized.");
    return;
  }

  const lines: string[] = ["<b>Bot Status</b>\n"];

  if (session.isActive) {
    lines.push(`Session: Active (${session.sessionId?.slice(0, 8)}...)`);
  } else {
    lines.push("Session: None");
  }

  if (session.isRunning) {
    const elapsed = session.queryStarted
      ? Math.floor((Date.now() - session.queryStarted.getTime()) / 1000)
      : 0;
    lines.push(`Query: Running (${elapsed}s)`);
    if (session.currentTool) {
      lines.push(`   ${session.currentTool}`);
    }
  } else {
    lines.push("Query: Idle");
    if (session.lastTool) {
      lines.push(`   Last: ${session.lastTool}`);
    }
  }

  if (session.lastActivity) {
    const ago = Math.floor(
      (Date.now() - session.lastActivity.getTime()) / 1000
    );
    lines.push(`\nLast activity: ${ago}s ago`);
  }

  if (session.lastUsage) {
    const usage = session.lastUsage;
    lines.push(
      `\nLast query usage:`,
      `   Input: ${usage.input_tokens?.toLocaleString() || "?"} tokens`,
      `   Output: ${usage.output_tokens?.toLocaleString() || "?"} tokens`
    );
    if (usage.cache_read_input_tokens) {
      lines.push(
        `   Cache read: ${usage.cache_read_input_tokens.toLocaleString()}`
      );
    }
  }

  if (session.lastError) {
    const ago = session.lastErrorTime
      ? Math.floor((Date.now() - session.lastErrorTime.getTime()) / 1000)
      : "?";
    lines.push(`\nLast error (${ago}s ago):`, `   ${session.lastError}`);
  }

  lines.push(`\nWorking dir: <code>${WORKING_DIR}</code>`);

  await ctx.reply(lines.join("\n"), { parse_mode: "HTML" });
}
```

---

## Documentation

### Documentation for `handleStatus` Function

**Purpose and Behavior:**
The `handleStatus` function in the Telegram bot context retrieves and displays detailed status information about a user's session, including session activity, query status, last usage details, and working directory path.

**Key Implementation Details:**
- **Authorization Check:** The function first checks if the user is authorized using `isAuthorized(userId, ALLOWED_USERS)`. If not, it replies with "Unauthorized."
- **Session Status Handling:** Depending on whether a session is active or idle, different status messages are generated. For running queries, elapsed time and current tool are included.
- **Usage Details:** Last usage tokens, cache reads, and errors are logged if available.
- **HTML Parsing:** The final message uses HTML parsing for formatting.

**When/Why to Use:**
Use this function in a Telegram bot context where detailed session status needs to be reported. It is particularly useful during debugging or when providing users with insights into their interaction history with the bot.

**Patterns and Gotchas:**
- **Conditional Logic:** The function uses multiple conditional checks, which can make it complex if not well-maintained.
- **Date Calculations:** Time calculations using `Math.floor` and `getTime()` might need adjustments based on time zones or precision requirements.
- **Error Handling:** While the function handles some errors (like missing tokens), ensure comprehensive error handling for all possible scenarios.

---

*Generated by CodeWorm on 2026-01-22 20:50*
