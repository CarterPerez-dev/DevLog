# Run

**Repository:** oneIsNun_
**File:** go-backend/internal/websocket/hub.go
**Language:** go
**Lines:** 44-94
**Complexity:** 10.0

---

## Source Code

```go
func (h *Hub) Run(ctx context.Context) {
	for {
		select {
		case <-ctx.Done():
			h.mu.Lock()
			for client := range h.clients {
				close(client.send)
				delete(h.clients, client)
			}
			h.mu.Unlock()
			return

		case client := <-h.register:
			h.mu.Lock()
			h.clients[client] = true
			h.mu.Unlock()
			h.logger.Debug("websocket client connected",
				"client_id", client.clientID,
				"total_clients", len(h.clients),
			)

		case client := <-h.unregister:
			h.mu.Lock()
			if _, ok := h.clients[client]; ok {
				delete(h.clients, client)
				close(client.send)
			}
			h.mu.Unlock()
			h.logger.Debug("websocket client disconnected",
				"client_id", client.clientID,
				"total_clients", len(h.clients),
			)

		case message := <-h.broadcast:
			h.mu.RLock()
			for client := range h.clients {
				select {
				case client.send <- message:
				default:
					h.mu.RUnlock()
					h.mu.Lock()
					delete(h.clients, client)
					close(client.send)
					h.mu.Unlock()
					h.mu.RLock()
				}
			}
			h.mu.RUnlock()
		}
	}
}
```

---

## Documentation

### Documentation for `Run` Function in `Hub`

**Purpose and Behavior:**
The `Run` function is a goroutine that manages the lifecycle of WebSocket clients connected to a hub. It handles registration, unregistration, and broadcasting messages to all connected clients.

**Key Implementation Details:**
- The function uses a context (`ctx`) for graceful shutdown.
- It employs a select statement to handle multiple channels concurrently:
  - `ctx.Done()` triggers cleanup when the context is canceled.
  - `h.register` handles client registration.
  - `h.unregister` manages client disconnection.
  - `h.broadcast` sends messages to all clients.

**When/Why to Use:**
This code should be used in WebSocket server implementations where you need to manage multiple connected clients efficiently. The use of goroutines and channels ensures non-blocking, concurrent operations, making it suitable for high-traffic applications.

**Patterns and Gotchas:**
- **Concurrency Safety:** The `mu` mutex is used to safely modify the `clients` map.
- **Error Handling:** While not explicitly shown, any errors from channel operations or logging should be handled appropriately.
- **Resource Management:** Properly closing client send channels during disconnection prevents resource leaks.

This implementation ensures robust management of WebSocket clients in a concurrent environment.

---

*Generated by CodeWorm on 2026-01-13 20:02*
