# GetDiskUsage

**Type:** Documentation
**Repository:** Yoshi-Audit
**File:** internal/docker/client.go
**Language:** go
**Lines:** 167-254
**Complexity:** 16.0

---

## Source Code

```go
func (c *Client) GetDiskUsage() ([]ImageInfo, []ContainerInfo, []VolumeInfo, BuildCacheInfo, error) {
	ctx := context.Background()
	du, err := c.cli.DiskUsage(ctx, types.DiskUsageOptions{})
	if err != nil {
		return nil, nil, nil, BuildCacheInfo{}, err
	}

	var images []ImageInfo
	for _, s := range du.Images {
		if s == nil {
			continue
		}
		repo := "<none>"
		tag := "<none>"
		if len(s.RepoTags) > 0 {
			parts := strings.SplitN(s.RepoTags[0], ":", 2)
			repo = parts[0]
			if len(parts) > 1 {
				tag = parts[1]
			}
		}
		dangling := repo == "<none>" && s.Containers == 0
		images = append(images, ImageInfo{
			ID:         s.ID,
			Repository: repo,
			Tag:        tag,
			Size:       s.Size,
			SharedSize: s.SharedSize,
			UniqueSize: s.Size - s.SharedSize,
			Containers: s.Containers,
			Created:    time.Unix(s.Created, 0),
			Dangling:   dangling,
		})
	}

	var containers []ContainerInfo
	for _, s := range du.Containers {
		if s == nil {
			continue
		}
		name := ""
		if len(s.Names) > 0 {
			name = strings.TrimPrefix(s.Names[0], "/")
		}
		containers = append(containers, ContainerInfo{
			ID:      s.ID,
			Name:    name,
			Image:   s.Image,
			Status:  s.Status,
			State:   s.State,
			Size:    s.SizeRw,
			Created: time.Unix(s.Created, 0),
			Running: s.State == "running",
		})
	}

	var volumes []VolumeInfo
	for _, v := range du.Volumes {
		if v == nil {
			continue
		}
		var size int64
		var links int
		if v.UsageData != nil {
			size = v.UsageData.Size
			links = int(v.UsageData.RefCount)
		}
		var created time.Time
		if v.CreatedAt != "" {
			created, _ = time.Parse(time.RFC3339, v.CreatedAt)
		}
		volumes = append(volumes, VolumeInfo{
			Name:    v.Name,
			Size:    size,
			Links:   links,
			Created: created,
		})
	}

	var cacheSize int64
	for _, bc := range du.BuildCache {
		if bc != nil {
			cacheSize += bc.Size
		}
	}

	return images, containers, volumes, BuildCacheInfo{TotalSize: cacheSize}, nil
}
```

---

## Documentation

### Documentation for `GetDiskUsage` Function

**Purpose and Behavior:**
The `GetDiskUsage` function retrieves detailed disk usage information from a Docker client, including images, containers, volumes, and build cache size. It processes the raw data to create structured `ImageInfo`, `ContainerInfo`, and `VolumeInfo` objects.

**Key Implementation Details:**
- The function takes no parameters other than `context.Context`.
- It uses the Docker API's `DiskUsageOptions` to fetch disk usage details.
- For each type of resource (images, containers, volumes), it iterates over the raw data, processes it into structured information, and appends it to respective slices.
- The function handles nil entries gracefully by skipping them.
- It calculates unique sizes for images and determines if an image is dangling.

**When/Why to Use This Code:**
Use this code when you need a comprehensive overview of disk usage across Docker resources. It's particularly useful in monitoring, auditing, or maintenance scenarios where detailed resource information is required.

**Patterns/Gotchas:**
- The function uses goroutines indirectly through the Docker API calls but does not explicitly manage them.
- Error handling is robust; it returns an error if any step fails.
- The `BuildCacheInfo` struct aggregates build cache size, which might be useful for tracking development artifacts.

---

*Generated by CodeWorm on 2026-02-28 22:49*
