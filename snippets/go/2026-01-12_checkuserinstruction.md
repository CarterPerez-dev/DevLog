# checkUserInstruction

**Repository:** Cybersecurity-Projects
**File:** PROJECTS/docker-security-audit/internal/analyzer/dockerfile.go
**Language:** go
**Lines:** 64-110
**Complexity:** 9.0

---

## Source Code

```go
func (a *DockerfileAnalyzer) checkUserInstruction(
	target finding.Target,
	ast *parser.Node,
) finding.Collection {
	var findings finding.Collection

	hasUser := false
	var lastFromLine int

	for _, node := range ast.Children {
		switch strings.ToUpper(node.Value) {
		case "FROM":
			lastFromLine = node.StartLine
			hasUser = false
		case "USER":
			hasUser = true
			user := ""
			if node.Next != nil {
				user = node.Next.Value
			}
			if user == "root" || user == "0" {
				loc := &finding.Location{Path: a.path, Line: node.StartLine}
				f := finding.New("DS-USER-ROOT", "USER instruction sets root user", finding.SeverityMedium, target).
					WithDescription("Dockerfile explicitly sets USER to root, which should be avoided.").
					WithCategory(string(CategoryDockerfile)).
					WithLocation(loc).
					WithRemediation("Create and use a non-root user in the Dockerfile.")
				findings = append(findings, f)
			}
		}
	}

	if !hasUser && lastFromLine > 0 {
		control, _ := benchmark.Get("4.1")
		loc := &finding.Location{Path: a.path, Line: lastFromLine}
		f := finding.New("CIS-4.1", control.Title, finding.SeverityMedium, target).
			WithDescription(control.Description).
			WithCategory(string(CategoryDockerfile)).
			WithLocation(loc).
			WithRemediation(control.Remediation).
			WithReferences(control.References...).
			WithCISControl(control.ToCISControl())
		findings = append(findings, f)
	}

	return findings
}
```

---

## Documentation

### Documentation for `checkUserInstruction` Function

**Purpose and Behavior:**
The `checkUserInstruction` function in the DockerfileAnalyzer checks for potential security issues related to user instructions within a Dockerfile. It identifies if the `USER root` instruction is used, which can pose security risks, and suggests using non-root users instead.

**Key Implementation Details:**
- The function iterates through the AST (Abstract Syntax Tree) of the Dockerfile.
- It looks for "FROM" and "USER" instructions to determine the last `FROM` line and check if a user is specified.
- If `USER root` or `USER 0` is found, it logs a finding with severity medium.
- If no `USER` instruction is present after the last `FROM`, it adds another finding suggesting adherence to CIS control.

**When/Why to Use:**
This function should be used in security audits of Dockerfiles to ensure compliance with best practices and avoid potential vulnerabilities. It helps in identifying insecure configurations that could lead to privilege escalation attacks.

**Patterns/Gotchas:**
- The function relies on the `parser.Node` structure, which must be correctly parsed from the Dockerfile.
- It assumes the presence of a `finding` package for logging findings, ensuring consistent categorization and reporting.
- The use of `strings.ToUpper` ensures case-insensitive matching but could lead to false positives if not carefully managed.

---

*Generated by CodeWorm on 2026-01-12 19:33*
