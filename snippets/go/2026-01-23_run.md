# Run

**Repository:** angelamos-operations
**File:** Docker-Kentros/internal/websocket/hub.go
**Language:** go
**Lines:** 38-82
**Complexity:** 10.0

---

## Source Code

```go
func (h *Hub) Run(ctx context.Context) {
	for {
		select {
		case <-ctx.Done():
			h.mu.Lock()
			for client := range h.clients {
				close(client.send)
				delete(h.clients, client)
			}
			h.mu.Unlock()
			return

		case client := <-h.register:
			h.mu.Lock()
			h.clients[client] = true
			h.mu.Unlock()
			h.logger.Debug("client connected", "addr", client.conn.RemoteAddr())

		case client := <-h.unregister:
			h.mu.Lock()
			if _, ok := h.clients[client]; ok {
				delete(h.clients, client)
				close(client.send)
			}
			h.mu.Unlock()
			h.logger.Debug(
				"client disconnected",
				"addr",
				client.conn.RemoteAddr(),
			)

		case message := <-h.broadcast:
			h.mu.RLock()
			for client := range h.clients {
				select {
				case client.send <- message:
				default:
					close(client.send)
					delete(h.clients, client)
				}
			}
			h.mu.RUnlock()
		}
	}
}
```

---

## Documentation

### Documentation for `Run` Function in `Hub`

**Purpose and Behavior:**
The `Run` function is a core component of the WebSocket hub, responsible for managing client connections and message broadcasting within a Go application. It runs indefinitely, handling three primary types of events:
1. Context cancellation (`ctx.Done()`): Closes all client send channels and removes clients from the hub.
2. Client registration: Adds new clients to the `clients` map and logs their connection.
3. Message broadcast: Sends messages to all connected clients, removing them if they are no longer readable.

**Key Implementation Details:**
- The function uses a goroutine to continuously handle events, ensuring non-blocking behavior.
- A mutex (`h.mu`) is used for thread-safe access to the `clients` map and send channels.
- Select statements manage concurrent operations efficiently.
- Context cancellation ensures graceful shutdown of clients when the hub stops.

**When/Why to Use:**
This code should be used in WebSocket server implementations where multiple clients need to be managed, and messages must be broadcasted efficiently. It handles context-driven shutdowns, ensuring that all clients are properly closed before exiting.

**Patterns and Gotchas:**
- The use of `select` statements is a Go idiom for handling multiple channels concurrently.
- Graceful client disconnection by closing send channels prevents resource leaks.
- The `ctx.Done()` channel ensures the hub can be cleanly shut down, making it suitable for production environments.

---

*Generated by CodeWorm on 2026-01-23 20:42*
