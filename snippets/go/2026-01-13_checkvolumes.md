# checkVolumes

**Repository:** stripe-referral
**File:** docksec/internal/analyzer/compose.go
**Language:** go
**Lines:** 170-228
**Complexity:** 10.0

---

## Source Code

```go
func (a *ComposeAnalyzer) checkVolumes(
	target finding.Target,
	serviceName string,
	node *yaml.Node,
) finding.Collection {
	var findings finding.Collection

	volumesNode := findNode(node, "volumes")
	if volumesNode == nil {
		return findings
	}

	for _, volNode := range volumesNode.Content {
		var hostPath string
		switch volNode.Kind {
		case yaml.ScalarNode:
			parts := strings.SplitN(volNode.Value, ":", 2)
			hostPath = parts[0]
		case yaml.MappingNode:
			sourceNode := findNode(volNode, "source")
			if sourceNode != nil {
				hostPath = sourceNode.Value
			}
		}

		if hostPath == "" {
			continue
		}

		if rules.IsDockerSocket(hostPath) {
			loc := &finding.Location{Path: a.path, Line: volNode.Line}
			f := finding.New("CIS-5.31", "Service '"+serviceName+"' mounts Docker socket", finding.SeverityCritical, target).
				WithDescription("Mounting Docker socket gives the container full control over the Docker daemon.").
				WithCategory(string(CategoryCompose)).
				WithLocation(loc).
				WithRemediation("Do not mount /var/run/docker.sock inside containers.")
			findings = append(findings, f)
			continue
		}

		if rules.IsSensitivePath(hostPath) {
			loc := &finding.Location{Path: a.path, Line: volNode.Line}
			severity := rules.GetPathSeverity(hostPath)
			pathInfo, _ := rules.GetPathInfo(hostPath)
			description := "Mounting sensitive host paths can enable container escape."
			if pathInfo.Description != "" {
				description = pathInfo.Description
			}
			f := finding.New("CIS-5.5", "Service '"+serviceName+"' mounts sensitive path: "+hostPath, severity, target).
				WithDescription(description).
				WithCategory(string(CategoryCompose)).
				WithLocation(loc).
				WithRemediation("Do not mount sensitive host directories. Use Docker volumes instead.")
			findings = append(findings, f)
		}
	}

	return findings
}
```

---

## Documentation

### Documentation for `checkVolumes` Function

**Purpose and Behavior:**
The `checkVolumes` function in the `ComposeAnalyzer` class examines Docker Compose files to identify potential security issues related to volume mounts. It checks if any volumes mount sensitive paths, particularly `/var/run/docker.sock`, which could grant containers full control over the Docker daemon.

**Key Implementation Details:**
1. **Node Traversal:** The function iterates through each volume node in the `volumes` section of a Compose file.
2. **Path Extraction:** It extracts the host path from scalar or mapping nodes, handling different formats for specifying source paths.
3. **Rule Evaluation:** Using predefined rules (`rules.IsDockerSocket`, `rules.IsSensitivePath`), it identifies and categorizes potential security risks.
4. **Finding Generation:** For identified issues, it creates detailed findings with descriptions, severities, categories, locations, and remediation advice.

**When/Why to Use:**
This function is crucial for security audits of Docker Compose files. It helps in identifying configurations that could lead to container escape or unauthorized access to critical system resources.

**Patterns/Gotchas:**
- **Error Handling:** While the code handles missing nodes gracefully, ensure robust error handling elsewhere.
- **Dynamic Rules:** The effectiveness depends on the accuracy and completeness of `rules.IsDockerSocket` and `rules.IsSensitivePath`.
- **Performance:** Iterating through complex YAML structures can be resource-intensive; consider optimizations for large files.

---

*Generated by CodeWorm on 2026-01-13 14:15*
