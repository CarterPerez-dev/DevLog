# NewTelemetry

**Repository:** fullstack-template
**File:** stacks/go-react/go-backend/internal/core/telemetry.go
**Language:** go
**Lines:** 30-101
**Complexity:** 8.0

---

## Source Code

```go
func NewTelemetry(
	ctx context.Context,
	otelCfg config.OtelConfig,
	appCfg config.AppConfig,
) (*Telemetry, error) {
	if !otelCfg.Enabled || otelCfg.Endpoint == "" {
		noopProvider := sdktrace.NewTracerProvider()
		return &Telemetry{
			TracerProvider: noopProvider,
			Tracer:         noopProvider.Tracer(otelCfg.ServiceName),
		}, nil
	}

	opts := []otlptracegrpc.Option{
		otlptracegrpc.WithEndpoint(otelCfg.Endpoint),
		otlptracegrpc.WithTimeout(5 * time.Second),
	}

	if otelCfg.Insecure {
		opts = append(
			opts,
			otlptracegrpc.WithTLSCredentials(insecure.NewCredentials()),
		)
	} else {
		opts = append(opts, otlptracegrpc.WithTLSCredentials(credentials.NewClientTLSFromCert(nil, "")))
	}

	exporter, err := otlptracegrpc.New(ctx, opts...)
	if err != nil {
		return nil, fmt.Errorf("create otlp exporter: %w", err)
	}

	res, err := resource.New(ctx,
		resource.WithAttributes(
			semconv.ServiceName(otelCfg.ServiceName),
			semconv.ServiceVersion(appCfg.Version),
			attribute.String("environment", appCfg.Environment),
		),
		resource.WithHost(),
		resource.WithProcess(),
	)
	if err != nil {
		return nil, fmt.Errorf("create resource: %w", err)
	}

	sampleRate := otelCfg.SampleRate
	if sampleRate <= 0 || sampleRate > 1 {
		sampleRate = 0.1
	}

	tp := sdktrace.NewTracerProvider(
		sdktrace.WithBatcher(exporter,
			sdktrace.WithBatchTimeout(5*time.Second),
			sdktrace.WithMaxExportBatchSize(512),
		),
		sdktrace.WithResource(res),
		sdktrace.WithSampler(sdktrace.ParentBased(
			sdktrace.TraceIDRatioBased(sampleRate),
		)),
	)

	otel.SetTracerProvider(tp)
	otel.SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(
		propagation.TraceContext{},
		propagation.Baggage{},
	))

	return &Telemetry{
		TracerProvider: tp,
		Tracer:         tp.Tracer(otelCfg.ServiceName),
	}, nil
}
```

---

## Documentation

### Documentation for `NewTelemetry` Function

**Purpose and Behavior:**
The `NewTelemetry` function initializes a telemetry system using OpenTelemetry (OTel) in Go. It configures the tracer provider based on provided configuration settings, enabling or disabling tracing depending on the `otelCfg.Enabled` flag. If enabled, it sets up an OTLP exporter with optional TLS credentials and creates a resource with attributes like service name and version.

**Key Implementation Details:**
- **Conditional Tracing:** The function checks if tracing is enabled and configures a no-op tracer provider if not.
- **Exporter Configuration:** It sets up an OTLP exporter with the specified endpoint and timeout, handling secure or insecure connections.
- **Resource Creation:** A resource object is created with service name, version, and environment attributes.
- **Batching and Sampling:** The tracer provider uses batch exporting with a timeout and maximum batch size. Tracing is sampled based on the provided sample rate.

**When/Why to Use:**
Use this function when integrating OpenTelemetry tracing into your Go application for monitoring and debugging purposes. It simplifies setting up tracing, especially in distributed systems where you need detailed trace data.

**Patterns/Gotchas:**
- **Error Handling:** The function returns an error if any step fails, ensuring robustness.
- **Resource Attributes:** Ensure that `appCfg` is properly initialized with version and environment details to avoid errors.
- **Sample Rate Default:** If the sample rate is not provided or out of bounds, a default value of 0.1 is used.

This function adheres to Go idioms by using context for lifecycle management and error handling best practices.

---

*Generated by CodeWorm on 2026-01-14 15:56*
