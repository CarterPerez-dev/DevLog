# checkEnvironment

**Type:** Documentation
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/intermediate/docker-security-audit/internal/analyzer/compose.go
**Language:** go
**Lines:** 396-478
**Complexity:** 16.0

---

## Source Code

```go
func (a *ComposeAnalyzer) checkEnvironment(
	target finding.Target,
	serviceName string,
	node *yaml.Node,
) finding.Collection {
	var findings finding.Collection

	envNode := findNode(node, "environment")
	if envNode == nil {
		return findings
	}

	if envNode.Kind == yaml.MappingNode {
		for i := 0; i < len(envNode.Content); i += 2 {
			if i+1 >= len(envNode.Content) {
				break
			}
			keyNode := envNode.Content[i]
			valueNode := envNode.Content[i+1]

			if rules.IsSensitiveEnvName(keyNode.Value) &&
				valueNode.Value != "" {
				if !isVariableReference(valueNode.Value) {
					loc := &finding.Location{Path: a.path, Line: keyNode.Line}
					f := finding.New("CIS-4.10", "Service '"+serviceName+"' has sensitive variable '"+keyNode.Value+"' with hardcoded value", finding.SeverityHigh, target).
						WithDescription("Hardcoding secrets in compose files exposes them in version control.").
						WithCategory(string(CategoryCompose)).
						WithLocation(loc).
						WithRemediation("Use environment variable substitution: ${" + keyNode.Value + "} or Docker secrets.")
					findings = append(findings, f)
				}
			}

			secrets := rules.DetectSecrets(valueNode.Value)
			for _, secret := range secrets {
				loc := &finding.Location{Path: a.path, Line: valueNode.Line}
				f := finding.New("CIS-4.10", "Service '"+serviceName+"' may contain "+string(secret.Type)+" in environment", finding.SeverityHigh, target).
					WithDescription(secret.Description + " detected in environment variable.").
					WithCategory(string(CategoryCompose)).
					WithLocation(loc).
					WithRemediation("Remove secrets from compose file. Use Docker secrets or external secret management.")
				findings = append(findings, f)
			}
		}
	} else if envNode.Kind == yaml.SequenceNode {
		for _, itemNode := range envNode.Content {
			parts := strings.SplitN(itemNode.Value, "=", 2)
			if len(parts) < 2 {
				continue
			}
			varName := parts[0]
			varValue := parts[1]

			if rules.IsSensitiveEnvName(varName) && varValue != "" {
				if !isVariableReference(varValue) {
					loc := &finding.Location{
						Path: a.path,
						Line: itemNode.Line,
					}
					f := finding.New("CIS-4.10", "Service '"+serviceName+"' has sensitive variable '"+varName+"' with hardcoded value", finding.SeverityHigh, target).
						WithDescription("Hardcoding secrets in compose files exposes them in version control.").
						WithCategory(string(CategoryCompose)).
						WithLocation(loc).
						WithRemediation("Use environment variable substitution: ${" + varName + "} or Docker secrets.")
					findings = append(findings, f)
				}
			}

			secrets := rules.DetectSecrets(varValue)
			for _, secret := range secrets {
				loc := &finding.Location{Path: a.path, Line: itemNode.Line}
				f := finding.New("CIS-4.10", "Service '"+serviceName+"' may contain "+string(secret.Type)+" in environment", finding.SeverityHigh, target).
					WithDescription(secret.Description + " detected in environment variable.").
					WithCategory(string
```

---

## Documentation

### Documentation for `checkEnvironment` Function

**Purpose and Behavior:**
The `checkEnvironment` function in the `ComposeAnalyzer` struct examines a Docker Compose file's environment section to identify potential security issues, such as hardcoded secrets and sensitive variables. It returns a collection of findings that highlight these vulnerabilities.

**Key Implementation Details:**
- The function iterates through the "environment" node in a YAML document, checking for mapping or sequence nodes.
- For each key-value pair, it uses `rules.IsSensitiveEnvName` to determine if the variable name is sensitive and whether its value is hardcoded.
- It appends findings with high severity, detailing potential risks and suggesting remediations like using environment variable substitution or Docker secrets.

**When/Why to Use This Code:**
This code should be used in security audits of Docker Compose files. Hardcoded secrets can lead to version control exposure and other security issues. By identifying these vulnerabilities early, developers can improve the security posture of their applications.

**Patterns and Gotchas:**
- The function handles both mapping and sequence nodes, ensuring comprehensive coverage.
- It relies on external `rules.IsSensitiveEnvName` and `rules.DetectSecrets` functions for sensitive variable detection, which must be correctly implemented.
- Be cautious with line number handling; incorrect location information can mislead developers.

---

*Generated by CodeWorm on 2026-02-18 20:26*
