# CountByField

**Repository:** angelamos-operations
**File:** CertGamesDB-Argos/go-backend/internal/handler/collections.go
**Language:** go
**Lines:** 195-242
**Complexity:** 10.0

---

## Source Code

```go
func (h *CollectionsHandler) CountByField(w http.ResponseWriter, r *http.Request) {
	name := chi.URLParam(r, "name")
	dbName := r.URL.Query().Get("database")
	if dbName == "" {
		dbName = h.database
	}

	field := r.URL.Query().Get("field")
	if field == "" {
		core.BadRequest(w, "field query parameter is required")
		return
	}

	value := r.URL.Query().Get("value")
	if value == "" {
		core.BadRequest(w, "value query parameter is required")
		return
	}

	var queryValue any = value

	if v, err := strconv.ParseInt(value, 10, 64); err == nil {
		queryValue = v
	} else if v, err := strconv.ParseFloat(value, 64); err == nil {
		queryValue = v
	} else if value == "true" {
		queryValue = true
	} else if value == "false" {
		queryValue = false
	} else if value == "null" {
		queryValue = nil
	}

	count, err := h.repo.CountByFieldValue(r.Context(), dbName, name, field, queryValue)
	if err != nil {
		core.InternalServerError(w, err)
		return
	}

	response := CountResponse{
		Collection: name,
		Field:      field,
		Value:      queryValue,
		Count:      count,
	}

	core.OK(w, response)
}
```

---

## Documentation

### Documentation for `CountByField` Function

**Purpose and Behavior:**
The `CountByField` function in the `CollectionsHandler` struct handles HTTP requests to count documents in a specified collection based on a field's value. It extracts query parameters from the request URL, validates them, converts string values to appropriate types (integer, float, boolean, or nil), and invokes the repository method to perform the count operation.

**Key Implementation Details:**
- **Parameter Extraction:** The function retrieves `name`, `database`, `field`, and `value` from the URL parameters.
- **Error Handling:** It checks for required query parameters and returns a 400 Bad Request if any are missing. Errors during value conversion or repository calls result in a 500 Internal Server Error.
- **Value Conversion:** The function attempts to convert string values to integers, floats, booleans, or nil using `strconv` package functions.

**When/Why to Use This Code:**
Use this code when you need to count documents in collections based on specific field values. It handles various data types and ensures robust error handling, making it suitable for production environments where reliability is crucial.

**Patterns and Gotchas:**
- **Error Handling:** The function uses `core.BadRequest` and `core.InternalServerError` for consistent error responses.
- **Type Conversion:** The dynamic type conversion logic can be complex; ensure thorough testing with various input types to avoid bugs.

---

*Generated by CodeWorm on 2026-01-23 17:37*
