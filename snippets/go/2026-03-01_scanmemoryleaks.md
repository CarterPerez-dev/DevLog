# ScanMemoryLeaks

**Type:** Documentation
**Repository:** Yoshi-Audit
**File:** internal/audit/scanner.go
**Language:** go
**Lines:** 165-197
**Complexity:** 7.0

---

## Source Code

```go
func (s *Scanner) ScanMemoryLeaks(procs []system.ProcessInfo, history map[int][]uint64) []Finding {
	nameMap := make(map[int]string)
	for _, p := range procs {
		nameMap[p.PID] = p.Name
	}

	const threshold = 100 * 1024 * 1024

	var findings []Finding
	for pid, readings := range history {
		if len(readings) < 2 {
			continue
		}
		first := readings[0]
		last := readings[len(readings)-1]
		if last > first && (last-first) > threshold {
			grewMiB := (last - first) / (1024 * 1024)
			name := nameMap[pid]
			if name == "" {
				name = fmt.Sprintf("pid-%d", pid)
			}
			findings = append(findings, Finding{
				Type:     FindingMemoryLeak,
				Severity: SeverityWarn,
				PID:      pid,
				Name:     name,
				Message:  fmt.Sprintf("Process grew %d MiB in %d readings", grewMiB, len(readings)),
				Detail:   fmt.Sprintf("first: %d bytes, last: %d bytes", first, last),
			})
		}
	}
	return findings
}
```

---

## Documentation

### Documentation for `ScanMemoryLeaks` Function

**Purpose and Behavior:**
The `ScanMemoryLeaks` function in the `Scanner` struct analyzes historical memory usage data of processes to detect potential memory leaks. It compares recent memory readings with older ones, flagging processes that have significantly increased their memory usage over time.

**Key Implementation Details:**
- The function takes a slice of `ProcessInfo` and a map of historical memory readings as inputs.
- It uses a name mapping for process IDs to improve readability in findings.
- A threshold is defined to determine significant memory growth, measured in MiB.
- Findings are collected if the last reading exceeds the first by more than the threshold.

**When/Why to Use:**
This function should be used during system audits or performance monitoring to identify processes that might be leaking memory. It helps in proactive maintenance and troubleshooting by highlighting suspicious behavior early.

**Patterns/Gotchas:**
- Ensure `history` map is properly populated with accurate readings.
- The threshold value may need tuning based on the specific environment's normal memory usage patterns.
- The function assumes all process IDs in history have corresponding names, which could lead to missing data if not handled.

---

*Generated by CodeWorm on 2026-03-01 00:02*
