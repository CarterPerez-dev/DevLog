# checkAddInstruction

**Repository:** stripe-referral
**File:** docksec/internal/analyzer/dockerfile.go
**Language:** go
**Lines:** 159-205
**Complexity:** 11.0

---

## Source Code

```go
func (a *DockerfileAnalyzer) checkAddInstruction(
	target finding.Target,
	ast *parser.Node,
) finding.Collection {
	var findings finding.Collection

	for _, node := range ast.Children {
		if strings.ToUpper(node.Value) == "ADD" {
			src := ""
			if node.Next != nil {
				src = node.Next.Value
			}

			isURL := strings.HasPrefix(src, "http://") ||
				strings.HasPrefix(src, "https://")
			isArchive := strings.HasSuffix(src, ".tar") ||
				strings.HasSuffix(src, ".tar.gz") ||
				strings.HasSuffix(src, ".tgz") ||
				strings.HasSuffix(src, ".tar.bz2")

			if !isURL && !isArchive {
				control, _ := benchmark.Get("4.9")
				loc := &finding.Location{Path: a.path, Line: node.StartLine}
				f := finding.New("CIS-4.9", control.Title, finding.SeverityLow, target).
					WithDescription(control.Description).
					WithCategory(string(CategoryDockerfile)).
					WithLocation(loc).
					WithRemediation(control.Remediation).
					WithReferences(control.References...).
					WithCISControl(control.ToCISControl())
				findings = append(findings, f)
			}

			if isURL {
				loc := &finding.Location{Path: a.path, Line: node.StartLine}
				f := finding.New("DS-ADD-URL", "ADD instruction fetches from URL", finding.SeverityMedium, target).
					WithDescription("ADD with URLs can introduce security risks. Use curl/wget with verification instead.").
					WithCategory(string(CategoryDockerfile)).
					WithLocation(loc).
					WithRemediation("Use RUN with curl or wget and verify checksums of downloaded files.")
				findings = append(findings, f)
			}
		}
	}

	return findings
}
```

---

## Documentation

### Documentation for `checkAddInstruction` Function

**Purpose and Behavior:**
The `checkAddInstruction` function in the DockerfileAnalyzer checks for potential security issues related to the "ADD" instruction in a Dockerfile. It identifies if an ADD instruction is used with local files or URLs, categorizing them based on their risk level.

**Key Implementation Details:**
- The function iterates over the children of a parsed AST node representing the Dockerfile.
- For each "ADD" instruction, it checks if the source is a URL or an archive file. If not, it adds a low-severity finding indicating potential security risks due to local files.
- If the source is a URL, it categorizes the finding as medium severity and suggests using `curl`/`wget` with verification.

**When/Why to Use:**
This function should be used in security analysis tools for Dockerfiles. It helps identify insecure practices like adding files from untrusted sources or local files that could contain vulnerabilities.

**Patterns/Gotchas:**
- The function uses string matching to determine if a source is a URL or an archive, which may not cover all edge cases.
- Error handling is minimal; the `Get` call assumes it always returns valid data. Ensure robust error handling in production use.
- The function relies on external controls (`benchmark.Get`) for descriptions and remediations, so these must be correctly configured.

---

*Generated by CodeWorm on 2026-01-12 18:26*
