# scanStaged

**Type:** Documentation
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/intermediate/secrets-scanner/internal/source/git.go
**Language:** go
**Lines:** 73-135
**Complexity:** 16.0

---

## Source Code

```go
func (g *Git) scanStaged(
	ctx context.Context,
	repo *git.Repository,
	out chan<- types.Chunk,
) error {
	wt, err := repo.Worktree()
	if err != nil {
		return fmt.Errorf("worktree: %w", err)
	}

	status, err := wt.Status()
	if err != nil {
		return fmt.Errorf("status: %w", err)
	}

	idx, err := repo.Storer.Index()
	if err != nil {
		return fmt.Errorf("index: %w", err)
	}

	for _, entry := range idx.Entries {
		if ctx.Err() != nil {
			return ctx.Err()
		}

		fileStatus := status.File(entry.Name)
		if fileStatus.Staging == git.Unmodified &&
			fileStatus.Worktree == git.Unmodified {
			continue
		}

		if g.isExcluded(entry.Name) || isBinaryExt(entry.Name) {
			continue
		}

		blob, blobErr := repo.BlobObject(entry.Hash)
		if blobErr != nil {
			continue
		}

		if blob.Size > g.MaxSize {
			continue
		}

		content, readErr := readBlob(blob)
		if readErr != nil {
			continue
		}

		chunks := splitIntoChunks(
			content, entry.Name, "", "", time.Time{},
		)
		for _, chunk := range chunks {
			select {
			case <-ctx.Done():
				return ctx.Err()
			case out <- chunk:
			}
		}
	}

	return nil
}
```

---

## Documentation

### Documentation for `scanStaged` Function

**Purpose and Behavior:**
The `scanStaged` function scans files staged in a Git repository, filtering out unmodified files, excluded files, and large binary files. It then splits the content into chunks and sends them to an output channel.

**Key Implementation Details:**
- **Context Handling:** The function uses context cancellation to stop processing early if the operation is canceled.
- **Status and Index Retrieval:** It retrieves the worktree status and index entries from the repository.
- **File Filtering:** Files are filtered based on their status, exclusion criteria, and size.
- **Blob Reading:** Blobs are read and split into chunks before being sent to the output channel.

**When/Why to Use:**
This function is useful for scanning staged files in a Git repository for potential secrets or other sensitive information. It can be employed in scenarios where you need to analyze changes before committing them, ensuring that no large binary files or uninteresting files are processed unnecessarily.

**Patterns and Gotchas:**
- **Error Handling:** The function handles errors gracefully by returning early from the loop.
- **Context Cancellation:** Properly uses context cancellation to stop processing early if needed.
- **Resource Management:** Ensures efficient resource usage by filtering out large binary files before reading them.

---

*Generated by CodeWorm on 2026-02-20 07:17*
