# FetchVersions

**Repository:** Cybersecurity-Projects
**File:** PROJECTS/beginner/simple-vulnerability-scanner/internal/pypi/client.go
**Language:** go
**Lines:** 76-137
**Complexity:** 12.0

---

## Source Code

```go
func (c *Client) FetchVersions(
	ctx context.Context,
	name string,
) ([]string, error) {
	normalized := NormalizeName(name)

	entry, hit := c.cache.Get(normalized)
	if hit && c.cache.IsFresh(entry) {
		return entry.Versions, nil
	}

	url := simpleAPIBase + normalized + "/"
	req, err := http.NewRequestWithContext(
		ctx, http.MethodGet, url, nil,
	)
	if err != nil {
		return nil, fmt.Errorf("build request for %s: %w", name, err)
	}
	req.Header.Set("Accept", simpleAPIAccept)
	req.Header.Set("User-Agent", c.userAgent)

	if entry != nil && entry.ETag != "" {
		req.Header.Set("If-None-Match", entry.ETag)
	}

	resp, err := c.doWithRetry(ctx, req)
	if err != nil {
		if entry != nil {
			return entry.Versions, nil
		}
		return nil, fmt.Errorf("fetch %s: %w", name, err)
	}
	defer func() { _ = resp.Body.Close() }() //nolint:errcheck

	switch resp.StatusCode {
	case http.StatusNotModified:
		c.cache.Touch(normalized)
		return entry.Versions, nil

	case http.StatusNotFound:
		return nil, fmt.Errorf(
			"package %q not found on PyPI", name,
		)

	case http.StatusOK:
		var result simpleAPIResponse
		if err := json.NewDecoder(resp.Body).Decode(&result); err != nil {
			return nil, fmt.Errorf("decode %s: %w", name, err)
		}
		_ = c.cache.Set(normalized, &CacheEntry{ //nolint:errcheck
			ETag:     resp.Header.Get("ETag"),
			Versions: result.Versions,
			CachedAt: time.Now(),
		})
		return result.Versions, nil

	default:
		return nil, fmt.Errorf(
			"PyPI returned %d for %s", resp.StatusCode, name,
		)
	}
}
```

---

## Documentation

### Documentation for `FetchVersions` Function

**Purpose and Behavior:**
The `FetchVersions` function in the Go code fetches version information for a given package name from PyPI (Python Package Index). It first checks if the data is available in a local cache. If not, it makes an HTTP GET request to retrieve the latest versions, handling retries and caching responses.

**Key Implementation Details:**
- **Context Handling:** Uses `context.Context` for request cancellation.
- **Cache Management:** Utilizes a cache mechanism (`c.cache`) to store and retrieve package data, ensuring efficient repeated queries.
- **HTTP Request Customization:** Sets appropriate headers like `Accept`, `User-Agent`, and `If-None-Match` based on cached entries.
- **Error Handling:** Implements error handling for request creation, HTTP response processing, and JSON decoding. Retries failed requests using a custom retry mechanism (`c.doWithRetry`).

**When/Why to Use:**
This function should be used in scenarios where version information of Python packages needs to be fetched efficiently, leveraging caching to reduce network calls. It is particularly useful for tools that require frequent package updates or dependency checks.

**Patterns and Gotchas:**
- **Error Propagation:** Errors are propagated using `fmt.Errorf`, ensuring clear error messages.
- **Resource Management:** Properly closes the HTTP response body with a deferred function, avoiding resource leaks.
- **Cache Freshness:** Ensures cache entries are refreshed only when necessary by checking `http.StatusNotModified`.

This implementation adheres to Go idioms and best practices, making it robust for real-world applications.

---

*Generated by CodeWorm on 2026-01-29 07:39*
