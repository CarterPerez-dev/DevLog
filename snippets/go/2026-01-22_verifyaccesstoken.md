# VerifyAccessToken

**Repository:** fullstack-template
**File:** stacks/go-react/go-backend/internal/auth/jwt.go
**Language:** go
**Lines:** 160-225
**Complexity:** 10.0

---

## Source Code

```go
func (m *JWTManager) VerifyAccessToken(
	ctx context.Context,
	tokenString string,
) (*middleware.AccessTokenClaims, error) {
	token, err := jwt.Parse(
		[]byte(tokenString),
		jwt.WithKey(jwa.ES256(), m.publicKey),
		jwt.WithValidate(true),
		jwt.WithIssuer(m.config.Issuer),
		jwt.WithAudience(m.config.Audience),
	)
	if err != nil {
		if isTokenExpiredError(err) {
			return nil, fmt.Errorf("verify token: %w", core.ErrTokenExpired)
		}
		return nil, fmt.Errorf("verify token: %w", core.ErrTokenInvalid)
	}

	var tokenType string
	if err := token.Get("type", &tokenType); err != nil ||
		tokenType != "access" {
		return nil, fmt.Errorf(
			"verify token: invalid token type: %w",
			core.ErrTokenInvalid,
		)
	}

	subject, ok := token.Subject()
	if !ok || subject == "" {
		return nil, fmt.Errorf(
			"verify token: missing subject: %w",
			core.ErrTokenInvalid,
		)
	}

	var roleStr string
	if err := token.Get("role", &roleStr); err != nil {
		return nil, fmt.Errorf(
			"verify token: missing role claim: %w",
			core.ErrTokenInvalid,
		)
	}

	var tierStr string
	if err := token.Get("tier", &tierStr); err != nil {
		return nil, fmt.Errorf(
			"verify token: missing tier claim: %w",
			core.ErrTokenInvalid,
		)
	}

	var versionFloat float64
	if err := token.Get("token_version", &versionFloat); err != nil {
		return nil, fmt.Errorf(
			"verify token: missing token_version claim: %w",
			core.ErrTokenInvalid,
		)
	}

	return &middleware.AccessTokenClaims{
		UserID:       subject,
		Role:         roleStr,
		Tier:         tierStr,
		TokenVersion: int(versionFloat),
	}, nil
}
```

---

## Documentation

### Documentation for `VerifyAccessToken` Function

**Purpose and Behavior:**
The `VerifyAccessToken` function in the JWTManager struct verifies an access token by parsing it, validating its claims, and extracting relevant information such as user ID, role, tier, and version. It returns a pointer to `middleware.AccessTokenClaims` if successful or an error otherwise.

**Key Implementation Details:**
- **Error Handling:** The function uses Go's idiomatic error handling with `fmt.Errorf` for custom error messages.
- **JWT Parsing:** It parses the token using the `jwt.Parse` method, specifying validation rules like key type and issuer.
- **Claim Validation:** It checks if the token is of type "access," has a non-empty subject, and contains required claims (role, tier, token_version).
- **Return Values:** On success, it returns a populated `middleware.AccessTokenClaims` struct; on failure, it returns an error.

**When/Why to Use:**
Use this function when you need to validate access tokens in your Go backend. It ensures that only valid and correctly formatted access tokens are accepted, providing necessary user information for authorization purposes.

**Patterns/Gotchas:**
- Ensure `m.publicKey` is properly set before calling this method.
- The function assumes the presence of specific claims (`type`, `role`, `tier`, `token_version`). Missing or incorrect claims will result in errors.
- Error handling is crucial; custom error types like `core.ErrTokenExpired` and `core.ErrTokenInvalid` should be defined elsewhere.

---

*Generated by CodeWorm on 2026-01-22 00:02*
