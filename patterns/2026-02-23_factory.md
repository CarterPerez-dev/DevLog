# factory

**Type:** Pattern Analysis
**Repository:** fullstack-template
**File:** stacks/fastapi-react/backend/app/factory.py
**Language:** python
**Lines:** 1-135
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025
factory.py
"""

from collections.abc import AsyncIterator
from contextlib import asynccontextmanager

from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from slowapi import _rate_limit_exceeded_handler
from slowapi.errors import RateLimitExceeded

from config import settings, API_PREFIX
from core.database import sessionmanager
from core.exceptions import BaseAppException
from core.logging import configure_logging
from core.rate_limit import limiter
from middleware.correlation import CorrelationIdMiddleware
from core.common_schemas import AppInfoResponse
from core.health_routes import router as health_router
from user.routes import router as user_router
from auth.routes import router as auth_router
from admin.routes import router as admin_router
from it_was_never_real import register_psyop_handler


@asynccontextmanager
async def lifespan(app: FastAPI) -> AsyncIterator[None]:
    """
    Application lifespan handler for startup and shutdown
    """
    configure_logging()
    sessionmanager.init(str(settings.DATABASE_URL))
    yield
    await sessionmanager.close()


OPENAPI_TAGS = [
    {
        "name": "root",
        "description": "API information"
    },
    {
        "name": "health",
        "description": "Health check endpoints"
    },
    {
        "name": "auth",
        "description": "Authentication and authorization"
    },
    {
        "name": "users",
        "description": "User registration and profile management"
    },
    {
        "name": "admin",
        "description": "Admin only operations"
    },
]


def create_app() -> FastAPI:
    """
    Application factory
    """
    app = FastAPI(
        title = settings.APP_NAME,
        summary = settings.APP_SUMMARY,
        description = settings.APP_DESCRIPTION,
        version = settings.APP_VERSION,
        contact = {
            "name": settings.APP_CONTACT_NAME,
            "email": settings.APP_CONTACT_EMAIL,
        },
        license_info = {
            "name": settings.APP_LICENSE_NAME,
            "url": settings.APP_LICENSE_URL,
        },
        openapi_tags = OPENAPI_TAGS,
        openapi_version = "3.1.0",
        lifespan = lifespan,
        root_path = "/api",
        openapi_url = "/openapi.json",
        docs_url = "/docs",
        redoc_url = "/redoc",
    )

    app.add_middleware(CorrelationIdMiddleware)
    app.add_middleware(
        CORSMiddleware,
        allow_origins = settings.CORS_ORIGINS,
        allow_credentials = settings.CORS_ALLOW_CREDENTIALS,
        allow_methods = settings.CORS_ALLOW_METHODS,
        allow_headers = settings.CORS_ALLOW_HEADERS,
    )

    app.state.limiter = limiter
    app.add_exception_handler(
        RateLimitExceeded,
        _rate_limit_exceeded_handler
    )

    @app.exception_handler(BaseAppException)
    async def app_exception_handler(
        request: Request,
        exc: BaseAppException,
    ) -> JSONRes
```

---

## Pattern Analysis

### Pattern Analysis

**Pattern Used:** Factory Method

The `create_app` function in `factory.py` acts as a factory method for creating an instance of `FastAPI`. This function initializes and configures various components such as middleware, exception handlers, routers, and database sessions. 

#### Implementation Details:
- The `create_app` function takes no arguments and returns a configured `FastAPI` application.
- It sets up the application with necessary configurations like title, version, middleware, rate limiting, and exception handling.
- It includes multiple routers for different functionalities (health checks, authentication, admin operations) using the `include_router` method.

#### Benefits:
1. **Modularity:** The factory method allows modular setup of the FastAPI app by separating configuration from application logic.
2. **Reusability:** The same factory function can be used to create multiple instances of the app with different configurations if needed.
3. **Maintainability:** Centralizing the creation and configuration process makes it easier to manage and update the app.

#### Deviations:
- The `lifespan` context manager is directly assigned as a parameter to the `FastAPI` instance, which is an uncommon deviation from the standard pattern where `lifespan` might be defined separately.
- The function includes multiple exception handlers and routers, making it somewhat complex but still adhering to the factory method principle.

#### Appropriateness:
This pattern is highly appropriate for FastAPI applications that require a structured setup with middleware, exception handling, and multiple router configurations. It ensures that all necessary components are initialized correctly before the application starts serving requests.

---

*Generated by CodeWorm on 2026-02-23 23:13*
