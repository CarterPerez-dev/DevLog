# factory

**Type:** Pattern Analysis
**Repository:** CertGames-Core
**File:** backend/api/domains/account/services/oauth.py
**Language:** python
**Lines:** 1-353
**Complexity:** 0.0

---

## Source Code

```python
"""
OAuth Service - OAuth operations and user creation
/api/domains/account/services/oauth.py
"""

import secrets
from typing import Any
from settings import Security
from mongoengine import (
    ValidationError as MongoValidationError,
    NotUniqueError,
)

from api.core.validation.exceptions import (
    ValidationError,
    DatabaseError,
)
from api.core.services.logging import AuditLogger

from .auth import AuthService
from ..models.User import User


class OAuthService:
    """
    Service class for OAuth operations
    """
    @staticmethod
    def generate_unique_username(base_username: str) -> str:
        """
        Generate a unique username based on the base username.
        Used for OAuth registration.
        """
        cleaned_username: str = "".join(
            c for c in base_username if c.isalnum() or c in ["_", "-"]
        )

        if len(cleaned_username) < 3:
            cleaned_username = f"user_{cleaned_username}"

        if not User.objects(username = cleaned_username).first():
            return cleaned_username

        for i in range(1, 1000):
            candidate: str = f"{cleaned_username}{i}"
            if not User.objects(username = candidate).first():
                return candidate

        random_suffix: str = secrets.token_hex(4)
        return f"{cleaned_username}_{random_suffix}"

    @staticmethod
    def create_oauth_user(
        email: str,
        name: str | None = None,
        provider: str | None = None,
        provider_id: str | None = None,
    ) -> User:
        """
        Create a new user via OAuth with all necessary setup
        """
        try:
            base_username: str = email.split("@")[0]
            username: str = OAuthService.generate_unique_username(
                base_username
            )

            secure_password: str = secrets.token_urlsafe(
                Security.TOKEN_LENGTH
            )

            new_user: User = User(
                username = username,
                email = email,
                password = secure_password,
                oauth_provider = provider,
                needs_username = True,
            )

            if provider == "google" and provider_id:
                new_user.google_id = provider_id
            elif provider == "apple" and provider_id:
                new_user.apple_id = provider_id
            elif provider == "github" and provider_id:
                new_user.github_id = provider_id

            if name:
                name_parts: list[str] = name.split(" ", 1)
                if len(name_parts) > 1:
                    new_user.first_name = name_parts[0]
                    new_user.last_name = name_parts[1]
                else:
                    new_user.first_name = name

            new_user.save()

            AuthService.auto_equip_default_avatar(new_user)

            AuditLogger.log_action(
                "user_created",
                user_id = str(new_user.id),
                data = {
    
```

---

## Pattern Analysis

### Pattern Analysis

**Pattern Used:** Factory Method

The `OAuthService` class implements a factory method pattern through its static methods `create_oauth_user` and `link_oauth_provider`. The `create_oauth_user` method acts as a factory, responsible for creating new user objects based on OAuth data. It generates unique usernames, sets up secure passwords, and handles various provider-specific details.

**Benefits:**
- **Encapsulation:** The creation logic is encapsulated within the `OAuthService`, making it easier to manage and extend.
- **Flexibility:** Different providers can be handled with minimal changes by adding new conditions in the factory method.
- **Error Handling:** Centralized error handling ensures consistent behavior when creating or linking users.

**Deviations:**
- The pattern is slightly modified. Typically, a factory method returns an object of the same type (or subtype) as its input parameters. Here, `create_oauth_user` returns a `User` instance, while `link_oauth_provider` does not return anything.
- The `link_oauth_provider` method is incomplete and lacks implementation details.

**Appropriateness:**
This pattern is appropriate for scenarios where you need to create objects based on different input types or conditions. It provides a clean separation of concerns by centralizing the creation logic in one place, making it easier to manage and extend as new providers are added. However, the `link_oauth_provider` method should be completed to ensure full functionality and consistency with the factory pattern.

---

*Generated by CodeWorm on 2026-02-23 11:52*
