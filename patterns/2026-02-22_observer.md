# observer

**Type:** Pattern Analysis
**Repository:** CertGames-Core
**File:** backend/app/clients/webhooks.py
**Language:** python
**Lines:** 1-320
**Complexity:** 0.0

---

## Source Code

```python
"""
Webhook Handler Configuration
/app/clients/webhooks.py
---
Future iOS Admin App Push Notification System
"""

import requests
from enum import Enum
from typing import Any, Optional
from datetime import datetime, UTC
from flask import Flask, current_app


class NotificationType(Enum):
    """
    Notification types for iOS admin app
    """
    SECURITY_ALERT = "security_alert"
    NEW_SUBSCRIPTION = "new_subscription"
    SUBSCRIPTION_CANCELLED = "subscription_cancelled"
    PAYMENT_FAILED = "payment_failed"
    HIGH_ERROR_RATE = "high_error_rate"
    PERFORMANCE_DEGRADATION = "performance_degradation"
    NEW_USER_SIGNUP = "new_user_signup"
    SUPPORT_TICKET = "support_ticket"
    DAILY_SUMMARY = "daily_summary"
    SUSPICIOUS_ACTIVITY = "suspicious_activity"


class AdminNotificationService:
    """
    Service to send push notifications to iOS Admin App
    Future implementation for my custom admin panel iOS app
    """
    def __init__(self, webhook_url: str, api_key: str = None):
        self.webhook_url = webhook_url
        self.api_key = api_key
        self.enabled = bool(webhook_url)

    def send_notification(
        self,
        notification_type: NotificationType,
        title: str,
        message: str,
        *,
        priority: str = "normal",
        data: dict[str,
                   Any] = None,
        badge_increment: int = 1
    ) -> bool:
        """
        Send notification to iOS admin app
        """
        if not self.enabled:
            return False

        payload = {
            "type": notification_type.value,
            "title": title,
            "body": message,
            "priority": priority,
            "timestamp": datetime.now(UTC).isoformat(),
            "badge_increment": badge_increment,
            "data": data or {},
            "sound":
            "critical.caf" if priority == "critical" else "default"
        }

        headers = {
            "Content-Type": "application/json",
        }

        if self.api_key:
            headers["Authorization"] = f"Bearer {self.api_key}"

        try:
            response = requests.post(
                self.webhook_url,
                json = payload,
                headers = headers,
                timeout = 5
            )
            return response.status_code in [200, 201, 204]
        except Exception as e:  # pylint: disable=broad-exception-caught
            current_app.logger.error(
                "Failed to send admin notification: %s",
                str(e)
            )
            return False


admin_notifier: Optional[AdminNotificationService] = None


def setup_webhooks(app: Flask) -> None:
    """
    Initialize webhook handlers for iOS admin app
    """
    global admin_notifier  # pylint: disable=global-statement

    ios_webhook_url = app.config.get("IOS_ADMIN_WEBHOOK_URL")
    ios_api_key = app.config.get("IOS_ADMIN_API_KEY")

    if ios_webhook_url:
        admin_notifier = AdminNotificationService(
            ios_w
```

---

## Pattern Analysis

### Pattern Analysis

**Pattern Used:** Observer

The `AdminNotificationService` class in the provided code acts as a subject, while the functions `notify_security_alert`, `notify_subscription_event`, and `notify_error_threshold` act as observers. The `setup_webhooks` function initializes the observer by setting up an instance of `AdminNotificationService`.

**How Implemented:**
- **Subject (`AdminNotificationService`):** This class has a method `send_notification` that can be called to send notifications.
- **Observers:** Functions like `notify_security_alert`, `notify_subscription_event`, and `notify_error_threshold` call the `send_notification` method when specific events occur.

**Benefits:**
1. **Decoupling:** The observer pattern decouples the subject from its observers, allowing for flexible event handling without tight coupling.
2. **Modularity:** New types of notifications can be added by simply creating new functions that call `send_notification`.

**Deviations:**
- The global variable `admin_notifier` is used to hold the instance of `AdminNotificationService`. This breaks encapsulation and violates the single responsibility principle, as it mixes configuration with notification logic.
- Broad exception handling in `send_notification` without specific error logging or recovery mechanisms.

**Appropriateness:**
This pattern is appropriate when you need to notify multiple components about events. However, the use of a global variable suggests that better design principles like dependency injection could be applied for improved maintainability and testability.

---

*Generated by CodeWorm on 2026-02-22 14:57*
