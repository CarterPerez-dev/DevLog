# factory

**Type:** Pattern Analysis
**Repository:** stripe-referral
**File:** src/stripe_referral/database/Session.py
**Language:** python
**Lines:** 1-71
**Complexity:** 0.0

---

## Source Code

```python
"""
ⒸAngelaMos | 2025 | CertGames.com
SQLAlchemy session factory and context manager
"""

from collections.abc import Generator
from contextlib import contextmanager

from sqlalchemy import Engine, create_engine
from sqlalchemy.orm import Session, sessionmaker

from ..config.constants import (
    DATABASE_CONNECTION_MAX_OVERFLOW,
    DATABASE_CONNECTION_POOL_SIZE,
    DATABASE_CONNECTION_TIMEOUT_SECONDS,
)
from ..config.enums import Environment
from ..config.settings import settings


engine: Engine | None
SessionLocal: sessionmaker[Session] | None

if settings.database_url:
    engine = create_engine(
        settings.database_url,
        pool_pre_ping = True,
        pool_size = DATABASE_CONNECTION_POOL_SIZE,
        max_overflow = DATABASE_CONNECTION_MAX_OVERFLOW,
        pool_timeout = DATABASE_CONNECTION_TIMEOUT_SECONDS,
        echo = settings.environment == Environment.DEVELOPMENT,
    )

    SessionLocal = sessionmaker(
        autocommit = False,
        autoflush = False,
        bind = engine,
    )
else:
    engine = None
    SessionLocal = None


@contextmanager
def get_db() -> Generator[Session, None, None]:
    """
    Context manager for database sessions
    """
    if SessionLocal is None:
        raise RuntimeError(
            "Database not configured. Set DATABASE_URL environment variable."
        )

    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


def get_db_session() -> Session:
    """
    Get a new database session (for dependency injection)
    """
    if SessionLocal is None:
        raise RuntimeError(
            "Database not configured. Set DATABASE_URL environment variable."
        )

    return SessionLocal()

```

---

## Pattern Analysis

### Pattern Analysis

**Pattern Used:** Factory Method

In the provided code, a factory method pattern is implemented to create and manage database sessions using SQLAlchemy's `sessionmaker`. The `SessionLocal` object acts as a factory for creating new session instances.

- **Implementation**: 
  - `SessionLocal` is conditionally created based on the presence of `settings.database_url`.
  - A context manager `get_db()` uses `SessionLocal` to provide database sessions, ensuring they are properly closed after use.
  - The `get_db_session()` function directly returns a new session instance.

- **Benefits**:
  - **Flexibility**: Allows for different configurations based on the environment (e.g., development vs. production).
  - **Encapsulation**: Hides the details of session creation and management, making the code more modular.
  - **Error Handling**: Ensures that sessions are properly closed even if an error occurs.

- **Deviations**:
  - The factory method is not strictly abstracted into a separate class or module; it's embedded within the `Session.py` file.
  - There’s no explicit interface defined for the session factory, which could be improved for better maintainability and testability.

- **Appropriateness**:
  - This pattern is appropriate when you need to manage complex object creation with varying configurations. It fits well in this context where database connection settings can differ based on the environment.
  - However, if more complex behavior or multiple factories are needed, a more generalized factory class might be beneficial.

This implementation effectively manages session creation and cleanup while adhering to best practices for resource management in Python.

---

*Generated by CodeWorm on 2026-03-01 15:25*
