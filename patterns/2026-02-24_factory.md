# factory

**Type:** Pattern Analysis
**Repository:** fullstack-template
**File:** backends/fastapi/app/factory.py
**Language:** python
**Lines:** 1-136
**Complexity:** 0.0

---

## Source Code

```python
"""
â’¸AngelaMos | 2025
factory.py
"""

from collections.abc import AsyncIterator
from contextlib import asynccontextmanager

from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from slowapi import _rate_limit_exceeded_handler
from slowapi.errors import RateLimitExceeded

from config import settings, API_PREFIX
from core.database import sessionmanager
from core.exceptions import BaseAppException
from core.logging import configure_logging
from core.rate_limit import limiter
from middleware.correlation import CorrelationIdMiddleware
from core.common_schemas import AppInfoResponse
from core.health_routes import router as health_router
from user.routes import router as user_router
from auth.routes import router as auth_router
from admin.routes import router as admin_router
from it_was_never_real import register_psyop_handler


@asynccontextmanager
async def lifespan(app: FastAPI) -> AsyncIterator[None]:
    """
    Application lifespan handler for startup and shutdown
    """
    configure_logging()
    sessionmanager.init(str(settings.DATABASE_URL))
    yield
    await sessionmanager.close()


OPENAPI_TAGS = [
    {
        "name": "root",
        "description": "API information"
    },
    {
        "name": "health",
        "description": "Health check endpoints"
    },
    {
        "name": "auth",
        "description": "Authentication and authorization"
    },
    {
        "name": "users",
        "description": "User registration and profile management"
    },
    {
        "name": "admin",
        "description": "Admin only operations"
    },
]


def create_app() -> FastAPI:
    """
    Application factory
    """
    app = FastAPI(
        title = settings.APP_NAME,
        summary = settings.APP_SUMMARY,
        description = settings.APP_DESCRIPTION,
        version = settings.APP_VERSION,
        contact = {
            "name": settings.APP_CONTACT_NAME,
            "email": settings.APP_CONTACT_EMAIL,
        },
        license_info = {
            "name": settings.APP_LICENSE_NAME,
            "url": settings.APP_LICENSE_URL,
        },
        openapi_tags = OPENAPI_TAGS,
        openapi_version = "3.1.0",
        lifespan = lifespan,
        root_path = "/api",
        openapi_url = "/openapi.json",
        docs_url = "/docs",
        redoc_url = "/redoc",
    )

    app.add_middleware(CorrelationIdMiddleware)
    app.add_middleware(
        CORSMiddleware,
        allow_origins = settings.CORS_ORIGINS,
        allow_credentials = settings.CORS_ALLOW_CREDENTIALS,
        allow_methods = settings.CORS_ALLOW_METHODS,
        allow_headers = settings.CORS_ALLOW_HEADERS,
    )

    app.state.limiter = limiter
    app.add_exception_handler(
        RateLimitExceeded,
        _rate_limit_exceeded_handler
    )

    @app.exception_handler(BaseAppException)
    async def app_exception_handler(
        request: Request,
        exc: BaseAppException,
    ) -> JSONRes
```

---

## Pattern Analysis

### Design Pattern Analysis

**Pattern Used:** Factory Method

The `create_app` function in `factory.py` implements a **Factory Method** design pattern. This method returns an instance of `FastAPI`, which encapsulates the creation process for the application, including initialization and configuration.

- **Implementation**: The `create_app` function initializes the FastAPI app with various configurations and middleware, routers, and exception handlers.
- **Benefits**: 
  - Encapsulation: It encapsulates the complexity of setting up an API by abstracting away the details of creating and configuring the application.
  - Flexibility: It allows for easy modification or replacement of the initialization process without affecting other parts of the codebase.
  - Reusability: The same factory method can be used to create multiple instances of FastAPI with different configurations.

- **Deviations**: 
  - The `lifespan` context manager is directly passed as an argument to the `FastAPI` constructor, which is a deviation from the standard pattern where the factory might return an object rather than passing configuration parameters.
  
- **Appropriateness**:
  - This pattern is appropriate in scenarios where multiple instances of a similar but slightly different application are needed. It ensures that all necessary configurations and initializations are consistently applied.

This implementation effectively uses the Factory Method to streamline the setup process for a FastAPI application, making it easier to manage and extend.

---

*Generated by CodeWorm on 2026-02-24 01:33*
