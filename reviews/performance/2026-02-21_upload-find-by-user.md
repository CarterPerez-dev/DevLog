# Upload.find_by_user

**Type:** Performance Analysis
**Repository:** vuemantics
**File:** backend/models/Upload.py
**Language:** python
**Lines:** 287-358
**Complexity:** 6.0

---

## Source Code

```python
async def find_by_user(
        cls,
        user_id: UUID,
        limit: int = config.DEFAULT_PAGE_SIZE,
        offset: int = 0,
        file_type: str | None = None,
        status: str | None = None,
        show_hidden: bool = False,
        sort_by: str = "created_at",
        sort_order: str = "desc",
    ) -> list[Upload]:
        """
        Find uploads by user with optional filters.

        Args:
            user_id: User's ID
            limit: Maximum results
            offset: Skip N results
            file_type: Filter by file type
            status: Filter by processing status
            show_hidden: If True, include hidden uploads
            sort_by: Field to sort by (created_at, updated_at, file_size, filename)
            sort_order: Sort direction (asc or desc)

        Returns:
            List of Upload instances
        """
        await cls.ensure_table_exists()

        conditions = ["user_id = $1"]
        params: list[Any] = [user_id]
        param_count = 1

        if file_type:
            param_count += 1
            conditions.append(f"file_type = ${param_count}")
            params.append(file_type)

        if status:
            param_count += 1
            conditions.append(f"processing_status = ${param_count}")
            params.append(status)

        if not show_hidden:
            conditions.append("hidden = FALSE")

        where_clause = " AND ".join(conditions)

        # Validate and sanitize sort params (prevent SQL injection)
        valid_sort_fields = {
            "created_at",
            "updated_at",
            "file_size",
            "filename"
        }
        if sort_by not in valid_sort_fields:
            sort_by = "created_at"

        valid_sort_orders = {"asc", "desc"}
        if sort_order.lower() not in valid_sort_orders:
            sort_order = "desc"

        query = f"""
            SELECT * FROM uploads
            WHERE {where_clause}
            ORDER BY {sort_by} {sort_order.upper()}
            LIMIT ${param_count + 1} OFFSET ${param_count + 2}
        """

        params.extend([limit, offset])
        records = await database.db.fetch(query, *params)
        return cls.from_records(records)
```

---

## Performance Analysis

### Performance Analysis

**Time Complexity:** The function has a time complexity of \(O(n)\), where \(n\) is the number of records returned by the database query. This is because the query execution depends on the size of the result set.

**Space Complexity:** The space complexity is \(O(1)\) for variables, but the `params` list and the SQL query string can grow with input parameters, making it \(O(k)\), where \(k\) is the number of conditions. 

**Bottlenecks:**
- **SQL Injection Risk:** Although the sort parameters are validated, using parameterized queries would be more secure.
- **Redundant Operations:** The `valid_sort_fields` and `valid_sort_orders` checks could be moved outside the function to avoid repeated validation.

**Inefficiencies:**
- **Dynamic Query Construction:** Constructing the SQL query string dynamically can introduce potential SQL injection risks. Use parameterized queries instead.
- **Unnecessary Iterations:** The conditions list is built in a loop, but this is efficient as it scales linearly with the number of filters.

**Optimization Opportunities:**
- **Use Parameterized Queries:** Replace dynamic SQL construction with parameterized queries to avoid SQL injection and improve readability.
- **Caching Filters:** If `file_type` and `status` are frequently queried, consider caching these filters to reduce database load.

**Resource Usage Concerns:**
- Ensure the database connection is properly managed. Use context managers or async context managers for opening connections if not already done.
- Validate input parameters thoroughly to prevent unexpected behavior or security issues.

---

*Generated by CodeWorm on 2026-02-21 22:27*
