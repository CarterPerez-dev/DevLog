# Upload.update_analysis

**Type:** Performance Analysis
**Repository:** vuemantics
**File:** backend/models/Upload.py
**Language:** python
**Lines:** 547-621
**Complexity:** 8.0

---

## Source Code

```python
async def update_analysis(
        self,
        description: str,
        embedding: list[float],
        use_local: bool = True,
        description_audit_score: int | None = None,
    ) -> None:
        """
        Update with AI analysis results

        Args:
            description: Text description from vision model
            embedding: Vector embedding (1024-dim bge-m3)
            use_local: If True, save to embedding_local (default)
            description_audit_score: Audit score 0-100 (higher is better)
        """
        if self.id is None:
            raise ValueError("Cannot update analysis for unsaved upload")

        # Handle both nested and flat embedding formats
        if isinstance(embedding, list) and len(embedding) > 0:
            first_elem = embedding[0]
            if isinstance(first_elem, list):  # type: ignore[unreachable]
                # Nested format: [[1.0, 2.0, ...]]
                embedding_list = first_elem  # type: ignore[unreachable]
            elif isinstance(first_elem, int | float):
                # Flat format: [1.0, 2.0, ...]
                embedding_list = embedding
            else:
                raise ValueError(
                    f"Invalid embedding format: {type(embedding)}"
                )
        else:
            raise ValueError(
                f"Invalid embedding format: {type(embedding)}"
            )

        if use_local:
            query = """
                UPDATE uploads
                SET description = $1,
                    embedding_local = $2,
                    processing_status = $3,
                    description_audit_score = $4,
                    updated_at = NOW()
                WHERE id = $5
                RETURNING updated_at
            """
        else:
            query = """
                UPDATE uploads
                SET description = $1,
                    embedding = $2,
                    processing_status = $3,
                    description_audit_score = $4,
                    updated_at = NOW()
                WHERE id = $5
                RETURNING updated_at
            """

        updated_at = await database.db.fetchval(
            query,
            description,
            embedding_list,
            ProcessingStatus.COMPLETED,
            description_audit_score,
            self.id
        )

        if updated_at:
            self.description = description
            self.embedding_local = embedding_list
            self.processing_status = ProcessingStatus.COMPLETED
            self.description_audit_score = description_audit_score
            self.updated_at = updated_at
```

---

## Performance Analysis

### Performance Analysis

**Time Complexity:** The function has a time complexity of \(O(1)\), as the operations are constant-time, involving conditional checks and database queries.

**Space Complexity:** The space complexity is also \(O(1)\) since no additional data structures grow with input size. However, the `embedding` handling could be optimized to avoid unnecessary type checking.

**Bottlenecks or Inefficiencies:**
- **Redundant Type Checking:** The code redundantly checks if the first element of `embedding` is a list and then again raises an error if it isn't.
- **Unnecessary Error Handling:** The nested `if` statement for embedding format handling can be simplified.

**Optimization Opportunities:**
- Simplify the `embedding` type checking by directly converting to a flat list:
  ```python
  embedding_list = [item for sublist in embedding for item in sublist] if isinstance(embedding[0], list) else embedding
  ```
- Use a single query template and conditionally set `embedding_local` or `embedding` within the SQL query.

**Resource Usage Concerns:**
- Ensure that `database.db.fetchval()` is efficient. Consider using connection pooling to avoid repeated database connection overhead.
- No resource leaks detected, but ensure all connections are properly closed in async contexts.

By simplifying type checks and optimizing the query construction, you can improve readability and maintainability while keeping performance consistent.

---

*Generated by CodeWorm on 2026-02-21 22:30*
