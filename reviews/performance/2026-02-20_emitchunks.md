# emitChunks

**Type:** Performance Analysis
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/intermediate/secrets-scanner/internal/source/directory.go
**Language:** go
**Lines:** 89-150
**Complexity:** 11.0

---

## Source Code

```go
func (d *Directory) emitChunks(
	ctx context.Context,
	absPath, relPath string,
	out chan<- types.Chunk,
) error {
	f, err := os.Open(absPath)
	if err != nil {
		return nil
	}
	defer f.Close()

	var buf strings.Builder
	scanner := bufio.NewScanner(f)
	scanner.Buffer(make([]byte, 0, 512*1024), 512*1024)

	lineNum := 0
	chunkStart := 1
	linesInChunk := 0

	for scanner.Scan() {
		if ctx.Err() != nil {
			return ctx.Err()
		}

		lineNum++
		linesInChunk++

		if buf.Len() > 0 {
			buf.WriteByte('\n')
		}
		buf.WriteString(scanner.Text())

		if linesInChunk >= 50 {
			select {
			case <-ctx.Done():
				return ctx.Err()
			case out <- types.Chunk{
				Content:   buf.String(),
				FilePath:  relPath,
				LineStart: chunkStart,
			}:
			}
			buf.Reset()
			chunkStart = lineNum + 1
			linesInChunk = 0
		}
	}

	if buf.Len() > 0 {
		select {
		case <-ctx.Done():
			return ctx.Err()
		case out <- types.Chunk{
			Content:   buf.String(),
			FilePath:  relPath,
			LineStart: chunkStart,
		}:
		}
	}

	return nil
}
```

---

## Performance Analysis

### Performance Analysis

**Time Complexity:** O(n), where n is the number of lines in the file. The function iterates over each line once.

**Space Complexity:** O(m), where m is the size of a chunk (50 lines). The `strings.Builder` buffer holds up to 50 lines at a time, which can be memory-intensive for large files.

**Bottlenecks and Inefficiencies:**
- **Buffering:** Using `bufio.Scanner` with a fixed buffer size could lead to unnecessary copying of data.
- **Redundant Operations:** The condition `if buf.Len() > 0 { ... }` is redundant since the buffer is reset after each chunk.

**Optimization Opportunities:**
- Use `bufio.NewScanner(f).Split(bufio.ScanLines)` for line-by-line processing, which simplifies the code and avoids manual buffering.
- Consider using a smaller buffer size if memory usage is a concern.

**Resource Usage Concerns:**
- Ensure that all file handles are properly closed to avoid resource leaks. The `defer f.Close()` ensures this, but it's good practice to verify there are no other unclosed resources.

### Suggested Optimizations

1. **Simplify Buffering:**
   ```go
   scanner.Split(bufio.ScanLines)
   ```

2. **Reduce Redundant Checks:**
   Remove the `if buf.Len() > 0 { ... }` check as it is redundant with the buffer reset.

3. **Error Handling:**
   Ensure robust error handling, especially for file operations and channel sends.

By applying these optimizations, you can improve both readability and performance of your function.

---

*Generated by CodeWorm on 2026-02-20 09:04*
