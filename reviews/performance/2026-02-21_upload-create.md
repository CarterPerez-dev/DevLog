# Upload.create

**Type:** Performance Analysis
**Repository:** vuemantics
**File:** backend/models/Upload.py
**Language:** python
**Lines:** 180-257
**Complexity:** 6.0

---

## Source Code

```python
async def create(
        cls,
        user_id: UUID,
        filename: str,
        file_path: str,
        file_type: str,
        file_size: int,
        mime_type: str,
        metadata: dict[str,
                       Any] | None = None,
        upload_id: UUID | None = None,
        batch_id: UUID | None = None,
    ) -> Upload:
        """
        Create a new upload record.

        Args:
            user_id: Owner's user ID
            filename: Original filename
            file_path: Local storage path
            file_type: 'image' or 'video'
            file_size: Size in bytes
            mime_type: MIME type
            metadata: Optional metadata

        Returns:
            Created Upload instance
        """
        await cls.ensure_table_exists()

        if upload_id:
            query = """
                INSERT INTO uploads (
                    id, user_id, batch_id, filename, file_path, file_type,
                    file_size, mime_type, metadata
                )
                VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
                RETURNING *
            """
            record = await database.db.fetchrow(
                query,
                upload_id,
                user_id,
                batch_id,
                filename,
                file_path,
                file_type,
                file_size,
                mime_type,
                json.dumps(metadata) if metadata is not None else None,
            )
        else:
            query = """
                INSERT INTO uploads (
                    user_id, batch_id, filename, file_path, file_type,
                    file_size, mime_type, metadata
                )
                VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
                RETURNING *
            """
            record = await database.db.fetchrow(
                query,
                user_id,
                batch_id,
                filename,
                file_path,
                file_type,
                file_size,
                mime_type,
                json.dumps(metadata) if metadata is not None else None,
            )

        if record is None:
            raise ValueError("Failed to create upload")
        upload = cls.from_record(record)
        if upload is None:
            raise ValueError("Failed to create upload from record")
        return upload
```

---

## Performance Analysis

### Performance Analysis

#### Time Complexity
The time complexity of `Upload.create` is \(O(1)\) for both the `if upload_id:` and `else` branches, as the operations are constant-time insertions and fetches.

#### Space Complexity
Space complexity is also \(O(1)\), as no additional space scales with input size. However, the use of `json.dumps(metadata)` could be costly if metadata is large or frequent.

#### Bottlenecks and Inefficiencies
- **Redundant Operations**: The function checks for `upload_id` twice.
- **Blocking JSON Conversion**: Converting `metadata` to a string using `json.dumps()` can be expensive, especially with large dictionaries. Consider using async-safe alternatives if possible.
- **Error Handling**: Raising `ValueError` on both `record is None` and `upload is None` might be redundant; consider combining or refining error handling.

#### Optimization Opportunities
1. **Combine Metadata Check**: Remove the redundant check for `upload_id`.
2. **Async JSON Conversion**: If metadata is frequently large, consider using an async-safe JSON library.
3. **Refine Error Handling**: Simplify and centralize error handling to avoid redundancy.

#### Resource Usage Concerns
- Ensure that `database.db` is properly managed with context managers or connection pooling to prevent resource leaks.

By addressing these points, you can improve the efficiency and maintainability of your code.

---

*Generated by CodeWorm on 2026-02-21 21:56*
