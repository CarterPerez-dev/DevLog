# ReferralService.track_referral

**Type:** Performance Analysis
**Repository:** stripe-referral
**File:** src/stripe_referral/services/referral_service.py
**Language:** python
**Lines:** 130-186
**Complexity:** 4.0

---

## Source Code

```python
def track_referral(
        db: Session,
        code: str,
        referred_user_id: str,
        transaction_id: str | None = None,
        transaction_amount: float | None = None,
    ) -> TrackReferralResult:
        """
        Track a successful referral conversion
        """
        code_repo = ReferralCodeRepository(db)
        tracking_repo = ReferralTrackingRepository(db)
        program_repo = ReferralProgramRepository(db)

        ReferralService.validate_code(db, code)

        code_obj = code_repo.get_by_code(code)
        if not code_obj:
            raise CodeNotFoundError(
                f"Code '{code}' not found",
                code = code
            )

        if code_obj.user_id == referred_user_id:
            raise SelfReferralError(
                "Cannot use your own referral code",
                user_id = referred_user_id,
            )

        program = program_repo.get_by_id(code_obj.program_id)
        if not program:
            raise ProgramNotFoundError(
                f"Program ID {code_obj.program_id} not found",
                program_id = code_obj.program_id,
            )

        tracking = tracking_repo.create(
            referrer_user_id = code_obj.user_id,
            referred_user_id = referred_user_id,
            code_id = code_obj.id,
            program_id = program.id,
            transaction_id = transaction_id,
            transaction_amount = transaction_amount,
            amount_earned = program.reward_amount,
            currency = program.reward_currency,
        )

        code_repo.increment_uses(code_obj.id)

        return TrackReferralResult(
            tracking_id = tracking.id,
            referrer_user_id = tracking.referrer_user_id,
            referred_user_id = tracking.referred_user_id,
            amount_earned = tracking.amount_earned,
            currency = tracking.currency,
            converted_at = tracking.converted_at.isoformat(),
        )
```

---

## Performance Analysis

### Performance Analysis

#### Time Complexity
The function has a time complexity of \(O(1)\) for the operations within each repository method call, assuming these methods are optimized. However, the overall complexity is dominated by database interactions.

#### Space Complexity and Memory Allocation
- The space complexity is \(O(1)\), as no additional data structures grow with input size.
- Ensure that `Session` instances are properly managed to avoid memory leaks.

#### Bottlenecks or Inefficiencies
1. **Redundant Database Queries**: Multiple database queries (e.g., `get_by_code`, `get_by_id`) can be optimized by fetching related entities in a single query if possible.
2. **Unnecessary Validation Calls**: The validation call to `ReferralService.validate_code` might already check for the same conditions, leading to redundant operations.

#### Optimization Opportunities
1. **Batch Database Queries**: Use SQL joins or eager loading to fetch all necessary data in one query instead of multiple calls.
   ```python
   tracking = tracking_repo.create(
       referrer_user_id=code_obj.user_id,
       referred_user_id=referred_user_id,
       code_id=code_obj.id,
       program_id=program.id,
       transaction_id=transaction_id,
       transaction_amount=transaction_amount,
       amount_earned=program.reward_amount,
       currency=program.reward_currency,
   )
   ```
2. **Remove Redundant Validation**: Ensure `ReferralService.validate_code` covers the same checks to avoid calling it separately.

#### Resource Usage Concerns
- Use context managers for database sessions to ensure proper closure:
  ```python
  with Session() as db:
      # Function code here
  ```

By optimizing these areas, you can improve both performance and maintainability.

---

*Generated by CodeWorm on 2026-02-21 21:15*
