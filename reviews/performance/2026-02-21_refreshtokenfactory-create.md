# RefreshTokenFactory.create

**Type:** Performance Analysis
**Repository:** my-portfolio
**File:** v1/backend/conftest.py
**Language:** python
**Lines:** 160-182
**Complexity:** 4.0

---

## Source Code

```python
async def create(
        cls,
        session: AsyncSession,
        user: User,
        *,
        is_revoked: bool = False,
        expires_delta: timedelta = timedelta(days = 7),
    ) -> tuple[RefreshToken,
               str]:
        raw_token = secrets.token_urlsafe(32)
        token_hash = hashlib.sha256(raw_token.encode()).hexdigest()

        token = RefreshToken(
            user_id = user.id,
            token_hash = token_hash,
            family_id = uuid4(),
            expires_at = datetime.now(UTC) + expires_delta,
            is_revoked = is_revoked,
        )
        session.add(token)
        await session.flush()
        await session.refresh(token)
        return token, raw_token
```

---

## Performance Analysis

### Performance Analysis

**Time Complexity:** The function has a time complexity of \(O(1)\), as the operations performed are constant-time, including hashing, token creation, and database operations.

**Space Complexity:** The space complexity is also \(O(1)\) since no additional data structures grow with input size. However, the `hashlib.sha256` function creates a new hash object each time it's called, which could be optimized by reusing an instance if this function is called frequently.

**Bottlenecks or Inefficiencies:**
- **Redundant Hashing:** The `secrets.token_urlsafe(32)` and subsequent hashing are redundant. You can directly use the raw token for storage.
- **Database Operations:** `session.flush()` and `session.refresh(token)` could be costly, especially if there are many concurrent operations.

**Optimization Opportunities:**
1. **Remove Redundant Hashing:** Directly store the raw token in the database to avoid hashing.
2. **Batch Operations:** Use batch operations or transactions for multiple `add` calls to reduce the number of database round trips.
3. **Reuse Hash Object:** If this function is called frequently, consider reusing a single `hashlib.sha256` instance.

**Resource Usage Concerns:**
- Ensure that the `session` is properly managed and closed after use to avoid resource leaks.
- Consider using context managers for session management if not already done:
  ```python
  async with AsyncSession() as session:
      # Function code here
  ```

By implementing these optimizations, you can improve both performance and efficiency.

---

*Generated by CodeWorm on 2026-02-21 20:35*
