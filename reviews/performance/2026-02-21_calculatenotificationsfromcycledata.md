# calculateNotificationsFromCycleData

**Type:** Performance Analysis
**Repository:** ios-test
**File:** red-recon/src/core/notifications/notification.service.ts
**Language:** typescript
**Lines:** 118-190
**Complexity:** 9.0

---

## Source Code

```typescript
function calculateNotificationsFromCycleData(
  cycleStatus: CycleStatus,
  partner: PartnerResponse
): NotificationConfig[] {
  const notifications: NotificationConfig[] = []
  const today = new Date()
  today.setHours(0, 0, 0, 0)

  if (
    partner.notification_period_reminder &&
    cycleStatus.predicted_period_start &&
    cycleStatus.days_until_period !== null
  ) {
    const predictedStart = new Date(cycleStatus.predicted_period_start)
    const reminderDate = addDays(predictedStart, -partner.reminder_days_before)

    if (reminderDate > today) {
      const content = NOTIFICATION_CONTENT[NotificationType.PERIOD_REMINDER]
      notifications.push({
        type: NotificationType.PERIOD_REMINDER,
        identifier: NOTIFICATION_IDENTIFIERS.PERIOD_REMINDER,
        title: content.title,
        body: content.bodyTemplate(partner.reminder_days_before),
        triggerDate: setTimeToMorning(reminderDate),
      })
    }
  }

  if (
    partner.notification_pms_alert &&
    cycleStatus.last_period_start &&
    cycleStatus.cycle_length
  ) {
    const lastPeriod = new Date(cycleStatus.last_period_start)
    const ovulationDay = cycleStatus.cycle_length - 14
    const lutealStartDay = ovulationDay + 2
    const lutealDate = addDays(lastPeriod, lutealStartDay - 1)

    if (lutealDate > today) {
      const content = NOTIFICATION_CONTENT[NotificationType.PMS_ALERT]
      notifications.push({
        type: NotificationType.PMS_ALERT,
        identifier: NOTIFICATION_IDENTIFIERS.PMS_ALERT,
        title: content.title,
        body: content.body,
        triggerDate: setTimeToMorning(lutealDate),
      })
    }
  }

  if (
    partner.notification_ovulation_alert &&
    cycleStatus.last_period_start &&
    cycleStatus.cycle_length
  ) {
    const lastPeriod = new Date(cycleStatus.last_period_start)
    const ovulationDay = cycleStatus.cycle_length - 14
    const ovulationDate = addDays(lastPeriod, ovulationDay - 1)

    if (ovulationDate > today) {
      const content = NOTIFICATION_CONTENT[NotificationType.OVULATION_ALERT]
      notifications.push({
        type: NotificationType.OVULATION_ALERT,
        identifier: NOTIFICATION_IDENTIFIERS.OVULATION_ALERT,
        title: content.title,
        body: content.body,
        triggerDate: setTimeToMorning(ovulationDate),
      })
    }
  }

  return notifications
}
```

---

## Performance Analysis

### Performance Analysis

**Time Complexity:** The function has a time complexity of \(O(1)\) since it performs a fixed number of operations regardless of the input size. However, the `addDays`, `setTimeToMorning`, and array push operations are costly.

**Space Complexity:** The space complexity is also \(O(1)\), as the only dynamic memory allocation occurs in the `notifications` array, which has a constant upper limit based on the function's logic.

**Bottlenecks or Inefficiencies:**
- **Redundant Date Calculations:** The dates for period reminder, ovulation alert, and PMS alert are calculated multiple times. This can be optimized by storing these values in variables.
- **Repeated Array Pushes:** Each condition results in a push to the `notifications` array, which can be costly if the conditions are frequently true.

**Optimization Opportunities:**
1. Store date calculations in variables:
   ```typescript
   const predictedStart = new Date(cycleStatus.predicted_period_start)
   const lastPeriod = new Date(cycleStatus.last_period_start)
   ```

2. Use a single array push statement if the conditions are mutually exclusive or use an array filter to avoid multiple pushes.

**Resource Usage Concerns:**
- Ensure that `NOTIFICATION_CONTENT` and other constants are properly cached to avoid repeated lookups.
- Consider using a more efficient date manipulation library if performance is critical.

By optimizing these areas, you can improve both the readability and performance of the function.

---

*Generated by CodeWorm on 2026-02-21 23:44*
