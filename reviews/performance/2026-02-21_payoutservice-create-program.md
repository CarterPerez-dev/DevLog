# PayoutService.create_program

**Type:** Performance Analysis
**Repository:** stripe-referral
**File:** src/stripe_referral/services/payout_service.py
**Language:** python
**Lines:** 69-115
**Complexity:** 4.0

---

## Source Code

```python
def create_program(
        db: Session,
        name: str,
        program_key: str,
        reward_amount: float,
        *,
        reward_currency: str = CurrencyCode.USD.value,
        reward_type: str = RewardType.ONE_TIME.value,
        adapter_type: str = AdapterType.MANUAL.value,
        max_rewards_per_user: int | None = None,
        conversion_window_days: int | None = None,
        adapter_config: dict[str,
                             Any] | None = None,
    ) -> ProgramInfo:
        """
        Create a new referral program
        """
        valid_adapter_types = [at.value for at in AdapterType]
        if adapter_type not in valid_adapter_types:
            raise InvalidRecipientDataError(
                f"Invalid adapter_type. Must be one of: {valid_adapter_types}",
                adapter_type = adapter_type,
            )

        program_repo = ReferralProgramRepository(db)

        program = program_repo.create(
            name = name,
            program_key = program_key,
            reward_amount = reward_amount,
            reward_currency = reward_currency,
            reward_type = reward_type,
            adapter_type = adapter_type,
            max_rewards_per_user = max_rewards_per_user,
            conversion_window_days = conversion_window_days,
            adapter_config = adapter_config or {},
        )

        return ProgramInfo(
            id = program.id,
            name = program.name,
            program_key = program.program_key,
            reward_amount = program.reward_amount,
            reward_currency = program.reward_currency,
            reward_type = program.reward_type,
            is_active = program.is_active,
        )
```

---

## Performance Analysis

### Performance Analysis

#### Time Complexity
The function has a time complexity of \(O(1)\), as it performs a fixed number of operations regardless of the input size.

#### Space Complexity and Memory Allocation
- The space complexity is also \(O(1)\) since no additional data structures are created that scale with input size. However, the `adapter_config` default value creation might be redundant if it's always an empty dictionary.
  
#### Bottlenecks or Inefficiencies
- **Redundant Default Value Creation**: The line `adapter_config = adapter_config or {}` creates a new dictionary even when `adapter_config` is already provided. This can be optimized by directly using the provided value.

#### Optimization Opportunities
- **Remove Redundant Dictionary Creation**:
  ```python
  program_repo.create(
      name=name,
      program_key=program_key,
      reward_amount=reward_amount,
      reward_currency=reward_currency,
      reward_type=reward_type,
      adapter_type=adapter_type,
      max_rewards_per_user=max_rewards_per_user,
      conversion_window_days=conversion_window_days,
      adapter_config=adapter_config or {},
  )
  ```
  Can be simplified to:
  ```python
  program_repo.create(
      name=name,
      program_key=program_key,
      reward_amount=reward_amount,
      reward_currency=reward_currency,
      reward_type=reward_type,
      adapter_type=adapter_type,
      max_rewards_per_user=max_rewards_per_user,
      conversion_window_days=conversion_window_days,
      adapter_config=adapter_config or {},
  )
  ```

- **Ensure Efficient Repository Calls**: Ensure that `ReferralProgramRepository.create` is optimized, especially if it involves database operations.

#### Resource Usage Concerns
- The function does not have any blocking calls in an async context.
- No N+1 query patterns are evident from the provided snippet.
- Caching opportunities might exist if creating similar programs frequently. Consider caching `ReferralProgramRepository.create` results using a library like `functools.lru_cache`.

By addressing these points, you can further optimize the function for better performance and efficiency.

---

*Generated by CodeWorm on 2026-02-21 21:08*
