# handleStatus

**Type:** Performance Analysis
**Repository:** angelamos-operations
**File:** CarterBot-Telegram/src/handlers/commands.ts
**Language:** typescript
**Lines:** 79-141
**Complexity:** 12.0

---

## Source Code

```typescript
async function handleStatus(ctx: Context): Promise<void> {
  const userId = ctx.from?.id;

  if (!isAuthorized(userId, ALLOWED_USERS)) {
    await ctx.reply("Unauthorized.");
    return;
  }

  const lines: string[] = ["<b>Bot Status</b>\n"];

  if (session.isActive) {
    lines.push(`Session: Active (${session.sessionId?.slice(0, 8)}...)`);
  } else {
    lines.push("Session: None");
  }

  if (session.isRunning) {
    const elapsed = session.queryStarted
      ? Math.floor((Date.now() - session.queryStarted.getTime()) / 1000)
      : 0;
    lines.push(`Query: Running (${elapsed}s)`);
    if (session.currentTool) {
      lines.push(`   ${session.currentTool}`);
    }
  } else {
    lines.push("Query: Idle");
    if (session.lastTool) {
      lines.push(`   Last: ${session.lastTool}`);
    }
  }

  if (session.lastActivity) {
    const ago = Math.floor(
      (Date.now() - session.lastActivity.getTime()) / 1000
    );
    lines.push(`\nLast activity: ${ago}s ago`);
  }

  if (session.lastUsage) {
    const usage = session.lastUsage;
    lines.push(
      `\nLast query usage:`,
      `   Input: ${usage.input_tokens?.toLocaleString() || "?"} tokens`,
      `   Output: ${usage.output_tokens?.toLocaleString() || "?"} tokens`
    );
    if (usage.cache_read_input_tokens) {
      lines.push(
        `   Cache read: ${usage.cache_read_input_tokens.toLocaleString()}`
      );
    }
  }

  if (session.lastError) {
    const ago = session.lastErrorTime
      ? Math.floor((Date.now() - session.lastErrorTime.getTime()) / 1000)
      : "?";
    lines.push(`\nLast error (${ago}s ago):`, `   ${session.lastError}`);
  }

  lines.push(`\nWorking dir: <code>${WORKING_DIR}</code>`);

  await ctx.reply(lines.join("\n"), { parse_mode: "HTML" });
}
```

---

## Performance Analysis

### Performance Analysis

**Time Complexity:** The time complexity is O(1) since the operations do not depend on input size, but rather on a fixed number of checks and computations.

**Space Complexity:** The space complexity is also O(1), as no additional data structures are created that scale with input size. However, the `lines` array can grow if there are many session activities or errors logged.

**Bottlenecks & Inefficiencies:**
- **Redundant Computations:** Calculating `elapsed`, `ago`, and `usage` multiple times is redundant.
- **String Concatenation:** Using `.push()` to build the string can be inefficient due to repeated allocations. Consider using a template literal or `StringBuilder`.

**Optimization Opportunities:**
1. **Memoize Time Calculations:** Store computed values like `elapsed`, `ago`, and `usage` in variables before pushing them to `lines`.
2. **Use Template Literals:** Replace `.push()` with template literals for cleaner, more efficient string building.

```typescript
const elapsed = session.queryStarted
  ? Math.floor((Date.now() - session.queryStarted.getTime()) / 1000)
  : 0;
const ago = Math.floor((Date.now() - session.lastActivity.getTime()) / 1000);
const usage = session.lastUsage;

lines.push(`Session: ${session.isActive ? `Active (${elapsed}s)`: "None"}`);
if (session.currentTool) lines.push(`   ${session.currentTool}`);

// ... other checks

await ctx.reply(lines.join("\n"), { parse_mode: "HTML" });
```

**Resource Usage Concerns:**
- Ensure that `ctx.reply` and any other async calls are properly awaited to avoid hanging or blocking.
- Verify that `WORKING_DIR` is a constant and not dynamically generated, as it should be.

By applying these optimizations, the code will run more efficiently with minimal impact on resource usage.

---

*Generated by CodeWorm on 2026-02-21 17:25*
