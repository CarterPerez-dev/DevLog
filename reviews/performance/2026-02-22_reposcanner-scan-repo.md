# RepoScanner.scan_repo

**Type:** Performance Analysis
**Repository:** CodeWorm
**File:** codeworm/analysis/scanner.py
**Language:** python
**Lines:** 148-212
**Complexity:** 16.0

---

## Source Code

```python
def scan_repo(self, repo_path: Path, repo_name: str) -> Iterator[ScannedFile]:
        """
        Scan a repository and yield discovered files
        """
        if not repo_path.exists():
            return

        gitignore_filter = GitignoreFilter(repo_path)
        include_spec = pathspec.PathSpec.from_lines(
            "gitwildmatch",
            self.include_patterns
        )

        for root, dirs, files in os.walk(repo_path):
            root_path = Path(root)

            dirs[:] = [
                d for d in dirs if not d.startswith(".")
                and not gitignore_filter.is_ignored(root_path / d)
            ]

            for filename in files:
                file_path = root_path / filename

                try:
                    rel_path = file_path.relative_to(repo_path)
                except ValueError:
                    continue

                if not include_spec.match_file(str(rel_path)):
                    continue

                if self._exclude_spec.match_file(str(rel_path)):
                    continue

                if gitignore_filter.is_ignored(file_path):
                    continue

                ext = file_path.suffix.lower()
                language = LANGUAGE_EXTENSIONS.get(ext)
                if not language:
                    continue

                try:
                    stat = file_path.stat()
                    if stat.st_size > self.MAX_FILE_SIZE:
                        continue
                    if stat.st_size == 0:
                        continue

                    is_binary = self._is_binary(file_path)
                    if is_binary:
                        continue

                    yield ScannedFile(
                        path = file_path,
                        language = language,
                        repo_name = repo_name,
                        relative_path = rel_path,
                        size_bytes = stat.st_size,
                        is_binary = False,
                    )

                except (OSError, PermissionError):
                    continue
```

---

## Performance Analysis

### Performance Analysis

#### Time Complexity
The time complexity of `scan_repo` is \(O(n \cdot m)\), where \(n\) is the number of files in the repository and \(m\) is the average cost of processing each file (e.g., checking against filters, reading stats). The primary bottleneck is the repeated checks for ignored directories and files.

#### Space Complexity
The space complexity is primarily determined by the `PathSpec` object and any cached results. However, it's generally low as these are not dynamically growing with input size.

#### Bottlenecks or Inefficiencies
1. **Redundant Checks**: The file path is checked for ignoring multiple times.
2. **Multiple File Existence Checks**: The `exists()` check on the root directory and `stat()` calls can be optimized.
3. **Filtering Directories**: Filtering directories in each iteration of `os.walk` can be costly.

#### Optimization Opportunities
1. **Cache Filters**: Cache the results of `gitignore_filter.is_ignored` to avoid redundant checks.
2. **Combine Checks**: Combine multiple file existence and size checks into a single pass.
3. **Use `pathlib` Efficiently**: Ensure efficient use of `Path` methods.

#### Resource Usage Concerns
- **File Path Handling**: Ensure that `file_path.stat()` is not called unnecessarily, possibly by caching the result.
- **Error Handling**: The exception handling can be optimized to avoid redundant checks.

### Suggested Optimizations

1. Cache filter results:
   ```python
   ignored_files = set()
   for root, dirs, files in os.walk(repo_path):
       # ... existing code ...
       if gitignore_filter.is_ignored(root_path / d):
           continue
       # ... existing code ...
       if file_path in ignored_files:
           continue
       ignored_files.add(file_path)
   ```

2. Combine checks for file existence and size:
   ```python
   try:
       stat = file_path.stat()
       if stat.st_size > self.MAX_FILE_SIZE or stat.st_size == 0:
           continue
   except (OSError, PermissionError):
       continue
   ```

These changes will reduce redundant operations and improve the overall efficiency of the function.

---

*Generated by CodeWorm on 2026-02-22 00:39*
