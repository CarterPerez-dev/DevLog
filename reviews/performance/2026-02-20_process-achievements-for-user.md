# process_achievements_for_user

**Type:** Performance Analysis
**Repository:** CertGames-Core
**File:** backend/api/domains/progression/services/unlock_engine.py
**Language:** python
**Lines:** 20-104
**Complexity:** 22.0

---

## Source Code

```python
def process_achievements_for_user():
    """
    Checks all achievement criteria against a user's progress
    and unlocks any that have been earned.
    """
    user = g.user

    counters = user.achievement_counters or {}
    unlocked = set(UserAchievementService.get_achievement_ids(user))
    newly_unlocked = []

    all_achievements = AchievementService.get_all()

    for ach in all_achievements:
        aid = ach.achievementId

        if aid in unlocked:
            continue

        crit = ach.criteria or {}

        if any(checker(crit,
                       counters,
                       user) for checker in CRITERIA_CHECKERS):
            unlocked.add(aid)
            newly_unlocked.append(aid)

    if newly_unlocked:
        current_time = datetime.now(UTC)
        total_xp_reward = 0
        total_coin_reward = 0

        for achievement_id in newly_unlocked:

            def get_ach_id(ach):
                return ach.get('achievementId') if isinstance(
                    ach,
                    dict
                ) else ach.achievementId

            if not any(get_ach_id(ach) == achievement_id
                       for ach in user.achievements_v2):
                user.achievements_v2.append(
                    UserAchievement(
                        achievementId = achievement_id,
                        unlockedAt = current_time
                    )
                )

                achievement = next(
                    (
                        ach for ach in all_achievements
                        if ach.achievementId == achievement_id
                    ),
                    None
                )
                if achievement:
                    total_xp_reward += achievement.xpReward or 0
                    total_coin_reward += achievement.coinReward or 0

        user.update(set__achievements_v2 = user.achievements_v2)

        if total_xp_reward > 0 or total_coin_reward > 0:
            if total_xp_reward > 0 and total_coin_reward > 0:
                ProgressionService.update_xp_and_coins(
                    user,
                    total_xp_reward,
                    total_coin_reward
                )
            elif total_xp_reward > 0:
                ProgressionService.update_xp(user, total_xp_reward)
            elif total_coin_reward > 0:
                ProgressionService.update_coins(user, total_coin_reward)

        user.reload()

        g.user = user

        AuditLogger.log_action(
            action = "achievements_unlocked",
            user_id = str(user.id),
            data = {"newly_unlocked": newly_unlocked},
        )

    return newly_unlocked
```

---

## Performance Analysis

### Performance Analysis

#### Time Complexity
The time complexity is dominated by the iteration over `all_achievements` (O(n)), where `n` is the number of achievements. The nested checks and operations inside this loop are relatively inexpensive, but the overall complexity remains linear.

#### Space Complexity
Space complexity is O(1) for variables like `unlocked`, `newly_unlocked`, and `current_time`. However, the space used by `user.achievements_v2` can grow with each call if achievements are frequently unlocked.

#### Bottlenecks or Inefficiencies
- **Redundant Checks**: The check `if not any(get_ach_id(ach) == achievement_id for ach in user.achievements_v2)` is redundant since the same logic is applied to both `user.achievements_v2` and `all_achievements`.
- **Multiple Queries**: The use of `next()` within a loop can be costly, especially if `all_achievements` is large.
- **Unnecessary Iterations**: The `any()` function inside the criteria check could be optimized by using more efficient data structures.

#### Optimization Opportunities
1. **Use Sets for Efficient Checks**: Convert `user.achievements_v2` to a set for O(1) lookups.
2. **Pre-fetch Achievements**: Fetch achievements in bulk and use them directly without repeated queries.
3. **Reduce Redundant Operations**: Combine the checks on `user.achievements_v2` and `all_achievements`.

#### Resource Usage Concerns
- Ensure that database connections are properly managed, especially if `get_all()` involves database calls.
- Consider caching frequently accessed data like achievements to reduce database load.

By applying these optimizations, you can significantly improve the performance of this function.

---

*Generated by CodeWorm on 2026-02-20 19:24*
