# InsightsService.export_all_data

**Type:** Performance Analysis
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/analytics/facets/insights/service.py
**Language:** python
**Lines:** 418-462
**Complexity:** 4.0

---

## Source Code

```python
async def export_all_data(
        session: AsyncSession,
    ) -> ExportDataResponse:
        """Export all video data as JSON"""
        videos = await InsightsRepository.get_all_videos(session)

        video_dicts = [
            {
                "id": str(v.id),
                "rank": v.rank,
                "date_posted": v.date_posted.isoformat(),
                "video_url": v.video_url,
                "views": v.views,
                "comments": v.comments,
                "likes": v.likes,
                "bookmarks": v.bookmarks,
                "shares": v.shares,
                "avg_watch_time": v.avg_watch_time,
                "new_followers": v.new_followers,
                "watched_full_video_percentage": v.watched_full_video_percentage,
                "top_comment_words": v.top_comment_words,
                "search_queries": v.search_queries,
                "traffic_sources": v.traffic_sources,
                "hook": v.hook,
                "text_on_screen_hook": v.text_on_screen_hook,
                "length": v.length,
                "description": v.description,
                "hashtags": v.hashtags,
                "cta": v.cta,
                "full_transcription": v.full_transcription,
                "notes": v.notes,
                "created_at": v.created_at.isoformat() if v.created_at else None,
                "updated_at": v.updated_at.isoformat() if v.updated_at else None,
                # Calculated fields
                "engagement_rate": InsightsRepository.calculate_engagement_rate(v),
                "follower_conversion_rate": InsightsRepository.calculate_follower_conversion_rate(v),
            }
            for v in videos
        ]

        return ExportDataResponse(
            videos = video_dicts,
            total_count = len(video_dicts),
            export_date = datetime.utcnow().isoformat(),
        )
```

---

## Performance Analysis

### Performance Analysis

#### Time Complexity
The time complexity of the function is \(O(n)\), where \(n\) is the number of videos returned by `InsightsRepository.get_all_videos`. This is because you're iterating over all videos to construct `video_dicts`.

#### Space Complexity and Memory Allocation
- The space complexity is also \(O(n)\) due to storing each video's data in `video_dicts`.
- Ensure that `ExportDataResponse` objects are properly managed, as excessive object creation can lead to memory overhead.

#### Bottlenecks or Inefficiencies
1. **N+1 Query Pattern**: The function fetches all videos and then iterates over them to calculate fields like engagement rate and follower conversion rate. This could result in multiple database queries if these calculations are expensive.
2. **Redundant Calculations**: If `calculate_engagement_rate` or `calculate_follower_conversion_rate` involve complex operations, they might be called redundantly for each video.

#### Optimization Opportunities
1. **Batch Calculations**: Calculate engagement rates and follower conversion rates in a batch operation if possible to reduce the number of database hits.
2. **Memoization**: Cache results from expensive calculations like `calculate_engagement_rate` and `calculate_follower_conversion_rate` using decorators or caching libraries (e.g., `functools.lru_cache`).

#### Resource Usage Concerns
- Ensure that `session` is properly closed after use, even in async contexts.
- Use context managers to manage database sessions: `async with session.begin() as db:`.

By addressing these points, you can significantly improve the performance and efficiency of your function.

---

*Generated by CodeWorm on 2026-03-01 13:01*
