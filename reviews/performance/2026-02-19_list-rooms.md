# list_rooms

**Type:** Performance Analysis
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/encrypted-p2p-chat/backend/app/api/rooms.py
**Language:** python
**Lines:** 136-200
**Complexity:** 10.0

---

## Source Code

```python
async def list_rooms(
    user_id: str,
    session: AsyncSession = Depends(get_session),
) -> RoomListResponse:
    """
    List all rooms for the specified user
    """
    user = await auth_service.get_user_by_id(session, UUID(user_id))

    if not user:
        raise HTTPException(
            status_code = status.HTTP_404_NOT_FOUND,
            detail = "User not found",
        )

    room_data_list = await surreal_db.get_rooms_for_user(user_id)

    rooms: list[RoomAPIResponse] = []

    for room_data in room_data_list:
        if not room_data:
            continue

        room_id = str(room_data.get("id", ""))
        participants_data = await surreal_db.get_room_participants(room_id)

        participants: list[ParticipantResponse] = []

        for p_data in participants_data:
            p_user_id = p_data.get("user_id")
            if not p_user_id:
                continue

            p_user = await auth_service.get_user_by_id(session, UUID(p_user_id))
            if p_user:
                participants.append(
                    ParticipantResponse(
                        user_id = str(p_user.id),
                        username = p_user.username,
                        display_name = p_user.display_name,
                        role = p_data.get("role", "member"),
                        joined_at = str(p_data.get("joined_at", "")),
                    )
                )

        other_participant = next(
            (p for p in participants if p.user_id != user_id),
            None
        )
        room_name = other_participant.display_name if other_participant else None

        rooms.append(
            RoomAPIResponse(
                id = room_id,
                type = RoomType(room_data.get("room_type", "direct")),
                name = room_name,
                participants = participants,
                unread_count = 0,
                is_encrypted = True,
                created_at = str(room_data.get("created_at", "")),
                updated_at = str(room_data.get("updated_at", "")),
            )
        )

    return RoomListResponse(rooms = rooms)
```

---

## Performance Analysis

### Performance Analysis

**Time Complexity:** The function has a time complexity of \(O(n \cdot m)\), where \(n\) is the number of rooms, and \(m\) is the average number of participants per room. This is due to nested loops iterating over `room_data_list` and `participants_data`.

**Space Complexity:** The space complexity is \(O(n + p)\), where \(n\) is the number of rooms, and \(p\) is the total number of participants across all rooms.

**Bottlenecks or Inefficiencies:**
1. **Nested Loops:** The nested loops for processing `participants_data` are redundant, leading to a significant performance hit.
2. **Multiple Database Queries:** For each room, multiple queries are made to fetch participant data, resulting in an N+1 query pattern.
3. **Redundant Checks:** The check `if not user:` and `if p_user:` can be moved outside the loop.

**Optimization Opportunities:**
1. **Batch Fetching Participants:** Use a single database call to fetch all participants for each room instead of multiple queries.
2. **Cache User Data:** Cache user data using a cache like Redis to avoid repeated database calls.
3. **Refactor Loops:** Combine loops and reduce redundancy by processing participant data in one go.

**Resource Usage Concerns:**
- Ensure proper use of context managers for session handling to prevent resource leaks.
- Use `Depends` correctly to manage dependencies and ensure sessions are properly closed after usage.

By addressing these issues, you can significantly improve the performance and efficiency of the function.

---

*Generated by CodeWorm on 2026-02-19 09:13*
