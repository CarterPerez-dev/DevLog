# ReferralService.validate_code

**Type:** Performance Analysis
**Repository:** stripe-referral
**File:** src/stripe_referral/services/referral_service.py
**Language:** python
**Lines:** 86-127
**Complexity:** 7.0

---

## Source Code

```python
def validate_code(db: Session, code: str) -> CodeValidation:
        """
        Validate if a code is active and usable
        """
        code_repo = ReferralCodeRepository(db)

        code_obj = code_repo.get_by_code(code)
        if not code_obj:
            raise CodeNotFoundError(
                f"Code '{code}' not found",
                code = code
            )

        if code_obj.status != ReferralCodeStatus.ACTIVE.value:
            raise CodeInactiveError(
                f"Code '{code}' is inactive (status: {code_obj.status})",
                code = code,
                status = code_obj.status,
            )

        if code_obj.expires_at and code_obj.expires_at < datetime.now(UTC
                                                                      ):
            raise CodeExpiredError(
                f"Code '{code}' expired at {code_obj.expires_at.isoformat()}",
                code = code,
                expires_at = code_obj.expires_at.isoformat(),
            )

        if code_obj.max_uses and code_obj.uses_count >= code_obj.max_uses:
            raise CodeMaxUsesReachedError(
                f"Code '{code}' has reached maximum uses ({code_obj.max_uses})",
                code = code,
                max_uses = code_obj.max_uses,
                uses_count = code_obj.uses_count,
            )

        return CodeValidation(
            valid = True,
            code_id = code_obj.id,
            program_id = code_obj.program_id,
            referrer_user_id = code_obj.user_id,
        )
```

---

## Performance Analysis

### Performance Analysis

**Time Complexity:** The function has a time complexity of O(1) since the operations are constant-time, assuming `get_by_code` is also O(1). However, if `get_by_code` involves database queries or other costly operations, it could be O(n).

**Space Complexity:** The space complexity is O(1), as no additional data structures that grow with input size are used.

**Bottlenecks and Inefficiencies:**
- **Database Query:** If `get_by_code` performs a database query each time, it can become costly if called frequently.
- **Redundant Checks:** The checks for status, expiration, and max uses could be combined into fewer conditions to reduce redundancy.

**Optimization Opportunities:**
1. **Cache Repository Results:** Cache the result of `code_repo.get_by_code(code)` using a caching mechanism like Redis or Memcached to avoid repeated database hits.
2. **Combine Conditions:** Combine multiple if checks into one condition block to reduce redundant code and improve readability.

```python
def validate_code(db: Session, code: str) -> CodeValidation:
    """
    Validate if a code is active and usable
    """
    code_repo = ReferralCodeRepository(db)
    
    code_obj = code_repo.get_by_code(code)
    if not code_obj or (code_obj.status != ReferralCodeStatus.ACTIVE.value 
                        or code_obj.expires_at and code_obj.expires_at < datetime.now(UTC) 
                        or code_obj.max_uses and code_obj.uses_count >= code_obj.max_uses):
        raise CodeNotFoundError(
            f"Code '{code}' is not valid: {code_obj.status}, expires at {code_obj.expires_at.isoformat()}, uses count {code_obj.uses_count}",
            code = code,
            status = code_obj.status if code_obj else None,
            expires_at = code_obj.expires_at.isoformat() if code_obj and code_obj.expires_at else None,
            max_uses = code_obj.max_uses if code_obj and code_obj.max_uses else None,
            uses_count = code_obj.uses_count if code_obj else None
        )

    return CodeValidation(
        valid=True,
        code_id=code_obj.id,
        program_id=code_obj.program_id,
        referrer_user_id=code_obj.user_id,
    )
```

**Resource Usage Concerns:**
- Ensure `ReferralCodeRepository.get_by_code` uses efficient queries and indexes to avoid blocking database operations.
- Use context managers for any database connections or file handles to ensure they are properly closed.

---

*Generated by CodeWorm on 2026-02-21 21:25*
