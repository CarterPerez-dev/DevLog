# extract_request_features

**Type:** Performance Analysis
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/app/core/features/extractor.py
**Language:** python
**Lines:** 41-105
**Complexity:** 10.0

---

## Source Code

```python
def extract_request_features(
    entry: ParsedLogEntry,
    country_code: str = "",
) -> dict[str, int | float | bool | str]:
    """
    Extract 23 stateless per-request features from a parsed log entry.
    """
    full_uri = entry.path
    if entry.query_string:
        full_uri = f"{entry.path}?{entry.query_string}"

    ua_lower = entry.user_agent.lower()
    non_alnum = sum(1 for c in entry.path if not c.isalnum())
    path_len = len(entry.path)

    _, ext = splitext(entry.path)

    return {
        "http_method":
        entry.method,
        "path_depth":
        len([s for s in entry.path.split("/") if s]),
        "path_entropy":
        _shannon_entropy(entry.path),
        "path_length":
        path_len,
        "query_string_length":
        len(entry.query_string),
        "query_param_count":
        (len(entry.query_string.split("&")) if entry.query_string else 0),
        "has_encoded_chars":
        bool(ENCODED_CHARS.search(full_uri)),
        "has_double_encoding":
        bool(DOUBLE_ENCODED.search(full_uri)),
        "status_code":
        entry.status_code,
        "status_class":
        f"{entry.status_code // 100}xx",
        "response_size":
        entry.response_size,
        "hour_of_day":
        entry.timestamp.hour,
        "day_of_week":
        entry.timestamp.weekday(),
        "is_weekend":
        entry.timestamp.weekday() >= 5,
        "ua_length":
        len(entry.user_agent),
        "ua_entropy":
        _shannon_entropy(entry.user_agent),
        "is_known_bot":
        any(sig in ua_lower for sig in BOT_USER_AGENTS),
        "is_known_scanner":
        any(sig in ua_lower for sig in SCANNER_USER_AGENTS),
        "has_attack_pattern":
        bool(ATTACK_COMBINED.search(full_uri)),
        "special_char_ratio":
        non_alnum / path_len if path_len else 0.0,
        "file_extension":
        ext,
        "country_code":
        country_code,
        "is_private_ip":
        _is_private_ip(entry.ip),
    }
```

---

## Performance Analysis

### Performance Analysis

**Time Complexity:** The function has a time complexity of \(O(n)\), where \(n\) is the length of `entry.path`. This is due to operations like splitting, iterating over characters, and computing entropy.

**Space Complexity:** The space complexity is also \(O(n)\) because intermediate strings and lists are created during processing. However, most of these can be optimized for better memory usage.

**Bottlenecks or Inefficiencies:**
1. **Redundant Operations:** Computing `path_len` twice (once in the dictionary return).
2. **String Manipulations:** Repeatedly splitting and joining strings (`entry.path.split("/")`, `entry.query_string.split("&")`) can be costly.
3. **Regex Searches:** Using regex multiple times on potentially large strings could be inefficient.

**Optimization Opportunities:**
1. **Memoization:** Cache the results of `_shannon_entropy` for repeated calls with the same input.
2. **Precompute Path Lengths:** Store `path_len` in a variable to avoid redundant calculations.
3. **Efficient String Handling:** Use more efficient string operations and avoid unnecessary splits.

**Resource Usage Concerns:**
- Ensure that regex patterns (`ENCODED_CHARS`, `DOUBLE_ENCODED`, etc.) are compiled once outside the function for better performance.
- Consider using context managers or `with` statements to manage resources if any external dependencies are used internally.

By addressing these points, you can significantly improve both the time and space efficiency of your function.

---

*Generated by CodeWorm on 2026-02-28 08:18*
