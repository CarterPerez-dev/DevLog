# InsightsService.get_performance_rankings

**Type:** Performance Analysis
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/analytics/facets/insights/service.py
**Language:** python
**Lines:** 119-176
**Complexity:** 5.0

---

## Source Code

```python
async def get_performance_rankings(
        session: AsyncSession,
        limit: int = 10,
    ) -> PerformanceRankingsResponse:
        """Get top performing videos by different metrics"""
        videos = await InsightsRepository.get_all_videos(session)

        def to_video_performance(video) -> VideoPerformance:
            return VideoPerformance(
                id = str(video.id),
                rank = video.rank,
                hook = video.hook,
                views = video.views,
                engagement_rate = InsightsRepository.
                calculate_engagement_rate(video),
                follower_conversion_rate = InsightsRepository.
                calculate_follower_conversion_rate(video),
                avg_watch_time = video.avg_watch_time,
                watched_full_video_percentage = video.
                watched_full_video_percentage,
                date_posted = video.date_posted.isoformat(),
            )

        by_views = sorted(
            videos,
            key = lambda v: v.views,
            reverse = True
        )[: limit]
        by_engagement = sorted(
            videos,
            key = lambda v: InsightsRepository.
            calculate_engagement_rate(v),
            reverse = True
        )[: limit]
        by_followers = sorted(
            videos,
            key = lambda v: InsightsRepository.
            calculate_follower_conversion_rate(v),
            reverse = True
        )[: limit]
        by_watch_time = sorted(
            videos,
            key = lambda v: v.avg_watch_time,
            reverse = True
        )[: limit]

        return PerformanceRankingsResponse(
            by_views = [to_video_performance(v) for v in by_views],
            by_engagement_rate = [
                to_video_performance(v) for v in by_engagement
            ],
            by_follower_conversion = [
                to_video_performance(v) for v in by_followers
            ],
            by_watch_time = [
                to_video_performance(v) for v in by_watch_time
            ],
        )
```

---

## Performance Analysis

### Performance Analysis

**Time Complexity:** The function has a time complexity of \(O(n \log n)\) due to the sorting operations, where \(n\) is the number of videos. Each sort operation involves comparing and rearranging elements, making it efficient for small to medium-sized datasets.

**Space Complexity:** The space complexity is \(O(n + m)\), where \(m\) is the number of rankings (4 in this case). This includes storing the sorted lists and the final response object.

**Bottlenecks or Inefficiencies:**
1. **Redundant Sorting:** Each ranking metric requires sorting all videos, even though only a subset (`limit`) is used.
2. **Repeated Calculations:** `calculate_engagement_rate` and `calculate_follower_conversion_rate` are called multiple times for each video.

**Optimization Opportunities:**
1. **Use Partial Sorts:** Instead of fully sorting the list, use partial sorts or selection algorithms to retrieve only the top `limit` elements.
2. **Memoization:** Cache the results of `calculate_engagement_rate` and `calculate_follower_conversion_rate` to avoid redundant calculations.

**Resource Usage Concerns:**
- Ensure that `AsyncSession` is properly managed within an async context, using `async with` to avoid resource leaks.
- Consider implementing a caching mechanism for frequently accessed video metrics to reduce database queries.

By optimizing the sorting and reducing redundant operations, you can significantly improve the performance of this function.

---

*Generated by CodeWorm on 2026-03-01 11:35*
