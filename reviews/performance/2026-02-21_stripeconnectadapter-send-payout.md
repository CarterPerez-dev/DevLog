# StripeConnectAdapter.send_payout

**Type:** Performance Analysis
**Repository:** stripe-referral
**File:** src/stripe_referral/adapters/stripe_connect.py
**Language:** python
**Lines:** 36-106
**Complexity:** 8.0

---

## Source Code

```python
def send_payout(
        self,
        user_id: str,
        amount: float,
        currency: str,
        recipient_data: dict[str,
                             Any],
    ) -> PayoutResult:
        """
        Send payout via Stripe Connect transfer
        """
        try:
            connected_account_id = recipient_data.get(
                "stripe_connect_account_id"
            )
            if not connected_account_id:
                return PayoutResult(
                    success = False,
                    error =
                    "Missing stripe_connect_account_id in recipient_data",
                )

            if not connected_account_id.startswith(
                    STRIPE_CONNECT_ACCOUNT_ID_PREFIX):
                return PayoutResult(
                    success = False,
                    error =
                    f"Invalid Stripe account ID format: {connected_account_id}",
                )

            amount_cents = int(amount * 100)

            transfer = stripe.Transfer.create(
                amount = amount_cents,
                currency = currency.lower(),
                destination = connected_account_id,
                metadata = {"user_id": user_id},
            )

            if not transfer.id.startswith(STRIPE_TRANSFER_ID_PREFIX):
                return PayoutResult(
                    success = False,
                    error =
                    f"Unexpected transfer ID format: {transfer.id}",
                )

            return PayoutResult(
                success = True,
                transaction_id = transfer.id,
            )

        except stripe.InvalidRequestError as e:
            return PayoutResult(
                success = False,
                error = f"Invalid request: {str(e)}",
            )
        except stripe.AuthenticationError as e:
            return PayoutResult(
                success = False,
                error = f"Authentication failed: {str(e)}",
            )
        except stripe.StripeError as e:
            return PayoutResult(
                success = False,
                error = f"Stripe error: {str(e)}",
            )
        except Exception as e:
            return PayoutResult(
                success = False,
                error = f"Unexpected error: {str(e)}",
            )
```

---

## Performance Analysis

### Performance Analysis

**Time Complexity:** The function has a time complexity of \(O(1)\), as it performs a fixed number of operations regardless of input size.

**Space Complexity:** The space complexity is also \(O(1)\) since the function uses a constant amount of additional memory for variables and does not create large data structures that grow with input size.

**Bottlenecks or Inefficiencies:**
- **Redundant Operations:** The `recipient_data.get("stripe_connect_account_id")` check is redundant if `connected_account_id` is guaranteed to be present.
- **Error Handling Overkill:** Multiple exception handlers catch broad exceptions, which can hide specific issues and make debugging harder.

**Optimization Opportunities:**
- Remove the redundant check for `stripe_connect_account_id`.
- Use more specific exception handling to improve error logging and debugging. For example, use separate handlers for `InvalidRequestError`, `AuthenticationError`, etc.
- Consider using a context manager or decorator to handle common setup/teardown logic.

**Resource Usage Concerns:**
- Ensure that all external dependencies (like Stripe API calls) are properly managed, especially in async contexts if this function is part of an asynchronous workflow. Use `async with` for managing connections and file handles.
- No resource leaks detected; ensure all connections and files are closed when not needed.

By refining the error handling and ensuring no redundant operations, you can improve both readability and performance slightly.

---

*Generated by CodeWorm on 2026-02-21 21:12*
