# BulkUploadService.list_user_batches

**Type:** Performance Analysis
**Repository:** vuemantics
**File:** backend/services/bulk_upload_service.py
**Language:** python
**Lines:** 280-327
**Complexity:** 7.0

---

## Source Code

```python
async def list_user_batches(
        user_id: UUID,
        limit: int = config.BATCH_LIST_DEFAULT_LIMIT,
        offset: int = config.BATCH_LIST_DEFAULT_OFFSET,
    ) -> list[BatchStatusResult]:
        """
        List batches for a user

        Args:
            user_id: User UUID
            limit: Max results
            offset: Skip N results

        Returns:
            List of BatchStatusResult
        """
        # Validate pagination parameters
        if limit < 1 or limit > config.BATCH_LIST_MAX_LIMIT:
            raise ValidationError(
                f"Limit must be between 1 and {config.BATCH_LIST_MAX_LIMIT}"
            )

        if offset < 0:
            raise ValidationError("Offset must be non-negative")

        batches = await UploadBatch.find_by_user(
            user_id = user_id,
            limit = min(limit,
                        config.BATCH_LIST_MAX_LIMIT),
            offset = offset,
        )

        return [
            BatchStatusResult(
                batch_id = batch.id,
                status = batch.status,
                total_uploads = batch.total_uploads,
                processed_uploads = batch.processed_uploads,
                successful_uploads = batch.successful_uploads,
                failed_uploads = batch.failed_uploads,
                progress_percentage = batch.get_progress_percentage(),
                created_at = batch.created_at.isoformat() if batch.created_at else None,
                started_at = None,  # Not needed for list view
                completed_at = batch.completed_at.isoformat() if batch.completed_at else None,
                error_message = None,  # Not needed for list view
            )
            for batch in batches
        ]
```

---

## Performance Analysis

### Performance Analysis

**Time Complexity:** The function has a time complexity of \(O(n)\), where \(n\) is the number of batches returned by `UploadBatch.find_by_user`. This is because the function iterates over all found batches to construct the result list.

**Space Complexity:** The space complexity is also \(O(n)\) due to the storage required for the list of `BatchStatusResult` objects. Each object contains several attributes, which can be memory-intensive if there are many batches.

**Bottlenecks and Inefficiencies:**
- **Redundant Operations:** The function constructs a new `BatchStatusResult` instance for each batch, even though some fields (like `started_at` and `error_message`) are not used in the list view. This can be optimized by filtering out unused attributes.
- **Validation Checks:** The validation checks on `limit` and `offset` are necessary but could be more efficient if they were moved to a separate method or handled earlier.

**Optimization Opportunities:**
- **Filter Unused Attributes:** Remove fields that are not needed in the list view, reducing memory usage and processing time.
  ```python
  return [
      BatchStatusResult(
          batch_id=batch.id,
          status=batch.status,
          total_uploads=batch.total_uploads,
          processed_uploads=batch.processed_uploads,
          successful_uploads=batch.successful_uploads,
          failed_uploads=batch.failed_uploads,
          progress_percentage=batch.get_progress_percentage(),
          created_at=batch.created_at.isoformat() if batch.created_at else None,
      )
      for batch in batches
  ]
  ```

- **Move Validation to a Separate Method:** Create a separate method for validation checks to make the code cleaner and potentially more efficient.
  ```python
  def validate_pagination(limit, offset):
      if limit < 1 or limit > config.BATCH_LIST_MAX_LIMIT:
          raise ValidationError(
              f"Limit must be between 1 and {config.BATCH_LIST_MAX_LIMIT}"
          )
      if offset < 0:
          raise ValidationError("Offset must be non-negative")

  # Call validate_pagination before the query
  validate_pagination(limit, offset)
  ```

**Resource Usage Concerns:**
- Ensure that `UploadBatch.find_by_user` is optimized and does not perform unnecessary database queries. Consider using caching mechanisms like Redis to store frequently accessed batch data.
- Use context managers for any database connections or file handles if they are used elsewhere in the codebase.

By implementing these optimizations, you can improve both the performance and memory efficiency of your function.

---

*Generated by CodeWorm on 2026-02-21 22:33*
