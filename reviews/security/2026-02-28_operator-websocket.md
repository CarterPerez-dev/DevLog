# operator_websocket

**Type:** Security Review
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/beginner/c2-beacon/backend/app/ops/router.py
**Language:** python
**Lines:** 45-110
**Complexity:** 7.0

---

## Source Code

```python
async def operator_websocket(ws: WebSocket) -> None:
    """
    WebSocket endpoint for operator dashboard connections
    """
    ops_manager: OpsManager = ws.app.state.ops_manager
    registry: BeaconRegistry = ws.app.state.registry
    task_manager: TaskManager = ws.app.state.task_manager

    await ops_manager.connect(ws)

    try:
        async with get_db() as db:
            beacons = await registry.get_all(db)

        beacon_list = []
        for b in beacons:
            record = b.model_dump()
            record["active"] = registry.is_active(b.id)
            beacon_list.append(record)

        await ws.send_text(json.dumps({
            "type": "beacon_list",
            "payload": beacon_list,
        }))

        while True:
            raw = await ws.receive_text()
            data = json.loads(raw)

            if data.get("type") == "submit_task":
                payload = data["payload"]
                task = TaskRecord(
                    id = str(uuid.uuid4()),
                    beacon_id = payload["beacon_id"],
                    command = CommandType(payload["command"]),
                    args = payload.get("args"),
                )

                async with get_db() as db:
                    await task_manager.submit(task, db)

                await ws.send_text(
                    json.dumps(
                        {
                            "type": "task_submitted",
                            "payload": {
                                "local_id": payload.get("local_id"),
                                "task_id": task.id,
                            },
                        }
                    )
                )

                logger.info(
                    "Task %s (%s) submitted for beacon %s",
                    task.id,
                    task.command,
                    task.beacon_id,
                )

    except WebSocketDisconnect:
        pass
    except json.JSONDecodeError:
        logger.warning("Invalid JSON from operator")
    finally:
        ops_manager.disconnect(ws)
```

---

## Security Review

### Security Review for `operator_websocket` Function

#### Vulnerabilities Found:

1. **XSS (Cross-Site Scripting)** - **Severity: Medium**
   - Line 26: The beacon records are sent directly to the client without sanitization, which could lead to XSS attacks if a beacon contains malicious content.

2. **Input Validation Gaps** - **Severity: Low**
   - Lines 38-41: The `TaskRecord` fields are constructed from user input (`data["payload"]`) but no validation is performed on the command or args parameters, which could lead to unexpected behavior.

#### Attack Vectors:

- An attacker could inject malicious content into beacon records or task commands to execute arbitrary JavaScript in the client's browser.
- Malformed JSON payloads could cause the WebSocket connection to fail unexpectedly.

#### Recommended Fixes:

1. **Sanitize Beacon Records**:
   - Use HTML escaping functions before sending beacon records to the client (Line 26).

2. **Validate Input Parameters**:
   - Implement input validation for `command` and `args` in `TaskRecord` construction (Lines 38-41). For example, ensure that `command` is a valid CommandType.

#### Overall Security Posture:

The code has some basic security practices but lacks robust input validation and output sanitization. Improving these areas will enhance the overall security posture of the application. Consider implementing additional logging and error handling to provide more detailed insights into potential issues.

---

*Generated by CodeWorm on 2026-02-28 19:37*
