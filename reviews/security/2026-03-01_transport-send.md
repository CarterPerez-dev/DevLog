# Transport.send

**Type:** Security Review
**Repository:** Telehook
**File:** src/telehook/transport.py
**Language:** python
**Lines:** 32-49
**Complexity:** 3.0

---

## Source Code

```python
async def send(self, message: Message) -> dict[str, Any]:
        payload = message.to_payload(chat_id = self._config.chat_id)
        response = await self._client.post(self._config.send_url, json = payload)
        data = response.json()

        if not data.get("ok"):
            retry_after = None
            params = data.get("parameters", {})
            if params:
                retry_after = params.get("retry_after")
            raise TelegramAPIError(
                status_code = response.status_code,
                description = data.get("description",
                                       "Unknown error"),
                retry_after = retry_after,
            )

        return data["result"]
```

---

## Security Review

### Security Review for `Transport.send` Function

#### Vulnerabilities Found:

1. **Information Disclosure** - **Severity: Medium**
   - The error handling leaks information about the API response, which could be used to infer details about the internal structure of the Telegram API.
   - **Line 6-9**: The error message includes sensitive data like `status_code` and a generic "Unknown error" message.

2. **Potential Race Conditions** - **Severity: Low**
   - While not explicitly present, there's potential for race conditions if multiple requests are made to the same endpoint simultaneously.
   - **Line 6-9**: Ensure that shared state or resources are properly managed in concurrent environments.

#### Attack Vectors:

- An attacker could exploit the error handling by crafting specific inputs to infer internal API structure and behavior.

#### Recommended Fixes:

1. **Error Handling**:
   - Use a more generic error message: `description = data.get("description", "Service unavailable")`.
   - **Line 6-9**: 
     ```python
     if not data.get("ok"):
         retry_after = None
         params = data.get("parameters", {})
         if params:
             retry_after = params.get("retry_after")
         raise TelegramAPIError(
             status_code=response.status_code,
             description="Service unavailable",
             retry_after=retry_after,
         )
     ```

2. **Concurrency Management**:
   - Ensure that shared resources are thread-safe or use appropriate synchronization mechanisms.
   - Consider using `asyncio.Lock` to manage concurrent access if necessary.

#### Overall Security Posture:

The code has a moderate security posture with some potential areas for improvement, particularly in error handling and concurrency management. Addressing the mentioned issues will enhance the robustness and security of the application.

---

*Generated by CodeWorm on 2026-03-01 19:50*
