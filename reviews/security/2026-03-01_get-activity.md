# get_activity

**Type:** Security Review
**Repository:** CodeWorm
**File:** dashboard/backend/api.py
**Language:** python
**Lines:** 217-236
**Complexity:** 3.0

---

## Source Code

```python
async def get_activity(
    days: int = Query(default = 90,
                      ge = 1,
                      le = 365),
) -> list[ActivityDay]:
    db = _get_db_path()
    if not db.exists():
        return []

    with _get_conn() as conn:
        rows = conn.execute(
            "SELECT date(documented_at) AS day, COUNT(*) AS cnt "
            "FROM documented_snippets "
            "WHERE documented_at > datetime('now', ?) "
            "GROUP BY day ORDER BY day",
            (f"-{days} days",
             ),
        ).fetchall()

    return [ActivityDay(date = row["day"], count = row["cnt"]) for row in rows]
```

---

## Security Review

### Security Review for `get_activity` Function

#### Vulnerabilities Found:

1. **SQL Injection** - **Severity: Medium**
   - **Line 8**: The SQL query uses a parameterized query, which is good. However, the date calculation `"datetime('now', ?)"` might be vulnerable if the input isn't properly sanitized.

2. **Input Validation Gap** - **Severity: Low**
   - **Line 4**: The `days` parameter validation only checks bounds but doesn't validate the type or format of the input.

3. **Hardcoded Secrets or Credentials** - **Severity: Info**
   - No hardcoded secrets or credentials found in the provided code snippet.

#### Attack Vectors:

- An attacker could manipulate the `days` parameter to potentially bypass intended logic or inject malicious SQL.
- Improper date calculation might allow injection if not validated properly.

#### Recommended Fixes:

1. **SQL Injection**:
   - Ensure that any user input used in date calculations is sanitized and validated.
   - Consider using a library like `sqlalchemy` for ORM, which can handle date calculations safely.

2. **Input Validation Gap**:
   - Add type hints and explicit validation for the `days` parameter to ensure it's an integer.
   ```python
   days: int = Query(default=90, ge=1, le=365, gt=0)
   ```

#### Overall Security Posture:

The code is relatively secure but can be improved by addressing the noted issues. Proper validation and sanitization of inputs are crucial to prevent SQL injection and ensure the integrity of date calculations.

### Fix Example

```python
from datetime import timedelta

async def get_activity(
    days: int = Query(default=90, ge=1, le=365, gt=0),
) -> list[ActivityDay]:
    db = _get_db_path()
    if not db.exists():
        return []

    with _get_conn() as conn:
        date_threshold = (datetime.now() - timedelta(days=days)).strftime('%Y-%m-%d')
        rows = conn.execute(
            "SELECT date(documented_at) AS day, COUNT(*) AS cnt "
            "FROM documented_snippets "
            "WHERE documented_at > ? "
            "GROUP BY day ORDER BY day",
            (date_threshold,)
        ).fetchall()

    return [ActivityDay(date=row["day"], count=row["cnt"]) for row in rows]
```

This refines the date calculation and ensures proper validation of the `days` parameter.

---

*Generated by CodeWorm on 2026-03-01 17:31*
