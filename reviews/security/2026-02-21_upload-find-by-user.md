# Upload.find_by_user

**Type:** Security Review
**Repository:** vuemantics
**File:** backend/models/Upload.py
**Language:** python
**Lines:** 287-358
**Complexity:** 6.0

---

## Source Code

```python
async def find_by_user(
        cls,
        user_id: UUID,
        limit: int = config.DEFAULT_PAGE_SIZE,
        offset: int = 0,
        file_type: str | None = None,
        status: str | None = None,
        show_hidden: bool = False,
        sort_by: str = "created_at",
        sort_order: str = "desc",
    ) -> list[Upload]:
        """
        Find uploads by user with optional filters.

        Args:
            user_id: User's ID
            limit: Maximum results
            offset: Skip N results
            file_type: Filter by file type
            status: Filter by processing status
            show_hidden: If True, include hidden uploads
            sort_by: Field to sort by (created_at, updated_at, file_size, filename)
            sort_order: Sort direction (asc or desc)

        Returns:
            List of Upload instances
        """
        await cls.ensure_table_exists()

        conditions = ["user_id = $1"]
        params: list[Any] = [user_id]
        param_count = 1

        if file_type:
            param_count += 1
            conditions.append(f"file_type = ${param_count}")
            params.append(file_type)

        if status:
            param_count += 1
            conditions.append(f"processing_status = ${param_count}")
            params.append(status)

        if not show_hidden:
            conditions.append("hidden = FALSE")

        where_clause = " AND ".join(conditions)

        # Validate and sanitize sort params (prevent SQL injection)
        valid_sort_fields = {
            "created_at",
            "updated_at",
            "file_size",
            "filename"
        }
        if sort_by not in valid_sort_fields:
            sort_by = "created_at"

        valid_sort_orders = {"asc", "desc"}
        if sort_order.lower() not in valid_sort_orders:
            sort_order = "desc"

        query = f"""
            SELECT * FROM uploads
            WHERE {where_clause}
            ORDER BY {sort_by} {sort_order.upper()}
            LIMIT ${param_count + 1} OFFSET ${param_count + 2}
        """

        params.extend([limit, offset])
        records = await database.db.fetch(query, *params)
        return cls.from_records(records)
```

---

## Security Review

### Security Review for `Upload.find_by_user`

#### Vulnerabilities Found:

1. **SQL Injection** - **Severity: Medium**
   - Line 29: The query string is constructed using user-provided parameters without proper sanitization, which could lead to SQL injection if the `where_clause` or `sort_by`, `sort_order` are not properly validated.

2. **Input Validation Gaps** - **Severity: Low**
   - While the sort fields and order are somewhat validated, there is no explicit validation for the `user_id`. Ensure it is a valid UUID before use.

#### Attack Vectors:

- An attacker could manipulate the query parameters to execute arbitrary SQL commands or bypass filters.
- Improper validation of `user_id` might allow unauthorized access.

#### Recommended Fixes:

1. **SQL Injection Prevention**:
   - Use parameterized queries instead of string interpolation for dynamic parts of the SQL query.
   ```python
   query = f"""
       SELECT * FROM uploads
       WHERE {' AND '.join(conditions)}
       ORDER BY {sort_by} {sort_order.upper()}
       LIMIT $({param_count + 1}) OFFSET $({param_count + 2})
   """
   ```

2. **UUID Validation**:
   - Validate `user_id` as a UUID before use.
   ```python
   if not user_id or not isinstance(user_id, UUID):
       raise ValueError("Invalid user ID")
   ```

3. **Error Handling**:
   - Ensure proper error handling to avoid leaking information about the database schema.

#### Overall Security Posture:

The code has some vulnerabilities that could be exploited, but with the suggested fixes, it can be significantly hardened. Proper input validation and parameterized queries are crucial to prevent SQL injection and ensure data integrity.

---

*Generated by CodeWorm on 2026-02-21 13:44*
