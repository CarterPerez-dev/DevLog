# process_achievements_for_user

**Type:** Security Review
**Repository:** CertGames-Core
**File:** backend/api/domains/progression/services/unlock_engine.py
**Language:** python
**Lines:** 20-104
**Complexity:** 22.0

---

## Source Code

```python
def process_achievements_for_user():
    """
    Checks all achievement criteria against a user's progress
    and unlocks any that have been earned.
    """
    user = g.user

    counters = user.achievement_counters or {}
    unlocked = set(UserAchievementService.get_achievement_ids(user))
    newly_unlocked = []

    all_achievements = AchievementService.get_all()

    for ach in all_achievements:
        aid = ach.achievementId

        if aid in unlocked:
            continue

        crit = ach.criteria or {}

        if any(checker(crit,
                       counters,
                       user) for checker in CRITERIA_CHECKERS):
            unlocked.add(aid)
            newly_unlocked.append(aid)

    if newly_unlocked:
        current_time = datetime.now(UTC)
        total_xp_reward = 0
        total_coin_reward = 0

        for achievement_id in newly_unlocked:

            def get_ach_id(ach):
                return ach.get('achievementId') if isinstance(
                    ach,
                    dict
                ) else ach.achievementId

            if not any(get_ach_id(ach) == achievement_id
                       for ach in user.achievements_v2):
                user.achievements_v2.append(
                    UserAchievement(
                        achievementId = achievement_id,
                        unlockedAt = current_time
                    )
                )

                achievement = next(
                    (
                        ach for ach in all_achievements
                        if ach.achievementId == achievement_id
                    ),
                    None
                )
                if achievement:
                    total_xp_reward += achievement.xpReward or 0
                    total_coin_reward += achievement.coinReward or 0

        user.update(set__achievements_v2 = user.achievements_v2)

        if total_xp_reward > 0 or total_coin_reward > 0:
            if total_xp_reward > 0 and total_coin_reward > 0:
                ProgressionService.update_xp_and_coins(
                    user,
                    total_xp_reward,
                    total_coin_reward
                )
            elif total_xp_reward > 0:
                ProgressionService.update_xp(user, total_xp_reward)
            elif total_coin_reward > 0:
                ProgressionService.update_coins(user, total_coin_reward)

        user.reload()

        g.user = user

        AuditLogger.log_action(
            action = "achievements_unlocked",
            user_id = str(user.id),
            data = {"newly_unlocked": newly_unlocked},
        )

    return newly_unlocked
```

---

## Security Review

### Security Review

#### Vulnerabilities Found:

1. **Info - Input Validation Gaps**: The `CRITERIA_CHECKERS` list is used to validate achievement criteria, but no specific input validation or sanitization is applied to the criteria or counters. This could potentially allow for unexpected behavior if the criteria are misconfigured.

2. **Info - Insecure Deserialization**: While not directly present in this code snippet, deserialization vulnerabilities can occur if `UserAchievement` and `all_achievements` objects contain serialized data that could be manipulated.

3. **Info - Error Handling**: The function does not handle potential exceptions from database operations or service calls, which might leak information about the application's internal state.

4. **Info - Hardcoded Secrets or Credentials**: No hardcoded secrets are found in this snippet, but ensure no such values exist elsewhere in the codebase.

5. **Info - Race Conditions and TOCTOU Bugs**: The `user.reload()` call could potentially race with other operations on the same user object, leading to inconsistent state if not properly synchronized.

#### Attack Vectors:

- Misconfigured criteria could lead to unintended achievement unlocks.
- Potential deserialization attacks if objects contain serialized data.

#### Recommended Fixes:

1. **Input Validation**: Ensure all inputs from `CRITERIA_CHECKERS` are validated and sanitized before use.
2. **Error Handling**: Implement try-except blocks around database operations and service calls to handle exceptions gracefully without leaking sensitive information.
3. **Synchronization**: Use locks or other synchronization mechanisms when accessing shared user objects to prevent race conditions.

#### Overall Security Posture:

The code has a moderate security posture, with some potential issues that could be mitigated by implementing the recommended fixes. Ensure comprehensive input validation and robust error handling practices are followed throughout the application.

---

*Generated by CodeWorm on 2026-02-19 22:33*
