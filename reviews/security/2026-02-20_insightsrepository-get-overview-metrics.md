# InsightsRepository.get_overview_metrics

**Type:** Security Review
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/analytics/facets/insights/repository.py
**Language:** python
**Lines:** 73-103
**Complexity:** 10.0

---

## Source Code

```python
async def get_overview_metrics(session: AsyncSession) -> dict:
        """Calculate overall performance metrics"""
        result = await session.execute(
            select(
                func.count(TikTokVideo.id).label("total_videos"),
                func.sum(TikTokVideo.views).label("total_views"),
                func.sum(TikTokVideo.likes).label("total_likes"),
                func.sum(TikTokVideo.comments).label("total_comments"),
                func.sum(TikTokVideo.shares).label("total_shares"),
                func.sum(TikTokVideo.bookmarks).label("total_bookmarks"),
                func.sum(TikTokVideo.new_followers).label("total_new_followers"),
                func.avg(TikTokVideo.avg_watch_time).label("avg_watch_time"),
                func.avg(TikTokVideo.watched_full_video_percentage).label("avg_watch_percentage"),
                func.min(TikTokVideo.date_posted).label("min_date"),
                func.max(TikTokVideo.date_posted).label("max_date"),
            )
        )
        row = result.one()
        return {
            "total_videos": row.total_videos or 0,
            "total_views": row.total_views or 0,
            "total_likes": row.total_likes or 0,
            "total_comments": row.total_comments or 0,
            "total_shares": row.total_shares or 0,
            "total_bookmarks": row.total_bookmarks or 0,
            "total_new_followers": row.total_new_followers or 0,
            "avg_watch_time": float(row.avg_watch_time or 0),
            "avg_watch_percentage": float(row.avg_watch_percentage or 0),
            "min_date": row.min_date,
            "max_date": row.max_date,
        }
```

---

## Security Review

### Security Review

#### Vulnerabilities Found:

1. **SQL Injection**: The code uses SQLAlchemy's `select` function, which is safe from SQL injection as long as the table and column names are not dynamically constructed based on user input (line 3-5). Severity: **Low**.

2. **Information Leakage**: Error handling is minimal; if a query fails, it might return an empty result rather than raising an exception or logging an error (lines 6-8). Severity: **Medium**.

#### Attack Vectors:

- An attacker could attempt to manipulate the SQL query by injecting malicious input into the table or column names. However, this is mitigated by using SQLAlchemy's ORM.
- If a database error occurs and is not properly handled, it might leak information about the underlying database structure or state.

#### Recommended Fixes:

1. **Error Handling**: Implement proper error handling to log exceptions without exposing sensitive information (line 7).
   ```python
   try:
       result = await session.execute(query)
       row = result.one()
       return ...
   except Exception as e:
       logger.error(f"Database query failed: {e}")
       raise HTTPException(status_code=500, detail="Internal server error")
   ```

2. **Logging**: Log the metrics and errors to a secure logging service rather than printing them.

#### Overall Security Posture:

The code is relatively safe from SQL injection due to its use of SQLAlchemy's ORM. However, improving error handling and logging practices will enhance the security posture by preventing information leakage and ensuring robustness in case of database issues.

---

*Generated by CodeWorm on 2026-02-20 23:59*
