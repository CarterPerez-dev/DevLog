# PayoutService.create_program

**Type:** Security Review
**Repository:** stripe-referral
**File:** src/stripe_referral/services/payout_service.py
**Language:** python
**Lines:** 69-115
**Complexity:** 4.0

---

## Source Code

```python
def create_program(
        db: Session,
        name: str,
        program_key: str,
        reward_amount: float,
        *,
        reward_currency: str = CurrencyCode.USD.value,
        reward_type: str = RewardType.ONE_TIME.value,
        adapter_type: str = AdapterType.MANUAL.value,
        max_rewards_per_user: int | None = None,
        conversion_window_days: int | None = None,
        adapter_config: dict[str,
                             Any] | None = None,
    ) -> ProgramInfo:
        """
        Create a new referral program
        """
        valid_adapter_types = [at.value for at in AdapterType]
        if adapter_type not in valid_adapter_types:
            raise InvalidRecipientDataError(
                f"Invalid adapter_type. Must be one of: {valid_adapter_types}",
                adapter_type = adapter_type,
            )

        program_repo = ReferralProgramRepository(db)

        program = program_repo.create(
            name = name,
            program_key = program_key,
            reward_amount = reward_amount,
            reward_currency = reward_currency,
            reward_type = reward_type,
            adapter_type = adapter_type,
            max_rewards_per_user = max_rewards_per_user,
            conversion_window_days = conversion_window_days,
            adapter_config = adapter_config or {},
        )

        return ProgramInfo(
            id = program.id,
            name = program.name,
            program_key = program.program_key,
            reward_amount = program.reward_amount,
            reward_currency = program.reward_currency,
            reward_type = program.reward_type,
            is_active = program.is_active,
        )
```

---

## Security Review

### Security Review

**Vulnerabilities Found:**

- **Input Validation Gap (Medium):** The `adapter_type` parameter is validated against a list of valid adapter types, but this validation could be improved by using a more robust method like enum checks or type hints.

- **Hardcoded Secrets or Credentials (Info):** No hardcoded secrets are found in the provided code snippet. Ensure no such secrets exist elsewhere in the repository.

**Attack Vectors:**

- An attacker could potentially inject invalid `adapter_type` values, leading to unexpected behavior or errors.

**Recommended Fixes:**

1. **Input Validation Gap:** Use a more robust validation method:
   ```python
   from enum import Enum

   class AdapterType(Enum):
       MANUAL = "manual"
       AUTOMATED = "automated"

   if adapter_type not in [at.value for at in AdapterType]:
       raise InvalidRecipientDataError(f"Invalid adapter_type. Must be one of: {AdapterType}")
   ```

2. **Documentation and Testing:** Ensure comprehensive unit tests cover all validation scenarios.

**Overall Security Posture:**

The code is relatively secure, but the input validation can be strengthened to prevent unexpected behavior. Implementing a more robust validation mechanism will enhance security posture by ensuring only valid adapter types are accepted.

---

*Generated by CodeWorm on 2026-02-21 12:25*
