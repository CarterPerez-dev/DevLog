# ReferralService.track_referral

**Type:** Security Review
**Repository:** stripe-referral
**File:** src/stripe_referral/services/referral_service.py
**Language:** python
**Lines:** 130-186
**Complexity:** 4.0

---

## Source Code

```python
def track_referral(
        db: Session,
        code: str,
        referred_user_id: str,
        transaction_id: str | None = None,
        transaction_amount: float | None = None,
    ) -> TrackReferralResult:
        """
        Track a successful referral conversion
        """
        code_repo = ReferralCodeRepository(db)
        tracking_repo = ReferralTrackingRepository(db)
        program_repo = ReferralProgramRepository(db)

        ReferralService.validate_code(db, code)

        code_obj = code_repo.get_by_code(code)
        if not code_obj:
            raise CodeNotFoundError(
                f"Code '{code}' not found",
                code = code
            )

        if code_obj.user_id == referred_user_id:
            raise SelfReferralError(
                "Cannot use your own referral code",
                user_id = referred_user_id,
            )

        program = program_repo.get_by_id(code_obj.program_id)
        if not program:
            raise ProgramNotFoundError(
                f"Program ID {code_obj.program_id} not found",
                program_id = code_obj.program_id,
            )

        tracking = tracking_repo.create(
            referrer_user_id = code_obj.user_id,
            referred_user_id = referred_user_id,
            code_id = code_obj.id,
            program_id = program.id,
            transaction_id = transaction_id,
            transaction_amount = transaction_amount,
            amount_earned = program.reward_amount,
            currency = program.reward_currency,
        )

        code_repo.increment_uses(code_obj.id)

        return TrackReferralResult(
            tracking_id = tracking.id,
            referrer_user_id = tracking.referrer_user_id,
            referred_user_id = tracking.referred_user_id,
            amount_earned = tracking.amount_earned,
            currency = tracking.currency,
            converted_at = tracking.converted_at.isoformat(),
        )
```

---

## Security Review

### Security Review for `ReferralService.track_referral`

#### Vulnerabilities and Severity

1. **Info: Input Validation Gaps**
   - **Line 8**: `referred_user_id` is a string, but no validation ensures it's a valid user ID.
   - **Severity**: Info

2. **Info: Error Handling Leaks Information**
   - **Lines 13-19**: Custom error messages include sensitive information like the code or program IDs.
   - **Severity**: Info

3. **High: Potential TOCTOU Bug**
   - **Line 40**: `code_repo.increment_uses` may race with other operations, leading to inconsistent state.
   - **Attack Vector**: Concurrent requests could increment uses incorrectly if not properly synchronized.
   - **Fix**: Use a transaction or atomic operation.

#### Recommended Fixes

1. **Input Validation**
   ```python
   referred_user_id = int(referred_user_id)  # Ensure it's an integer user ID
   ```

2. **Error Handling**
   ```python
   raise CodeNotFoundError(f"Code '{code}' not found")
   raise SelfReferralError("Cannot use your own referral code")
   raise ProgramNotFoundError(f"Program ID {code_obj.program_id} not found")
   ```

3. **Race Condition Fix**
   ```python
   with db.begin_nested():
       tracking_repo.create(..., transaction_id=transaction_id, transaction_amount=transaction_amount)
       code_repo.increment_uses(code_obj.id)
   ```

#### Overall Security Posture

The current implementation is secure but could benefit from improved input validation and error handling to prevent information leaks. Addressing the TOCTOU bug ensures data integrity during concurrent operations.

---

*Generated by CodeWorm on 2026-02-21 12:40*
