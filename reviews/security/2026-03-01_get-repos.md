# get_repos

**Type:** Security Review
**Repository:** CodeWorm
**File:** dashboard/backend/api.py
**Language:** python
**Lines:** 109-155
**Complexity:** 7.0

---

## Source Code

```python
async def get_repos() -> list[RepoStatus]:
    config_dir = Path(os.environ.get("CODEWORM_CONFIG_DIR", "config"))
    repos_path = config_dir / "repos.yaml"

    repos: list[RepoStatus] = []
    if repos_path.exists():
        import yaml

        with repos_path.open() as f:
            data = yaml.safe_load(f) or {}

        db = _get_db_path()
        repo_counts: dict[str, int] = {}
        repo_last: dict[str, str] = {}

        if db.exists():
            with _get_conn() as conn:
                for row in conn.execute(
                        "SELECT source_repo, COUNT(*), MAX(documented_at) "
                        "FROM documented_snippets GROUP BY source_repo"
                ).fetchall():
                    repo_counts[row[0]] = row[1]
                    repo_last[row[0]] = row[2]

        for entry in data.get("repositories", []):
            from datetime import datetime

            name = entry.get("name", "")
            last_str = repo_last.get(name)
            last_dt = datetime.fromisoformat(last_str) if last_str else None

            repos.append(
                RepoStatus(
                    name = name,
                    path = str(entry.get("path",
                                         "")),
                    weight = entry.get("weight",
                                       5),
                    enabled = entry.get("enabled",
                                        True),
                    docs_generated = repo_counts.get(name,
                                                     0),
                    last_activity = last_dt,
                )
            )

    return repos
```

---

## Security Review

### Security Review for `get_repos` Function

#### Vulnerabilities Found:

1. **Hardcoded Secrets or Credentials:**
   - Severity: Low
   - The function does not contain hardcoded secrets, but it relies on environment variables which should be properly managed.

2. **Input Validation Gaps:**
   - Severity: Medium
   - `repos.yaml` content is loaded without validation. Ensure that the YAML data is validated to prevent deserialization issues or injection attacks.
   
3. **Error Handling:**
   - Severity: Low
   - Error handling could be improved, especially around file operations and database queries.

4. **Overall Security Posture:**
   - The function has a moderate security posture with no critical vulnerabilities but requires improvements in data validation and error handling.

#### Recommended Fixes:

1. **Input Validation:**
   ```python
   from pydantic import BaseModel, validator

   class RepoEntry(BaseModel):
       name: str
       path: str = ""
       weight: int = 5
       enabled: bool = True

       @validator('path')
       def validate_path(cls, v):
           if not os.path.exists(v):
               raise ValueError("Path does not exist")
           return v
   ```

2. **Error Handling:**
   ```python
   try:
       with repos_path.open() as f:
           data = yaml.safe_load(f) or {}
   except (yaml.YAMLError, FileNotFoundError) as e:
       logger.error(f"Failed to load repos.yaml: {e}")
       return []
   ```

3. **Database Query Safety:**
   - Ensure that the database query is safe and does not expose any SQL injection risks.

By implementing these fixes, you can enhance the security posture of your code.

---

*Generated by CodeWorm on 2026-03-01 16:14*
