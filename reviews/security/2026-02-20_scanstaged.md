# scanStaged

**Type:** Security Review
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/intermediate/secrets-scanner/internal/source/git.go
**Language:** go
**Lines:** 73-135
**Complexity:** 16.0

---

## Source Code

```go
func (g *Git) scanStaged(
	ctx context.Context,
	repo *git.Repository,
	out chan<- types.Chunk,
) error {
	wt, err := repo.Worktree()
	if err != nil {
		return fmt.Errorf("worktree: %w", err)
	}

	status, err := wt.Status()
	if err != nil {
		return fmt.Errorf("status: %w", err)
	}

	idx, err := repo.Storer.Index()
	if err != nil {
		return fmt.Errorf("index: %w", err)
	}

	for _, entry := range idx.Entries {
		if ctx.Err() != nil {
			return ctx.Err()
		}

		fileStatus := status.File(entry.Name)
		if fileStatus.Staging == git.Unmodified &&
			fileStatus.Worktree == git.Unmodified {
			continue
		}

		if g.isExcluded(entry.Name) || isBinaryExt(entry.Name) {
			continue
		}

		blob, blobErr := repo.BlobObject(entry.Hash)
		if blobErr != nil {
			continue
		}

		if blob.Size > g.MaxSize {
			continue
		}

		content, readErr := readBlob(blob)
		if readErr != nil {
			continue
		}

		chunks := splitIntoChunks(
			content, entry.Name, "", "", time.Time{},
		)
		for _, chunk := range chunks {
			select {
			case <-ctx.Done():
				return ctx.Err()
			case out <- chunk:
			}
		}
	}

	return nil
}
```

---

## Security Review

### Security Review for `scanStaged` Function

#### Vulnerabilities and Severity:

1. **Input Validation Gaps** (Medium):
   - The function iterates over index entries without validating the input filenames.
   - **Severity**: Medium
   - **Attack Vector**: Maliciously crafted filenames could potentially exploit vulnerabilities in file handling or cause unexpected behavior.

2. **Error Handling** (Info):
   - Some error checks are handled with `continue`, which may suppress errors and hide potential issues.
   - **Severity**: Info

3. **Overall Security Posture**:
   - The function is generally secure but could benefit from more robust input validation and comprehensive error handling.

#### Recommended Fixes:

1. **Input Validation**:
   - Validate filenames to ensure they do not contain malicious characters or paths.
     ```go
     if !isValidFilename(entry.Name) {
         continue
     }
     ```

2. **Error Handling**:
   - Log errors instead of silently continuing to avoid hiding issues.
     ```go
     log.Printf("Failed to read blob: %v", readErr)
     continue
     ```

3. **Function Documentation and Comments**:
   - Add comments explaining the purpose of each validation step for better readability.

#### Concrete Fixes:

```go
func (g *Git) scanStaged(
	ctx context.Context,
	repo *git.Repository,
	out chan<- types.Chunk,
) error {
	wt, err := repo.Worktree()
	if err != nil {
		return fmt.Errorf("worktree: %w", err)
	}

	status, err := wt.Status()
	if err != nil {
		return fmt.Errorf("status: %w", err)
	}

	idx, err := repo.Storer.Index()
	if err != nil {
		return fmt.Errorf("index: %w", err)
	}

	for _, entry := range idx.Entries {
		if ctx.Err() != nil {
			return ctx.Err()
		}

		fileStatus := status.File(entry.Name)
		if fileStatus.Staging == git.Unmodified &&
			fileStatus.Worktree == git.Unmodified {
			continue
		}

		if !isValidFilename(entry.Name) || isBinaryExt(entry.Name) {
			continue
		}

		blob, blobErr := repo.BlobObject(entry.Hash)
		if blobErr != nil {
			log.Printf("Failed to get blob object: %v", blobErr)
			continue
		}

		if blob.Size > g.MaxSize {
			continue
		}

		content, readErr := readBlob(blob)
		if readErr != nil {
			log.Printf("Failed to read blob content: %v", readErr)
			continue
		}

		chunks := splitIntoChunks(
			content, entry.Name, "", "", time.Time{},
		)
		for _, chunk := range chunks {
			select {
			case <-ctx.Done():
				return ctx.Err()
			case out <- chunk:
			}
		}
	}

	return nil
}

func isValidFilename(filename string) bool {
	// Implement validation logic here.
	return true
}
```

This review highlights the need for input validation and improved error handling to enhance the security posture of the function.

---

*Generated by CodeWorm on 2026-02-20 08:34*
