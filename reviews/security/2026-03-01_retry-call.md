# Retry.__call__

**Type:** Security Review
**Repository:** Telehook
**File:** src/telehook/middleware/retry.py
**Language:** python
**Lines:** 18-39
**Complexity:** 8.0

---

## Source Code

```python
async def __call__(self, message: Message, next_: SendFunc) -> None:
        last_error: TelegramAPIError | None = None

        for attempt in range(self._max_attempts):
            try:
                await next_(message)
                return
            except TelegramAPIError as e:
                if e.status_code < 500 and e.status_code != 429:
                    raise

                last_error = e

                if attempt < self._max_attempts - 1:
                    if e.retry_after:
                        delay = min(e.retry_after, 60)
                    else:
                        delay = self._initial_backoff * (2**attempt)
                    await asyncio.sleep(delay)

        if last_error:
            raise last_error
```

---

## Security Review

### Security Review for `Retry.__call__` Method

#### Vulnerabilities and Severity:

1. **Info - Error Handling Leakage**: The function catches `TelegramAPIError` but does not handle other potential exceptions, which could leak information about the application's internal state.
2. **Info - Lack of Input Validation**: While input validation is not directly applicable here, ensuring that `Message` and `SendFunc` are properly validated elsewhere in the codebase would be beneficial.

#### Attack Vectors:

- An attacker could exploit unhandled exceptions to gain insights into the applicationâ€™s error handling mechanisms.
- If `TelegramAPIError` contains sensitive information (e.g., API keys or user data), it could be leaked through error messages.

#### Recommended Fixes:

1. **Enhance Error Handling**:
   ```python
   except Exception as e:
       logger.error(f"Unexpected error: {str(e)}", exc_info=True)
       raise
   ```

2. **Document and Validate Inputs**: Ensure that `Message` and `SendFunc` are validated elsewhere in the codebase.

3. **Review and Secure Logging**:
   - Use structured logging to avoid exposing sensitive information.
   - Implement a secure logging mechanism to prevent logs from containing sensitive data.

#### Overall Security Posture:

The current implementation is relatively safe but could benefit from improved error handling and input validation practices. Ensuring that all exceptions are handled securely and that inputs are validated can significantly enhance the overall security posture of the application.

---

*Generated by CodeWorm on 2026-03-01 18:04*
