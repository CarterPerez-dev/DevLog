# run_once

**Type:** Security Review
**Repository:** CodeWorm
**File:** codeworm/cli.py
**Language:** python
**Lines:** 125-173
**Complexity:** 8.0

---

## Source Code

```python
def run_once(
    ctx: click.Context,
    devlog: Path | None,
    repo: tuple,
    dry_run: bool
) -> None:
    """
    Run a single documentation cycle then exit
    """
    from codeworm.daemon import CodeWormDaemon

    overrides = {"debug": ctx.obj["debug"]}

    if devlog:
        overrides["devlog"] = {"repo_path": devlog}

    if repo:
        repos = [
            {
                "name": name,
                "path": Path(path),
                "weight": 5
            } for name, path in repo
        ]
        overrides["repos"] = repos

    settings = load_settings(config_dir = ctx.obj["config_dir"], **overrides)
    redis_url = settings.dashboard.redis.connection_url if settings.dashboard.redis.enabled else ""
    configure_logging(debug = settings.debug, redis_url = redis_url)

    if not settings.repos:
        console.print("[red]Error:[/red] No repositories configured")
        console.print("Add repos to config/repos.yaml or use --repo NAME PATH")
        raise SystemExit(1)

    mode = "[yellow][DRY RUN][/yellow] " if dry_run else ""
    console.print(f"{mode}[bold]Running single documentation cycle...[/bold]")
    console.print(f"  DevLog: {settings.devlog.repo_path}")
    console.print(f"  Repos: {[r.name for r in settings.repos]}")

    daemon = CodeWormDaemon(settings)
    result = asyncio.run(daemon.run_once(dry_run = dry_run))

    if result:
        console.print("[green]Documentation generated successfully[/green]")
    else:
        console.print(
            "[yellow]No candidates found or all already documented[/yellow]"
        )
```

---

## Security Review

### Security Review for `run_once` Function

#### Vulnerabilities and Severity:

1. **Info: Hardcoded Secrets or Credentials**
   - No hardcoded secrets detected.

2. **Low: Input Validation Gaps**
   - Line 19: The `repo` parameter is a tuple, but the validation of its content (e.g., paths) is missing.
   - Suggestion: Validate and sanitize input paths to prevent directory traversal attacks.

3. **Info: Error Handling that Leaks Information**
   - Line 28-30: Error messages provide minimal information but could be improved for security.
   - Suggestion: Use generic error messages to avoid leaking sensitive details.

4. **Info: Insecure Deserialization**
   - No insecure deserialization detected.

5. **Info: Race Conditions and TOCTOU Bugs**
   - No race conditions or TOCTOU bugs identified.

6. **Info: Authentication and Authorization Issues**
   - No explicit authentication or authorization checks found.

7. **Info: Injection Vulnerabilities (SQL, Command, XSS)**
   - No SQL, command, or XSS injection vulnerabilities detected.

#### Attack Vectors:
- Potential for directory traversal if `repo` paths are not validated.
- Information leakage through error messages could be exploited in certain scenarios.

#### Recommended Fixes:

1. **Input Validation:**
   ```python
   repos = [
       {
           "name": name,
           "path": Path(path).resolve(),  # Resolve to absolute path
           "weight": 5
       } for name, path in repo if Path(path).exists()
   ]
   ```

2. **Error Handling:**
   ```python
   if not settings.repos:
       console.print("[red]Error:[/red] No repositories configured")
       raise SystemExit(1)
   ```

3. **Overall Security Posture:**
   - The function is generally secure but could benefit from improved input validation and error handling.
   - Consider implementing logging for more detailed error messages without exposing sensitive information.

By addressing these minor issues, the overall security posture of the `run_once` function can be significantly enhanced.

---

*Generated by CodeWorm on 2026-02-21 15:34*
