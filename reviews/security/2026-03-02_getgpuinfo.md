# GetGPUInfo

**Type:** Security Review
**Repository:** Yoshi-Audit
**File:** internal/system/gpu.go
**Language:** go
**Lines:** 31-67
**Complexity:** 6.0

---

## Source Code

```go
func GetGPUInfo() (GPUInfo, error) {
	out, err := exec.Command(
		"nvidia-smi",
		"--query-gpu=utilization.gpu,memory.used,memory.total",
		"--format=csv,noheader,nounits",
	).Output()
	if err != nil {
		return GPUInfo{}, fmt.Errorf("nvidia-smi failed: %w", err)
	}

	line := strings.TrimSpace(string(out))
	parts := strings.Split(line, ",")
	if len(parts) < 3 {
		return GPUInfo{}, fmt.Errorf("unexpected nvidia-smi output: %q", line)
	}

	util, err := strconv.ParseFloat(strings.TrimSpace(parts[0]), 64)
	if err != nil {
		return GPUInfo{}, fmt.Errorf("failed to parse utilization: %w", err)
	}

	usedMiB, err := strconv.ParseUint(strings.TrimSpace(parts[1]), 10, 64)
	if err != nil {
		return GPUInfo{}, fmt.Errorf("failed to parse used memory: %w", err)
	}

	totalMiB, err := strconv.ParseUint(strings.TrimSpace(parts[2]), 10, 64)
	if err != nil {
		return GPUInfo{}, fmt.Errorf("failed to parse total memory: %w", err)
	}

	return GPUInfo{
		Utilization: util,
		UsedVRAM:    usedMiB * 1024 * 1024,
		TotalVRAM:   totalMiB * 1024 * 1024,
	}, nil
}
```

---

## Security Review

### Security Review for `GetGPUInfo` Function

**Vulnerabilities:**

1. **Injection Vulnerability (Low):**
   - The command is constructed using fixed strings, so there's no risk of injection.

2. **Input Validation Gap (Medium):**
   - The function assumes the output format will always be as expected. If `nvidia-smi` changes its output format, this could lead to errors or misinterpretation.
   
3. **Error Handling (Info):**
   - Error handling is adequate but could provide more context in case of failure.

4. **Overall Security Posture:**
   - The function is relatively secure with no critical vulnerabilities. However, it lacks robust error handling and input validation.

**Recommendations:**

1. **Improve Input Validation:**
   ```go
   if len(parts) != 3 {
       return GPUInfo{}, fmt.Errorf("unexpected nvidia-smi output format: %q", line)
   }
   ```

2. **Enhance Error Handling:**
   - Provide more detailed error messages to help with debugging.
   ```go
   func GetGPUInfo() (GPUInfo, error) {
       out, err := exec.Command(
           "nvidia-smi",
           "--query-gpu=utilization.gpu,memory.used,memory.total",
           "--format=csv,noheader,nounits",
       ).Output()
       if err != nil {
           return GPUInfo{}, fmt.Errorf("failed to execute nvidia-smi: %w", err)
       }

       line := strings.TrimSpace(string(out))
       parts := strings.Split(line, ",")
       if len(parts) != 3 {
           return GPUInfo{}, fmt.Errorf("unexpected nvidia-smi output format: %q", line)
       }

       util, err := strconv.ParseFloat(strings.TrimSpace(parts[0]), 64)
       if err != nil {
           return GPUInfo{}, fmt.Errorf("failed to parse utilization: %w", err)
       }

       usedMiB, err := strconv.ParseUint(strings.TrimSpace(parts[1]), 10, 64)
       if err != nil {
           return GPUInfo{}, fmt.Errorf("failed to parse used memory: %w", err)
       }

       totalMiB, err := strconv.ParseUint(strings.TrimSpace(parts[2]), 10, 64)
       if err != nil {
           return GPUInfo{}, fmt.Errorf("failed to parse total memory: %w", err)
       }

       return GPUInfo{
           Utilization: util,
           UsedVRAM:    usedMiB * 1024 * 1024,
           TotalVRAM:   totalMiB * 1024 * 1024,
       }, nil
   }
   ```

By addressing these points, the function will be more robust and secure.

---

*Generated by CodeWorm on 2026-03-02 00:30*
