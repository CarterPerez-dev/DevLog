# loadMixamoAnimation

**Type:** Security Review
**Repository:** angelamos-3d
**File:** frontend/src/lib/animation/loadMixamoAnimation.ts
**Language:** typescript
**Lines:** 11-87
**Complexity:** 7.0

---

## Source Code

```typescript
async function loadMixamoAnimation(
	url: string,
	vrm: VRM,
): Promise<THREE.AnimationClip> {
	const loader = new FBXLoader();
	const asset = await loader.loadAsync(url);

	const clip = THREE.AnimationClip.findByName(asset.animations, "mixamo.com");
	if (!clip) throw new Error("mixamo.com animation clip not found");

	const tracks: THREE.KeyframeTrack[] = [];

	const restRotationInverse = new THREE.Quaternion();
	const parentRestWorldRotation = new THREE.Quaternion();
	const _quatA = new THREE.Quaternion();

	const motionHipsHeight =
		asset.getObjectByName("mixamorigHips")?.position.y ?? 1;
	const vrmHipsY = vrm.humanoid?.normalizedRestPose?.hips?.position?.[1] ?? 1;
	const hipsPositionScale = vrmHipsY / motionHipsHeight;

	clip.tracks.forEach((track) => {
		const trackSplitted = track.name.split(".");
		const mixamoRigName = trackSplitted[0];
		const vrmBoneName = mixamoVRMRigMap[mixamoRigName];
		const vrmNodeName = vrm.humanoid?.getNormalizedBoneNode(vrmBoneName)?.name;
		const mixamoRigNode = asset.getObjectByName(mixamoRigName);

		if (vrmNodeName != null && mixamoRigNode != null) {
			const propertyName = trackSplitted[1];

			mixamoRigNode.getWorldQuaternion(restRotationInverse).invert();
			mixamoRigNode.parent?.getWorldQuaternion(parentRestWorldRotation);

			if (track instanceof THREE.QuaternionKeyframeTrack) {
				for (let i = 0; i < track.values.length; i += 4) {
					const flatQuaternion = track.values.slice(i, i + 4);

					_quatA.fromArray(flatQuaternion);
					_quatA
						.premultiply(parentRestWorldRotation)
						.multiply(restRotationInverse);
					_quatA.toArray(flatQuaternion);

					flatQuaternion.forEach((v, index) => {
						track.values[index + i] = v;
					});
				}

				tracks.push(
					new THREE.QuaternionKeyframeTrack(
						`${vrmNodeName}.${propertyName}`,
						track.times,
						track.values.map((v, i) =>
							vrm.meta?.metaVersion === "0" && i % 2 === 0 ? -v : v,
						),
					),
				);
			} else if (track instanceof THREE.VectorKeyframeTrack) {
				const value = track.values.map(
					(v, i) =>
						(vrm.meta?.metaVersion === "0" && i % 3 !== 1 ? -v : v) *
						hipsPositionScale,
				);
				tracks.push(
					new THREE.VectorKeyframeTrack(
						`${vrmNodeName}.${propertyName}`,
						track.times,
						value,
					),
				);
			}
		}
	});

	return new THREE.AnimationClip("vrmAnimation", clip.duration, tracks);
}
```

---

## Security Review

### Security Review for `loadMixamoAnimation` Function

#### Vulnerabilities and Severity:

1. **Input Validation Gaps** (Medium):
   - The function accepts a URL as input without any validation or sanitization.
   - **Line 6**: `const asset = await loader.loadAsync(url);`
     - An attacker could inject malicious content into the URL, potentially leading to unexpected behavior or security issues.

2. **Error Handling Leaks Information** (Low):
   - The function throws an error if the clip is not found.
   - **Line 13**: `if (!clip) throw new Error("mixamo.com animation clip not found");`
     - This could leak information about the asset structure to attackers.

#### Attack Vectors:

- An attacker could provide a crafted URL to inject malicious content or exploit vulnerabilities in the FBXLoader.
- The error message might reveal sensitive information about the expected structure of the loaded assets.

#### Recommended Fixes:

1. **Input Validation**:
   - Validate and sanitize the `url` input before passing it to `loader.loadAsync`.
     ```typescript
     if (!/^[^<>:"\/\\|?*]+(\.[^<>:"\/\\|?*]+)*$/.test(url)) {
       throw new Error("Invalid URL");
     }
     ```

2. **Error Handling**:
   - Catch and handle errors more gracefully to avoid leaking information.
     ```typescript
     try {
       const asset = await loader.loadAsync(url);
       // ... rest of the function ...
     } catch (error) {
       console.error("Failed to load animation:", error);
       throw new Error("Failed to load mixamo.com animation clip");
     }
     ```

#### Overall Security Posture:

The current implementation has moderate security risks due to potential injection vulnerabilities and error handling issues. Addressing these gaps will improve the overall security posture of the function.

---

*Generated by CodeWorm on 2026-03-01 14:46*
