# User.create

**Type:** Security Review
**Repository:** vuemantics
**File:** backend/models/User.py
**Language:** python
**Lines:** 67-100
**Complexity:** 4.0

---

## Source Code

```python
async def create(
        cls,
        email: str,
        password_hash: str,
        is_active: bool = True
    ) -> User:
        """
        Create a new user
        """
        await cls.ensure_table_exists()

        query = """
            INSERT INTO users (email, password_hash, is_active)
            VALUES ($1, $2, $3)
            RETURNING *
        """

        try:
            record = await database.db.fetchrow(
                query,
                email.lower(),
                password_hash,
                is_active
            )
            if record is None:
                raise ValueError("Failed to create user")
            user = cls.from_record(record)
            if user is None:
                raise ValueError("Failed to create user from record")
            return user
        except UniqueViolationError as e:
            raise ValueError(
                f"User with email {email} already exists"
            ) from e
```

---

## Security Review

### Security Review for `User.create` Method

**Vulnerabilities Found:**

1. **SQL Injection**: Line 8 uses parameterized queries, which are safe and prevent SQL injection.

2. **Error Handling (Info)**:
   - **Severity**: Info
   - **Issue**: The error handling catches a generic `UniqueViolationError`, but does not provide specific context about the violation.
   - **Recommendation**: Use more specific exceptions to handle different types of violations, such as `IntegrityError`.

3. **Input Validation (Medium)**:
   - **Severity**: Medium
   - **Issue**: The method accepts raw email and password_hash inputs without validation.
   - **Recommendation**: Add input validation for `email` and `password_hash`. For example, ensure the email is properly formatted.

4. **Overall Security Posture**:
   - The code uses parameterized queries to prevent SQL injection, which is good practice.
   - However, there are areas where additional validation and specific error handling can improve security.

### Attack Vectors

- An attacker could attempt to bypass input validation by providing malformed email addresses or weak password hashes.
- Improper error handling might leak information about the database schema or existing users.

### Recommended Fixes

1. **Add Input Validation**:
   ```python
   import re

   if not re.match(r"[^@]+@[^@]+\.[^@]+", email):
       raise ValueError("Invalid email format")
   ```

2. **Improve Error Handling**:
   ```python
   from sqlalchemy.exc import IntegrityError

   try:
       # ...
   except IntegrityError as e:
       raise ValueError(f"User with email {email} already exists") from e
   ```

3. **Document and Test Security**:
   - Ensure all input fields are validated.
   - Regularly test the application for vulnerabilities.

By addressing these issues, you can significantly enhance the security posture of your application.

---

*Generated by CodeWorm on 2026-02-21 14:25*
