# ReferralService.validate_code

**Type:** Security Review
**Repository:** stripe-referral
**File:** src/stripe_referral/services/referral_service.py
**Language:** python
**Lines:** 86-127
**Complexity:** 7.0

---

## Source Code

```python
def validate_code(db: Session, code: str) -> CodeValidation:
        """
        Validate if a code is active and usable
        """
        code_repo = ReferralCodeRepository(db)

        code_obj = code_repo.get_by_code(code)
        if not code_obj:
            raise CodeNotFoundError(
                f"Code '{code}' not found",
                code = code
            )

        if code_obj.status != ReferralCodeStatus.ACTIVE.value:
            raise CodeInactiveError(
                f"Code '{code}' is inactive (status: {code_obj.status})",
                code = code,
                status = code_obj.status,
            )

        if code_obj.expires_at and code_obj.expires_at < datetime.now(UTC
                                                                      ):
            raise CodeExpiredError(
                f"Code '{code}' expired at {code_obj.expires_at.isoformat()}",
                code = code,
                expires_at = code_obj.expires_at.isoformat(),
            )

        if code_obj.max_uses and code_obj.uses_count >= code_obj.max_uses:
            raise CodeMaxUsesReachedError(
                f"Code '{code}' has reached maximum uses ({code_obj.max_uses})",
                code = code,
                max_uses = code_obj.max_uses,
                uses_count = code_obj.uses_count,
            )

        return CodeValidation(
            valid = True,
            code_id = code_obj.id,
            program_id = code_obj.program_id,
            referrer_user_id = code_obj.user_id,
        )
```

---

## Security Review

### Security Review for `stripe-referral/src/stripe_referral/services/referral_service.py`

#### Vulnerabilities and Severity

1. **Input Validation Gaps** - **Medium**
   - The function does not validate the input `code` parameter, which could lead to unexpected behavior if an invalid or maliciously crafted string is passed.
   
2. **Hardcoded Secrets or Credentials** - **Info**
   - No hardcoded secrets are found in the provided code snippet.

3. **Error Handling that Leaks Information** - **Low**
   - The error messages provide some information about the state of the referral code, but they do not disclose sensitive data.

4. **Overall Security Posture** - **Medium**
   - The function is well-structured and handles common validation cases, but it could benefit from more robust input validation and improved error handling.

#### Attack Vectors

1. **Invalid Code Input**: An attacker could pass an invalid or maliciously crafted `code` string that might cause unexpected behavior in the application.
2. **Information Disclosure**: The error messages provide some information about the state of the referral code, which could be used for further attacks if not handled properly.

#### Recommended Fixes

1. **Input Validation**:
   - Add input validation to ensure `code` is a valid string before processing it.
     ```python
     if not isinstance(code, str) or len(code) < 1:
         raise ValueError("Invalid code format")
     ```

2. **Error Handling**:
   - Customize error messages to avoid leaking sensitive information.
     ```python
     from fastapi import HTTPException

     def validate_code(db: Session, code: str) -> CodeValidation:
         # ... existing code ...
         except Exception as e:
             raise HTTPException(status_code=400, detail=str(e))
     ```

3. **Context Managers**:
   - Use context managers for database sessions to ensure they are properly closed.
     ```python
     from sqlalchemy.orm import Session

     def validate_code(db: Session, code: str) -> CodeValidation:
         with db.begin():
             # ... existing code ...
     ```

By implementing these changes, the security posture of the function can be significantly improved.

---

*Generated by CodeWorm on 2026-02-21 12:45*
