# get_recent

**Type:** Security Review
**Repository:** CodeWorm
**File:** dashboard/backend/api.py
**Language:** python
**Lines:** 149-197
**Complexity:** 8.0

---

## Source Code

```python
async def get_recent(
    limit: int = Query(default=50, ge=1, le=200),
    offset: int = Query(default=0, ge=0),
    repo: str | None = Query(default=None),
    doc_type: str | None = Query(default=None),
) -> list[RecentDoc]:
    db = _get_db_path()
    if not db.exists():
        return []

    query = "SELECT * FROM documented_snippets"
    params: list = []
    conditions: list[str] = []
    has_doc_type = False

    with _get_conn() as check_conn:
        has_doc_type = _has_column(check_conn, "documented_snippets", "doc_type")

    if repo:
        conditions.append("source_repo = ?")
        params.append(repo)
    if doc_type and has_doc_type:
        conditions.append("doc_type = ?")
        params.append(doc_type)

    if conditions:
        query += " WHERE " + " AND ".join(conditions)

    query += " ORDER BY documented_at DESC LIMIT ? OFFSET ?"
    params.extend([limit, offset])

    with _get_conn() as conn:
        rows = conn.execute(query, params).fetchall()

    results = []
    for row in rows:
        results.append(RecentDoc(
            id=row["id"],
            source_repo=row["source_repo"],
            source_file=row["source_file"],
            function_name=row["function_name"],
            class_name=row["class_name"],
            doc_type=row["doc_type"] if "doc_type" in row.keys() else "function_doc",
            documented_at=row["documented_at"],
            snippet_path=row["snippet_path"],
            git_commit=row["git_commit"],
        ))

    return results
```

---

## Security Review

### Security Review for `get_recent` Function

#### Vulnerabilities Found:

1. **SQL Injection** - **Severity: High**
   - Line 15-20: The SQL query is constructed with user input (`repo`, `doc_type`) without proper parameterization, which can lead to SQL injection.

2. **Input Validation Gaps** - **Severity: Medium**
   - Lines 7-9: While the `limit` and `offset` parameters are validated, there's no validation for `repo` or `doc_type`.

3. **Hardcoded Secrets or Credentials** - **Severity: Info**
   - No hardcoded secrets found in the snippet.

4. **Error Handling** - **Severity: Low**
   - Minimal error handling; consider adding try-except blocks to handle database connection errors and query execution failures.

#### Attack Vectors:

- An attacker could manipulate `repo` or `doc_type` to inject malicious SQL code.
- Lack of validation for `repo` and `doc_type` can lead to unexpected behavior or data leakage.

#### Recommended Fixes:

1. **SQL Injection Fix**:
   - Use parameterized queries to safely include user inputs in the SQL statement.
     ```python
     query += " WHERE 1=1"
     if repo:
         query += f" AND source_repo = ?"
         params.append(repo)
     if doc_type and has_doc_type:
         query += f" AND doc_type = ?"
         params.append(doc_type)
     ```

2. **Input Validation**:
   - Add validation for `repo` and `doc_type` to ensure they are within expected ranges.
     ```python
     repo = validate_repo(repo)  # Implement this function
     doc_type = validate_doc_type(doc_type)  # Implement this function
     ```

3. **Error Handling**:
   - Enhance error handling by catching exceptions and logging errors.
     ```python
     try:
         rows = conn.execute(query, params).fetchall()
     except sqlite3.Error as e:
         logger.error(f"Database error: {e}")
         return []
     ```

#### Overall Security Posture:

The current code has significant SQL injection risks that need immediate attention. Addressing these issues will significantly improve the security posture of the application.

---

*Generated by CodeWorm on 2026-02-21 16:18*
