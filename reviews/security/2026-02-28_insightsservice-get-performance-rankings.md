# InsightsService.get_performance_rankings

**Type:** Security Review
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/analytics/facets/insights/service.py
**Language:** python
**Lines:** 119-176
**Complexity:** 5.0

---

## Source Code

```python
async def get_performance_rankings(
        session: AsyncSession,
        limit: int = 10,
    ) -> PerformanceRankingsResponse:
        """Get top performing videos by different metrics"""
        videos = await InsightsRepository.get_all_videos(session)

        def to_video_performance(video) -> VideoPerformance:
            return VideoPerformance(
                id = str(video.id),
                rank = video.rank,
                hook = video.hook,
                views = video.views,
                engagement_rate = InsightsRepository.
                calculate_engagement_rate(video),
                follower_conversion_rate = InsightsRepository.
                calculate_follower_conversion_rate(video),
                avg_watch_time = video.avg_watch_time,
                watched_full_video_percentage = video.
                watched_full_video_percentage,
                date_posted = video.date_posted.isoformat(),
            )

        by_views = sorted(
            videos,
            key = lambda v: v.views,
            reverse = True
        )[: limit]
        by_engagement = sorted(
            videos,
            key = lambda v: InsightsRepository.
            calculate_engagement_rate(v),
            reverse = True
        )[: limit]
        by_followers = sorted(
            videos,
            key = lambda v: InsightsRepository.
            calculate_follower_conversion_rate(v),
            reverse = True
        )[: limit]
        by_watch_time = sorted(
            videos,
            key = lambda v: v.avg_watch_time,
            reverse = True
        )[: limit]

        return PerformanceRankingsResponse(
            by_views = [to_video_performance(v) for v in by_views],
            by_engagement_rate = [
                to_video_performance(v) for v in by_engagement
            ],
            by_follower_conversion = [
                to_video_performance(v) for v in by_followers
            ],
            by_watch_time = [
                to_video_performance(v) for v in by_watch_time
            ],
        )
```

---

## Security Review

### Security Review

**Vulnerabilities Found:**

1. **No Injection Vulnerabilities**: The code does not use user input in SQL or command execution, so no injection issues are present.
   
2. **Authentication and Authorization Issues**: None identified as the function is internal to a service.

3. **Hardcoded Secrets or Credentials**: No hardcoded secrets found.

4. **Race Conditions and TOCTOU Bugs**: Not applicable; the code does not interact with external files or systems that could cause race conditions.

5. **Input Validation Gaps**: The `limit` parameter is used directly without validation, which could lead to potential issues if an attacker can manipulate it.
   
6. **Insecure Deserialization**: No deserialization functions are present.

7. **Error Handling**: Error handling is not shown in the snippet, but ensure that exceptions are caught and handled appropriately to avoid information leakage.

**Severity:**
- Input validation gap: **Medium**

**Attack Vector:**
An attacker could potentially manipulate the `limit` parameter to cause unexpected behavior or resource exhaustion if not properly validated.

**Recommended Fixes:**
1. Validate and sanitize the `limit` parameter:
   ```python
   def get_performance_rankings(
       session: AsyncSession,
       limit: int = 10,
   ) -> PerformanceRankingsResponse:
       if not 0 < limit <= 100:  # Example validation
           raise ValueError("Limit must be between 1 and 100")
   ```

2. Ensure proper error handling to avoid information leakage.

**Overall Security Posture:**
The code is secure against common vulnerabilities but could benefit from input validation and improved error handling. Regular security audits should continue to ensure the overall security posture remains strong.

---

*Generated by CodeWorm on 2026-02-28 00:59*
