# handleStatus

**Type:** Security Review
**Repository:** angelamos-operations
**File:** CarterBot-Telegram/src/handlers/commands.ts
**Language:** typescript
**Lines:** 79-141
**Complexity:** 12.0

---

## Source Code

```typescript
async function handleStatus(ctx: Context): Promise<void> {
  const userId = ctx.from?.id;

  if (!isAuthorized(userId, ALLOWED_USERS)) {
    await ctx.reply("Unauthorized.");
    return;
  }

  const lines: string[] = ["<b>Bot Status</b>\n"];

  if (session.isActive) {
    lines.push(`Session: Active (${session.sessionId?.slice(0, 8)}...)`);
  } else {
    lines.push("Session: None");
  }

  if (session.isRunning) {
    const elapsed = session.queryStarted
      ? Math.floor((Date.now() - session.queryStarted.getTime()) / 1000)
      : 0;
    lines.push(`Query: Running (${elapsed}s)`);
    if (session.currentTool) {
      lines.push(`   ${session.currentTool}`);
    }
  } else {
    lines.push("Query: Idle");
    if (session.lastTool) {
      lines.push(`   Last: ${session.lastTool}`);
    }
  }

  if (session.lastActivity) {
    const ago = Math.floor(
      (Date.now() - session.lastActivity.getTime()) / 1000
    );
    lines.push(`\nLast activity: ${ago}s ago`);
  }

  if (session.lastUsage) {
    const usage = session.lastUsage;
    lines.push(
      `\nLast query usage:`,
      `   Input: ${usage.input_tokens?.toLocaleString() || "?"} tokens`,
      `   Output: ${usage.output_tokens?.toLocaleString() || "?"} tokens`
    );
    if (usage.cache_read_input_tokens) {
      lines.push(
        `   Cache read: ${usage.cache_read_input_tokens.toLocaleString()}`
      );
    }
  }

  if (session.lastError) {
    const ago = session.lastErrorTime
      ? Math.floor((Date.now() - session.lastErrorTime.getTime()) / 1000)
      : "?";
    lines.push(`\nLast error (${ago}s ago):`, `   ${session.lastError}`);
  }

  lines.push(`\nWorking dir: <code>${WORKING_DIR}</code>`);

  await ctx.reply(lines.join("\n"), { parse_mode: "HTML" });
}
```

---

## Security Review

### Security Review for `handleStatus` Function

#### Vulnerabilities Found:

1. **Info - Hardcoded Secrets:**
   - **Line 28:** The path `WORKING_DIR` is hardcoded, which could expose sensitive information if the application is running on an insecure server.
   
2. **Low - Input Validation Gaps:**
   - **Lines 6-9 & 15-20:** While checking session states, there are no explicit validation checks for potential input tampering or unexpected values.

3. **Info - Error Handling:**
   - **Line 24 & 28:** The error handling is basic and could leak information about the application's internal state if an error occurs during execution.

#### Attack Vectors:

- An attacker could exploit hardcoded paths to gain unauthorized access.
- Tampering with session states or input values might lead to unexpected behavior, though this is mitigated by authorization checks.

#### Recommended Fixes:

1. **Fix Hardcoded Secrets:**
   - Move `WORKING_DIR` to a configuration file that can be updated without changing the codebase.
   
2. **Enhance Input Validation:**
   - Ensure all session states and input values are validated against expected types and ranges before processing.
   
3. **Improve Error Handling:**
   - Use try-catch blocks to handle potential errors gracefully, avoiding exposing sensitive information.

#### Overall Security Posture:

The code has some minor security issues that could be exploited if not properly managed. Addressing the hardcoded secrets and improving input validation will significantly enhance the application's security posture.

---

*Generated by CodeWorm on 2026-02-20 21:24*
