# seed_domain

**Type:** Security Review
**Repository:** my-portfolio
**File:** v1/data/tools/seed.py
**Language:** python
**Lines:** 204-278
**Complexity:** 22.0

---

## Source Code

```python
async def seed_domain(
    session: AsyncSession,
    domain: str,
    dry_run: bool = False,
    clear: bool = False,
) -> tuple[int, int]:
    config = DOMAIN_CONFIG[domain]
    model = config["model"]
    files = scan_seed_files(domain)

    if not files:
        print(f"  {color('dim', 'No files found')}")
        return 0, 0

    if clear and not dry_run:
        await session.execute(delete(model))
        print(f"  {color('yellow', 'Cleared existing records')}")

    inserted = 0
    errors = 0

    for file_path, lang_code, is_array_file in files:
        try:
            with open(file_path) as f:
                raw_data = json.load(f)

            records = raw_data if is_array_file else [raw_data]

            for idx, data in enumerate(records):
                try:
                    if "language" not in data or data["language"] is None:
                        data["language"] = lang_code

                    transformed = transform_data(data, config)

                    if dry_run:
                        label = f"{file_path.name}[{idx}]" if is_array_file else file_path.name
                        print(f"  {color('blue', '○')} {label} (dry-run)")
                    else:
                        upsert_keys = config.get("upsert_keys", [])
                        if upsert_keys:
                            stmt = insert(model).values(**transformed)
                            update_cols = {
                                k: v for k, v in transformed.items()
                                if k not in upsert_keys and k != "id"
                            }
                            stmt = stmt.on_conflict_do_update(
                                index_elements=upsert_keys,
                                set_=update_cols,
                            )
                            await session.execute(stmt)
                        else:
                            record = model(**transformed)
                            session.add(record)

                    inserted += 1

                except TypeError as e:
                    label = f"{file_path.name}[{idx}]" if is_array_file else file_path.name
                    print(f"  {color('red', '✗')} {label}: Field error - {e}")
                    errors += 1

            if not dry_run and is_array_file:
                print(f"  {color('green', '✓')} {file_path.name} ({len(records)} records)")
            elif not dry_run:
                print(f"  {color('green', '✓')} {file_path.name}")

        except json.JSONDecodeError as e:
            print(f"  {color('red', '✗')} {file_path.name}: Invalid JSON - {e}")
            errors += 1
        except Exception as e:
            print(f"  {color('red', '✗')} {file_path.name}: {e}")
            errors += 1

    return inserted, errors
```

---

## Security Review

### Security Review for `seed_domain` Function

#### Vulnerabilities and Severity:

1. **Input Validation Gaps** (Medium):
   - Line 16: The `domain` parameter is not validated, which could allow injection of invalid or malicious domain names.
   
2. **Error Handling Leaks Information** (Low):
   - Lines 45-47: Generic exceptions are caught and printed with error messages, potentially leaking information about the system.

3. **Insecure Deserialization** (Medium):
   - Line 31: JSON files are loaded without validation, which could lead to deserialization attacks if the data contains malicious code.
   
4. **Race Conditions and TOCTOU Bugs** (Low):
   - The function does not handle concurrent access or updates properly, but this is less critical in a single-threaded context.

#### Attack Vectors:

- An attacker could exploit input validation gaps to inject invalid domain names, leading to unexpected behavior or errors.
- Malicious JSON files could be uploaded, causing deserialization attacks if the data contains harmful code.

#### Recommended Fixes:

1. **Input Validation**:
   - Validate `domain` against a whitelist of allowed domains (e.g., using regex).
   
2. **Error Handling**:
   - Catch specific exceptions and handle them appropriately to avoid leaking sensitive information.
   
3. **Secure Deserialization**:
   - Use safe deserialization libraries or validate JSON content before loading.

4. **Concurrency Handling**:
   - Ensure the function is thread-safe if it will be used in a multi-threaded environment.

#### Overall Security Posture:

The code has several areas for improvement, particularly around input validation and error handling. Addressing these issues will significantly enhance the security posture of the application.

---

*Generated by CodeWorm on 2026-02-21 11:20*
