# GetGPUProcesses

**Type:** Security Review
**Repository:** Yoshi-Audit
**File:** internal/system/gpu.go
**Language:** go
**Lines:** 69-109
**Complexity:** 8.0

---

## Source Code

```go
func GetGPUProcesses() ([]GPUProcess, error) {
	out, err := exec.Command(
		"nvidia-smi",
		"--query-compute-apps=pid,used_memory",
		"--format=csv,noheader,nounits",
	).Output()
	if err != nil {
		return nil, fmt.Errorf("nvidia-smi failed: %w", err)
	}

	var procs []GPUProcess
	lines := strings.Split(strings.TrimSpace(string(out)), "\n")
	for _, line := range lines {
		line = strings.TrimSpace(line)
		if line == "" || strings.HasPrefix(line, "[") {
			continue
		}

		parts := strings.Split(line, ",")
		if len(parts) < 2 {
			continue
		}

		pid, err := strconv.Atoi(strings.TrimSpace(parts[0]))
		if err != nil {
			continue
		}

		memMiB, err := strconv.ParseUint(strings.TrimSpace(parts[1]), 10, 64)
		if err != nil {
			continue
		}

		procs = append(procs, GPUProcess{
			PID:      pid,
			UsedVRAM: memMiB * 1024 * 1024,
		})
	}

	return procs, nil
}
```

---

## Security Review

### Security Review for `GetGPUProcesses` Function

#### Vulnerabilities and Severity:

1. **Injection Vulnerability (Info)**
   - **Line:** 6-7
   - **Details:** The command is constructed using fixed strings, but the function does not contain any user input that could be injected. However, if this function were to accept a parameter for `nvidia-smi` arguments, it would introduce an injection risk.
   
2. **Input Validation Gap (Medium)**
   - **Line:** 13-15
   - **Details:** The code splits the output into parts and attempts to parse them as integers. However, there is no validation of `parts[0]` and `parts[1]`, which could lead to errors or unexpected behavior if the input format deviates.

#### Attack Vectors:

- An attacker could manipulate the `nvidia-smi` output format, causing parsing issues.
- If this function were extended to accept user inputs for command arguments, it would be vulnerable to injection attacks.

#### Recommended Fixes:

1. **Input Validation:**
   - Validate and sanitize `parts[0]` and `parts[1]` before converting them to integers:
     ```go
     if len(parts) < 2 {
         continue
     }
     
     pid, err := strconv.Atoi(strings.TrimSpace(parts[0]))
     if err != nil || pid <= 0 {
         continue
     }

     memMiB, err := strconv.ParseUint(strings.TrimSpace(parts[1]), 10, 64)
     if err != nil || memMiB == 0 {
         continue
     }
     ```

2. **Documentation and Testing:**
   - Ensure that the function's behavior is well-documented.
   - Add unit tests to cover various input scenarios.

#### Overall Security Posture:

The current implementation has minimal security risks but could benefit from better input validation and robust error handling. Addressing these issues will improve the overall security posture of the codebase.

---

*Generated by CodeWorm on 2026-03-01 23:00*
