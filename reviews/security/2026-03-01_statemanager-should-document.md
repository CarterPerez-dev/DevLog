# StateManager.should_document

**Type:** Security Review
**Repository:** CodeWorm
**File:** codeworm/core/state.py
**Language:** python
**Lines:** 137-180
**Complexity:** 4.0

---

## Source Code

```python
def should_document(
        self,
        snippet: CodeSnippet,
        doc_type: DocType = DocType.FUNCTION_DOC,
        redocument_after_days: int = 90,
    ) -> bool:
        """
        Determine if a snippet should be documented with a given doc_type
        Deduplication is scoped to (entity + doc_type) so the same code
        can have a function_doc, security_review, and TIL without conflict
        """
        code_hash = self.hash_code(snippet.source)
        with self._get_conn() as conn:
            cursor = conn.execute(
                "SELECT 1 FROM documented_snippets "
                "WHERE code_hash = ? AND doc_type = ? LIMIT 1",
                (code_hash,
                 doc_type.value),
            )
            if cursor.fetchone():
                return False

            cursor = conn.execute(
                """
                SELECT documented_at FROM documented_snippets
                WHERE source_file = ? AND function_name = ?
                    AND class_name IS ? AND doc_type = ?
                ORDER BY documented_at DESC LIMIT 1
                """,
                (
                    str(snippet.file_path),
                    snippet.function_name,
                    snippet.class_name,
                    doc_type.value,
                ),
            )
            row = cursor.fetchone()
            if row:
                last_doc = datetime.fromisoformat(row["documented_at"])
                if datetime.now() - last_doc < timedelta(
                        days = redocument_after_days):
                    return False

            return True
```

---

## Security Review

### Security Review for `StateManager.should_document`

#### Vulnerabilities Found:

1. **SQL Injection** - **Severity: Low**
   - Line 9 and 15: The SQL queries use parameterized statements, which are safe from SQL injection.

2. **Information Disclosure** - **Severity: Medium**
   - Line 17: The `cursor.fetchone()` results are not checked for `None` before accessing the dictionary keys. This could lead to a `KeyError`.
   - **Attack Vector**: An attacker might exploit this by providing crafted input that causes an unexpected result.

3. **Hardcoded Secrets or Credentials** - **Severity: Info**
   - No hardcoded secrets or credentials found in the provided code snippet.

4. **Input Validation Gaps** - **Severity: Low**
   - The `snippet` object is assumed to be validated elsewhere, but no explicit validation is shown here.

5. **Overall Security Posture** - **Medium**
   - The code has good practices regarding SQL injection and uses parameterized queries. However, there are minor issues that could be improved for robustness.

#### Recommended Fixes:

1. **Check for `None` Before Accessing Dictionary Keys:**
   ```python
   row = cursor.fetchone()
   if row is not None:
       last_doc = datetime.fromisoformat(row["documented_at"])
   ```

2. **Enhance Input Validation** (if necessary):
   - Ensure that `snippet.file_path`, `snippet.function_name`, and `snippet.class_name` are validated before use.

3. **Document and Review Code**: 
   - Document the assumptions about input validation and provide a review process for new code additions.

By addressing these issues, the overall security posture of this function can be improved to better protect against potential vulnerabilities.

---

*Generated by CodeWorm on 2026-03-01 17:13*
