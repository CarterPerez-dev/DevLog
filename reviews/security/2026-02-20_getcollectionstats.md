# GetCollectionStats

**Type:** Security Review
**Repository:** angelamos-operations
**File:** CertGamesDB-Argos/go-backend/internal/mongodb/collections.go
**Language:** go
**Lines:** 153-206
**Complexity:** 15.0

---

## Source Code

```go
func (r *CollectionsRepository) GetCollectionStats(ctx context.Context, dbName, collName string) (*CollectionStats, error) {
	db := r.client.client.Database(dbName)

	var stats bson.M
	if err := db.RunCommand(ctx, bson.D{{"collStats", collName}}).Decode(&stats); err != nil {
		return nil, fmt.Errorf("get collection stats: %w", err)
	}

	result := &CollectionStats{
		Name: collName,
	}

	if count, ok := stats["count"].(int32); ok {
		result.DocumentCount = int64(count)
	} else if count, ok := stats["count"].(int64); ok {
		result.DocumentCount = count
	}

	if size, ok := stats["size"].(int32); ok {
		result.SizeBytes = int64(size)
	} else if size, ok := stats["size"].(int64); ok {
		result.SizeBytes = size
	}

	if avgSize, ok := stats["avgObjSize"].(int32); ok {
		result.AvgDocSize = int64(avgSize)
	} else if avgSize, ok := stats["avgObjSize"].(int64); ok {
		result.AvgDocSize = avgSize
	} else if avgSize, ok := stats["avgObjSize"].(float64); ok {
		result.AvgDocSize = int64(avgSize)
	}

	if storageSize, ok := stats["storageSize"].(int32); ok {
		result.StorageSize = int64(storageSize)
	} else if storageSize, ok := stats["storageSize"].(int64); ok {
		result.StorageSize = storageSize
	}

	if nindexes, ok := stats["nindexes"].(int32); ok {
		result.IndexCount = int(nindexes)
	}

	if totalIndexSize, ok := stats["totalIndexSize"].(int32); ok {
		result.TotalIndexSize = int64(totalIndexSize)
	} else if totalIndexSize, ok := stats["totalIndexSize"].(int64); ok {
		result.TotalIndexSize = totalIndexSize
	}

	if capped, ok := stats["capped"].(bool); ok {
		result.Capped = capped
	}

	return result, nil
}
```

---

## Security Review

### Security Review for `GetCollectionStats` Function

#### Vulnerabilities Found:

1. **Input Validation Gaps** (Medium):
   - The function accepts `dbName` and `collName` as strings without any validation or sanitization.
   - Potential attack vector: An attacker could inject malicious database names or collection names to exploit vulnerabilities in the MongoDB server.

2. **Error Handling** (Low):
   - Error handling is present but could be more informative, especially when decoding JSON.
   - Suggested fix: Use `err == nil` checks and provide detailed error messages.

#### Recommended Fixes:

1. Validate input parameters:
   ```go
   if dbName == "" || collName == "" {
       return nil, fmt.Errorf("invalid database or collection name")
   }
   ```

2. Improve error handling:
   ```go
   if err := db.RunCommand(ctx, bson.D{{"collStats", collName}}).Decode(&stats); err != nil {
       return nil, fmt.Errorf("failed to get collection stats: %v", err)
   }
   ```

3. Ensure robust type assertions for JSON decoding:
   ```go
   if count, ok := stats["count"].(json.Number); ok {
       result.DocumentCount = count.Int64()
   }
   ```

#### Overall Security Posture:

The function is generally secure but could benefit from input validation and improved error handling to prevent potential injection attacks. Ensuring that all inputs are sanitized and validated can significantly enhance the security posture of this function.

---

*Generated by CodeWorm on 2026-02-20 17:22*
