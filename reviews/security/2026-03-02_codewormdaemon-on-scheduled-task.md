# CodeWormDaemon._on_scheduled_task

**Type:** Security Review
**Repository:** CodeWorm
**File:** codeworm/daemon.py
**Language:** python
**Lines:** 370-393
**Complexity:** 6.0

---

## Source Code

```python
def _on_scheduled_task(self) -> None:
        """
        Callback executed by scheduler for each documentation task
        """
        if self._loop:
            future = asyncio.run_coroutine_threadsafe(
                self._execute_documentation_cycle(),
                self._loop,
            )
            try:
                future.result(timeout = 1800)
            except Exception as e:
                self.logger.exception("scheduled_task_error", error = str(e))
                self.stats.record_failure(f"task_error: {e}")
                if self.notifier and self.stats.consecutive_failures >= self.settings.telegram.alert_after_failures:
                    self.notifier.send_error_sync(e, "scheduler")

            next_run = self.scheduler.get_next_run_time()
            if next_run:
                self.logger.info(
                    "next_scheduled_run",
                    time = next_run.isoformat()
                )
                self._emit_event("next_cycle", {"time": next_run.isoformat()})
```

---

## Security Review

### Security Review for `CodeWormDaemon._on_scheduled_task`

#### Vulnerabilities and Severity:

1. **Error Handling Leakage** - **Severity: Medium**
   - The exception message is logged with the error details, which could potentially leak sensitive information if not sanitized.
   
2. **Logging Sensitive Information** - **Severity: Low**
   - Ensure that any sensitive data (like `e`) is properly sanitized before logging.

#### Attack Vectors:

- An attacker could exploit the logging mechanism to gain insights into system state or inject malicious content, though this is mitigated by proper sanitization practices.

#### Recommended Fixes:

1. **Sanitize Logs**:
   ```python
   self.logger.exception("scheduled_task_error", error = str(e).replace("\n", "\\n"))
   ```

2. **Review Notifier Implementation**:
   Ensure that `self.notifier.send_error_sync` does not expose sensitive information.

#### Overall Security Posture:

The code is relatively secure but could benefit from additional checks, such as input validation for the `next_run` time and ensuring that the logging mechanism does not inadvertently leak sensitive data. Consider using structured logging to further enhance security practices.

---

*Generated by CodeWorm on 2026-03-02 07:26*
