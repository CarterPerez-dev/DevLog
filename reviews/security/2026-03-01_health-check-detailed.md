# health_check_detailed

**Type:** Security Review
**Repository:** my-portfolio
**File:** v1/backend/app/core/health_routes.py
**Language:** python
**Lines:** 49-80
**Complexity:** 5.0

---

## Source Code

```python
async def health_check_detailed() -> HealthDetailedResponse:
    """
    Detailed health check including database connectivity
    """
    db_status = HealthStatus.UNHEALTHY
    redis_status = None

    try:
        async with sessionmanager.connect() as conn:
            await conn.execute(text("SELECT 1"))
            db_status = HealthStatus.HEALTHY
    except Exception:
        db_status = HealthStatus.UNHEALTHY

    if settings.REDIS_URL:
        try:
            r = redis.from_url(str(settings.REDIS_URL))
            await r.ping()
            redis_status = HealthStatus.HEALTHY
            await r.close()
        except Exception:
            redis_status = HealthStatus.UNHEALTHY

    overall = HealthStatus.HEALTHY if db_status == HealthStatus.HEALTHY else HealthStatus.DEGRADED

    return HealthDetailedResponse(
        status = overall,
        environment = settings.ENVIRONMENT.value,
        version = settings.APP_VERSION,
        database = db_status,
        redis = redis_status,
    )
```

---

## Security Review

### Security Review for `health_check_detailed` Function

#### Vulnerabilities and Severity:

1. **SQL Injection** - **Critical**
   - **Line 6**: The code uses a raw SQL query with `text("SELECT 1")`, which could be vulnerable to SQL injection if the input is not sanitized.

2. **Hardcoded Secrets or Credentials** - **Low**
   - No hardcoded secrets are found, but ensure environment variables are used for sensitive data like `settings.REDIS_URL`.

3. **Error Handling that Leaks Information** - **Medium**
   - The generic exception handling without proper logging could expose internal errors.

4. **Overall Security Posture** - **Medium**

#### Attack Vectors:

1. SQL Injection: An attacker could manipulate the query to execute arbitrary SQL commands.
2. Error Disclosure: Generic exceptions might reveal sensitive information about the application's structure and dependencies.

#### Recommended Fixes:

1. **SQL Injection Fix (Line 6)**
   - Use parameterized queries or ORM methods if available:
     ```python
     await conn.execute(text("SELECT 1"), {})
     ```

2. **Error Handling Improvement**
   - Implement structured logging to log errors without exposing sensitive information.
     ```python
     except Exception as e:
         logger.error(f"Database connection error: {str(e)}")
         db_status = HealthStatus.UNHEALTHY
     ```

3. **Environment Variables for Secrets**
   - Ensure `settings.REDIS_URL` is set via environment variables.

4. **Input Validation (Not Applicable)**
   - No user input directly influences the query, so no immediate need for validation here.

By addressing these issues, you can significantly improve the security posture of your application.

---

*Generated by CodeWorm on 2026-03-01 14:23*
