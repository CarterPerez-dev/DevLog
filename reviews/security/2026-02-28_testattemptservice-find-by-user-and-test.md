# TestAttemptService.find_by_user_and_test

**Type:** Security Review
**Repository:** CertGames-Core
**File:** backend/api/domains/testing/services/session_ops.py
**Language:** python
**Lines:** 25-64
**Complexity:** 7.0

---

## Source Code

```python
def find_by_user_and_test(
        user_id: str | ObjectId,
        test_id: int | str,
        category: str | None = None,
        status: str | None = None
    ) -> TestAttempt | None:
        """
        Find test attempt by user and test.
        """
        if isinstance(user_id, str):
            try:
                user_id = ObjectId(user_id)
            except (InvalidId, ValueError):
                return None

        base_query: dict[str, Any] = {"userId": user_id, "testId": test_id}

        if category:
            base_query["category"] = category

        if status == "finished":
            return TestAttempt.objects(
                **base_query,
                finished = True
            ).order_by('-finishedAt').first()
        if status == "unfinished":
            return TestAttempt.objects(
                **base_query,
                finished = False
            ).first()
        attempt = TestAttempt.objects(
            **base_query,
            finished = False
        ).first()
        if not attempt:
            attempt = TestAttempt.objects(
                **base_query,
                finished = True
            ).order_by('-finishedAt').first()
        return attempt
```

---

## Security Review

### Security Review

#### Vulnerabilities Found:

1. **SQL Injection** - **Severity: Info**
   - The code uses PyMongo's `TestAttempt.objects` method, which is safe from SQL injection but could be vulnerable to other types of injections if integrated with a different database.

2. **Input Validation Gaps** - **Severity: Medium**
   - The validation for the `status` parameter does not cover all possible values, leading to potential logic errors or unexpected behavior.

3. **Hardcoded Secrets or Credentials** - **Severity: Info**
   - No hardcoded secrets found in this snippet.

4. **Error Handling that Leaks Information** - **Severity: Low**
   - The function returns `None` if the input is invalid, which could be improved for better error handling.

5. **Overall Security Posture** - **Medium**
   - The code has basic validation but lacks comprehensive input validation and edge case handling.

#### Attack Vectors:

- An attacker could exploit the lack of validation on the `status` parameter to cause unexpected behavior or bypass intended logic.
- Improper error handling might reveal internal details about the application's structure if not handled properly.

#### Recommended Fixes:

1. **Enhance Input Validation**:
   ```python
   valid_status = ["finished", "unfinished"]
   if status and status not in valid_status:
       return None, f"Invalid status: {status}"
   ```

2. **Improve Error Handling**:
   ```python
   except (InvalidId, ValueError) as e:
       return None, str(e)
   ```

3. **Document and Test Edge Cases**:
   Ensure all possible inputs are tested to cover edge cases.

By addressing these issues, the security posture of the code can be significantly improved.

---

*Generated by CodeWorm on 2026-02-28 00:43*
