# PayoutService.create_payout

**Type:** Security Review
**Repository:** stripe-referral
**File:** src/stripe_referral/services/payout_service.py
**Language:** python
**Lines:** 142-213
**Complexity:** 6.0

---

## Source Code

```python
def create_payout(
        db: Session,
        tracking_id: int,
        adapter_type: str,
        recipient_data: dict[str,
                             Any],
    ) -> PayoutInfo:
        """
        Create a payout record for a tracking entry
        """
        tracking_repo = ReferralTrackingRepository(db)
        payout_repo = PayoutRepository(db)
        program_repo = ReferralProgramRepository(db)

        tracking = tracking_repo.get_by_id(tracking_id)
        if not tracking:
            raise TrackingNotFoundError(
                f"Tracking ID {tracking_id} not found",
                tracking_id = tracking_id,
            )

        existing_payout = payout_repo.get_by_tracking_id(tracking_id)
        if existing_payout:
            raise PayoutAlreadyExistsError(
                f"Payout already exists for tracking ID {tracking_id}",
                tracking_id = tracking_id,
            )

        program = program_repo.get_by_id(tracking.program_id)
        if not program:
            raise TrackingNotFoundError(
                f"Program ID {tracking.program_id} not found",
                program_id = tracking.program_id,
            )

        adapter = PayoutService._get_adapter(
            adapter_type,
            program.adapter_config
        )

        validation: RecipientValidation = adapter.validate_recipient(
            recipient_data
        )
        if not validation["valid"]:
            raise InvalidRecipientDataError(
                validation.get("error",
                               "Invalid recipient data"),
                recipient_data = recipient_data,
                adapter_type = adapter_type,
            )

        payout = payout_repo.create(
            user_id = tracking.referrer_user_id,
            tracking_id = tracking_id,
            amount = tracking.amount_earned,
            currency = tracking.currency,
            status = PayoutStatus.PENDING.value,
            adapter_type = adapter_type,
            recipient_data = recipient_data,
        )

        return PayoutInfo(
            id = payout.id,
            user_id = payout.user_id,
            amount = payout.amount,
            currency = payout.currency,
            status = payout.status,
            adapter_type = payout.adapter_type,
            processed_at = payout.processed_at.isoformat()
            if payout.processed_at else None,
            external_transaction_id = payout.external_transaction_id,
        )
```

---

## Security Review

### Security Review for `PayoutService.create_payout`

#### Vulnerabilities and Severity

1. **Information Leakage** - **Info**
   - **Line 20**: The error messages include sensitive information like tracking ID and program ID, which could be used to infer data structure.
   - **Fix**: Use generic error messages that do not disclose internal details.

2. **Input Validation Gaps** - **Medium**
   - **Lines 16-19**: `recipient_data` is validated but no specific checks are made for malicious input (e.g., SQL injection, XSS).
   - **Fix**: Ensure all user inputs are properly sanitized and validated before processing.

3. **Hardcoded Secrets or Credentials** - **Info**
   - No hardcoded secrets found in the snippet.
   - **Fix**: Ensure no sensitive information is stored in plain text within the codebase.

#### Attack Vectors

- An attacker could exploit input validation gaps to inject malicious data, leading to unauthorized actions or data leakage.
- Generic error messages can be used to infer database structure and potentially extract sensitive information.

#### Recommended Fixes

1. **Generic Error Handling**:
   ```python
   raise TrackingNotFoundError(f"Tracking ID not found", tracking_id=tracking_id)
   ```

2. **Input Validation**:
   - Implement more robust validation for `recipient_data` using libraries like `pydantic`.
   - Example: Use a schema to define valid recipient data.

3. **Error Messages**:
   ```python
   raise TrackingNotFoundError("Tracking ID not found")
   ```

#### Overall Security Posture

The code has some minor issues that could be improved for better security posture. Addressing the input validation and error handling will significantly enhance the robustness of the function against potential attacks.

---

*Generated by CodeWorm on 2026-02-21 12:18*
