# websocket_detect

**Type:** Security Review
**Repository:** angelamos-operations
**File:** Angela-Wake/server/routes.py
**Language:** python
**Lines:** 66-129
**Complexity:** 17.0

---

## Source Code

```python
async def websocket_detect(websocket: WebSocket):
    await websocket.accept()

    model_paths = list(MODELS_DIR.glob("*.tflite")) + list(MODELS_DIR.glob("*.onnx"))
    if model_paths:
        m = Model(
            wakeword_models=[str(p) for p in model_paths],
            vad_threshold=VAD_THRESHOLD if ENABLE_VAD else None,
        )
    else:
        m = Model(vad_threshold=VAD_THRESHOLD if ENABLE_VAD else None)

    model_names = list(m.models.keys())
    frame_count = 0

    try:
        while True:
            msg = await websocket.receive()

            if msg.get('type') == 'websocket.disconnect':
                break

            if 'text' in msg:
                if msg['text'] == 'reset':
                    m.reset()
                    print("[DEBUG] Model reset")
                continue

            if 'bytes' not in msg:
                continue

            data = msg['bytes']
            audio = np.frombuffer(data, dtype=np.int16)
            frame_count += 1

            orig_len = len(audio)
            orig_amp = np.max(np.abs(audio))

            if len(audio) != TARGET_SAMPLES:
                ratio = len(audio) // TARGET_SAMPLES
                if ratio > 1:
                    audio = audio[::ratio][:TARGET_SAMPLES]
                else:
                    audio = signal.resample_poly(audio, TARGET_SAMPLES, len(audio)).astype(np.int16)

            predictions = m.predict(audio)

            for name in model_names:
                score = predictions.get(name, 0.0)
                if frame_count % 50 == 0:
                    print(f"[DEBUG] Frame {frame_count}: orig_len={orig_len}, orig_amp={orig_amp}, {name}={score:.4f}")
                if score >= DETECTION_THRESHOLD:
                    await websocket.send_json(
                        {
                            "detected": True,
                            "model": name,
                            "score": float(score),
                        }
                    )

    except WebSocketDisconnect:
        pass
    except Exception as e:
        await websocket.close(code = 1011, reason = str(e))
```

---

## Security Review

### Security Review for `websocket_detect` Function

#### Vulnerabilities Found:

1. **Information Leakage** - The debug messages print model reset information, which could be exploited to infer the presence or absence of models.
   - **Severity: Medium**
2. **Error Handling** - Catching exceptions and closing the websocket with a custom error message can leak details about the exception.
   - **Severity: Low**

#### Attack Vectors:

- An attacker could use the debug messages to infer model presence, potentially aiding in crafting targeted attacks.

#### Recommended Fixes:

1. Remove or comment out debug print statements:
   ```python
   # print("[DEBUG] Model reset")
   ```

2. Improve error handling by logging errors instead of sending them back to the client:
   ```python
   except Exception as e:
       logger.error(f"Error processing websocket: {e}")
       await websocket.close(code=1011, reason="Internal server error")
   ```

#### Overall Security Posture:

The code has some minor issues that could be improved. By removing debug information and handling errors more securely, the overall security posture can be enhanced. Ensure all sensitive operations are logged internally rather than exposed to clients.

---

*Generated by CodeWorm on 2026-02-20 15:26*
