# createAuthResponse

**Type:** Security Review
**Repository:** fullstack-template
**File:** stacks/go-react/go-backend/internal/auth/service.go
**Language:** go
**Lines:** 352-411
**Complexity:** 5.0

---

## Source Code

```go
func (s *Service) createAuthResponse(
	ctx context.Context,
	user *UserInfo,
	userAgent, ipAddress, familyID string,
	oldTokenID *string,
) (*AuthResponse, error) {
	accessToken, err := s.jwt.CreateAccessToken(AccessTokenClaims{
		UserID:       user.ID,
		Role:         user.Role,
		Tier:         user.Tier,
		TokenVersion: user.TokenVersion,
	})
	if err != nil {
		return nil, fmt.Errorf("create access token: %w", err)
	}

	refreshData, err := s.jwt.CreateRefreshToken(user.ID, familyID)
	if err != nil {
		return nil, fmt.Errorf("create refresh token: %w", err)
	}

	newTokenID := uuid.New().String()

	refreshTokenEntity := &RefreshToken{
		ID:        newTokenID,
		UserID:    user.ID,
		TokenHash: refreshData.Hash,
		FamilyID:  refreshData.FamilyID,
		ExpiresAt: refreshData.ExpiresAt,
		UserAgent: userAgent,
		IPAddress: ipAddress,
	}

	if err := s.repo.Create(ctx, refreshTokenEntity); err != nil {
		return nil, fmt.Errorf("store refresh token: %w", err)
	}

	if oldTokenID != nil {
		//nolint:errcheck // best-effort token chain tracking
		_ = s.repo.MarkAsUsed(ctx, *oldTokenID, newTokenID)
	}

	return &AuthResponse{
		User: UserResponse{
			ID:        user.ID,
			Email:     user.Email,
			Name:      user.Name,
			Role:      user.Role,
			Tier:      user.Tier,
			CreatedAt: time.Now(),
		},
		Tokens: TokenResponse{
			AccessToken:  accessToken,
			RefreshToken: refreshData.Token,
			TokenType:    "Bearer",
			ExpiresIn:    int(15 * time.Minute / time.Second),
			ExpiresAt:    time.Now().Add(15 * time.Minute),
		},
	}, nil
}
```

---

## Security Review

### Security Review for `createAuthResponse` Function

#### Vulnerabilities Found:

1. **Info - Error Handling**: The error handling is consistent but could be more verbose, especially in the case where `MarkAsUsed` fails.
2. **Low - Input Validation Gaps**: Ensure that `userAgent`, `ipAddress`, and `familyID` are validated to prevent injection attacks.

#### Attack Vectors:

- Potential injection if `userAgent`, `ipAddress`, or `familyID` contain malicious input.
- Best-effort token chain tracking might not be sufficient for critical operations.

#### Recommended Fixes:

1. **Input Validation**:
   - Validate and sanitize `userAgent`, `ipAddress`, and `familyID` to ensure they do not contain harmful characters (e.g., using regex).
   
2. **Enhanced Error Handling**:
   - Add more detailed error handling for the `MarkAsUsed` call.
     ```go
     if err := s.repo.MarkAsUsed(ctx, *oldTokenID, newTokenID); err != nil {
         return nil, fmt.Errorf("mark old token as used: %w", err)
     }
     ```

3. **Documentation and Comments**:
   - Document the purpose of `//nolint:errcheck` to clarify why it is being ignored.

#### Overall Security Posture:

The function appears secure with no critical issues, but minor improvements can enhance its robustness against potential attacks. Proper input validation and detailed error handling are recommended to ensure a high security posture.

---

*Generated by CodeWorm on 2026-02-20 11:59*
