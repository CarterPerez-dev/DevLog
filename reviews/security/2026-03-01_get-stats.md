# get_stats

**Type:** Security Review
**Repository:** CodeWorm
**File:** dashboard/backend/api.py
**Language:** python
**Lines:** 41-105
**Complexity:** 3.0

---

## Source Code

```python
async def get_stats() -> StatsResponse:
    db = _get_db_path()
    if not db.exists():
        return StatsResponse()

    with _get_conn() as conn:
        total = conn.execute("SELECT COUNT(*) FROM documented_snippets"
                             ).fetchone()[0]

        by_repo = dict(
            conn.execute(
                "SELECT source_repo, COUNT(*) FROM documented_snippets "
                "GROUP BY source_repo"
            ).fetchall()
        )

        if _has_column(conn, "documented_snippets", "doc_type"):
            by_doc_type = dict(
                conn.execute(
                    "SELECT doc_type, COUNT(*) FROM documented_snippets "
                    "GROUP BY doc_type"
                ).fetchall()
            )
        else:
            by_doc_type = {"function_doc": total}

        last_7 = conn.execute(
            "SELECT COUNT(*) FROM documented_snippets "
            "WHERE documented_at > datetime('now', '-7 days')"
        ).fetchone()[0]

        last_30 = conn.execute(
            "SELECT COUNT(*) FROM documented_snippets "
            "WHERE documented_at > datetime('now', '-30 days')"
        ).fetchone()[0]

        today = conn.execute(
            "SELECT COUNT(*) FROM documented_snippets "
            "WHERE date(documented_at) = date('now')"
        ).fetchone()[0]

        lang_rows = conn.execute(
            "SELECT "
            "CASE "
            "  WHEN source_file LIKE '%.py' THEN 'python' "
            "  WHEN source_file LIKE '%.ts' THEN 'typescript' "
            "  WHEN source_file LIKE '%.tsx' THEN 'tsx' "
            "  WHEN source_file LIKE '%.js' THEN 'javascript' "
            "  WHEN source_file LIKE '%.go' THEN 'go' "
            "  WHEN source_file LIKE '%.rs' THEN 'rust' "
            "  ELSE 'other' "
            "END AS lang, COUNT(*) "
            "FROM documented_snippets GROUP BY lang"
        ).fetchall()
        by_language = dict(lang_rows)

    return StatsResponse(
        total_documented = total,
        by_repo = by_repo,
        by_language = by_language,
        by_doc_type = by_doc_type,
        last_7_days = last_7,
        last_30_days = last_30,
        today = today,
    )
```

---

## Security Review

### Security Review for `get_stats` Function

#### Vulnerabilities Found:

1. **SQL Injection** (Critical):
   - Line 7: The SQL query is directly constructed using string concatenation, which can lead to SQL injection if the input is not properly sanitized.

2. **Hardcoded Secrets or Credentials** (Info):
   - There are no hardcoded secrets or credentials in this snippet, but ensure that `_get_db_path()` and `_has_column()` do not expose sensitive information.

3. **Input Validation Gaps** (Medium):
   - The SQL queries assume the input is safe. Ensure all inputs are validated to prevent unexpected behavior.

4. **Error Handling** (Low):
   - There is no explicit error handling for database operations, which could leak information about the underlying database structure if an exception occurs.

#### Attack Vectors:

- An attacker could manipulate the `documented_snippets` table or input parameters to execute arbitrary SQL commands.
- Improper error handling might reveal sensitive details of the database schema.

#### Recommended Fixes:

1. **SQL Injection**:
   - Use parameterized queries instead of string concatenation (line 7).
     ```python
     total = conn.execute("SELECT COUNT(*) FROM documented_snippets").fetchone()[0]
     ```

2. **Error Handling**:
   - Implement try-except blocks to handle exceptions and return generic error messages.
     ```python
     try:
         # Database operations
     except Exception as e:
         logger.error(f"Database operation failed: {e}")
         return StatsResponse(error="An error occurred")
     ```

3. **Input Validation**:
   - Ensure all inputs are validated before use in SQL queries.

#### Overall Security Posture:

The code has critical vulnerabilities that could be exploited if not properly secured. Addressing the SQL injection and implementing robust error handling will significantly improve the security posture of this function.

---

*Generated by CodeWorm on 2026-03-01 16:52*
