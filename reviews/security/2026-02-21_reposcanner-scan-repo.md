# RepoScanner.scan_repo

**Type:** Security Review
**Repository:** CodeWorm
**File:** codeworm/analysis/scanner.py
**Language:** python
**Lines:** 148-212
**Complexity:** 16.0

---

## Source Code

```python
def scan_repo(self, repo_path: Path, repo_name: str) -> Iterator[ScannedFile]:
        """
        Scan a repository and yield discovered files
        """
        if not repo_path.exists():
            return

        gitignore_filter = GitignoreFilter(repo_path)
        include_spec = pathspec.PathSpec.from_lines(
            "gitwildmatch",
            self.include_patterns
        )

        for root, dirs, files in os.walk(repo_path):
            root_path = Path(root)

            dirs[:] = [
                d for d in dirs if not d.startswith(".")
                and not gitignore_filter.is_ignored(root_path / d)
            ]

            for filename in files:
                file_path = root_path / filename

                try:
                    rel_path = file_path.relative_to(repo_path)
                except ValueError:
                    continue

                if not include_spec.match_file(str(rel_path)):
                    continue

                if self._exclude_spec.match_file(str(rel_path)):
                    continue

                if gitignore_filter.is_ignored(file_path):
                    continue

                ext = file_path.suffix.lower()
                language = LANGUAGE_EXTENSIONS.get(ext)
                if not language:
                    continue

                try:
                    stat = file_path.stat()
                    if stat.st_size > self.MAX_FILE_SIZE:
                        continue
                    if stat.st_size == 0:
                        continue

                    is_binary = self._is_binary(file_path)
                    if is_binary:
                        continue

                    yield ScannedFile(
                        path = file_path,
                        language = language,
                        repo_name = repo_name,
                        relative_path = rel_path,
                        size_bytes = stat.st_size,
                        is_binary = False,
                    )

                except (OSError, PermissionError):
                    continue
```

---

## Security Review

### Security Review for `RepoScanner.scan_repo`

**Vulnerabilities:**

1. **Input Validation Gaps (Medium):**
   - The function does not validate the `repo_path` or `repo_name` inputs, which could lead to unexpected behavior if these are manipulated.

2. **Error Handling (Low):**
   - The error handling for `OSError` and `PermissionError` is minimal, but it does prevent crashes by continuing execution.

3. **Overall Security Posture:**
   - The code shows good practices with file path validation using `pathspec`, but lacks input validation on external inputs like `repo_path` and `repo_name`.

**Attack Vectors:**

- Maliciously crafted `repo_path` or `repo_name` could lead to unexpected behavior, although the current implementation does not expose any direct vulnerabilities.

**Recommended Fixes:**

1. **Input Validation (Medium):**
   - Validate `repo_path` and `repo_name` inputs to ensure they are safe.
     ```python
     if not repo_path.is_dir() or not isinstance(repo_name, str):
         raise ValueError("Invalid repository path or name")
     ```

2. **Enhanced Error Handling (Low):**
   - Consider logging the errors for better debugging and security monitoring.
     ```python
     except OSError as e:
         logger.error(f"Failed to stat file: {e}")
         continue
     ```

3. **Overall Security Posture:**
   - Ensure all external inputs are validated and sanitized where used.

By addressing these points, the overall security posture of the code will be significantly improved.

---

*Generated by CodeWorm on 2026-02-21 15:44*
