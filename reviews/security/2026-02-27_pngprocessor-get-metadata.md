# PngProcessor.get_metadata

**Type:** Security Review
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/beginner/metadata-scrubber-tool/src/core/png_metadata.py
**Language:** python
**Lines:** 51-113
**Complexity:** 13.0

---

## Source Code

```python
def get_metadata(self, img: Image) -> dict[str, Any]:
        """
        Extract metadata from a PNG image.

        Extracts both EXIF data (if present) and PNG textual chunks (PngInfo).

        Args:
            img: PIL Image object.

        Returns:
            Dict with 'data' (metadata dict), 'tags_to_delete' (EXIF tag IDs),
            and 'text_keys' (PngInfo keys to remove).

        Raises:
            MetadataNotFoundError: If no metadata is found in the image.
        """
        img.load()
        found_metadata = False

        # Extract EXIF data (if present)
        exif = img.getexif()
        if exif:
            found_metadata = True
            # Main IFD
            for tag, value in exif.items():
                tag_name = ExifTags.TAGS.get(tag, f"Tag_{tag}")
                self.tags_to_delete.append(tag)
                self.data[f"EXIF:{tag_name}"] = value

            # GPS IFD
            gps_ifd = exif.get_ifd(ExifTags.IFD.GPSInfo)
            for tag, value in gps_ifd.items():
                tag_name = ExifTags.GPSTAGS.get(tag, f"GPSTag_{tag}")
                self.tags_to_delete.append(tag)
                self.data[f"GPS:{tag_name}"] = value

        # Extract PNG textual metadata (PngInfo chunks)
        if hasattr(img, "info") and img.info:
            for key, value in img.info.items():
                # Skip binary/internal data
                if key in ("icc_profile", "exif", "transparency", "gamma"):
                    continue

                if isinstance(value, str | bytes):
                    found_metadata = True
                    if isinstance(value, bytes):
                        try:
                            value = value.decode("utf-8", errors = "replace")
                        except Exception:
                            value = str(value)

                    self.data[f"PNG:{key}"] = value
                    if isinstance(key, str):  # Only add string keys
                        self.text_keys_to_delete.append(key)

        if not found_metadata:
            raise MetadataNotFoundError("No metadata found in the PNG image.")

        return {
            "data": self.data,
            "tags_to_delete": self.tags_to_delete,
            "text_keys": self.text_keys_to_delete,
        }
```

---

## Security Review

### Security Review for `PngProcessor.get_metadata`

#### Vulnerabilities and Severity:

1. **Input Validation Gap** (Medium):
   - Lines 10-16: The function accepts a `img` argument without validating its type or source, which could allow an attacker to inject malicious data.
   
2. **Error Handling that Leaks Information** (Low):
   - Line 23: The error handling for decoding binary values is somewhat generic but does not expose sensitive information.

#### Attack Vectors:

- An attacker could provide a crafted image with malicious metadata, leading to unexpected behavior or data leakage.

#### Recommended Fixes:

1. **Input Validation**:
   ```python
   if not isinstance(img, Image):
       raise TypeError("Argument 'img' must be an instance of PIL.Image.")
   ```

2. **Enhanced Error Handling**:
   - Ensure error messages are non-informative to prevent information leakage.

#### Overall Security Posture:

The code has a moderate security posture due to the lack of input validation and potential for data injection through untrusted image sources. Addressing these issues will improve the robustness and security of the function, preventing potential misuse or vulnerabilities.

---

*Generated by CodeWorm on 2026-02-27 18:47*
