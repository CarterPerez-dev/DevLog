# StripeConnectAdapter.send_payout

**Type:** Security Review
**Repository:** stripe-referral
**File:** src/stripe_referral/adapters/stripe_connect.py
**Language:** python
**Lines:** 36-106
**Complexity:** 8.0

---

## Source Code

```python
def send_payout(
        self,
        user_id: str,
        amount: float,
        currency: str,
        recipient_data: dict[str,
                             Any],
    ) -> PayoutResult:
        """
        Send payout via Stripe Connect transfer
        """
        try:
            connected_account_id = recipient_data.get(
                "stripe_connect_account_id"
            )
            if not connected_account_id:
                return PayoutResult(
                    success = False,
                    error =
                    "Missing stripe_connect_account_id in recipient_data",
                )

            if not connected_account_id.startswith(
                    STRIPE_CONNECT_ACCOUNT_ID_PREFIX):
                return PayoutResult(
                    success = False,
                    error =
                    f"Invalid Stripe account ID format: {connected_account_id}",
                )

            amount_cents = int(amount * 100)

            transfer = stripe.Transfer.create(
                amount = amount_cents,
                currency = currency.lower(),
                destination = connected_account_id,
                metadata = {"user_id": user_id},
            )

            if not transfer.id.startswith(STRIPE_TRANSFER_ID_PREFIX):
                return PayoutResult(
                    success = False,
                    error =
                    f"Unexpected transfer ID format: {transfer.id}",
                )

            return PayoutResult(
                success = True,
                transaction_id = transfer.id,
            )

        except stripe.InvalidRequestError as e:
            return PayoutResult(
                success = False,
                error = f"Invalid request: {str(e)}",
            )
        except stripe.AuthenticationError as e:
            return PayoutResult(
                success = False,
                error = f"Authentication failed: {str(e)}",
            )
        except stripe.StripeError as e:
            return PayoutResult(
                success = False,
                error = f"Stripe error: {str(e)}",
            )
        except Exception as e:
            return PayoutResult(
                success = False,
                error = f"Unexpected error: {str(e)}",
            )
```

---

## Security Review

### Security Review

#### Vulnerabilities Found:

1. **Error Handling:**
   - **Severity:** Medium
   - **Line 28-36, 40-57**: The `stripe.StripeError` and generic `Exception` catch-all blocks can leak sensitive information through error messages. This could expose internal system details to attackers.
   
2. **Input Validation:**
   - **Severity:** Low
   - **Line 11-13**: While checking the format of the `connected_account_id`, it is crucial to ensure that this validation covers all possible invalid formats and not just the prefix check.

#### Attack Vectors:

- An attacker could exploit the generic error handling by crafting requests that trigger exceptions, potentially revealing sensitive information.
- Improper input validation might allow an attacker to inject malicious data into `connected_account_id`.

#### Recommended Fixes:

1. **Error Handling:**
   - Use more specific exception types and avoid catching broad exceptions like `Exception`.
   ```python
   except stripe.StripeError as e:
       return PayoutResult(
           success = False,
           error = f"Stripe API Error: {str(e)}",
       )
   ```

2. **Input Validation:**
   - Ensure comprehensive validation of the `connected_account_id` to cover all invalid formats.
   ```python
   if not connected_account_id or not connected_account_id.startswith(
       STRIPE_CONNECT_ACCOUNT_ID_PREFIX):
       return PayoutResult(
           success = False,
           error = f"Invalid Stripe account ID format: {connected_account_id}",
       )
   ```

#### Overall Security Posture:

The code has a moderate security posture. While the input validation is adequate, the error handling needs improvement to prevent information leakage. Addressing these issues will significantly enhance the overall security of the function.

---

*Generated by CodeWorm on 2026-02-21 12:36*
