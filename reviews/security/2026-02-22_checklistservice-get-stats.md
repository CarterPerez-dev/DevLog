# ChecklistService.get_stats

**Type:** Security Review
**Repository:** angelamos-operations
**File:** CarterOS-Server/src/aspects/life_manager/facets/checklist/service.py
**Language:** python
**Lines:** 178-229
**Complexity:** 14.0

---

## Source Code

```python
async def get_stats(session: AsyncSession) -> ChecklistStatsResponse:
        """
        Compute streak, per-item completion rates, and year heatmap
        """
        today = date.today()
        year_start = date(today.year, 1, 1)

        heatmap_rows = await ChecklistLogRepository.get_heatmap_data(
            session, year_start, today
        )
        heatmap = [
            HeatmapDay(
                date=row.log_date,
                completed_count=int(row.completed_count or 0),
                total_count=int(row.total_count or 0),
            )
            for row in heatmap_rows
        ]

        heatmap_by_date = {h.date: h for h in heatmap}
        streak = 0
        check_date = today
        while check_date >= year_start:
            day = heatmap_by_date.get(check_date)
            if day and day.total_count > 0 and day.completed_count == day.total_count:
                streak += 1
                check_date -= timedelta(days=1)
            else:
                break

        rate_rows = await ChecklistLogRepository.get_item_completion_rates(session)
        active_items = await ChecklistItemRepository.get_active(session)
        item_map = {i.id: i.title for i in active_items}

        item_stats = [
            ItemStat(
                item_id=row.item_id,
                title=item_map.get(row.item_id, ""),
                completion_rate=round(
                    (int(row.completed or 0) / int(row.total)) if int(row.total) > 0 else 0.0,
                    4,
                ),
            )
            for row in rate_rows
            if row.item_id in item_map
        ]

        return ChecklistStatsResponse(
            streak=streak,
            item_stats=item_stats,
            heatmap=heatmap,
        )
```

---

## Security Review

### Security Review for `get_stats` Function

#### Vulnerabilities Found:

1. **Info: Input Validation Gaps**
   - Line 16-18: The `heatmap_rows`, `rate_rows`, and `active_items` are fetched without input validation, which could lead to unexpected behavior if the database queries return more data than expected.
   
2. **Info: Insecure Deserialization (Not Applicable)**
   - No deserialization of untrusted data is present.

3. **Info: Error Handling that Leaks Information**
   - Lines 16-18: Potential for exceptions to leak information about the database structure or query results if an error occurs during fetching rows.
   
4. **Info: Hardcoded Secrets (Not Applicable)**
   - No hardcoded secrets are found.

5. **Info: Race Conditions and TOCTOU Bugs (Not Applicable)**
   - The function does not interact with external systems, so race conditions or TOCTOU bugs are unlikely.

#### Attack Vectors:
- If the database returns more rows than expected, it could lead to unexpected behavior in the application logic.
- Potential for exceptions to reveal sensitive information about the underlying data structure.

#### Recommended Fixes:

1. **Input Validation:**
   - Ensure that the number of rows returned by `ChecklistLogRepository.get_heatmap_data` and `get_item_completion_rates` is within expected bounds.
   
2. **Error Handling:**
   - Implement robust error handling to catch and log exceptions without revealing sensitive information.

3. **Overall Security Posture:**
   - The function has a good overall security posture, but improvements in input validation and error handling can further enhance its resilience against unexpected inputs or database anomalies.

```python
async def get_stats(session: AsyncSession) -> ChecklistStatsResponse:
    today = date.today()
    year_start = date(today.year, 1, 1)

    heatmap_rows = await ChecklistLogRepository.get_heatmap_data(
        session, year_start, today
    )
    
    # Validate input length
    if len(heatmap_rows) > MAX_HEATMAP_ROWS:
        raise ValueError("Too many heatmap rows returned")

    heatmap = [
        HeatmapDay(
            date=row.log_date,
            completed_count=int(row.completed_count or 0),
            total_count=int(row.total_count or 0),
        )
        for row in heatmap_rows
    ]

    # ... rest of the function ...
```

By adding these checks, you can ensure that the function behaves predictably even when unexpected data is returned from the database.

---

*Generated by CodeWorm on 2026-02-22 01:26*
