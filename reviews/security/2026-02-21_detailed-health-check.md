# detailed_health_check

**Type:** Security Review
**Repository:** vuemantics
**File:** backend/routers/v1/health.py
**Language:** python
**Lines:** 45-91
**Complexity:** 9.0

---

## Source Code

```python
async def detailed_health_check() -> HealthDetailedResponse:
    """
    Detailed health check including database connectivity

    healthy, degraded, or unhealthy
    """
    db_status = HealthStatus.UNHEALTHY
    redis_status = None

    try:
        await db.fetchval("SELECT 1")
        db_status = HealthStatus.HEALTHY
    except Exception as e:
        logger.error(f"Database health check failed: {e}")
        db_status = HealthStatus.UNHEALTHY

    if settings.redis_url:
        try:
            redis_client = redis.from_url(
                settings.redis_url,
                decode_responses = settings.redis_decode_responses
            )
            await redis_client.ping()
            await redis_client.close()
            redis_status = HealthStatus.HEALTHY
        except Exception as e:
            logger.error(f"Redis health check failed: {e}")
            redis_status = HealthStatus.UNHEALTHY

    services = [db_status,
                redis_status] if redis_status is not None else [db_status]
    healthy_count = sum(1 for s in services if s == HealthStatus.HEALTHY)

    if healthy_count == len(services):
        overall = HealthStatus.HEALTHY
    elif healthy_count > 0:
        overall = HealthStatus.DEGRADED
    else:
        overall = HealthStatus.UNHEALTHY

    return HealthDetailedResponse(
        status = overall,
        environment = settings.environment,
        version = config.APP_VERSION,
        database = db_status,
        redis = redis_status,
    )
```

---

## Security Review

### Security Review for `detailed_health_check`

#### Vulnerabilities Found:

1. **Logging of Exceptions** - Lines 9-11 and 20-22: Logging exceptions without proper sanitization can leak sensitive information.
   - **Severity**: Medium
   - **Attack Vector**: An attacker could exploit this to gain insights into the system's internal state.

2. **Hardcoded Secrets or Credentials** - Line 6: `settings.redis_url` and `settings.redis_decode_responses` might contain hardcoded secrets if not properly managed.
   - **Severity**: Low
   - **Attack Vector**: If these settings are misconfigured, they could expose sensitive information.

3. **Input Validation Gaps** - Lines 9-12 and 20-23: The code does not validate the inputs to the database or Redis operations.
   - **Severity**: Medium
   - **Attack Vector**: SQL injection or command injection if the input is manipulated.

#### Recommended Fixes:

1. **Sanitize Logs**: Use structured logging with placeholders for sensitive information.
   ```python
   logger.error(f"Database health check failed: {str(e)}")
   ```

2. **Environment Variables for Secrets**: Ensure `settings.redis_url` and `settings.redis_decode_responses` are read from environment variables or a secure secrets manager.

3. **Input Validation**: Validate inputs to database queries and Redis commands.
   ```python
   try:
       await db.fetchval("SELECT 1")
   except asyncpg.exceptions.PostgresError as e:
       logger.error(f"Database health check failed: {str(e)}")
       db_status = HealthStatus.UNHEALTHY
   ```

#### Overall Security Posture:

The code has moderate security risks, primarily related to logging and input handling. Addressing these issues will significantly improve the overall security posture of the application.

--- 

This review highlights key areas for improvement in the `detailed_health_check` function. Implementing the suggested fixes will help mitigate potential vulnerabilities.

---

*Generated by CodeWorm on 2026-02-21 14:03*
