# calculateNotificationsFromCycleData

**Type:** Security Review
**Repository:** ios-test
**File:** red-recon/src/core/notifications/notification.service.ts
**Language:** typescript
**Lines:** 118-190
**Complexity:** 9.0

---

## Source Code

```typescript
function calculateNotificationsFromCycleData(
  cycleStatus: CycleStatus,
  partner: PartnerResponse
): NotificationConfig[] {
  const notifications: NotificationConfig[] = []
  const today = new Date()
  today.setHours(0, 0, 0, 0)

  if (
    partner.notification_period_reminder &&
    cycleStatus.predicted_period_start &&
    cycleStatus.days_until_period !== null
  ) {
    const predictedStart = new Date(cycleStatus.predicted_period_start)
    const reminderDate = addDays(predictedStart, -partner.reminder_days_before)

    if (reminderDate > today) {
      const content = NOTIFICATION_CONTENT[NotificationType.PERIOD_REMINDER]
      notifications.push({
        type: NotificationType.PERIOD_REMINDER,
        identifier: NOTIFICATION_IDENTIFIERS.PERIOD_REMINDER,
        title: content.title,
        body: content.bodyTemplate(partner.reminder_days_before),
        triggerDate: setTimeToMorning(reminderDate),
      })
    }
  }

  if (
    partner.notification_pms_alert &&
    cycleStatus.last_period_start &&
    cycleStatus.cycle_length
  ) {
    const lastPeriod = new Date(cycleStatus.last_period_start)
    const ovulationDay = cycleStatus.cycle_length - 14
    const lutealStartDay = ovulationDay + 2
    const lutealDate = addDays(lastPeriod, lutealStartDay - 1)

    if (lutealDate > today) {
      const content = NOTIFICATION_CONTENT[NotificationType.PMS_ALERT]
      notifications.push({
        type: NotificationType.PMS_ALERT,
        identifier: NOTIFICATION_IDENTIFIERS.PMS_ALERT,
        title: content.title,
        body: content.body,
        triggerDate: setTimeToMorning(lutealDate),
      })
    }
  }

  if (
    partner.notification_ovulation_alert &&
    cycleStatus.last_period_start &&
    cycleStatus.cycle_length
  ) {
    const lastPeriod = new Date(cycleStatus.last_period_start)
    const ovulationDay = cycleStatus.cycle_length - 14
    const ovulationDate = addDays(lastPeriod, ovulationDay - 1)

    if (ovulationDate > today) {
      const content = NOTIFICATION_CONTENT[NotificationType.OVULATION_ALERT]
      notifications.push({
        type: NotificationType.OVULATION_ALERT,
        identifier: NOTIFICATION_IDENTIFIERS.OVULATION_ALERT,
        title: content.title,
        body: content.body,
        triggerDate: setTimeToMorning(ovulationDate),
      })
    }
  }

  return notifications
}
```

---

## Security Review

### Security Review for `calculateNotificationsFromCycleData`

#### Vulnerabilities and Severity:

1. **Info - Hardcoded Secrets or Credentials:**
   - The code uses hardcoded values like `NOTIFICATION_CONTENT` and `NOTIFICATION_IDENTIFIERS`. Ensure these are securely managed, especially if they contain sensitive information.

2. **Info - Input Validation Gaps:**
   - While the function checks for nulls and dates, it does not validate input types or ranges, which could lead to unexpected behavior but is unlikely to be a critical security issue.

3. **Info - Error Handling:**
   - The code does not handle potential errors from functions like `addDays` or `setTimeToMorning`. Consider adding try-catch blocks to prevent information leakage through exceptions.

4. **Info - Overall Security Posture:**
   - The function is relatively secure but could benefit from better error handling and ensuring that all inputs are validated for type and range.

#### Attack Vectors:

- If `NOTIFICATION_CONTENT` or `NOTIFICATION_IDENTIFIERS` contain sensitive data, an attacker could exploit this to gain unauthorized access.
- Potential issues with date calculations if the input dates are manipulated.

#### Recommended Fixes:

1. **Secure Hardcoded Values:**
   - Ensure that any hardcoded values do not contain sensitive information and use environment variables for configuration where possible.

2. **Enhance Error Handling:**
   ```typescript
   try {
     const reminderDate = addDays(predictedStart, -partner.reminder_days_before);
     if (reminderDate > today) {
       // ... existing logic ...
     }
   } catch (error) {
     console.error("Error calculating date:", error);
   }
   ```

3. **Validate Input Types:**
   - Add type checks for `cycleStatus` properties to ensure they are of the expected types.

By addressing these issues, you can improve the overall security posture of your application.

---

*Generated by CodeWorm on 2026-02-21 14:50*
