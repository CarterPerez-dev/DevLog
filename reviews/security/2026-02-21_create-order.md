# create_order

**Type:** Security Review
**Repository:** fastapi-rc
**File:** fastapi-rc/examples/04_full_api_example.py
**Language:** python
**Lines:** 194-240
**Complexity:** 4.0

---

## Source Code

```python
async def create_order(
    user_id: str,
    product_ids: list[str],
    user_cache: UserCache,
    product_cache: ProductCache,
    order_cache: OrderCache,
    redis: RedisClient,
):
    """
    Create order with multi-cache coordination

    Pattern: Cache user, products, then order creation
    """
    user = await user_cache.get_or_set(
        identifier = user_id,
        factory = lambda: fetch_user(user_id),
    )

    products: list[Product] = []
    for product_id in product_ids:
        product = await product_cache.get_or_set(
            identifier = product_id,
            factory = lambda pid = product_id: fetch_product(pid),
        )
        products.append(product)

    total = sum(p.price for p in products)

    order = Order(
        id = "order_123",
        user_id = user.id,
        product_ids = product_ids,
        total = total,
        created_at = datetime.now(),
    )

    await order_cache.set(
        identifier = order.id,
        value = order,
        ttl = 300,
    )

    async for key in redis.scan_iter(
            f"ecommerce:v1:orders:user:{user_id}:*"):
        await redis.delete(key)

    return order
```

---

## Security Review

### Security Review for `create_order` Function

#### Vulnerabilities Found:

1. **Info: Input Validation Gaps** - Lines 6-8 and 10-12 lack input validation, which could lead to unexpected behavior or errors.
   - **Severity:** Info  
   - **Fix:** Add type hints and validate inputs for `user_id`, `product_ids`.

2. **Info: Hardcoded Secrets or Credentials** - No hardcoded secrets found in the snippet.

3. **Low: Error Handling Gaps** - Lines 14-15 do not handle potential exceptions from `fetch_user` or `fetch_product`.
   - **Severity:** Low  
   - **Fix:** Add try-except blocks to catch and handle exceptions properly.

#### Attack Vectors:

- Malformed input could cause the function to fail or behave unexpectedly.
- Potential for race conditions if multiple requests are made concurrently, as there is no explicit locking mechanism.

#### Recommended Fixes:

1. **Add Input Validation:**
   ```python
   assert isinstance(user_id, str) and user_id.isalnum()
   assert all(isinstance(pid, str) for pid in product_ids)
   ```

2. **Exception Handling:**
   ```python
   try:
       user = await user_cache.get_or_set(
           identifier=user_id,
           factory=lambda: fetch_user(user_id),
       )
   except Exception as e:
       raise ValueError(f"Failed to fetch or set user: {e}")
   
   for product_id in product_ids:
       try:
           product = await product_cache.get_or_set(
               identifier=product_id,
               factory=lambda pid=product_id: fetch_product(pid),
           )
       except Exception as e:
           raise ValueError(f"Failed to fetch or set product: {e}")
   ```

3. **Add Context Managers for Redis Operations**:
   ```python
   async with redis.pipeline(transaction=True) as pipe:
       await order_cache.set(
           identifier=order.id,
           value=order,
           ttl=300,
           pipe=pipe,
       )
       async for key in redis.scan_iter(f"ecommerce:v1:orders:user:{user_id}:*"):
           await pipe.delete(key)
       await pipe.execute()
   ```

#### Overall Security Posture:
The code is relatively secure but could benefit from better input validation and robust error handling. Adding context managers for Redis operations ensures transactions are managed correctly, reducing the risk of data corruption or inconsistencies.

---

*Generated by CodeWorm on 2026-02-21 11:08*
