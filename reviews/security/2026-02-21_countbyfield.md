# CountByField

**Type:** Security Review
**Repository:** angelamos-operations
**File:** CertGamesDB-Argos/go-backend/internal/handler/collections.go
**Language:** go
**Lines:** 195-242
**Complexity:** 10.0

---

## Source Code

```go
func (h *CollectionsHandler) CountByField(w http.ResponseWriter, r *http.Request) {
	name := chi.URLParam(r, "name")
	dbName := r.URL.Query().Get("database")
	if dbName == "" {
		dbName = h.database
	}

	field := r.URL.Query().Get("field")
	if field == "" {
		core.BadRequest(w, "field query parameter is required")
		return
	}

	value := r.URL.Query().Get("value")
	if value == "" {
		core.BadRequest(w, "value query parameter is required")
		return
	}

	var queryValue any = value

	if v, err := strconv.ParseInt(value, 10, 64); err == nil {
		queryValue = v
	} else if v, err := strconv.ParseFloat(value, 64); err == nil {
		queryValue = v
	} else if value == "true" {
		queryValue = true
	} else if value == "false" {
		queryValue = false
	} else if value == "null" {
		queryValue = nil
	}

	count, err := h.repo.CountByFieldValue(r.Context(), dbName, name, field, queryValue)
	if err != nil {
		core.InternalServerError(w, err)
		return
	}

	response := CountResponse{
		Collection: name,
		Field:      field,
		Value:      queryValue,
		Count:      count,
	}

	core.OK(w, response)
}
```

---

## Security Review

### Security Review for `CountByField` Function

#### Vulnerabilities Found:

1. **Injection Vulnerability** - **Severity: Medium**
   - **Line 8**: The `name` and `field` parameters are directly used in the query without sanitization, which could lead to SQL injection.
   
2. **Input Validation Gaps** - **Severity: Low**
   - **Lines 13-20**: While some basic validation is performed on the `value` parameter, more comprehensive checks should be implemented.

#### Attack Vectors:

- An attacker could exploit the lack of sanitization to inject malicious SQL code or manipulate query parameters to access unauthorized data.

#### Recommended Fixes:

1. **Sanitize Input**:
   - Use a library like `sqlx` with placeholders for parameterized queries.
   ```go
   count, err := h.repo.CountByFieldValue(r.Context(), dbName, name, field, queryValue)
   if err != nil {
       core.InternalServerError(w, err)
       return
   }
   ```

2. **Enhance Input Validation**:
   - Implement more robust validation for `name` and `field`.
   ```go
   if !isValidName(name) || !isValidField(field) {
       core.BadRequest(w, "Invalid field or collection name")
       return
   }
   ```

3. **Use Parameterized Queries**:
   - Ensure all dynamic values are properly parameterized to prevent SQL injection.

#### Overall Security Posture:

The current implementation has moderate security risks due to potential injection vulnerabilities and lack of comprehensive input validation. Addressing these issues will significantly improve the overall security posture of the application.

---

*Generated by CodeWorm on 2026-02-21 09:30*
