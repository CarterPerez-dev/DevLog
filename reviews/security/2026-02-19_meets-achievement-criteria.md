# meets_achievement_criteria

**Type:** Security Review
**Repository:** CertGames-Core
**File:** backend/api/domains/progression/services/achieve_engine.py
**Language:** python
**Lines:** 12-61
**Complexity:** 20.0

---

## Source Code

```python
def meets_achievement_criteria(
    criteria: dict[str,
                   Any],
    user: User,
    user_counters: dict[str,
                        Any]
) -> bool:
    """
    Check if user meets the achievement criteria for unlock eligibility.
    """
    if not criteria:
        return False

    if "level" in criteria and (user.level or 1) < criteria["level"]:
        return False

    if "coins" in criteria and (user.coins or 0) < criteria["coins"]:
        return False

    if "testCount" in criteria:
        current_tests = user_counters.get("total_tests_completed", 0)
        if current_tests < criteria["testCount"]:
            return False

    if "perfectTests" in criteria:
        current_perfect = user_counters.get("perfect_tests_count", 0)
        if current_perfect < criteria["perfectTests"]:
            return False

    if "totalQuestions" in criteria:
        current_questions = user_counters.get(
            "total_questions_answered",
            0
        )
        if current_questions < criteria["totalQuestions"]:
            return False

    if "minScore" in criteria:
        highest_score = user_counters.get("highest_score_ever", 0)
        if highest_score < criteria["minScore"]:
            return False

    if "minScoreBefore" in criteria and "minScoreAfter" in criteria:
        lowest_score = user_counters.get("lowest_score_ever", 100)
        highest_score = user_counters.get("highest_score_ever", 0)
        if not (lowest_score <= criteria["minScoreBefore"]
                and highest_score >= criteria["minScoreAfter"]):
            return False

    return True
```

---

## Security Review

### Security Review for `meets_achievement_criteria`

#### Vulnerabilities and Severity:

1. **Input Validation Gaps** (Medium):
   - The function relies on user-provided data without thorough validation.
   - Potential for injection if `criteria`, `user`, or `user_counters` contain unexpected values.

2. **Hardcoded Secrets or Credentials** (Info):
   - No hardcoded secrets found in the provided code snippet.

3. **Error Handling that Leaks Information** (Low):
   - The function does not handle errors, but it returns a boolean value, so no information leakage is evident.

4. **Overall Security Posture**:
   - The function has a moderate security posture due to potential injection points and lack of input validation.

#### Recommended Fixes:

1. **Input Validation** (Fix):
   - Validate `criteria`, `user`, and `user_counters` for expected types and values.
   ```python
   if not isinstance(criteria, dict) or not all(isinstance(v, (int, str)) for v in criteria.values()):
       raise ValueError("Invalid criteria")
   ```

2. **Error Handling** (Fix):
   - Implement error handling to manage unexpected inputs gracefully.
   ```python
   try:
       # Validation logic here
   except Exception as e:
       logging.error(f"Validation failed: {e}")
       return False
   ```

3. **Document and Validate Criteria Structure** (Best Practice):
   - Define a schema for `criteria` to ensure it contains expected keys.

#### Attack Vectors:

- **Injection**: Malicious input could exploit the lack of validation, leading to unexpected behavior.
- **Race Conditions**: Concurrent modifications to `user_counters` might lead to inconsistent state checks.

By addressing these issues, you can significantly enhance the security and robustness of your code.

---

*Generated by CodeWorm on 2026-02-19 20:39*
