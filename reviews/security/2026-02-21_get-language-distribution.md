# get_language_distribution

**Type:** Security Review
**Repository:** kill-pr0cess.inc
**File:** backend/src/routes/github.rs
**Language:** rust
**Lines:** 259-327
**Complexity:** 10.0

---

## Source Code

```rust
pub async fn get_language_distribution(
    State(app_state): State<AppState>,
) -> Result<JsonResponse<serde_json::Value>> {
    info!("Calculating language distribution across repositories");

    let username = &app_state.config.github_username;

    // Get all repositories
    let repositories = match app_state.github_service.get_user_repositories(username).await {
        Ok(repos) => repos,
        Err(_) => get_repositories_from_db(&app_state, username).await?,
    };

    // Calculate language statistics
    let mut language_stats: HashMap<String, LanguageStat> = HashMap::new();
    let mut total_size: i64 = 0;

    for repo in &repositories {
        if repo.is_archived || repo.is_fork {
            continue; // Skip archived and forked repositories for cleaner stats
        }

        total_size += repo.size_kb as i64;

        if let Some(ref language) = repo.language {
            let stat = language_stats.entry(language.clone()).or_insert(LanguageStat {
                name: language.clone(),
                repository_count: 0,
                total_size_kb: 0,
                total_stars: 0,
                average_stars: 0.0,
                percentage: 0.0,
            });

            stat.repository_count += 1;
            stat.total_size_kb += repo.size_kb as i64;
            stat.total_stars += repo.stargazers_count;
        }
    }

    // Calculate percentages and averages
    for stat in language_stats.values_mut() {
        stat.percentage = if total_size > 0 {
            (stat.total_size_kb as f64 / total_size as f64) * 100.0
        } else { 0.0 };
        stat.average_stars = if stat.repository_count > 0 {
            stat.total_stars as f64 / stat.repository_count as f64
        } else { 0.0 };
    }

    // Sort by usage (repository count)
    let mut sorted_languages: Vec<_> = language_stats.into_values().collect();
    sorted_languages.sort_by(|a, b| b.repository_count.cmp(&a.repository_count));

    let response = serde_json::json!({
        "languages": sorted_languages,
        "summary": {
            "total_languages": sorted_languages.len(),
            "total_repositories_analyzed": repositories.len(),
            "total_size_kb": total_size,
            "most_used_language": sorted_languages.first().map(|l| &l.name),
            "language_diversity_score": calculate_diversity_score(&sorted_languages)
        },
        "analysis_timestamp": chrono::Utc::now()
    });

    info!("Language distribution calculated for {} languages", sorted_languages.len());
    Ok(Json(response))
}
```

---

## Security Review

### Security Review for `get_language_distribution`

#### Vulnerabilities Found:

1. **Hardcoded Secrets or Credentials:**
   - **Severity:** Info
   - **Line:** N/A
   - **Fix:** Ensure that sensitive information like `app_state.config.github_username` is securely managed and not hardcoded.

2. **Error Handling:**
   - **Severity:** Low
   - **Line:** 13-14
   - **Fix:** Improve error handling to avoid leaking database access errors by logging generic messages or using a custom error type.

#### Attack Vectors:

- **Injection Vulnerabilities:** None identified in the provided code.
- **Race Conditions and TOCTOU Bugs:** Not applicable here, as there are no file operations or shared mutable state issues.
- **Input Validation Gaps:** The function does not validate input from `app_state` or `username`, but this is managed by the service layer.

#### Recommended Fixes:

1. Securely manage credentials:
   - Use environment variables or a secrets manager for sensitive information like `github_username`.

2. Improve error handling:
   ```rust
   let repositories = match app_state.github_service.get_user_repositories(username).await {
       Ok(repos) => repos,
       Err(e) => {
           error!("Failed to get user repositories: {}", e);
           get_repositories_from_db(&app_state, username).await?
       }
   };
   ```

#### Overall Security Posture:

The code is generally secure but could benefit from better error handling and secure credential management. The function does not expose significant vulnerabilities, but improvements can be made to handle errors gracefully and manage sensitive data securely.

---

*Generated by CodeWorm on 2026-02-21 10:46*
