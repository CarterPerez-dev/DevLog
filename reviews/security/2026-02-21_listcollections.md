# ListCollections

**Type:** Security Review
**Repository:** angelamos-operations
**File:** CertGamesDB-Argos/go-backend/internal/mongodb/collections.go
**Language:** go
**Lines:** 93-151
**Complexity:** 12.0

---

## Source Code

```go
func (r *CollectionsRepository) ListCollections(ctx context.Context, dbName string) ([]CollectionInfo, error) {
	db := r.client.client.Database(dbName)

	cursor, err := db.ListCollections(ctx, bson.D{})
	if err != nil {
		return nil, fmt.Errorf("list collections: %w", err)
	}
	defer cursor.Close(ctx)

	var collections []CollectionInfo
	for cursor.Next(ctx) {
		var result bson.M
		if err := cursor.Decode(&result); err != nil {
			continue
		}

		name, _ := result["name"].(string)
		collType, _ := result["type"].(string)

		if collType == "" {
			collType = "collection"
		}

		info := CollectionInfo{
			Name: name,
			Type: collType,
		}

		count, _ := db.Collection(name).EstimatedDocumentCount(ctx)
		info.DocumentCount = count

		var stats bson.M
		if err := db.RunCommand(ctx, bson.D{{"collStats", name}}).Decode(&stats); err == nil {
			if size, ok := stats["size"].(int32); ok {
				info.SizeBytes = int64(size)
			} else if size, ok := stats["size"].(int64); ok {
				info.SizeBytes = size
			}
			if avgSize, ok := stats["avgObjSize"].(int32); ok {
				info.AvgDocSize = int64(avgSize)
			} else if avgSize, ok := stats["avgObjSize"].(int64); ok {
				info.AvgDocSize = avgSize
			} else if avgSize, ok := stats["avgObjSize"].(float64); ok {
				info.AvgDocSize = int64(avgSize)
			}
			if nindexes, ok := stats["nindexes"].(int32); ok {
				info.IndexCount = int(nindexes)
			}
		}

		collections = append(collections, info)
	}

	sort.Slice(collections, func(i, j int) bool {
		return collections[i].DocumentCount > collections[j].DocumentCount
	})

	return collections, nil
}
```

---

## Security Review

### Security Review for `ListCollections` Function

#### Vulnerabilities Found:

1. **Information Disclosure** - **Severity: Low**
   - **Description**: The function handles errors but does not provide detailed error messages, which could potentially leak information about the database structure.
   - **Attack Vector**: An attacker might infer details about the database schema based on error messages.
   - **Fix**: Use more generic error messages or log detailed errors for debugging purposes only.

2. **Input Validation** - **Severity: Low**
   - **Description**: The function does not validate `dbName` input, which could lead to potential misconfiguration issues if an attacker can manipulate it.
   - **Fix**: Validate and sanitize `dbName` to ensure it conforms to expected patterns or is whitelisted.

3. **Error Handling** - **Severity: Low**
   - **Description**: The function uses a generic error handling pattern but does not differentiate between different types of errors, which could make debugging harder.
   - **Fix**: Use specific error types and handle them appropriately.

#### Overall Security Posture:

The code is generally secure with no critical or high-severity issues. However, there are some areas for improvement in terms of error handling and input validation to enhance the security posture further.

### Recommendations:
- Implement more detailed logging for debugging purposes without exposing sensitive information.
- Validate and sanitize `dbName` parameters.
- Use specific error types and handle them appropriately to improve error management.

---

*Generated by CodeWorm on 2026-02-21 00:59*
