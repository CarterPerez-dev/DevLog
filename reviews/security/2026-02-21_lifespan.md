# lifespan

**Type:** Security Review
**Repository:** vuemantics
**File:** backend/core/lifespan.py
**Language:** python
**Lines:** 24-83
**Complexity:** 3.0

---

## Source Code

```python
async def lifespan(_app: FastAPI) -> AsyncIterator[None]:
    """
    Manage application lifecycle

    Handles startup and shutdown events for database connections
    and any other resources that need initialization/cleanup
    """
    logger.info(
        f"Starting {config.settings.app_name} in {config.settings.environment} mode"
    )

    try:
        await init_db()
        logger.info("Database connection pool initialized")

        # Foreign key dependency
        await UploadBatch.ensure_table_exists()
        logger.info("UploadBatch table initialized")

        version = await db.fetchval(
            "SELECT extversion FROM pg_extension WHERE extname = 'vector'"
        )
        if version:
            logger.info(f"pgvector {version} is ready")
        else:
            logger.warning(
                "pgvector extension not found - vector search will fail"
            )

        await init_redis()
        logger.info("Redis connection pool initialized")

        await redis_pool.client.ping()  # type: ignore[union-attr]
        logger.info("Redis is ready")

        init_manager()
        init_publisher()

        await get_publisher().start()
        logger.info("WebSocket publisher started")

    except Exception as e:
        logger.error(f"Startup failed: {e}")
        raise

    yield

    logger.info("Shutting down application")

    await get_manager().disconnect_all()
    logger.info("All WebSocket connections closed")

    await get_publisher().stop()
    logger.info("WebSocket publisher stopped")

    await close_redis()
    logger.info("Redis connection pool closed")

    await close_db()
    logger.info("Database connection pool closed")
```

---

## Security Review

### Security Review for `lifespan` Function

#### Vulnerabilities Found:

1. **SQL Injection** (Critical, Line 26):
   - The SQL query is directly constructed using a string format, which could lead to SQL injection if the input is not properly sanitized.
   
2. **Logging Sensitive Information** (Medium, Lines 35-40, 47-48):
   - Logging sensitive information like connection details or version numbers can expose critical data.

#### Attack Vectors:

1. **SQL Injection**: An attacker could manipulate the `version` variable to execute arbitrary SQL commands.
2. **Logging Sensitive Information**: Exposing database and Redis connection status through logs might aid in reverse engineering the application's architecture.

#### Recommended Fixes:

1. **SQL Injection**:
   - Use parameterized queries or ORM methods instead of string formatting for SQL queries.
     ```python
     version = await db.fetchval("SELECT extversion FROM pg_extension WHERE extname = %s", 'vector')
     ```

2. **Logging Sensitive Information**:
   - Log only necessary information and avoid sensitive details.
     ```python
     if not version:
         logger.warning(f"pgvector extension not found")
     ```

#### Overall Security Posture:

The function is generally well-structured for managing application lifecycle events, but it needs improvements in handling SQL queries and logging to ensure data security. Implementing the suggested fixes will significantly enhance the security posture of this code.

---

*Generated by CodeWorm on 2026-02-21 14:19*
