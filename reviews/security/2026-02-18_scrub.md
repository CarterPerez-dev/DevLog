# scrub

**Type:** Security Review
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/beginner/metadata-scrubber-tool/src/commands/scrub.py
**Language:** python
**Lines:** 36-150
**Complexity:** 10.0

---

## Source Code

```python
def scrub(
    file_path: Path = typer.Argument(
        exists=True,
        file_okay=True,
        dir_okay=True,
        readable=True,
        writable=True,
        resolve_path=True,
        help="The file or directory to process.",
    ),
    recursive: bool = typer.Option(
        False, "--recursive", "-r",
        help="Recursively process files in the specified directory."
    ),
    ext: str = typer.Option(
        None, "--extension", "-ext",
        help="File extension to filter by (e.g., jpg, png)."
    ),
    output_dir: str = typer.Option(
        "./scrubbed", "--output", "-o",
        help="Directory to save processed files."
    ),
    dry_run: bool = typer.Option(
        False, "--dry-run", "-d",
        help="Preview what would be processed without making changes."
    ),
    workers: int = typer.Option(
        min(4, (os.cpu_count() or 1)),
        "--workers", "-w",
        help="Number of concurrent worker threads (default: 4 or CPU count)."
    ),
):
    # fmt: on
    """
    Remove metadata from files.

    Scrubs privacy-sensitive metadata (EXIF, GPS, author info) from images.
    Works with JPEG, PNG, and will support PDF/Office docs in future.

    Examples:

        scrub photo.jpg

        scrub ./photos/ -r -ext jpg --output ./cleaned

        scrub ./folder/ -r -ext png --dry-run

        scrub ./large_batch/ -r -ext jpg --workers 8
    """
    # Validate recursive/extension combo
    if recursive and not ext:
        raise typer.BadParameter(
            "If you provide --recursive or -r, you must also provide --extension or -ext."
        )
    if ext and not recursive:
        raise typer.BadParameter(
            "If you provide --extension or -ext, you must also provide --recursive or -r."
        )

    # Show dry-run banner
    if dry_run:
        console.print(
            "\n[bold yellow]ðŸ” DRY-RUN MODE[/bold yellow] - No files will be modified.\n"
        )

    # Collect files to process
    files = list(get_target_files(file_path, ext)) if recursive else [file_path]

    if not files:
        console.print("[yellow]No files found to process.[/yellow]")
        raise typer.Exit(0)

    # Show worker count for batch operations
    if len(files) > 1:
        console.print(
            f"[dim]Processing {len(files)} files with {workers} workers...[/dim]\n"
        )

    # Initialize processor with worker count
    processor = BatchProcessor(
        output_dir = output_dir,
        dry_run = dry_run,
        max_workers = workers
    )

    # Process with thread-safe progress bar
    with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            BarColumn(),
            MofNCompleteColumn(),
            TaskProgressColumn(),
            TimeElapsedColumn(),
            console = console,
            refresh_per_second = 10,  # Smooth updates for concurrent processing
    ) as progress:
        task_id = progress.add_task(
            "[cyan]
```

---

## Security Review

### Security Review for `scrub` Function

**Vulnerabilities Found:**

1. **Input Validation Gaps (Medium):**
   - The function does not validate the `output_dir` path, which could allow directory traversal attacks.
   
2. **Error Handling (Low):**
   - Error handling is minimal and may leak information about file paths or processing issues.

3. **Overall Security Posture:**
   - The code is generally secure but lacks some critical checks and error handling.

**Attack Vectors:**

- An attacker could exploit the `output_dir` parameter to write files in unintended locations.
- Lack of proper validation might allow injection attacks if the input paths are manipulated.

**Recommended Fixes:**

1. **Input Validation (Medium):**
   - Validate `output_dir` using `pathlib.Path.is_absolute()` and ensure it does not contain problematic characters or paths:
     ```python
     from pathlib import Path

     output_path = Path(output_dir)
     if not output_path.exists() or not output_path.is_dir():
         raise typer.BadParameter("Output directory must exist and be a valid directory.")
     ```

2. **Error Handling (Low):**
   - Improve error handling to avoid exposing sensitive information:
     ```python
     try:
         processor.process_batch(files, progress_callback=on_file_complete)
     except Exception as e:
         console.print(f"[red]An error occurred: {e}[/red]")
         raise typer.Exit(1)
     ```

3. **Overall Security Posture:**
   - Ensure all paths are validated and sanitized to prevent directory traversal and injection attacks.

By addressing these issues, the overall security of the `scrub` function can be significantly improved.

---

*Generated by CodeWorm on 2026-02-18 12:55*
