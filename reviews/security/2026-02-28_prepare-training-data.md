# prepare_training_data

**Type:** Security Review
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/ai-threat-detection/backend/ml/splitting.py
**Language:** python
**Lines:** 28-84
**Complexity:** 4.0

---

## Source Code

```python
def prepare_training_data(
    X: np.ndarray,
    y: np.ndarray,
    train_ratio: float = 0.70,
    val_ratio: float = 0.15,
    smote_strategy: float = 0.3,
    smote_k: int = 5,
    random_state: int = 42,
) -> TrainingSplit:
    """
    Split data into train/val/test with SMOTE on training set only
    """
    n_classes = len(np.unique(y))
    if n_classes < 2:
        raise ValueError("y must contain at least 2 classes")

    test_size = 1.0 - train_ratio
    X_train, X_rem, y_train, y_rem = train_test_split(
        X,
        y,
        test_size=test_size,
        stratify=y,
        random_state=random_state,
    )

    X_val, X_test, y_val, y_test = train_test_split(
        X_rem,
        y_rem,
        test_size=0.5,
        stratify=y_rem,
        random_state=random_state,
    )

    X_normal_train = X_train[y_train == 0]

    class_counts = np.bincount(y_train)
    minority_count = class_counts.min()
    majority_count = class_counts.max()
    current_ratio = minority_count / majority_count

    if (minority_count >= smote_k + 1 and current_ratio < smote_strategy):
        sampler = SMOTE(
            sampling_strategy=smote_strategy,
            k_neighbors=smote_k,
            random_state=random_state,
        )
        X_train, y_train = sampler.fit_resample(X_train, y_train)

    return TrainingSplit(
        X_train=X_train,
        y_train=y_train,
        X_val=X_val,
        y_val=y_val,
        X_test=X_test,
        y_test=y_test,
        X_normal_train=X_normal_train,
    )
```

---

## Security Review

### Security Review for `prepare_training_data`

#### Vulnerabilities and Severity:

1. **Input Validation Gaps** [Medium]
   - **Line 8**: The function does not validate the input arrays `X` and `y`. If these inputs are manipulated, it could lead to unexpected behavior or errors.
   
2. **Hardcoded Secrets or Credentials** [Info]
   - No hardcoded secrets or credentials were found in this code snippet.

3. **Error Handling that Leaks Information** [Low]
   - The function raises a `ValueError` if the number of classes is less than 2, which could be informative to an attacker about the dataset's structure.

4. **Overall Security Posture**
   - The overall security posture is good, but there are areas for improvement in input validation and error handling.

#### Attack Vectors:

- An attacker could provide malformed or malicious data to `X` and `y`, leading to unexpected behavior.
- Information about the dataset's class distribution might be leaked through error messages.

#### Recommended Fixes:

1. **Input Validation**:
   - Validate that `X` and `y` are numpy arrays on line 3.
   ```python
   if not isinstance(X, np.ndarray) or not isinstance(y, np.ndarray):
       raise TypeError("Inputs X and y must be numpy arrays")
   ```

2. **Error Handling**:
   - Customize the error message to avoid leaking sensitive information.
   ```python
   if n_classes < 2:
       raise ValueError("The target array `y` must contain at least two classes.")
   ```

3. **Documentation and Comments**:
   - Add comments or documentation explaining why certain validations are performed.

By addressing these points, the security posture of this function can be significantly improved.

---

*Generated by CodeWorm on 2026-02-28 11:46*
