# checkVolumes

**Type:** Security Review
**Repository:** docksec
**File:** internal/analyzer/compose.go
**Language:** go
**Lines:** 170-228
**Complexity:** 10.0

---

## Source Code

```go
func (a *ComposeAnalyzer) checkVolumes(
	target finding.Target,
	serviceName string,
	node *yaml.Node,
) finding.Collection {
	var findings finding.Collection

	volumesNode := findNode(node, "volumes")
	if volumesNode == nil {
		return findings
	}

	for _, volNode := range volumesNode.Content {
		var hostPath string
		switch volNode.Kind {
		case yaml.ScalarNode:
			parts := strings.SplitN(volNode.Value, ":", 2)
			hostPath = parts[0]
		case yaml.MappingNode:
			sourceNode := findNode(volNode, "source")
			if sourceNode != nil {
				hostPath = sourceNode.Value
			}
		}

		if hostPath == "" {
			continue
		}

		if rules.IsDockerSocket(hostPath) {
			loc := &finding.Location{Path: a.path, Line: volNode.Line}
			f := finding.New("CIS-5.31", "Service '"+serviceName+"' mounts Docker socket", finding.SeverityCritical, target).
				WithDescription("Mounting Docker socket gives the container full control over the Docker daemon.").
				WithCategory(string(CategoryCompose)).
				WithLocation(loc).
				WithRemediation("Do not mount /var/run/docker.sock inside containers.")
			findings = append(findings, f)
			continue
		}

		if rules.IsSensitivePath(hostPath) {
			loc := &finding.Location{Path: a.path, Line: volNode.Line}
			severity := rules.GetPathSeverity(hostPath)
			pathInfo, _ := rules.GetPathInfo(hostPath)
			description := "Mounting sensitive host paths can enable container escape."
			if pathInfo.Description != "" {
				description = pathInfo.Description
			}
			f := finding.New("CIS-5.5", "Service '"+serviceName+"' mounts sensitive path: "+hostPath, severity, target).
				WithDescription(description).
				WithCategory(string(CategoryCompose)).
				WithLocation(loc).
				WithRemediation("Do not mount sensitive host directories. Use Docker volumes instead.")
			findings = append(findings, f)
		}
	}

	return findings
}
```

---

## Security Review

### Security Review for `checkVolumes` Function

**Vulnerabilities Found:**

1. **Information Disclosure - Line 26-30, 39-45**
   - Severity: **Low**
   - **Attack Vector:** If the `rules.IsDockerSocket` or `rules.IsSensitivePath` functions leak information about the paths being checked.
   - **Recommendation:** Ensure these functions do not expose sensitive details in error messages. Use generic error handling.

2. **Input Validation Gaps - Line 14-20**
   - Severity: **Medium**
   - **Attack Vector:** Potential for misinterpretation of `volNode.Value` or `sourceNode.Value`.
   - **Recommendation:** Validate and sanitize input values before processing them.

3. **Error Handling - Line 26-30, 39-45**
   - Severity: **Low**
   - **Attack Vector:** Potential for information leakage if errors occur.
   - **Recommendation:** Use `defer` to ensure proper error handling and logging.

**Overall Security Posture:**

The function is generally secure but could benefit from improved input validation, error handling, and ensuring that no sensitive details are leaked. By addressing the noted issues, the security posture can be significantly enhanced.

### Concrete Fixes

1. **Error Handling:**
   ```go
   defer func() {
       if err := recover(); err != nil {
           log.Printf("Error checking volume: %v", err)
       }
   }()
   ```

2. **Input Validation:**
   Ensure `volNode.Value` and `sourceNode.Value` are properly validated before use.

3. **Generic Error Messages:**
   Modify `rules.IsDockerSocket` and `rules.IsSensitivePath` to return generic error messages if needed.

---

*Generated by CodeWorm on 2026-02-21 15:11*
