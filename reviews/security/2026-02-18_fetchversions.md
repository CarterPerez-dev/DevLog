# FetchVersions

**Type:** Security Review
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/beginner/simple-vulnerability-scanner/internal/pypi/client.go
**Language:** go
**Lines:** 76-137
**Complexity:** 12.0

---

## Source Code

```go
func (c *Client) FetchVersions(
	ctx context.Context,
	name string,
) ([]string, error) {
	normalized := NormalizeName(name)

	entry, hit := c.cache.Get(normalized)
	if hit && c.cache.IsFresh(entry) {
		return entry.Versions, nil
	}

	url := simpleAPIBase + normalized + "/"
	req, err := http.NewRequestWithContext(
		ctx, http.MethodGet, url, nil,
	)
	if err != nil {
		return nil, fmt.Errorf("build request for %s: %w", name, err)
	}
	req.Header.Set("Accept", simpleAPIAccept)
	req.Header.Set("User-Agent", c.userAgent)

	if entry != nil && entry.ETag != "" {
		req.Header.Set("If-None-Match", entry.ETag)
	}

	resp, err := c.doWithRetry(ctx, req)
	if err != nil {
		if entry != nil {
			return entry.Versions, nil
		}
		return nil, fmt.Errorf("fetch %s: %w", name, err)
	}
	defer func() { _ = resp.Body.Close() }() //nolint:errcheck

	switch resp.StatusCode {
	case http.StatusNotModified:
		c.cache.Touch(normalized)
		return entry.Versions, nil

	case http.StatusNotFound:
		return nil, fmt.Errorf(
			"package %q not found on PyPI", name,
		)

	case http.StatusOK:
		var result simpleAPIResponse
		if err := json.NewDecoder(resp.Body).Decode(&result); err != nil {
			return nil, fmt.Errorf("decode %s: %w", name, err)
		}
		_ = c.cache.Set(normalized, &CacheEntry{ //nolint:errcheck
			ETag:     resp.Header.Get("ETag"),
			Versions: result.Versions,
			CachedAt: time.Now(),
		})
		return result.Versions, nil

	default:
		return nil, fmt.Errorf(
			"PyPI returned %d for %s", resp.StatusCode, name,
		)
	}
}
```

---

## Security Review

### Security Review for `FetchVersions` Function

#### Vulnerabilities Found:

1. **Information Leakage:**
   - **Severity:** Low
   - **Line 36, 48, 59**: The error messages include the exact HTTP status code and package name, which could be used to infer information about the system's state or contents.

2. **Hardcoded Secrets:**
   - **Severity:** Info
   - **Line 10-11**: `simpleAPIBase` and `simpleAPIAccept` are hardcoded strings. Ensure these values are not sensitive but if they are, consider using environment variables.

3. **Error Handling:**
   - **Severity:** Low
   - **Lines 48, 59**: Error messages include package names which could be leveraged for information gathering attacks.

#### Attack Vectors:

- An attacker could use the error messages to infer details about the system's state or contents.
- Hardcoded strings might expose sensitive information if not properly managed.

#### Recommended Fixes:

1. **Information Leakage:**
   - Use generic error messages that do not include package names or HTTP status codes.
   ```go
   return nil, fmt.Errorf("error fetching package versions")
   ```

2. **Hardcoded Secrets:**
   - Move `simpleAPIBase` and `simpleAPIAccept` to environment variables or a configuration file.

3. **Error Handling:**
   - Ensure error messages are generic and do not include sensitive information.

#### Overall Security Posture:

The code has some minor issues related to information leakage and hardcoded values, but the overall security posture is manageable with the suggested fixes. Proper error handling and configuration management can significantly enhance the security of this function.

---

*Generated by CodeWorm on 2026-02-18 22:08*
