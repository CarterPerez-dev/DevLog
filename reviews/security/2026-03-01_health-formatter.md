# health_formatter

**Type:** Security Review
**Repository:** Telehook
**File:** src/telehook/formatters/health.py
**Language:** python
**Lines:** 9-26
**Complexity:** 5.0

---

## Source Code

```python
def health_formatter(
    app: str,
    status: str,
    uptime: str | None = None,
    extra: dict[str,
                str] | None = None,
) -> str:
    emoji = "\u2705" if status == "alive" else "\U0001f7e1"
    parts = [f"{emoji} <b>{app} is {status}</b>", ""]

    if uptime:
        parts.append(f"<b>Uptime:</b> {uptime}")

    if extra:
        for key, value in extra.items():
            parts.append(f"<b>{key}:</b> {value}")

    return truncate("\n".join(parts))
```

---

## Security Review

### Security Review of `health_formatter` Function

#### Vulnerabilities Found:

1. **XSS Risk** - Line 7: The function constructs HTML strings without escaping input, which could lead to Cross-Site Scripting (XSS) if the `status`, `uptime`, or `extra` values are controlled by an attacker.
   - **Severity**: High
   - **Attack Vector**: An attacker could inject malicious scripts into the `status` or `extra` parameters.

2. **Info Leakage** - Line 14: The function uses the `truncate` function, but does not handle errors or edge cases where truncation might fail.
   - **Severity**: Low
   - **Attack Vector**: If `truncate` fails, it could leak information about the internal implementation.

#### Recommended Fixes:

- Escape all user-controlled inputs before including them in HTML strings to prevent XSS. Use a library like `html.escape`.
  ```python
  from html import escape

  # Replace line 7 with:
  emoji = "\u2705" if status == "alive" else "\U0001f7e1"
  parts = [f"{emoji} <b>{escape(app)} is {status}</b>", ""]
  ```

- Ensure robust error handling for the `truncate` function.
  ```python
  try:
      return truncate("\n".join(parts))
  except Exception as e:
      # Log or handle the exception appropriately
      pass
  ```

#### Overall Security Posture:

The current code has a significant XSS risk due to unescaped user inputs. Addressing this is critical to prevent potential security breaches. The `truncate` function's error handling, while not severe, should be improved for better reliability and security practices.

---

*Generated by CodeWorm on 2026-03-01 18:17*
