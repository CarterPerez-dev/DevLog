# parseCPULine

**Type:** Security Review
**Repository:** Yoshi-Audit
**File:** internal/system/cpu.go
**Language:** go
**Lines:** 15-34
**Complexity:** 5.0

---

## Source Code

```go
func parseCPULine(line string) (idle, total uint64, err error) {
	fields := strings.Fields(line)
	if len(fields) < 5 {
		return 0, 0, fmt.Errorf("not enough fields in cpu line: %q", line)
	}

	var sum uint64
	for i := 1; i < len(fields); i++ {
		val, parseErr := strconv.ParseUint(fields[i], 10, 64)
		if parseErr != nil {
			return 0, 0, fmt.Errorf("failed to parse field %d: %w", i, parseErr)
		}
		sum += val
		if i == 4 {
			idle = val
		}
	}

	return idle, sum, nil
}
```

---

## Security Review

### Security Review for `parseCPULine` Function

**Vulnerabilities Found:**

1. **Input Validation Gap (Medium):**
   - The function does not validate the input string format, which could lead to unexpected behavior if non-numeric data is present.
   
2. **Error Handling (Low):**
   - Error messages include sensitive information like field indices and error types.

**Attack Vectors:**

- An attacker could inject non-numeric values into the `line` parameter, causing parsing errors or incorrect CPU usage calculations.
- Sensitive error details might be exposed in logs or panic messages.

**Recommended Fixes:**

1. **Input Validation Gap (Medium):**
   - Add regex validation to ensure fields are numeric before parsing.
     ```go
     if _, err := regexp.MatchString(`^\d+$`, fields[i]); err != nil {
         return 0, 0, fmt.Errorf("field %d is not a number: %q", i, fields[i])
     }
     ```

2. **Error Handling (Low):**
   - Use more generic error messages to avoid leaking information.
     ```go
     if parseErr != nil {
         return 0, 0, errors.New("failed to parse field")
     }
     ```

**Overall Security Posture:**

The current implementation is secure but can be improved by adding robust input validation and refining error handling. Ensuring that the code does not expose sensitive information in error messages is crucial for maintaining a strong security posture.

*Severity Ratings:*
- Input Validation Gap: Medium
- Error Handling: Low

---

*Generated by CodeWorm on 2026-03-02 01:40*
