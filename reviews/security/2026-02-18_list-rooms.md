# list_rooms

**Type:** Security Review
**Repository:** Cybersecurity-Projects
**File:** PROJECTS/advanced/encrypted-p2p-chat/backend/app/api/rooms.py
**Language:** python
**Lines:** 136-200
**Complexity:** 10.0

---

## Source Code

```python
async def list_rooms(
    user_id: str,
    session: AsyncSession = Depends(get_session),
) -> RoomListResponse:
    """
    List all rooms for the specified user
    """
    user = await auth_service.get_user_by_id(session, UUID(user_id))

    if not user:
        raise HTTPException(
            status_code = status.HTTP_404_NOT_FOUND,
            detail = "User not found",
        )

    room_data_list = await surreal_db.get_rooms_for_user(user_id)

    rooms: list[RoomAPIResponse] = []

    for room_data in room_data_list:
        if not room_data:
            continue

        room_id = str(room_data.get("id", ""))
        participants_data = await surreal_db.get_room_participants(room_id)

        participants: list[ParticipantResponse] = []

        for p_data in participants_data:
            p_user_id = p_data.get("user_id")
            if not p_user_id:
                continue

            p_user = await auth_service.get_user_by_id(session, UUID(p_user_id))
            if p_user:
                participants.append(
                    ParticipantResponse(
                        user_id = str(p_user.id),
                        username = p_user.username,
                        display_name = p_user.display_name,
                        role = p_data.get("role", "member"),
                        joined_at = str(p_data.get("joined_at", "")),
                    )
                )

        other_participant = next(
            (p for p in participants if p.user_id != user_id),
            None
        )
        room_name = other_participant.display_name if other_participant else None

        rooms.append(
            RoomAPIResponse(
                id = room_id,
                type = RoomType(room_data.get("room_type", "direct")),
                name = room_name,
                participants = participants,
                unread_count = 0,
                is_encrypted = True,
                created_at = str(room_data.get("created_at", "")),
                updated_at = str(room_data.get("updated_at", "")),
            )
        )

    return RoomListResponse(rooms = rooms)
```

---

## Security Review

### Security Review for `list_rooms` Function

#### Vulnerabilities Found:

1. **Injection Vulnerability: Medium**
   - **Line 8:** The `auth_service.get_user_by_id` function could be vulnerable to SQL injection if the user ID is not properly validated or sanitized.
   
2. **Hardcoded Secrets: Low**
   - No hardcoded secrets or credentials are found in this snippet.

3. **Input Validation Gaps: Medium**
   - **Line 10:** The `user_id` parameter is not validated for format or length, which could lead to unexpected behavior if the input is malformed.
   
4. **Error Handling: Info**
   - The error handling does not provide detailed information that could be used by attackers.

#### Attack Vectors:

- An attacker could exploit injection vulnerabilities to manipulate queries and potentially gain unauthorized access.
- Malformed `user_id` inputs could lead to errors or unexpected behavior, affecting the application's security posture.

#### Recommended Fixes:

1. **Input Validation:**
   - Add validation for `user_id` on line 8 to ensure it is a valid UUID format.
   
2. **Injection Prevention:**
   - Ensure that the `auth_service.get_user_by_id` function uses parameterized queries or an ORM that prevents SQL injection.

3. **Error Handling:**
   - Improve error handling by logging errors without exposing sensitive information.

#### Overall Security Posture:

The current code has some vulnerabilities, but implementing the suggested fixes can significantly improve its security posture. Ensure to review and secure other parts of the application as well.

---

*Generated by CodeWorm on 2026-02-18 21:12*
